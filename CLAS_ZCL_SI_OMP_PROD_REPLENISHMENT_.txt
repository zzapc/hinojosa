
class ZCL_SI_OMP_PROD_REPLENISHMENT definition
  public
  create public .

public section.

  interfaces ZII_SI_OMP_PROD_REPLENISHMENT .

  class-methods DAME_MATERIAL
    importing
      !IV_STR type STRING
    changing
      !CV_MATNR type MATNR
    exceptions
      NO_MATERIAL_FOUND
      E_CALIDAD_VACIA
      E_VALOR_EXTERNO
      E_VALOR_SAP
      E_SIN_VALOR
      E_MAT_ZPIM_NOT_FOUND .
  PROTECTED SECTION.
private section.

  types:
    gtyp_ltbk TYPE STANDARD TABLE OF ltbk .
  types:
    gtyp_ltbp TYPE STANDARD TABLE OF ltbp .
  types:
    BEGIN OF treg_log,
             cinumber TYPE lvs_benum,
*
             matnr_1    type string,
             menge_1    type LTBP_MENGE,
             ok_1     TYPE tbnum,
             ko_1     TYPE bapi_msg,

             matnr_2    type string,
             menge_2    type LTBP_MENGE,
             ok_2     TYPE tbnum,
             ko_2     TYPE bapi_msg,

             matnr_3    type string,
             menge_3    type LTBP_MENGE,
             ok_3     TYPE tbnum,
             ko_3     TYPE bapi_msg,

             matnr_4    type string,
             menge_4    type LTBP_MENGE,
             ok_4     TYPE tbnum,
             ko_4     TYPE bapi_msg,

             matnr_5    type string,
             menge_5    type LTBP_MENGE,
             ok_5     TYPE tbnum,
             ko_5     TYPE bapi_msg,

             matnr_6    type string,
             menge_6    type LTBP_MENGE,
             ok_6     TYPE tbnum,
             ko_6     TYPE bapi_msg,

           END OF treg_log .
  types:
    gtyp_log TYPE STANDARD TABLE OF treg_log .

  constants GAC_NODATA type BDC_FVAL value '/' ##NO_TEXT.
  data GAT_BDCDATA type BDCDATA_TAB .
  data GAT_BORRADAS type GTYP_LTBK .
  data GAT_CREADAS type GTYP_LTBK .
  data GAT_MODIFICADAS type GTYP_LTBK .
  data GAT_RETURN type BAPIRET2_T .
  data GA_LGORT type LGORT_D value 1000 ##NO_TEXT.
  data GA_BWART type BWART value 919 ##NO_TEXT.
  data GA_WERKS type WERKS_D value 2000 ##NO_TEXT.
  data GAT_LOG type GTYP_LOG .
  data:
    gac_th(4) value '<th>' ##NO_TEXT.
  data:
    gac_thf(5) value '</th>' ##NO_TEXT.
  data:
    gac_tr(4) value '<tr>' ##NO_TEXT.
  data:
    gac_trf(5) value '</tr>' ##NO_TEXT.
  data:
    gac_td(4) value '<td>' ##NO_TEXT.
  data:
    gac_tdf(5) value '</td>' ##NO_TEXT.
  data GAV_HAY_ERROR type ABAP_BOOL .

  methods BORRA_NECESIDAD
    importing
      !PI_LGNUM type LGNUM
      !PI_TBNUM type TBNUM
    returning
      value(PR_BORRADA) type ABAP_BOOL .
  methods F_BDC_DYNPRO
    importing
      !PE_DYN type BDC_DYNR
      !PE_PROG type BDC_PROG .
  methods F_BDC_FIELD
    importing
      !PE_FNAM type FNAM_____4
      !PE_FVAL type BDC_FVAL .
  methods DAME_TABLA_CREADAS
    changing
      !PT_MESS type SOLI_TAB .
  methods DAME_TABLE_ERROES
    changing
      !PT_MESS type SOLI_TAB .
  methods ERROR_MATERIAL_LOG
    importing
      !PI_SUBRC type SYST_SUBRC
    returning
      value(PC_KO) type BAPI_MSG .
  methods BORRA_NT_ABIERTAS .
  methods CARGA_NT_MODIFICADAS .
  methods CREAR_NTS
    importing
      !PI_INDEX type SY-INDEX
    changing
      !PT_LTBK type GTYP_LTBK
      !PT_LTBP type GTYP_LTBP
      !PC_OK type TBNUM
      !PC_KO type BAPI_MSG .
  methods DAME_HARDCODES .
  methods ENVIA_MAIL_NOTIFICACION .
  methods NOTIFICA_BORRADA
    importing
      !PI_LGNUM type LGNUM
      !PI_TBNUM type TBNUM .
  methods NOTIFICA_MODIFICADA
    importing
      !PI_LTBK type LTBK .
endclass. "ZCL_SI_OMP_PROD_REPLENISHMENT definition
class ZCL_SI_OMP_PROD_REPLENISHMENT implementation.
  METHOD borra_necesidad.
    DATA: ls_opt TYPE ctu_params,
          lt_msg TYPE TABLE OF bdcmsgcoll,
          lv_aux TYPE bdc_fval.

    REFRESH gat_bdcdata.
    CLEAR pr_borrada.

    ls_opt-nobinpt = abap_true.
    ls_opt-dismode = 'N'.

    f_bdc_dynpro( EXPORTING pe_prog = 'SAPML02B' pe_dyn = '0100').
    f_bdc_field( EXPORTING pe_fnam = 'BDC_CURSOR' pe_fval = 'LTBK-TBNUM' ).
    f_bdc_field( EXPORTING pe_fnam = 'BDC_OKCODE' pe_fval ='/00' ).
    MOVE pi_lgnum TO lv_aux.
    f_bdc_field( EXPORTING pe_fnam = 'LTBK-LGNUM' pe_fval = lv_aux ).
    MOVE pi_tbnum TO lv_aux.
    f_bdc_field( EXPORTING pe_fnam = 'LTBK-TBNUM' pe_fval = lv_aux ).

    f_bdc_dynpro( EXPORTING pe_prog = 'SAPML02B' pe_dyn = '1103').
    f_bdc_field( EXPORTING pe_fnam = 'BDC_OKCODE' pe_fval = '=DLK' ).

    f_bdc_dynpro( EXPORTING pe_prog = 'SAPLSPO1' pe_dyn = '0400').
    f_bdc_field( EXPORTING pe_fnam = 'BDC_OKCODE' pe_fval = '=YES' ).

    CALL TRANSACTION 'LB02' USING gat_bdcdata OPTIONS FROM ls_opt MESSAGES INTO lt_msg .

    LOOP AT lt_msg INTO DATA(ls_msg) WHERE msgtyp = 'E'.

      CLEAR pr_borrada.

    ENDLOOP.
    IF sy-subrc NE 0.
      pr_borrada = abap_true.
    ENDIF.
  ENDMETHOD.
  METHOD borra_nt_abiertas.

    DATA: lt_ltbk  TYPE gtyp_ltbk,
          lt_ltbp  TYPE gtyp_ltbp,
          ls_ltbc  TYPE ltbc,
          lv_canc  TYPE abap_bool,
          lt_ltbc  TYPE STANDARD TABLE OF ltbc,
          ls_ltbk  TYPE ltbk,
          ls_modif TYPE ltbk,
          lv_ok    TYPE abap_bool.

    IF lv_canc IS NOT INITIAL.

      SELECT * FROM ltbp
        INTO CORRESPONDING FIELDS OF TABLE lt_ltbp
        WHERE lgnum = '200' AND
              elikz = space AND
              werks = '2000' AND
              charg = '2000' .

      IF lt_ltbp IS NOT INITIAL.
        SELECT *
          FROM ltbk
          INTO CORRESPONDING FIELDS OF TABLE lt_ltbk
          FOR ALL ENTRIES IN lt_ltbp
          WHERE lgnum EQ lt_ltbp-lgnum AND
                tbnum EQ lt_ltbp-tbnum .

      ENDIF.

    ELSE.
* seleccionamos las NT abiertas y no modificadas!!!
      SELECT *
        FROM ltbk
        INTO CORRESPONDING FIELDS OF TABLE lt_ltbk
        WHERE lgnum = '200' AND
              statu = space AND
              betyp = 'O' AND
              tbpri EQ ' '.

* miramos que las necesidades no sean del mismo ID de trabajo que las modificadas
      LOOP AT gat_modificadas INTO ls_modif.
        LOOP AT lt_ltbk INTO ls_ltbk WHERE benum = ls_modif-benum.
          DELETE lt_ltbk INDEX sy-tabix.
        ENDLOOP.
      ENDLOOP.

    ENDIF.

    LOOP AT lt_ltbk INTO ls_modif.

      lv_ok =  borra_necesidad( EXPORTING pi_lgnum = ls_modif-lgnum
                                          pi_tbnum = ls_modif-tbnum ).

      IF lv_ok IS NOT INITIAL.
        REFRESH lt_ltbc.

        SELECT *
          FROM ltbp
          INTO CORRESPONDING FIELDS OF TABLE lt_ltbp
          WHERE lgnum = ls_modif-lgnum AND
                tbnum = ls_modif-tbnum.

        LOOP AT lt_ltbp ASSIGNING FIELD-SYMBOL(<ls>).

          MOVE-CORRESPONDING <ls> TO ls_ltbc.

          APPEND ls_ltbc TO lt_ltbc.

        ENDLOOP.

        IF lt_ltbc IS NOT INITIAL.

          CALL FUNCTION 'L_TR_CANCEL'
            EXPORTING
              i_save_only_all      = 'X'
*             i_update_task        =
              i_commit_work        = 'X'
            TABLES
              t_ltbc               = lt_ltbc
            EXCEPTIONS
              item_error           = 1
              no_update_item_error = 2
              no_update_no_entry   = 3
              tr_locked            = 4
              OTHERS               = 5.
          IF sy-subrc <> 0.
* Implement suitable error handling here
          ELSE.
            LOOP AT lt_ltbc INTO ls_ltbc.

              notifica_borrada( EXPORTING pi_lgnum = ls_ltbc-lgnum
                                          pi_tbnum = ls_ltbc-tbnum ).
            ENDLOOP.
          ENDIF.


        ENDIF.
      ELSE.
        notifica_borrada( EXPORTING pi_lgnum = ls_modif-lgnum
                            pi_tbnum = ls_modif-tbnum ).
      ENDIF.

    ENDLOOP.

  ENDMETHOD.
  METHOD carga_nt_modificadas.

    DATA: lt_ltbk TYPE gtyp_ltbk,
          ls_ltbk TYPE ltbk.

* seleccionamos las NT abiertas y no modificadas!!!
    SELECT *
      FROM ltbk
      INTO CORRESPONDING FIELDS OF TABLE lt_ltbk
      WHERE lgnum = '200' AND
            statu = space AND
            betyp = 'O' AND
            tbpri NE ' '.

    IF lt_ltbk[] IS NOT INITIAL.
      SELECT *
      FROM ltbk
      APPENDING TABLE lt_ltbk
      FOR ALL ENTRIES IN lt_ltbk
      WHERE lgnum = lt_ltbk-lgnum AND
            benum = lt_ltbk-benum.
    ENDIF.

    LOOP AT lt_ltbk INTO ls_ltbk.

      notifica_modificada( EXPORTING pi_ltbk = ls_ltbk ).

    ENDLOOP.

  ENDMETHOD.
  METHOD crear_nts.
    DATA: lt_ltba TYPE STANDARD TABLE OF ltba,
          ls_ltba TYPE ltba,
          ls_ltbk TYPE ltbk,
          ls_ltbp TYPE ltbp,
          lv_mess TYPE bapi_msg,
          ls_ret  TYPE bapiret2.

    READ TABLE pt_ltbk INTO ls_ltbk INDEX 1.
    IF sy-subrc EQ 0.
      MOVE-CORRESPONDING ls_ltbk TO ls_ltba.

      LOOP AT pt_ltbp INTO ls_ltbp.
        MOVE-CORRESPONDING ls_ltbp TO ls_ltba.
        ls_ltba-menga = ls_ltbp-menge.
        ls_ltba-altme = ls_ltbp-meins.
        ls_ltba-lgort = ga_lgort.
        ls_ltba-bwlvs = ga_bwart.
        ls_ltba-nlpla = ls_ltbk-nlpla.
        ls_ltba-betyp = 'O'.
        APPEND ls_ltba TO lt_ltba.
      ENDLOOP.

    ENDIF.

    CALL FUNCTION 'L_TR_CREATE'
      EXPORTING
        i_single_item         = 'X'
        i_save_only_all       = 'X'
*       I_UPDATE_TASK         =
        i_commit_work         = 'X'
      TABLES
        t_ltba                = lt_ltba
      EXCEPTIONS
        item_error            = 1
        no_entry_in_int_table = 2
        item_without_number   = 3
        no_update_item_error  = 4
        OTHERS                = 5.

    IF sy-subrc <> 0.

      LOOP AT lt_ltba INTO ls_ltba.
        CALL FUNCTION 'BAPI_MESSAGE_GETDETAIL'
          EXPORTING
            id         = ls_ltba-msgid
            number     = ls_ltba-msgno
            language   = sy-langu
            textformat = 'RTF'
            message_v1 = ls_ltba-msgv1
            message_v2 = ls_ltba-msgv2
            message_v3 = ls_ltba-msgv3
            message_v4 = ls_ltba-msgv4
          IMPORTING
            message    = lv_mess.

        CONCATENATE pc_ko lv_mess INTO pc_ko SEPARATED BY space.
        gav_hay_error = abap_true.
      ENDLOOP.

    ELSE.
      LOOP AT lt_ltba INTO ls_ltba WHERE tbnum IS NOT INITIAL.

        pc_ok = ls_ltba-tbnum.

      ENDLOOP.

    ENDIF.

  ENDMETHOD.
  METHOD dame_hardcodes.
    CONSTANTS: lc_int TYPE repid VALUE 'INTF_OMP'.
    DATA: lt_hard TYPE STANDARD TABLE OF ztwm001.

    SELECT *
      FROM ztwm001
      INTO CORRESPONDING FIELDS OF TABLE lt_hard
      WHERE cprog = lc_int AND
            param2 = '01'.

    LOOP AT lt_hard ASSIGNING FIELD-SYMBOL(<h>).
      IF <h>-param1 = 'BWART'.
        ga_bwart = <h>-valor1.
      ELSEIF <h>-param1 = 'LGORT'.
        ga_lgort = <h>-valor1.
      ELSEIF <h>-param1 = 'WERKS'.
        ga_werks = <h>-valor1.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.
  METHOD dame_material.
    DATA: lt_str       TYPE TABLE OF string,
          lv_str       TYPE string,
          lv_matnr     TYPE matnr,
          lv_cal(3),
          lv_grama     TYPE zgramaje,
          lv_ancho     TYPE zancho,
          lv_val_ext   TYPE zedpi0005,
          lv_valor_sap TYPE zedpi0004,
          lv_matkl     TYPE matkl,
          lv_mtart     TYPE mtart,
          lt_mara      TYPE STANDARD TABLE OF mara.

    IF iv_str IS NOT INITIAL.

      SPLIT iv_str AT '/' INTO TABLE lt_str.

      LOOP AT lt_str ASSIGNING FIELD-SYMBOL(<l>).
        CASE sy-tabix.
          WHEN '1'.
            IF <l> EQ 'PAP'.
              lv_mtart = 'ZPAP'.
            ENDIF.
          WHEN '2'.
            SPLIT <l> AT space INTO lv_cal lv_grama.
            IF lv_grama NE space.
              CONDENSE: lv_cal.
              CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
                EXPORTING
                  input  = lv_grama
                IMPORTING
                  output = lv_grama.

            ELSE.
*             sera preimpreso?
              CLEAR: lv_cal, lv_grama.
              lv_mtart = 'ZPIM'.
              CONCATENATE 'P0' <l> '%' INTO lv_matnr.
            ENDIF.
          WHEN '3'.
            MOVE <l> TO lv_ancho. CONDENSE lv_ancho.
          WHEN OTHERS .
        ENDCASE.

      ENDLOOP.

      IF lv_cal IS NOT INITIAL.

        SELECT SINGLE valor_externo
          FROM ztpi0013
          INTO lv_val_ext
          WHERE calidad = lv_cal.

        IF sy-subrc EQ 0.

          SELECT SINGLE zvalor_sap
            FROM ztpi0003
            INTO lv_valor_sap
            WHERE zcodigo = '5' AND
                  werks = '2000' AND
                  zvalor_externo = lv_val_ext.

          IF sy-subrc EQ 0.

            MOVE lv_valor_sap TO lv_matkl.


            IF lv_mtart IS INITIAL.
              SELECT SINGLE matnr FROM mara
                INTO lv_matnr
                WHERE matkl = lv_matkl AND
                      zzgramaje = lv_grama AND
                      zzancho = lv_ancho.
            ELSE.
              SELECT SINGLE matnr FROM mara
                INTO lv_matnr
                WHERE mtart = lv_mtart AND
                      matkl = lv_matkl AND
                      zzgramaje = lv_grama AND
                      zzancho = lv_ancho.
            ENDIF.

            IF sy-subrc EQ 0.
              cv_matnr = lv_matnr.
            ELSE.
              RAISE no_material_found.
            ENDIF.

          ELSE.
            RAISE e_valor_sap.
          ENDIF.

        ELSE.
          RAISE e_valor_externo.
        ENDIF.

      ELSE.
        IF lv_matnr IS NOT INITIAL.

          SELECT *
            FROM mara
            INTO CORRESPONDING FIELDS OF TABLE lt_mara
            WHERE matnr LIKE lv_matnr.

          IF sy-subrc EQ 0.
            CLEAR lv_matnr.

            LOOP AT lt_mara ASSIGNING FIELD-SYMBOL(<ls>).
              MOVE <ls>-matnr+6(4) TO lv_grama.
              MOVE <ls>-matnr+10(4) TO lv_ancho.
              IF lv_grama EQ <ls>-zzgramaje AND lv_ancho EQ <ls>-zzancho.
                lv_matnr = <ls>-matnr.
                EXIT.
              ENDIF.
            ENDLOOP.
            IF lv_matnr IS INITIAL.
              RAISE e_mat_zpim_not_found.
            ELSE.
              cv_matnr = lv_matnr.
            ENDIF.
          ENDIF.
        ELSE.
          RAISE e_calidad_vacia.
        ENDIF.

      ENDIF.

    ELSE.
      RAISE e_sin_valor.
    ENDIF.
  ENDMETHOD.
  METHOD dame_tabla_creadas.
    DATA: lv_aux     TYPE string,
          lt_message TYPE soli_tab,
          ls_log type treg_log,
          ls_message TYPE soli.

    ls_message-line = '<b> <u>·<p> Resumen de NTs creadas por cinumber </b> </u/> </p>'.
    APPEND ls_message TO lt_message.

    CONCATENATE '<table style="width:100%">' gac_tr
                gac_th 'CInumber' gac_thf
                gac_th 'PaperStation' gac_thf
                gac_th 'NT' gac_thf
                gac_th 'Material' gac_thf
                gac_th 'Cantidad' gac_thf gac_trf
                INTO ls_message-line.
    APPEND ls_message TO lt_message.

    LOOP AT gat_log INTO ls_log.
      CLEAR ls_message.
      IF ls_log-ok_1 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation1' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ok_1 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_1 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_1 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ok_2 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation2' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ok_2 gac_tdf    INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_2 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_2 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ok_3 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation3' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ok_3 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_3 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_3 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ok_4 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation4' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ok_4 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_4 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_4 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ok_5 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation5' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ok_5 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_5 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_5 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ok_6 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation6' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ok_6 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_6 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_6 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.

    ENDLOOP.
    ls_message-line = '</table>'.
    APPEND ls_message TO lt_message.

    APPEND LINES OF lt_message TO pt_mess.

  ENDMETHOD.
  METHOD dame_table_erroes.
    DATA: ls_message TYPE soli,
          lt_message TYPE soli_tab,
          ls_log     TYPE treg_log,
          lv_aux     TYPE string.

    ls_message-line = '<b> <u>·<p> Resumen de errores por cinumber </b> </u/> </p>'.
    APPEND ls_message TO lt_message.

    CONCATENATE '<table style="width:100%">' gac_tr
                gac_th 'CInumber' gac_thf
                gac_th 'PaperStation' gac_thf
                gac_th 'Error' gac_thf
                gac_th 'Material' gac_thf
                gac_th 'Cantidad' gac_thf gac_trf
                INTO ls_message-line.
    APPEND ls_message TO lt_message.

    LOOP AT gat_log INTO ls_log.
      CLEAR ls_message.
      IF ls_log-ko_1 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation1' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ko_1 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_1 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_1 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ko_2 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation2' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ko_2 gac_tdf    INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_2 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_2 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ko_3 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation3' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ko_3 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_3 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_3 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ko_4 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation4' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ko_4 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_4 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_4 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ko_5 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation5' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ko_5 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_5 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_5 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ko_6 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation6' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ko_6 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_6 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_6 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.

    ENDLOOP.
    ls_message-line = '</table>'.
    APPEND ls_message TO lt_message.

    APPEND LINES OF lt_message TO pt_mess.
  ENDMETHOD.
  METHOD envia_mail_notificacion.
    CONSTANTS: lc_th(4)  VALUE '<th>',
               lc_thf(5) VALUE '</th>',
               lc_tr(4)  VALUE '<tr>',
               lc_trf(5) VALUE '</tr>',
               lc_td(4)  VALUE '<td>',
               lc_tdf(5) VALUE '</td>'.

    DATA: ls_mails       TYPE ztmm0025,
          lt_addr        TYPE bcsy_smtpa,
          lo_send_email  TYPE REF TO cl_bcs,
          lo_document    TYPE REF TO cl_document_bcs,
          lo_recipient   TYPE REF TO if_recipient_bcs,
          lv_sent_to_all TYPE os_boolean,
          lo_sender      TYPE REF TO cl_cam_address_bcs,
          lv_sender      TYPE adr6-smtp_addr,
          lv_subject     TYPE so_obj_des,
          lt_message     TYPE soli_tab,
          ls_message     TYPE soli,
          ls_ltbk        TYPE ltbk,
          lv_lin         TYPE i,
          ls_ret         TYPE bapiret2,
          lv_message     TYPE bapi_msg,
          lv_aux         TYPE string,
          ls_log         TYPE treg_log.

    SELECT SINGLE * FROM ztmm0025
      INTO ls_mails
      WHERE werks EQ ga_werks AND
            proceso = '3'.

    IF sy-subrc EQ 0 AND ls_mails IS NOT INITIAL.

      IF ls_mails-email1 NE space.
        APPEND ls_mails-email1 TO lt_addr.
      ENDIF.
      IF ls_mails-email2 NE space.
        APPEND ls_mails-email2 TO lt_addr.
      ENDIF.
      IF ls_mails-email3 NE space.
        APPEND ls_mails-email3 TO lt_addr.
      ENDIF.
      IF ls_mails-email4 NE space.
        APPEND ls_mails-email4 TO lt_addr.
      ENDIF.

* Inicialización de la clase
      lo_send_email = cl_bcs=>create_persistent( ).

* Cuerpo del email

* Necesidades borradas
      LOOP AT gat_borradas INTO ls_ltbk.
        IF sy-tabix EQ 1.
          DESCRIBE TABLE gat_borradas LINES lv_lin.
          MOVE lv_lin TO lv_aux.
          CONDENSE lv_aux.
          CONCATENATE '<font size="+3"> <b> <u>·<p> Necesidades borradas. Total ' lv_aux '</b> </u/> </p> </font>' INTO lv_aux SEPARATED BY space.
          ls_message-line = lv_aux.
          APPEND ls_message TO lt_message.
          CLEAR ls_message.
        ENDIF.
        CONCATENATE '<p> Nº necesidad' ls_ltbk-tbnum 'Texto' ls_ltbk-tbktx INTO lv_aux SEPARATED BY space.
        ls_message-line = lv_aux.
        APPEND ls_message TO lt_message.
        CLEAR ls_message.
      ENDLOOP.

* Necesidades Modificadas
      LOOP AT gat_modificadas INTO ls_ltbk.
        IF sy-tabix EQ 1.
          DESCRIBE TABLE gat_modificadas LINES lv_lin.
          MOVE lv_lin TO lv_aux.
          CONDENSE lv_aux.
          CONCATENATE '<font size="+3">·<b> <u>·<p>  Necesidades modificadas . Total ' lv_aux '</b> </u/> </p> </font>' INTO lv_aux SEPARATED BY space.
          ls_message-line = lv_aux.
          APPEND ls_message TO lt_message.
          CLEAR ls_message.
        ENDIF.
        CONCATENATE '<p>Nº necesidad' ls_ltbk-tbnum 'Texto' ls_ltbk-tbktx '</p>' INTO lv_aux SEPARATED BY space.
        ls_message-line = lv_aux.
        APPEND ls_message TO lt_message.
        CLEAR ls_message.
      ENDLOOP.

      ls_message-line = '<font size="+3"> <b> <u>·<p> Resumen del resultado del fichero </p></font>'.
      APPEND ls_message TO lt_message.
      ls_message-line = text-sty.
      APPEND ls_message TO lt_message.

* tabla resumen de NTs creadas
      dame_tabla_creadas( CHANGING pt_mess = lt_message ).

* tabla resumen de errores
      dame_table_erroes( CHANGING pt_mess = lt_message ).


* Crear documento
      lv_subject = 'Log de Interface OMP a SAP'.

      lo_document =  cl_document_bcs=>create_document( i_type    =  'HTM'
                                                        i_subject =  lv_subject
                                                        i_text    =  lt_message ).
* Enviar documento al email
      lo_send_email->set_document( lo_document ).

* Añadir remitente
      lv_sender = 'sap@hinojosa.es'.
      lo_sender = cl_cam_address_bcs=>create_internet_address( lv_sender  ).
      lo_send_email->set_sender( i_sender = lo_sender ).

* Añadir destinatarios al email
      LOOP AT lt_addr ASSIGNING FIELD-SYMBOL(<fs_addr>).
        lo_recipient = cl_cam_address_bcs=>create_internet_address( <fs_addr> ).
        lo_send_email->add_recipient( i_recipient = lo_recipient ).
      ENDLOOP.
      IF ls_mails-lista NE space. " 58445 - Envío a listas de distribución
        lo_recipient = cl_distributionlist_bcs=>getu_persistent( i_dliname = ls_mails-lista i_private = space ).
        lo_send_email->add_recipient( i_recipient = lo_recipient i_express = 'X' ).
      ENDIF.

* Enviar email
      TRY.
          lv_sent_to_all = lo_send_email->send( i_with_error_screen = 'X' ).
        CATCH cx_send_req_bcs .

      ENDTRY.

*  COMMIT WORK. " no se puede porque estamos en UPDATE!

      IF lv_sent_to_all EQ 'X'.
*   Enviado Correctamente
      ELSE.
*   Error al enviar
      ENDIF.

    ENDIF.

  ENDMETHOD.
  METHOD error_material_log.
    CASE pi_subrc.
      WHEN 1.
        MOVE text-e01 TO pc_ko.
      WHEN 2.
        MOVE text-e02 TO pc_ko.
      WHEN 3.
        MOVE text-e03 TO pc_ko.
      WHEN 4.
        MOVE text-e04 TO pc_ko.
      WHEN 5.
      WHEN 6.
        MOVE text-e06 TO pc_ko.
    ENDCASE.

  ENDMETHOD.
  METHOD f_bdc_dynpro.
    DATA: ls_bdc TYPE bdcdata.

    ls_bdc-program  = pe_prog.
    ls_bdc-dynpro   = pe_dyn.
    ls_bdc-dynbegin = abap_true.
    APPEND ls_bdc TO gat_bdcdata.

  ENDMETHOD.
  METHOD f_bdc_field.
    DATA: ls_bdc TYPE bdcdata.

    IF pe_fval  <> gac_nodata.
      ls_bdc-fnam  = pe_fnam.
      ls_bdc-fval   = pe_fval.
      APPEND ls_bdc TO gat_bdcdata.
    ENDIF.
  ENDMETHOD.
  METHOD notifica_borrada.
    DATA: ls_ltbk TYPE ltbk.

    SELECT SINGLE *
      FROM ltbk
      INTO CORRESPONDING FIELDS OF ls_ltbk
      WHERE lgnum = pi_lgnum AND
            tbnum = pi_tbnum.

    IF sy-subrc EQ 0.
      APPEND ls_ltbk TO gat_borradas.
    ENDIF.
  ENDMETHOD.
  METHOD notifica_modificada.

    IF pi_ltbk IS NOT INITIAL.
      APPEND pi_ltbk TO gat_modificadas.
    ENDIF.
  ENDMETHOD.
  METHOD zii_si_omp_prod_replenishment~si_omp_prod_replenishment_in_o.
*** **** INSERT IMPLEMENTATION HERE **** ***

    DATA: ls_data     TYPE zdt_omp_prod_replenishment_in,
          lv_name     TYPE string,
          lv_str      TYPE string,
          ls_ltbk     TYPE ltbk,
          ls_ltbp     TYPE ltbp,
          lt_ltbk     TYPE gtyp_ltbk,
          lt_ltbp     TYPE gtyp_ltbp,
          lv_lgnum    TYPE lgnum,
          lv_tbnum    TYPE tbnum,
          ls_log      TYPE treg_log,
          lv_aux_trim TYPE lqua_gesme,
          lv_aux2     TYPE string.

    CLEAR gav_hay_error.
* 0.- cargamos hardcodes
    dame_hardcodes( ).

* 1.- las otras NTs, modificadas van al log
    carga_nt_modificadas( ).

* 2.- borrado de NTs abiertas sin modificacion
    borra_nt_abiertas( ).

* 4.- Generamos las NTs en SAP
*     Recorremos los datos de entrada para procesarlos
    MOVE input-mt_omp_prod_replenishment_in_o-message-name TO lv_name.

    LOOP AT input-mt_omp_prod_replenishment_in_o-message-ompci ASSIGNING FIELD-SYMBOL(<ls>).
      CLEAR ls_log.
      CLEAR ls_ltbk.
      MOVE <ls>-cinumber TO: ls_ltbk-benum,
                             ls_log-cinumber.

*      MOVE <ls>-start_date TO ls_ltbk-pdatu.
      CONCATENATE <ls>-start_date+6(4) <ls>-start_date+3(2) <ls>-start_date+0(2) INTO ls_ltbk-bdatu.
      CONCATENATE <ls>-start_date+11(2) <ls>-start_date+14(2) <ls>-start_date+17(2) INTO ls_ltbk-bzeit.

*      MOVE <ls>-end_date TO ls_ltbk-pzeit.
      CONCATENATE <ls>-end_date+6(4) <ls>-end_date+3(2) <ls>-end_date+0(2) INTO ls_ltbk-pdatu.
      CONCATENATE <ls>-end_date+11(2) <ls>-end_date+14(2) <ls>-end_date+17(2) INTO ls_ltbk-pzeit.

* <ls>-CISTATUS
      MOVE <ls>-quality TO lv_str.
      REPLACE ALL OCCURRENCES OF <ls>-flute_type IN lv_str WITH space.
      CONDENSE lv_str.
      lv_aux_trim = <ls>-planned_trim.
      IF lv_aux_trim IS NOT INITIAL.
        lv_aux_trim = lv_aux_trim * 1000.
        lv_aux2 = lv_aux_trim.
      ENDIF.

      CONCATENATE <ls>-reel_width
                  lv_str
                  <ls>-flute_type
                  lv_aux2
                  INTO ls_ltbk-lznum "ls_ltbk-tbktx
                  SEPARATED BY '/'.
* <ls>-PLANNED_LINEAL
      REFRESH: lt_ltbp, lt_ltbk.

      MOVE <ls>-paper_station1 TO lv_str.
      dame_material( EXPORTING iv_str = lv_str CHANGING cv_matnr = ls_ltbp-matnr
                     EXCEPTIONS
                       no_material_found = 1
                       e_calidad_vacia   = 2
                       e_valor_externo   = 3
                       e_valor_sap       = 4
                       e_sin_valor       = 5
                       e_mat_zpim_not_found = 6
                       OTHERS            = 7 ).
      IF sy-subrc EQ 0.
        MOVE <ls>-paper1length_m TO ls_ltbp-menge.
        MOVE 'M' TO ls_ltbp-meins.
* <ls>-PAPER1WEIGHT_KG
        MOVE ga_werks TO ls_ltbp-werks.
        ls_ltbk-nlpla = 'BHS1'.
        MOVE <ls>-comment TO ls_ltbk-tbktx. "ls_ltbk-lznum.

        SELECT SINGLE lgnum lgtyp
          FROM lagp
          INTO ( ls_ltbk-lgnum, ls_ltbk-nltyp )
          WHERE lgpla = ls_ltbk-nlpla.

        ls_ltbp-lgnum = ls_ltbk-lgnum.

        APPEND ls_ltbp TO lt_ltbp.
        APPEND ls_ltbk TO lt_ltbk.

        crear_nts( EXPORTING pi_index = sy-tabix
                   CHANGING pt_ltbk = lt_ltbk
                            pt_ltbp = lt_ltbp
                            pc_ok = ls_log-ok_1
                            pc_ko = ls_log-ko_1 ).
*       movemos al log el material y la cantidad
        MOVE ls_ltbp-menge TO ls_log-menge_1.
        MOVE ls_ltbp-matnr TO ls_log-matnr_1.
      ELSE.
        IF sy-subrc <> 5. " si no hay material informado, no es un error
          MOVE <ls>-paper1length_m TO ls_log-menge_1.
          MOVE lv_str TO ls_log-matnr_1.
          ls_log-ko_1 = error_material_log( EXPORTING pi_subrc = sy-subrc ).
          gav_hay_error = abap_true.
        ENDIF.
      ENDIF.

      REFRESH: lt_ltbp, lt_ltbk.
      MOVE <ls>-paper_station2 TO lv_str.
      dame_material( EXPORTING iv_str = lv_str CHANGING cv_matnr = ls_ltbp-matnr
                     EXCEPTIONS
                       no_material_found = 1
                       e_calidad_vacia   = 2
                       e_valor_externo   = 3
                       e_valor_sap       = 4
                       e_sin_valor       = 5
                       e_mat_zpim_not_found = 6
                       OTHERS            = 7 ).
      IF sy-subrc EQ 0.
        MOVE <ls>-paper2length_m TO ls_ltbp-menge.
        MOVE 'M' TO ls_ltbp-meins.
* <ls>-PAPER2WEIGHT_KG
        MOVE ga_werks TO ls_ltbp-werks.
        ls_ltbk-nlpla = 'BHS2'.
        MOVE <ls>-comment TO ls_ltbk-tbktx. "ls_ltbk-lznum.

        SELECT SINGLE lgnum lgtyp
          FROM lagp
          INTO ( ls_ltbk-lgnum, ls_ltbk-nltyp )
          WHERE lgpla = ls_ltbk-nlpla.

        ls_ltbp-lgnum = ls_ltbk-lgnum.

        APPEND ls_ltbp TO lt_ltbp.
        APPEND ls_ltbk TO lt_ltbk.

        crear_nts( EXPORTING pi_index = sy-tabix
                   CHANGING pt_ltbk = lt_ltbk
                            pt_ltbp = lt_ltbp
                            pc_ok = ls_log-ok_2
                            pc_ko = ls_log-ko_2 ).
*       movemos al log el material y la cantidad
        MOVE ls_ltbp-menge TO ls_log-menge_2.
        MOVE ls_ltbp-matnr TO ls_log-matnr_2.
      ELSE.
        IF sy-subrc <> 5. " si no hay material informado, no es un error
          MOVE <ls>-paper2length_m TO ls_log-menge_2.
          MOVE lv_str TO ls_log-matnr_2.
          ls_log-ko_2 = error_material_log( EXPORTING pi_subrc = sy-subrc ).
          gav_hay_error = abap_true.
        ENDIF.
      ENDIF.

      REFRESH: lt_ltbp, lt_ltbk.
      MOVE <ls>-paper_station3 TO lv_str.
      dame_material( EXPORTING iv_str = lv_str CHANGING cv_matnr = ls_ltbp-matnr
                     EXCEPTIONS
                       no_material_found = 1
                       e_calidad_vacia   = 2
                       e_valor_externo   = 3
                       e_valor_sap       = 4
                       e_sin_valor       = 5
                       e_mat_zpim_not_found = 6
                       OTHERS            = 7 ).
      IF sy-subrc EQ 0.
        MOVE <ls>-paper3length_m TO ls_ltbp-menge.
        MOVE 'M' TO ls_ltbp-meins.
* <ls>-PAPER3WEIGHT_KG
        MOVE ga_werks TO ls_ltbp-werks.
        ls_ltbk-nlpla = 'BHS3'.
        MOVE <ls>-comment TO ls_ltbk-tbktx. "ls_ltbk-lznum.

        SELECT SINGLE lgnum lgtyp
          FROM lagp
          INTO ( ls_ltbk-lgnum, ls_ltbk-nltyp )
          WHERE lgpla = ls_ltbk-nlpla.

        ls_ltbp-lgnum = ls_ltbk-lgnum.

        APPEND ls_ltbp TO lt_ltbp.
        APPEND ls_ltbk TO lt_ltbk.

        crear_nts( EXPORTING pi_index = sy-tabix
                   CHANGING pt_ltbk = lt_ltbk
                            pt_ltbp = lt_ltbp
                            pc_ok = ls_log-ok_3
                            pc_ko = ls_log-ko_3 ).
*       movemos al log el material y la cantidad
        MOVE ls_ltbp-menge TO ls_log-menge_3.
        MOVE ls_ltbp-matnr TO ls_log-matnr_3.
      ELSE.
        IF sy-subrc <> 5. " si no hay material informado, no es un error
          MOVE <ls>-paper3length_m TO ls_log-menge_3.
          MOVE lv_str TO ls_log-matnr_3.
          ls_log-ko_3 = error_material_log( EXPORTING pi_subrc = sy-subrc ).
          gav_hay_error = abap_true.
        ENDIF.
      ENDIF.

      REFRESH: lt_ltbp, lt_ltbk.
      MOVE <ls>-paper_station4 TO lv_str.
      dame_material( EXPORTING iv_str = lv_str CHANGING cv_matnr = ls_ltbp-matnr
                     EXCEPTIONS
                       no_material_found = 1
                       e_calidad_vacia   = 2
                       e_valor_externo   = 3
                       e_valor_sap       = 4
                       e_sin_valor       = 5
                       e_mat_zpim_not_found = 6
                       OTHERS            = 7 ).
      IF sy-subrc EQ 0.
        MOVE <ls>-paper4length_m TO ls_ltbp-menge.
        MOVE 'M' TO ls_ltbp-meins.
* <ls>-PAPER4WEIGHT_KG
        MOVE ga_werks TO ls_ltbp-werks.
        ls_ltbk-nlpla = 'BHS4'.
        MOVE <ls>-comment TO ls_ltbk-tbktx. "ls_ltbk-lznum.

        SELECT SINGLE lgnum lgtyp
          FROM lagp
          INTO ( ls_ltbk-lgnum, ls_ltbk-nltyp )
          WHERE lgpla = ls_ltbk-nlpla.

        ls_ltbp-lgnum = ls_ltbk-lgnum.

        APPEND ls_ltbp TO lt_ltbp.
        APPEND ls_ltbk TO lt_ltbk.

        crear_nts( EXPORTING pi_index = sy-tabix
                   CHANGING pt_ltbk = lt_ltbk
                            pt_ltbp = lt_ltbp
                            pc_ok = ls_log-ok_4
                            pc_ko = ls_log-ko_4 ).
*       movemos al log el material y la cantidad
        MOVE ls_ltbp-menge TO ls_log-menge_4.
        MOVE ls_ltbp-matnr TO ls_log-matnr_4.
      ELSE.
        IF sy-subrc <> 5. " si no hay material informado, no es un error
          MOVE <ls>-paper4length_m TO ls_log-menge_4.
          MOVE lv_str TO ls_log-matnr_4.
          ls_log-ko_4 = error_material_log( EXPORTING pi_subrc = sy-subrc ).
          gav_hay_error = abap_true.
        ENDIF.
      ENDIF.

      REFRESH: lt_ltbp, lt_ltbk.
      MOVE <ls>-paper_station5 TO lv_str.
      dame_material( EXPORTING iv_str = lv_str CHANGING cv_matnr = ls_ltbp-matnr
                     EXCEPTIONS
                       no_material_found = 1
                       e_calidad_vacia   = 2
                       e_valor_externo   = 3
                       e_valor_sap       = 4
                       e_sin_valor       = 5
                       e_mat_zpim_not_found = 6
                       OTHERS            = 7 ).
      IF sy-subrc EQ 0.
        MOVE <ls>-paper5length_m TO ls_ltbp-menge.
        MOVE 'M' TO ls_ltbp-meins.
* <ls>-PAPER5WEIGHT_KG
        MOVE ga_werks TO ls_ltbp-werks.
        ls_ltbk-nlpla = 'BHS5'.
        MOVE <ls>-comment TO ls_ltbk-tbktx. "ls_ltbk-lznum.

        SELECT SINGLE lgnum lgtyp
          FROM lagp
          INTO ( ls_ltbk-lgnum, ls_ltbk-nltyp )
          WHERE lgpla = ls_ltbk-nlpla.

        ls_ltbp-lgnum = ls_ltbk-lgnum.

        APPEND ls_ltbp TO lt_ltbp.
        APPEND ls_ltbk TO lt_ltbk.

        crear_nts( EXPORTING pi_index = sy-tabix
                   CHANGING pt_ltbk = lt_ltbk
                            pt_ltbp = lt_ltbp
                            pc_ok = ls_log-ok_5
                            pc_ko = ls_log-ko_5 ).
*       movemos al log el material y la cantidad
        MOVE ls_ltbp-menge TO ls_log-menge_5.
        MOVE ls_ltbp-matnr TO ls_log-matnr_5.
      ELSE.
        IF sy-subrc <> 5. " si no hay material informado, no es un error
          MOVE <ls>-paper5length_m TO ls_log-menge_5.
          MOVE lv_str TO ls_log-matnr_5.
          ls_log-ko_5 = error_material_log( EXPORTING pi_subrc = sy-subrc ).
          gav_hay_error = abap_true.
        ENDIF.
      ENDIF.

      REFRESH: lt_ltbp, lt_ltbk.
      MOVE <ls>-paper_station6 TO lv_str.
      dame_material( EXPORTING iv_str = lv_str CHANGING cv_matnr = ls_ltbp-matnr
                     EXCEPTIONS
                       no_material_found = 1
                       e_calidad_vacia   = 2
                       e_valor_externo   = 3
                       e_valor_sap       = 4
                       e_sin_valor       = 5
                       e_mat_zpim_not_found = 6
                       OTHERS            = 7 ).

      IF sy-subrc EQ 0.
        MOVE <ls>-paper6length_m TO ls_ltbp-menge.
        MOVE 'M' TO ls_ltbp-meins.
        MOVE ga_werks TO ls_ltbp-werks.
        ls_ltbk-nlpla = 'BHS6'.
        MOVE <ls>-comment TO ls_ltbk-tbktx. "ls_ltbk-lznum.

        SELECT SINGLE lgnum lgtyp
          FROM lagp
          INTO ( ls_ltbk-lgnum, ls_ltbk-nltyp )
          WHERE lgpla = ls_ltbk-nlpla.

        ls_ltbp-lgnum = ls_ltbk-lgnum.

        APPEND ls_ltbp TO lt_ltbp.
        APPEND ls_ltbk TO lt_ltbk.

        crear_nts( EXPORTING pi_index = sy-tabix
                   CHANGING pt_ltbk = lt_ltbk
                            pt_ltbp = lt_ltbp
                            pc_ok = ls_log-ok_6
                            pc_ko = ls_log-ko_6 ).
*       movemos al log el material y la cantidad
        MOVE ls_ltbp-menge TO ls_log-menge_6.
        MOVE ls_ltbp-matnr TO ls_log-matnr_6.
      ELSE.
        IF sy-subrc <> 5. " si no hay material informado, no es un error
          MOVE <ls>-paper6length_m TO ls_log-menge_6.
          MOVE lv_str TO ls_log-matnr_6.
          ls_log-ko_6 = error_material_log( EXPORTING pi_subrc = sy-subrc ).
          gav_hay_error = abap_true.
        ENDIF.
      ENDIF.

      APPEND ls_log TO gat_log.

    ENDLOOP.

* 3.- se envia notificacion necesidades creadas/borradas/modificadas

*   Solo enviamos el mail si hay algun error
    IF gav_hay_error NE space.
      envia_mail_notificacion( ).
      CLEAR gav_hay_error.
    ENDIF.

  ENDMETHOD.
