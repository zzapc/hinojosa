************************************************************************
* APLICACION  : BC                                                    *
* TIPO        : Listado
* TITULO      : Listado seguimiento desarrollos
* DESCRIPCION :
* VERSION     : 0.72
*                                                                      *
*AUTOR: Andres Picazo                           FECHA: 28/02/2007      *
* MODIFICACIONES                                                       *
* -------------                                                        *
* FECHA        NOMBRE                               ORDEN              *
* -------------------------------------------------------------------- *
* dd.mm.yyyy   username                                                *
************************************************************************
REPORT zbcut011
      NO STANDARD PAGE HEADING
      LINE-COUNT 065
      LINE-SIZE 100.

* Trampo status
* inlclude LSMPIF03 linea 62 form check_adm tables
*if sy-uname = zcl_c=>usuario_ap. exit. endif.

*------INCLUDES--------------------------------------------------------*

CONSTANTS c_version TYPE p LENGTH 8 DECIMALS 0 VALUE 20180410.

*------TABLAS/ESTRUCTURAS----------------------------------------------*
TABLES:
  cross,
  trdir,
  tadir,
  ddtypes,
  tfdir,
  v_fdirt,
  stxh,
  zbc003,
  zbc003t,
  stxfadm,
  modtext,
  modact,
  modsap,
  tstcp,
  ttxfp,
  dd02l,
  smimloio,
  e071,
  rseuinc,
  dd40l,
  dd04l,
  dd01l,
  dd02t,
  o2xsltdesc,
  hrs1000,
  sscrfields,
  tstc.

DATA: i_listado         TYPE TABLE OF zest_zbc003 WITH HEADER LINE,
      i_list_orig       TYPE TABLE OF zest_zbc003 WITH HEADER LINE,
      i_list            TYPE TABLE OF zest_zbc003 WITH HEADER LINE,
      l_listado         TYPE zest_zbc003,
      enhincinx         TYPE enhincinx,
      fpcontext         TYPE fpcontext,
      fpinterface       TYPE fpinterface,
      v_ruta_comparador TYPE string,
      o_ms              TYPE REF TO zcl_ap_mgraph.

DATA: BEGIN OF i_list_excel OCCURS 0,
        object           TYPE zest_zbc003-object,
        name             TYPE zest_zbc003-name,
        text             TYPE zest_zbc003-text,
        devclass         TYPE zest_zbc003-devclass,
        tcode            TYPE zest_zbc003-tcode,
        ttext            TYPE zest_zbc003-ttext,
        cnam             TYPE zest_zbc003-cnam,
        cdat             TYPE zest_zbc003-cdat,
        unam             TYPE zest_zbc003-unam,
        udat             TYPE zest_zbc003-udat,
        hash             TYPE zest_zbc003-hash,
        cliente_descarga TYPE zest_zbc003-cliente_descarga,
        fecha_descarga   TYPE zest_zbc003-fecha_descarga,
      END OF i_list_excel,
      i_list_excel_dic LIKE i_list_excel OCCURS 0,
      i_list_excel_ext LIKE i_list_excel OCCURS 0,
      i_list_excel_opn LIKE i_list_excel OCCURS 0,
      i_list_excel_gen LIKE i_list_excel OCCURS 0,
      i_list_excel_tmp LIKE i_list_excel OCCURS 0,
      v_text1          TYPE string,
      v_text2          TYPE string.

DATA i_source TYPE TABLE OF text255 WITH HEADER LINE.

DATA: BEGIN OF i_cambios OCCURS 0,
        name    TYPE trdir-name,
        vrsflag TYPE vxabapt255-vrsflag,
        number  TYPE vxabapt255-number,
        line    TYPE vxabapt255-line,
      END OF i_cambios,
      i_camb    TYPE TABLE OF vxabapt255,
      l_camb    TYPE vxabapt255,
      l_cambios LIKE i_cambios,
      i_grupof  TYPE TABLE OF string WITH HEADER LINE.

*------VARIABLES-------------------------------------------------------*
DATA: sgpi  TYPE REF TO zcl_ap_sgpi,
      o_alv TYPE REF TO zcl_ap_alv_grid,
      o_enh TYPE REF TO cl_enh_editor_navigator.

DATA: BEGIN OF i_ztasks OCCURS 0,
        cliente         TYPE c LENGTH 3,
        objeto          TYPE c LENGTH 30,
        descripcion_obj TYPE c LENGTH 80,
        texto           TYPE string,
      END OF i_ztasks.


DATA v_directorio TYPE string.
DATA: v_ans                TYPE c LENGTH 1,
      v_emailaddr          TYPE c LENGTH 130,
      v_no_se_adjunta_slnk TYPE c LENGTH 1,
      v_fichero_excel      TYPE string,
      v_fichero_excel_dic  TYPE string,
      v_fichero_excel_ext  TYPE string,
      v_fichero_excel_opn  TYPE string,
      v_fichero_excel_gen  TYPE string,
      v_fichero_excel_tmp  TYPE string,
      i_ficheros_ftp       TYPE TABLE OF string WITH HEADER LINE.

DATA o_bi      TYPE REF TO zcl_ap_batch_input.
DATA l_mensaje TYPE bapireturn1-message.                    "#EC *

DATA o_prog    TYPE REF TO zcl_ap_dev.

RANGES: r_devclass_open FOR tadir-devclass,
        r_devclass_openf FOR tadir-devclass.

DEFINE addrango_eq.
  CLEAR &1.
  &1-option = 'EQ'.
  &1-sign   = 'I'.
  &1-low    = &2.
  APPEND &1.
END-OF-DEFINITION.


DEFINE addrango_neq.
  CLEAR &1.
  &1-option = 'EQ'.
  &1-sign   = 'E'.
  &1-low    = &2.
  APPEND &1.
END-OF-DEFINITION.

*----------------------------------------------------------------------*
* CLASS lcl_event_grid_100 DEFINITION
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
CLASS lcl_event_grid DEFINITION INHERITING FROM zcl_ap_alv_grid_eventos FINAL.
  PUBLIC SECTION.
    METHODS: double_click REDEFINITION,
      toolbar      REDEFINITION,
      user_command REDEFINITION.
ENDCLASS. " lcl_event_grid_100 DEFINITION

DATA: o_event        TYPE REF TO lcl_event_grid,
      v_fechas_vivas TYPE d,
      i_ficheros     TYPE TABLE OF file_info WITH HEADER LINE.

*------PARAMETER/SELECT-OPTIONS EN PANTALLA----------------------------*
SELECTION-SCREEN BEGIN OF BLOCK blk_par WITH FRAME TITLE TEXT-001.

SELECT-OPTIONS: s_tcode  FOR tstc-tcode,
                s_report FOR trdir-name,
                s_subc   FOR trdir-subc,
                s_devcla FOR tadir-devclass,
                s_estado FOR zbc003-estado,
                s_grupo  FOR zbc003-grupo,
                s_cdat   FOR trdir-cdat,
                s_udat   FOR trdir-udat,
                s_cnam   FOR trdir-cnam,
                s_unam   FOR trdir-unam,
                s_asign  FOR zbc003-asignado_a,
                s_progr  FOR zbc003-probado_por,
                s_prior  FOR zbc003-prioridad,
                s_ot     FOR e071-trkorr.

SELECTION-SCREEN SKIP.

PARAMETERS: p_report AS CHECKBOX DEFAULT 'X',
            p_funcio AS CHECKBOX DEFAULT ' ',
            p_clases AS CHECKBOX DEFAULT ' ',
            p_formul AS CHECKBOX DEFAULT ' ',
            p_proyec AS CHECKBOX DEFAULT ' ',
            p_badis  AS CHECKBOX DEFAULT ' ',
            p_userex AS CHECKBOX DEFAULT ' ',
            p_modife AS CHECKBOX DEFAULT ' ',
            p_rutina AS CHECKBOX DEFAULT ' ',
            p_tablas AS CHECKBOX DEFAULT ' ',
            p_cds    AS CHECKBOX DEFAULT ' ',
            p_enhan  AS CHECKBOX DEFAULT ' ',
            p_bte    AS CHECKBOX DEFAULT ' ',
            p_bsp    AS CHECKBOX DEFAULT ' ',
            p_mime   AS CHECKBOX DEFAULT ' ',
            p_webd   AS CHECKBOX DEFAULT '',
            p_pdf    AS CHECKBOX DEFAULT '',
            p_xslt   AS CHECKBOX DEFAULT '',
            p_wf     AS CHECKBOX DEFAULT ''.

SELECTION-SCREEN END OF BLOCK blk_par.

SELECTION-SCREEN BEGIN OF BLOCK blk_par3 WITH FRAME TITLE TEXT-003.
PARAMETERS: p_rfc    TYPE rfcdest,
            p_lib    AS CHECKBOX MODIF ID zap,
            p_solom  AS CHECKBOX MODIF ID zap,
            p_utili  AS CHECKBOX MODIF ID zap,
            p_numlin AS CHECKBOX MODIF ID zap,
            p_zip    AS CHECKBOX MODIF ID zap,
            p_outlo  AS CHECKBOX MODIF ID zap,
            p_ftp    AS CHECKBOX MODIF ID zap,
            p_origen DEFAULT 'L' MODIF ID zap,
            p_dirlib TYPE string MODIF ID zap,
            p_vivas  AS CHECKBOX MODIF ID zap,
            p_libt   AS CHECKBOX MODIF ID zap,
            p_hash   AS CHECKBOX MODIF ID zap,
            p_ext    AS CHECKBOX MODIF ID zap,
            p_open   AS CHECKBOX MODIF ID zap,
            p_gen    AS CHECKBOX MODIF ID zap,
            p_tmp    AS CHECKBOX MODIF ID zap,
            p_zipl   AS CHECKBOX DEFAULT 'X' MODIF ID zap,
            p_buscar TYPE text132,
            p_onedr  AS CHECKBOX MODIF ID zap USER-COMMAND one,
            p_dirto  TYPE text255 MODIF ID za2,
            p_rutaw  TYPE text255.
SELECTION-SCREEN SKIP.
PARAMETERS p_vari LIKE disvariant-variant.
SELECTION-SCREEN END OF BLOCK blk_par3.


************************************************************************
*
*                  LOGICA DEL PROGRAMA
*
************************************************************************


*----------------------------------------------------------------------*
* INITIALIZATION
*----------------------------------------------------------------------*
INITIALIZATION.
  o_prog = NEW #( get_nombre_pc = 'X' ).

  o_prog->initialization( EXPORTING nombre_pc = o_prog->nombre_pc CHANGING sscrfields = sscrfields ).

*  addrango_eq: s_subc '1',
*               s_subc 'M',
*               s_subc 'S'.

  addrango_neq: s_estado 'B',
                s_estado 'N',
                s_estado 'O'.

  IF sy-uname = zcl_c=>usuario_ap.
    SET PARAMETER ID 'SAPLINK_AUTHOR' FIELD 'APICAZO'.      "#EC *
  ENDIF.


AT SELECTION-SCREEN OUTPUT.
  IF NOT sy-uname = zcl_c=>usuario_ap.
    zcl_ap_dynpro=>screen_visible( group1 = 'ZAP' variable = '' ).
    CLEAR: p_lib, p_solom, p_onedr, p_dirto, p_dirlib, p_origen.
  ENDIF.
  zcl_ap_dynpro=>screen_visible( group1 = 'ZA2' variable = p_onedr ).

*----------------------------------------------------------------------
* START-OF-SELECTION.
*----------------------------------------------------------------------*
START-OF-SELECTION.
  IF p_vivas = 'X'.
    p_report = 'X'.
    p_funcio = 'X'.
    p_clases = 'X'.
    p_formul = 'X'.
*    p_proyec = 'X'.
*    p_badis  = 'X'.
    p_tablas = 'X'.
    p_pdf    = 'X'.
*    p_xslt   = 'X'.
    v_fechas_vivas = zcl_ap_temp=>get_st_valor1( clave = sy-tcode subclave = sy-uname ).
    IF v_fechas_vivas IS INITIAL.
      v_fechas_vivas = sy-datum - 365.
    ENDIF.
  ELSEIF p_libt = 'X'.
    p_lib = 'X'.
    p_solom = 'X'.
    p_report = 'X'.
    p_funcio = 'X'.
    p_clases = 'X'.
    p_tablas = 'X'.
    p_modife = 'X'.
*    v_fechas_vivas = sy-datum - 60.
*    CLEAR s_udat.
*    s_udat-option = 'GT'.
*    s_udat-sign = 'I'.
*    s_udat-low = v_fechas_vivas.
*    APPEND s_udat.
  ENDIF.

  IF p_lib = 'X' OR NOT p_rfc IS INITIAL.
    DATA v_merge TYPE string.
    v_merge = |C:\\Program Files\\WinMerge,C:\\Users\\andre\\OneDrive\\tools\\WinMerge,| &&
              |\\\\nws4101.stadlerrail.ch\\vdi_data_users$\\picand\\Desktop\\WinMerge\\WinMerge\\|.

    IF p_rutaw IS INITIAL.
      v_ruta_comparador = zcl_ap_ficheros=>buscar_ruta_fichero( fichero = 'WinMergeU.exe' rutas = v_merge ). "#EC *
    ELSE.
      v_ruta_comparador = p_rutaw.
    ENDIF.


  ENDIF.

  DATA: v_aux1 TYPE string,
        v_aux2 TYPE string.
  SPLIT zcl_c=>ruta_descarga_slnk AT '\CODIGO\Reports_slnk\' INTO v_aux1 v_aux2. "#EC *
  CONCATENATE '\CODIGO\Reports_slnk\' v_aux2 INTO v_aux1.   "#EC *

  IF p_onedr = 'X' AND NOT p_dirlib IS INITIAL.
    o_ms = NEW zcl_ap_mgraph( clave = 'ZAPC' json_parametros = p_dirlib ).
    IF NOT o_ms->message IS INITIAL.
      MESSAGE o_ms->message TYPE 'I'.
      RETURN.
    ENDIF.

    v_directorio = 'GD_LIB/LIB'.
    IF p_lib = 'X'.
      v_fichero_excel = |{ v_directorio }/libreria.xlsx|.
    ELSE.
      REPLACE '/LIB' IN v_directorio WITH v_aux1.
      REPLACE ALL OCCURRENCES OF '\' IN v_directorio WITH '/'.
      v_fichero_excel = |{ v_directorio }/desarrollos.xlsx|.
    ENDIF.
  ELSE.
    IF NOT p_dirlib IS INITIAL.
      v_directorio = p_dirlib.
    ELSE.

      DATA v_rlib TYPE string.
      v_rlib = |C:\\Users\\andre\\OneDrive - SAP4 Programing SL\\GD_LIB\\LIB,| &&
               |D:\\OneDrive - SAP4 Programing SL\\GD_LIB\\LIB,| &&
               |\\\\nws4101.stadlerrail.ch\\vdi_data_users$\\picand\\Downloads\\LIB|.
      v_directorio = zcl_ap_ficheros=>buscar_ruta_fichero( rutas = v_rlib ).
    ENDIF.

    IF p_lib IS INITIAL.
      IF v_directorio CS '\LIB\LIB'.
        REPLACE '\LIB\LIB' IN v_directorio WITH '\X||X\LIB'.
        REPLACE '\LIB' IN v_directorio WITH v_aux1.
        REPLACE '\X||X\' IN v_directorio WITH '\LIB\'.
      ELSE.
        REPLACE '\LIB' IN v_directorio WITH v_aux1.
      ENDIF.

      v_fichero_excel = zcl_ap_ficheros=>concat_ruta( directorio = v_directorio fichero = 'desarrollos.xlsx' ).
    ELSE.
      v_fichero_excel = zcl_ap_ficheros=>concat_ruta( directorio = v_directorio fichero = 'libreria.xlsx' ).
    ENDIF.
  ENDIF.

  IF p_hash IS INITIAL AND p_solom IS INITIAL AND p_lib IS INITIAL.
    CLEAR v_fichero_excel.
  ENDIF.

  IF p_solom = 'X' AND p_onedr IS INITIAL.
    i_ficheros[] = zcl_ap_ficheros=>lista_ficheros( directory = v_directorio max_ficheros = 99999 ).
    DELETE i_ficheros WHERE filelength = 0.
    DELETE i_ficheros WHERE NOT ( filename CS '.txt' OR filename CS '.slnk' ).
  ENDIF.

  sgpi = NEW #( ).
  o_bi = NEW #( ).

  IF NOT s_ot[] IS INITIAL.
    SELECT DISTINCT object, obj_name FROM e070 JOIN e071 ON e070~trkorr = e071~trkorr
      INTO TABLE @DATA(i_obj)
     WHERE ( e070~trkorr IN  @s_ot
          OR e070~strkorr IN @s_ot )
      AND obj_name IN @s_report
      AND object IN ('CINC', 'CLAS', 'CLSD', 'CPRI', 'CPRO', 'CPUB', 'CUAD', 'DDLS', 'DOMA', 'DOMD', 'DTEL', 'DYNP', 'ENHO', 'FUGR', 'FUNC', 'METH', 'PROG', 'REPS', 'REPT', 'SFPF', 'SFPI', 'TABD', 'TABL', 'TTYD', 'TTYP' ).

    LOOP AT i_obj ASSIGNING FIELD-SYMBOL(<obj>).
      CASE <obj>-object.
        WHEN 'METH' OR 'DYNP'.
          APPEND VALUE #( option = 'EQ' sign = 'I' low = <obj>-obj_name(30)  ) TO s_report[].
        WHEN 'CINC'.
          SPLIT <obj>-obj_name AT '=' INTO DATA(cl) DATA(otr).
          APPEND VALUE #( option = 'EQ' sign = 'I' low = cl ) TO s_report[].
        WHEN OTHERS.
          APPEND VALUE #( option = 'EQ' sign = 'I' low = <obj>-obj_name ) TO s_report[].
      ENDCASE.
    ENDLOOP.
  ENDIF.

  PERFORM seleccionar_datos.

  CALL SCREEN 0100.

************************************************************************
*
*                  FORMS ADICIONALES
*
************************************************************************

*&---------------------------------------------------------------------*

*&      Form  SELECCIONAR_DATOS
*&---------------------------------------------------------------------*
*       Selecciona las devoluciones
*----------------------------------------------------------------------*

FORM seleccionar_datos.
  DATA r_obj    TYPE TABLE OF rstt_s_range_string WITH HEADER LINE.
  DATA l_tabla  TYPE tabname VALUE 'ZESTADISTICAS'.
  DATA i_zbc003 LIKE zbc003 OCCURS 0 WITH HEADER LINE.
  DATA: l_aux1 TYPE c LENGTH 80,
        l_aux2 TYPE c LENGTH 80.
  DATA i_tadir     TYPE TABLE OF tadir WITH HEADER LINE.
  DATA i_enhincinx TYPE TABLE OF enhincinx WITH HEADER LINE.
  DATA: ev_include TYPE programm,
        ev_line    TYPE string.
  DATA l_ok TYPE c LENGTH 1.
  DATA: i_dd02l   TYPE TABLE OF dd02l WITH HEADER LINE,
        l_tabname LIKE d010tab-tabname,
        i_progs   LIKE d010tab OCCURS 0 WITH HEADER LINE.
  DATA i_tbe  TYPE TABLE OF tbe32 WITH HEADER LINE.
  DATA i_bsp  TYPE TABLE OF o2appl WITH HEADER LINE.
  DATA i_webd TYPE TABLE OF wdy_application WITH HEADER LINE.
  DATA: i_trdir LIKE trdir OCCURS 1000 WITH HEADER LINE,
        BEGIN OF i_tstc  OCCURS 300,
          pgmna LIKE tstc-pgmna,
          tcode LIKE tstc-tcode,
        END   OF i_tstc,
        BEGIN OF i_estad OCCURS 1000,
          report  TYPE c LENGTH 40, " LIKE zestadisticas-report,
          fecha   TYPE d,           " LIKE zestadisticas-fecha,

          account TYPE sy-uname,    " LIKE zestadisticas-account,
          total   TYPE i,
        END OF i_estad,
        l_aux   TYPE c LENGTH 60,
        i_est   LIKE i_estad OCCURS 100000 WITH HEADER LINE,
        l_fin   TYPE c LENGTH 1,
        l_tcode TYPE sy-tcode.

  CLEAR r_obj.
  r_obj-option = 'CP'.
  r_obj-sign   = 'I'.
  r_obj-low    = 'Z*'.
  APPEND r_obj.
  r_obj-low = 'Y*'.
  APPEND r_obj.
  IF p_ext = 'X'.
    IF sy-uname = zcl_c=>usuario_ap.
      r_obj-low = '/SOTHIS/*'.
      APPEND r_obj.
      r_obj-low = '/SEI/*'.
      APPEND r_obj.
      r_obj-low = '/MOVI/*'.
      APPEND r_obj.
      r_obj-low = '/COCKPIT/*'.
      APPEND r_obj.
      r_obj-low = '/IECI/*'.
      APPEND r_obj.
    ENDIF.
  ENDIF.

  r_devclass_open-option = 'CP'.
  IF p_open IS INITIAL.
    r_devclass_open-sign = 'E'.
  ELSE.
    r_devclass_open-sign = 'I'.
  ENDIF.
  r_devclass_open-low = 'ZABAPGIT*'. APPEND r_devclass_open.
  r_devclass_open-low = 'ZOPENCHECK*'. APPEND r_devclass_open.
  r_devclass_open-low = 'TEST_*'. APPEND r_devclass_open.
  r_devclass_open-low = 'ZAPCMD*'. APPEND r_devclass_open.
  r_devclass_open-low = 'ZABAP2XLSX*'. APPEND r_devclass_open.
  r_devclass_open-low = 'ZSAPLINK*'. APPEND r_devclass_open.

  IF p_open IS INITIAL.
    r_devclass_openf[] = r_devclass_open[].
  ENDIF.

  IF p_vivas IS INITIAL.
    SELECT tabname FROM dd02l
      UP TO 1 ROWS
      INTO l_tabla
     WHERE tabname = l_tabla
     ORDER BY PRIMARY KEY.
    ENDSELECT.
    IF sy-subrc = 0.
      SELECT * FROM (l_tabla)
        INTO CORRESPONDING FIELDS OF TABLE i_est
       WHERE report IN s_report
         AND ( report IN r_obj
          OR   report LIKE 'SAPMZ%' ).
      SORT i_est.
      LOOP AT i_est.
        AT NEW report.
          CLEAR i_estad.
          CLEAR l_fin.
        ENDAT.
        i_estad-total = i_estad-total + 1.
        AT END OF report.
          l_fin = 'X'.
        ENDAT.
        IF l_fin = 'X'.
          i_estad-report  = i_est-report.
          i_estad-fecha   = i_est-fecha.
          i_estad-account = i_est-account.
          APPEND i_estad.
          CLEAR l_fin.
        ENDIF.
      ENDLOOP.
      REFRESH i_est.
      SORT i_estad.
    ENDIF.
  ENDIF.

  IF NOT v_fichero_excel IS INITIAL.
    IF p_onedr = 'X'.
      o_ms->get_contenido_fichero( EXPORTING nombre = v_fichero_excel popup_respuesta = '' IMPORTING message = DATA(l_msg) tabla_xlsx = i_list_excel[] ).
      IF NOT l_msg IS INITIAL. MESSAGE l_msg TYPE 'E'. ENDIF.
    ELSE.
      IF zcl_ap_ficheros=>existe(  v_fichero_excel ).
        zcl_ap_sgpi=>text( 'Leyendo excel con listado objetos' ).

        NEW zcl_ap_abap2xls( )->lee_fichero( EXPORTING fichero       = v_fichero_excel
                                                       get_datos     = 'X'
                                                       huge          = 'X'
                                                       mostrar_error = ''
                                             IMPORTING datos         = i_list_excel[] ).

        IF p_lib IS INITIAL.
          v_fichero_excel_dic = v_fichero_excel.
          REPLACE 'desarrollos.xlsx' IN v_fichero_excel_dic WITH 'desarrollos_dic.xlsx'.

          IF p_tablas = 'X'.
            v_fichero_excel_dic = v_fichero_excel.
            REPLACE 'desarrollos.xlsx' IN v_fichero_excel_dic WITH 'desarrollos_dic.xlsx'.
            NEW zcl_ap_abap2xls( )->lee_fichero( EXPORTING fichero       = v_fichero_excel_dic
                                                           get_datos     = 'X'
                                                           huge          = 'X'
                                                           mostrar_error = ''
                                                 IMPORTING datos         = i_list_excel_dic[] ).
            APPEND LINES OF i_list_excel_dic TO i_list_excel.
          ENDIF.

          v_fichero_excel_ext = v_fichero_excel.
          REPLACE 'desarrollos.xlsx' IN v_fichero_excel_ext WITH 'desarrollos_ext.xlsx'.
          IF p_ext = 'X'.
            NEW zcl_ap_abap2xls( )->lee_fichero( EXPORTING fichero       = v_fichero_excel_ext
                                                           get_datos     = 'X'
                                                           huge          = 'X'
                                                           mostrar_error = ''
                                                 IMPORTING datos         = i_list_excel_ext[] ).
            APPEND LINES OF i_list_excel_ext TO i_list_excel.
          ENDIF.

          v_fichero_excel_opn = v_fichero_excel.
          REPLACE 'desarrollos.xlsx' IN v_fichero_excel_opn WITH 'desarrollos_open.xlsx'.

          IF p_open = 'X'.
            NEW zcl_ap_abap2xls( )->lee_fichero( EXPORTING fichero       = v_fichero_excel_opn
                                                           get_datos     = 'X'
                                                           huge          = 'X'
                                                           mostrar_error = ''
                                                 IMPORTING datos         = i_list_excel_opn[] ).
            APPEND LINES OF i_list_excel_opn TO i_list_excel.
          ENDIF.

          v_fichero_excel_gen = v_fichero_excel.
          REPLACE 'desarrollos.xlsx' IN v_fichero_excel_gen WITH 'desarrollos_generated.xlsx'.

          IF p_gen = 'X'.
            NEW zcl_ap_abap2xls( )->lee_fichero( EXPORTING fichero       = v_fichero_excel_gen
                                                           get_datos     = 'X'
                                                           huge          = 'X'
                                                           mostrar_error = ''
                                                 IMPORTING datos         = i_list_excel_gen[] ).
            APPEND LINES OF i_list_excel_gen TO i_list_excel.
          ENDIF.

          v_fichero_excel_tmp = v_fichero_excel.
          REPLACE 'desarrollos.xlsx' IN v_fichero_excel_tmp WITH 'desarrollos_tmp.xlsx'.

          IF p_tmp = 'X'.
            NEW zcl_ap_abap2xls( )->lee_fichero( EXPORTING fichero       = v_fichero_excel_tmp
                                                           get_datos     = 'X'
                                                           huge          = 'X'
                                                           mostrar_error = ''
                                                 IMPORTING datos         = i_list_excel_tmp[] ).
            APPEND LINES OF i_list_excel_tmp TO i_list_excel.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

  RANGES: r_name FOR trdir-name,
          r_name_apc FOR trdir-name.

  addrango_eq r_name_apc '&&&&&'.
  IF    NOT s_grupo[] IS INITIAL
     OR NOT s_asign[] IS INITIAL
     OR NOT s_progr[] IS INITIAL
     OR NOT s_prior[] IS INITIAL
     OR NOT p_lib     IS INITIAL.
    SELECT * FROM zbc003
      INTO TABLE i_zbc003
     WHERE (    grupo  IN s_grupo
             OR grupo2 IN s_grupo
             OR grupo3 IN s_grupo )
       AND asignado_a    IN s_asign
       AND procesado_por IN s_progr
       AND name          IN s_report
       AND prioridad     IN s_prior.
    IF sy-subrc <> 0.
      addrango_eq r_name '&&&&&'.
    ELSE.
      IF p_lib = 'X'.
        DELETE i_zbc003 WHERE libreria = ''.
      ENDIF.
      LOOP AT i_zbc003.
        addrango_eq r_name i_zbc003-name.
      ENDLOOP.
    ENDIF.
  ELSEIF p_vivas = 'X'.
    SELECT * FROM zbc003
      INTO TABLE i_zbc003
     WHERE name IN s_report
       AND (    asignado_a     = sy-uname
             OR procesado_por  = sy-uname
             OR prioridad     <> 0 ).
    IF sy-subrc = 0.
      IF p_lib = 'X'.
        DELETE i_zbc003 WHERE libreria = ''.
      ENDIF.
      LOOP AT i_zbc003.
        addrango_eq r_name_apc i_zbc003-name.
      ENDLOOP.
    ENDIF.
  ENDIF.

  IF p_report = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando programas'(spr) ).
* Buscamos programas

    IF p_vivas IS INITIAL.
      SELECT * FROM  trdir
        INTO TABLE i_trdir
       WHERE ( name  IN r_obj
            OR name  LIKE 'SAPMZ%'
            OR name  LIKE 'MZ%'
            OR name  LIKE 'LZ%F01' )
          AND NOT name LIKE '%==%'
          AND name IN s_report
          AND name IN r_name
      AND ( subc = '1' OR subc = 'M' OR subc = 'I' OR subc = 'S' )
      AND subc IN s_subc
      AND ( cnam IN s_cnam
        AND unam IN s_unam
        AND cdat IN s_cdat
        AND udat IN s_udat )
      ORDER BY name.
    ELSE.
      SELECT * FROM  trdir
        INTO TABLE i_trdir
       WHERE
        name IN r_name_apc
         OR (
            ( name  IN r_obj
           OR name  LIKE 'SAPMZ%'
           OR name  LIKE 'MZ%'
           OR name  LIKE 'LZ%F01' )
         AND NOT name LIKE '%=====%'
         AND name IN s_report
         AND name IN r_name
      AND ( subc = '1' OR subc = 'M' OR subc = 'I' OR subc = 'S' )
      AND subc IN s_subc
      AND ( cnam = sy-uname OR unam = sy-uname )
      AND ( cdat >= v_fechas_vivas OR udat >= v_fechas_vivas ) )
        ORDER BY name.

      LOOP AT i_zbc003 WHERE prioridad = '88888'.
        DELETE i_trdir WHERE name = i_zbc003-name.
      ENDLOOP.
    ENDIF.

      IF NOT i_trdir[] IS INITIAL.
        SELECT * FROM tstc                              "#EC CI_GENBUFF
          INTO CORRESPONDING FIELDS OF TABLE i_tstc
          FOR ALL ENTRIES IN i_trdir
         WHERE pgmna = i_trdir-name.
      ENDIF.
    SORT i_tstc.
    sgpi->get_filas_tabla( i_trdir[] ).
    LOOP AT i_trdir.
      SELECT SINGLE devclass FROM  tadir
        INTO i_listado-devclass
       WHERE pgmid    = 'R3TR'
         AND object   = 'PROG'
         AND obj_name = i_trdir-name
         AND delflag  = ''.
      IF NOT ( sy-subrc = 0 OR i_trdir-rmand IS INITIAL ). " Reports raros a borrar
        CONTINUE.
      ENDIF.

      sgpi->porcentaje( texto = 'Procesando'(pro) cantidad = sy-tabix ).
      CLEAR i_listado.
      MOVE-CORRESPONDING i_trdir TO i_listado.
      i_listado-object = 'PROG'.
      READ TABLE i_tstc WITH KEY pgmna = i_trdir-name
           BINARY SEARCH.
      IF sy-subrc = 0.
        i_listado-tcode = i_tstc-tcode.
      ELSE.
        i_listado-tcode = 'SE38'.
      ENDIF.

      IF i_listado-tcode IN s_tcode.
        APPEND i_listado.
      ENDIF.
    ENDLOOP.

    zcl_ap_sgpi=>text( 'Seleccionando transacciones sin report Z'(stz) ).
    LOOP AT i_tstc WHERE     (    tcode(1) = 'Z'
                               OR tcode(1) = 'Y' )
                         AND tcode IN s_tcode.
      READ TABLE i_listado WITH KEY tcode = i_tstc-tcode.
      IF sy-subrc = 0.
        CONTINUE.
      ENDIF.

      CLEAR i_listado.
      i_listado-tcode = i_tstc-tcode.
      i_listado-name  = i_tstc-pgmna.
      IF i_listado-name IS INITIAL.
        SELECT SINGLE * FROM tstcp
         WHERE tcode = i_tstc-tcode.
        IF sy-subrc = 0.
          i_listado-subc = '1'.
          IF tstcp-param+2(12) = 'START_REPORT'.
            SPLIT tstcp-param AT 'D_SREPOVARI-REPORT='
                  INTO l_aux1 l_aux2.
            SPLIT l_aux2 AT ';' INTO i_listado-name l_aux1.
          ELSEIF tstcp-param+2(4) = 'ZBC4'.
            SPLIT tstcp-param AT 'P_TABLA='
                  INTO l_aux1 l_aux2.
            SPLIT l_aux2 AT ';' INTO i_listado-aux l_aux1.
          ELSEIF tstcp-param+2(6) = 'ZBCTAB'.
            SPLIT tstcp-param AT 'TABLA='
                  INTO l_aux1 l_aux2.
            SPLIT l_aux2 AT ';' INTO i_listado-aux l_aux1.
          ELSE.
            i_listado-name = tstcp-param+2.
          ENDIF.
        ENDIF.
      ENDIF.

      IF i_listado-name IN r_name.
        READ TABLE i_trdir WITH KEY name = i_listado-name
             BINARY SEARCH.
        IF sy-subrc = 0.
          MOVE-CORRESPONDING i_trdir TO i_listado.
        ELSE.
          SELECT SINGLE * FROM  trdir
           WHERE name  = i_listado-name
             AND name IN s_report.
          IF sy-subrc = 0.
            MOVE-CORRESPONDING trdir TO i_listado.
          ENDIF.
        ENDIF.

        IF i_listado-name(4) = 'AQQQ'.
          i_listado-subc = 'Q'.
        ENDIF.
        IF i_listado-subc IN s_subc.
          APPEND i_listado.
        ENDIF.
      ENDIF.
    ENDLOOP.

    zcl_ap_sgpi=>text( 'Seleccionando programas'(spr) ).
    LOOP AT i_listado.
      IF NOT i_listado-tcode IS INITIAL.
        IF i_listado-name IS INITIAL.
          SELECT SINGLE * FROM tstcp
           WHERE tcode = i_listado-tcode.
          SEARCH tstcp FOR 'EXTDREPORT=KE'.
          IF sy-subrc = 0.
            DELETE i_listado.
            CONTINUE.
          ENDIF.
        ENDIF.

        SELECT SINGLE ttext FROM tstct
      INTO i_listado-ttext
     WHERE sprsl = sy-langu
       AND tcode = i_listado-tcode.
      ENDIF.
      SELECT SINGLE text FROM trdirt
        INTO i_listado-text
       WHERE sprsl = sy-langu
         AND name  = i_listado-name.
      SELECT SINGLE devclass FROM  tadir
        INTO i_listado-devclass
       WHERE pgmid    = 'R3TR'
         AND object   = 'PROG'
         AND obj_name = i_listado-name.
      IF i_listado-devclass IN s_devcla AND i_listado-devclass IN r_devclass_openf.
        IF NOT i_listado-name IS INITIAL.
          READ TABLE i_estad WITH KEY report = i_listado-name
               BINARY SEARCH.
          IF sy-subrc = 0.
            i_listado-total  = i_estad-total.
            i_listado-fult   = i_estad-fecha.
            i_listado-uuname = i_estad-account.
          ENDIF.
        ENDIF.

        IF p_numlin = 'X'.
          IF NOT i_listado-name IS INITIAL.
            READ REPORT i_listado-name INTO i_source.
            i_listado-numlin = lines( i_source ).
          ENDIF.
        ENDIF.

        MODIFY i_listado.
      ELSE.
        DELETE i_listado.
      ENDIF.
    ENDLOOP.
  ENDIF.

  IF p_utili = 'X'.
    LOOP AT i_listado WHERE subc = '1'.
      SELECT include FROM cross
        INTO cross-include
       WHERE type = 'R'
         AND name = i_listado-name.
        IF i_listado-aux IS INITIAL.
          i_listado-aux = cross-include.
        ELSE.
          CONCATENATE i_listado-aux ',' cross-include
                      INTO i_listado-aux SEPARATED BY space.
        ENDIF.
        IF i_listado-total = 0.
          READ TABLE i_estad WITH KEY report = cross-include
               BINARY SEARCH.
          IF sy-subrc = 0.
            i_listado-total = i_estad-total.
          ENDIF.
        ENDIF.

      ENDSELECT.
      MODIFY i_listado.
    ENDLOOP.

    LOOP AT i_listado WHERE subc = 'I'.
      SELECT * FROM rseuinc
       WHERE include = i_listado-name.
        IF i_listado-aux IS INITIAL.
          i_listado-aux = rseuinc-master.
        ELSE.
          CONCATENATE i_listado-aux ',' rseuinc-master
                      INTO i_listado-aux SEPARATED BY space.
        ENDIF.
        IF i_listado-total = 0.
          READ TABLE i_estad WITH KEY report = rseuinc-master
               BINARY SEARCH.
          IF sy-subrc = 0.
            i_listado-total = i_estad-total.
          ENDIF.
        ENDIF.
        IF i_listado-tcode IS INITIAL.
          READ TABLE i_tstc WITH KEY pgmna = rseuinc-master
               BINARY SEARCH.
          IF sy-subrc = 0.
            i_listado-tcode = i_tstc-tcode.
            SELECT SINGLE ttext FROM tstct
          INTO i_listado-ttext
         WHERE sprsl = sy-langu
           AND tcode = i_listado-tcode.
          ENDIF.
        ENDIF.
      ENDSELECT.
      MODIFY i_listado.
    ENDLOOP.
  ENDIF.

  IF p_funcio = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando programas'(spr) ).
    SELECT * FROM v_fdirt
     WHERE area           IN r_obj
       AND funcname       IN s_report
       AND funcname NOT LIKE 'TABLE%'
       AND funcname NOT LIKE 'VIEW%'
       AND active          = 'X'
       AND spras           = sy-langu.
      IF v_fdirt-funcname IN r_name.
        SELECT SINGLE * FROM tadir
         WHERE pgmid     = 'R3TR'
           AND object    = 'FUGR'
           AND obj_name  = v_fdirt-area
           AND devclass IN s_devcla
           AND devclass IN r_devclass_openf.
        IF sy-subrc = 0.
          CLEAR i_listado.
          i_listado-object   = 'FUGR'.  " APC03112010
          i_listado-devclass = tadir-devclass.
          PERFORM get_funcion USING v_fdirt-funcname.
          IF p_utili = 'X'.
            SELECT include FROM cross
              INTO cross-include
             WHERE type = 'F'
               AND name = i_listado-name.
              IF i_listado-aux IS INITIAL.
                i_listado-aux = cross-include.
              ELSE.
                CONCATENATE i_listado-aux ',' cross-include
                            INTO i_listado-aux SEPARATED BY space.
              ENDIF.
              IF i_listado-total = 0.
                READ TABLE i_estad WITH KEY report = cross-include
                     BINARY SEARCH.
                IF sy-subrc = 0.
                  i_listado-total = i_estad-total.
                ENDIF.
              ENDIF.

            ENDSELECT.
          ENDIF.

          APPEND i_listado.
        ENDIF.
      ENDIF.
    ENDSELECT.
  ENDIF.

  IF p_clases = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando clases'(scl) ).

    IF i_zbc003[] IS INITIAL.
      SELECT  devclass object obj_name FROM  tadir      "#EC CI_GENBUFF
        INTO CORRESPONDING FIELDS OF TABLE i_tadir
       WHERE pgmid     = 'R3TR'
         AND object    = 'CLAS'
         AND obj_name IN r_obj
         AND obj_name IN s_report
         AND devclass IN s_devcla
         AND devclass IN r_devclass_openf
         AND delflag   = ''.
    ELSE.
      SELECT  devclass object obj_name FROM  tadir      "#EC CI_GENBUFF
        INTO CORRESPONDING FIELDS OF TABLE i_tadir
         FOR ALL ENTRIES IN i_zbc003
       WHERE pgmid     = 'R3TR'
         AND object    = 'CLAS'
         AND obj_name  = i_zbc003-name
         AND devclass IN s_devcla
         AND devclass IN r_devclass_openf
         AND delflag   = ''.
    ENDIF.
    LOOP AT i_tadir INTO tadir.
      SELECT SINGLE clsname FROM seoclass
        INTO tadir-obj_name
       WHERE clsname = tadir-obj_name.
      IF sy-subrc <> 0.
        CONTINUE.
      ENDIF.

      CLEAR i_listado.
      i_listado-name     = tadir-obj_name.
      i_listado-object   = tadir-object.
      i_listado-subc     = 'C'.
      i_listado-tcode    = 'SE24'.
      i_listado-text     = stxh-tdtitle.
      i_listado-devclass = tadir-devclass.

      SELECT  descript author createdon
                    changedby changedon
        FROM vseoclass
        UP TO 1 ROWS
        INTO (i_listado-text, i_listado-cnam, i_listado-cdat,
              i_listado-unam, i_listado-udat)
       WHERE clsname = tadir-obj_name
         AND langu   = sy-langu
       ORDER BY PRIMARY KEY.
      ENDSELECT.

      CONCATENATE tadir-obj_name '%' INTO l_aux.
      SELECT MAX( udat ) FROM progdir
        INTO i_listado-udat
       WHERE name LIKE l_aux.

      SELECT unam FROM progdir
        INTO i_listado-unam
        UP TO 1 ROWS
       WHERE name  LIKE l_aux
         AND state    = 'A'
         AND udat     = i_listado-udat
       ORDER BY PRIMARY KEY.
      ENDSELECT.

      APPEND i_listado.
    ENDLOOP.
  ENDIF.

  IF p_enhan = 'X'.                                                              " NOLIB
    o_enh = NEW #( ).
    zcl_ap_sgpi=>text( 'Seleccionando enhancement'(sen) ).                            " NOLIB
    SELECT  devclass object obj_name FROM  tadir        "#EC CI_GENBUFF
      INTO CORRESPONDING FIELDS OF tadir
     WHERE object   IN ( 'ENHO', 'ENHS' )
       AND obj_name IN r_obj                                                   " NOLIB
       AND obj_name IN s_report.                                                 " NOLIB
      " NOLIB
      CLEAR i_listado.                                                           " NOLIB
      i_listado-name   = tadir-obj_name.  " NOLIB
      i_listado-object = tadir-object.
      i_listado-subc   = 'A'.  " NOLIB

      CLEAR enhincinx.
      SELECT enhinclude FROM enhincinx
        INTO enhincinx-enhinclude
        UP TO 1 ROWS
       WHERE enhname = i_listado-name
        ORDER BY PRIMARY KEY.
      ENDSELECT.
      IF NOT enhincinx-enhinclude IS INITIAL.
        SELECT SINGLE cnam cdat unam udat vern FROM trdir
          INTO CORRESPONDING FIELDS OF i_listado
         WHERE name = enhincinx-enhinclude.
      ENDIF.

      SELECT obj_name FROM enhobj                                " NOLIB
        INTO (i_listado-tcode )                                " NOLIB
        UP TO 1 ROWS
       WHERE enhname = tadir-obj_name                                           " NOLIB
       ORDER BY PRIMARY KEY.
      ENDSELECT.
      i_listado-devclass = tadir-devclass.                                       " NOLIB
      APPEND i_listado.                                                          " NOLIB
    ENDSELECT.                                                                   " NOLIB
    LOOP AT i_listado WHERE subc = 'A'.
      i_listado-subc = '+'.

      SELECT * FROM enhincinx
        INTO TABLE i_enhincinx
       WHERE enhname = i_listado-name.

      LOOP AT i_enhincinx.                               "#EC CI_NESTED
        i_listado-text = i_enhincinx-full_name.

        o_enh->get_line_position( EXPORTING iv_full_name = i_enhincinx-full_name
                                            iv_prog      = i_enhincinx-programname
                                            iv_enhname   = i_enhincinx-enhname
                                  IMPORTING ev_include   = ev_include
                                            ev_line      = ev_line ).
        i_listado-tcode  = ev_include.
        i_listado-object = 'PROG'.

        APPEND i_listado.
      ENDLOOP.
    ENDLOOP.
  ENDIF.                                                                         " NOLIB

  IF p_formul = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando programas'(spr) ).
    SELECT tdfdate tdform tdfuser tdldate tdluser tdtitle FROM stxh
      INTO CORRESPONDING FIELDS OF stxh
   WHERE tdobject  = 'FORM'
     AND tdform   IN s_report
*     AND tdform IN r_name
     AND tdform   IN r_obj
     AND tdid      = 'DEF'
     AND tdspras   = 'S'.
      IF stxh-tdform IN r_name.
        CLEAR i_listado.
        i_listado-name   = stxh-tdform.
        i_listado-subc   = 'S'.
        i_listado-tcode  = 'SE71'.
        i_listado-text   = stxh-tdtitle.
        i_listado-cdat   = stxh-tdfdate.
        i_listado-cnam   = stxh-tdfuser.
        i_listado-udat   = stxh-tdldate.
        i_listado-unam   = stxh-tdluser.
        i_listado-object = 'FORM'.  " APC03112010

        SELECT SINGLE devclass FROM  tadir
          INTO i_listado-devclass
         WHERE pgmid    = 'R3TR'
           AND object   = 'FORM'
           AND obj_name = i_listado-name.

        IF p_utili = 'X'.
          SELECT * FROM ttxfp                           "#EC CI_GENBUFF
           WHERE tdform = i_listado-name.
            IF i_listado-ttext IS INITIAL.
              i_listado-ttext = ttxfp-print_name.
            ELSE.
              CONCATENATE i_listado-ttext ',' ttxfp-print_name
                          INTO i_listado-ttext.
            ENDIF.
          ENDSELECT.
        ENDIF.
        APPEND i_listado.
      ENDIF.
    ENDSELECT.

    SELECT * FROM  stxfadm
           WHERE formname   IN s_report
             AND formname   IN r_obj
             AND masterlang  = sy-langu
             AND devclass   IN s_devcla
             AND devclass   IN r_devclass_openf.
      IF stxfadm-formname IN r_name.
        CLEAR i_listado.
        i_listado-name   = stxfadm-formname.
        i_listado-subc   = 'S'.
        i_listado-object = 'SSFO'.  " APC03112010
        i_listado-tcode  = 'SMARTFORMS'.
        i_listado-cdat   = stxfadm-firstdate.
        i_listado-cnam   = stxfadm-firstuser.
        i_listado-udat   = stxfadm-lastdate.
        i_listado-unam   = stxfadm-lastuser.

        SELECT SINGLE pgnam kschl FROM tnapr
          INTO (i_listado-tcode, i_listado-ttext)
         WHERE nacha = '1'
           AND sform = stxfadm-formname.

        SELECT SINGLE caption FROM  stxfadmt
          INTO i_listado-text
               WHERE langu    = sy-langu
                 AND formname = stxfadm-formname.
        APPEND i_listado.
      ENDIF.
    ENDSELECT.

  ENDIF.

  IF p_proyec = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando proyectos de ampliaciÃ³n'(spa) ).
    REFRESH i_list.
    SELECT * FROM modtext
     WHERE sprsl  = sy-langu
       AND name  IN s_report.
      IF modtext-name IN r_name.
        CLEAR i_list.
        i_list-name = modtext-name.
        i_list-subc = 'A'.
        i_list-text = modtext-modtext.
        APPEND i_list.
      ENDIF.
    ENDSELECT.

    LOOP AT i_list.
      CLEAR l_ok.
      SELECT * FROM modact
       WHERE name = i_list-name.
        i_listado-devclass = modact-devclass.
        SELECT * FROM modsap
         WHERE name = modact-member
           AND typ  = 'E'.
          i_listado       = i_list.
          i_listado-tcode = modsap-member.
          SELECT SINGLE modtext FROM  modsapt
            INTO i_listado-aux
                 WHERE sprsl = sy-langu
                   AND name  = modsap-name.
          SELECT SINGLE * FROM tfdir
           WHERE funcname = modsap-member.
          CONCATENATE tfdir-pname+3 'U' tfdir-include INTO
          i_listado-ttext.

          i_listado-ttext(1) = 'Z'.
          SELECT SINGLE name FROM trdir
            INTO trdir-name
           WHERE name = i_listado-ttext.
          IF sy-subrc = 0.

            IF i_listado-ttext(2) = 'ZX'.
              SELECT SINGLE cnam unam cdat udat FROM  trdir
                INTO (i_listado-cnam, i_listado-unam,
                      i_listado-cdat, i_listado-udat)
               WHERE name = i_listado-ttext.
              i_listado-object = 'PROG'.
            ENDIF.

            IF i_listado-devclass IS INITIAL.
              SELECT SINGLE devclass FROM  tadir
                INTO i_listado-devclass
               WHERE pgmid    = 'R3TR'
                 AND object   = 'PROG'
                 AND obj_name = i_listado-ttext.
            ENDIF.

            APPEND i_listado.
            l_ok = 'X'.
          ENDIF.
        ENDSELECT.
      ENDSELECT.
      IF l_ok IS INITIAL.
        APPEND i_list TO i_listado.
      ENDIF.
    ENDLOOP.

  ENDIF.

  IF p_badis = 'X'.
    SELECT devclass object obj_name FROM tadir          "#EC CI_GENBUFF
      INTO CORRESPONDING FIELDS OF tadir
     WHERE pgmid     = 'R3TR'
       AND object    = 'SXCI'
       AND obj_name IN s_report
       AND obj_name IN r_name
       AND obj_name IN r_obj
       AND devclass IN s_devcla
       AND devclass IN r_devclass_openf
       AND delflag   = ''.
      CLEAR i_listado.
      i_listado-name  = tadir-obj_name.
      i_listado-subc  = 'B'.
      i_listado-tcode = 'SE19'.

      SELECT SINGLE text FROM  sxc_attrt
        INTO i_listado-text
       WHERE imp_name = tadir-obj_name
         AND sprsl    = sy-langu.

      SELECT imp_class FROM sxc_class                   "#EC CI_GENBUFF
        INTO i_listado-ttext
        UP TO 1 ROWS
       WHERE imp_name = tadir-obj_name
       ORDER BY PRIMARY KEY.
      ENDSELECT.

      SELECT SINGLE descript author createdon
                    changedby changedon
        FROM vseoclass
        INTO (i_listado-aux, i_listado-cnam, i_listado-cdat,
              i_listado-unam, i_listado-udat)
       WHERE clsname = i_listado-ttext.

      IF i_listado-ttext(1) = 'Z'.
        CONCATENATE i_listado-ttext '%' INTO l_aux.
        SELECT MAX( udat ) FROM progdir
          INTO i_listado-udat
         WHERE name LIKE l_aux.

        SELECT  unam FROM progdir
          INTO i_listado-unam
          UP TO 1 ROWS
         WHERE name  LIKE l_aux
           AND state    = 'A'
           AND udat     = i_listado-udat
         ORDER BY PRIMARY KEY.
        ENDSELECT.
      ENDIF.

      i_listado-object = 'CLAS'.

      APPEND i_listado.
    ENDSELECT.
  ENDIF.

  IF p_userex = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando Userexits'(sue) ).
    SELECT * FROM  trdir
      INTO TABLE i_trdir
     WHERE ( ( name  LIKE 'MV%Z%' )
         OR  ( name  LIKE 'RV%Z%' )
         OR  ( name  LIKE 'LV%Z%' )
         OR  ( name  LIKE 'RPC%Z%' )
         OR  ( name  LIKE 'VV05HF%' )
         OR  ( name  LIKE 'LV0%CFZZ' ) )
        AND name IN s_report
        AND name IN r_name
        AND subc = 'I'
        AND unam <> 'SAP'
        AND unam <> 'SAP*'
        AND unam <> 'DDIC'.
    LOOP AT i_trdir WHERE name IN r_name.
      CLEAR i_listado.
      MOVE-CORRESPONDING i_trdir TO i_listado.
      i_listado-object = 'PROG'.
      SELECT SINGLE text FROM trdirt
        INTO i_listado-text
       WHERE sprsl = sy-langu
         AND name  = i_listado-name.
      SELECT SINGLE devclass FROM  tadir
        INTO i_listado-devclass
       WHERE pgmid    = 'R3TR'
         AND object   = 'PROG'
         AND obj_name = i_listado-name.
      APPEND i_listado.
    ENDLOOP.
  ENDIF.

  IF p_rutina = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando Rutinas'(sru) ).
    SELECT * FROM  trdir
      INTO TABLE i_trdir
     WHERE name      LIKE 'RV%'
       AND name  NOT LIKE 'RV%NN'
       AND name  NOT LIKE 'RV%CC'
       AND name  NOT LIKE 'RV%Z%'
       AND name        IN s_report
       AND subc         = 'I'
       AND unam        <> 'SAP'.
    LOOP AT i_trdir WHERE name IN r_name.
      CLEAR i_listado.
      MOVE-CORRESPONDING i_trdir TO i_listado.
      i_listado-object = 'PROG'.  " APC03112010
      i_listado-tcode  = 'VOFM'.  " APC03112010
      SELECT SINGLE text FROM trdirt
        INTO i_listado-text
       WHERE sprsl = sy-langu
         AND name  = i_listado-name.
      SELECT SINGLE devclass FROM  tadir
        INTO i_listado-devclass
       WHERE pgmid    = 'R3TR'
         AND object   = 'PROG'
         AND obj_name = i_listado-name.
      APPEND i_listado.
    ENDLOOP.
  ENDIF.

  IF p_tablas = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando tablas'(sta) ).

    IF p_vivas IS INITIAL.
      SELECT  as4date as4user tabclass tabname FROM  dd02l
        INTO CORRESPONDING FIELDS OF TABLE i_dd02l
       WHERE tabname IN r_obj
         AND tabname IN s_report
         AND as4user IN s_cnam
         AND as4user IN s_unam
         AND as4date IN s_cdat
         AND as4date IN s_udat.
    ELSE.
      SELECT as4date as4user tabclass tabname FROM  dd02l
        INTO CORRESPONDING FIELDS OF TABLE i_dd02l
        WHERE tabname IN r_name_apc
           OR (       tabname IN r_obj
                AND   tabname IN s_report
                AND ( as4user  = sy-uname )
                AND ( as4date >= v_fechas_vivas ) ).
    ENDIF.
    LOOP AT i_dd02l INTO dd02l.
      IF dd02l-tabname NOT IN r_name.
        CONTINUE.
      ENDIF.

      CLEAR i_listado.
      i_listado-name = dd02l-tabname.
      SELECT ddtext FROM  dd02t
        UP TO 1 ROWS
        INTO i_listado-text
             WHERE tabname    = i_listado-name
               AND ddlanguage = sy-langu
       ORDER BY PRIMARY KEY.
      ENDSELECT.

      SELECT SINGLE devclass object FROM tadir          "#EC CI_GENBUFF
        INTO (i_listado-devclass, i_listado-object)
       WHERE pgmid     = 'R3TR'
         AND object   IN ( 'TABL', 'VIEW' )
         AND obj_name  = dd02l-tabname
         AND delflag   = ''.
      IF NOT ( i_listado-devclass IN s_devcla AND i_listado-devclass IN r_devclass_openf ).
        CONTINUE.
      ENDIF.

      CASE dd02l-tabclass.
        WHEN 'INTTAB'.
          i_listado-subc = 'E'.
        WHEN 'VIEW'.
          i_listado-subc = 'V'.
        WHEN 'APPEND'.
          i_listado-subc = 'A'.
        WHEN OTHERS.
          i_listado-subc = 'T'.
          IF p_numlin = 'X'.
            SELECT COUNT( * ) FROM (i_listado-name)
              INTO i_listado-numlin.
          ENDIF.
      ENDCASE.

      i_listado-cdat  = dd02l-as4date.
      i_listado-cnam  = dd02l-as4user.

      i_listado-tcode = 'SE11'.

      IF p_utili = 'X'.
        l_tabname = i_listado-name.
        CALL FUNCTION 'RS_TABLE_IN_PROGRAMS'
          EXPORTING
            tabname  = l_tabname
          TABLES
            proglist = i_progs.
        LOOP AT i_progs.                                 "#EC CI_NESTED
          IF i_listado-aux IS INITIAL.
            i_listado-aux = i_progs-master.
          ELSE.
            CONCATENATE i_listado-aux ',' i_progs-master
                        INTO i_listado-aux SEPARATED BY space.
          ENDIF.

          IF i_listado-total = 0.
            READ TABLE i_estad WITH KEY report = i_progs-master
                 BINARY SEARCH.
            IF sy-subrc = 0.
              i_listado-total = i_estad-total.
            ENDIF.
          ENDIF.

        ENDLOOP.
      ENDIF.

      APPEND i_listado.
    ENDLOOP.

    IF p_vivas IS INITIAL AND p_libt IS INITIAL.
      zcl_ap_sgpi=>text( 'Seleccionando tipos'(sti) ).
      SELECT * FROM  ddtypes
       WHERE typename IN r_obj
         AND typename IN s_report.
        IF ddtypes-typename IN r_name.

          SELECT SINGLE as4date as4user FROM  dd40l
            INTO CORRESPONDING FIELDS OF dd04l
           WHERE typename  = ddtypes-typename
             AND as4user  IN s_cnam
             AND as4user  IN s_unam
             AND as4date  IN s_cdat
             AND as4date  IN s_udat.
          IF sy-subrc = 0.
            CLEAR i_listado.
            i_listado-name = ddtypes-typename.
            SELECT SINGLE devclass object FROM tadir    "#EC CI_GENBUFF
               INTO (i_listado-devclass, i_listado-object)
              WHERE pgmid       = 'R3TR'
                AND object   LIKE 'T%'
                AND obj_name    = ddtypes-typename.
            IF i_listado-devclass IN s_devcla AND i_listado-devclass IN r_devclass_openf.

              i_listado-cdat  = dd40l-as4date.
              i_listado-cnam  = dd40l-as4user.
              i_listado-tcode = 'SE11'.
              i_listado-subc  = 'D'.

              SELECT ddtext FROM  dd40t
                INTO i_listado-text
                UP TO 1 ROWS
              WHERE typename   = i_listado-name
                AND ddlanguage = sy-langu
               ORDER BY PRIMARY KEY.
              ENDSELECT.

              APPEND i_listado.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDSELECT.

      zcl_ap_sgpi=>text( 'Seleccionando elementos de datos'(sed) ).

      SELECT  as4date as4user rollname FROM  dd04l
        INTO CORRESPONDING FIELDS OF dd04l
       WHERE rollname IN s_report
         AND rollname IN r_name
         AND rollname IN r_obj
         AND as4user  IN s_cnam
         AND as4user  IN s_unam
         AND as4date  IN s_cdat
         AND as4date  IN s_udat.
        IF sy-subrc = 0.
          CLEAR i_listado.
          i_listado-name = dd04l-rollname.
          SELECT SINGLE devclass object FROM tadir
             INTO (i_listado-devclass, i_listado-object)
            WHERE pgmid    = 'R3TR'
              AND object   = 'DTEL'
              AND obj_name = i_listado-name.
          IF i_listado-devclass IN s_devcla AND i_listado-devclass IN r_devclass_openf.

            i_listado-cdat  = dd04l-as4date.
            i_listado-cnam  = dd04l-as4user.
            i_listado-tcode = 'SE11'.
            i_listado-subc  = 'D'.

            SELECT ddtext FROM  dd04t
              INTO i_listado-text
              UP TO 1 ROWS
            WHERE rollname   = i_listado-name
              AND ddlanguage = sy-langu
              ORDER BY PRIMARY KEY.
            ENDSELECT.

            APPEND i_listado.
          ENDIF.
        ENDIF.
      ENDSELECT.

      zcl_ap_sgpi=>text( 'Seleccionando dominios'(sdo) ).
      SELECT  as4date as4user domname FROM  dd01l
        INTO CORRESPONDING FIELDS OF dd01l
       WHERE domname IN s_report
         AND domname IN r_obj
         AND domname IN r_name
         AND as4user IN s_cnam
         AND as4user IN s_unam
         AND as4date IN s_cdat
         AND as4date IN s_udat.
        IF sy-subrc = 0.
          CLEAR i_listado.
          i_listado-name = dd01l-domname.
          SELECT SINGLE devclass object FROM tadir
             INTO (i_listado-devclass, i_listado-object)
            WHERE pgmid    = 'R3TR'
              AND object   = 'DOMA'
              AND obj_name = i_listado-name.
          IF i_listado-devclass IN s_devcla AND i_listado-devclass IN r_devclass_openf.

            i_listado-cdat  = dd01l-as4date.
            i_listado-cnam  = dd01l-as4user.
            i_listado-tcode = 'SE11'.
            i_listado-subc  = 'D'.

            SELECT ddtext FROM  dd01t
              INTO i_listado-text
              UP TO 1 ROWS
            WHERE domname    = i_listado-name
              AND ddlanguage = sy-langu
             ORDER BY PRIMARY KEY.
            ENDSELECT.

            APPEND i_listado.
          ENDIF.
        ENDIF.
      ENDSELECT.
    ENDIF.
  ENDIF.

  IF p_cds = 'X'.
    CLEAR i_listado.
    SELECT  as4date as4user ddlname FROM  ddddlsrc
      INTO (i_listado-cdat, i_listado-cnam, i_listado-name )
     WHERE ddlname IN r_obj
       AND ddlname IN s_report
       AND as4user IN s_cnam
       AND as4user IN s_unam
       AND as4date IN s_cdat
       AND as4date IN s_udat.

      SELECT SINGLE ddtext FROM ddddlsrct
        INTO i_listado-text
       WHERE ddlname = i_listado-name.

      SELECT SINGLE devclass object FROM tadir          "#EC CI_GENBUFF
        INTO (i_listado-devclass, i_listado-object)
       WHERE pgmid     = 'R3TR'
         AND object   IN ('DDLS')
         AND obj_name  = i_listado-name
         AND delflag   = ''.
      i_listado-tcode = 'SE11'.
      i_listado-subc  = 'C'.
      APPEND i_listado.
    ENDSELECT.
  ENDIF.

  IF p_modife = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando modificaciones al estandar'(sms) ).
    SELECT * FROM zbc003
      WHERE name   IN s_report
        AND tcode  IN s_tcode
        AND name   IN r_name
        AND estado  = 'M'.
      CLEAR i_listado.
      MOVE-CORRESPONDING zbc003 TO i_listado.

      IF NOT i_listado-tcode IS INITIAL.
        SELECT SINGLE ttext FROM tstct
      INTO i_listado-ttext
     WHERE sprsl = sy-langu
       AND tcode = i_listado-tcode.
      ENDIF.
      SELECT SINGLE text FROM trdirt
        INTO i_listado-text
       WHERE sprsl = sy-langu
         AND name  = i_listado-name.
      SELECT SINGLE devclass object FROM  tadir
        INTO (i_listado-devclass, i_listado-object)
       WHERE pgmid    = 'R3TR'
         AND object   = 'PROG'
         AND obj_name = i_listado-name.
      IF sy-subrc <> 0.
        SELECT SINGLE devclass object FROM  tadir       "#EC CI_GENBUFF
        INTO (i_listado-devclass, i_listado-object)
         WHERE pgmid    = 'R3TR'
           AND obj_name = i_listado-name.
      ENDIF.
      IF i_listado-object IS INITIAL.                          " APC03112010
        SELECT SINGLE name FROM trdir                             " APC03112010
          INTO trdir-name
         WHERE name = i_listado-name.                          " APC03112010
        IF sy-subrc = 0.                                       " APC03112010
          i_listado-object = 'PROG'.                           " APC03112010
        ENDIF.                                                 " APC03112010
      ENDIF.                                                   " APC03112010

      SELECT SINGLE cnam unam cdat udat FROM  trdir
        INTO (i_listado-cnam, i_listado-unam,
              i_listado-cdat, i_listado-udat)
       WHERE name = i_listado-name.

      PERFORM icono_status USING i_listado-estado
              CHANGING i_listado-icono.

      IF i_listado-estado = 'B'.
        zcl_ap_alv_grid=>append_color( EXPORTING colorc      = 'ROJO'
                                       CHANGING  tabla_color = i_listado-color ).
      ELSEIF i_listado-estado = 'O'.
        zcl_ap_alv_grid=>append_color( EXPORTING colorc      = 'NARANJA'
                                       CHANGING  tabla_color = i_listado-color ).
      ELSEIF i_listado-estado = 'M'.
        zcl_ap_alv_grid=>append_color( EXPORTING colorc      = 'AMARILLO'
                                       CHANGING  tabla_color = i_listado-color ).
      ENDIF.

      i_listado-tipo = 'X'.

      APPEND i_listado.
    ENDSELECT.
  ENDIF.

  IF p_bte = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando BTEs'(sbt) ).

    SELECT * FROM tbe31
      APPENDING CORRESPONDING FIELDS OF TABLE i_tbe
      WHERE funct IN s_report
        AND funct IN r_obj.
    SELECT * FROM tbe32
      APPENDING CORRESPONDING FIELDS OF TABLE i_tbe
      WHERE funct IN s_report
        AND funct IN r_obj.

    SELECT * FROM tbe34
      APPENDING CORRESPONDING FIELDS OF TABLE i_tbe
      WHERE funct IN s_report
        AND funct IN r_obj.

    SELECT * FROM tps31
      APPENDING CORRESPONDING FIELDS OF TABLE i_tbe
      WHERE funct IN s_report
        AND funct IN r_obj.
    SELECT * FROM tps32
      APPENDING CORRESPONDING FIELDS OF TABLE i_tbe
      WHERE funct IN s_report
        AND funct IN r_obj.

    SELECT * FROM tps34
      APPENDING CORRESPONDING FIELDS OF TABLE i_tbe
      WHERE funct IN s_report
        AND funct IN r_obj.

    LOOP AT i_tbe WHERE funct IN r_name.
      CLEAR i_listado.
      SELECT * FROM v_fdirt
        UP TO 1 ROWS
       WHERE area     IN r_obj
         AND funcname  = i_tbe-funct
         AND active    = 'X'
         AND spras     = sy-langu
       ORDER BY PRIMARY KEY.
      ENDSELECT.
      IF sy-subrc = 0.
        PERFORM get_funcion USING v_fdirt-funcname.
        i_listado-tcode = 'FIBF'.
        i_listado-subc  = '9'.
        APPEND i_listado.
      ENDIF.
    ENDLOOP.
  ENDIF.

  IF p_bsp = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando BSPs'(sbs) ).

    SELECT * FROM o2appl                                "#EC CI_GENBUFF
      INTO TABLE i_bsp
      WHERE applname  IN s_report
        AND applname  IN r_obj
        AND applname  IN r_name
        AND author    IN s_cnam
        AND changedby IN s_unam
        AND createdon IN s_cdat
        AND changedon IN s_udat.

    LOOP AT i_bsp.
      i_listado-tcode  = 'BSP'.
      i_listado-subc   = 'B'.
      i_listado-object = 'WAPA'.
      i_listado-name   = i_bsp-applname.
      i_listado-cdat   = i_bsp-createdon.
      i_listado-cnam   = i_bsp-author.
      i_listado-udat   = i_bsp-changedon.
      i_listado-unam   = i_bsp-changedby.
      i_listado-ttext  = i_bsp-applclas.

      APPEND i_listado.
    ENDLOOP.
  ENDIF.

  IF p_webd = 'X'.
    zcl_ap_sgpi=>text( 'Seleccionando Webdynpros'(swd) ).

    SELECT * FROM wdy_application                       "#EC CI_GENBUFF
      INTO TABLE i_webd
      WHERE application_name IN s_report
        AND application_name IN r_obj
        AND author           IN s_cnam
        AND changedby        IN s_unam
        AND createdon        IN s_cdat
        AND changedon        IN s_udat.

    LOOP AT i_webd.
      CLEAR i_listado.
      i_listado-tcode  = 'WEBDYNPRO'.
      i_listado-subc   = 'W'.
      i_listado-object = 'WDYA'.
      i_listado-name   = i_webd-application_name.
      i_listado-cdat   = i_webd-createdon.
      i_listado-cnam   = i_webd-author.
      i_listado-udat   = i_webd-changedon.
      i_listado-unam   = i_webd-changedby.

      APPEND i_listado.
    ENDLOOP.

    SELECT  devclass object obj_name FROM tadir         "#EC CI_GENBUFF
      INTO CORRESPONDING FIELDS OF tadir
     WHERE pgmid       = 'R3TR'
       AND object   LIKE 'WD%'
       AND obj_name   IN s_report
       AND obj_name   IN r_obj
       AND devclass   IN s_devcla
       AND delflag     = ''.
      IF NOT line_exists( i_listado[ subc   = 'W'
                                     object = tadir-object
                                     name   = tadir-obj_name ] ).
        CLEAR i_listado.
        MOVE-CORRESPONDING tadir TO i_listado.
        i_listado-tcode    = 'WEBDYNPRO'.
        i_listado-subc     = 'W'.
        i_listado-name     = tadir-obj_name.
        i_listado-devclass = tadir-devclass.
        APPEND i_listado.
      ENDIF.
    ENDSELECT.

  ENDIF.

  IF p_mime = 'X'.
    SELECT * FROM smimloio                              "#EC CI_GENBUFF
     WHERE crea_user <> 'SAP'
       AND crea_time  > '20100101000000'
       AND prop09    IN s_report.

      CLEAR i_listado.
      i_listado-tcode  = 'MIME'.
      i_listado-subc   = 'M'.
      i_listado-object = 'SMIM'.
      i_listado-ttext  = smimloio-lo_class.
      i_listado-name   = smimloio-prop09.
      i_listado-text   = smimloio-loio_id.
      i_listado-cnam   = smimloio-crea_user.
      i_listado-cdat   = smimloio-crea_time(8).
      IF smimloio-chng_time IS INITIAL.
        i_listado-unam = i_listado-cnam.
        i_listado-udat = i_listado-cdat.
      ELSE.
        i_listado-unam = smimloio-chng_user.
        i_listado-udat = smimloio-chng_time.
      ENDIF.

      IF     i_listado-cnam IN s_cnam
         AND i_listado-unam IN s_unam
         AND i_listado-cdat IN s_cdat
         AND i_listado-udat IN s_udat.
        IF smimloio-prop02 = 'M_FOLDER' AND NOT smimloio-prop08 IS INITIAL.
          SELECT SINGLE prop09 FROM smimloio
            INTO i_listado-tcode
           WHERE loio_id  = smimloio-prop08
             AND lo_class = smimloio-prop02.
        ENDIF.
        APPEND i_listado.
      ENDIF.
    ENDSELECT.
  ENDIF.

  IF p_pdf = 'X'.
    SELECT devclass obj_name FROM tadir                 "#EC CI_GENBUFF
      INTO CORRESPONDING FIELDS OF tadir
     WHERE pgmid     = 'R3TR'
       AND object    = 'SFPF'
       AND obj_name IN s_report
       AND obj_name IN r_name
       AND obj_name IN r_obj
       AND devclass IN s_devcla
       AND delflag   = ''.
      CLEAR i_listado.
      i_listado-name     = tadir-obj_name.
      i_listado-subc     = 'P'.
      i_listado-tcode    = 'SFP'.
      i_listado-object   = 'SFPF'.
      i_listado-devclass = tadir-devclass.

      SELECT * FROM fpcontext
        INTO fpcontext
        UP TO 1 ROWS
       WHERE name = tadir-obj_name
       ORDER BY PRIMARY KEY.
      ENDSELECT.

      i_listado-cdat = fpcontext-firstdate.
      i_listado-cnam = fpcontext-firstuser.
      i_listado-udat = fpcontext-lastdate.
      i_listado-unam = fpcontext-lastuser.

      SELECT SINGLE text FROM  fpcontextt
        INTO i_listado-text
             WHERE name     = fpcontext-name
               AND state    = fpcontext-state
               AND language = sy-langu.

      APPEND i_listado.
    ENDSELECT.

    SELECT devclass obj_name FROM tadir                 "#EC CI_GENBUFF
      INTO CORRESPONDING FIELDS OF tadir
         WHERE pgmid     = 'R3TR'
           AND object    = 'SFPI'
           AND obj_name IN s_report
           AND obj_name IN r_name
           AND obj_name IN r_obj
           AND devclass IN s_devcla
           AND delflag   = ''.
      CLEAR i_listado.
      i_listado-name     = tadir-obj_name.
      i_listado-subc     = 'P'.
      i_listado-tcode    = 'SFP'.
      i_listado-object   = 'SFPI'.
      i_listado-devclass = tadir-devclass.

      SELECT firstdate firstuser lastdate lastuser FROM fpinterface
        UP TO 1 ROWS
        INTO CORRESPONDING FIELDS OF fpinterface
       WHERE name = tadir-obj_name
        ORDER BY PRIMARY KEY.
      ENDSELECT.

      i_listado-cdat = fpinterface-firstdate.
      i_listado-cnam = fpinterface-firstuser.
      i_listado-udat = fpinterface-lastdate.
      i_listado-unam = fpinterface-lastuser.

      SELECT SINGLE text FROM  fpinterfacet
        INTO i_listado-text
             WHERE name     = fpinterface-name
               AND state    = fpinterface-state
               AND language = sy-langu.

      APPEND i_listado.
    ENDSELECT.
  ENDIF.

  IF p_xslt = 'X'.
    SELECT devclass obj_name FROM tadir                 "#EC CI_GENBUFF
      INTO CORRESPONDING FIELDS OF tadir
             WHERE pgmid     = 'R3TR'
               AND object    = 'XSLT'
               AND obj_name IN s_report
               AND obj_name IN r_name
               AND obj_name IN r_obj
               AND devclass IN s_devcla
               AND delflag   = ''.
      SELECT author createdon changedby changedon FROM o2xsltdesc
        INTO CORRESPONDING FIELDS OF o2xsltdesc
        UP TO 1 ROWS
       WHERE relid = 'TR' AND xsltdesc = tadir-obj_name
       ORDER BY PRIMARY KEY.
      ENDSELECT.
      IF sy-subrc = 0.

        CLEAR i_listado.
        i_listado-name   = tadir-obj_name.
        i_listado-subc   = 'X'.
        i_listado-tcode  = 'XSLT_TOOL'.
        i_listado-object = 'XSLT'.
        i_listado-cnam   = o2xsltdesc-author.
        i_listado-cdat   = o2xsltdesc-createdon.
        i_listado-unam   = o2xsltdesc-changedby.
        i_listado-udat   = o2xsltdesc-changedon.

        APPEND i_listado.
      ENDIF.
    ENDSELECT.
  ENDIF.

  IF p_wf = 'X'.
    SELECT mc_short stext uname aedtm FROM hrs1000      "#EC CI_GENBUFF
      INTO CORRESPONDING FIELDS OF hrs1000
     WHERE otype    IN ( 'AC', 'TS', 'WS' )
       AND uname    <> 'SAP'
       AND mc_short IN s_report
       AND mc_short IN r_name
       AND mc_short IN r_obj.
      CLEAR i_listado.
      i_listado-name = hrs1000-mc_short.
      i_listado-subc = 'W'.
      CONCATENATE hrs1000-otype hrs1000-objid INTO i_listado-tcode.
      i_listado-object = hrs1000-otype.
      i_listado-text   = hrs1000-stext.
      IF hrs1000-otype = 'WS'.
        SELECT SINGLE created_by created_on changed_by changed_on FROM swdsheader "#EC CI_GENBUFF
          INTO (i_listado-cnam, i_listado-cdat, i_listado-unam, i_listado-udat)
        WHERE wfd_id = i_listado-tcode.
      ELSE.
        i_listado-unam = hrs1000-uname.
        i_listado-cnam = hrs1000-uname.
        i_listado-udat = hrs1000-aedtm.
        i_listado-cdat = hrs1000-aedtm.
      ENDIF.
      APPEND i_listado.
    ENDSELECT.
  ENDIF.

  zcl_ap_sgpi=>text( 'Analizando informaciÃ³n'(ain) ).

  LOOP AT i_listado WHERE devclass = ''.
    SELECT devclass FROM  tadir                         "#EC CI_GENBUFF
      INTO i_listado-devclass
      UP TO 1 ROWS
     WHERE object   = i_listado-object
       AND obj_name = i_listado-name
     ORDER BY PRIMARY KEY.
    ENDSELECT.
    MODIFY i_listado.
  ENDLOOP.

  DELETE i_listado WHERE     NOT devclass IN s_devcla
                         AND NOT devclass IN r_devclass_open.

  LOOP AT i_listado.
    SELECT SINGLE * FROM zbc003
     WHERE name  = i_listado-name
       AND tcode = i_listado-tcode.
    IF sy-subrc = 0.
      MOVE-CORRESPONDING zbc003 TO i_listado.
    ENDIF.

    PERFORM icono_status USING i_listado-estado
            CHANGING i_listado-icono.

    IF i_listado-total > 0.
      zcl_ap_alv_grid=>append_color( EXPORTING colorc      = 'VERDE'
                                     CHANGING  tabla_color = i_listado-color ).
    ELSEIF i_listado-estado = 'B'.
      zcl_ap_alv_grid=>append_color( EXPORTING colorc      = 'ROJO'
                                     CHANGING  tabla_color = i_listado-color ).
    ELSEIF i_listado-estado = 'O'.
      zcl_ap_alv_grid=>append_color( EXPORTING colorc      = 'NARANJA'
                                     CHANGING  tabla_color = i_listado-color ).
    ELSEIF i_listado-estado = 'M'.
      zcl_ap_alv_grid=>append_color( EXPORTING colorc      = 'AMARILLO'
                                     CHANGING  tabla_color = i_listado-color ).
    ENDIF.

    SELECT SINGLE tcode FROM zdocumentos
      INTO l_tcode
     WHERE tcode = i_listado-name.
    IF sy-subrc <> 0 AND i_listado-grupo <> ''.
      SELECT SINGLE tcode FROM zdocumentos
        INTO l_tcode
       WHERE tcode = i_listado-grupo.
    ENDIF.
    IF sy-subrc = 0.
      i_listado-doc = icon_word_processing.
    ENDIF.

    SELECT comentarios FROM zbc003t
      UP TO 1 ROWS
      INTO i_listado-comentarios
     WHERE name  = i_listado-name
       AND tcode = i_listado-tcode
      ORDER BY PRIMARY KEY.
    ENDSELECT.
    MODIFY i_listado.
  ENDLOOP.

  LOOP AT i_listado WHERE         udat IS INITIAL
                          AND NOT cdat IS INITIAL.
    i_listado-udat = i_listado-cdat.
    i_listado-unam = i_listado-cnam.
    MODIFY i_listado.
  ENDLOOP.

  DELETE i_listado WHERE NOT estado IN s_estado.
  DELETE i_listado WHERE NOT asignado_a IN s_asign.
  DELETE i_listado WHERE NOT procesado_por IN s_progr.

  DELETE i_listado WHERE    NOT cnam IN s_cnam
                         OR NOT cdat IN s_cdat
                         OR NOT unam IN s_unam
                         OR NOT udat IN s_udat.

  IF p_gen IS INITIAL.
    DELETE i_listado WHERE text CS '(generated)'.
  ENDIF.

  IF p_tmp IS INITIAL AND p_lib IS INITIAL.
    DELETE i_listado WHERE devclass = '$TMP'.
  ENDIF.

  IF p_vivas = 'X'.
    DELETE i_listado WHERE NOT ( ( cnam = sy-uname OR unam = sy-uname ) ).

    DELETE i_listado WHERE NOT ( cdat >= v_fechas_vivas OR udat >= v_fechas_vivas ).
  ENDIF.

  IF p_lib = 'X'.
    DELETE i_listado WHERE libreria = ''.
  ENDIF.

*      IF p_solom = 'X'.
*        DATA: l_nombre TYPE string,
*              l_fecha  TYPE d.
*        LOOP AT i_listado.
*          REPLACE ALL OCCURRENCES OF '/' IN i_listado-name WITH '_'.
*          CONCATENATE i_listado-object i_listado-name INTO l_nombre SEPARATED BY '_'.
*
*          IF p_lib IS INITIAL.
*            l_fecha = i_listado-udat.
*          ELSE.
** Quiero asegurarme de que se verifica si se ha modificado en el plazo de un mes
*            l_fecha = i_listado-udat + 30.
*            CONCATENATE l_nombre '.TXT' INTO l_nombre.
*          ENDIF.
*          IF l_fecha < sy-datum.
*            LOOP AT i_ficheros WHERE filename CS l_nombre
*                                 AND writedate > l_fecha.
*              EXIT.
*            ENDLOOP.
*            IF sy-subrc = 0.
** SÃ³lo si el fichero no se ha modificado en el Ãºltimos
*              ADD 30 TO i_ficheros-writedate.
*              IF i_ficheros-writedate < sy-datum.
*                DELETE i_listado.
*              ENDIF.
*            ENDIF.
*          ENDIF.
*        ENDLOOP.
*      ENDIF.

  IF p_hash = 'X' OR p_lib = 'X' OR p_solom = 'X' OR p_buscar <> ''.
    zcl_ap_sgpi=>text( 'Calculando hash' ).
    LOOP AT i_listado.
      CLEAR i_listado-color.
      PERFORM get_hash.
      CLEAR i_list_excel.
      READ TABLE i_list_excel WITH KEY object = i_listado-object
                                       name   = i_listado-name
                                       tcode  = i_listado-tcode
                                       ttext  = i_listado-ttext.
      IF sy-subrc = 0.
        i_listado-cliente_descarga = i_list_excel-cliente_descarga.
        i_listado-fecha_descarga   = i_list_excel-fecha_descarga.
      ENDIF.
      IF i_list_excel-hash = i_listado-hash.
        i_listado-icono = icon_equal_green.
      ELSE.
        i_listado-icono = icon_incoming_object.
        i_listado-marca = 'X'.
      ENDIF.
      MODIFY i_listado.
    ENDLOOP.
  ENDIF.

  IF p_lib = 'X'.
    zcl_ap_sgpi=>text( 'Comparando ficheros'(cfi) ).
    PERFORM comparar_ficheros.
  ELSEIF NOT p_rfc IS INITIAL.
    LOOP AT i_listado.
      i_listado-marca = 'X'.
      MODIFY i_listado.
    ENDLOOP.
    PERFORM comparar_ficheros.
  ENDIF.

  IF p_solom = 'X'.
    DELETE i_listado WHERE icono = icon_equal_green.
  ENDIF.

  LOOP AT i_listado ASSIGNING FIELD-SYMBOL(<listado>).
    CASE <listado>-icono.
      WHEN icon_equal_green.
        zcl_ap_alv_grid=>append_color( EXPORTING colorc      = 'VERDE'
                                CHANGING  tabla_color = <listado>-color ).
      WHEN OTHERS.
        IF NOT <listado>-fecha_descarga IS INITIAL.
          IF <listado>-fecha_descarga = sy-datum AND <listado>-cliente_descarga = zcl_c=>cliente_tasks.
            <listado>-icono = icon_incoming_object. " Descarga
            zcl_ap_alv_grid=>append_color( EXPORTING campo = 'CLIENTE_DESCARGA,FECHA_DESCARGA' colorc      = 'VERDE'
                                    CHANGING  tabla_color = <listado>-color ).

          ELSEIF <listado>-icono = icon_incoming_object. " Descarga
            IF <listado>-udat >= <listado>-fecha_descarga.
              zcl_ap_alv_grid=>append_color( EXPORTING campo = 'UDAT,FECHA_DESCARGA' colorc      = 'VERDE'
                                      CHANGING  tabla_color = <listado>-color ).
            ELSE.
              zcl_ap_alv_grid=>append_color( EXPORTING campo = 'UDAT,FECHA_DESCARGA' colorc      = 'ROJO'
                                      CHANGING  tabla_color = <listado>-color ).
            ENDIF.
          ELSEIF <listado>-icono = icon_outgoing_object. " Subida
            IF <listado>-udat < <listado>-fecha_descarga.
              zcl_ap_alv_grid=>append_color( EXPORTING campo = 'UDAT,FECHA_DESCARGA' colorc      = 'VERDE'
                                      CHANGING  tabla_color = <listado>-color ).
            ELSE.
              zcl_ap_alv_grid=>append_color( EXPORTING campo = 'UDAT,FECHA_DESCARGA' colorc      = 'ROJO'
                                      CHANGING  tabla_color = <listado>-color ).
            ENDIF.
          ENDIF.
        ENDIF.
    ENDCASE.
  ENDLOOP.

* Buscamos OTS
  DATA r_object TYPE RANGE OF e071-object.
  LOOP AT i_listado ASSIGNING <listado>.
    r_object = VALUE #( ( option = 'EQ' sign = 'I' low = <listado>-object ) ).
    IF <listado>-object = 'PROG'.
      APPEND VALUE #( option = 'EQ' sign = 'I' low = 'REPS' ) TO r_object.
    ENDIF.
    IF <listado>-object = 'CLAS'.
      DATA(aux1) = <listado>-name(30) && '%'.
      SELECT e071~trkorr e070~strkorr FROM e071 JOIN e070 ON e071~trkorr = e070~trkorr
        INTO CORRESPONDING FIELDS OF <listado>
        UP TO 1 ROWS
       WHERE object IN ('CLAS', 'METH', 'CLSD', 'CPRI', 'CPRO', 'CPUB')
         AND obj_name LIKE aux1
         AND trstatus = 'D' "Pendiente de liberar
       ORDER BY e070~trkorr DESCENDING.
      ENDSELECT.
    ELSE.
      SELECT e071~trkorr e070~strkorr FROM e071 JOIN e070 ON e071~trkorr = e070~trkorr
        INTO CORRESPONDING FIELDS OF <listado>
        UP TO 1 ROWS
       WHERE object IN r_object
         AND obj_name = <listado>-name
         AND trstatus = 'D' "Pendiente de liberar
       ORDER BY e070~trkorr DESCENDING.
      ENDSELECT.
    ENDIF.
    IF NOT <listado>-strkorr IS INITIAL.
      SELECT SINGLE as4text FROM  e07t
        INTO <listado>-as4text
      WHERE  trkorr  = <listado>-strkorr.
    ENDIF.
  ENDLOOP.

  i_list_orig[] = i_listado[].
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  icono_status
*&---------------------------------------------------------------------*
FORM icono_status USING    pe_estado
                  CHANGING ps_icono.

  CASE pe_estado.
    WHEN 'B'.  " Borrar
      ps_icono = icon_delete.
    WHEN 'C'.  " Critico
      ps_icono = icon_message_warning_small.
    WHEN 'O'.  " Obsoleto
      ps_icono = icon_bw_simulate_cancel.
    WHEN '?'.  " Duda
      ps_icono = icon_message_question_small.
    WHEN 'M'.
      ps_icono = icon_message_critical.
    WHEN 'A'.
      ps_icono = icon_okay.
    WHEN 'N'.
      ps_icono = icon_interval_include.
    WHEN 'Q'.
      ps_icono = icon_list.
    WHEN 'R'.
      ps_icono = icon_biw_report.
  ENDCASE.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  editar_nota
*&---------------------------------------------------------------------*
FORM editar_nota USING pe_name
                       pe_tcode.

  DATA: i_zbc003t LIKE zbc003t OCCURS 0 WITH HEADER LINE,
        i_lineas  LIKE zbc003t-comentarios OCCURS 0 WITH HEADER LINE,
        l_titulo  TYPE c LENGTH 80.

  SELECT comentarios FROM zbc003t
    INTO CORRESPONDING FIELDS OF TABLE i_zbc003t
   WHERE name  = pe_name
     AND tcode = pe_tcode.

  LOOP AT i_zbc003t.
    i_lineas = i_zbc003t-comentarios.
    APPEND i_lineas.
  ENDLOOP.

  CONCATENATE 'Notas report'(nre) pe_name pe_tcode
              INTO l_titulo SEPARATED BY space.
  CALL FUNCTION 'TERM_CONTROL_EDIT'
    EXPORTING
      titel          = l_titulo
      langu          = sy-langu
    TABLES
      textlines      = i_lineas
    EXCEPTIONS
      user_cancelled = 1
      OTHERS         = 2.
  IF sy-subrc = 0.
    DELETE FROM zbc003t
     WHERE name  = pe_name
       AND tcode = pe_tcode.
    LOOP AT i_lineas.
      CLEAR zbc003t.
      zbc003t-name        = pe_name.
      zbc003t-tcode       = pe_tcode.
      zbc003t-linea       = sy-tabix.
      zbc003t-comentarios = i_lineas.
      MODIFY zbc003t.
    ENDLOOP.
  ENDIF.
*  endif.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  descargar_slnk
*&---------------------------------------------------------------------*
FORM descargar_slnk USING pe_mail.
  DATA: v_dif     TYPE c LENGTH 50,
        l_no      TYPE c LENGTH 1,
        l_string  TYPE string,
        l_xstring TYPE xstring,
        l_aux     TYPE c LENGTH 40,
        l_nombre  TYPE c LENGTH 80,
        l_smartf  TYPE tdsfname.
  DATA: _objname TYPE string,
        xml      TYPE string.
  DATA deffilename  TYPE string.
  DATA izip         TYPE REF TO cl_abap_zip.
  DATA errorflag    TYPE flag.
  DATA deffilename3 TYPE string.
  DATA i_tabla      TYPE TABLE OF text255.
  DATA: l_version TYPE string,
        zbc003v   TYPE zbc003v.
  DATA deffilename2 TYPE string.
  DATA l_comando    TYPE string.
  DATA zip_file     TYPE xstring.
  DATA binary_tab   TYPE STANDARD TABLE OF x255.
  DATA i_texto_mail LIKE solisti1 OCCURS 0 WITH HEADER LINE.
  DATA i_ficheros   LIKE tnotetem OCCURS 0 WITH HEADER LINE.

  CHECK i_listado-object <> ''.
  CHECK i_listado-name <> ''.

  CLEAR v_dif.
  IF sy-ucomm(4) = 'COMP'.
    CONCATENATE '___DIF_' zcl_c=>empresa INTO v_dif.
  ELSEIF pe_mail = 'B'.
    IF sy-ucomm = 'MACHACAR'.
      CONCATENATE '__DESCARGA_' zcl_c=>empresa '_' sy-datum '_' sy-uzeit INTO v_dif.
    ELSE.
      IF p_lib = 'X'.
        CONCATENATE '__BACKUP_' zcl_c=>empresa '_' sy-datum '_' sy-uzeit INTO v_dif.
      ELSE.
        MESSAGE '¿?' TYPE 'E'.
        DATA(l_versiones) = 'X'.
        CONCATENATE '_' sy-datum '_' sy-uzeit INTO v_dif.
      ENDIF.
    ENDIF.
  ENDIF.

  CASE i_listado-object.
    WHEN 'PROG'.
      IF i_listado-subc = 'P'.
        _objname = i_listado-ttext.
        CONCATENATE i_listado-ttext '_' i_listado-text INTO i_listado-text.
      ELSEIF i_listado-subc = 'A' OR i_listado-subc = '+'.
        IF i_listado-ttext(1) = 'Z'.
          _objname = i_listado-ttext.
        ELSE.
          _objname = i_listado-tcode.
        ENDIF.
      ELSE.
        _objname = i_listado-name.
      ENDIF.
    WHEN 'CLAS'.
      IF i_listado-subc = 'B'.                          " APC03112010
        _objname = i_listado-ttext.
      ELSE.
        _objname = i_listado-name.
      ENDIF.
    WHEN 'TABL' OR 'VIEW' OR
         'TTYP' OR 'DOMA' OR 'DTEL' OR
         'SSFO' OR 'FORM' OR
         'WAPA' OR 'WDYA' OR 'WDYN' OR 'WDCA' OR 'WDCC' OR
         'ENHO' OR 'ENHS' OR
         'SFPF' OR 'SFPI' OR
         'XSLT' OR 'DDLS'.

      _objname = i_listado-name.
    WHEN 'FUGR'.
      IF sy-ucomm = 'COMPARAR' OR sy-ucomm = 'COMP_ONL'.
        _objname = i_listado-name.
      ELSE.
        _objname = i_listado-ttext.
      ENDIF.
    WHEN 'SMIM'.
      _objname = i_listado-text.
    WHEN 'SHLP'.
      EXIT.
  ENDCASE.

  IF i_listado-object <> 'FORM' AND i_listado-object <> 'SFPF' AND i_listado-object <> 'DDLS'.
    CLEAR l_no.
    IF i_listado-object = 'FUGR'.
      IF pe_mail IS INITIAL.
        IF line_exists( i_grupof[ table_line = _objname ] ).
          l_no = 'X'.
        ENDIF.
      ENDIF.
    ENDIF.
    IF l_no IS INITIAL.
      xml = zcl_ap_dev=>get_saplink_xml( object = i_listado-object
                                         nombre = _objname ).
      IF xml IS INITIAL.
        MESSAGE s398(00) WITH 'Install plugin for object type:'(ipo) i_listado-object _objname ''.
      ENDIF.
    ENDIF.
  ENDIF.

  l_string = i_listado-text.
  zcl_ap_string=>limpiar_nombre_fichero( CHANGING string = l_string ).
  i_listado-text = l_string.

  IF pe_mail = 'X' OR p_ftp = 'X'.
    IF p_lib = 'X'.
      CONCATENATE i_listado-object '_' _objname
                 v_dif
                 '.slnk' INTO deffilename.
    ELSE.
      CONCATENATE i_listado-object '_' _objname '_'
                 i_listado-text
                 v_dif
                 '.slnk' INTO deffilename.
    ENDIF.
    IF p_zip = 'X'.
      izip = NEW #( ).
      l_xstring = zcl_ap_string=>string2xstring( xml ).
      izip->add( name    = deffilename
                 content = l_xstring ).
    ENDIF.
  ENDIF.

  DATA(l_object) = i_listado-object.
  DATA(l_objname) = _objname.
  REPLACE ALL OCCURRENCES OF '/' IN l_object WITH '_'.
  REPLACE ALL OCCURRENCES OF '/' IN l_objname WITH '_'.
  REPLACE ALL OCCURRENCES OF '/' IN i_listado-text WITH '_'.
  REPLACE ALL OCCURRENCES OF '\' IN l_object WITH '_'.
  REPLACE ALL OCCURRENCES OF '\' IN l_objname WITH '_'.
  REPLACE ALL OCCURRENCES OF '\' IN i_listado-text WITH '_'.

  IF p_lib IS INITIAL AND i_listado-object <> 'FUGR'.
    IF l_versiones = 'X'.
      CONCATENATE v_directorio '\VERSIONES\'
                 l_object '_' l_objname '_'
                 i_listado-text
                 v_dif
                 '.slnk' INTO deffilename.
    ELSE.
      CONCATENATE v_directorio
                 l_object '_' l_objname '_'
                 i_listado-text
                 v_dif
                 '.slnk' INTO deffilename.

    ENDIF.
  ELSE.
    CONCATENATE v_directorio '\'
               l_object '_' l_objname
               v_dif
               '.slnk' INTO deffilename.
  ENDIF.
  l_aux = deffilename.
  IF l_aux(2) <> '\\'.
    REPLACE '\\' WITH '\' INTO deffilename.
  ENDIF.
  CLEAR errorflag.

  IF p_onedr IS INITIAL.
    REPLACE ALL OCCURRENCES OF '/' IN deffilename WITH '_'.
  ENDIF.

  IF pe_mail <> 'V'.
    IF pe_mail = 'B'.
      IF p_onedr IS INITIAL.
        REPLACE '\LIB' WITH '\LIB_BACKUP' INTO deffilename.
      ELSE.
        REPLACE '/LIB' WITH '/LIB_BACKUP' INTO deffilename.
      ENDIF.
    ENDIF.
    IF i_listado-object = 'SFPF'.
      PERFORM descargar_sfp USING deffilename _objname.
    ELSEIF i_listado-object = 'DDLS'.
    ELSEIF i_listado-object <> 'FORM'.
      CLEAR l_no.
      IF i_listado-object = 'FUGR'.
        IF pe_mail IS INITIAL.
          IF line_exists( i_grupof[ table_line = _objname ] ).
            l_no = 'X'.
          ELSE.
            APPEND _objname TO i_grupof.
          ENDIF.
        ENDIF.
      ENDIF.
      IF l_no IS INITIAL AND sy-ucomm(4) <> 'COMP'.
        PERFORM putonmachine USING deffilename xml.
        IF errorflag IS NOT INITIAL.
          MESSAGE s398(00) WITH 'Error descargando'(ede) deffilename '' ''.
          EXIT.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

  l_nombre = _objname.

  IF i_listado-object = 'SSFO'.
    CONCATENATE l_nombre '' INTO l_smartf.
    CALL FUNCTION 'FB_DOWNLOAD_FORM'
      EXPORTING
        i_formname           = l_smartf
        i_formtype           = ' '
        i_with_dialog        = ''
*     IMPORTING
*       O_FORMNAME           =
      EXCEPTIONS
        no_name              = 1
        no_form              = 2
        no_access_permission = 3
        illegal_language     = 4
        illegal_formtype     = 5
        OTHERS               = 6.
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.
*
*    DATA o_bi TYPE REF TO zcl_batch_input.
*    DATA l_mensaje TYPE bapireturn1-message.
*    CREATE OBJECT o_bi.
*
*    o_bi->inicio( ).
*
** SAP Smart Forms: Initial screen
*    o_bi->dynpro( program = 'SAPMSSFO' dynpro = '0100').
*    o_bi->campos( campo = 'BDC_OKCODE' valor = '=XMLDOWN').
*
** Smart Forms: Determine form name (create, change, ...)
*    o_bi->dynpro( program = 'SAPLSTXB' dynpro = '3000').
*    o_bi->campos( campo = 'BDC_OKCODE' valor = '=ENTER').
*    l_smartf = l_nombre.
*    o_bi->campos( campo = 'SSFSCREEN-FNAME' valor = l_smartf ). " Smart Forms: Nombre formulario
*
** SAP Smart Forms: Initial screen
*    o_bi->dynpro( program = 'SAPMSSFO' dynpro = '0100').
*    o_bi->campos( campo = 'BDC_OKCODE' valor = '=BACK').
*    o_bi->campos( campo = 'RB_SF' valor = 'X').
*
*    CONCATENATE v_directorio '\'
*               i_listado-object '_'
*               i_listado-name '_'
*               i_listado-text
*               v_dif
*               '.xml' INTO deffilename2.
*
*    o_bi->campos( campo = 'SSFSCREEN-FNAME' valor = deffilename2 ). " Smart Forms: Nombre formulario
*
*    l_mensaje = o_bi->llamar_transaccion( tcode = 'SMARTFORMS' modo = 'A').
  ELSEIF i_listado-object = 'FORM'.
    CONCATENATE v_directorio '\'
               i_listado-object '_'
               i_listado-name
               '.txt' INTO deffilename3.
    IF deffilename3(2) <> '\\'.
      REPLACE '\\' WITH '\' INTO deffilename3.
    ENDIF.
    SUBMIT rstxscrp WITH obj_name = _objname             "#EC CI_SUBMIT
           WITH dataset = deffilename3
           EXPORTING LIST TO MEMORY
            AND RETURN.
  ELSEIF i_listado-object = 'FUGR'.
    i_tabla = zcl_ap_dev=>get_objeto_como_texto( tipo   = i_listado-object
                                                 nombre = i_listado-name ).
    _objname = i_listado-name.
  ELSEIF i_listado-object = 'SFPF'.
  ELSE.
    i_tabla = zcl_ap_dev=>get_objeto_como_texto( tipo   = i_listado-object
                                                 nombre = l_nombre ).
  ENDIF.

  IF NOT i_tabla[] IS INITIAL.

    IF pe_mail = 'V'.
      l_version = zcl_ap_string=>tabla2string( tabla = i_tabla[] ).

      CLEAR zbc003v.
      MOVE-CORRESPONDING i_listado TO zbc003v.
      zbc003v-fecha  = sy-datum.
      zbc003v-hora   = sy-uzeit.
      zbc003v-string = l_version.
      MODIFY zbc003v FROM zbc003v.

    ELSE.
      IF p_lib IS INITIAL.
        IF l_versiones IS INITIAL.
          CONCATENATE v_directorio '\'
                     i_listado-object '_'
                     _objname '_'
                     i_listado-text
                     v_dif
                     '.txt' INTO deffilename2.
        ELSE.
          CONCATENATE v_directorio '\VERSIONES\'
                     i_listado-object '_'
                     _objname '_'
                     i_listado-text
                     v_dif
                     '.txt' INTO deffilename2.
        ENDIF.
      ELSE.
        CONCATENATE v_directorio '\'
                   i_listado-object '_'
                   _objname
                   v_dif
                   '.txt' INTO deffilename2.

        CONCATENATE v_directorio '\'
                   i_listado-object '_'
                   _objname
                   '.txt' INTO deffilename3.
      ENDIF.

      IF pe_mail = 'B'.
        REPLACE '\LIB' WITH '\LIB_BACKUP' INTO deffilename2.
        REPLACE '\LIB' WITH '\LIB_BACKUP' INTO deffilename3.
      ENDIF.

      IF o_ms IS INITIAL.
        REPLACE ALL OCCURRENCES OF '/' IN deffilename2 WITH '_'.
        REPLACE ALL OCCURRENCES OF '/' IN deffilename3 WITH '_'.
        IF p_rfc IS INITIAL.
          zcl_ap_ficheros=>grabar( EXPORTING fichero       = deffilename2
                                             mostrar_error = 'I'
                                   CHANGING  tabla         = i_tabla ).
        ENDIF.
      ELSEIF sy-ucomm(4) <> 'COMP'.
        l_string = zcl_ap_string=>tabla2string( i_tabla ).
        IF NOT l_string IS INITIAL.
          REPLACE ALL OCCURRENCES OF '\' IN deffilename2 WITH '/'.
          DATA(l_stringx) = zcl_ap_string=>string2xstring( l_string ).
          REPLACE ALL OCCURRENCES OF ` ` IN deffilename2 WITH '_'.
          o_ms->grabar_fichero( EXPORTING nombre       = deffilename2
                                          contenidox   = l_stringx
                                          content_type = 'text/plain'
                                IMPORTING message      = DATA(l_msg) ).
          IF NOT l_msg IS INITIAL. MESSAGE l_msg TYPE 'E'. ENDIF.
        ENDIF.
      ENDIF.

      IF sy-ucomm = 'COMPARAR'.
        IF p_onedr = 'X'.
          v_text1 = zcl_ap_string=>tabla2string( i_tabla ).
*          zcl_ap_ficheros=>leer_xstring( EXPORTING fichero = deffilename3 get_string = 'X'
          REPLACE ALL OCCURRENCES OF '\' IN deffilename3 WITH '/'.
          o_ms->get_contenido_fichero( EXPORTING nombre          = deffilename3
                                                 popup_respuesta = ''
                                       IMPORTING message         = l_msg
                                                 respuesta       = v_text2
                                                 contenido       = DATA(l_xstringo) ).
          IF NOT l_msg IS INITIAL.
            MESSAGE l_msg TYPE 'I'.
            RETURN.
          ENDIF.
          IF p_dirto IS INITIAL.
            DATA(l_ruta_local) = zcl_ap_ficheros=>get_directorio_temporal( ).
          ELSE.
            l_ruta_local = p_dirto.
          ENDIF.
          deffilename2 = zcl_ap_ficheros=>concat_ruta( directorio = l_ruta_local fichero = 'CLIENTE.TXT' ).
          deffilename3 = zcl_ap_ficheros=>concat_ruta( directorio = l_ruta_local fichero = 'LIB.TXT' ).
          zcl_ap_ficheros=>grabar_xstring( fichero = deffilename2 xstring = zcl_ap_string=>string2xstring( v_text1 ) ).
*          zcl_ap_ficheros=>grabar_xstring( fichero = deffilename3 xstring = zcl_ap_string=>string2xstring( v_text2 ) ).
          zcl_ap_ficheros=>grabar_xstring( fichero = deffilename3 xstring = l_xstringo ).

        ELSE.
          IF NOT p_rfc IS INITIAL.
            DATA(l_temp) = zcl_ap_ficheros=>get_directorio_temporal( ).
            deffilename2  = |{ i_listado-object }_{ i_listado-name }.TXT|.
            deffilename3  = |{ i_listado-object }_{ i_listado-name }_{ p_rfc }.TXT|.
            REPLACE ALL OCCURRENCES OF '/' IN deffilename2 WITH '_'.
            REPLACE ALL OCCURRENCES OF '/' IN deffilename3 WITH '_'.

            DATA i_codigo TYPE tttext255.
            CALL FUNCTION 'Z_RFC_GET_CODIGO'
              EXPORTING
                object   = i_listado-object
                obj_name = i_listado-name
              IMPORTING
                i_codigo = i_codigo.
            i_tabla[] = i_codigo.

            zcl_ap_ficheros=>grabar( EXPORTING fichero       = deffilename2
                                               mostrar_error = 'I'
                                     CHANGING  tabla         = i_tabla ).


            CLEAR i_codigo.
            CALL FUNCTION 'Z_RFC_GET_CODIGO'
              DESTINATION p_rfc
              EXPORTING
                object   = i_listado-object
                obj_name = i_listado-name
              IMPORTING
                i_codigo = i_codigo.


            zcl_ap_ficheros=>grabar( EXPORTING fichero       = deffilename3
                                               mostrar_error = 'I'
                                     CHANGING  tabla         = i_codigo ).
          ENDIF.
          CONCATENATE '"' deffilename2 '"' INTO deffilename2.
          CONCATENATE '"' deffilename3 '"' INTO deffilename3.
        ENDIF.

        CONCATENATE deffilename2 deffilename3
                    INTO l_comando SEPARATED BY space.

        cl_gui_frontend_services=>execute( EXPORTING  application            = v_ruta_comparador
                                                      parameter              = l_comando
                                           EXCEPTIONS cntl_error             = 1
                                                      error_no_gui           = 2
                                                      bad_parameter          = 3
                                                      file_not_found         = 4
                                                      path_not_found         = 5
                                                      file_extension_unknown = 6
                                                      error_execute_failed   = 7
                                                      synchronous_failed     = 8
                                                      not_supported_by_gui   = 9 ).
        IF sy-subrc <> 0.
          MESSAGE 'Error lanzando comparador' TYPE 'I'.
        ENDIF.
      ELSEIF sy-ucomm = 'COMP_ONL'.
        v_text1 = zcl_ap_string=>tabla2string( i_tabla ).
        zcl_ap_ficheros=>leer_xstring( EXPORTING fichero    = deffilename3
                                                 get_string = 'X'
                                       IMPORTING string     = v_text2 ).

        DATA(v_url1) = 'https://sap4-my.sharepoint.com/:t:/p/andres/EVad4mu4Cd5PidxmVnjy8U8BZ_--2JfOLBhTmGnVP9YwbA?e=kS34KU?&download=1'.
        DATA(v_url2) = 'https://sap4-my.sharepoint.com/:t:/p/andres/EZDfCwIhjrBBph9h8h9TBWIBuOVwU870gwm4Taan_dX5GA?e=XaIFnf?&download=1'.
*        DATA(v_url1) = 'https://sap4-my.sharepoint.com/personal/andres_sap4_com/Documents/Compartir/temp/t1.txt?ga=1'.
*        DATA(v_url2) = 'https://sap4-my.sharepoint.com/personal/andres_sap4_com/Documents/Compartir/temp/t2.txt?ga=2'.
*        DATA(l_url) = |https://extendsclass.com/text-compare.html?url1=data:text/plain;charset=UTF-8;page=21,{ v_text1 }&url2=data:text/plain;charset=UTF-8;page=21,{ v_text2 }|.
        DATA(l_url) = |https://extendsclass.com/text-compare.html?url1={ v_url1 }&url2={ v_url2 }|.
*        DATA(l_url) = |https://www.diffnow.com/compare-urls?url1={ v_url1 }&url2={ v_url2 }|.
        zcl_ap_gos=>visualizar_fichero_st( l_url ).
      ENDIF.
    ENDIF.
  ENDIF.

  IF pe_mail <> 'V'.
    IF pe_mail = 'X' OR p_ftp = 'X'.
      IF p_zip = 'X'.
        CONCATENATE _objname '_'
                   i_listado-text
                   '.txt' INTO deffilename2.
        l_string  = zcl_ap_string=>tabla2string( i_tabla ).
        l_xstring = zcl_ap_string=>string2xstring( l_string ).

        CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
          EXPORTING
            buffer     = zip_file
          TABLES
            binary_tab = binary_tab.

        CONCATENATE v_directorio '\'
                   _objname '_'
                   i_listado-text
                   v_dif
                   '.zip' INTO deffilename2.

        zcl_ap_ficheros=>grabar( EXPORTING fichero       = deffilename2
                                           tipo          = 'BIN'
                                           mostrar_error = 'I'
                                 CHANGING  tabla         = binary_tab ).
      ENDIF.

      REFRESH i_texto_mail.
      LOOP AT i_tabla INTO i_texto_mail.
        APPEND i_texto_mail.
      ENDLOOP.

      IF v_no_se_adjunta_slnk IS INITIAL.
        IF p_zip IS INITIAL.
          i_ficheros-template = deffilename.
        ELSE.
          i_ficheros-template = deffilename2.
        ENDIF.
        APPEND i_ficheros.
        APPEND i_ficheros-template TO i_ficheros_ftp.

      ENDIF.

      IF pe_mail = 'X'.
        CONCATENATE '(' zcl_c=>empresa ')' i_listado-name '-'
                   i_listado-text INTO deffilename2.

        IF v_ans = 'J'.
          DELETE i_ficheros WHERE template = ''.
          IF p_outlo IS INITIAL.
*            CALL FUNCTION 'Z_ENVIO_MAIL'
*              EXPORTING
*                subject    = deffilename2
*                direccion  = v_emailaddr
*                urgente    = 'X'
*                html       = ''
*              TABLES
*                texto      = i_texto_mail
*                t_ficheros = i_ficheros.
          ELSE.
            PERFORM outlook TABLES i_ficheros i_texto_mail
                    USING v_emailaddr deffilename2.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

  IF pe_mail = ''.
    PERFORM get_hash.
    i_listado-descargado = 'X'.
  ENDIF.
ENDFORM.

*\--------------------------------------------------------------------/


*/------------------------putOnMachine--------------------------------\
FORM putonmachine USING fullpath  TYPE string
                        xmlstring TYPE string.

  IF xmlstring IS INITIAL.
    RETURN.
  ENDIF.

  IF NOT o_ms IS INITIAL.
    DATA(l_xstring) = zcl_ap_string=>string2xstring( xmlstring ).
    IF NOT l_xstring IS INITIAL.
*        o_ms->grabar_fichero( EXPORTING nombre = fullpath contenidox = l_xstring content_type = 'text/plain'
      REPLACE ALL OCCURRENCES OF '\' IN fullpath WITH '/'.
      REPLACE ALL OCCURRENCES OF 'GD_LIB_LIB' IN fullpath WITH 'GD_LIB/LIB'.
      CONDENSE fullpath.
      REPLACE ALL OCCURRENCES OF ` ` IN fullpath WITH '_'.
      " TODO: variable is assigned but never used (ABAP cleaner)
      DATA(l_stringx) = zcl_ap_string=>string2xstring( xmlstring ).
      o_ms->grabar_fichero( EXPORTING nombre       = fullpath
                                      contenidox   = l_xstring
                                      content_type = 'text/plain'
                            IMPORTING message      = DATA(l_msg) ).
      IF NOT l_msg IS INITIAL. MESSAGE l_msg TYPE 'E'. ENDIF.
    ENDIF.
  ELSE.
    TRY.
        TRY.
            zcl_ap_ficheros=>grabar_xstring( fichero       = fullpath
                                             local         = 'X'
                                             mostrar_error = 'I'
                                             string        = xmlstring ).
            CLEAR v_no_se_adjunta_slnk.
          CATCH cx_root.
            v_no_se_adjunta_slnk = 'X'.
        ENDTRY.
      CATCH cx_root.
        v_no_se_adjunta_slnk = 'X'.
    ENDTRY.
  ENDIF.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  outlook
*&---------------------------------------------------------------------*

FORM outlook
  TABLES email_attachments STRUCTURE tnotetem
         email_body        STRUCTURE solisti1
  USING  email_address
         subject.

  DATA: g_translate    TYPE c LENGTH 2,
        t_vbs          LIKE STANDARD TABLE OF soli WITH HEADER LINE,
        g_file         TYPE c LENGTH 120,
        g_last         TYPE c LENGTH 1,
        g_vbs_filename LIKE rlgrap-filename,
        commandline    TYPE string.
  DATA l_string TYPE string.

*- Prepare a code to translate a quote into a hex-tab
*- so it can then be translated back to 2 double quotes.
  CONCATENATE '"' cl_abap_char_utilities=>cr_lf+1(1) INTO g_translate.

  APPEND: 'Dim myolapp ' TO t_vbs,                          "#EC *
      'Dim olNamespace ' TO t_vbs,                          "#EC *
      'Dim myItem ' TO t_vbs,                               "#EC *
      'Dim myRecipient ' TO t_vbs,                          "#EC *
      'Dim myAttachments ' TO t_vbs,                        "#EC *
      ' ' TO t_vbs,                                         "#EC *
      'Set myolapp = CreateObject("Outlook.Application") ' TO t_vbs, "#EC *
      'Set olNamespace = myolapp.GetNamespace("MAPI") ' TO t_vbs, "#EC *
      'Set myItem = myolapp.CreateItem(olMailItem) ' TO t_vbs, "#EC *
      ' ' TO t_vbs.

*- Destinatarios del mensaje
*  LOOP AT email_address.
*   IF email_address = space. CONTINUE. ENDIF.
  CONCATENATE
    'Set myRecipient = myItem.Recipients.Add("' email_address '")' "#EC *
    INTO t_vbs.
  APPEND t_vbs.
*  ENDLOOP.

*- Asunto del mensaje
  CONCATENATE 'myItem.Subject = "' subject '"' INTO t_vbs.  "#EC *
  APPEND t_vbs.

*- Ficheros adjuntos
  APPEND 'Set myAttachments = myItem.Attachments' TO t_vbs. "#EC *

*- Chequeamos la existencia de los ficheros adjuntos
  LOOP AT email_attachments.

    g_file = email_attachments-template.

*    CALL FUNCTION 'WS_QUERY'
*      EXPORTING
*        filename       = g_file
*        query          = 'FE'
*      EXCEPTIONS
*        inv_query      = 1
*        no_batch       = 2
*        frontend_error = 3
*        OTHERS         = 4.
*    IF sy-subrc EQ 0.
    IF zcl_ap_ficheros=>existe( g_file ).
      CONCATENATE 'myAttachments.Add("' email_attachments-template '")' "#EC *
                  INTO t_vbs.
      APPEND t_vbs.
    ELSE.
      MESSAGE i000(38) WITH
        'No se ha podido adjuntar el fichero'(npa) email_attachments.
    ENDIF.
  ENDLOOP.

*- Cuerpo del email
  CLEAR: g_last,
         t_vbs.
  APPEND t_vbs.
  LOOP AT email_body.
    AT FIRST.
      APPEND 'myitem.body = _' TO t_vbs.
    ENDAT.
    AT LAST.
      g_last = 'X'.
    ENDAT.

*- Double-quotes(") will cause an error in VBScript
*- Replace with a hex-tab and then replace with
*- 2 double-quotes ("")
    TRANSLATE email_body USING g_translate.
    WHILE sy-subrc = 0.
      REPLACE cl_abap_char_utilities=>cr_lf+1(1)
              WITH '""' INTO email_body.
    ENDWHILE.

    IF g_last = 'X'.
      CONCATENATE '"' email_body '" &vbCrLf '
                  INTO t_vbs.
    ELSE.
      CONCATENATE '"' email_body '" &vbCrLf &_'
                  INTO t_vbs.
    ENDIF.
    APPEND t_vbs.
  ENDLOOP.

*  APPEND 'myItem.Display' TO t_vbs.
  APPEND 'myItem.Send' TO t_vbs.

*- Preparamos el nombre de fichero vbscript para descargarlo
*- y ejecutarlo, llamando a la variable de entorno de Windows
*- TEMP
  CLEAR g_vbs_filename.
*  CALL FUNCTION 'WS_QUERY'
*    EXPORTING
*      environment    = 'TEMP'
*      query          = 'EN'
*    IMPORTING
*      return         = g_vbs_filename
*    EXCEPTIONS
*      inv_query      = 1
*      no_batch       = 2
*      frontend_error = 3
*      OTHERS         = 4.

  g_vbs_filename = zcl_ap_ficheros=>get_directorio_temporal( ).

  CONCATENATE g_vbs_filename 'mail.vbs' INTO g_vbs_filename.
  commandline = g_vbs_filename.

  PERFORM sapgui_progress(rstxldmc) USING 10
    'Realizando download de fichero...'(rdf).

  l_string = g_vbs_filename.

*- Descargamos el fichero vbscript
  zcl_ap_ficheros=>grabar( EXPORTING fichero = l_string
                           CHANGING  tabla   = t_vbs[] ).

* Abrimos el Outlook
  PERFORM sapgui_progress(rstxldmc) USING 50
    'Abriendo Outlook... Espere por favor'(aol).

  cl_gui_frontend_services=>execute( EXPORTING  application            = 'WSCRIPT.EXE'
                                                parameter              = commandline
                                     EXCEPTIONS cntl_error             = 1
                                                error_no_gui           = 2
                                                bad_parameter          = 3
                                                file_not_found         = 4
                                                path_not_found         = 5
                                                file_extension_unknown = 6
                                                error_execute_failed   = 7
                                                synchronous_failed     = 8
                                                not_supported_by_gui   = 9 ).
  IF sy-subrc <> 0.
    MESSAGE 'Error abriendo outlook' TYPE 'I'.
  ELSE.
    MESSAGE s000(38) WITH 'Abriendo Outlook... Espere por favor'(aol).
    WAIT UP TO 5 SECONDS.
  ENDIF.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  copy_ftp
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM copy_ftp.
  DATA o_ftp TYPE REF TO zcl_ap_ftp.

  o_ftp = NEW #( ).

  o_ftp->connect( user     = 'sap4abap'
                  password = 'B5DC3B26771B'
                  host     = 'sap4.com' ).

  IF NOT o_ftp->error_conexion IS INITIAL.
    MESSAGE 'Error de conexion'(eco) TYPE 'E'.
  ELSE.
    IF o_ftp->cd( 'lib' ) = 'X'.

      IF NOT zcl_c=>empresa IS INITIAL.
        IF o_ftp->cd( zcl_c=>empresa ) = ''.
          MESSAGE e398(00) WITH 'Error al cambiar a dir.FTP'(eft) zcl_c=>empresa '' ''.
        ENDIF.
      ENDIF.

      LOOP AT i_ficheros_ftp.
        IF o_ftp->put( i_ficheros_ftp ) = ''.
          WRITE / o_ftp->mensaje_error.
        ENDIF.
      ENDLOOP.
    ENDIF.

    o_ftp->disconnect( ).

  ENDIF.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  COMPARAR_FICHEROS
*&---------------------------------------------------------------------*
FORM comparar_ficheros.
  DATA: i_ficheros TYPE TABLE OF file_info WITH HEADER LINE,
        i_tabla    TYPE TABLE OF text1024,
        i_tabla2   TYPE TABLE OF text1024 WITH HEADER LINE,
        l_tabla    TYPE text1024,
        l_aux1     TYPE string,
        l_aux2     TYPE string.
  DATA l_nombrefichero TYPE string.
  DATA v_text3         TYPE string.
  DATA string          TYPE string.
  DATA: aux1 TYPE c LENGTH 80,
        aux2 TYPE c LENGTH 80,
        aux3 TYPE c LENGTH 80,
        aux4 TYPE c LENGTH 80,
        aux5 TYPE string.
  DATA r_lin_exc TYPE RANGE OF string.
  DATA l_dif     TYPE i.
  DATA: i_t1_255 TYPE TABLE OF text255,
        i_t2_255 TYPE TABLE OF text255.
  DATA abaptext_delta LIKE vxabapt255 OCCURS 0 WITH HEADER LINE.

  i_ficheros[] = zcl_ap_ficheros=>lista_ficheros( v_directorio ).
  LOOP AT i_ficheros.
    i_ficheros-filename = to_upper( i_ficheros-filename ). "#EC TRANSLANG
    MODIFY i_ficheros.
  ENDLOOP.

  LOOP AT i_listado WHERE marca = 'X'.
    zcl_ap_sgpi=>text( |Comparando { i_listado-name }| ).

    CLEAR: i_tabla,
           i_tabla2.
    REFRESH: i_tabla, i_tabla2.

    CONCATENATE i_listado-object '_' i_listado-name '.txt' INTO DATA(l_nf).
    IF o_ms IS INITIAL.
      IF p_rfc IS INITIAL.
        CONCATENATE v_directorio '\' l_nf INTO l_nombrefichero.
        l_nombrefichero = to_upper( l_nombrefichero ).

        CLEAR i_ficheros.
        READ TABLE i_ficheros WITH KEY filename = l_nombrefichero.
        IF sy-subrc = 0.
          zcl_ap_ficheros=>leer( EXPORTING fichero       = l_nombrefichero
                                           mostrar_error = ''
                                 CHANGING  tabla         = i_tabla[] ).
        ENDIF.
      ELSE.
        DATA i_codigo TYPE tttext255.
        CALL FUNCTION 'Z_RFC_GET_CODIGO'
          DESTINATION p_rfc
          EXPORTING
            object   = i_listado-object
            obj_name = i_listado-name
            modo     = 'C'
          IMPORTING
            i_codigo = i_codigo
            trdir    = trdir.

        i_listado-fecha_descarga = trdir-udat.
        i_listado-cliente_descarga = trdir-unam.


        i_tabla[] = i_codigo.

      ENDIF.
    ELSE.
      CONCATENATE v_directorio '/' l_nf INTO l_nombrefichero.
      o_ms->get_contenido_fichero( EXPORTING nombre          = l_nombrefichero
                                             popup_respuesta = ''
                                   IMPORTING message         = DATA(l_msg)
                                             respuesta       = DATA(v_text2)
                                             contenido       = DATA(l_xstring) ).
      IF NOT l_msg IS INITIAL.
        MESSAGE l_msg TYPE 'I'.
        RETURN.
      ENDIF.
      TRY.

          DATA(lv_conv) = cl_abap_conv_in_ce=>create(
                              encoding = '1100'
                              input    = l_xstring ).

        CATCH cx_root INTO DATA(o_root).
          l_msg = o_root->get_text( ).
      ENDTRY.

      TRY.

          lv_conv->read(
            IMPORTING
              data = v_text3 ).

        CATCH cx_root INTO o_root.
          l_msg = o_root->get_text( ).
      ENDTRY.

      zcl_ap_string=>string2tabla( EXPORTING string = v_text3 longitud = 255 CHANGING tabla = i_tabla[] ).

*      LOOP AT i_tabla ASSIGNING FIELD-SYMBOL(<sss>).
*        IF <sss> CS 'No!'.
*          BREAK-POINT.
*        ENDIF.
*      ENDLOOP.

    ENDIF.

    DATA l_s TYPE string.
    DEFINE fix_comment.
      IF l_tabla CS &1.
        REPLACE ALL OCCURRENCES OF &1 IN l_tabla WITH '.'.
      ENDIF.
      l_s = l_tabla.
      zcl_ap_string=>quitar_caracteres_extranos( CHANGING string = l_s ).
      l_tabla = l_s.
    END-OF-DEFINITION.

    DEFINE fix_comments.
      fix_comment: `. "#EC NOTEXT .`, ` ##NO_TEXT.`.
    END-OF-DEFINITION.

    IF i_tabla IS INITIAL.
      i_listado-icono    = icon_incoming_object.  " BAJAR
      i_listado-libreria = 'N'.
    ELSE.
      IF p_rfc IS INITIAL.
        zcl_ap_dev=>texto_comparable( CHANGING i_tabla = i_tabla[] ).

        LOOP AT i_tabla INTO l_tabla.                    "#EC CI_NESTED
          IF l_tabla CS 'type-pools' OR l_tabla CS 'TYPE_POOLS'.
            DELETE i_tabla.
            CONTINUE.
          ELSEIF l_tabla CS '"'.
            SPLIT l_tabla AT '"' INTO l_aux1 l_aux2.
            l_tabla = l_aux1.
          ENDIF.
          fix_comments.

          IF ( i_listado-subc = 'T' OR i_listado-subc = 'E' ) AND l_tabla CS ';'.
            SPLIT l_tabla AT ';' INTO aux1 aux2 aux3 aux4 aux5.
            CONCATENATE aux1 aux2 aux3 aux4 INTO l_tabla SEPARATED BY ';'.
          ENDIF.

          MODIFY i_tabla FROM l_tabla.
        ENDLOOP.

        LOOP AT i_tabla INTO l_tabla.                    "#EC CI_NESTED
          IF l_tabla IS INITIAL.
            DELETE i_tabla.
          ENDIF.
        ENDLOOP.

        DO 10 TIMES.
          DATA(l_reintentar) = ''.
          LOOP AT i_tabla ASSIGNING FIELD-SYMBOL(<t>).   "#EC CI_NESTED
            CONDENSE <t> NO-GAPS.
            <t> = to_upper( <t> ).
            IF <t> = 'TYPES:' OR <t> = 'TYPES'.
              DATA(l_idx) = sy-tabix + 1.
              READ TABLE i_tabla INTO DATA(l_t2) INDEX l_idx.
              IF sy-subrc = 0.
                CONDENSE l_t2 NO-GAPS. l_t2 = to_upper( l_t2 ).
                <t> = |TYPES{ l_t2 }|.
                DELETE i_tabla INDEX l_idx.
                l_reintentar = 'X'.
              ENDIF.
            ENDIF.
            IF <t> = 'CONSTANTS:' OR <t> = 'CONSTANTS'.
              l_idx = sy-tabix + 1.
              READ TABLE i_tabla INTO l_t2 INDEX l_idx.
              IF sy-subrc = 0.
                CONDENSE l_t2 NO-GAPS. l_t2 = to_upper( l_t2 ).
                <t> = |CONSTANTS{ l_t2 }|.
                DELETE i_tabla INDEX l_idx.
                l_reintentar = 'X'.
              ENDIF.
            ENDIF.
          ENDLOOP.
          IF l_reintentar IS INITIAL.
            EXIT.
          ENDIF.
        ENDDO.
      ENDIF.

      i_listado-nlinlib = lines( i_tabla ).
      i_tabla2[] = zcl_ap_dev=>get_objeto_como_texto( tipo   = i_listado-object
                                                      nombre = i_listado-name
                                                      modo   = 'C' ).

      IF p_rfc IS INITIAL.
        LOOP AT i_tabla2 INTO l_tabla.                   "#EC CI_NESTED
          IF l_tabla CS 'type-pools' OR l_tabla CS 'TYPE_POOLS'.
            DELETE i_tabla2.
            CONTINUE.
          ELSEIF l_tabla CS '"'.
            SPLIT l_tabla AT '"' INTO l_aux1 l_aux2.
            l_tabla = l_aux1.
          ENDIF.

          fix_comments.
          MODIFY i_tabla2 FROM l_tabla.
        ENDLOOP.

        LOOP AT i_tabla2 INTO l_tabla.                   "#EC CI_NESTED
          IF l_tabla IS INITIAL.
            DELETE i_tabla2.
          ENDIF.
        ENDLOOP.

        DO 10 TIMES.
          l_reintentar = ''.
          LOOP AT i_tabla2 ASSIGNING <t>.                "#EC CI_NESTED
            CONDENSE <t> NO-GAPS.
            <t> = to_upper( <t> ).
            IF <t> = 'TYPES:' OR <t> = 'TYPES'.
              l_idx = sy-tabix + 1.
              READ TABLE i_tabla2 INTO l_t2 INDEX l_idx.
              IF sy-subrc = 0.
                CONDENSE l_t2 NO-GAPS. l_t2 = to_upper( l_t2 ).
                <t> = |TYPES{ l_t2 }|.
                DELETE i_tabla2 INDEX l_idx.
                l_reintentar = 'X'.
              ENDIF.
            ENDIF.

            IF <t> = 'CONSTANTS:' OR <t> = 'CONSTANTS'.
              l_idx = sy-tabix + 1.
              READ TABLE i_tabla INTO l_t2 INDEX l_idx.
              IF sy-subrc = 0.
                CONDENSE l_t2 NO-GAPS. l_t2 = to_upper( l_t2 ).
                <t> = |CONSTANTS{ l_t2 }|.
                DELETE i_tabla INDEX l_idx.
                l_reintentar = 'X'.
              ENDIF.
            ENDIF.
          ENDLOOP.
          IF l_reintentar IS INITIAL.
            EXIT.
          ENDIF.
        ENDDO.

        r_lin_exc = VALUE #( option = 'EQ'
                             sign   = 'I'
                             ( low = 'PRIVATESECTION.' )
                             ( low = 'PROTECTEDSECTION.' ) ).
        LOOP AT i_tabla INTO l_tabla.                    "#EC CI_NESTED
          IF l_tabla IN r_lin_exc.
            DELETE i_tabla.
          ENDIF.
        ENDLOOP.
        LOOP AT i_tabla2 INTO l_tabla.                   "#EC CI_NESTED
          IF l_tabla IN r_lin_exc.
            DELETE i_tabla2.
          ENDIF.
        ENDLOOP.

        DATA(i_t) = i_tabla[].
        CLEAR i_tabla[].
        CLEAR string.
        LOOP AT i_t ASSIGNING <t>.                       "#EC CI_NESTED
          IF string IS INITIAL.
            string = <t>.
          ELSE.
            CONCATENATE string <t> INTO string SEPARATED BY space.
          ENDIF.

          IF zcl_ap_string=>ultimo_caracter( <t> ) = '.'.
            IF i_listado-object = 'CLAS'. REPLACE ALL OCCURRENCES OF '!' IN string WITH ''. ENDIF.
            CONDENSE string NO-GAPS.
            APPEND string TO i_tabla.
            CLEAR string.
          ENDIF.
        ENDLOOP.
        i_t = i_tabla2[].
        CLEAR i_tabla2[].
        LOOP AT i_t ASSIGNING <t>.                       "#EC CI_NESTED
          IF string IS INITIAL.
            string = <t>.
          ELSE.
            CONCATENATE string <t> INTO string SEPARATED BY space.
          ENDIF.
          IF zcl_ap_string=>ultimo_caracter( <t> ) = '.'.
            IF i_listado-object = 'CLAS'. REPLACE ALL OCCURRENCES OF '!' IN string WITH ''. ENDIF.
            CONDENSE string NO-GAPS.
            APPEND string TO i_tabla2.
            CLEAR string.
          ENDIF.
        ENDLOOP.
      ENDIF.

      i_listado-nlinlib = lines( i_tabla ).
      i_listado-nlinact = lines( i_tabla2 ).

      i_listado-icono   = icon_equal_green.

      IF i_listado-nlinlib <> i_listado-nlinact.
        i_listado-icono = icon_not_equal_red.
      ELSE.
        IF p_rfc IS INITIAL.
          LOOP AT i_tabla INTO l_tabla.                  "#EC CI_NESTED
            IF l_tabla(6) = 'TYPES:'. l_tabla+5 = l_tabla+6. ENDIF.
            CLEAR i_tabla2.
            READ TABLE i_tabla2 INDEX sy-tabix.
            IF i_tabla2(6) = 'TYPES:'. i_tabla2+5 = i_tabla2+6. ENDIF.
            IF l_tabla = i_tabla2.
              CONTINUE.
            ENDIF.

            IF NOT o_ms IS INITIAL.
              IF i_tabla2 = 'IFSTRINGCS''EUR''.' AND l_tabla = 'IFSTRINGCS''.''.'.
                CONTINUE.
              ENDIF.
              IF i_tabla2 = 'REPLACEALLOCCURRENCESOF''EUR''INSTRINGWITH''EUR''.' AND l_tabla = 'REPLACEALLOCCURRENCESOF''.''INSTRINGWITH''EUR''.'.
                CONTINUE.
              ENDIF.
            ENDIF.

* Se raya con los acentos...
            DATA(l_ok) = ''.
            IF NOT o_ms IS INITIAL.
              IF strlen( l_tabla ) = strlen( i_tabla2 ).
                DATA(l_long) = strlen( l_tabla ).
                CLEAR l_dif.
                DO l_long TIMES.
                  DATA(l_inx) = sy-index - 1.
                  IF l_tabla+l_inx(1) <> i_tabla2+l_inx(1).
                    IF l_tabla+l_inx(1) = '?' OR l_tabla+l_inx(1) = '.' OR l_tabla+l_inx(1) = '¡'.
                    ELSE.
                      l_dif = l_dif + 1.
                    ENDIF.
                  ENDIF.
                ENDDO.
                IF l_dif = 0.
                  l_ok = 'X'.
                ELSE.
                  l_ok = ''.
                ENDIF.
              ENDIF.
            ENDIF.
            IF l_ok IS INITIAL.
              i_listado-icono = icon_not_equal_red.
              EXIT.
            ENDIF.
          ENDLOOP.
        ELSE.
          IF i_tabla2[] NE i_tabla[].
            i_listado-icono = icon_not_equal_red.
          ENDIF.
        ENDIF.
      ENDIF.

      IF i_listado-icono = icon_not_equal_red.
        i_t1_255 = i_tabla2[].
        i_t2_255 = i_tabla[].
        abaptext_delta[] = zcl_ap_dev=>comparar_reports( tabla1 = i_t1_255
                                                         tabla2 = i_t2_255 ).

        LOOP AT abaptext_delta.                          "#EC CI_NESTED
          CLEAR i_cambios.
          MOVE-CORRESPONDING abaptext_delta TO i_cambios.
          i_cambios-name = i_listado-name.
          APPEND i_cambios.
        ENDLOOP.

        IF     i_listado-nlinact  > i_listado-nlinlib
           AND i_listado-udat    >= i_ficheros-writedate.
          i_listado-icono = icon_incoming_object.                      " BAJAR
        ELSEIF     i_listado-nlinact  < i_listado-nlinlib
               AND i_listado-udat    <= i_ficheros-writedate.
          i_listado-icono = icon_outgoing_object.                      " SUBIR
        ENDIF.
      ENDIF.
    ENDIF.

    IF p_solom = '' OR i_listado-icono <> icon_equal_green.
      MODIFY i_listado.
    ELSE.
      DELETE i_listado.
    ENDIF.

  ENDLOOP.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  SUBIR_LIB
*&---------------------------------------------------------------------*
FORM subir_lib.
  DATA: l_tipo    TYPE c LENGTH 4,
        l_file    TYPE c LENGTH 300,
        isslinkee TYPE c LENGTH 1.
  DATA: l_object   TYPE e071-object,
        l_obj_name TYPE e071-obj_name.

  PERFORM get_tipo USING i_listado-subc i_listado-name
          CHANGING l_tipo.

  CONCATENATE l_tipo '_' i_listado-name '.slnk' INTO DATA(l_nf).
  IF NOT o_ms IS INITIAL AND NOT p_dirto IS INITIAL.

    CONCATENATE v_directorio '/' l_nf INTO l_file.
    o_ms->get_contenido_fichero( EXPORTING nombre = CONV #( l_file ) popup_respuesta = '' IMPORTING message = DATA(l_msg) respuesta = DATA(v_text2) ).
    IF NOT l_msg IS INITIAL.
      MESSAGE l_msg TYPE 'I'.
      RETURN.
    ENDIF.
    l_file = zcl_ap_ficheros=>concat_ruta( directorio = p_dirto fichero = l_nf ).
    zcl_ap_ficheros=>grabar_xstring( fichero = l_file xstring = zcl_ap_string=>string2xstring( v_text2 ) ).
  ELSE.

    CONCATENATE v_directorio '\' l_nf INTO l_file.
  ENDIF.

  isslinkee = 'X'.
  EXPORT isslinkee TO MEMORY ID 'ISSLNK'.
  SUBMIT zsaplink                                        "#EC CI_SUBMIT
   AND RETURN
*   VIA SELECTION-SCREEN
         WITH filename = l_file
         WITH slpkg    = i_listado-devclass
         WITH overwr   = 'X'.

  PERFORM cambiar_clase_desarrollo.

  l_object   = l_tipo.
  l_obj_name = i_listado-name.
  zcl_ap_dev=>activar_objeto( object   = l_object
                              obj_name = l_obj_name ).
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  GET_TIPO
*&---------------------------------------------------------------------*
FORM get_tipo USING    pe_subc
                       pe_name
              CHANGING ps_tipo.

  CASE pe_subc.
    WHEN '1' OR 'I' OR 'M'.
      ps_tipo = 'PROG'.
    WHEN 'C'.
      ps_tipo = 'CLAS'.
    WHEN 'T' OR 'E'.
      SELECT SINGLE as4date as4user tabclass tabname FROM dd02l
        INTO CORRESPONDING FIELDS OF dd02l
       WHERE tabname = pe_name.
      IF sy-subrc = 0.
        ps_tipo = 'TABL'.
      ELSE.
        CLEAR ps_tipo.
      ENDIF.
    WHEN 'D'.
      ps_tipo = 'TTYP'.
    WHEN 'F'.
      ps_tipo = 'FUGR'.
  ENDCASE.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  CAMBIAR_CLASE_DESARROLLO
*&---------------------------------------------------------------------*
FORM cambiar_clase_desarrollo.
  e071-obj_name = i_listado-name.
  zcl_ap_dev=>popup_cambio_clase_desarrollo( object   = i_listado-object
                                             obj_name = e071-obj_name
                                             devclass = i_listado-devclass ).
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  VER_VERSIONES
*&---------------------------------------------------------------------*

CLASS lcl_alv_popup DEFINITION INHERITING FROM zcl_ap_alv FINAL.
  PUBLIC SECTION.
    DATA i_versiones TYPE TABLE OF zbc003v.

    METHODS handle_double_click REDEFINITION.
ENDCLASS.                    " lcl_alv DEFINITION


*----------------------------------------------------------------------*
*       CLASS lcl_alv IMPLEMENTATION
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
CLASS lcl_alv_popup IMPLEMENTATION.
  METHOD handle_double_click.
    DATA l_version TYPE zbc003v.

    READ TABLE i_versiones INTO l_version INDEX row.
    IF sy-subrc = 0.
      zcl_ap_string=>editor_popup_string( l_version-string ).
    ENDIF.
  ENDMETHOD.
ENDCLASS.                    " lcl_alv IMPLEMENTATION

*&---------------------------------------------------------------------*
*&      Form  ver_versiones
*&---------------------------------------------------------------------*

FORM ver_versiones.
  DATA o_alv TYPE REF TO lcl_alv_popup.

  o_alv = NEW #( tabla = '' ).

  SELECT * FROM zbc003v
    INTO TABLE o_alv->i_versiones
   WHERE name  = i_listado-name
     AND tcode = i_listado-tcode.

  o_alv->constructor_tabla( EXPORTING tabla   = 'I_VERSIONES'
                            CHANGING  t_tabla = o_alv->i_versiones ).

  o_alv->show( ).
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  ACTUALIZAR_REPOSITORIO
*&---------------------------------------------------------------------*
FORM actualizar_repositorio.
  DATA: o_repo    TYPE REF TO zcl_ap_repo,
        l_cambio  TYPE c LENGTH 1,
        l_repo    TYPE zap_repo,
        l_fichero TYPE string.

  o_repo = NEW #( origen        = p_origen
                  ruta_pc_local = v_directorio ).

  o_repo->conexion( password = 'B5DC3B23704A7C' ).

  LOOP AT i_listado WHERE marca = 'X'.
    CLEAR l_cambio.
    READ TABLE o_repo->i_repo INTO l_repo WITH KEY object = i_listado-object
                                                   nombre = i_listado-name.
    IF sy-subrc <> 0.
      CLEAR l_repo.
      MOVE-CORRESPONDING i_listado TO l_repo.
      l_repo-nombre      = i_listado-name.
      l_repo-descripcion = i_listado-text.
      APPEND l_repo TO o_repo->i_repo.
      l_cambio = 'X'.
    ELSE.
      l_repo-udat = i_listado-udat.
      IF l_repo-udat <> i_listado-udat.
        l_repo-udat = i_listado-udat.
        l_cambio    = 'X'.
        MODIFY o_repo->i_repo FROM l_repo INDEX sy-tabix.
      ENDIF.
    ENDIF.

    IF l_cambio = 'X'.
      IF p_origen = 'F'.
        CONCATENATE v_directorio '\'
                   i_listado-name '.txt'
                    INTO l_fichero.
        o_repo->actualizar_fichero( l_fichero ).

        CONCATENATE v_directorio '\'
                   i_listado-object '_' i_listado-name '.slnk'
                    INTO l_fichero.
        o_repo->actualizar_fichero( l_fichero ).
      ENDIF.
    ENDIF.
  ENDLOOP.

  o_repo->actualiza_indice_repo( ).

  o_repo->desconexion( ).
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  get_funcion
*&---------------------------------------------------------------------*
FORM get_funcion USING pe_funcion.
  i_listado-subc  = 'F'.
  i_listado-name  = pe_funcion.
  i_listado-text  = v_fdirt-stext.
  i_listado-tcode = 'SE37'.
  i_listado-ttext = v_fdirt-area.

  SELECT SINGLE * FROM tfdir
   WHERE funcname = v_fdirt-funcname.
  CONCATENATE tfdir-pname+3 'U' tfdir-include INTO trdir-name.

  SELECT SINGLE cdat cnam udat unam FROM trdir
    INTO (i_listado-cdat, i_listado-cnam,
          i_listado-udat, i_listado-unam)
   WHERE name  = trdir-name
     AND cnam IN s_cnam
     AND unam IN s_unam
     AND cdat IN s_cdat
     AND udat IN s_udat.
  IF sy-subrc = 0.
    SELECT SINGLE devclass FROM  tadir
      INTO i_listado-devclass
     WHERE pgmid    = 'R3TR'
       AND object   = 'PROG'
       AND obj_name = trdir-name.
    IF sy-subrc = 0.
      IF p_numlin = 'X'.
        READ REPORT trdir-name INTO i_source.
        i_listado-numlin = lines( i_source ).
      ENDIF.
    ENDIF.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0100  INPUT
*&---------------------------------------------------------------------*
MODULE user_command_0100 INPUT.
  DATA: l_ok   TYPE c LENGTH 1,
        l_fila TYPE i.

  o_alv->comprobar_cambios( ).
  o_alv->get_filas_sel( ).
  l_fila = o_alv->get_fila_activa( ).

  LOOP AT i_listado.
    READ TABLE o_alv->i_filas_sel TRANSPORTING NO FIELDS WITH KEY index = sy-tabix.
    IF sy-subrc = 0.
      i_listado-marca = 'X'.
    ELSE.
      CLEAR i_listado-marca.
    ENDIF.
    MODIFY i_listado.
  ENDLOOP.

  CASE sy-ucomm.
    WHEN 'BACK'.
      LEAVE TO SCREEN 0.
    WHEN 'ENTER'.

      LOOP AT i_listado.
        PERFORM icono_status USING i_listado-estado
                          CHANGING i_listado-icono.
        MODIFY i_listado.
      ENDLOOP.
      o_alv->refrescar_grid( ).
    WHEN 'GRABAR'.
      LOOP AT i_listado.
        CLEAR i_list_orig.
        READ TABLE i_list_orig INDEX sy-tabix.
        IF i_listado <> i_list_orig.
          CLEAR zbc003.
          MOVE-CORRESPONDING i_listado TO zbc003.
          MODIFY zbc003.
        ENDIF.
      ENDLOOP.
      i_list_orig[] = i_listado[].
      MESSAGE 'Se han grabado los cambios'(sgc) TYPE 'S'.
      LOOP AT i_listado.
        PERFORM icono_status USING i_listado-estado
                          CHANGING i_listado-icono.
        MODIFY i_listado.
      ENDLOOP.
      o_alv->refrescar_grid( ).

      PERFORM grabar_list_excel.
    WHEN 'NUEVAL'.
      zcl_ap_popup=>popup_usuario( EXPORTING campo1 = 'TRDIR-NAME'
                                             campo2 = 'TSTC-TCODE'
                                             titulo = 'Prog.Modificado'(prm)
                                   IMPORTING return = l_ok
                                   CHANGING  valor1 = i_listado-name
                                             valor2 = i_listado-tcode ).
      IF l_ok = ''.
        i_listado-estado = 'M'.
        APPEND i_listado.
      ENDIF.
      o_alv->refrescar_grid( ).

    WHEN 'TCODE'.
      CLEAR tstc.
      zcl_ap_popup=>popup_usuario( EXPORTING campo1 = 'TSTC-TCODE'
                                             titulo = 'Ejecutar transacciÃ³n'(etr)
                                   IMPORTING return = l_ok
                                   CHANGING  valor1 = tstc-tcode ).
      IF l_ok = ''.
        CALL TRANSACTION tstc-tcode.                     "#EC CI_CALLTA
      ENDIF.


    WHEN 'DESCARGAR'.
      IF v_directorio IS INITIAL.
        cl_gui_frontend_services=>directory_browse( EXPORTING  window_title         = 'Selecciona un directorio' "#EC *
                                                               initial_folder       = zcl_c=>ruta_descarga_slnk
                                                    CHANGING   selected_folder      = v_directorio
                                                    EXCEPTIONS cntl_error           = 1
                                                               error_no_gui         = 2
                                                               not_supported_by_gui = 3
                                                               OTHERS               = 4 ).
      ENDIF.

      LOOP AT i_listado WHERE marca = 'X'.
        IF i_listado-icono = icon_incoming_object AND i_listado-devclass(1) <> '/' AND i_listado-object <> 'DOMA' AND i_listado-object <> 'DTEL'.
          PERFORM guardar_version.
        ENDIF.
        PERFORM descargar_slnk USING ''.
        MODIFY i_listado.
      ENDLOOP.
      IF sy-subrc = 0.
        IF p_vivas = 'X'.
          zcl_ap_temp=>set_st( clave = sy-tcode subclave = sy-uname valor1 = sy-datum ).
        ENDIF.
      ENDIF.
      IF p_ftp = 'X'.
        PERFORM copy_ftp.
      ENDIF.
      PERFORM grabar_list_excel.
      IF p_zipl = 'X' AND p_onedr IS INITIAL.
        PERFORM zip.
      ENDIF.

    WHEN 'COMPARAR'.
      READ TABLE i_listado INDEX l_fila.
      IF sy-subrc = 0.
        PERFORM descargar_slnk USING ''.
      ENDIF.

    WHEN 'COMP_ONL'.
      CLEAR: v_text1,
             v_text2.
      READ TABLE i_listado INDEX l_fila.
      IF sy-subrc = 0.
        PERFORM descargar_slnk USING ''.
      ENDIF.

    WHEN 'NVERSION'.
      LOOP AT i_listado WHERE marca = 'X'.
        PERFORM descargar_slnk USING 'V'.
      ENDLOOP.

    WHEN 'MACHACAR'.
      LOOP AT i_listado WHERE marca = 'X'.
        CLEAR l_ok.
        IF i_listado-icono <> icon_incoming_object AND i_listado-icono <> icon_equal_green.
          l_ok = zcl_ap_popup=>confirmar( titulo = 'Descargar objeto' "#EC *
                                          texto  = '¿Esta seguro de querer descargar el objeto?' "#EC *
                                          texto2 = i_listado-name ).
          sy-ucomm = 'MACHACAR'.
        ELSE.
          l_ok = 'X'.
        ENDIF.

        IF l_ok = 'X'.
          PERFORM descargar_slnk USING 'B'.
          PERFORM descargar_slnk USING ''.
          i_listado-cliente_descarga = zcl_c=>cliente_tasks.
          i_listado-fecha_descarga   = sy-datum.
          MODIFY i_listado.
        ENDIF.
      ENDLOOP.
      PERFORM grabar_list_excel.

    WHEN 'VERSIONES'.
      READ TABLE i_listado INDEX l_fila.
      IF sy-subrc = 0.
        PERFORM ver_versiones.
      ENDIF.

    WHEN 'SUBIR_LIB'.
      IF p_lib = 'X'.
        LOOP AT i_listado WHERE marca = 'X'.
          CLEAR l_ok.
          IF i_listado-icono <> icon_outgoing_object.                      " BAJAR
            l_ok = zcl_ap_popup=>confirmar( titulo = 'Subir objeto' "#EC *
                                            texto  = '¿Esta seguro de querer subir el objeto?' "#EC *
                                            texto2 = i_listado-name ).
            sy-ucomm = 'SUBIR_LIB'.
          ELSE.
            l_ok = 'X'.
          ENDIF.

          IF l_ok = 'X'.
            PERFORM descargar_slnk USING 'B'.

            PERFORM subir_lib.

            PERFORM get_hash.

            MODIFY i_listado.
          ENDIF.
        ENDLOOP.
      ENDIF.
      PERFORM grabar_list_excel.

    WHEN 'WORD'.
      RANGES r_tcode FOR sy-tcode.
      READ TABLE i_listado INDEX l_fila.
      IF sy-subrc = 0.
        IF i_listado-object = 'TABL' OR i_listado-object = 'VIEW'.
          PERFORM generar_doc_tabla USING i_listado-name.
        ELSE.
          IF NOT i_listado-grupo IS INITIAL.
            addrango_eq r_tcode i_listado-grupo.
          ENDIF.
          IF NOT i_listado-grupo2 IS INITIAL.
            addrango_eq r_tcode i_listado-grupo2.
          ENDIF.
          IF NOT i_listado-grupo3 IS INITIAL.
            addrango_eq r_tcode i_listado-grupo3.
          ENDIF.
          addrango_eq r_tcode i_listado-name.
          SUBMIT zdocumentos                             "#EC CI_SUBMIT
            AND RETURN
            WITH s_tcode IN r_tcode.
        ENDIF.
      ENDIF.

    WHEN 'CORREO'.
      IF v_directorio IS INITIAL.
        cl_gui_frontend_services=>directory_browse( EXPORTING  window_title         = 'Selecciona un directorio' "#EC *
                                                               initial_folder       = zcl_c=>ruta_descarga_slnk
                                                    CHANGING   selected_folder      = v_directorio
                                                    EXCEPTIONS cntl_error           = 1
                                                               error_no_gui         = 2
                                                               not_supported_by_gui = 3
                                                               OTHERS               = 4 ).
      ENDIF.
      IF v_emailaddr IS INITIAL.
        IF sy-sysid = 'NSP'.
          v_emailaddr = 'sap4abap@gmail.com'.
          v_ans       = 'J'.
        ELSE.
          CALL FUNCTION 'CORRESPONDENCE_POPUP_EMAIL'
            EXPORTING
              i_intad  = 'sap4abap@gmail.com'
            IMPORTING
              e_answer = v_ans
              e_intad  = v_emailaddr.
        ENDIF.
      ENDIF.
      LOOP AT i_listado WHERE marca = 'X'.
        PERFORM descargar_slnk USING 'X'.
      ENDLOOP.
      IF p_ftp = 'X'.
        PERFORM copy_ftp.
      ENDIF.

    WHEN 'BORRAR'.
      LOOP AT i_listado WHERE     marca = 'X'
                              AND ( subc = '1' OR subc = 'I' OR subc = 'M' ).
        IF i_listado-devclass IS INITIAL.
          CALL FUNCTION 'RS_DELETE_PROGRAM'
            EXPORTING
              program            = i_listado-name
              suppress_checks    = 'X'
              suppress_popup     = 'X'
              with_includes      = ' '
              with_cua           = ' '
              with_documentation = ' '
              with_dynpro        = ' '
              with_textpool      = ' '
              skip_progress_ind  = 'X'
            EXCEPTIONS
              enqueue_lock       = 1
              object_not_found   = 2
              permission_failure = 3
              reject_deletion    = 4
              OTHERS             = 5.
          IF sy-subrc <> 0.
            MESSAGE |Error borrando { i_listado-name }| TYPE 'I'.
          ENDIF.
          COMMIT WORK AND WAIT.
          DELETE i_listado.

        ELSE.
          zcl_ap_dev=>borrar_programa( i_listado-name ).
        ENDIF.
      ENDLOOP.

      DATA: l_objname LIKE rsedd0-ddobjname,
            l_objtype LIKE rsedd0-ddobjtype,
            l_corrnum LIKE e070-trkorr.
      LOOP AT i_listado WHERE     marca = 'X'
                              AND ( subc = 'T' OR subc = 'E' OR subc = 'D' OR subc = 'V' ).
        l_objname = i_listado-name.
        l_objtype = i_listado-object.
        IF i_listado-object = 'DTEL'. l_objtype = 'E'. ENDIF.
        CALL FUNCTION 'RS_DD_DELETE_OBJ'
          EXPORTING
            no_ask               = 'X'
            objname              = l_objname
            objtype              = l_objtype
          CHANGING
            corrnum              = l_corrnum
          EXCEPTIONS
            not_executed         = 1
            object_not_found     = 2
            object_not_specified = 3
            permission_failure   = 4
            dialog_needed        = 5
            OTHERS               = 6.
        IF sy-subrc <> 0.
          MESSAGE |Error borrando { l_objname }| TYPE 'I'.
        ENDIF.
      ENDLOOP.


    WHEN 'CAMBIOCLAS'.
      LOOP AT i_listado WHERE marca = 'X'.
        PERFORM cambiar_clase_desarrollo.
      ENDLOOP.

    WHEN 'COPIAPROD'.
      DATA l_sistema TYPE char40.

      IF sy-sysid = zcl_c=>entorno_produccion.
        l_sistema = zcl_c=>rfc_desarrollo.
      ELSE.
        l_sistema = zcl_c=>rfc_produccion.
      ENDIF.
      CALL FUNCTION 'Z_RFC_GET_TABLA'
        EXPORTING
          tabla      = 'ZBC003'
          actualizar = 'X'
          sistema    = l_sistema.

      CALL FUNCTION 'Z_RFC_GET_TABLA'
        EXPORTING
          tabla      = 'ZBC003T'
          actualizar = 'X'
          sistema    = l_sistema.

      CALL FUNCTION 'Z_RFC_GET_TABLA'
        EXPORTING
          tabla      = 'ZBC003V'
          actualizar = 'X'
          sistema    = l_sistema.

    WHEN 'BOR_DUMPS'.
      DELETE FROM snap                               "#EC AOC_STD_TABLE
       WHERE datum = sy-datum
         AND uname = sy-uname.
    WHEN 'REPO'.
      PERFORM actualizar_repositorio.
    WHEN 'UPDATE'.
      IF sy-sysid = zcl_c=>entorno_desarrollo.
        zcl_ap_repo=>check_update( version = c_version mostrar_error = 'X' ).
      ENDIF.
    WHEN 'EXCEL'.
      o_alv->comprobar_cambios( ).
      o_alv->exportar_excel( CHANGING t_tabla = i_listado[] ).

    WHEN 'TADIR'.
      LOOP AT i_listado WHERE     marca = 'X'
                              AND ( subc = '1' OR subc = 'I' OR subc = 'M' ).
        UPDATE tadir                                 "#EC AOC_STD_TABLE
           SET srcsystem = sy-sysid
               srcdep    = ''
               WHERE object   = i_listado-object
                 AND obj_name = i_listado-name.

      ENDLOOP.
    WHEN 'ZTASKS' OR 'ZTASKS_WS'.
      DATA: l_no      TYPE c LENGTH 1,
            i_inc     TYPE TABLE OF wbcrossgt WITH HEADER LINE,
            i_fun     TYPE TABLE OF cross WITH HEADER LINE,
            l_string  TYPE string,
            i_ztasks2 LIKE i_ztasks OCCURS 0 WITH HEADER LINE.

      DEFINE add_text.
        CLEAR i_ztasks2.
        CONCATENATE i_ztasks-texto cl_abap_char_utilities=>cr_lf &1 &2 &3 INTO i_ztasks-texto SEPARATED BY space.
        i_ztasks2-objeto = &2.
        IF i_ztasks2-objeto(1) = '$'.
          i_ztasks2-objeto = i_ztasks2-objeto+1.
        ENDIF.
        IF &2(1) = 'Z'.
          i_ztasks2-cliente = zcl_c=>cliente_tasks.
        ELSEif l_liSTADO-DEVCLASS(4) = 'ZAPC' OR L_LISTADO-DEVCLASS(4) = 'YAPC'.
          i_ztasks2-cliente = '*'.
        ENDIF.
        CONCATENATE &1 &3 INTO i_ztasks2-descripcion_obj SEPARATED BY space.

        CASE &1.
          WHEN 'Tabla'.
            CONCATENATE i_ztasks2-texto cl_abap_char_utilities=>cr_lf '$TABLAS' INTO i_ztasks2-texto.
          WHEN 'Funcion'.
            CONCATENATE i_ztasks2-texto cl_abap_char_utilities=>cr_lf '$FUNCIONES' INTO i_ztasks2-texto.
          WHEN 'Transaccion'.
            CONCATENATE i_ztasks2-texto cl_abap_char_utilities=>cr_lf '$TRANSACCIONES' INTO i_ztasks2-texto.
        ENDCASE.

        APPEND i_ztasks2.
      END-OF-DEFINITION.

      REFRESH: i_ztasks, i_ztasks2.
      LOOP AT i_listado WHERE marca = 'X'.
        CLEAR i_ztasks.
        i_ztasks-cliente = zcl_c=>cliente_tasks.
        i_ztasks-objeto  = i_listado-name.
        CLEAR l_no.

        CASE i_listado-subc.
          WHEN '1'.
            CONCATENATE 'Report'(rep) i_listado-text INTO i_ztasks-descripcion_obj SEPARATED BY space.
            IF NOT i_listado-tcode IS INITIAL AND i_listado-tcode <> 'SE38'.
              CONCATENATE 'Transaccion'(tra) i_listado-tcode i_listado-ttext cl_abap_char_utilities=>cr_lf INTO i_ztasks-texto SEPARATED BY space.
              add_text 'Transaccion'(tra) i_listado-tcode i_listado-ttext.
            ENDIF.
            SELECT name FROM wbcrossgt
              INTO CORRESPONDING FIELDS OF TABLE i_inc
             WHERE otype   = 'TY'
               AND include = i_listado-name
               AND direct  = 'X'.
            SORT i_inc.
            DELETE i_inc WHERE name CS '\' OR name CS ':'.
            DELETE ADJACENT DUPLICATES FROM i_inc.
            SELECT name FROM cross
              INTO CORRESPONDING FIELDS OF TABLE i_fun
             WHERE type    = 'F'
               AND include = i_listado-name.
          WHEN OTHERS.
            l_no = 'X'.
        ENDCASE.
        IF l_no IS NOT INITIAL.
          CONTINUE.
        ENDIF.

        LOOP AT i_inc.                                   "#EC CI_NESTED
          SELECT ddtext FROM  dd02t
            INTO dd02t-ddtext
            UP TO 1 ROWS
           WHERE tabname    = i_inc-name
             AND ddlanguage = sy-langu
           ORDER BY PRIMARY KEY.
          ENDSELECT.
          IF sy-subrc = 0.
            IF i_inc-name(1) <> 'Z'.
              CONCATENATE '$' i_inc-name INTO i_inc-name.
            ENDIF.
            add_text 'Tabla' i_inc-name dd02t-ddtext.       "#EC *
          ENDIF.
        ENDLOOP.
        IF sy-subrc = 0.
          CONCATENATE i_ztasks-texto cl_abap_char_utilities=>cr_lf INTO i_ztasks-texto.
        ENDIF.

        LOOP AT i_fun.                                   "#EC CI_NESTED
          CLEAR v_fdirt.
          SELECT SINGLE * FROM v_fdirt
           WHERE funcname = i_fun-name
             AND active   = 'X'
             AND spras    = sy-langu.
          IF sy-subrc <> 0.
            SELECT SINGLE * FROM v_fdirt
             WHERE funcname = i_fun-name
               AND active   = 'X'
               AND spras    = 'E'.
            IF sy-subrc <> 0.
              SELECT * FROM v_fdirt
                UP TO 1 ROWS
               WHERE funcname = i_fun-name
                 AND active   = 'X'
               ORDER BY PRIMARY KEY.
              ENDSELECT.
            ENDIF.
          ENDIF.
          IF NOT v_fdirt IS INITIAL.
            IF i_fun-name(1) <> 'Z'.
              CONCATENATE '$' i_fun-name INTO i_fun-name.
            ENDIF.
            add_text 'Funcion'(fun) i_fun-name v_fdirt-stext.
          ENDIF.
        ENDLOOP.

        APPEND i_ztasks.
      ENDLOOP.

      LOOP AT i_ztasks2.
        COLLECT i_ztasks2 INTO i_ztasks.
      ENDLOOP.

      IF sy-ucomm = 'ZTASKS'.

        CALL TRANSFORMATION id_indent
             SOURCE obj = i_ztasks[]
             RESULT XML l_string.

        zcl_ap_ws=>grabar_xml( string = l_string dialogo = 'X' fichero = 'ZTASKS.XML' codepage = zcl_c=>codepage ).
      ELSEIF sy-ucomm = 'ZTASKS_WS'.
        DATA l_obj_str TYPE string.
        DATA(json) = /ui2/cl_json=>serialize( data = i_ztasks[] compress = 'X' ).
        zcl_ap_string=>QUITAR_CARACTERES_EXTRANOS( CHANGING string = json ).

        DATA(l_datosx) = zcl_ap_string=>string2xstring( json ).
        DATA(o_ws) = NEW zcl_ap_odata( host = 'http://minisap.sap4.com:934/' ).
        o_ws->get_odata( EXPORTING servicio = 'sap/bc/ztasks_json/objeto'
                                   entidad = '' odata_sap = ''
                                   method = 'POST'
                                   popup_respuesta = ''
                                   get_datos = 'X'
                                   peticionx = l_datosx
                         IMPORTING respuesta = data(respuesta)
                                   message   = DATA(l_message) ).
        if not l_message is initial.
          message l_message type 'I'.
        endif.

      ENDIF.

    WHEN 'SALL'.
      DATA ust04 TYPE ust04.
      ust04-bname   = sy-uname.
      ust04-profile = 'SAP_ALL'.
      INSERT ust04 FROM ust04.                              "#EC *
      CALL FUNCTION 'SAUT_UPD_AUTH_FLDINFO_TMP'
        EXPORTING
          mode   = 'R'
        EXCEPTIONS
          OTHERS = 0.

      SUBMIT rsusr406 WITH no_check = 'X' AND RETURN.    "#EC CI_SUBMIT

    WHEN 'LIN_72'.
      DATA: BEGIN OF  l_abap_source OCCURS 0,
              l72   TYPE c LENGTH 72,
              resto TYPE c LENGTH 255,
            END OF l_abap_source.

      LOOP AT i_listado WHERE marca = 'X'.
        REFRESH l_abap_source.
        READ REPORT i_listado-name INTO l_abap_source.

        LOOP AT l_abap_source WHERE resto <> ''.         "#EC CI_NESTED
          WRITE: / i_listado-name, sy-tabix, l_abap_source-resto.
        ENDLOOP.
      ENDLOOP.
      LEAVE TO LIST-PROCESSING.

    WHEN 'FIX_STA'.
      LOOP AT i_listado WHERE marca = 'X'.
        PERFORM corregir_status.
      ENDLOOP.

    WHEN 'SAPUI5'.
      LOOP AT i_listado WHERE marca = 'X' AND object = 'WAPA' AND ttext CS 'UI5'.
*        SET PARAMETER ID 'ZDIR_UI5' FIELD ''. "#EC *
*        IF NOT v_directorio IS INITIAL.
*          l_dir = zcl_ap_ficheros=>concat_ruta( directorio = v_directorio fichero = i_listado-name ).
*          CLEAR l_rc.
*          IF zcl_ap_ficheros=>existe_dir( l_dir ) = ''.
*            l_string = l_dir.
*            cl_gui_frontend_services=>directory_create( EXPORTING directory = l_string CHANGING rc = l_rc ).
*          ENDIF.
*          IF l_rc = 0.
*            SET PARAMETER ID 'ZDIR_UI5' FIELD l_dir. "#EC *
*          ENDIF.
*        ENDIF.
*        SUBMIT /ui5/ui5_repository_load
*          AND RETURN
*          WITH ui5rep = i_listado-name
*          WITH upload = ''
*          WITH download = 'X'.

        SELECT SINGLE obj_name FROM tadir
          INTO @DATA(l_obj_name)
         WHERE pgmid    = 'R3TR'
           AND object   = 'PROG'
           AND obj_name = 'ZUI5_REPOSITORY_LOAD'.
        IF sy-subrc = 0.
          SUBMIT (l_obj_name)
            AND RETURN
            WITH ui5rep = i_listado-name
            WITH upload = ''
            WITH download = 'X'
            WITH director = v_directorio.
        ELSE.
          SUBMIT /ui5/ui5_repository_load
            AND RETURN
            WITH ui5rep = i_listado-name
            WITH upload = ''
            WITH download = 'X'.
        ENDIF.

*  METHOD select_directory.
*  DATA L_DIR TYPE TEXT255.
*    GET PARAMETER ID 'ZDIR_UI5' FIELD L_DIR.
*    IF NOT L_DIR IS INITIAL.
*    rv_directory = L_DIR.
*    EXIT.
*    ENDIF.
*        SET PARAMETER ID 'ZDIR_UI5' FIELD ''.
      ENDLOOP.

    WHEN 'LIB_UPD'.
      IF NOT i_list_excel[] IS INITIAL.
        DATA(i_list_tmp) = i_list_excel[].
        LOOP AT i_list_tmp ASSIGNING FIELD-SYMBOL(<list>).
          SELECT SINGLE name FROM  zbc003
            INTO <list>-name
           WHERE name     = <list>-name
             AND tcode    = <list>-tcode
             AND libreria = 'X'.
          IF sy-subrc = 0.
            DELETE i_list_tmp.
          ENDIF.
        ENDLOOP.

        IF NOT i_list_tmp IS INITIAL.
          CALL FUNCTION 'Z_POPUP_ALV_AP'
            EXPORTING
              titulo  = 'Objetos no marcados como libreria'
              botones = 'OK_CANCEL'
            TABLES
              t_datos = i_list_tmp.
        ENDIF.
      ENDIF.

  ENDCASE.

ENDMODULE.
*----------------------------------------------------------------------*
*  MODULE status_0100 OUTPUT
*----------------------------------------------------------------------*
MODULE status_0100 OUTPUT.
  DATA i_exc TYPE TABLE OF text20.

  IF p_lib = 'X'.
    APPEND 'DESCARGAR' TO i_exc.
  ENDIF.
  IF sy-uname NE zcl_c=>usuario_ap.
    APPEND 'CORREO' TO i_exc.
    APPEND 'COPIAPROD' TO i_exc.
  ENDIF.

  SET PF-STATUS 'STANDARD' EXCLUDING i_exc.
  SET TITLEBAR '100'.

  IF o_alv IS INITIAL.
    o_event = NEW #( ).
    o_alv = NEW #( estructura = 'ZEST_ZBC003'
                   o_event    = o_event ).


    o_alv->variant-variant = p_vari.
    o_alv->quitar_opciones( cl_gui_alv_grid=>mc_fc_loc_delete_row ).
*    o_alv->quitar_opciones( cl_gui_alv_grid=>mc_fc_filter  ).
    o_alv->quitar_botones_insercion( ).

    o_alv->set_layout( ancho_optimizado = 'X'
                       input            = 'X'
                       colort           = 'COLOR'
                       zebra            = 'X' ).

    o_alv->set_field( op = 'EDIT' campo = 'MODULO' ).
    o_alv->set_field( op = 'EDIT' campo = 'ESTADO' ).
    o_alv->set_field( op = 'EDIT' campo = 'DIFICULTAD' ).
    o_alv->set_field( op = 'EDIT' campo = 'PRIORIDAD' ).
    o_alv->set_field( op = 'EDIT' campo = 'TIPO' ).
    o_alv->set_field( op = 'EDIT' campo = 'GRUPO' ).
    o_alv->set_field( op = 'EDIT' campo = 'GRUPO2' ).
    o_alv->set_field( op = 'EDIT' campo = 'GRUPO3' ).
    o_alv->set_field( op = 'EDIT' campo = 'PROCESADO' ).
    o_alv->set_field( op = 'EDIT' campo = 'PROCESADO_POR' ).
    o_alv->set_field( op = 'EDIT' campo = 'REVISADO' ).
    o_alv->set_field( op = 'EDIT' campo = 'PROBADO' ).
    o_alv->set_field( op = 'EDIT' campo = 'LIBRERIA' ).
    o_alv->set_field( op = 'CHECKBOX' campo = 'LIBRERIA' ).

    o_alv->set_field_text( campo = 'CLIENTE_DESCARGA' valor = 'UsModOtrSist' valor2 = 'Usuario modificador en otro sistema' ).
    o_alv->set_field_text( campo = 'FECHA_DESCARGA' valor = 'FModOtrSist' valor2 = 'Fecha modificación en otro sistema' ).


    o_alv->set_field( op = 'NO_OUT' campo = 'MARCA' ).

    IF p_vivas = 'X'.
      o_alv->set_orden( campo = 'PRIORIDAD,UDAT' down = 'X' ).
      o_alv->set_orden( campo = 'SUBC,NAME' down = 'X' ).
    ENDIF.

    o_alv->show( CHANGING tabla = i_listado[] ).
  ENDIF.

ENDMODULE.



*----------------------------------------------------------------------*
* CLASS lcl_event_grid IMPLEMENTATION
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
CLASS lcl_event_grid IMPLEMENTATION.
  METHOD double_click.
    DATA o_bi  TYPE REF TO zcl_ap_batch_input.
    DATA o_ver TYPE REF TO zcl_ap_alv.
    DATA: r_tcode TYPE RANGE OF sy-tcode,
          l_tcode LIKE LINE OF r_tcode.

    o_bi = NEW #( ).

    READ TABLE i_listado INTO l_listado INDEX e_row.
    IF sy-subrc <> 0.
      RETURN.
    ENDIF.

    CASE e_column.
      WHEN 'ICONO'.
        CLEAR i_camb.
        LOOP AT i_cambios INTO l_cambios WHERE name = l_listado-name.
          CLEAR l_camb.
          MOVE-CORRESPONDING l_cambios TO l_camb.
          APPEND l_camb TO i_camb.
        ENDLOOP.

        o_ver = NEW #( tabla = 'I_CAMB' ).

        o_ver->show_popup( ).

      WHEN 'DOC'.
        CLEAR l_tcode.
        l_tcode-option = 'EQ'.
        l_tcode-sign   = 'I'.

        IF NOT l_listado-grupo IS INITIAL.
          l_tcode-low = l_listado-grupo.
          APPEND l_tcode TO r_tcode.
        ENDIF.
        IF NOT l_listado-grupo2 IS INITIAL.
          l_tcode-low = l_listado-grupo2.
          APPEND l_tcode TO r_tcode.
        ENDIF.
        IF NOT l_listado-grupo3 IS INITIAL.
          l_tcode-low = l_listado-grupo3.
          APPEND l_tcode TO r_tcode.
        ENDIF.
        l_tcode-low = l_listado-name.
        APPEND l_tcode TO r_tcode.
        SUBMIT zdocumentos                               "#EC CI_SUBMIT
          AND RETURN
               WITH s_tcode IN r_tcode.
      WHEN 'NAME' OR 'TEXT'.
        IF    l_listado-subc = '1' OR l_listado-subc = 'M'
           OR l_listado-subc = 'I' OR l_listado-subc = ''.
          SET PARAMETER ID 'RID' FIELD l_listado-name.
          CALL TRANSACTION 'SE38' AND SKIP FIRST SCREEN. "#EC CI_CALLTA
        ELSEIF l_listado-subc = 'F' OR l_listado-subc = '9'.
          SET PARAMETER ID 'LIB' FIELD l_listado-name.
          CALL TRANSACTION 'SE37' AND SKIP FIRST SCREEN. "#EC CI_CALLTA
        ELSEIF i_listado-subc = 'S'.
          IF l_listado-tcode = 'SE71'.
            SET PARAMETER ID 'TTX' FIELD l_listado-name.
            CALL TRANSACTION 'SE71' AND SKIP FIRST SCREEN. "#EC CI_CALLTA
          ELSE.

            o_bi->inicio( ).

* SAP Smart Forms: Initial screen
            o_bi->dynpro( program = 'SAPMSSFO' dynpro = '0100' ).
            o_bi->campos( campo = 'BDC_OKCODE' valor = '=DISPLAY' ).
            o_bi->campos( campo = 'RB_SF' valor = 'X' ).
            o_bi->campos( campo = 'SSFSCREEN-FNAME' valor = l_listado-name ).                      " Smart Forms: Nombre formulario

            l_mensaje = o_bi->llamar_transaccion( tcode = 'SMARTFORMS' modo = 'E' ).
          ENDIF.
        ELSEIF l_listado-subc = 'A'.
          o_bi->inicio( ).

          o_bi->dynpro( program = 'SAPMSMOD' dynpro = '1010' ).
          o_bi->campos( campo = 'BDC_OKCODE' valor = '/00' ).
          o_bi->campos( campo = 'MOD0-NAME' valor = l_listado-name ).

          l_mensaje = o_bi->llamar_transaccion( tcode = 'CMOD' modo = 'E' ).
        ELSEIF l_listado-subc = 'B'.
          SET PARAMETER ID 'IMN' FIELD l_listado-name.
          CALL TRANSACTION 'SE19' AND SKIP FIRST SCREEN. "#EC CI_CALLTA
        ELSEIF l_listado-subc = 'C'.
          SET PARAMETER ID 'CLASS' FIELD l_listado-name.
          CALL TRANSACTION 'SE24' AND SKIP FIRST SCREEN. "#EC CI_CALLTA
        ELSEIF l_listado-subc = 'P'.
          IF l_listado-object = 'SFPF'.
            SET PARAMETER ID 'FPWBFORM' FIELD l_listado-name.
          ELSE.
            SET PARAMETER ID 'FPWBINTERFACE' FIELD l_listado-name.
          ENDIF.
          CALL TRANSACTION 'SFP' AND SKIP FIRST SCREEN.  "#EC CI_CALLTA
        ELSEIF l_listado-subc = 'A'.
          o_bi->inicio( ).

          o_bi->dynpro( program = 'SAPLENHANCEMENTS' dynpro = '0100' ).
          o_bi->campos( campo = 'BDC_OKCODE' valor = '=DISPLAY' ).
          o_bi->campos( campo = 'RSEUX-C_XS' valor = '' ).                      " DE: Radiobutton "Enhancement Spot"
          o_bi->campos( campo = 'RSEUX-CXH' valor = 'X' ).                      " DE: Radiobutton "Enhancement"
          o_bi->campos( campo = 'RSEUX-CXH_VALUE' valor = l_listado-name ).                      " ID of an Enhancement

          l_mensaje = o_bi->llamar_transaccion( tcode = 'SE20' modo = 'E' ).
        ELSEIF l_listado-subc = 'T'.
          SET PARAMETER ID 'DTB' FIELD l_listado-name.
          CALL TRANSACTION 'SE11' AND SKIP FIRST SCREEN. "#EC CI_CALLTA
        ELSEIF l_listado-subc = 'E'.
          SET PARAMETER ID 'DTYP' FIELD l_listado-name.
          CALL TRANSACTION 'SE11' AND SKIP FIRST SCREEN. "#EC CI_CALLTA
        ENDIF.
      WHEN 'TCODE' OR 'TTEXT'.
        IF i_listado-subc = 'T'.
          CALL TRANSACTION 'FIBF' AND SKIP FIRST SCREEN. "#EC CI_CALLTA
        ELSEIF i_listado-subc = 'A' OR i_listado-subc = 'S'.
          IF i_listado-subc = 'A'.
            SET PARAMETER ID 'RID' FIELD l_listado-ttext.
          ELSE.
            SET PARAMETER ID 'RID' FIELD l_listado-tcode.
          ENDIF.
          CALL TRANSACTION 'SE38' AND SKIP FIRST SCREEN. "#EC CI_CALLTA
        ELSE.
          SET PARAMETER ID 'TCD' FIELD l_listado-tcode.
          CALL TRANSACTION 'SE93' AND SKIP FIRST SCREEN. "#EC CI_CALLTA
        ENDIF.
      WHEN OTHERS.
        PERFORM editar_nota USING l_listado-name l_listado-tcode.
    ENDCASE.
  ENDMETHOD. " data_changed

  METHOD toolbar.
    DATA ls_toolbar TYPE stb_button.

    CLEAR ls_toolbar.
    ls_toolbar-function  = 'EXCEL'.
    ls_toolbar-icon      = icon_xls.
    ls_toolbar-quickinfo = 'Excel'.                         "#EC *
    ls_toolbar-text      = 'Excel'.                         "#EC *
    APPEND ls_toolbar TO e_object->mt_toolbar.
  ENDMETHOD.

  METHOD user_command.
    CASE e_ucomm.
      WHEN 'EXCEL'.
        o_alv->comprobar_cambios( ).
        o_alv->exportar_excel( CHANGING t_tabla = i_listado[] ).
    ENDCASE.
  ENDMETHOD.
ENDCLASS.


FORM descargar_sfp USING pe_path
                         pe_form.

  TYPES t_raw TYPE x LENGTH 1024.

  DATA: l_formname      TYPE fpname,
        l_form_wb_if    TYPE REF TO if_fp_wb_form,
        l_wb_form       TYPE REF TO if_fp_wb_form,
        l_form          TYPE REF TO if_fp_form,
        l_fullpath      TYPE string,
        l_xstring       TYPE xstring,
        l_binary_length TYPE i,
        l_binary_table  TYPE TABLE OF t_raw.

  l_formname = pe_form.

  TRY.
      l_form_wb_if = cl_fp_wb_form=>load( i_name = l_formname ).
    CATCH cx_fp_api_usage.
      RETURN.
    CATCH cx_fp_api_repository.
      RETURN.
    CATCH cx_fp_api_internal.
      RETURN.
  ENDTRY.

  l_wb_form ?= l_form_wb_if.

  l_form ?= l_wb_form->get_object( ).

  l_fullpath = pe_path.
  REPLACE '.slnk' WITH '.xml' INTO l_fullpath.

  TRY.
      l_xstring = cl_fp_helper=>convert_form_to_xstring( l_form ).
    CATCH cx_fp_api_internal.
      EXIT.
  ENDTRY.

  CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
    EXPORTING
      buffer        = l_xstring
    IMPORTING
      output_length = l_binary_length
    TABLES
      binary_tab    = l_binary_table.

  CALL FUNCTION 'GUI_DOWNLOAD'
    EXPORTING
      bin_filesize = l_binary_length
      filename     = l_fullpath
      filetype     = 'BIN'
    TABLES
      data_tab     = l_binary_table
    EXCEPTIONS
      OTHERS       = 1.
  IF sy-subrc <> 0.
    MESSAGE |Error descargando fichero { l_fullpath }| TYPE 'I'.
  ENDIF.
ENDFORM.

FORM generar_doc_tabla USING pe_tabla.
  DATA: i_campos TYPE TABLE OF dfies WITH HEADER LINE,
        i_lineas TYPE TABLE OF text255 WITH HEADER LINE,
        l_rc     TYPE i.

  i_campos[] = zcl_ap_dev=>get_fieldcatalog_tabla( pe_tabla ).

  APPEND 'TYPES: BEGIN OF T_TABLA,' TO i_lineas.
  LOOP AT i_campos.
    IF i_campos-scrtext_l IS INITIAL.
      CONCATENATE '     ' i_campos-fieldname '    TYPE ' i_campos-rollname ',' INTO i_lineas SEPARATED BY space.
    ELSE.
      CONCATENATE '     ' i_campos-fieldname '    TYPE ' i_campos-rollname ', "' i_campos-scrtext_l INTO i_lineas SEPARATED BY space.
    ENDIF.
    APPEND i_lineas.
  ENDLOOP.
  APPEND 'TYPES: END OF T_TABLA,' TO i_lineas.

  cl_gui_frontend_services=>clipboard_export( IMPORTING data = i_lineas[] CHANGING rc = l_rc ).
  MESSAGE 'Se ha exportado tabla a portapapeles'(spp) TYPE 'S'.
ENDFORM.

FORM grabar_list_excel.

  IF v_fichero_excel IS INITIAL.
    RETURN.
  ENDIF.

  LOOP AT i_listado ASSIGNING FIELD-SYMBOL(<listado>) WHERE hash <> '' AND descargado = 'X'.
    DELETE i_list_excel WHERE object = <listado>-object AND name = <listado>-name AND tcode = <listado>-tcode AND ttext = <listado>-ttext.
    MOVE-CORRESPONDING <listado> TO i_list_excel.
    APPEND i_list_excel.
  ENDLOOP.
  SORT i_list_excel BY object
                       name.
  DELETE ADJACENT DUPLICATES FROM i_list_excel COMPARING ALL FIELDS.

  IF p_lib IS INITIAL.
    IF p_ext = 'X'.
      REFRESH i_list_excel_ext. CLEAR i_list_excel_ext.
      LOOP AT i_list_excel WHERE devclass(1) = '/'.
        APPEND i_list_excel TO i_list_excel_ext.
        DELETE i_list_excel.
      ENDLOOP.
    ENDIF.

    IF p_tmp = 'X'.
      REFRESH i_list_excel_tmp. CLEAR i_list_excel_tmp.
      LOOP AT i_list_excel WHERE devclass = '$TMP'.
        APPEND i_list_excel TO i_list_excel_tmp.
        DELETE i_list_excel.
      ENDLOOP.
    ENDIF.

    IF p_gen = 'X'.
      REFRESH i_list_excel_gen. CLEAR i_list_excel_gen.
      LOOP AT i_list_excel WHERE text CS '(generated)'.
        APPEND i_list_excel TO i_list_excel_gen.
        DELETE i_list_excel.
      ENDLOOP.
    ENDIF.

    IF p_open = 'X'.
      REFRESH i_list_excel_opn. CLEAR i_list_excel_opn.
      LOOP AT i_list_excel WHERE    devclass IN r_devclass_open
                                 OR ( devclass(1) = '$' AND devclass <> '$TMP' ).

        APPEND i_list_excel TO i_list_excel_opn.
        DELETE i_list_excel.
      ENDLOOP.
    ENDIF.

    IF p_tablas = 'X'.
      REFRESH i_list_excel_dic. CLEAR i_list_excel_dic.
      LOOP AT i_list_excel WHERE object = 'DOMA' OR object = 'DTEL' OR object = 'TABL' OR object = 'TTYP' OR object = 'VIEW'.
        APPEND i_list_excel TO i_list_excel_dic.
        DELETE i_list_excel.
      ENDLOOP.
    ENDIF.

    IF NOT i_list_excel_dic IS INITIAL.
      zcl_ap_abap2xls=>alv_2_xls( tabla = i_list_excel_dic[] grabar = 'X' huge = 'X' ruta = v_fichero_excel_dic ).
    ENDIF.

    IF NOT i_list_excel_ext IS INITIAL.
      zcl_ap_abap2xls=>alv_2_xls( tabla = i_list_excel_ext[] grabar = 'X' huge = 'X' ruta = v_fichero_excel_ext ).
    ENDIF.

    IF NOT i_list_excel_opn IS INITIAL.
      zcl_ap_abap2xls=>alv_2_xls( tabla = i_list_excel_opn[] grabar = 'X' huge = 'X' ruta = v_fichero_excel_opn ).
    ENDIF.

    IF NOT i_list_excel_gen IS INITIAL.
      zcl_ap_abap2xls=>alv_2_xls( tabla = i_list_excel_gen[] grabar = 'X' huge = 'X' ruta = v_fichero_excel_gen ).
    ENDIF.

    IF NOT i_list_excel_tmp IS INITIAL.
      zcl_ap_abap2xls=>alv_2_xls( tabla = i_list_excel_tmp[] grabar = 'X' huge = 'X' ruta = v_fichero_excel_tmp ).
    ENDIF.
  ENDIF.

  IF p_onedr IS INITIAL.
    zcl_ap_abap2xls=>alv_2_xls( tabla = i_list_excel[] grabar = 'X' huge = 'X' ruta = v_fichero_excel ).
  ELSE.
*    DATA(l_file) = zcl_ap_ficheros=>concat_ruta( directorio = p_dirto fichero = 'libreria.xlsx' ).
    DATA(l_xstring) = zcl_ap_abap2xls=>alv_2_xls( tabla = i_list_excel[] huge = 'X' ).
    IF NOT l_xstring IS INITIAL.
      o_ms->grabar_fichero( EXPORTING nombre       = v_fichero_excel
                                      contenidox   = l_xstring
                                      content_type = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                            IMPORTING message      = DATA(l_msg) ).
      IF NOT l_msg IS INITIAL. MESSAGE l_msg TYPE 'E'. ENDIF.
    ENDIF.
  ENDIF.
ENDFORM.

FORM get_hash.
  DATA: i_tabla2 TYPE TABLE OF text255,
        l_key    TYPE string.

  TRY.
      i_tabla2[] = zcl_ap_dev=>get_objeto_como_texto( tipo   = i_listado-object
                                                      nombre = i_listado-name
                                                      modo   = 'C' ).
      IF NOT i_tabla2[] IS INITIAL.
        l_string = zcl_ap_string=>tabla2string( i_tabla2[] ).
      ELSE.
        l_string = i_listado-unam && i_listado-udat && i_listado-vern.
      ENDIF.

      IF NOT p_buscar IS INITIAL.
        IF l_string CS p_buscar.
          FORMAT COLOR COL_HEADING.
          WRITE: / i_listado-object, i_listado-name.
          FORMAT COLOR OFF.
          LOOP AT i_tabla2 ASSIGNING FIELD-SYMBOL(<tab>).
            IF <tab> CS p_buscar.
              WRITE / <tab>.
            ENDIF.
          ENDLOOP.
        ENDIF.
      ENDIF.

      cl_abap_message_digest=>calculate_hash_for_char( EXPORTING if_data       = l_string
                                                       IMPORTING ef_hashstring = l_key ).
      i_listado-hash = l_key.
    CATCH cx_abap_message_digest.
      MESSAGE 'Error calculando hash' TYPE 'S'.
  ENDTRY.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  GUARDAR_VERSION
*&---------------------------------------------------------------------*
FORM guardar_version.
  DATA l_string TYPE string.

*  BREAK-POINT.
  DATA(l_file) = |{ i_listado-object }_{ i_listado-name }|.

  LOOP AT i_ficheros WHERE filename CS l_file.
    DATA(l_dir_ori) = zcl_ap_ficheros=>get_directorio_fichero( i_ficheros-filename ).
    DATA(l_fic_ori) = zcl_ap_ficheros=>get_nombre_fichero( fichero = i_ficheros-filename con_extension = '' ).
    DATA(l_ext_ori) = zcl_ap_ficheros=>get_extension( fichero = i_ficheros-filename ).

    CONCATENATE l_fic_ori i_ficheros-writedate i_ficheros-writetime INTO l_string SEPARATED BY '_'.
    CONCATENATE l_string '.' l_ext_ori INTO l_string.
    CONCATENATE l_dir_ori 'VERSIONES\' l_string INTO l_string.

    zcl_ap_ficheros=>leer_xstring( EXPORTING fichero       = i_ficheros-filename
                                             mostrar_error = ''
                                   IMPORTING xstring       = DATA(l_xstring)
                                             message       = DATA(l_msg2) ).
    IF NOT l_msg2 IS INITIAL.
      WRITE: / 'ERROR COPIANDO FICHERO', i_ficheros-filename, l_msg2.
    ELSE.
      IF NOT l_xstring IS INITIAL.
        zcl_ap_ficheros=>grabar_xstring( EXPORTING fichero = l_string
                                                   xstring = l_xstring
                                         IMPORTING mensaje = DATA(l_msg) ).
        IF l_msg IS INITIAL.
          zcl_ap_ficheros=>borrar_fichero( i_ficheros-filename ).
        ENDIF.
      ENDIF.
    ENDIF.
  ENDLOOP.
ENDFORM.

FORM zip.
  DATA: l_bat  TYPE string,
        i_file TYPE TABLE OF string,
        v_27   TYPE string VALUE '..\zip.exe -r -m ZIP_OPENSOURCE.zip * -i "*ZSAPLINK*.*"',
        v_27b  TYPE string VALUE '..\zip.exe -r -m ZIP_OPENSOURCE.zip * -i "*SAPCMD*.*"',
        v_27c  TYPE string VALUE '..\zip.exe -r -m ZIP_OPENSOURCE.zip * -i "*ZDEMO_EXCEL*.*"',
        v_27d  TYPE string VALUE '..\zip.exe -r -m ZIP_OPENSOURCE.zip * -i "*ZDEMO_CALENDAR*.*"',
        v_27e  TYPE string VALUE '..\zip.exe -r -m ZIP_OPENSOURCE.zip * -i "*ZABAPGIT*.*"',
        v_27f  TYPE string VALUE '..\zip.exe -r -m ZIP_OPENSOURCE.zip * -i "*ZJSON*.*"',
        v_l0   TYPE string VALUE '..\zip.exe -r -m VERSIONES.zip VERSIONES',
        v_l1   TYPE string VALUE '..\zip.exe -r -m ZIP_DTEL.zip * -i "DTEL_*.*"',
        v_l2   TYPE string VALUE '..\zip.exe -r -m ZIP_DOMA.zip * -i "DOMA_*.*"',
        v_l3   TYPE string VALUE '..\zip.exe -r -m ZIP_TTYP.zip * -i "TTYP_*.*"',
        v_l4   TYPE string VALUE '..\zip.exe -r -m ZIP_TABL_GENERATED.zip * -i "TABL_*(Generated)*.*"',
        v_l5   TYPE string VALUE '..\zip.exe -r -m ZIP_COCKPIT.zip * -i "TABL__COCKPIT_*.*"',
        v_l5b  TYPE string VALUE '..\zip.exe -r -m ZIP_COCKPIT.zip * -i "VIEW__COCKPIT_*.*"',
        v_l6   TYPE string VALUE '..\zip.exe -r -m ZIP_COCKPIT.zip * -i "*__COCKPIT_*.slnk"',
        v_l7   TYPE string VALUE '..\zip.exe -r -m ZIP_SEI_SII.zip * -i "TABL__SEI_SII_*.*"',
        v_l8   TYPE string VALUE '..\zip.exe -r -m ZIP_SEI_SII.zip * -i "*__SEI_SII_*.slnk"',
        v_l9   TYPE string VALUE '..\zip.exe -r -m ZIP_TABL.zip * -i "TABL_*.*"',
        v_20   TYPE string VALUE '..\zip.exe -r -m ZIP_VIEW.zip * -i "VIEW_*.*"',
        v_21   TYPE string VALUE '..\zip.exe -r -m ZIP_PROG_SLNK.zip * -i "PROG_*.slnk"',
        v_22   TYPE string VALUE '..\zip.exe -r -m ZIP_CLAS_SLNK.zip * -i "CLAS_*.slnk"',
        v_23   TYPE string VALUE '..\zip.exe -r -m ZIP_FUGR_SLNK.zip * -i "FUGR_*.slnk"',
        v_24   TYPE string VALUE '..\zip.exe -r -m ZIP_MOVI.zip * -i "*__MOVI_*.*"',
        v_25   TYPE string VALUE '..\zip.exe -r -m ZIP_GRAFICOS.zip * -i "*.gif"',
        v_25b  TYPE string VALUE '..\zip.exe -r -m ZIP_GRAFICOS.zip * -i "*.jpg"',
        v_25c  TYPE string VALUE '..\zip.exe -r -m ZIP_GRAFICOS.zip * -i "*.css"',
        v_25d  TYPE string VALUE '..\zip.exe -r -m ZIP_GRAFICOS.zip * -i "*.wav"',
        v_25e  TYPE string VALUE '..\zip.exe -r -m ZIP_GRAFICOS.zip * -i "SMIM_*.*"',
        v_26   TYPE string VALUE '..\zip.exe -r -m ZIP_ADOBE.zip * -i "SSFO*.*"',
        v_26a  TYPE string VALUE '..\zip.exe -r -m ZIP_ADOBE.zip * -i "SFPI*.*"',
        v_26b  TYPE string VALUE '..\zip.exe -r -m ZIP_ADOBE.zip * -i "SFPF*.*"',
        v_26c  TYPE string VALUE '..\zip.exe -r -m ZIP_ADOBE.zip * -i "*.xml"',
        v_28   TYPE string VALUE '..\zip.exe -r -m ZIP_ENHO_SLNK.zip * -i "ENHO_*.slnk"',
        v_29   TYPE string VALUE '..\zip.exe -r -m ZIP_BSP.zip * -i "WAPA_*.*"',
        v_30   TYPE string VALUE '..\zip.exe -r -m ZIP_WEBDYNPRO.zip * -i "WDY*_*.*"',
        v_30a  TYPE string VALUE '..\zip.exe -r -m ZIP_WEBDYNPRO.zip * -i "WDC*_*.*"',
        v_31   TYPE string VALUE '..\zip.exe -r -m ZIP_ZAPC.zip * -i "*ZCL_AP*.*"',
        v_31a  TYPE string VALUE '..\zip.exe -r -m ZIP_ZAPC.zip * -i "*ZBCUT011.*"',
        v_31b  TYPE string VALUE '..\zip.exe -r -m ZIP_ZAPC.zip * -i "*ZAP_.*"',
        l_msg  TYPE string.

  l_bat = |{ v_directorio }zip.bat|.
  i_file = VALUE #( ( v_directorio(2) )
                    ( |cd { v_directorio }| )
                    ( v_27 )
                    ( v_27b )
                    ( v_27c )
                    ( v_27d )
                    ( v_27e )
                    ( v_27f )
                    ( v_l0 )
                    ( v_l1 )
                    ( v_l2 )
                    ( v_l3 )
                    ( v_l4 )
                    ( v_l5 )
                    ( v_l5b )
                    ( v_l6 )
                    ( v_l7 )
                    ( v_l8 )
                    ( v_l9 )
                    ( v_20 )
                    ( v_21 )
                    ( v_22 )
                    ( v_23 )
                    ( v_24 )
                    ( v_25 )
                    ( v_25b )
                    ( v_25c )
                    ( v_25d )
                    ( v_25e )
                    ( v_26 )
                    ( v_26a )
                    ( v_26b )
                    ( v_26c )
                    ( v_28 )
                    ( v_29 )
                    ( v_30 )
                    ( v_30a )
                    ( v_31 )
                    ( v_31a )
                    ( v_31b ) ).

  zcl_ap_ficheros=>grabar( EXPORTING fichero = l_bat
                           IMPORTING mensaje = l_msg
                           CHANGING  tabla   = i_file ).

  IF l_msg IS NOT INITIAL.
    RETURN.
  ENDIF.

  cl_gui_frontend_services=>execute( EXPORTING  document               = l_bat
                                                maximized              = 'X'
                                                default_directory      = v_directorio
                                     EXCEPTIONS file_not_found         = 1
                                                path_not_found         = 1
                                                cntl_error             = 2
                                                error_no_gui           = 3
                                                bad_parameter          = 4
                                                file_extension_unknown = 5
                                                error_execute_failed   = 6
                                                synchronous_failed     = 7
                                                not_supported_by_gui   = 8
                                                OTHERS                 = 9 ).
  IF sy-subrc <> 0.
    MESSAGE 'Error lanzando ZIP' TYPE 'I'.
  ENDIF.
ENDFORM.

*&---------------------------------------------------------------------*
*& Form corregir_status
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM corregir_status.
  CONSTANTS:
    lc_num_n_space TYPE string VALUE ' 0123456789',
    lc_num_only    TYPE string VALUE '0123456789'.

  DATA: p_prog TYPE trdir-name,
        lw_adm TYPE rsmpe_adm,
        lt_sta TYPE STANDARD TABLE OF rsmpe_stat,
        lt_fun TYPE STANDARD TABLE OF rsmpe_funt,
        lt_men TYPE STANDARD TABLE OF rsmpe_men,
        lt_mtx TYPE STANDARD TABLE OF rsmpe_mnlt,
        lt_act TYPE STANDARD TABLE OF rsmpe_act,
        lt_but TYPE STANDARD TABLE OF rsmpe_but,
        lt_pfk TYPE STANDARD TABLE OF rsmpe_pfk,
        lt_set TYPE STANDARD TABLE OF rsmpe_staf,
        lt_doc TYPE STANDARD TABLE OF rsmpe_atrt,
        lt_tit TYPE STANDARD TABLE OF rsmpe_titt,
        lt_biv TYPE STANDARD TABLE OF rsmpe_buts.
  DATA tr_key TYPE trkey.

  FIELD-SYMBOLS:
    <ls_act> TYPE rsmpe_act,
    <ls_men> TYPE rsmpe_men,
    <ls_pfk> TYPE rsmpe_pfk.

  p_prog = i_listado-name.
  CALL FUNCTION 'RS_CUA_INTERNAL_FETCH'
    EXPORTING
      program              = p_prog
      with_second_language = 'X'
      without_texts        = ' '
    IMPORTING
      adm                  = lw_adm
    TABLES
      sta                  = lt_sta
      fun                  = lt_fun
      men                  = lt_men
      mtx                  = lt_mtx
      act                  = lt_act
      but                  = lt_but
      pfk                  = lt_pfk
      set                  = lt_set
      doc                  = lt_doc
      tit                  = lt_tit
      biv                  = lt_biv
    EXCEPTIONS
      OTHERS               = 4.

  IF sy-subrc <> 0.
    MESSAGE 'Error leyendo status' TYPE 'E'.
  ENDIF.

* Copia de código en ZABAPGIT
  IF     lw_adm         IS NOT INITIAL
     AND lw_adm-actcode CO lc_num_n_space
     AND lw_adm-mencode CO lc_num_n_space
     AND lw_adm-pfkcode CO lc_num_n_space. " Check performed in form check_adm of include LSMPIF03
  ELSE.
    LOOP AT lt_act ASSIGNING <ls_act>.
      IF <ls_act>-code+6(14) IS INITIAL AND <ls_act>-code(6) CO lc_num_only.
        lw_adm-actcode = <ls_act>-code.
      ENDIF.
    ENDLOOP.

    LOOP AT lt_men ASSIGNING <ls_men>.
      IF <ls_men>-code+6(14) IS INITIAL AND <ls_men>-code(6) CO lc_num_only.
        lw_adm-mencode = <ls_men>-code.
      ENDIF.
    ENDLOOP.

    LOOP AT lt_pfk ASSIGNING <ls_pfk>.
      IF <ls_pfk>-code+6(14) IS INITIAL AND <ls_pfk>-code(6) CO lc_num_only.
        lw_adm-pfkcode = <ls_pfk>-code.
      ENDIF.
    ENDLOOP.
  ENDIF.

  SELECT SINGLE devclass object obj_name FROM tadir     "#EC CI_GENBUFF
    INTO (tr_key-devclass, tr_key-obj_type, tr_key-obj_name)
   WHERE object   = 'PROG'
     AND obj_name = p_prog.
  IF sy-subrc <> 0.
    MESSAGE 'Error en SELECT TADIR' TYPE 'E'.
  ENDIF.

  CALL FUNCTION 'RS_CUA_INTERNAL_WRITE'
    EXPORTING
      program      = p_prog
      language     = sy-langu
      tr_key       = tr_key
      adm          = lw_adm
*     STATE        = 'A'
    TABLES
      sta          = lt_sta
      fun          = lt_fun
      men          = lt_men
      mtx          = lt_mtx
      act          = lt_act
      but          = lt_but
      pfk          = lt_pfk
      set          = lt_set
      doc          = lt_doc
      tit          = lt_tit
      biv          = lt_biv
    EXCEPTIONS
      not_found    = 1
      invalid_data = 2.

  IF sy-subrc <> 0.
    MESSAGE 'Error escribiendo status' TYPE 'E'.
  ENDIF.
ENDFORM.
