FUNCTION ZMASTERIDOC_CREATE_P03_OLD.
*"--------------------------------------------------------------------
*"*"Interfase local
*"  IMPORTING
*"     VALUE(MESSAGE_TYPE) LIKE  TBDME-MESTYP
*"     VALUE(CREATION_DATE_HIGH) LIKE  SY-DATUM DEFAULT SY-DATUM
*"     VALUE(CREATION_TIME_HIGH) LIKE  SY-UZEIT DEFAULT SY-UZEIT
*"--------------------------------------------------------------------

  DATA: BEGIN OF t_serial OCCURS 0,
          kunnr   LIKE bdikna1key-kunnr,
          cretime LIKE bdcp-cretime,
        END OF t_serial.

* kna1
  DATA: BEGIN OF f_kna1key,
          mandt LIKE bdikna1key-mandt,
          kunnr LIKE bdikna1key-kunnr,
        END OF f_kna1key.

  DATA: BEGIN OF f_kna1.
          INCLUDE STRUCTURE bdikna1key.
        DATA: END OF f_kna1.

  DATA: BEGIN OF t_kna1key OCCURS 10.
          INCLUDE STRUCTURE bdikna1key.
        DATA: END OF t_kna1key.

  DATA: BEGIN OF t_knaskey_h1 OCCURS 10.
          INCLUDE STRUCTURE bdiknaskey.
        DATA: END OF t_knaskey_h1.

  DATA: BEGIN OF t_knaskey_h2 OCCURS 10.
          INCLUDE STRUCTURE bdiknaskey.
        DATA: END OF t_knaskey_h2.

* knas
  DATA: BEGIN OF f_knaskey,
          mandt LIKE bdiknaskey-mandt,
          kunnr LIKE bdiknaskey-kunnr,
          land1 LIKE bdiknaskey-land1,
        END OF f_knaskey.

  DATA: t_knas    LIKE bdiknaskey OCCURS 0 WITH HEADER LINE,
        t_knaskey LIKE bdiknaskey OCCURS 0 WITH HEADER LINE.


* knb1
  DATA: BEGIN OF f_knb1key,
          mandt LIKE bdiknb1key-mandt,
          kunnr LIKE bdiknb1key-kunnr,
          bukrs LIKE bdiknb1key-bukrs,
        END OF f_knb1key.

  DATA: BEGIN OF t_knb1 OCCURS 10.
          INCLUDE STRUCTURE bdiknb1key.
        DATA: END OF t_knb1.

  DATA: BEGIN OF t_knb1key OCCURS 10.
          INCLUDE STRUCTURE bdiknb1key.
        DATA: END OF t_knb1key.

* knb5
  DATA: BEGIN OF f_knb5key,
          mandt LIKE bdiknb5key-mandt,
          kunnr LIKE bdiknb5key-kunnr,
          bukrs LIKE bdiknb5key-bukrs,
          maber LIKE bdiknb5key-maber,
        END OF f_knb5key.

  DATA: BEGIN OF t_knb5 OCCURS 10.
          INCLUDE STRUCTURE bdiknb5key.
        DATA: END OF t_knb5.

  DATA: BEGIN OF t_knb5key OCCURS 10.
          INCLUDE STRUCTURE bdiknb5key.
        DATA: END OF t_knb5key,
        t_knb5key_h1 LIKE bdiknb5key OCCURS 0 WITH HEADER LINE,
        t_knb5key_h2 LIKE bdiknb5key OCCURS 0 WITH HEADER LINE.

* knbk
  DATA: BEGIN OF f_knbkkey,
          mandt LIKE bdiknbkkey-mandt,
          kunnr LIKE bdiknbkkey-kunnr,
          banks LIKE bdiknbkkey-banks,
          bankl LIKE bdiknbkkey-bankl,
          bankn LIKE bdiknbkkey-bankn,
        END OF f_knbkkey.

  DATA: BEGIN OF t_knbk OCCURS 10.
          INCLUDE STRUCTURE bdiknbkkey.
        DATA: END OF t_knbk.

  DATA: BEGIN OF t_knbkkey OCCURS 10.
          INCLUDE STRUCTURE bdiknbkkey.
        DATA: END OF t_knbkkey.

  DATA: BEGIN OF t_knbkkey_h1 OCCURS 10.
          INCLUDE STRUCTURE bdiknbkkey.
        DATA: END OF t_knbkkey_h1.

  DATA: BEGIN OF t_knbkkey_h2 OCCURS 10.
          INCLUDE STRUCTURE bdiknbkkey.
        DATA: END OF t_knbkkey_h2.

* knex
  DATA: BEGIN OF f_knexkey,
          mandt LIKE bdiknexkey-mandt,
          kunnr LIKE bdiknexkey-kunnr,
          lndex LIKE bdiknexkey-lndex,
        END OF f_knexkey.

  DATA: t_knex    LIKE bdiknexkey OCCURS 0 WITH HEADER LINE,
        t_knexkey LIKE bdiknexkey OCCURS 0 WITH HEADER LINE.

* vckun
  DATA: BEGIN OF f_vckunkey,
          mandt LIKE bdvckunkey-mandt,
          kunnr LIKE bdvckunkey-kunnr,
          ccins LIKE bdvckunkey-ccins,
          ccnum LIKE bdvckunkey-ccnum,
        END OF f_vckunkey.

  DATA: t_vckun       LIKE bdvckunkey OCCURS 0 WITH HEADER LINE,
        t_vckunkey    LIKE bdvckunkey OCCURS 0 WITH HEADER LINE,
        t_vckunkey_h1 LIKE bdvckunkey OCCURS 0 WITH HEADER LINE,
        t_vckunkey_h2 LIKE bdvckunkey OCCURS 0 WITH HEADER LINE.

* vcnum
  DATA: BEGIN OF f_vcnumkey,
          mandt LIKE bdvckunkey-mandt,
          ccins LIKE bdvckunkey-ccins,
          ccnum LIKE bdvckunkey-ccnum,
        END OF f_vcnumkey.

  DATA: t_vcnumkey    LIKE bdvckunkey OCCURS 0 WITH HEADER LINE,
        t_vcnumkey_h1 LIKE bdvckunkey OCCURS 0 WITH HEADER LINE.
* knka
  DATA: BEGIN OF f_knkakey,
          mandt LIKE bdiknkakey-mandt,
          kunnr LIKE bdiknkakey-kunnr,
        END OF f_knkakey.

  DATA: BEGIN OF t_knka OCCURS 10.
          INCLUDE STRUCTURE bdiknkakey.
        DATA: END OF t_knka.

  DATA: BEGIN OF t_knkakey OCCURS 10.
          INCLUDE STRUCTURE bdiknkakey.
        DATA: END OF t_knkakey.

* knkk
  DATA: BEGIN OF f_knkkkey,
          mandt LIKE bdiknkkkey-mandt,
          kunnr LIKE bdiknkkkey-kunnr,
          kkber LIKE bdiknkkkey-kkber,
        END OF f_knkkkey.

  DATA: BEGIN OF t_knkk OCCURS 10.
          INCLUDE STRUCTURE bdiknkkkey.
        DATA: END OF t_knkk.

  DATA: BEGIN OF t_knkkkey OCCURS 10.
          INCLUDE STRUCTURE bdiknkkkey.
        DATA: END OF t_knkkkey.

* knva
  DATA: BEGIN OF f_knvakey,
          mandt LIKE bdiknvakey-mandt,
          kunnr LIKE bdiknvakey-kunnr,
          ablad LIKE bdiknvakey-ablad,
        END OF f_knvakey.

  DATA: BEGIN OF t_knva OCCURS 10.
          INCLUDE STRUCTURE bdiknvakey.
        DATA: END OF t_knva.

  DATA: BEGIN OF t_knvakey OCCURS 10.
          INCLUDE STRUCTURE bdiknvakey.
        DATA: END OF t_knvakey.

  DATA: BEGIN OF t_knvakey_h1 OCCURS 10.
          INCLUDE STRUCTURE bdiknvakey.
        DATA: END OF t_knvakey_h1.

  DATA: BEGIN OF t_knvakey_h2 OCCURS 10.
          INCLUDE STRUCTURE bdiknvakey.
        DATA: END OF t_knvakey_h2.

*mi/46a begin
* wrf12
  DATA: BEGIN OF f_wrf12key,
          mandt LIKE bdiwrf12ke-mandt,
          locnr LIKE bdiwrf12ke-locnr,
          empst LIKE bdiwrf12ke-empst,
        END OF f_wrf12key.

  DATA: BEGIN OF t_wrf12 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf12ke.
        DATA: END OF t_wrf12.

  DATA: BEGIN OF t_wrf12key OCCURS 10.
          INCLUDE STRUCTURE bdiwrf12ke.
        DATA: END OF t_wrf12key.

  DATA: BEGIN OF t_wrf12key_h1 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf12ke.
        DATA: END OF t_wrf12key_h1.

  DATA: BEGIN OF t_wrf12key_h2 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf12ke.
        DATA: END OF t_wrf12key_h2.

* wrf4
  DATA: BEGIN OF f_wrf4key,
          mandt LIKE bdiwrf4key-mandt,
          locnr LIKE bdiwrf4key-locnr,
          abtnr LIKE bdiwrf4key-abtnr,
        END OF f_wrf4key.

  DATA: BEGIN OF t_wrf4 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf4key.
        DATA: END OF t_wrf4.

  DATA: BEGIN OF t_wrf4key OCCURS 10.
          INCLUDE STRUCTURE bdiwrf4key.
        DATA: END OF t_wrf4key.

  DATA: BEGIN OF t_wrf4key_h1 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf4key.
        DATA: END OF t_wrf4key_h1.

  DATA: BEGIN OF t_wrf4key_h2 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf4key.
        DATA: END OF t_wrf4key_h2.
*mi/46a end

*mi/46c begin
* wrf1
  DATA: BEGIN OF f_wrf1key,
          mandt LIKE bdiwrf1key-mandt,
          locnr LIKE bdiwrf1key-locnr,
        END OF f_wrf1key.

  DATA: BEGIN OF t_wrf1 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf1key.
        DATA: END OF t_wrf1.

  DATA: BEGIN OF t_wrf1key OCCURS 10.
          INCLUDE STRUCTURE bdiwrf1key.
        DATA: END OF t_wrf1key.

  DATA: BEGIN OF t_wrf1key_h1 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf1key.
        DATA: END OF t_wrf1key_h1.

  DATA: BEGIN OF t_wrf1key_h2 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf1key.
        DATA: END OF t_wrf1key_h2.

* wrf3
  DATA: BEGIN OF f_wrf3key,
          mandt LIKE bdiwrf3key-mandt,
          locnr LIKE bdiwrf3key-locnr,
          matkl LIKE bdiwrf3key-matkl,
          datbi LIKE bdiwrf3key-datbi,
          datab LIKE bdiwrf3key-datab,
          loclb LIKE bdiwrf3key-loclb,
        END OF f_wrf3key.

  DATA: BEGIN OF t_wrf3 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf3key.
        DATA: END OF t_wrf3.

  DATA: BEGIN OF t_wrf3key OCCURS 10.
          INCLUDE STRUCTURE bdiwrf3key.
        DATA: END OF t_wrf3key.

  DATA: BEGIN OF t_wrf3key_h1 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf3key.
        DATA: END OF t_wrf3key_h1.

  DATA: BEGIN OF t_wrf3key_h2 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf3key.
        DATA: END OF t_wrf3key_h2.

* wrf5
  DATA: BEGIN OF f_wrf5key,
          mandt LIKE bdiwrf5key-mandt,
          locnr LIKE bdiwrf5key-locnr,
          ccins LIKE bdiwrf5key-ccins,
          merch LIKE bdiwrf5key-merch,
          bezei LIKE bdiwrf5key-bezei,
        END OF f_wrf5key.

  DATA: BEGIN OF t_wrf5 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf5key.
        DATA: END OF t_wrf5.

  DATA: BEGIN OF t_wrf5key OCCURS 10.
          INCLUDE STRUCTURE bdiwrf5key.
        DATA: END OF t_wrf5key.

  DATA: BEGIN OF t_wrf5key_h1 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf5key.
        DATA: END OF t_wrf5key_h1.

  DATA: BEGIN OF t_wrf5key_h2 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf5key.
        DATA: END OF t_wrf5key_h2.

* wrf6
  DATA: BEGIN OF f_wrf6key,
          mandt LIKE bdiwrf6key-mandt,
          locnr LIKE bdiwrf6key-locnr,
          matkl LIKE bdiwrf6key-matkl,
        END OF f_wrf6key.

  DATA: BEGIN OF t_wrf6 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf6key.
        DATA: END OF t_wrf6.

  DATA: BEGIN OF t_wrf6key OCCURS 10.
          INCLUDE STRUCTURE bdiwrf6key.
        DATA: END OF t_wrf6key.

  DATA: BEGIN OF t_wrf6key_h1 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf6key.
        DATA: END OF t_wrf6key_h1.

  DATA: BEGIN OF t_wrf6key_h2 OCCURS 10.
          INCLUDE STRUCTURE bdiwrf6key.
        DATA: END OF t_wrf6key_h2.

* t023w
  DATA: BEGIN OF f_t023wkey,
          mandt LIKE bdit023wke-mandt,
          locnr LIKE bdit023wke-locnr,
          matkl LIKE bdit023wke-matkl,
        END OF f_t023wkey.

  DATA: BEGIN OF t_t023w OCCURS 10.
          INCLUDE STRUCTURE bdit023wke.
        DATA: END OF t_t023w.

  DATA: BEGIN OF t_t023wkey OCCURS 10.
          INCLUDE STRUCTURE bdit023wke.
        DATA: END OF t_t023wkey.

  DATA: BEGIN OF t_t023wkey_h1 OCCURS 10.
          INCLUDE STRUCTURE bdit023wke.
        DATA: END OF t_t023wkey_h1.

  DATA: BEGIN OF t_t023wkey_h2 OCCURS 10.
          INCLUDE STRUCTURE bdit023wke.
        DATA: END OF t_t023wkey_h2.

* t023x
  DATA: BEGIN OF f_t023xkey,
          mandt LIKE bdit023xke-mandt,
          locnr LIKE bdit023xke-locnr,
          matnr LIKE bdit023xke-matnr,
        END OF f_t023xkey.

  DATA: BEGIN OF t_t023x OCCURS 10.
          INCLUDE STRUCTURE bdit023xke.
        DATA: END OF t_t023x.

  DATA: BEGIN OF t_t023xkey OCCURS 10.
          INCLUDE STRUCTURE bdit023xke.
        DATA: END OF t_t023xkey.

  DATA: BEGIN OF t_t023xkey_h1 OCCURS 10.
          INCLUDE STRUCTURE bdit023xke.
        DATA: END OF t_t023xkey_h1.

  DATA: BEGIN OF t_t023xkey_h2 OCCURS 10.
          INCLUDE STRUCTURE bdit023xke.
        DATA: END OF t_t023xkey_h2.
*mi/46c end

* knvd
  DATA: BEGIN OF f_knvdkey,
          mandt LIKE bdiknvdkey-mandt,
          kunnr LIKE bdiknvdkey-kunnr,
          vkorg LIKE bdiknvdkey-vkorg,
          vtweg LIKE bdiknvdkey-vtweg,
          spart LIKE bdiknvdkey-spart,
          doctp LIKE bdiknvdkey-doctp,
          spras LIKE bdiknvdkey-spras,
        END OF f_knvdkey.

  DATA: BEGIN OF t_knvd OCCURS 10.
          INCLUDE STRUCTURE bdiknvdkey.
        DATA: END OF t_knvd.

  DATA: BEGIN OF t_knvdkey OCCURS 10.
          INCLUDE STRUCTURE bdiknvdkey.
        DATA: END OF t_knvdkey.

  DATA: BEGIN OF t_knvdkey_h1 OCCURS 10.
          INCLUDE STRUCTURE bdiknvdkey.
        DATA: END OF t_knvdkey_h1.

  DATA: BEGIN OF t_knvdkey_h2 OCCURS 10.
          INCLUDE STRUCTURE bdiknvdkey.
        DATA: END OF t_knvdkey_h2.

* knvi
  DATA: BEGIN OF f_knvikey,
          mandt LIKE bdiknvikey-mandt,
          kunnr LIKE bdiknvikey-kunnr,
          aland LIKE bdiknvikey-aland,
          tatyp LIKE bdiknvikey-tatyp,
        END OF f_knvikey.

  DATA: BEGIN OF t_knvi OCCURS 10.
          INCLUDE STRUCTURE bdiknvikey.
        DATA: END OF t_knvi.

  DATA: BEGIN OF t_knvikey OCCURS 10.
          INCLUDE STRUCTURE bdiknvikey.
        DATA: END OF t_knvikey.

  DATA: ls_knvvkey_knvi    TYPE bdiknvvkey,
        lv_land            TYPE c,
        lt_sales_area_knvi LIKE knvi OCCURS 0 WITH HEADER LINE.

* knvk
  DATA: BEGIN OF f_knvkkey,
          mandt LIKE bdiknvkkey-mandt,
          kunnr LIKE bdiknvkkey-kunnr,
          parnr LIKE bdiknvkkey-parnr,
        END OF f_knvkkey.

  DATA: BEGIN OF t_knvk OCCURS 10.
          INCLUDE STRUCTURE bdiknvkkey.
        DATA: END OF t_knvk.

  DATA: BEGIN OF t_knvkkey OCCURS 10.
          INCLUDE STRUCTURE bdiknvkkey.
        DATA: END OF t_knvkkey.

  DATA: BEGIN OF t_knvkkey_h1 OCCURS 10.
          INCLUDE STRUCTURE bdiknvkkey.
        DATA: END OF t_knvkkey_h1.

  DATA: BEGIN OF t_knvkkey_h2 OCCURS 10.
          INCLUDE STRUCTURE bdiknvkkey.
        DATA: END OF t_knvkkey_h2.

* knvl
  DATA: BEGIN OF f_knvlkey,
          mandt LIKE bdiknvlkey-mandt,
          kunnr LIKE bdiknvlkey-kunnr,
          aland LIKE bdiknvlkey-aland,
          tatyp LIKE bdiknvlkey-tatyp,
          licnr LIKE bdiknvlkey-licnr,
        END OF f_knvlkey.

  DATA: BEGIN OF t_knvl OCCURS 10.
          INCLUDE STRUCTURE bdiknvlkey.
        DATA: END OF t_knvl.

  DATA: BEGIN OF t_knvlkey OCCURS 10.
          INCLUDE STRUCTURE bdiknvlkey.
        DATA: END OF t_knvlkey.

  DATA: BEGIN OF t_knvlkey_h1 OCCURS 10.
          INCLUDE STRUCTURE bdiknvlkey.
        DATA: END OF t_knvlkey_h1.

  DATA: BEGIN OF t_knvlkey_h2 OCCURS 10.
          INCLUDE STRUCTURE bdiknvlkey.
        DATA: END OF t_knvlkey_h2.

* knvp
  DATA: BEGIN OF f_knvpkey,
          mandt LIKE bdiknvpkey-mandt,
          kunnr LIKE bdiknvpkey-kunnr,
          vkorg LIKE bdiknvpkey-vkorg,
          vtweg LIKE bdiknvpkey-vtweg,
          spart LIKE bdiknvpkey-spart,
          parvw LIKE bdiknvpkey-parvw,
          parza LIKE bdiknvpkey-parza,
        END OF f_knvpkey.

  DATA: BEGIN OF t_knvp OCCURS 10.
          INCLUDE STRUCTURE bdiknvpkey.
        DATA: END OF t_knvp.

  DATA: BEGIN OF t_knvpkey OCCURS 10.
          INCLUDE STRUCTURE bdiknvpkey.
        DATA: END OF t_knvpkey.

  DATA: BEGIN OF t_knvpkey_h1 OCCURS 10.
          INCLUDE STRUCTURE bdiknvpkey.
        DATA: END OF t_knvpkey_h1.

  DATA: BEGIN OF t_knvpkey_h2 OCCURS 10.
          INCLUDE STRUCTURE bdiknvpkey.
        DATA: END OF t_knvpkey_h2.

* knvv
  DATA: BEGIN OF f_knvvkey,
          mandt LIKE bdiknvvkey-mandt,
          kunnr LIKE bdiknvvkey-kunnr,
          vkorg LIKE bdiknvvkey-vkorg,
          vtweg LIKE bdiknvvkey-vtweg,
          spart LIKE bdiknvvkey-spart,
        END OF f_knvvkey.

  DATA: BEGIN OF t_knvv OCCURS 10.
          INCLUDE STRUCTURE bdiknvvkey.
        DATA: END OF t_knvv.

  DATA: BEGIN OF t_knvvkey OCCURS 10.
          INCLUDE STRUCTURE bdiknvvkey.
        DATA: END OF t_knvvkey.

* knbw
  DATA: f_knbwkey  TYPE knbw_key_s.

  DATA: BEGIN OF t_knbw OCCURS 0.
          INCLUDE STRUCTURE bdiknbwkey.
        DATA: END OF t_knbw.

  DATA: BEGIN OF t_knbwkey OCCURS 0.
          INCLUDE STRUCTURE bdiknbwkey.
        DATA: END OF t_knbwkey.

  DATA: BEGIN OF t_knbwkey_h1 OCCURS 0.
          INCLUDE STRUCTURE bdiknbwkey.
        DATA: END OF t_knbwkey_h1.

  DATA: BEGIN OF t_knbwkey_h2 OCCURS 0.
          INCLUDE STRUCTURE bdiknbwkey.
        DATA: END OF t_knbwkey_h2.

* knat
  DATA: BEGIN OF f_knatkey,
          mandt LIKE bdiknatkey-mandt,
          kunnr LIKE bdiknatkey-kunnr,
          taxgr LIKE bdiknatkey-taxgr,
        END OF f_knatkey.

  DATA: BEGIN OF t_knat OCCURS 10.
          INCLUDE STRUCTURE bdiknatkey.
        DATA: END OF t_knat.

  DATA: BEGIN OF t_knatkey OCCURS 10.
          INCLUDE STRUCTURE bdiknatkey.
        DATA: END OF t_knatkey.

  DATA: BEGIN OF t_knatkey_h1 OCCURS 10.
          INCLUDE STRUCTURE bdiknatkey.
        DATA: END OF t_knatkey_h1.

  DATA: BEGIN OF t_knatkey_h2 OCCURS 10.
          INCLUDE STRUCTURE bdiknatkey.
        DATA: END OF t_knatkey_h2.

* change pointers
  DATA: BEGIN OF t_chgptrs OCCURS 10.
          INCLUDE STRUCTURE bdcp.
        DATA: END OF t_chgptrs.

  DATA: t_chgptrs_klim         LIKE bdcp OCCURS 0 WITH HEADER LINE,
        t_chgptrs_vcnum        LIKE bdcp OCCURS 0 WITH HEADER LINE,
        t_chgptrs_plant        LIKE bdcp OCCURS 0 WITH HEADER LINE, "mi/46a
        t_chgptrs_debi_listing LIKE bdcp OCCURS 0 WITH HEADER LINE.

* Note 450069 / mh.
  DATA: t_chgptrs_debi_text LIKE bdcp OCCURS 0 WITH HEADER LINE.

  DATA: lv_customer_text_cp LIKE customer_texts_cp.
  DATA: lt_text_deletions_cp LIKE customer_texts_cp
                             OCCURS 0 WITH HEADER LINE.
* Note 450069 / mh.
  DATA: t_chgptrs_debi_cred_text LIKE bdcp OCCURS 0 WITH HEADER LINE.
  DATA: lv_credit_text_cp TYPE credit_texts_cp.
  DATA: lt_credit_text_deletions_cp TYPE credit_texts_it_cp.

  DATA: BEGIN OF t_cpident OCCURS 10,
          cpident LIKE bdcp-cpident,
        END OF t_cpident.

  DATA: BEGIN OF t_cpident_deb OCCURS 10,
          mandt   LIKE bdikna1key-mandt,
          kunnr   LIKE bdikna1key-kunnr,
          cpident LIKE bdcp-cpident,
        END OF t_cpident_deb.
  DATA: lv_chgptrs LIKE t_chgptrs.                  "mi/note 201673
  FIELD-SYMBOLS: <fs_cpident_deb> LIKE LINE OF t_cpident_deb,
                 <fs_knaskey>     TYPE bdiknaskey,
                 <fs_knb1key>     TYPE bdiknb1key,
                 <fs_knb5key>     TYPE bdiknb5key,
                 <fs_knbkkey>     TYPE bdiknbkkey,
                 <fs_knexkey>     TYPE bdiknexkey,
                 <fs_knkakey>     TYPE bdiknkakey,
                 <fs_knkkkey>     TYPE bdiknkkkey,
                 <fs_knvakey>     TYPE bdiknvakey,
                 <fs_wrf12key>    TYPE bdiwrf12ke,
                 <fs_wrf4key>     TYPE bdiwrf4key,
                 <fs_wrf1key>     TYPE bdiwrf1key,
                 <fs_wrf3key>     TYPE bdiwrf3key,
                 <fs_wrf5key>     TYPE bdiwrf5key,
                 <fs_wrf6key>     TYPE bdiwrf6key,
                 <fs_t023wkey>    TYPE bdit023wke,
                 <fs_t023xkey>    TYPE bdit023xke,
                 <fs_knvdkey>     TYPE bdiknvdkey,
                 <fs_knvikey>     TYPE bdiknvikey,
                 <fs_knvkkey>     TYPE bdiknvkkey,
                 <fs_knvlkey>     TYPE bdiknvlkey,
                 <fs_knvpkey>     TYPE bdiknvpkey,
                 <fs_knvvkey>     TYPE bdiknvvkey,
                 <fs_vckunkey>    TYPE bdvckunkey,
                 <fs_knbwkey>     TYPE bdiknbwkey.

* \BE Note 517173 - B
  DATA: BEGIN OF lt_knvk_adr OCCURS 10.      "Alle Adreßnummern zu den
          INCLUDE STRUCTURE knvkadrfeld.     "Ansprechpartnern
        DATA: END OF lt_knvk_adr.
  DATA: lv_rcvprn   LIKE bdaledc-rcvprn.
* \BE Note 517173 - E

* created idocs
  DATA: created_m_idocs LIKE sy-tabix.
  DATA: created_comm_idocs LIKE sy-tabix.
  DATA: created_c_idocs LIKE sy-tabix.
  DATA: done_since_commit LIKE sy-tabix.

  DATA: BEGIN OF t_resend OCCURS 0,
          kunnr LIKE kna1-kunnr,
        END OF t_resend.
  DATA: need_to_resend LIKE c_true.

  DATA: lv_tabix LIKE sy-tabix.
  DATA: lv_parza_length TYPE i.
  DATA: lv_subrc TYPE sysubrc.

** start_EoP adaptation
** Read back internal guideline note 1998910 before starting delivering a correction
  IF cl_vs_switch_check=>cmd_vmd_cvp_ilm_sfw_01( ) IS NOT INITIAL.
    INCLUDE erp_cvp_i1_c_ale0032 IF FOUND.
  ENDIF.
** end_EoP_adaptation

* ADD_ON-Änderungen - B
* Ermitteln Instanz für BADI VENDOR_ADD_DATA_BI
*  PERFORM get_badi_instance_bi.
* ADD_ON-Änderungen - E

  REFRESH t_kna1key.
  REFRESH t_knaskey.
  REFRESH t_knb1key.
  REFRESH t_knb5key.
  REFRESH t_knbkkey.
  REFRESH t_knexkey.
  REFRESH t_knkakey.
  REFRESH t_knkkkey.
  REFRESH t_knvakey.
  REFRESH t_wrf12key.                                       "mi/46a
  REFRESH t_wrf4key.                                        "mi/46a
  REFRESH t_wrf1key.                                        "mi/46c
  REFRESH t_wrf3key.                                        "mi/46c
  REFRESH t_wrf5key.                                        "mi/46c
  REFRESH t_wrf6key.                                        "mi/46c
  REFRESH t_t023wkey.                                       "mi/46c
  REFRESH t_t023xkey.                                       "mi/46c
  REFRESH t_knvdkey.
  REFRESH t_knvikey.
  REFRESH t_knvkkey.
  REFRESH t_knvlkey.
  REFRESH t_knvpkey.
  REFRESH t_knvvkey.
  REFRESH t_vckunkey.
  REFRESH t_knbwkey.
  REFRESH t_knatkey.

* read all not processed change pointers for the given messagetype,
* object class DEBI
  CALL FUNCTION 'CHANGE_POINTERS_READ'
    EXPORTING
      change_document_object_class = c_cdobjcl_debi
      message_type                 = message_type
      creation_date_high           = creation_date_high
      creation_time_high           = creation_time_high
      read_not_processed_pointers  = c_x
    TABLES
      change_pointers              = t_chgptrs.

* read all not processed change pointers for the given messagetype,
* object class KLIM
  CALL FUNCTION 'CHANGE_POINTERS_READ'
    EXPORTING
      change_document_object_class = c_cdobjcl_klim
      message_type                 = message_type
      creation_date_high           = creation_date_high
      creation_time_high           = creation_time_high
      read_not_processed_pointers  = c_x
    TABLES
      change_pointers              = t_chgptrs_klim.

* Add the KLIM pointers to the table with all pointers.
  APPEND LINES OF t_chgptrs_klim TO t_chgptrs.

* read all not processed change pointers for the given messagetype,
* object class VCNUM (credit card data)
  CALL FUNCTION 'CHANGE_POINTERS_READ'
    EXPORTING
      change_document_object_class = c_cdobjcl_vcnum
      message_type                 = message_type
      creation_date_high           = creation_date_high
      creation_time_high           = creation_time_high
      read_not_processed_pointers  = c_x
    TABLES
      change_pointers              = t_chgptrs_vcnum.

* Add the VCNUM pointers to the table with all pointers.
  APPEND LINES OF t_chgptrs_vcnum TO t_chgptrs.

*mi/46a begin
* read all not processed change pointers for the given messagetype,
* object class BETRIEB
  CALL FUNCTION 'CHANGE_POINTERS_READ'
    EXPORTING
      change_document_object_class = c_cdobjcl_plant
      message_type                 = message_type
      creation_date_high           = creation_date_high
      creation_time_high           = creation_time_high
      read_not_processed_pointers  = c_x
    TABLES
      change_pointers              = t_chgptrs_plant.

* Add the VCNUM pointers to the table with all pointers.
  APPEND LINES OF t_chgptrs_plant TO t_chgptrs.
*mi/46a end

* read all not processed change pointers for the given messagetype,
* object class DEBITOR - these are created when the customer has been
* added to a listing (ALE distribution class).
  CALL FUNCTION 'CHANGE_POINTERS_READ'
    EXPORTING
      change_document_object_class = c_cdobjcl_debi_listing
      message_type                 = message_type
      creation_date_high           = creation_date_high
      creation_time_high           = creation_time_high
      read_not_processed_pointers  = c_x
    TABLES
      change_pointers              = t_chgptrs_debi_listing.


* Fill table with customers that need 'refreshing' because they have
* been added to a listing.
* Add entries to t_kna1key for these customers.
  LOOP AT t_chgptrs_debi_listing.
    t_resend-kunnr = t_chgptrs_debi_listing-tabkey+3(10).


    COLLECT t_resend.

    f_kna1key-mandt = t_chgptrs_debi_listing-tabkey(3).
    f_kna1key-kunnr = t_resend-kunnr.

    READ TABLE t_kna1key WITH KEY f_kna1key.

    MOVE f_kna1key-mandt TO t_kna1key-mandt.
    MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
    t_kna1key-msgfn = c_msgfn_i.            "Always insert in this case.

    IF sy-subrc <> 0.
      APPEND t_kna1key.
    ELSE.
      MODIFY t_kna1key INDEX sy-tabix.
    ENDIF.

    t_serial-kunnr    = t_kna1key-kunnr.
    t_serial-cretime  = t_chgptrs-cretime.
    READ TABLE t_serial WITH KEY
      kunnr = t_kna1key-kunnr BINARY SEARCH
                       TRANSPORTING NO FIELDS.
    IF sy-subrc <> 0.
      INSERT t_serial INDEX sy-tabix.
    ENDIF.

*   add pointer to processed pointers
    t_cpident_deb-mandt = t_chgptrs_debi_listing-tabkey+0(3).
    t_cpident_deb-kunnr = t_resend-kunnr.
    t_cpident_deb-cpident = t_chgptrs_debi_listing-cpident.
    APPEND t_cpident_deb.

  ENDLOOP.

  SORT t_resend BY kunnr.
  need_to_resend = c_false.
  READ TABLE t_resend INDEX 1.
  IF sy-subrc = 0.
    need_to_resend = c_true.
  ENDIF.

* Begin of insertion note 450069 / mh.
* read all not processed change pointers for the given messagetype,
* object class CUSTTEXT
  CALL FUNCTION 'CHANGE_POINTERS_READ'
    EXPORTING
      change_document_object_class = c_cdobjcl_ctext
      message_type                 = message_type
      creation_date_high           = creation_date_high
      creation_time_high           = creation_time_high
      read_not_processed_pointers  = c_x
    TABLES
      change_pointers              = t_chgptrs_debi_text.


  LOOP AT t_chgptrs_debi_text.
    f_kna1key-mandt = t_chgptrs_debi_text-tabkey(3).
    f_kna1key-kunnr = t_chgptrs_debi_text-tabkey+3(10).

    READ TABLE t_kna1key WITH KEY f_kna1key.

    MOVE f_kna1key-mandt TO t_kna1key-mandt.
    MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
    t_kna1key-msgfn = c_msgfn_s.            "Resend ausführen.

    IF sy-subrc <> 0.
      APPEND t_kna1key.
    ELSE.
      MODIFY t_kna1key INDEX sy-tabix.
    ENDIF.

    MOVE t_chgptrs_debi_text-cdobjid TO lv_customer_text_cp.

    IF NOT lv_customer_text_cp-text_id IS INITIAL.
      LOOP AT lt_text_deletions_cp TRANSPORTING NO FIELDS
           WHERE kunnr = lv_customer_text_cp-kunnr AND    "note 499292
                 bukrs = lv_customer_text_cp-bukrs AND    "note 499292
                 vkorg = lv_customer_text_cp-vkorg AND    "note 499292
                 vtweg = lv_customer_text_cp-vtweg AND    "note 499292
                 spart = lv_customer_text_cp-spart AND    "note 499292
                 parnr = lv_customer_text_cp-parnr AND    "note 499292
                 text_id = lv_customer_text_cp-text_id AND
                 spras = lv_customer_text_cp-spras.
      ENDLOOP.
      IF sy-subrc NE 0.
        APPEND lv_customer_text_cp TO lt_text_deletions_cp.
      ENDIF.
    ENDIF.

* Contact Person Texts, resend KNVK-segment.
    IF NOT lv_customer_text_cp-parnr IS INITIAL.
      f_knvkkey-mandt = t_chgptrs_debi_text-tabkey(3).
      f_knvkkey-kunnr = t_chgptrs_debi_text-tabkey+3(10).
      f_knvkkey-parnr = lv_customer_text_cp-parnr.

      READ TABLE t_knvkkey WITH KEY f_knvkkey.

      MOVE f_knvkkey-mandt TO t_knvkkey-mandt.
      MOVE f_knvkkey-kunnr TO t_knvkkey-kunnr.
      MOVE f_knvkkey-parnr TO t_knvkkey-parnr.
      t_knvkkey-msgfn = c_msgfn_s.            "Resend ausführen.

      IF sy-subrc <> 0.
        APPEND t_knvkkey.
      ELSE.
        MODIFY t_knvkkey INDEX sy-tabix.
      ENDIF.
    ENDIF.

* Company Code Texts, resend KNB1-segment.
    IF NOT lv_customer_text_cp-bukrs IS INITIAL.
      f_knb1key-mandt = t_chgptrs_debi_text-tabkey(3).
      f_knb1key-kunnr = t_chgptrs_debi_text-tabkey+3(10).
      f_knb1key-bukrs = lv_customer_text_cp-bukrs.

      READ TABLE t_knb1key WITH KEY f_knb1key.

      MOVE f_knb1key-mandt TO t_knb1key-mandt.
      MOVE f_knb1key-kunnr TO t_knb1key-kunnr.
      MOVE f_knb1key-bukrs TO t_knb1key-bukrs.
      t_knb1key-msgfn = c_msgfn_s.            "Resend ausführen.

      IF sy-subrc <> 0.
        APPEND t_knb1key.
      ELSE.
        MODIFY t_knb1key INDEX sy-tabix.
      ENDIF.
    ENDIF.

* Sales Area Texts, resend KNVV-segment.
    IF NOT lv_customer_text_cp-vkorg IS INITIAL.
      f_knvvkey-mandt = t_chgptrs_debi_text-tabkey(3).
      f_knvvkey-kunnr = t_chgptrs_debi_text-tabkey+3(10).
      f_knvvkey-vkorg = lv_customer_text_cp-vkorg.
      f_knvvkey-vtweg = lv_customer_text_cp-vtweg.
      f_knvvkey-spart = lv_customer_text_cp-spart.

      READ TABLE t_knvvkey WITH KEY f_knvvkey.

      MOVE f_knvvkey-mandt TO t_knvvkey-mandt.
      MOVE f_knvvkey-kunnr TO t_knvvkey-kunnr.
      MOVE f_knvvkey-vkorg TO t_knvvkey-vkorg.
      MOVE f_knvvkey-vtweg TO t_knvvkey-vtweg.
      MOVE f_knvvkey-spart TO t_knvvkey-spart.

      t_knvvkey-msgfn = c_msgfn_s.            "Resend ausführen.

      IF sy-subrc <> 0.
        APPEND t_knvvkey.
      ELSE.
        MODIFY t_knvvkey INDEX sy-tabix.
      ENDIF.
    ENDIF.

    t_serial-kunnr    = t_kna1key-kunnr.
    t_serial-cretime  = t_chgptrs_debi_text-cretime.
    READ TABLE t_serial WITH KEY
      kunnr = t_kna1key-kunnr BINARY SEARCH
                       TRANSPORTING NO FIELDS.
    IF sy-subrc <> 0.
      INSERT t_serial INDEX sy-tabix.
    ENDIF.

*   add pointer to processed pointers
    t_cpident_deb-mandt = t_chgptrs_debi_text-tabkey+0(3).
    t_cpident_deb-kunnr = t_kna1key-kunnr.
    t_cpident_deb-cpident = t_chgptrs_debi_text-cpident.
    APPEND t_cpident_deb.

  ENDLOOP.

* End of insertion note 450069 / mh.

* read all not processed change pointers for the given messagetype,
* object class CREDTEXT
  CALL FUNCTION 'CHANGE_POINTERS_READ'
    EXPORTING
      change_document_object_class = c_cdobjcl_credtext
      message_type                 = message_type
      creation_date_high           = creation_date_high
      creation_time_high           = creation_time_high
      read_not_processed_pointers  = c_x
    TABLES
      change_pointers              = t_chgptrs_debi_cred_text.

  LOOP AT t_chgptrs_debi_cred_text.
    f_kna1key-mandt = t_chgptrs_debi_cred_text-tabkey(3).
    f_kna1key-kunnr = t_chgptrs_debi_cred_text-tabkey+3(10).

    READ TABLE t_kna1key WITH KEY f_kna1key.

    MOVE f_kna1key-mandt TO t_kna1key-mandt.
    MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
    t_kna1key-msgfn = c_msgfn_s.            "Resend ausführen.

    IF sy-subrc <> 0.
      APPEND t_kna1key.
    ELSE.
      MODIFY t_kna1key INDEX sy-tabix.
    ENDIF.

*    MOVE t_chgptrs_debi_cred_text-cdobjid TO lv_credit_text_cp.
    lv_credit_text_cp-kunnr  = t_chgptrs_debi_cred_text-cdobjid+0(10).
    lv_credit_text_cp-kkber  = t_chgptrs_debi_cred_text-cdobjid+10(4).
    lv_credit_text_cp-text_id = t_chgptrs_debi_cred_text-cdobjid+14(4).
    lv_credit_text_cp-spras  = t_chgptrs_debi_cred_text-cdobjid+18(1).

    IF NOT lv_credit_text_cp-text_id IS INITIAL.
      LOOP AT lt_credit_text_deletions_cp TRANSPORTING NO FIELDS
           WHERE kunnr = lv_credit_text_cp-kunnr AND
                 kkber = lv_credit_text_cp-kkber AND
                 text_id = lv_credit_text_cp-text_id AND
                 spras = lv_credit_text_cp-spras.
      ENDLOOP.
      IF sy-subrc NE 0.
        APPEND lv_credit_text_cp TO lt_credit_text_deletions_cp.
      ENDIF.
    ENDIF.

* Customer master credit management: Control area data text
* resend KNKK-segment.
    IF NOT lv_credit_text_cp-kkber IS INITIAL.
      f_knkkkey-mandt = t_chgptrs_debi_cred_text-tabkey(3).
      f_knkkkey-kunnr = t_chgptrs_debi_cred_text-tabkey+3(10).
      f_knkkkey-kkber = lv_credit_text_cp-kkber.

      READ TABLE t_knkkkey WITH KEY f_knkkkey.

      MOVE f_knkkkey-mandt TO t_knkkkey-mandt.
      MOVE f_knkkkey-kunnr TO t_knkkkey-kunnr.
      MOVE f_knkkkey-kkber TO t_knkkkey-kkber.
      t_knkkkey-msgfn = c_msgfn_s.

      IF sy-subrc <> 0.
        APPEND t_knkkkey.
      ELSE.
        MODIFY t_knkkkey INDEX sy-tabix.
      ENDIF.
    ELSE.
* **** KNKA text is not processed in standard
* Customer master credit management: Central data text,
* resend KNKA-segment.
*    IF lv_credit_text_cp-kkber IS INITIAL.
*      f_knkakey-mandt = t_chgptrs_debi_cred_text-tabkey(3).
*      f_knkakey-kunnr = t_chgptrs_debi_cred_text-tabkey+3(10).
*      READ TABLE t_knkakey WITH KEY f_knkakey.
*
*      MOVE f_knkakey-mandt TO t_knkakey-mandt.
*      MOVE f_knkakey-kunnr TO t_knkakey-kunnr.
*      t_knvvkey-msgfn = c_msgfn_s.
*
*      IF sy-subrc <> 0.
*        APPEND t_knkakey.
*      ELSE.
*        MODIFY t_knkakey INDEX sy-tabix.
*      ENDIF.
    ENDIF.

    t_serial-kunnr    = t_kna1key-kunnr.
    t_serial-cretime  = t_chgptrs_debi_cred_text-cretime.
    READ TABLE t_serial WITH KEY
      kunnr = t_kna1key-kunnr BINARY SEARCH
                       TRANSPORTING NO FIELDS.
    IF sy-subrc <> 0.
      INSERT t_serial INDEX sy-tabix.
    ENDIF.

*   add pointer to processed pointers
    t_cpident_deb-mandt = t_chgptrs_debi_cred_text-tabkey+0(3).
    t_cpident_deb-kunnr = t_kna1key-kunnr.
    t_cpident_deb-cpident = t_chgptrs_debi_cred_text-cpident.
    APPEND t_cpident_deb.
  ENDLOOP.

* create all keys from the change pointers
  LOOP AT t_chgptrs.


    DATA: t_bdicpident TYPE TABLE OF bdicpident,
          l_bdicpident TYPE bdicpident.

*    Comprobamos que se ha pasado de ZPOT a ZCLI
    SELECT SINGLE COUNT(*)
      FROM cdhdr AS a
      INNER JOIN cdpos AS b ON a~changenr = b~changenr AND a~objectclas = b~objectclas AND a~objectid = b~objectid
      WHERE a~objectid = t_chgptrs-tabkey+3(10)
        AND b~fname = 'KEY'
        AND b~tabname = 'KNA1'
        AND b~CHNGIND = 'I'
        AND a~changenr = t_chgptrs-cdchgno
        AND a~objectclas = t_chgptrs-cdobjcl.
    IF sy-subrc <> 0.

      REFRESH: t_bdicpident.
      CLEAR: l_bdicpident.

      l_bdicpident-cpident = t_chgptrs-cpident.

      APPEND l_bdicpident TO t_bdicpident.

      CALL FUNCTION 'CHANGE_POINTERS_STATUS_WRITE'
        EXPORTING
          message_type           = message_type    " Message type
        TABLES
          change_pointers_idents = t_bdicpident.

      DELETE t_chgptrs.

      CONTINUE.
    ENDIF.


    CASE t_chgptrs-tabname.
*     table KNA1
*     table KNA1 of the change document equals the table KNA1
      WHEN 'KNA1'.
        f_kna1key-mandt = t_chgptrs-tabkey+0(3).
        IF f_kna1key-mandt = space.
          f_kna1key-mandt = t_chgptrs-mandt.
        ENDIF.
        f_kna1key-kunnr = t_chgptrs-tabkey+3(10).

        READ TABLE t_kna1key WITH KEY f_kna1key.

        MOVE f_kna1key-mandt TO t_kna1key-mandt.
        MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_kna1key-msgfn.
        IF sy-subrc <> 0.
          APPEND t_kna1key.
        ELSE.
          MODIFY t_kna1key INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_kna1key TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table KNAS
*     table KNAS of the change document equals the table KNAS
      WHEN 'KNAS'.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_knaskey-mandt.
        IF f_knaskey-mandt = space.
          f_knaskey-mandt = t_chgptrs-mandt.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(10)
                                  f_knaskey-kunnr.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+13(3)
                                  f_knaskey-land1.

        READ TABLE t_knaskey WITH KEY f_knaskey.

        MOVE f_knaskey-mandt TO t_knaskey-mandt.
        MOVE f_knaskey-kunnr TO t_knaskey-kunnr.
        MOVE f_knaskey-land1 TO t_knaskey-land1.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_knaskey-msgfn.
        IF sy-subrc <> 0.
          APPEND t_knaskey.
        ELSE.
          MODIFY t_knaskey INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_knaskey TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.

*     table KNAT
*     table KNAT of the change document equals the table KNAT
      WHEN 'KNAT'.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_knatkey-mandt.
        IF f_knatkey-mandt = space.
          f_knatkey-mandt = t_chgptrs-mandt.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(10)
                                  f_knatkey-kunnr.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+13(3)
                                  f_knatkey-taxgr.

        READ TABLE t_knatkey WITH KEY f_knatkey.

        MOVE f_knatkey-mandt TO t_knatkey-mandt.
        MOVE f_knatkey-kunnr TO t_knatkey-kunnr.
        MOVE f_knatkey-taxgr TO t_knatkey-taxgr.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_knatkey-msgfn.
        IF sy-subrc <> 0.
          APPEND t_knatkey.
        ELSE.
          MODIFY t_knatkey INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_knatkey TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table KNB1
*     table KNB1 of the change document equals the table KNB1
      WHEN 'KNB1'.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_knb1key-mandt.
        IF f_knb1key-mandt = space.
          f_knb1key-mandt = t_chgptrs-mandt.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(10)
                                  f_knb1key-kunnr.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+13(4)
                                  f_knb1key-bukrs.

        READ TABLE t_knb1key WITH KEY f_knb1key.

        MOVE f_knb1key-mandt TO t_knb1key-mandt.
        MOVE f_knb1key-kunnr TO t_knb1key-kunnr.
        MOVE f_knb1key-bukrs TO t_knb1key-bukrs.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_knb1key-msgfn.
        IF sy-subrc <> 0.
          APPEND t_knb1key.
        ELSE.
          MODIFY t_knb1key INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_knb1key TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table KNB5
*     table KNB5 of the change document equals the table KNB5
      WHEN 'KNB5'.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_knb5key-mandt.
        IF f_knb5key-mandt = space.
          f_knb5key-mandt = t_chgptrs-mandt.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(10)
                                  f_knb5key-kunnr.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+13(4)
                                  f_knb5key-bukrs.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+17(2)
                                  f_knb5key-maber.

        READ TABLE t_knb5key WITH KEY f_knb5key.

        MOVE f_knb5key-mandt TO t_knb5key-mandt.
        MOVE f_knb5key-kunnr TO t_knb5key-kunnr.
        MOVE f_knb5key-bukrs TO t_knb5key-bukrs.
        MOVE f_knb5key-maber TO t_knb5key-maber.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_knb5key-msgfn.
        IF sy-subrc <> 0.
          APPEND t_knb5key.
        ELSE.
          MODIFY t_knb5key INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_knb5key TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table KNBK
*     table KNBK of the change document equals the table KNBK
      WHEN 'KNBK'.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_knbkkey-mandt.
        IF f_knbkkey-mandt = space.
          f_knbkkey-mandt = t_chgptrs-mandt.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(10)
                                  f_knbkkey-kunnr.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+13(3)
                                  f_knbkkey-banks.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+16(15)
                                  f_knbkkey-bankl.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+31(18)
                                  f_knbkkey-bankn.

        READ TABLE t_knbkkey WITH KEY f_knbkkey.

        MOVE f_knbkkey-mandt TO t_knbkkey-mandt.
        MOVE f_knbkkey-kunnr TO t_knbkkey-kunnr.
        MOVE f_knbkkey-banks TO t_knbkkey-banks.
        MOVE f_knbkkey-bankl TO t_knbkkey-bankl.
        MOVE f_knbkkey-bankn TO t_knbkkey-bankn.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_knbkkey-msgfn.
        IF sy-subrc <> 0.
          APPEND t_knbkkey.
        ELSE.
          MODIFY t_knbkkey INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_knbkkey TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table KNEX
*     table KNEX of the change document equals the table KNEX
      WHEN 'KNEX'.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_knexkey-mandt.
        IF f_knexkey-mandt = space.
          f_knexkey-mandt = t_chgptrs-mandt.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(10)
                                  f_knexkey-kunnr.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+13(3)
                                  f_knexkey-lndex.

        READ TABLE t_knexkey WITH KEY f_knexkey.

        MOVE f_knexkey-mandt TO t_knexkey-mandt.
        MOVE f_knexkey-kunnr TO t_knexkey-kunnr.
        MOVE f_knexkey-lndex TO t_knexkey-lndex.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_knexkey-msgfn.
        IF sy-subrc <> 0.
          APPEND t_knexkey.
        ELSE.
          MODIFY t_knexkey INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_knexkey TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table KNKA
*     table KNKA of the change document equals the table KNKA
      WHEN 'KNKA'.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_knkakey-mandt.
        IF f_knkakey-mandt = space.
          f_knkakey-mandt = t_chgptrs-mandt.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(10)
                                  f_knkakey-kunnr.

        READ TABLE t_knkakey WITH KEY f_knkakey.

        MOVE f_knkakey-mandt TO t_knkakey-mandt.
        MOVE f_knkakey-kunnr TO t_knkakey-kunnr.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_knkakey-msgfn.
        IF sy-subrc <> 0.
          APPEND t_knkakey.
        ELSE.
          MODIFY t_knkakey INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_knkakey TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table KNKK
*     table KNKK of the change document equals the table KNKK
      WHEN 'KNKK'.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_knkkkey-mandt.
        IF f_knkkkey-mandt = space.
          f_knkkkey-mandt = t_chgptrs-mandt.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(10)
                                  f_knkkkey-kunnr.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+13(4)
                                  f_knkkkey-kkber.

        READ TABLE t_knkkkey WITH KEY f_knkkkey.

        MOVE f_knkkkey-mandt TO t_knkkkey-mandt.
        MOVE f_knkkkey-kunnr TO t_knkkkey-kunnr.
        MOVE f_knkkkey-kkber TO t_knkkkey-kkber.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_knkkkey-msgfn.
        IF sy-subrc <> 0.
          APPEND t_knkkkey.
        ELSE.
          MODIFY t_knkkkey INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_knkkkey TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table KNVA
*     table KNVA of the change document equals the table KNVA
      WHEN 'KNVA'.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_knvakey-mandt.
        IF f_knvakey-mandt = space.
          f_knvakey-mandt = t_chgptrs-mandt.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(10)
                                  f_knvakey-kunnr.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+13(25)
                                  f_knvakey-ablad.

        READ TABLE t_knvakey WITH KEY f_knvakey.

        MOVE f_knvakey-mandt TO t_knvakey-mandt.
        MOVE f_knvakey-kunnr TO t_knvakey-kunnr.
        MOVE f_knvakey-ablad TO t_knvakey-ablad.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_knvakey-msgfn.
        IF sy-subrc <> 0.
          APPEND t_knvakey.
        ELSE.
          MODIFY t_knvakey INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_knvakey TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*mi/46a begin
*     table wrf12
*     table wrf12 of the change document equals the table wrf12
      WHEN 'WRF12'.
        f_wrf12key-mandt = t_chgptrs-tabkey+0(3).
        IF f_wrf12key-mandt = space.
          f_wrf12key-mandt = t_chgptrs-mandt.
        ENDIF.
        f_wrf12key-locnr = t_chgptrs-tabkey+3(10).
        f_wrf12key-empst = t_chgptrs-tabkey+13(25).

        READ TABLE t_wrf12key WITH KEY f_wrf12key.

        MOVE f_wrf12key-mandt TO t_wrf12key-mandt.
        MOVE f_wrf12key-locnr TO t_wrf12key-locnr.
        MOVE f_wrf12key-empst TO t_wrf12key-empst.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_wrf12key-msgfn.
        IF sy-subrc <> 0.
          APPEND t_wrf12key.
        ELSE.
          MODIFY t_wrf12key INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_wrf12key TO t_cpident_deb.
        t_cpident_deb-kunnr = f_wrf12key-locnr.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table wrf4
*     table wrf4 of the change document equals the table wrf4
      WHEN 'WRF4'.
        f_wrf4key-mandt = t_chgptrs-tabkey+0(3).
        IF f_wrf4key-mandt = space.
          f_wrf4key-mandt = t_chgptrs-mandt.
        ENDIF.
        f_wrf4key-locnr = t_chgptrs-tabkey+3(10).
        f_wrf4key-abtnr = t_chgptrs-tabkey+13(4).

        READ TABLE t_wrf4key WITH KEY f_wrf4key.

        MOVE f_wrf4key-mandt TO t_wrf4key-mandt.
        MOVE f_wrf4key-locnr TO t_wrf4key-locnr.
        MOVE f_wrf4key-abtnr TO t_wrf4key-abtnr.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_wrf4key-msgfn.
        IF sy-subrc <> 0.
          APPEND t_wrf4key.
        ELSE.
          MODIFY t_wrf4key INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_wrf4key TO t_cpident_deb.
        t_cpident_deb-kunnr = f_wrf4key-locnr.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.
*mi/46a end


*mi/46c begin
*     table wrf1
*     table wrf1 of the change document equals the table wrf1
      WHEN 'WRF1'.
        f_wrf1key-mandt = t_chgptrs-tabkey+0(3).
        IF f_wrf1key-mandt = space.
          f_wrf1key-mandt = t_chgptrs-mandt.
        ENDIF.
        f_wrf1key-locnr = t_chgptrs-tabkey+3(10).

        READ TABLE t_wrf1key WITH KEY f_wrf1key.

        MOVE f_wrf1key-mandt TO t_wrf1key-mandt.
        MOVE f_wrf1key-locnr TO t_wrf1key-locnr.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_wrf1key-msgfn.
        IF sy-subrc <> 0.
          APPEND t_wrf1key.
        ELSE.
          MODIFY t_wrf1key INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_wrf1key TO t_cpident_deb.
        t_cpident_deb-kunnr = f_wrf1key-locnr.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table wrf3
*     table wrf3 of the change document equals the table wrf3
      WHEN 'WRF3'.
        f_wrf3key-mandt = t_chgptrs-tabkey+0(3).
        IF f_wrf3key-mandt = space.
          f_wrf3key-mandt = t_chgptrs-mandt.
        ENDIF.
        f_wrf3key-locnr = t_chgptrs-tabkey+3(10).
        f_wrf3key-matkl = t_chgptrs-tabkey+13(9).
        f_wrf3key-datbi = t_chgptrs-tabkey+22(8).
        f_wrf3key-datab = t_chgptrs-tabkey+30(8).
        f_wrf3key-loclb = t_chgptrs-tabkey+38(4).

        READ TABLE t_wrf3key WITH KEY f_wrf3key.

        MOVE f_wrf3key-mandt TO t_wrf3key-mandt.
        MOVE f_wrf3key-locnr TO t_wrf3key-locnr.
        MOVE f_wrf3key-matkl TO t_wrf3key-matkl.
        MOVE f_wrf3key-datbi TO t_wrf3key-datbi.
        MOVE f_wrf3key-datab TO t_wrf3key-datab.
        MOVE f_wrf3key-loclb TO t_wrf3key-loclb.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_wrf3key-msgfn.
        IF sy-subrc <> 0.
          APPEND t_wrf3key.
        ELSE.
          MODIFY t_wrf3key INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_wrf3key TO t_cpident_deb.
        t_cpident_deb-kunnr = f_wrf3key-locnr.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table wrf5
*     table wrf5 of the change document equals the table wrf5
      WHEN 'WRF5'.
        f_wrf5key-mandt = t_chgptrs-tabkey+0(3).
        IF f_wrf5key-mandt = space.
          f_wrf5key-mandt = t_chgptrs-mandt.
        ENDIF.
        f_wrf5key-locnr = t_chgptrs-tabkey+3(10).
        f_wrf5key-ccins = t_chgptrs-tabkey+13(4).
        f_wrf5key-merch = t_chgptrs-tabkey+17(15).
        f_wrf5key-bezei = t_chgptrs-tabkey+32(30).

        READ TABLE t_wrf5key WITH KEY f_wrf5key.

        MOVE f_wrf5key-mandt TO t_wrf5key-mandt.
        MOVE f_wrf5key-locnr TO t_wrf5key-locnr.
        MOVE f_wrf5key-ccins TO t_wrf5key-ccins.
        MOVE f_wrf5key-merch TO t_wrf5key-merch.
        MOVE f_wrf5key-bezei TO t_wrf5key-bezei.

        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_wrf5key-msgfn.
        IF sy-subrc <> 0.
          APPEND t_wrf5key.
        ELSE.
          MODIFY t_wrf5key INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_wrf5key TO t_cpident_deb.
        t_cpident_deb-kunnr = f_wrf5key-locnr.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table wrf6
*     table wrf6 of the change document equals the table wrf6
      WHEN 'WRF6'.
        f_wrf6key-mandt = t_chgptrs-tabkey+0(3).
        IF f_wrf6key-mandt = space.
          f_wrf6key-mandt = t_chgptrs-mandt.
        ENDIF.
        f_wrf6key-locnr = t_chgptrs-tabkey+3(10).
        f_wrf6key-matkl = t_chgptrs-tabkey+13(9).

        READ TABLE t_wrf6key WITH KEY f_wrf6key.

        MOVE f_wrf6key-mandt TO t_wrf6key-mandt.
        MOVE f_wrf6key-locnr TO t_wrf6key-locnr.
        MOVE f_wrf6key-matkl TO t_wrf6key-matkl.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_wrf6key-msgfn.
        IF sy-subrc <> 0.
          APPEND t_wrf6key.
        ELSE.
          MODIFY t_wrf6key INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_wrf6key TO t_cpident_deb.
        t_cpident_deb-kunnr = f_wrf6key-locnr.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table t023w
*     table t023w of the change document equals the table t023w
      WHEN 'T023W'.
        f_t023wkey-mandt = t_chgptrs-tabkey+0(3).
        IF f_t023wkey-mandt = space.
          f_t023wkey-mandt = t_chgptrs-mandt.
        ENDIF.
        f_t023wkey-locnr = t_chgptrs-tabkey+3(10).
        f_t023wkey-matkl = t_chgptrs-tabkey+13(9).

        READ TABLE t_t023wkey WITH KEY f_t023wkey.

        MOVE f_t023wkey-mandt TO t_t023wkey-mandt.
        MOVE f_t023wkey-locnr TO t_t023wkey-locnr.
        MOVE f_t023wkey-matkl TO t_t023wkey-matkl.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_t023wkey-msgfn.
        IF sy-subrc <> 0.
          APPEND t_t023wkey.
        ELSE.
          MODIFY t_t023wkey INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_t023wkey TO t_cpident_deb.
        t_cpident_deb-kunnr = f_t023wkey-locnr.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table t023x
*     table t023x of the change document equals the table t023x
      WHEN 'T023X'.
        f_t023xkey-mandt = t_chgptrs-tabkey+0(3).
        IF f_t023xkey-mandt = space.
          f_t023xkey-mandt = t_chgptrs-mandt.
        ENDIF.
        f_t023xkey-locnr = t_chgptrs-tabkey+3(10).
        f_t023xkey-matnr = t_chgptrs-tabkey+13(18).

        READ TABLE t_t023xkey WITH KEY f_t023xkey.

        MOVE f_t023xkey-mandt TO t_t023xkey-mandt.
        MOVE f_t023xkey-locnr TO t_t023xkey-locnr.
        MOVE f_t023xkey-matnr TO t_t023xkey-matnr.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_t023xkey-msgfn.
        IF sy-subrc <> 0.
          APPEND t_t023xkey.
        ELSE.
          MODIFY t_t023xkey INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_t023xkey TO t_cpident_deb.
        t_cpident_deb-kunnr = f_t023xkey-locnr.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.
*mi/46c end


*     table KNVD
*     table KNVD of the change document equals the table KNVD
      WHEN 'KNVD'.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_knvdkey-mandt.
        IF f_knvdkey-mandt = space.
          f_knvdkey-mandt = t_chgptrs-mandt.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(10)
                                  f_knvdkey-kunnr.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+13(4)
                                  f_knvdkey-vkorg.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+17(2)
                                  f_knvdkey-vtweg.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+19(2)
                                  f_knvdkey-spart.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+21(4)
                                  f_knvdkey-doctp.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+25(1)
                                  f_knvdkey-spras.

        READ TABLE t_knvdkey WITH KEY f_knvdkey.

        MOVE f_knvdkey-mandt TO t_knvdkey-mandt.
        MOVE f_knvdkey-kunnr TO t_knvdkey-kunnr.
        MOVE f_knvdkey-vkorg TO t_knvdkey-vkorg.
        MOVE f_knvdkey-vtweg TO t_knvdkey-vtweg.
        MOVE f_knvdkey-spart TO t_knvdkey-spart.
        MOVE f_knvdkey-doctp TO t_knvdkey-doctp.
        MOVE f_knvdkey-spras TO t_knvdkey-spras.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_knvdkey-msgfn.
        IF sy-subrc <> 0.
          APPEND t_knvdkey.
        ELSE.
          MODIFY t_knvdkey INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_knvdkey TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table KNVI
*     table KNVI of the change document equals the table KNVI
      WHEN 'KNVI'.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_knvikey-mandt.
        IF f_knvikey-mandt = space.
          f_knvikey-mandt = t_chgptrs-mandt.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(10)
                                  f_knvikey-kunnr.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+13(3)
                                  f_knvikey-aland.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+16(4)
                                  f_knvikey-tatyp.

        READ TABLE t_knvikey WITH KEY f_knvikey.

        MOVE f_knvikey-mandt TO t_knvikey-mandt.
        MOVE f_knvikey-kunnr TO t_knvikey-kunnr.
        MOVE f_knvikey-aland TO t_knvikey-aland.
        MOVE f_knvikey-tatyp TO t_knvikey-tatyp.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_knvikey-msgfn.
        IF sy-subrc <> 0.
          APPEND t_knvikey.
        ELSE.
          MODIFY t_knvikey INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_knvikey TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table KNVK
*     table KNVK of the change document equals the table KNVK
      WHEN 'KNVK'.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_knvkkey-mandt.
        IF f_knvkkey-mandt = space.
          f_knvkkey-mandt = t_chgptrs-mandt.
        ENDIF.
        f_knvkkey-kunnr = t_chgptrs-cdobjid.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(10)
                                  f_knvkkey-parnr.

        READ TABLE t_knvkkey WITH KEY f_knvkkey.

        MOVE f_knvkkey-mandt TO t_knvkkey-mandt.
        MOVE f_knvkkey-kunnr TO t_knvkkey-kunnr.
        MOVE f_knvkkey-parnr TO t_knvkkey-parnr.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_knvkkey-msgfn.
        IF sy-subrc <> 0.
          APPEND t_knvkkey.
        ELSE.
          MODIFY t_knvkkey INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_knvkkey TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table KNVL
*     table KNVL of the change document equals the table KNVL
      WHEN 'KNVL'.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_knvlkey-mandt.
        IF f_knvlkey-mandt = space.
          f_knvlkey-mandt = t_chgptrs-mandt.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(10)
                                  f_knvlkey-kunnr.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+13(3)
                                  f_knvlkey-aland.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+16(4)
                                  f_knvlkey-tatyp.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+20(15)
                                  f_knvlkey-licnr.

        READ TABLE t_knvlkey WITH KEY f_knvlkey.

        MOVE f_knvlkey-mandt TO t_knvlkey-mandt.
        MOVE f_knvlkey-kunnr TO t_knvlkey-kunnr.
        MOVE f_knvlkey-aland TO t_knvlkey-aland.
        MOVE f_knvlkey-tatyp TO t_knvlkey-tatyp.
        MOVE f_knvlkey-licnr TO t_knvlkey-licnr.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_knvlkey-msgfn.
        IF sy-subrc <> 0.
          APPEND t_knvlkey.
        ELSE.
          MODIFY t_knvlkey INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_knvlkey TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table KNVP
*     table KNVP of the change document equals the table KNVP
      WHEN 'KNVP'.
        IF lv_parza_length IS INITIAL.
          DESCRIBE FIELD f_knvpkey-parza
                   LENGTH lv_parza_length
                   IN CHARACTER MODE.
          IF lv_parza_length = 0.
            lv_parza_length = 3.
          ENDIF.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_knvpkey-mandt.
        IF f_knvpkey-mandt = space.
          f_knvpkey-mandt = t_chgptrs-mandt.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(10)
                                  f_knvpkey-kunnr.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+13(4)
                                  f_knvpkey-vkorg.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+17(2)
                                  f_knvpkey-vtweg.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+19(2)
                                  f_knvpkey-spart.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+21(2)
                                  f_knvpkey-parvw.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+23(lv_parza_length)
                                  f_knvpkey-parza.

        READ TABLE t_knvpkey WITH KEY f_knvpkey
                             BINARY SEARCH.

        MOVE f_knvpkey-mandt TO t_knvpkey-mandt.
        MOVE f_knvpkey-kunnr TO t_knvpkey-kunnr.
        MOVE f_knvpkey-vkorg TO t_knvpkey-vkorg.
        MOVE f_knvpkey-vtweg TO t_knvpkey-vtweg.
        MOVE f_knvpkey-spart TO t_knvpkey-spart.
        MOVE f_knvpkey-parvw TO t_knvpkey-parvw.
        MOVE f_knvpkey-parza TO t_knvpkey-parza.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_knvpkey-msgfn.
        IF sy-subrc = 0.
          MODIFY t_knvpkey INDEX sy-tabix.
        ELSEIF sy-subrc = 4.
          INSERT t_knvpkey INDEX sy-tabix.
        ELSE.
          APPEND t_knvpkey.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_knvpkey TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.


*     table KNVV
*     table KNVV of the change document equals the table KNVV
      WHEN 'KNVV'.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_knvvkey-mandt.
        IF f_knvvkey-mandt = space.
          f_knvvkey-mandt = t_chgptrs-mandt.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(10)
                                  f_knvvkey-kunnr.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+13(4)
                                  f_knvvkey-vkorg.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+17(2)
                                  f_knvvkey-vtweg.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+19(2)
                                  f_knvvkey-spart.

        READ TABLE t_knvvkey WITH KEY f_knvvkey.

        MOVE f_knvvkey-mandt TO t_knvvkey-mandt.
        MOVE f_knvvkey-kunnr TO t_knvvkey-kunnr.
        MOVE f_knvvkey-vkorg TO t_knvvkey-vkorg.
        MOVE f_knvvkey-vtweg TO t_knvvkey-vtweg.
        MOVE f_knvvkey-spart TO t_knvvkey-spart.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_knvvkey-msgfn.
        IF sy-subrc <> 0.
          APPEND t_knvvkey.
        ELSE.
*\BE Note 374353 - A
*         MODIFY T_KNVVKEY INDEX SY-TABIX.
          IF t_knvvkey-msgfn = c_msgfn_i.
            MODIFY t_knvvkey INDEX sy-tabix.
          ENDIF.
*\BE Note 374353 - E
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_knvvkey TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.

*     table VCKUN
*     table VCKUN of the change document equals the table VCKUN
      WHEN 'VCKUN'.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_vckunkey-mandt.
        IF f_vckunkey-mandt = space.
          f_vckunkey-mandt = t_chgptrs-mandt.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(10)
                                  f_vckunkey-kunnr.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+13(4)
                                  f_vckunkey-ccins.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+17(25)
                                  f_vckunkey-ccnum.

        READ TABLE t_vckunkey WITH KEY f_vckunkey.

        MOVE f_vckunkey-mandt TO t_vckunkey-mandt.
        MOVE f_vckunkey-kunnr TO t_vckunkey-kunnr.
        MOVE f_vckunkey-ccins TO t_vckunkey-ccins.
        MOVE f_vckunkey-ccnum TO t_vckunkey-ccnum.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_vckunkey-msgfn.
        IF sy-subrc <> 0.
          APPEND t_vckunkey.
        ELSE.
          MODIFY t_vckunkey INDEX sy-tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_vckunkey TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.

*     table VCNUM
*     table VCNUM of the change document equals the table VCNUM
      WHEN 'VCNUM'.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_vcnumkey-mandt.
        IF f_vcnumkey-mandt = space.
          f_vcnumkey-mandt = t_chgptrs-mandt.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(4)
                                  f_vcnumkey-ccins.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+7(25)
                                  f_vcnumkey-ccnum.

        READ TABLE t_vcnumkey WITH KEY f_vcnumkey.

        MOVE f_vcnumkey-mandt TO t_vcnumkey-mandt.
        MOVE f_vcnumkey-ccins TO t_vcnumkey-ccins.
        MOVE f_vcnumkey-ccnum TO t_vcnumkey-ccnum.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_vcnumkey-msgfn.
        IF sy-subrc <> 0.
          APPEND t_vcnumkey.
        ELSE.
          MODIFY t_vcnumkey INDEX sy-tabix.
        ENDIF.

*mi/note 201673 begin
        DATA: e_vckun TYPE vckun.
        CALL FUNCTION 'CCARDEC_BP_SELECT'
          EXPORTING
            i_ccins         = f_vcnumkey-ccins
            i_ccnum         = f_vcnumkey-ccnum
          IMPORTING
            e_vckun         = e_vckun
          EXCEPTIONS
            vckun_not_found = 1
            vcnum_not_found = 2
            OTHERS          = 3.
        MOVE e_vckun-kunnr TO t_cpident_deb-kunnr.
        IF sy-subrc <> 0.
          lv_chgptrs = t_chgptrs.
          LOOP AT t_chgptrs WHERE tabname       = 'VCKUN'
                            AND   tabkey+13(4)  = f_vcnumkey-ccins
                            AND   tabkey+17(25) = f_vcnumkey-ccnum.
            t_cpident_deb-kunnr = t_chgptrs-tabkey+3(10).
          ENDLOOP.
          t_chgptrs = lv_chgptrs.
        ENDIF.
*mi/note 201673 end

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_vcnumkey TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.

*     table KNBW    \BE 4.70
*     table KNBW of the change document equals the table KNBW
      WHEN 'KNBW'.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+0(3)
                                  f_knbwkey-mandt.
        IF f_knbwkey-mandt = space.
          f_knbwkey-mandt = t_chgptrs-mandt.
        ENDIF.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+3(10)
                                  f_knbwkey-kunnr.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+13(4)
                                  f_knbwkey-bukrs.
        PERFORM move_x_to_y USING t_chgptrs-tabkey+17(2)
                                  f_knbwkey-witht.

        READ TABLE t_knbwkey WITH KEY f_knbwkey
                                  BINARY SEARCH.
        lv_tabix = sy-tabix.

        MOVE f_knbwkey-mandt TO t_knbwkey-mandt.
        MOVE f_knbwkey-kunnr TO t_knbwkey-kunnr.
        MOVE f_knbwkey-bukrs TO t_knbwkey-bukrs.
        MOVE f_knbwkey-witht TO t_knbwkey-witht.
        PERFORM convert_cdchgid_to_msgfn USING t_chgptrs-cdchgid
                                               t_knbwkey-msgfn.
        IF sy-subrc <> 0.
          INSERT t_knbwkey INDEX lv_tabix.
        ELSE.
          MODIFY t_knbwkey INDEX lv_tabix.
        ENDIF.

*       add pointer to processed pointers
        MOVE-CORRESPONDING f_knbwkey TO t_cpident_deb.
        MOVE t_chgptrs-cpident TO t_cpident_deb-cpident.
        APPEND t_cpident_deb.

    ENDCASE.

*\BE Note 381050 - B
*   T_SERIAL-KUNNR    = T_CHGPTRS-CDOBJID.
*   T_SERIAL-CRETIME  = T_CHGPTRS-CRETIME.
*   READ TABLE T_SERIAL WITH KEY
*     KUNNR = T_CHGPTRS-CDOBJID BINARY SEARCH
*                      TRANSPORTING NO FIELDS.
    t_serial-kunnr    = t_cpident_deb-kunnr.
    t_serial-cretime  = t_chgptrs-cretime.
    READ TABLE t_serial WITH KEY
      kunnr = t_cpident_deb-kunnr BINARY SEARCH
                       TRANSPORTING NO FIELDS.
*\BE Note 381050 - E
    IF sy-subrc <> 0.
      INSERT t_serial INDEX sy-tabix.
    ENDIF.

  ENDLOOP.                             "at t_chgptrs

* ADD_ON-Änderungen - B
  PERFORM process_own_change_pointer
                      TABLES t_serial
                             t_cpident_deb
                             t_kna1key
                             t_knb1key
                             t_knvvkey
                             t_knbkkey
                             t_knvkkey
                             t_knexkey
                             t_knvakey
                             t_knvpkey
                             t_knvdkey
                             t_knvikey
                             t_knvlkey
                      USING  message_type
                             creation_date_high
                             creation_time_high.

* ADD_ON-Änderungen - E

  SORT t_serial BY cretime kunnr.

* create keys for necassary segments

* Create key entries for those tables whose entire contents need
* to be sent each time (for the given customer, company code and/or
* sales area.), i.e. if one entry changed, need to send all others too.
  t_knbkkey_h1[] = t_knbkkey[].
  t_knvakey_h1[] = t_knvakey[].
  t_wrf12key_h1[] = t_wrf12key[].                           "mi/46a
  t_wrf4key_h1[] = t_wrf4key[].                             "mi/46a
  t_wrf1key_h1[] = t_wrf1key[].                             "mi/46c
  t_wrf3key_h1[] = t_wrf3key[].                             "mi/46c
  t_wrf5key_h1[] = t_wrf5key[].                             "mi/46c
  t_wrf6key_h1[] = t_wrf6key[].                             "mi/46c
  t_t023wkey_h1[] = t_t023wkey[].                           "mi/46c
  t_t023xkey_h1[] = t_t023xkey[].                           "mi/46c
  t_knvdkey_h1[] = t_knvdkey[].
  t_knvkkey_h1[] = t_knvkkey[].
  t_knvlkey_h1[] = t_knvlkey[].
  t_knvpkey_h1[] = t_knvpkey[].
  t_vcnumkey_h1[] = t_vcnumkey[].
  t_knbwkey_h1[] = t_knbwkey[].
  t_knaskey_h1[] = t_knaskey[].
  t_knatkey_h1[] = t_knatkey[].

  SORT t_knaskey_h1 BY mandt kunnr.
  DELETE ADJACENT DUPLICATES FROM t_knaskey_h1
    COMPARING mandt kunnr.

  SORT t_knbkkey_h1 BY mandt kunnr.
  DELETE ADJACENT DUPLICATES FROM t_knbkkey_h1
    COMPARING mandt kunnr.

  SORT t_knvakey_h1 BY mandt kunnr.
  DELETE ADJACENT DUPLICATES FROM t_knvakey_h1
    COMPARING mandt kunnr.

*mi/46a begin
  SORT t_wrf12key_h1 BY mandt locnr.
  DELETE ADJACENT DUPLICATES FROM t_wrf12key_h1
    COMPARING mandt locnr.

  SORT t_wrf4key_h1 BY mandt locnr.
  DELETE ADJACENT DUPLICATES FROM t_wrf4key_h1
    COMPARING mandt locnr.
*mi/46a end

*mi/46c begin
  SORT t_wrf1key_h1 BY mandt locnr.
  DELETE ADJACENT DUPLICATES FROM t_wrf1key_h1
    COMPARING mandt locnr.

  SORT t_wrf3key_h1 BY mandt locnr.
  DELETE ADJACENT DUPLICATES FROM t_wrf3key_h1
    COMPARING mandt locnr.

  SORT t_wrf5key_h1 BY mandt locnr.
  DELETE ADJACENT DUPLICATES FROM t_wrf5key_h1
    COMPARING mandt locnr.

  SORT t_wrf6key_h1 BY mandt locnr.
  DELETE ADJACENT DUPLICATES FROM t_wrf6key_h1
    COMPARING mandt locnr.

  SORT t_t023wkey_h1 BY mandt locnr.
  DELETE ADJACENT DUPLICATES FROM t_t023wkey_h1
    COMPARING mandt locnr.

  SORT t_t023xkey_h1 BY mandt locnr.
  DELETE ADJACENT DUPLICATES FROM t_t023xkey_h1
    COMPARING mandt locnr.
*mi/46c end

  SORT t_knvdkey_h1 BY mandt kunnr vkorg vtweg spart.
  DELETE ADJACENT DUPLICATES FROM t_knvdkey_h1
    COMPARING mandt kunnr vkorg vtweg spart.

  SORT t_knvkkey_h1 BY mandt kunnr.
  DELETE ADJACENT DUPLICATES FROM t_knvkkey_h1
    COMPARING mandt kunnr.

  SORT t_knvlkey_h1 BY mandt kunnr.
  DELETE ADJACENT DUPLICATES FROM t_knvlkey_h1
    COMPARING mandt kunnr.

*  SORT t_knvpkey_h1 BY mandt kunnr vkorg vtweg spart.
  DELETE ADJACENT DUPLICATES FROM t_knvpkey_h1
    COMPARING mandt kunnr vkorg vtweg spart.

* Sort KNAT data.
  SORT t_knatkey_h1 BY mandt kunnr.
  DELETE ADJACENT DUPLICATES FROM t_knatkey_h1
    COMPARING mandt kunnr.


  LOOP AT t_knaskey_h1.
    SELECT * FROM knas
    WHERE kunnr = t_knaskey_h1-kunnr.
      MOVE-CORRESPONDING knas TO t_knaskey_h2.
      APPEND t_knaskey_h2.
    ENDSELECT.
  ENDLOOP.

  SORT t_knbwkey_h1 BY mandt kunnr bukrs.
  DELETE ADJACENT DUPLICATES FROM t_knbwkey_h1
    COMPARING mandt kunnr bukrs.

  LOOP AT t_knbkkey_h1.
    SELECT * FROM knbk
    WHERE kunnr = t_knbkkey_h1-kunnr.
      MOVE-CORRESPONDING knbk TO t_knbkkey_h2.
      APPEND t_knbkkey_h2.
    ENDSELECT.
  ENDLOOP.

  LOOP AT t_knvakey_h1.
    SELECT * FROM knva
    WHERE kunnr = t_knvakey_h1-kunnr.
      MOVE-CORRESPONDING knva TO t_knvakey_h2.
      APPEND t_knvakey_h2.
    ENDSELECT.
  ENDLOOP.

*mi/46a begin
  LOOP AT t_wrf12key_h1.
    SELECT * FROM wrf12
    WHERE locnr = t_wrf12key_h1-locnr.
      MOVE-CORRESPONDING wrf12 TO t_wrf12key_h2.
      APPEND t_wrf12key_h2.
    ENDSELECT.
  ENDLOOP.

  LOOP AT t_wrf4key_h1.
    SELECT * FROM wrf4
    WHERE locnr = t_wrf4key_h1-locnr.
      MOVE-CORRESPONDING wrf4 TO t_wrf4key_h2.
      APPEND t_wrf4key_h2.
    ENDSELECT.
  ENDLOOP.
*mi/46a end

*mi/46c begin
  LOOP AT t_wrf1key_h1.
    SELECT * FROM wrf1
    WHERE locnr = t_wrf1key_h1-locnr.
      MOVE-CORRESPONDING wrf1 TO t_wrf1key_h2.
      APPEND t_wrf1key_h2.
    ENDSELECT.
  ENDLOOP.

  LOOP AT t_wrf3key_h1.
    SELECT * FROM wrf3
    WHERE locnr = t_wrf3key_h1-locnr.
      MOVE-CORRESPONDING wrf3 TO t_wrf3key_h2.
      APPEND t_wrf3key_h2.
    ENDSELECT.
  ENDLOOP.

  LOOP AT t_wrf5key_h1.
    SELECT * FROM wrf5
    WHERE locnr = t_wrf5key_h1-locnr.
      MOVE-CORRESPONDING wrf5 TO t_wrf5key_h2.
      APPEND t_wrf5key_h2.
    ENDSELECT.
  ENDLOOP.

  LOOP AT t_wrf6key_h1.
    SELECT * FROM wrf6
    WHERE locnr = t_wrf6key_h1-locnr.
      MOVE-CORRESPONDING wrf6 TO t_wrf6key_h2.
      APPEND t_wrf6key_h2.
    ENDSELECT.
  ENDLOOP.

  LOOP AT t_t023wkey_h1.
    SELECT * FROM t023w
    WHERE locnr = t_t023wkey_h1-locnr.
      MOVE-CORRESPONDING t023w TO t_t023wkey_h2.
      APPEND t_t023wkey_h2.
    ENDSELECT.
  ENDLOOP.

  LOOP AT t_t023xkey_h1.
    SELECT * FROM t023x
    WHERE locnr = t_t023xkey_h1-locnr.
      MOVE-CORRESPONDING t023x TO t_t023xkey_h2.
      APPEND t_t023xkey_h2.
    ENDSELECT.
  ENDLOOP.
*mi/46c end

  LOOP AT t_knvdkey_h1.
    SELECT * FROM knvd
    WHERE kunnr = t_knvdkey_h1-kunnr
    AND   vkorg = t_knvdkey_h1-vkorg
    AND   vtweg = t_knvdkey_h1-vtweg
    AND   spart = t_knvdkey_h1-spart.
      MOVE-CORRESPONDING knvd TO t_knvdkey_h2.
      APPEND t_knvdkey_h2.
    ENDSELECT.
  ENDLOOP.

  LOOP AT t_knvkkey_h1.
    SELECT * FROM knvk
    WHERE kunnr = t_knvkkey_h1-kunnr.
      MOVE-CORRESPONDING knvk TO t_knvkkey_h2.
      APPEND t_knvkkey_h2.
    ENDSELECT.
  ENDLOOP.

  LOOP AT t_knvlkey_h1.
    SELECT * FROM knvl
    WHERE kunnr = t_knvlkey_h1-kunnr.
      MOVE-CORRESPONDING knvl TO t_knvlkey_h2.
      APPEND t_knvlkey_h2.
    ENDSELECT.
  ENDLOOP.

  LOOP AT t_knatkey_h1.
    SELECT * FROM knat
    WHERE kunnr = t_knatkey_h1-kunnr.
      MOVE-CORRESPONDING knat TO t_knatkey_h2.
      APPEND t_knatkey_h2.
    ENDSELECT.
  ENDLOOP.

  IF NOT t_knvpkey_h1[] IS INITIAL.
    SELECT mandt kunnr vkorg vtweg spart parvw parza
             FROM knvp
             APPENDING CORRESPONDING FIELDS OF TABLE t_knvpkey_h2
             FOR ALL ENTRIES IN t_knvpkey_h1
    WHERE kunnr = t_knvpkey_h1-kunnr
    AND   vkorg = t_knvpkey_h1-vkorg
    AND   vtweg = t_knvpkey_h1-vtweg
             AND   spart = t_knvpkey_h1-spart
             ORDER BY PRIMARY KEY.
  ENDIF.

  LOOP AT t_knaskey_h2.
    READ TABLE t_knaskey WITH KEY mandt = t_knaskey_h2-mandt
                                  kunnr = t_knaskey_h2-kunnr
                                  land1 = t_knaskey_h2-land1.
    IF sy-subrc <> 0.
      t_knaskey = t_knaskey_h2.
      PERFORM convert_cdchgid_to_msgfn USING ' '
                                             t_knaskey-msgfn.
      APPEND t_knaskey.
    ENDIF.
  ENDLOOP.

  IF NOT t_knbwkey_h1[] IS INITIAL.
    SELECT mandt kunnr bukrs witht   FROM knbw
         APPENDING CORRESPONDING FIELDS OF TABLE t_knbwkey_h2
      FOR ALL ENTRIES IN t_knbwkey_h1
      WHERE kunnr = t_knbwkey_h1-kunnr
        AND bukrs = t_knbwkey_h1-bukrs.
  ENDIF.

  LOOP AT t_knbkkey_h2.
    READ TABLE t_knbkkey WITH KEY mandt = t_knbkkey_h2-mandt
                                  kunnr = t_knbkkey_h2-kunnr
                                  banks = t_knbkkey_h2-banks
                                  bankl = t_knbkkey_h2-bankl
                                  bankn = t_knbkkey_h2-bankn.
    IF sy-subrc <> 0.
      t_knbkkey = t_knbkkey_h2.
      PERFORM convert_cdchgid_to_msgfn USING ' '
                                             t_knbkkey-msgfn.
      APPEND t_knbkkey.
    ENDIF.
  ENDLOOP.

  LOOP AT t_knvakey_h2.
    READ TABLE t_knvakey WITH KEY mandt = t_knvakey_h2-mandt
                                  kunnr = t_knvakey_h2-kunnr
                                  ablad = t_knvakey_h2-ablad.
    IF sy-subrc <> 0.
      t_knvakey = t_knvakey_h2.
      PERFORM convert_cdchgid_to_msgfn USING ' '
                                             t_knvakey-msgfn.
      APPEND t_knvakey.
    ENDIF.
  ENDLOOP.

*mi/46a begin
  LOOP AT t_wrf12key_h2.
    READ TABLE t_wrf12key WITH KEY mandt = t_wrf12key_h2-mandt
                                   locnr = t_wrf12key_h2-locnr
                                   empst = t_wrf12key_h2-empst.
    IF sy-subrc <> 0.
      t_wrf12key = t_wrf12key_h2.
      PERFORM convert_cdchgid_to_msgfn USING ' '
                                             t_wrf12key-msgfn.
      APPEND t_wrf12key.
    ENDIF.
  ENDLOOP.

  LOOP AT t_wrf4key_h2.
    READ TABLE t_wrf4key WITH KEY mandt = t_wrf4key_h2-mandt
                                  locnr = t_wrf4key_h2-locnr
                                  abtnr = t_wrf4key_h2-abtnr.
    IF sy-subrc <> 0.
      t_wrf4key = t_wrf4key_h2.
      PERFORM convert_cdchgid_to_msgfn USING ' '
                                             t_wrf4key-msgfn.
      APPEND t_wrf4key.
    ENDIF.
  ENDLOOP.
*mi/46a end

*mi/46c begin
  LOOP AT t_wrf1key_h2.
    READ TABLE t_wrf1key WITH KEY mandt = t_wrf1key_h2-mandt
                                  locnr = t_wrf1key_h2-locnr.
    IF sy-subrc <> 0.
      t_wrf1key = t_wrf1key_h2.
      PERFORM convert_cdchgid_to_msgfn USING ' '
                                             t_wrf1key-msgfn.
      APPEND t_wrf1key.
    ENDIF.
  ENDLOOP.

  LOOP AT t_wrf3key_h2.
    READ TABLE t_wrf3key WITH KEY mandt = t_wrf3key_h2-mandt
                                  locnr = t_wrf3key_h2-locnr
                                  matkl = t_wrf3key_h2-matkl
                                  datbi = t_wrf3key_h2-datbi
                                  datab = t_wrf3key_h2-datab
                                  loclb = t_wrf3key_h2-loclb.
    IF sy-subrc <> 0.
      t_wrf3key = t_wrf3key_h2.
      PERFORM convert_cdchgid_to_msgfn USING ' '
                                             t_wrf3key-msgfn.
      APPEND t_wrf3key.
    ENDIF.
  ENDLOOP.

  LOOP AT t_wrf5key_h2.
    READ TABLE t_wrf5key WITH KEY mandt = t_wrf5key_h2-mandt
                                  locnr = t_wrf5key_h2-locnr
                                  ccins = t_wrf5key_h2-ccins
                                  merch = t_wrf5key_h2-merch
                                  bezei = t_wrf5key_h2-bezei.

    IF sy-subrc <> 0.
      t_wrf5key = t_wrf5key_h2.
      PERFORM convert_cdchgid_to_msgfn USING ' '
                                             t_wrf5key-msgfn.
      APPEND t_wrf5key.
    ENDIF.
  ENDLOOP.

  LOOP AT t_wrf6key_h2.
    READ TABLE t_wrf6key WITH KEY mandt = t_wrf6key_h2-mandt
                                  locnr = t_wrf6key_h2-locnr
                                  matkl = t_wrf6key_h2-matkl.
    IF sy-subrc <> 0.
      t_wrf6key = t_wrf6key_h2.
      PERFORM convert_cdchgid_to_msgfn USING ' '
                                             t_wrf6key-msgfn.
      APPEND t_wrf6key.
    ENDIF.
  ENDLOOP.

  LOOP AT t_t023wkey_h2.
    READ TABLE t_t023wkey WITH KEY mandt = t_t023wkey_h2-mandt
                                   locnr = t_t023wkey_h2-locnr
                                   matkl = t_t023wkey_h2-matkl.
    IF sy-subrc <> 0.
      t_t023wkey = t_t023wkey_h2.
      PERFORM convert_cdchgid_to_msgfn USING ' '
                                             t_t023wkey-msgfn.
      APPEND t_t023wkey.
    ENDIF.
  ENDLOOP.

  LOOP AT t_t023xkey_h2.
    READ TABLE t_t023xkey WITH KEY mandt = t_t023xkey_h2-mandt
                                   locnr = t_t023xkey_h2-locnr
                                   matnr = t_t023xkey_h2-matnr.
    IF sy-subrc <> 0.
      t_t023xkey = t_t023xkey_h2.
      PERFORM convert_cdchgid_to_msgfn USING ' '
                                             t_t023xkey-msgfn.
      APPEND t_t023xkey.
    ENDIF.
  ENDLOOP.
*mi/46c end

  LOOP AT t_knvdkey_h2.
    READ TABLE t_knvdkey WITH KEY mandt = t_knvdkey_h2-mandt
                                  kunnr = t_knvdkey_h2-kunnr
                                  vkorg = t_knvdkey_h2-vkorg
                                  vtweg = t_knvdkey_h2-vtweg
                                  spart = t_knvdkey_h2-spart
                                  doctp = t_knvdkey_h2-doctp
                                  spras = t_knvdkey_h2-spras.
    IF sy-subrc <> 0.
      t_knvdkey = t_knvdkey_h2.
      PERFORM convert_cdchgid_to_msgfn USING ' '
                                             t_knvdkey-msgfn.
      APPEND t_knvdkey.
    ENDIF.
  ENDLOOP.

  LOOP AT t_knvkkey_h2.
    READ TABLE t_knvkkey WITH KEY mandt = t_knvkkey_h2-mandt
                                  kunnr = t_knvkkey_h2-kunnr
                                  parnr = t_knvkkey_h2-parnr.
    IF sy-subrc <> 0.
      t_knvkkey = t_knvkkey_h2.
      PERFORM convert_cdchgid_to_msgfn USING ' '
                                             t_knvkkey-msgfn.
      APPEND t_knvkkey.
    ENDIF.
  ENDLOOP.

  LOOP AT t_knvlkey_h2.
    READ TABLE t_knvlkey WITH KEY mandt = t_knvlkey_h2-mandt
                                  kunnr = t_knvlkey_h2-kunnr
                                  aland = t_knvlkey_h2-aland
                                  tatyp = t_knvlkey_h2-tatyp
                                  licnr = t_knvlkey_h2-licnr.
    IF sy-subrc <> 0.
      t_knvlkey = t_knvlkey_h2.
      PERFORM convert_cdchgid_to_msgfn USING ' '
                                             t_knvlkey-msgfn.
      APPEND t_knvlkey.
    ENDIF.
  ENDLOOP.

  LOOP AT t_knvpkey_h2.
    READ TABLE t_knvpkey WITH KEY mandt = t_knvpkey_h2-mandt
                                  kunnr = t_knvpkey_h2-kunnr
                                  vkorg = t_knvpkey_h2-vkorg
                                  vtweg = t_knvpkey_h2-vtweg
                                  spart = t_knvpkey_h2-spart
                                  parvw = t_knvpkey_h2-parvw
                                  parza = t_knvpkey_h2-parza
                                  BINARY SEARCH.
    IF sy-subrc <> 0.
      t_knvpkey = t_knvpkey_h2.
      PERFORM convert_cdchgid_to_msgfn USING ' '
                                             t_knvpkey-msgfn.
      IF sy-subrc = 4.
        INSERT t_knvpkey INDEX sy-tabix.
      ELSE.
        APPEND t_knvpkey.
      ENDIF.
    ENDIF.
  ENDLOOP.

  LOOP AT t_knbwkey_h2.
    READ TABLE t_knbwkey WITH KEY mandt = t_knbwkey_h2-mandt
                                  kunnr = t_knbwkey_h2-kunnr
                                  bukrs = t_knbwkey_h2-bukrs
                                  witht = t_knbwkey_h2-witht
                         BINARY SEARCH.
    lv_tabix = sy-tabix.
    IF sy-subrc <> 0.
      t_knbwkey = t_knbwkey_h2.
      PERFORM convert_cdchgid_to_msgfn USING ' '
                                             t_knbwkey-msgfn.
      INSERT t_knbwkey INDEX lv_tabix.
    ENDIF.
  ENDLOOP.

  LOOP AT t_knatkey_h2.
    READ TABLE t_knatkey WITH KEY mandt = t_knatkey_h2-mandt
                                  kunnr = t_knatkey_h2-kunnr
                                  taxgr = t_knatkey_h2-taxgr.
    IF sy-subrc <> 0.
      t_knatkey = t_knatkey_h2.
      PERFORM convert_cdchgid_to_msgfn USING ' '
                                             t_knatkey-msgfn.
      APPEND t_knatkey.
    ENDIF.
  ENDLOOP.

* create KNKA Keys and KNKK-Keys
* Pre 3.1 Logic!
* loop at t_kna1key where mandt = sy-mandt.
*
*   select single * from knka where kunnr = t_kna1key-kunnr.
*   move-corresponding knka to t_knkakey.
*   perform convert_cdchgid_to_msgfn using 'S'
*                                          t_knkakey-msgfn.
*   append t_knkakey.
*
*   select * from knkk where kunnr = t_kna1key-kunnr.
*     move-corresponding knkk to t_knkkkey.
*     perform convert_cdchgid_to_msgfn using 'S'
*                                            t_knkkkey-msgfn.
*     append t_knkkkey.
*   endselect.
*
* endloop.                             "at t_kna1key

  IF NOT t_vcnumkey_h1[] IS INITIAL.     "\BE Note 498652
* Add VCKUN keys for changed VCNUM entries.
    SORT t_vcnumkey_h1 BY mandt ccins ccnum.
    DELETE ADJACENT DUPLICATES FROM t_vcnumkey_h1
      COMPARING mandt ccins ccnum.

* Fill t_vcnumkey_h2 so that it contains only VCNUM keys for
* credit cards that are used by customers, i.e. in table VCKUN.
    DATA: BEGIN OF lt_vckun OCCURS 200.
            INCLUDE STRUCTURE vckun.
          DATA: END OF lt_vckun.
    DATA: BEGIN OF ltt_vckun OCCURS 200.
            INCLUDE STRUCTURE vckun.
          DATA: END OF ltt_vckun.
    REFRESH ltt_vckun.
    LOOP AT t_vcnumkey_h1.
      REFRESH lt_vckun.
      CALL FUNCTION 'CCARDEC_BP_SELECT'
        EXPORTING
          i_ccins         = t_vcnumkey_h1-ccins
          i_ccnum         = t_vcnumkey_h1-ccnum
          i_decrypt       = 'X'
        TABLES
          t_vckun         = lt_vckun
        EXCEPTIONS
          vckun_not_found = 1
          vcnum_not_found = 2
          OTHERS          = 3.
      APPEND LINES OF lt_vckun TO ltt_vckun.
    ENDLOOP.
    LOOP AT ltt_vckun.
      MOVE ltt_vckun-mandt TO t_vckunkey_h1-mandt.
      MOVE ltt_vckun-kunnr TO t_vckunkey_h1-kunnr.
      MOVE ltt_vckun-ccins TO t_vckunkey_h1-ccins.
      MOVE ltt_vckun-ccnum TO t_vckunkey_h1-ccnum.
      APPEND t_vckunkey_h1.
    ENDLOOP.

    SORT t_vckunkey_h1 BY mandt ccins ccnum.

    LOOP AT t_vcnumkey.
*   If the credit card data is used by a customer, and this customer
*   is not already in t_vckunkey, add it.
      READ TABLE t_vckunkey_h1 WITH KEY mandt = t_vcnumkey-mandt
                                        ccins = t_vcnumkey-ccins
                                        ccnum = t_vcnumkey-ccnum
                               BINARY SEARCH.
      IF sy-subrc = 0.        "If credit card used by a customer
        READ TABLE t_vckunkey WITH KEY mandt = t_vcnumkey-mandt
                                       ccins = t_vcnumkey-ccins
                                       ccnum = t_vcnumkey-ccnum.
        IF sy-subrc <> 0.
          t_vckunkey-mandt = t_vckunkey_h1-mandt.
          t_vckunkey-kunnr = t_vckunkey_h1-kunnr.
          t_vckunkey-ccins = t_vckunkey_h1-ccins.
          t_vckunkey-ccnum = t_vckunkey_h1-ccnum.
          t_vckunkey-msgfn = t_vcnumkey-msgfn.
          APPEND t_vckunkey.
        ELSE.
          MODIFY t_vckunkey INDEX sy-tabix.
        ENDIF.
      ENDIF.
    ENDLOOP.
  ENDIF.        "\BE Note 498652

* Now we have all customers where a credit card has been changed.
* Now add all existing credit cards for the customers taken into account
  REFRESH t_vckunkey_h2[].
  t_vckunkey_h1[] = t_vckunkey[].
  SORT t_vckunkey_h1 BY mandt kunnr.
  DELETE ADJACENT DUPLICATES FROM t_vckunkey_h1.
  LOOP AT t_vckunkey_h1.
    SELECT * FROM vckun APPENDING CORRESPONDING FIELDS OF TABLE t_vckunkey_h2
        WHERE kunnr = t_vckunkey_h1-kunnr.
  ENDLOOP.
  SORT t_vckunkey BY mandt kunnr ccins ccnum.
  LOOP AT t_vckunkey_h2.
    READ TABLE t_vckunkey WITH KEY mandt = t_vckunkey_h2-mandt
                                   kunnr = t_vckunkey_h2-kunnr
                                   ccins =  t_vckunkey_h2-ccins
                                   ccnum =  t_vckunkey_h2-ccnum
                          BINARY SEARCH.
    IF sy-subrc NE 0.
      lv_subrc = sy-subrc.
      lv_tabix = sy-tabix.
      t_vckunkey-mandt = t_vckunkey_h2-mandt.
      t_vckunkey-kunnr = t_vckunkey_h2-kunnr.
      t_vckunkey-ccins = t_vckunkey_h2-ccins.
      t_vckunkey-ccnum = t_vckunkey_h2-ccnum.
      PERFORM convert_cdchgid_to_msgfn USING ' ' t_vckunkey-msgfn.
      IF  lv_subrc = 4.
        INSERT t_vckunkey INDEX lv_tabix.
      ELSE.
        APPEND t_vckunkey.
      ENDIF.
    ENDIF.
  ENDLOOP.

* Now we have all customers where a dunning data has been changed.
* Now add all existing dunning for the customers taken into account
  REFRESH t_knb5key_h2[].
  t_knb5key_h1[] = t_knb5key[].
  SORT t_knb5key_h1 BY mandt kunnr bukrs.
  DELETE ADJACENT DUPLICATES FROM t_knb5key_h1
         COMPARING mandt kunnr bukrs.
  LOOP AT t_knb5key_h1.
    SELECT * FROM knb5
             APPENDING CORRESPONDING FIELDS OF TABLE t_knb5key_h2
             WHERE kunnr = t_knb5key_h1-kunnr AND
                   bukrs = t_knb5key_h1-bukrs.
  ENDLOOP.
  SORT t_knb5key BY mandt kunnr bukrs maber.
  LOOP AT t_knb5key_h2.
    READ TABLE t_knb5key WITH KEY mandt = t_knb5key_h2-mandt
                                  kunnr = t_knb5key_h2-kunnr
                                  bukrs = t_knb5key_h2-bukrs
                                  maber = t_knb5key_h2-maber
                         BINARY SEARCH.
    IF sy-subrc NE 0.
      lv_subrc = sy-subrc.
      lv_tabix = sy-tabix.
      t_knb5key-mandt = t_knb5key_h2-mandt.
      t_knb5key-kunnr  = t_knb5key_h2-kunnr.
      t_knb5key-bukrs  = t_knb5key_h2-bukrs.
      t_knb5key-maber  = t_knb5key_h2-maber.
      PERFORM convert_cdchgid_to_msgfn USING ' ' t_knb5key-msgfn.
      IF lv_subrc = 4.
        INSERT t_knb5key INDEX lv_tabix.
      ELSE.
        APPEND t_knb5key.
      ENDIF.
    ENDIF.
  ENDLOOP.

* create KNVV Keys for every KNVP record
  CLEAR f_knvvkey.
  LOOP AT t_knvpkey.
*   Not necessary to read t_knvvkey each time
    IF t_knvpkey-mandt NE f_knvvkey-mandt OR
       t_knvpkey-kunnr NE f_knvvkey-kunnr OR
       t_knvpkey-vkorg NE f_knvvkey-vkorg OR
       t_knvpkey-vtweg NE f_knvvkey-vtweg OR
       t_knvpkey-spart NE f_knvvkey-spart.

      MOVE-CORRESPONDING t_knvpkey TO f_knvvkey.
      READ TABLE t_knvvkey WITH KEY f_knvvkey.
      IF sy-subrc <> 0.
        MOVE f_knvvkey-mandt TO t_knvvkey-mandt.
        MOVE f_knvvkey-kunnr TO t_knvvkey-kunnr.
        MOVE f_knvvkey-vkorg TO t_knvvkey-vkorg.
        MOVE f_knvvkey-vtweg TO t_knvvkey-vtweg.
        MOVE f_knvvkey-spart TO t_knvvkey-spart.
        PERFORM convert_cdchgid_to_msgfn USING 'S'
                                               t_knvvkey-msgfn.
        APPEND t_knvvkey.
      ENDIF.
    ENDIF.
  ENDLOOP.

* create KNVV Keys for every KNVD record
  LOOP AT t_knvdkey.
    MOVE-CORRESPONDING t_knvdkey TO f_knvvkey.
    READ TABLE t_knvvkey WITH KEY f_knvvkey.
    IF sy-subrc <> 0.
      MOVE f_knvvkey-mandt TO t_knvvkey-mandt.
      MOVE f_knvvkey-kunnr TO t_knvvkey-kunnr.
      MOVE f_knvvkey-vkorg TO t_knvvkey-vkorg.
      MOVE f_knvvkey-vtweg TO t_knvvkey-vtweg.
      MOVE f_knvvkey-spart TO t_knvvkey-spart.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_knvvkey-msgfn.
      APPEND t_knvvkey.
    ENDIF.
  ENDLOOP.

* create KNVV Keys for every KNVI record
  LOOP AT t_knvikey.
    CLEAR lv_land.
    SELECT * FROM knvv WHERE kunnr = t_knvikey-kunnr.
      CHECK lv_land IS INITIAL.
      MOVE-CORRESPONDING knvv TO ls_knvvkey_knvi.
      PERFORM get_sales_area_tax_indicators
                  TABLES lt_sales_area_knvi
                  USING  ls_knvvkey_knvi.
      READ TABLE lt_sales_area_knvi WITH KEY kunnr = t_knvikey-kunnr
                                             aland = t_knvikey-aland.
      CHECK sy-subrc = 0.
      lv_land = 'X'.
      MOVE-CORRESPONDING knvv TO f_knvvkey.
      READ TABLE t_knvvkey WITH KEY f_knvvkey.
      IF sy-subrc <> 0.
        MOVE f_knvvkey-mandt TO t_knvvkey-mandt.
        MOVE f_knvvkey-kunnr TO t_knvvkey-kunnr.
        MOVE f_knvvkey-vkorg TO t_knvvkey-vkorg.
        MOVE f_knvvkey-vtweg TO t_knvvkey-vtweg.
        MOVE f_knvvkey-spart TO t_knvvkey-spart.
        PERFORM convert_cdchgid_to_msgfn USING 'S'
                                               t_knvvkey-msgfn.
        APPEND t_knvvkey.
      ENDIF.
    ENDSELECT.
*   EXIT.
  ENDLOOP.

* create KNVV Keys for every KNVL record
  LOOP AT t_knvlkey.
    SELECT * FROM knvv WHERE kunnr = t_knvlkey-kunnr.
      MOVE-CORRESPONDING knvv TO f_knvvkey.
      READ TABLE t_knvvkey WITH KEY f_knvvkey.
      IF sy-subrc <> 0.
        MOVE f_knvvkey-mandt TO t_knvvkey-mandt.
        MOVE f_knvvkey-kunnr TO t_knvvkey-kunnr.
        MOVE f_knvvkey-vkorg TO t_knvvkey-vkorg.
        MOVE f_knvvkey-vtweg TO t_knvvkey-vtweg.
        MOVE f_knvvkey-spart TO t_knvvkey-spart.
        PERFORM convert_cdchgid_to_msgfn USING 'S'
                                               t_knvvkey-msgfn.
        APPEND t_knvvkey.
      ENDIF.
    ENDSELECT.
*   EXIT.
  ENDLOOP.

* create KNA1 Keys for every KNVV record
  LOOP AT t_knvvkey.
    MOVE-CORRESPONDING t_knvvkey TO f_kna1key.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.

* create KNB1 Keys for every KNB5 record
  LOOP AT t_knb5key.
    MOVE-CORRESPONDING t_knb5key TO f_knb1key.
    READ TABLE t_knb1key WITH KEY f_knb1key.
    IF sy-subrc <> 0.
      MOVE f_knb1key-mandt TO t_knb1key-mandt.
      MOVE f_knb1key-kunnr TO t_knb1key-kunnr.
      MOVE f_knb1key-bukrs TO t_knb1key-bukrs.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_knb1key-msgfn.
      APPEND t_knb1key.
    ENDIF.
  ENDLOOP.

* create KNB1 Keys for every KNBW record
  LOOP AT t_knbwkey.
    MOVE-CORRESPONDING t_knbwkey TO f_knb1key.
    READ TABLE t_knb1key WITH KEY f_knb1key.
    IF sy-subrc <> 0.
      MOVE f_knb1key-mandt TO t_knb1key-mandt.
      MOVE f_knb1key-kunnr TO t_knb1key-kunnr.
      MOVE f_knb1key-bukrs TO t_knb1key-bukrs.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_knb1key-msgfn.
      APPEND t_knb1key.
    ENDIF.
  ENDLOOP.

* create KNA1 Keys for every KNB1 record
  LOOP AT t_knb1key.
    MOVE-CORRESPONDING t_knb1key TO f_kna1key.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.

* create KNA1 Keys for every KNBK record
  LOOP AT t_knbkkey.
    MOVE-CORRESPONDING t_knbkkey TO f_kna1key.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.

* create KNA1 Keys for every KNVA record
  LOOP AT t_knvakey.
    MOVE-CORRESPONDING t_knvakey TO f_kna1key.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.

*mi/46a begin
* create KNA1 Keys for every WRF12 record
  LOOP AT t_wrf12key.
    MOVE-CORRESPONDING t_wrf12key TO f_kna1key.
    f_kna1key-kunnr = t_wrf12key-locnr.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.

* create KNA1 Keys for every WRF4 record
  LOOP AT t_wrf4key.
    MOVE-CORRESPONDING t_wrf4key TO f_kna1key.
    f_kna1key-kunnr = t_wrf4key-locnr.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.
*mi/46a end

*mi/46c begin
* create KNA1 Keys for every WRF1 record
  LOOP AT t_wrf1key.
    MOVE-CORRESPONDING t_wrf1key TO f_kna1key.
    f_kna1key-kunnr = t_wrf1key-locnr.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.

* create KNA1 Keys for every WRF3 record
  LOOP AT t_wrf3key.
    MOVE-CORRESPONDING t_wrf3key TO f_kna1key.
    f_kna1key-kunnr = t_wrf3key-locnr.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.

* create KNA1 Keys for every WRF5 record
  LOOP AT t_wrf5key.
    MOVE-CORRESPONDING t_wrf5key TO f_kna1key.
    f_kna1key-kunnr = t_wrf5key-locnr.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.

* create KNA1 Keys for every WRF6 record
  LOOP AT t_wrf6key.
    MOVE-CORRESPONDING t_wrf6key TO f_kna1key.
    f_kna1key-kunnr = t_wrf6key-locnr.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.

* create KNA1 Keys for every T023W record
  LOOP AT t_t023wkey.
    MOVE-CORRESPONDING t_t023wkey TO f_kna1key.
    f_kna1key-kunnr = t_t023wkey-locnr.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.

* create KNA1 Keys for every T023X record
  LOOP AT t_t023xkey.
    MOVE-CORRESPONDING t_t023xkey TO f_kna1key.
    f_kna1key-kunnr = t_t023xkey-locnr.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.
*mi/46c end

* create KNA1 Keys for every KNVK record
  LOOP AT t_knvkkey.
    MOVE-CORRESPONDING t_knvkkey TO f_kna1key.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.

* create KNA1 Keys for every KNEX record
  LOOP AT t_knexkey.
    MOVE-CORRESPONDING t_knexkey TO f_kna1key.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.

* create KNA1 Keys for every KNAS record
  LOOP AT t_knaskey.
    MOVE-CORRESPONDING t_knaskey TO f_kna1key.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.

* create KNA1 Keys for every KNKA record
  LOOP AT t_knkakey.
    MOVE-CORRESPONDING t_knkakey TO f_kna1key.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.

* create KNA1 Keys for every KNKK record
  LOOP AT t_knkkkey.
    MOVE-CORRESPONDING t_knkkkey TO f_kna1key.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.

* create KNA1 Keys for every VCKUN record
  LOOP AT t_vckunkey.
    MOVE-CORRESPONDING t_vckunkey TO f_kna1key.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.

* create KNA1 Keys for every KNAT record
  LOOP AT t_knatkey.
    MOVE-CORRESPONDING t_knatkey TO f_kna1key.
    READ TABLE t_kna1key WITH KEY f_kna1key.
    IF sy-subrc <> 0.
      MOVE f_kna1key-mandt TO t_kna1key-mandt.
      MOVE f_kna1key-kunnr TO t_kna1key-kunnr.
      PERFORM convert_cdchgid_to_msgfn USING 'S'
                                             t_kna1key-msgfn.
      APPEND t_kna1key.
    ENDIF.
  ENDLOOP.


  SORT t_kna1key BY mandt kunnr.
  SORT t_knaskey BY mandt kunnr land1.
  SORT t_knb1key BY mandt kunnr bukrs.
  SORT t_knb5key BY mandt kunnr bukrs maber.
  SORT t_knbkkey BY mandt kunnr banks bankl bankn.
  SORT t_knexkey BY mandt kunnr lndex.
  SORT t_knkakey BY mandt kunnr.
  SORT t_knkkkey BY mandt kunnr kkber.
  SORT t_knvakey BY mandt kunnr ablad.
*mi/46a begin
  SORT t_wrf12key BY mandt locnr empst.
  SORT t_wrf4key BY mandt locnr abtnr.
*mi/46a end
*mi/46c begin
  SORT t_wrf1key BY mandt locnr.
  SORT t_wrf3key BY mandt locnr matkl datbi datab loclb.
  SORT t_wrf5key BY mandt locnr ccins merch.
  SORT t_wrf6key BY mandt locnr matkl.
  SORT t_t023wkey BY mandt locnr matkl.
  SORT t_t023xkey BY mandt locnr matnr.
*mi/46c end
  SORT t_knvdkey BY mandt kunnr vkorg vtweg spart doctp spras.
  SORT t_knvikey BY mandt kunnr aland tatyp.
  SORT t_knvkkey BY mandt kunnr parnr.
  SORT t_knvlkey BY mandt kunnr aland tatyp licnr.
  SORT t_knvpkey BY mandt kunnr vkorg vtweg spart parvw parza.
  SORT t_knvvkey BY mandt kunnr vkorg vtweg spart.
  SORT t_vckunkey BY mandt kunnr ccins ccnum.
  SORT t_cpident_deb BY mandt kunnr.
* SORT T_KNBWKEY BY MANDT KUNNR BUKRS WITHT.
  SORT t_knatkey BY mandt kunnr taxgr.


* initialize counter variables for created idocs
  created_m_idocs = 0.
  created_c_idocs = 0.
  done_since_commit = 0.

  CLEAR t_cpident. REFRESH t_cpident.

* call of the idoc creater for every debitor
  LOOP AT t_serial.

    READ TABLE t_kna1key WITH KEY mandt = sy-mandt
                                  kunnr = t_serial-kunnr
                         BINARY SEARCH.

    IF sy-subrc <> 0.
      CONTINUE.
    ENDIF.

    CLEAR   f_kna1.
    REFRESH t_knas.
    CLEAR   t_knas.
    REFRESH t_knb1.
    CLEAR   t_knb1.
    REFRESH t_knb5.
    CLEAR   t_knb5.
    REFRESH t_knbk.
    CLEAR   t_knbk.
    REFRESH t_knex.
    CLEAR   t_knex.
    REFRESH t_knka.
    CLEAR   t_knka.
    REFRESH t_knkk.
    CLEAR   t_knkk.
    REFRESH t_knva.
    CLEAR   t_knva.
*mi/46a begin
    REFRESH t_wrf12.
    CLEAR   t_wrf12.
    REFRESH t_wrf4.
    CLEAR   t_wrf4.
*mi/46a end
*mi/46c begin
    REFRESH t_wrf1.
    CLEAR   t_wrf1.
    REFRESH t_wrf3.
    CLEAR   t_wrf3.
    REFRESH t_wrf5.
    CLEAR   t_wrf5.
    REFRESH t_wrf6.
    CLEAR   t_wrf6.
    REFRESH t_t023w.
    CLEAR   t_t023w.
    REFRESH t_t023x.
    CLEAR   t_t023x.
*mi/46c end
    REFRESH t_knvd.
    CLEAR   t_knvd.
    REFRESH t_knvi.
    CLEAR   t_knvi.
    REFRESH t_knvk.
    CLEAR   t_knvk.
    REFRESH t_knvl.
    CLEAR   t_knvl.
    REFRESH t_knvp.
    CLEAR   t_knvp.
    REFRESH t_knvv.
    CLEAR   t_knvv.
    REFRESH t_vckun.
    CLEAR   t_vckun.
    REFRESH t_knbw.
    CLEAR   t_knbw.
    REFRESH t_knat.
    CLEAR   t_knat.

    MOVE-CORRESPONDING t_kna1key TO f_kna1.

*    LOOP AT t_knaskey WHERE mandt = f_kna1-mandt
*                      AND   kunnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_knaskey TO t_knas.
*      APPEND t_knas.
*
*    ENDLOOP.
    READ TABLE t_knaskey WITH KEY mandt = f_kna1-mandt
                                  kunnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_knaskey FROM lv_tabix ASSIGNING <fs_knaskey>.
        IF <fs_knaskey>-mandt = f_kna1-mandt
           AND <fs_knaskey>-kunnr = f_kna1-kunnr.
          APPEND <fs_knaskey> TO t_knas.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_knb1key WHERE mandt = f_kna1-mandt
*                      AND   kunnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_knb1key TO t_knb1.
*      APPEND t_knb1.
*
*    ENDLOOP.
    READ TABLE t_knb1key WITH KEY mandt = f_kna1-mandt
                                  kunnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_knb1key FROM lv_tabix ASSIGNING <fs_knb1key>.
        IF <fs_knb1key>-mandt = f_kna1-mandt
           AND <fs_knb1key>-kunnr = f_kna1-kunnr.
          APPEND <fs_knb1key> TO t_knb1.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_knb5key WHERE mandt = f_kna1-mandt
*                      AND   kunnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_knb5key TO t_knb5.
*      APPEND t_knb5.
*
*    ENDLOOP.
    READ TABLE t_knb5key WITH KEY mandt = f_kna1-mandt
                                  kunnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_knb5key FROM lv_tabix ASSIGNING <fs_knb5key>.
        IF <fs_knb5key>-mandt = f_kna1-mandt
           AND <fs_knb5key>-kunnr = f_kna1-kunnr.
          APPEND <fs_knb5key> TO t_knb5.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_knexkey WHERE mandt = f_kna1-mandt
*                      AND   kunnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_knexkey TO t_knex.
*      APPEND t_knex.
*
*    ENDLOOP.
    READ TABLE t_knexkey WITH KEY mandt = f_kna1-mandt
                                  kunnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_knexkey FROM lv_tabix ASSIGNING <fs_knexkey>.
        IF <fs_knexkey>-mandt = f_kna1-mandt
           AND <fs_knexkey>-kunnr = f_kna1-kunnr.
          APPEND <fs_knexkey> TO t_knex.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_knbkkey WHERE mandt = f_kna1-mandt
*                      AND   kunnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_knbkkey TO t_knbk.
*      APPEND t_knbk.
*
*    ENDLOOP.
    READ TABLE t_knbkkey WITH KEY mandt = f_kna1-mandt
                                  kunnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_knbkkey FROM lv_tabix ASSIGNING <fs_knbkkey>.
        IF <fs_knbkkey>-mandt = f_kna1-mandt
           AND <fs_knbkkey>-kunnr = f_kna1-kunnr.
          APPEND <fs_knbkkey> TO t_knbk.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_knkakey WHERE mandt = f_kna1-mandt
*                      AND   kunnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_knkakey TO t_knka.
*      APPEND t_knka.
*
*    ENDLOOP.
    READ TABLE t_knkakey WITH KEY mandt = f_kna1-mandt
                                  kunnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_knkakey FROM lv_tabix ASSIGNING <fs_knkakey>.
        IF <fs_knkakey>-mandt = f_kna1-mandt
           AND <fs_knkakey>-kunnr = f_kna1-kunnr.
          APPEND <fs_knkakey> TO t_knka.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_knkkkey WHERE mandt = f_kna1-mandt
*                      AND   kunnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_knkkkey TO t_knkk.
*      APPEND t_knkk.
*
*    ENDLOOP.
    READ TABLE t_knkkkey WITH KEY mandt = f_kna1-mandt
                                  kunnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_knkkkey FROM lv_tabix ASSIGNING <fs_knkkkey>.
        IF <fs_knkkkey>-mandt = f_kna1-mandt
           AND <fs_knkkkey>-kunnr = f_kna1-kunnr.
          APPEND <fs_knkkkey> TO t_knkk.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_knvakey WHERE mandt = f_kna1-mandt
*                      AND   kunnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_knvakey TO t_knva.
*      APPEND t_knva.
*
*    ENDLOOP.
    READ TABLE t_knvakey WITH KEY mandt = f_kna1-mandt
                                  kunnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_knvakey FROM lv_tabix ASSIGNING <fs_knvakey>.
        IF <fs_knvakey>-mandt = f_kna1-mandt
           AND <fs_knvakey>-kunnr = f_kna1-kunnr.
          APPEND <fs_knvakey> TO t_knva.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*mi/46a begin
*    LOOP AT t_wrf12key WHERE mandt = f_kna1-mandt
*                       AND   locnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_wrf12key TO t_wrf12.
*      APPEND t_wrf12.
*
*    ENDLOOP.
    READ TABLE t_wrf12key WITH KEY mandt = f_kna1-mandt
                                   locnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_wrf12key FROM lv_tabix ASSIGNING <fs_wrf12key>.
        IF <fs_wrf12key>-mandt = f_kna1-mandt
           AND <fs_wrf12key>-locnr = f_kna1-kunnr.
          APPEND <fs_wrf12key> TO t_wrf12.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_wrf4key WHERE mandt = f_kna1-mandt
*                      AND   locnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_wrf4key TO t_wrf4.
*      APPEND t_wrf4.
*
*    ENDLOOP.
*mi/46a end
    READ TABLE t_wrf4key WITH KEY mandt = f_kna1-mandt
                                  locnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_wrf4key FROM lv_tabix ASSIGNING <fs_wrf4key>.
        IF <fs_wrf4key>-mandt = f_kna1-mandt
           AND <fs_wrf4key>-locnr = f_kna1-kunnr.
          APPEND <fs_wrf4key> TO t_wrf4.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*mi/46c begin
*    LOOP AT t_wrf1key WHERE mandt = f_kna1-mandt
*                      AND   locnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_wrf1key TO t_wrf1.
*      APPEND t_wrf1.
*
*    ENDLOOP.
    READ TABLE t_wrf1key WITH KEY mandt = f_kna1-mandt
                                  locnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_wrf1key FROM lv_tabix ASSIGNING <fs_wrf1key>.
        IF <fs_wrf1key>-mandt = f_kna1-mandt
           AND <fs_wrf1key>-locnr = f_kna1-kunnr.
          APPEND <fs_wrf1key> TO t_wrf1.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_wrf3key WHERE mandt = f_kna1-mandt
*                      AND   locnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_wrf3key TO t_wrf3.
*      APPEND t_wrf3.
*
*    ENDLOOP.
    READ TABLE t_wrf3key WITH KEY mandt = f_kna1-mandt
                                  locnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_wrf3key FROM lv_tabix ASSIGNING <fs_wrf3key>.
        IF <fs_wrf3key>-mandt = f_kna1-mandt
           AND <fs_wrf3key>-locnr = f_kna1-kunnr.
          APPEND <fs_wrf3key> TO t_wrf3.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_wrf5key WHERE mandt = f_kna1-mandt
*                      AND   locnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_wrf5key TO t_wrf5.
*      APPEND t_wrf5.
*
*    ENDLOOP.
    READ TABLE t_wrf5key WITH KEY mandt = f_kna1-mandt
                                  locnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_wrf5key FROM lv_tabix ASSIGNING <fs_wrf5key>.
        IF <fs_wrf5key>-mandt = f_kna1-mandt
           AND <fs_wrf5key>-locnr = f_kna1-kunnr.
          APPEND <fs_wrf5key> TO t_wrf5.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_wrf6key WHERE mandt = f_kna1-mandt
*                      AND   locnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_wrf6key TO t_wrf6.
*      APPEND t_wrf6.
*
*    ENDLOOP.
    READ TABLE t_wrf6key WITH KEY mandt = f_kna1-mandt
                                  locnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_wrf6key FROM lv_tabix ASSIGNING <fs_wrf6key>.
        IF <fs_wrf6key>-mandt = f_kna1-mandt
           AND <fs_wrf6key>-locnr = f_kna1-kunnr.
          APPEND <fs_wrf6key> TO t_wrf6.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_t023wkey WHERE mandt = f_kna1-mandt
*                       AND   locnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_t023wkey TO t_t023w.
*      APPEND t_t023w.
*
*    ENDLOOP.
    READ TABLE t_t023wkey WITH KEY mandt = f_kna1-mandt
                                   locnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_t023wkey FROM lv_tabix ASSIGNING <fs_t023wkey>.
        IF <fs_t023wkey>-mandt = f_kna1-mandt
           AND <fs_t023wkey>-locnr = f_kna1-kunnr.
          APPEND <fs_t023wkey> TO t_t023w.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_t023xkey WHERE mandt = f_kna1-mandt
*                       AND   locnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_t023xkey TO t_t023x.
*      APPEND t_t023x.
*
*    ENDLOOP.
*mi/46c end
    READ TABLE t_t023xkey WITH KEY mandt = f_kna1-mandt
                                   locnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_t023xkey FROM lv_tabix ASSIGNING <fs_t023xkey>.
        IF <fs_t023xkey>-mandt = f_kna1-mandt
           AND <fs_t023xkey>-locnr = f_kna1-kunnr.
          APPEND <fs_t023xkey> TO t_t023x.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_knvdkey WHERE mandt = f_kna1-mandt
*                      AND   kunnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_knvdkey TO t_knvd.
*      APPEND t_knvd.
*
*    ENDLOOP.
    READ TABLE t_knvdkey WITH KEY mandt = f_kna1-mandt
                                  kunnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_knvdkey FROM lv_tabix ASSIGNING <fs_knvdkey>.
        IF <fs_knvdkey>-mandt = f_kna1-mandt
           AND <fs_knvdkey>-kunnr = f_kna1-kunnr.
          APPEND <fs_knvdkey> TO t_knvd.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_knvikey WHERE mandt = f_kna1-mandt
*                      AND   kunnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_knvikey TO t_knvi.
*      APPEND t_knvi.
*
*    ENDLOOP.
    READ TABLE t_knvikey WITH KEY mandt = f_kna1-mandt
                                  kunnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_knvikey FROM lv_tabix ASSIGNING <fs_knvikey>.
        IF <fs_knvikey>-mandt = f_kna1-mandt
           AND <fs_knvikey>-kunnr = f_kna1-kunnr.
          APPEND <fs_knvikey> TO t_knvi.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_knvkkey WHERE mandt = f_kna1-mandt
*                      AND   kunnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_knvkkey TO t_knvk.
*      APPEND t_knvk.
*
*    ENDLOOP.
    READ TABLE t_knvkkey WITH KEY mandt = f_kna1-mandt
                                  kunnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_knvkkey FROM lv_tabix ASSIGNING <fs_knvkkey>.
        IF <fs_knvkkey>-mandt = f_kna1-mandt
           AND <fs_knvkkey>-kunnr = f_kna1-kunnr.
          APPEND <fs_knvkkey> TO t_knvk.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_knvlkey WHERE mandt = f_kna1-mandt
*                      AND   kunnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_knvlkey TO t_knvl.
*      APPEND t_knvl.
*
*    ENDLOOP.
    READ TABLE t_knvlkey WITH KEY mandt = f_kna1-mandt
                                  kunnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_knvlkey FROM lv_tabix ASSIGNING <fs_knvlkey>.
        IF <fs_knvlkey>-mandt = f_kna1-mandt
           AND <fs_knvlkey>-kunnr = f_kna1-kunnr.
          APPEND <fs_knvlkey> TO t_knvl.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_knvpkey WHERE mandt = f_kna1-mandt
*                      AND   kunnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_knvpkey TO t_knvp.
*      APPEND t_knvp.
*
*    ENDLOOP.
    READ TABLE t_knvpkey WITH KEY mandt = f_kna1-mandt
                                  kunnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_knvpkey FROM lv_tabix ASSIGNING <fs_knvpkey>.
        IF <fs_knvpkey>-mandt = f_kna1-mandt
           AND <fs_knvpkey>-kunnr = f_kna1-kunnr.
          APPEND <fs_knvpkey> TO t_knvp.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_knvvkey WHERE mandt = f_kna1-mandt
*                      AND   kunnr = f_kna1-kunnr.
*
*      MOVE-CORRESPONDING t_knvvkey TO t_knvv.
*      APPEND t_knvv.
*
*    ENDLOOP.
    READ TABLE t_knvvkey WITH KEY mandt = f_kna1-mandt
                                  kunnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_knvvkey FROM lv_tabix ASSIGNING <fs_knvvkey>.
        IF <fs_knvvkey>-mandt = f_kna1-mandt
           AND <fs_knvvkey>-kunnr = f_kna1-kunnr.
          APPEND <fs_knvvkey> TO t_knvv.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

*    LOOP AT t_vckunkey WHERE mandt = f_kna1-mandt
*                       AND   kunnr = f_kna1-kunnr.
*
*      APPEND t_vckunkey TO t_vckun.
*
*    ENDLOOP.
    READ TABLE t_vckunkey WITH KEY mandt = f_kna1-mandt
                                   kunnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_vckunkey FROM lv_tabix ASSIGNING <fs_vckunkey>.
        IF <fs_vckunkey>-mandt = f_kna1-mandt
           AND <fs_vckunkey>-kunnr = f_kna1-kunnr.
          APPEND <fs_vckunkey> TO t_vckun.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

    READ TABLE t_knbwkey WITH KEY mandt = f_kna1-mandt
                                  kunnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_knbwkey FROM lv_tabix ASSIGNING <fs_knbwkey>.
        IF <fs_knbwkey>-mandt = f_kna1-mandt
           AND <fs_knbwkey>-kunnr = f_kna1-kunnr.
* T_KNBW ist damit auch sortiert.
          APPEND <fs_knbwkey> TO t_knbw.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.


    LOOP AT t_knatkey WHERE mandt = f_kna1-mandt
                      AND   kunnr = f_kna1-kunnr.

      MOVE-CORRESPONDING t_knatkey TO t_knat.
      APPEND t_knat.

    ENDLOOP.


* Begin of insertion note 450069 / mh.
* Fill text deletions per customer in global table.
    REFRESH gt_text_deletions_cp.
    LOOP AT lt_text_deletions_cp WHERE kunnr = f_kna1-kunnr.
      APPEND lt_text_deletions_cp TO gt_text_deletions_cp.
    ENDLOOP.
* End of insertion note 450069 / mh.

    REFRESH gt_credit_text_deletions_cp.
    LOOP AT lt_credit_text_deletions_cp INTO lv_credit_text_cp
                                      WHERE kunnr = f_kna1-kunnr.
      APPEND lv_credit_text_cp TO gt_credit_text_deletions_cp.
    ENDLOOP.

*   Add entries for unchanged segments if the customer has been added
*   to a listing.
    IF need_to_resend = c_true.

      READ TABLE t_resend WITH KEY kunnr = f_kna1-kunnr
                          BINARY SEARCH.

      IF sy-subrc = 0.
        PERFORM insert_keys TABLES t_knas
                                   t_knb1
                                   t_knb5
                                   t_knbk
                                   t_knex
                                   t_knka
                                   t_knkk
                                   t_knva
                                   t_wrf12                  "mi/46a
                                   t_wrf4                   "mi/46a
                                   t_wrf1                   "mi/46c
                                   t_wrf3                   "mi/46c
                                   t_wrf5                   "mi/46c
                                   t_wrf6                   "mi/46c
                                   t_t023w                  "mi/46c
                                   t_t023x                  "mi/46c
                                   t_knvd
                                   t_knvi
                                   t_knvk
                                   t_knvl
                                   t_knvp
                                   t_knvv
                                   t_vckun
                                   t_knbw
                                   lt_knvk_adr              "\BE 517173
                                   t_knat
                            USING  f_kna1-kunnr
                                   message_type.

* \BE Note 517173 - B
        CLEAR lv_rcvprn.
* Senden der Adressdaten von Kunden anstossen.
        PERFORM sending_zav_adress_debi_kred
          USING f_kna1-kunnr  'K'  lv_rcvprn.
* Sender der Adressdaten von Ansprechpartnern anstossen.
        PERFORM sending_zav_address_co_pa
          TABLES lt_knvk_adr
          USING  f_kna1-kunnr  'K'  lv_rcvprn .
* \BE Note 517173 - E
      ENDIF.
    ENDIF.

    CALL FUNCTION 'MASTERIDOC_CREATE_DEBMAS'
      EXPORTING
        kna1key            = f_kna1
        rcvpfc             = ' '
        rcvprn             = '         '
        rcvprt             = ' '
        sndpfc             = ' '
        sndprn             = '         '
        sndprt             = ' '
        message_type       = message_type
        serial             = t_serial-cretime
      IMPORTING
        created_comm_idocs = created_comm_idocs
      TABLES
        knaskey            = t_knas
        knb1key            = t_knb1
        knb5key            = t_knb5
        knbkkey            = t_knbk
        knexkey            = t_knex
        knkakey            = t_knka
        knkkkey            = t_knkk
        knvakey            = t_knva
        wrf12key           = t_wrf12                        "mi/46a
        wrf4key            = t_wrf4                         "mi/46a
        wrf1key            = t_wrf1                         "mi/46c
        wrf3key            = t_wrf3                         "mi/46c
        wrf5key            = t_wrf5                         "mi/46c
        wrf6key            = t_wrf6                         "mi/46c
        t023wkey           = t_t023w                        "mi/46c
        t023xkey           = t_t023x                        "mi/46c
        knvdkey            = t_knvd
        knvikey            = t_knvi
        knvkkey            = t_knvk
        knvlkey            = t_knvl
        knvpkey            = t_knvp
        knvvkey            = t_knvv
        vckunkey           = t_vckun
        knbwkey            = t_knbw
        knatkey            = t_knat.

    created_m_idocs = created_m_idocs + 1.
    created_c_idocs = created_c_idocs + created_comm_idocs.
*   DONE_SINCE_COMMIT = DONE_SINCE_COMMIT + 1.
*                    Ansonsten evtl. Überlauf in Sperrtabelle
*\BE 22.10.99 Vorgehen verfeinert, damit Änderungspointer als
*             verarbeitet markiert werden, falls aufgrund der Filterung
*             Kommunikationsidocs erzeugt werden.
*   DONE_SINCE_COMMIT = DONE_SINCE_COMMIT + CREATED_COMM_IDOCS.
    IF created_comm_idocs = 0.
      done_since_commit = done_since_commit + 1.
    ELSE.
      done_since_commit = done_since_commit + created_comm_idocs.
    ENDIF.
*\BE 22.10.99 Ende

* append all processed pointer for the debitor
*    LOOP AT T_CPIDENT_DEB ASSIGNING <FS_CPIDENT_DEB>
*                          WHERE KUNNR = F_KNA1-KUNNR.
*      T_CPIDENT-CPIDENT = <FS_CPIDENT_DEB>-CPIDENT.
*      APPEND t_cpident.
*    ENDLOOP.
    READ TABLE t_cpident_deb WITH KEY kunnr = f_kna1-kunnr
                         BINARY SEARCH
                         TRANSPORTING NO FIELDS.
    lv_tabix = sy-tabix.
    IF sy-subrc = 0.
      LOOP AT t_cpident_deb FROM lv_tabix
           ASSIGNING <fs_cpident_deb>.
        IF <fs_cpident_deb>-kunnr = f_kna1-kunnr.
          t_cpident-cpident = <fs_cpident_deb>-cpident.
          APPEND t_cpident.
        ELSE.
          EXIT.
        ENDIF.
      ENDLOOP.
    ENDIF.

    IF done_since_commit >= c_idocs_before_commit.
      done_since_commit = 0.

* write staus of all processed pointers
      CALL FUNCTION 'CHANGE_POINTERS_STATUS_WRITE'
        EXPORTING
          message_type           = message_type
        TABLES
          change_pointers_idents = t_cpident.

      CALL FUNCTION 'DB_COMMIT'.
      CALL FUNCTION 'DEQUEUE_ALL'.
      COMMIT WORK.

      CLEAR t_cpident. REFRESH t_cpident.

    ENDIF.

  ENDLOOP.                             "at t_kna1key

* commit if necassary
  IF done_since_commit > 0.

* write staus of all processed pointers
    CALL FUNCTION 'CHANGE_POINTERS_STATUS_WRITE'
      EXPORTING
        message_type           = message_type
      TABLES
        change_pointers_idents = t_cpident.

    CALL FUNCTION 'DB_COMMIT'.
    CALL FUNCTION 'DEQUEUE_ALL'.
    COMMIT WORK.

  ENDIF.

  MESSAGE ID 'B1' TYPE 'I' NUMBER '038'
          WITH created_m_idocs message_type.
  MESSAGE ID 'B1' TYPE 'I' NUMBER '039'
          WITH created_c_idocs message_type.

** start_EoP adaptation
** Read back internal guideline note 1998910 before starting delivering a correction
  IF cl_vs_switch_check=>cmd_vmd_cvp_ilm_sfw_01( ) IS NOT INITIAL.
    INCLUDE erp_cvp_i1_c_ale0033 IF FOUND.
  ENDIF.
** end_EoP_adaptation
ENDFUNCTION.
