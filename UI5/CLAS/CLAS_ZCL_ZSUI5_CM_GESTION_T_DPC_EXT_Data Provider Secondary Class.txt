
class ZCL_ZSUI5_CM_GESTION_T_DPC_EXT definition
  public
  inheriting from ZCL_ZSUI5_CM_GESTION_T_DPC
  create public .

public section.

  methods /IWBEP/IF_MGW_APPL_SRV_RUNTIME~CREATE_DEEP_ENTITY
    redefinition .
  methods /IWBEP/IF_MGW_APPL_SRV_RUNTIME~EXECUTE_ACTION
    redefinition .
protected section.

  methods AYUDAALMACENESSE_GET_ENTITYSET
    redefinition .
  methods AYUDACLIENTESDES_GET_ENTITYSET
    redefinition .
  methods AYUDACONDUCTORSE_GET_ENTITYSET
    redefinition .
  methods AYUDADESTINATARI_GET_ENTITYSET
    redefinition .
  methods AYUDAMOTIVOPEDID_GET_ENTITYSET
    redefinition .
  methods AYUDATIPOPALLETS_GET_ENTITYSET
    redefinition .
  methods AYUDATRANSPORT01_GET_ENTITYSET
    redefinition .
  methods ENTREGASTRANSPOR_GET_ENTITY
    redefinition .
  methods ENTREGASTRANSPOR_GET_ENTITYSET
    redefinition .
  methods MATERIALESDEVSET_GET_ENTITYSET
    redefinition .
  methods MATERIALESSET_GET_ENTITYSET
    redefinition .
  methods POSICIONESENTREG_GET_ENTITYSET
    redefinition .
  methods TRANSPORTESSET_GET_ENTITYSET
    redefinition .
  methods AYUDAPUESTOEXPED_GET_ENTITYSET
    redefinition .
private section.

  methods CUSTOME_CREATE_DEEP_ENTREGAS
    importing
      !IV_ENTITY_NAME type STRING
      !IV_ENTITY_SET_NAME type STRING
      !IV_SOURCE_NAME type STRING
      !IT_KEY_TAB type /IWBEP/T_MGW_NAME_VALUE_PAIR
      !IT_NAVIGATION_PATH type /IWBEP/T_MGW_NAVIGATION_PATH
      !IO_EXPAND type ref to /IWBEP/IF_MGW_ODATA_EXPAND
      !IO_TECH_REQUEST_CONTEXT type ref to /IWBEP/IF_MGW_REQ_ENTITY_C
      !IO_DATA_PROVIDER type ref to /IWBEP/IF_MGW_ENTRY_PROVIDER
    exporting
      !ER_DEEP_ENTITY type ZCL_ZSUI5_CM_GESTION_T_MPC_EXT=>TS_DEEP_ENTITY_ENTREGA
      !ER_RETURN type BAPIRET2_T .
  methods CUSTOME_CREATE_DEEP_TRANSPORTE
    importing
      !IV_ENTITY_NAME type STRING
      !IV_ENTITY_SET_NAME type STRING
      !IV_SOURCE_NAME type STRING
      !IT_KEY_TAB type /IWBEP/T_MGW_NAME_VALUE_PAIR
      !IT_NAVIGATION_PATH type /IWBEP/T_MGW_NAVIGATION_PATH
      !IO_EXPAND type ref to /IWBEP/IF_MGW_ODATA_EXPAND
      !IO_TECH_REQUEST_CONTEXT type ref to /IWBEP/IF_MGW_REQ_ENTITY_C
      !IO_DATA_PROVIDER type ref to /IWBEP/IF_MGW_ENTRY_PROVIDER
    exporting
      !ER_DEEP_ENTITY type ZCL_ZSUI5_CM_GESTION_T_MPC_EXT=>TS_DEEP_ENTITY_TRANSPORTE
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION
      /IWBEP/CX_MGW_TECH_EXCEPTION .
endclass. "ZCL_ZSUI5_CM_GESTION_T_DPC_EXT definition
class ZCL_ZSUI5_CM_GESTION_T_DPC_EXT implementation.
  METHOD /iwbep/if_mgw_appl_srv_runtime~create_deep_entity.
    DATA: custome_create_deep_trans   TYPE zcl_zsui5_cm_gestion_t_mpc_ext=>ts_deep_entity_transporte,
          custome_create_deep_entrega TYPE zcl_zsui5_cm_gestion_t_mpc_ext=>ts_deep_entity_entrega,
          lt_return                   TYPE bapiret2_t.

    CASE iv_entity_set_name.
*      WHEN 'TransportesSet'.
*        CALL METHOD me->custome_create_deep_transporte
*          EXPORTING
*            iv_entity_name          = iv_entity_name
*            iv_entity_set_name      = iv_entity_set_name
*            iv_source_name          = iv_source_name
*            it_key_tab              = it_key_tab
*            it_navigation_path      = it_navigation_path
*            io_expand               = io_expand
*            io_tech_request_context = io_tech_request_context
*            io_data_provider        = io_data_provider
*          IMPORTING
*            er_deep_entity          = custome_create_deep_trans.
*
*        copy_data_to_ref(
*          EXPORTING
*          is_data = custome_create_deep_trans
*          CHANGING
*          cr_data = er_deep_entity
*          ).
      WHEN 'EntregasTransporteSet'.
        CALL METHOD me->custome_create_deep_entregas
          EXPORTING
            iv_entity_name          = iv_entity_name
            iv_entity_set_name      = iv_entity_set_name
            iv_source_name          = iv_source_name
            it_key_tab              = it_key_tab
            it_navigation_path      = it_navigation_path
            io_expand               = io_expand
            io_tech_request_context = io_tech_request_context
            io_data_provider        = io_data_provider
          IMPORTING
            er_return               = lt_return
            er_deep_entity          = custome_create_deep_entrega.

        LOOP AT lt_return INTO DATA(ls_return) WHERE type NE 'E' AND type NE 'A' AND type NE ''.
          APPEND INITIAL LINE TO custome_create_deep_entrega-mensajesentregadeep ASSIGNING FIELD-SYMBOL(<ls_mensaje>).
          <ls_mensaje>-type = ls_return-type.
          MESSAGE ID ls_return-id TYPE ls_return-type NUMBER ls_return-number
            WITH ls_return-message_v1 ls_return-message_v2 ls_return-message_v3 ls_return-message_v4 INTO   <ls_mensaje>-mensaje.

          IF ls_return-id = 'V1' AND ls_return-number = '150'.
            <ls_mensaje>-warning = 'X'.
          ENDIF.
        ENDLOOP.

        copy_data_to_ref(
          EXPORTING
          is_data = custome_create_deep_entrega
          CHANGING
          cr_data = er_deep_entity
          ).
        READ TABLE lt_return TRANSPORTING NO FIELDS WITH KEY type = 'E'.
        IF sy-subrc NE 0.

          DATA(io_message_container) = /iwbep/if_mgw_conv_srv_runtime~get_message_container( ).

*          io_message_container->add_messages_from_bapi(
*             it_bapi_messages = lt_return
*             iv_add_to_response_header = abap_true
*             iv_determine_leading_msg = /iwbep/if_message_container=>gcs_leading_msg_search_option-first
*           ).

        ELSE.
          DATA(lo_logger)            = /iwbep/if_mgw_conv_srv_runtime~get_logger( ).
          io_message_container = /iwbep/if_mgw_conv_srv_runtime~get_message_container( ).
          DATA(lv_error_category)    = /iwbep/if_message_container=>gcs_error_category-processing.

          io_message_container->add_messages_from_bapi(
             iv_error_category = lv_error_category
             it_bapi_messages = lt_return
              iv_add_to_response_header = abap_true
             iv_determine_leading_msg = /iwbep/if_message_container=>gcs_leading_msg_search_option-first
           ).

          RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception
            EXPORTING
              textid = /iwbep/cx_mgw_busi_exception=>business_error.

        ENDIF.
    ENDCASE.
  ENDMETHOD.
  METHOD /iwbep/if_mgw_appl_srv_runtime~execute_action.
    DATA:
      ls_parameter         TYPE /iwbep/s_mgw_name_value_pair,
      lo_logger            TYPE REF TO /iwbep/cl_cos_logger,
      io_message_container TYPE REF TO /iwbep/if_message_container,
      lv_error_category    TYPE /iwbep/if_message_container=>ty_error_category,
      lv_text              TYPE bapi_msg,
      ls_return            TYPE bapiret2,
      return               TYPE bapiret2_t.

    DATA:
      lv_borrado      TYPE flag,
      lv_devuelto     TYPE flag,
      lv_tknum        TYPE tknum,
      ts_mpc_borrar   TYPE zcl_zsui5_cm_gestion_t_mpc=>borrado,
      ts_mpc_devolver TYPE zcl_zsui5_cm_gestion_t_mpc=>devuelto,
      ls_montaje      TYPE zui5s_cm_montaje.

    CASE iv_action_name.

      WHEN 'BorrarTransporte'.
        IF it_parameter IS NOT INITIAL.

          READ TABLE it_parameter INTO ls_parameter WITH KEY name = 'Tknum'.
          IF sy-subrc = 0.
            lv_tknum = ls_parameter-value.
          ENDIF.

        ENDIF.

        CALL FUNCTION 'ZUI5_CM_BORRAR_TRANSPORTE'
          EXPORTING
            i_transporte = lv_tknum
          IMPORTING
            o_borrado    = lv_borrado
            o_return     = return.


        IF lv_borrado IS NOT INITIAL.
          ts_mpc_borrar-ok = lv_borrado.
          copy_data_to_ref(
           EXPORTING
             is_data = ts_mpc_borrar

           CHANGING
             cr_data = er_data ).

          io_message_container = /iwbep/if_mgw_conv_srv_runtime~get_message_container( ).

          io_message_container->add_messages_from_bapi(
             it_bapi_messages = return
             iv_add_to_response_header = abap_true
             iv_determine_leading_msg = /iwbep/if_message_container=>gcs_leading_msg_search_option-first
           ).
        ENDIF.

      WHEN 'DevolverTransporte'.
        IF it_parameter IS NOT INITIAL.

          READ TABLE it_parameter INTO ls_parameter WITH KEY name = 'Tknum'.
          IF sy-subrc = 0.
            lv_tknum = ls_parameter-value.
          ENDIF.

        ENDIF.

        CALL FUNCTION 'ZUI5_CM_DEVOLVER_TRANSPORTE'
          EXPORTING
            i_transporte = lv_tknum
          IMPORTING
            o_devuelto   = lv_devuelto
            o_return     = return.


        IF lv_devuelto IS NOT INITIAL.
          ts_mpc_devolver-ok = lv_devuelto.
          copy_data_to_ref(
           EXPORTING
             is_data = ts_mpc_devolver

           CHANGING
             cr_data = er_data ).

          io_message_container = /iwbep/if_mgw_conv_srv_runtime~get_message_container( ).

          io_message_container->add_messages_from_bapi(
             it_bapi_messages = return
             iv_add_to_response_header = abap_true
             iv_determine_leading_msg = /iwbep/if_message_container=>gcs_leading_msg_search_option-first
           ).
        ENDIF.
    ENDCASE.

    READ TABLE return WITH KEY type = 'E' TRANSPORTING NO FIELDS.
    IF sy-subrc EQ 0.
      lo_logger            = /iwbep/if_mgw_conv_srv_runtime~get_logger( ).
      io_message_container = /iwbep/if_mgw_conv_srv_runtime~get_message_container( ).
      lv_error_category    = /iwbep/if_message_container=>gcs_error_category-processing.

      io_message_container->add_messages_from_bapi(
         it_bapi_messages = return
         iv_determine_leading_msg = /iwbep/if_message_container=>gcs_leading_msg_search_option-first
       ).

      RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception
        EXPORTING
          textid = /iwbep/cx_mgw_busi_exception=>business_error.
    ENDIF.
  ENDMETHOD.
  METHOD ayudaalmacenesse_get_entityset.
*-------------------------------------------------------------
*  Data declaration
*-------------------------------------------------------------
    DATA e_data  TYPE zif_zui5_cm_get_almacenes=>zui5tt_cm_almacenes.
    DATA e_data_temp  TYPE zif_zui5_cm_get_almacenes=>zui5tt_cm_almacenes.
    DATA e_return  TYPE zif_zui5_cm_get_almacenes=>bapiret2_t.
    DATA ir_lgort  TYPE zif_zui5_cm_get_almacenes=>range_t_lgort_d.
    DATA ir_logbe  TYPE zif_zui5_cm_get_almacenes=>rseloption.
    DATA ir_werks  TYPE zif_zui5_cm_get_almacenes=>range_t_werks_d.
    DATA ls_e_data  TYPE LINE OF zif_zui5_cm_get_almacenes=>zui5tt_cm_almacenes.
    DATA ls_e_return  TYPE LINE OF zif_zui5_cm_get_almacenes=>bapiret2_t.
    DATA ls_ir_lgort  TYPE LINE OF zif_zui5_cm_get_almacenes=>range_t_lgort_d.
    DATA ls_ir_logbe  TYPE LINE OF zif_zui5_cm_get_almacenes=>rseloption.
    DATA ls_ir_werks  TYPE LINE OF zif_zui5_cm_get_almacenes=>range_t_werks_d.
    DATA lv_rfc_name TYPE tfdir-funcname.
    DATA lv_destination TYPE rfcdest.
    DATA lv_subrc TYPE syst-subrc.
    DATA lv_exc_msg TYPE /iwbep/mgw_bop_rfc_excep_text.
    DATA lx_root TYPE REF TO cx_root.
    DATA lo_filter TYPE  REF TO /iwbep/if_mgw_req_filter.
    DATA lt_filter_select_options TYPE /iwbep/t_mgw_select_option.
    DATA lv_filter_str TYPE string.
    DATA ls_paging TYPE /iwbep/s_mgw_paging.
    DATA ls_converted_keys LIKE LINE OF et_entityset.
    DATA lv_source_entity_set_name TYPE string.
    DATA ayudacentrosset_get_entityset TYPE LINE OF zcl_zsui5_cm_gestion_t_mpc=>tt_ayudacentros.
    DATA ls_filter TYPE /iwbep/s_mgw_select_option.
    DATA ls_filter_range TYPE /iwbep/s_cod_select_option.
    DATA lr_werks LIKE RANGE OF ls_converted_keys-werks.
    DATA ls_werks LIKE LINE OF lr_werks.
    DATA lr_lgort LIKE RANGE OF ls_converted_keys-lgort.
    DATA ls_lgort LIKE LINE OF lr_lgort.
    DATA lr_lgobe LIKE RANGE OF ls_converted_keys-lgobe.
    DATA ls_lgobe LIKE LINE OF lr_lgobe.
    DATA lo_dp_facade TYPE REF TO /iwbep/if_mgw_dp_facade.
    DATA ls_gw_e_data LIKE LINE OF et_entityset.
    DATA lv_skip     TYPE int4.
    DATA lv_top      TYPE int4.

    "MTS: Ajustes filtro OR
    DATA lt_filter_select_options_and TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_temp TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_or TYPE /iwbep/t_mgw_select_option.
    DATA lv_veces TYPE i.
    DATA posicion TYPE i.
    "MTS: Ajustes filtro OR

*-------------------------------------------------------------
*  Map the runtime request to the RFC - Only mapped attributes
*-------------------------------------------------------------
* Get all input information from the technical request context object
* Since DPC works with internal property names and runtime API interface holds external property names
* the process needs to get the all needed input information from the technical request context object
* Get filter or select option information
    lo_filter = io_tech_request_context->get_filter( ).
    lt_filter_select_options = lo_filter->get_filter_select_options( ).
    lv_filter_str = lo_filter->get_filter_string( ).

* Check if the supplied filter is supported by standard gateway runtime process
    IF  lv_filter_str            IS NOT INITIAL
    AND lt_filter_select_options IS INITIAL.
      " If the string of the Filter System Query Option is not automatically converted into
      " filter option table (lt_filter_select_options), then the filtering combination is not supported
      " Log message in the application log
*      me->/iwbep/if_sb_dpc_comm_services~log_message(
*        EXPORTING
*          iv_msg_type   = 'E'
*          iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
*          iv_msg_number = 025 ).
*      " Raise Exception
*      RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
*        EXPORTING
*          textid = /iwbep/cx_mgw_tech_exception=>internal_error.
      zcl_search_dpc=>filtros_or( EXPORTING iv_instancia = me iv_data = ls_gw_e_data IMPORTING et_filter_select_options_and = lt_filter_select_options_and et_filter_select_options_or = lt_filter_select_options_or ).
      "MTS: Ajustes filtro OR
    ENDIF.
    IF iv_search_string IS NOT INITIAL.
      zcl_search_dpc=>search_or( EXPORTING iv_instancia = me iv_search = iv_search_string iv_data = ls_gw_e_data it_filter_select_options = lt_filter_select_options
                 IMPORTING et_filter_select_options_or = lt_filter_select_options_or ).
    ENDIF.

* Get key table information
    io_tech_request_context->get_converted_source_keys(
      IMPORTING
        es_key_values  = ls_converted_keys ).

    ls_paging-top = io_tech_request_context->get_top( ).
    ls_paging-skip = io_tech_request_context->get_skip( ).

* Maps key fields to function module parameters
    IF it_key_tab IS NOT INITIAL.

      lv_source_entity_set_name = io_tech_request_context->get_source_entity_set_name( ).

      IF  lv_source_entity_set_name = 'AyudaCentrosSet'.
        " Convert keys to appropriate entity set structure
        io_tech_request_context->get_converted_source_keys(
          IMPORTING
            es_key_values  = ayudacentrosset_get_entityset ).
        ls_ir_werks-low = ayudacentrosset_get_entityset-werks. " Equivalent to 'Werks' property in the service
        ls_ir_werks-option = 'EQ'.
        ls_ir_werks-sign = 'I'.
        APPEND ls_ir_werks TO ir_werks.

      ENDIF.

    ENDIF.

    "MTS: Ajustes filtro OR
    IF lt_filter_select_options_or IS NOT INITIAL OR lt_filter_select_options_and IS NOT INITIAL.
      DESCRIBE TABLE lt_filter_select_options_or LINES lv_veces.
      IF lv_veces IS INITIAL.
        lv_veces = 1.
      ENDIF.
    ELSE.
      lv_veces = 1.
    ENDIF.

    CLEAR posicion.

    IF lt_filter_select_options IS NOT INITIAL.
      zcl_search_dpc=>filtro_mayusculas(
     EXPORTING
       iv_data = ls_gw_e_data
       CHANGING
       ct_filter_select_options = lt_filter_select_options ).

      APPEND LINES OF lt_filter_select_options TO lt_filter_select_options_and.
    ENDIF.

    DO lv_veces TIMES.
      CLEAR: e_data, ir_lgort, ir_logbe, ir_werks.

      ADD 1 TO posicion.
      READ TABLE lt_filter_select_options_or INTO DATA(ls_option_or) INDEX posicion.
      IF sy-subrc = 0.
        lt_filter_select_options = lt_filter_select_options_and.
        APPEND ls_option_or TO lt_filter_select_options.
      ENDIF.
      "MTS: Ajustes filtro OR

*      IF it_filter_select_options IS NOT INITIAL.

* Maps filter table lines to function module parameters
      LOOP AT lt_filter_select_options INTO ls_filter.

        CASE ls_filter-property.
          WHEN 'WERKS'.              " Equivalent to 'Werks' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_werks ).

            LOOP AT lr_werks INTO ls_werks.
              ls_ir_werks-high = ls_werks-high.
              ls_ir_werks-low = ls_werks-low.
              ls_ir_werks-option = ls_werks-option.
              ls_ir_werks-sign = ls_werks-sign.
              APPEND ls_ir_werks TO ir_werks.
            ENDLOOP.
            CLEAR lr_werks.
          WHEN 'LGORT'.              " Equivalent to 'Lgort' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_lgort ).

            LOOP AT lr_lgort INTO ls_lgort.
              ls_ir_lgort-high = ls_lgort-high.
              ls_ir_lgort-low = ls_lgort-low.
              ls_ir_lgort-option = ls_lgort-option.
              ls_ir_lgort-sign = ls_lgort-sign.
              APPEND ls_ir_lgort TO ir_lgort.
            ENDLOOP.
            CLEAR lr_lgort.
          WHEN 'LGORT_MULTIPLE'.
            READ TABLE ls_filter-select_options INDEX 1 INTO DATA(t_filter_selopt).
            IF t_filter_selopt IS NOT INITIAL.
              SPLIT t_filter_selopt-low AT ':' INTO TABLE DATA(t_lgort_mult).
              CLEAR: ls_filter-select_options, t_filter_selopt.
              LOOP AT t_lgort_mult INTO DATA(wa_lgort_mult).
                t_filter_selopt-sign = 'I'.
                t_filter_selopt-option = 'EQ'.
                t_filter_selopt-low = wa_lgort_mult.
                APPEND t_filter_selopt TO ls_filter-select_options.
              ENDLOOP.
              lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_lgort ).

              LOOP AT lr_lgort INTO ls_lgort.
                ls_ir_lgort-high = ls_lgort-high.
                ls_ir_lgort-low = ls_lgort-low.
                ls_ir_lgort-option = ls_lgort-option.
                ls_ir_lgort-sign = ls_lgort-sign.
                APPEND ls_ir_lgort TO ir_lgort.
              ENDLOOP.
              CLEAR lr_lgort.
            ENDIF.
          WHEN 'LGOBE'.              " Equivalent to 'Lgobe' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_lgobe ).

            LOOP AT lr_lgobe INTO ls_lgobe.
              ls_ir_logbe-high = ls_lgobe-high.
              ls_ir_logbe-low = ls_lgobe-low.
              ls_ir_logbe-option = ls_lgobe-option.
              ls_ir_logbe-sign = ls_lgobe-sign.
              APPEND ls_ir_logbe TO ir_logbe.
            ENDLOOP.
            CLEAR lr_lgobe.

          WHEN OTHERS.
*       SARCE INI 3###########################################
            " Log message in the application log
            IF NOT iv_search_string IS INITIAL.
              DATA(vv_jump_search) = 'X'.
              CONTINUE.
            ENDIF.
*      SARCE FIN 3###########################################
            " Log message in the application log
            me->/iwbep/if_sb_dpc_comm_services~log_message(
              EXPORTING
                iv_msg_type   = 'E'
                iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
                iv_msg_number = 020
                iv_msg_v1     = ls_filter-property ).
            " Raise Exception
            RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
              EXPORTING
                textid = /iwbep/cx_mgw_tech_exception=>internal_error.
        ENDCASE.

      ENDLOOP.

*      SARCE INI 4###########################################
      IF vv_jump_search = 'X'.
        vv_jump_search = ''.
        CONTINUE.
      ENDIF.
      "MTS: Ajustes
*      SARCE FIN 4###########################################

* Get RFC destination
      lo_dp_facade = /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ).
      lv_destination = /iwbep/cl_sb_gen_dpc_rt_util=>get_rfc_destination( io_dp_facade = lo_dp_facade ).

*-------------------------------------------------------------
*  Call RFC function module
*-------------------------------------------------------------
      lv_rfc_name = 'ZUI5_CM_GET_ALMACENES'.

      IF lv_destination IS INITIAL OR lv_destination EQ 'NONE'.

        TRY.
            CALL FUNCTION lv_rfc_name
              EXPORTING
                ir_werks       = ir_werks
                ir_lgort       = ir_lgort
                ir_logbe       = ir_logbe
              IMPORTING
                e_return       = e_return
                e_data         = e_data
              EXCEPTIONS
                system_failure = 1000 message lv_exc_msg
                OTHERS         = 1002.

            lv_subrc = sy-subrc.
*in case of co-deployment the exception is raised and needs to be caught
          CATCH cx_root INTO lx_root.
            lv_subrc = 1001.
            lv_exc_msg = lx_root->if_message~get_text( ).
        ENDTRY.

      ELSE.

        CALL FUNCTION lv_rfc_name DESTINATION lv_destination
          EXPORTING
            ir_werks              = ir_werks
            ir_lgort              = ir_lgort
            ir_logbe              = ir_logbe
          IMPORTING
            e_return              = e_return
            e_data                = e_data
          EXCEPTIONS
            system_failure        = 1000 MESSAGE lv_exc_msg
            communication_failure = 1001 MESSAGE lv_exc_msg
            OTHERS                = 1002.

        lv_subrc = sy-subrc.

      ENDIF.

      "MTS: Ajustes
      APPEND LINES OF e_data TO e_data_temp.

*-------------------------------------------------------------
*  Map the RFC response to the caller interface - Only mapped attributes
*-------------------------------------------------------------
*-------------------------------------------------------------
* Error and exception handling
*-------------------------------------------------------------
      IF lv_subrc <> 0.
* Execute the RFC exception handling process
        me->/iwbep/if_sb_dpc_comm_services~rfc_exception_handling(
          EXPORTING
            iv_subrc            = lv_subrc
            iv_exp_message_text = lv_exc_msg ).
      ENDIF.

      IF e_return IS NOT INITIAL.
        me->/iwbep/if_sb_dpc_comm_services~rfc_save_log(
          EXPORTING
            iv_entity_type = iv_entity_name
            it_return      = e_return
            it_key_tab     = it_key_tab ).
      ENDIF.



    ENDDO. "MTS Ajustes
    e_data = e_data_temp.

*-------------------------------------------------------------------------*
*             - Post Backend Call -
*-------------------------------------------------------------------------*
    IF ls_paging-skip IS NOT INITIAL.
*  If the Skip value was requested at runtime
*  the response table will provide backend entries from skip + 1, meaning start from skip +1
*  for example: skip=5 means to start get results from the 6th row
      lv_skip = ls_paging-skip + 1.
    ENDIF.
*  The Top value was requested at runtime but was not handled as part of the function interface
    IF  ls_paging-top <> 0
    AND lv_skip IS NOT INITIAL.
*  if lv_skip > 0 retrieve the entries from lv_skip + Top - 1
*  for example: skip=5 and top=2 means to start get results from the 6th row and end in row number 7
      lv_top = ls_paging-top + lv_skip - 1.
    ELSEIF ls_paging-top <> 0
    AND    lv_skip IS INITIAL.
      lv_top = ls_paging-top.
    ELSE.
      lv_top = lines( e_data ).
    ENDIF.

*    "Ordenamos
*    IF it_order IS NOT INITIAL.
*      SORT e_data BY zcl_search_dpc=>sort_string( EXPORTING iv_instancia = me ).
*      DELETE ADJACENT DUPLICATES FROM e_data.
*    ENDIF.

*  - Map properties from the backend to the Gateway output response table -

    LOOP AT e_data INTO ls_e_data
*  Provide the response entries according to the Top and Skip parameters that were provided at runtime
         FROM lv_skip TO lv_top.
*  Only fields that were mapped will be delivered to the response table
      ls_gw_e_data-werks = ls_e_data-werks.
      ls_gw_e_data-lgort = ls_e_data-lgort.
      ls_gw_e_data-lgobe = ls_e_data-lgobe.
      APPEND ls_gw_e_data TO et_entityset.
      CLEAR ls_gw_e_data.
    ENDLOOP.

    IF it_order IS NOT INITIAL.
      SORT et_entityset BY zcl_search_dpc=>sort_string( EXPORTING iv_instancia = me ).
      DELETE ADJACENT DUPLICATES FROM et_entityset.
    ENDIF.

  ENDMETHOD.
  METHOD ayudaclientesdes_get_entityset.
*-------------------------------------------------------------
*  Data declaration
*-------------------------------------------------------------
    DATA ir_kunnr  TYPE zif_zui5_cm_get_clientes_desti=>range_kunnr_tab.
    DATA ir_kunnr_name  TYPE zif_zui5_cm_get_clientes_desti=>zsuis_cm_nombres_rang.
    DATA ir_kunwe  TYPE zif_zui5_cm_get_clientes_desti=>range_kunnr_tab.
    DATA ir_kunwe_name  TYPE zif_zui5_cm_get_clientes_desti=>zsuis_cm_nombres_rang.
    DATA ir_werks  TYPE zif_zui5_cm_get_clientes_desti=>range_t_werks_d.
    DATA o_data  TYPE zif_zui5_cm_get_clientes_desti=>zscmtt_destinatarios_cliente.

    DATA o_return  TYPE zif_zui5_cm_get_clientes_desti=>bapiret2_t.
    DATA ls_ir_kunnr  TYPE LINE OF zif_zui5_cm_get_clientes_desti=>range_kunnr_tab.
    DATA ls_ir_kunnr_name  TYPE LINE OF zif_zui5_cm_get_clientes_desti=>zsuis_cm_nombres_rang.
    DATA ls_ir_kunwe  TYPE LINE OF zif_zui5_cm_get_clientes_desti=>range_kunnr_tab.
    DATA ls_ir_kunwe_name  TYPE LINE OF zif_zui5_cm_get_clientes_desti=>zsuis_cm_nombres_rang.
    DATA ls_ir_werks  TYPE LINE OF zif_zui5_cm_get_clientes_desti=>range_t_werks_d.
    DATA ls_o_data  TYPE LINE OF zif_zui5_cm_get_clientes_desti=>zscmtt_destinatarios_cliente.
    DATA ls_o_return  TYPE LINE OF zif_zui5_cm_get_clientes_desti=>bapiret2_t.
    DATA lv_rfc_name TYPE tfdir-funcname.
    DATA lv_destination TYPE rfcdest.
    DATA lv_subrc TYPE syst-subrc.
    DATA lv_exc_msg TYPE /iwbep/mgw_bop_rfc_excep_text.
    DATA lx_root TYPE REF TO cx_root.
    DATA lo_filter TYPE  REF TO /iwbep/if_mgw_req_filter.
    DATA lt_filter_select_options TYPE /iwbep/t_mgw_select_option.
    DATA lv_filter_str TYPE string.
    DATA ls_paging TYPE /iwbep/s_mgw_paging.
    DATA ls_converted_keys LIKE LINE OF et_entityset.
    DATA ls_filter TYPE /iwbep/s_mgw_select_option.
    DATA ls_filter_range TYPE /iwbep/s_cod_select_option.
    DATA lr_kunnr LIKE RANGE OF ls_converted_keys-kunnr.
    DATA ls_kunnr LIKE LINE OF lr_kunnr.
    DATA lr_name_kunnr LIKE RANGE OF ls_converted_keys-name_kunnr.
    DATA ls_name_kunnr LIKE LINE OF lr_name_kunnr.
    DATA lr_kunn2 LIKE RANGE OF ls_converted_keys-kunn2.
    DATA ls_kunn2 LIKE LINE OF lr_kunn2.
    DATA lr_name1_kunn2 LIKE RANGE OF ls_converted_keys-name1_kunn2.
    DATA ls_name1_kunn2 LIKE LINE OF lr_name1_kunn2.
    DATA lr_werks LIKE RANGE OF ls_converted_keys-werks.
    DATA ls_werks LIKE LINE OF lr_werks.
    DATA lo_dp_facade TYPE REF TO /iwbep/if_mgw_dp_facade.
    DATA ls_gw_o_data LIKE LINE OF et_entityset.
    DATA lv_skip     TYPE int4.
    DATA lv_top      TYPE int4.

    DATA ir_city  TYPE zif_zui5_cm_get_clientes_desti=>rseloption.
    DATA ir_street  TYPE zif_zui5_cm_get_clientes_desti=>rseloption.
    DATA ls_ir_city  TYPE LINE OF zif_zui5_cm_get_clientes_desti=>rseloption.
    DATA ls_ir_street  TYPE LINE OF zif_zui5_cm_get_clientes_desti=>rseloption.
    DATA lr_city LIKE RANGE OF ls_converted_keys-city.
    DATA ls_city LIKE LINE OF lr_city.
    DATA lr_street LIKE RANGE OF ls_converted_keys-street.
    DATA ls_street LIKE LINE OF lr_street.

    "MTS: Ajustes filtro OR
    DATA e_data_temp  TYPE zif_zui5_cm_get_clientes_desti=>zscmtt_destinatarios_cliente.
    DATA lt_filter_select_options_and TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_temp TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_or TYPE /iwbep/t_mgw_select_option.
    DATA lv_veces TYPE i.
    DATA posicion TYPE i.
    "MTS: Ajustes filtro OR

*-------------------------------------------------------------
*  Map the runtime request to the RFC - Only mapped attributes
*-------------------------------------------------------------
* Get all input information from the technical request context object
* Since DPC works with internal property names and runtime API interface holds external property names
* the process needs to get the all needed input information from the technical request context object
* Get filter or select option information
    lo_filter = io_tech_request_context->get_filter( ).
    lt_filter_select_options = lo_filter->get_filter_select_options( ).
    lv_filter_str = lo_filter->get_filter_string( ).
*    DATA(lt_tree) = io_tech_request_context->get_filter_expression_tree( ).
*    DATA(ls) = lt_tree->mo_filter_parser.
*    DATA ls_te TYPE REF TO /iwbep/if_mgw_expr_node.
*    ls->convert_expression_tree( CHANGING co_filter = ls_te ).
* Check if the supplied filter is supported by standard gateway runtime process
    IF  lv_filter_str            IS NOT INITIAL
    AND lt_filter_select_options IS INITIAL.
      " If the string of the Filter System Query Option is not automatically converted into
      " filter option table (lt_filter_select_options), then the filtering combination is not supported
      " Log message in the application log
*      me->/iwbep/if_sb_dpc_comm_services~log_message(
*        EXPORTING
*          iv_msg_type   = 'E'
*          iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
*          iv_msg_number = 025 ).
*      " Raise Exception
*      RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
*        EXPORTING
*          textid = /iwbep/cx_mgw_tech_exception=>internal_error.
      zcl_search_dpc=>filtros_or( EXPORTING iv_instancia = me iv_data = ls_gw_o_data IMPORTING et_filter_select_options_and = lt_filter_select_options_and et_filter_select_options_or = lt_filter_select_options_or ).
      "MTS: Ajustes filtro OR
    ENDIF.
    IF iv_search_string IS NOT INITIAL.
      zcl_search_dpc=>search_or( EXPORTING iv_instancia = me iv_search = iv_search_string iv_data = ls_gw_o_data it_filter_select_options = lt_filter_select_options
                 IMPORTING et_filter_select_options_or = lt_filter_select_options_or ).
    ENDIF.

* Get key table information
    io_tech_request_context->get_converted_source_keys(
      IMPORTING
        es_key_values  = ls_converted_keys ).

    ls_paging-top = io_tech_request_context->get_top( ).
    ls_paging-skip = io_tech_request_context->get_skip( ).

    "MTS: Ajustes filtro OR
    IF lt_filter_select_options_or IS NOT INITIAL OR lt_filter_select_options_and IS NOT INITIAL.
      DESCRIBE TABLE lt_filter_select_options_or LINES lv_veces.
      IF lv_veces IS INITIAL.
        lv_veces = 1.
      ENDIF.
    ELSE.
      lv_veces = 1.
    ENDIF.

    CLEAR posicion.

    IF lt_filter_select_options IS NOT INITIAL.
      zcl_search_dpc=>filtro_mayusculas(
     EXPORTING
       iv_data = ls_gw_o_data
       CHANGING
       ct_filter_select_options = lt_filter_select_options ).

      APPEND LINES OF lt_filter_select_options TO lt_filter_select_options_and.
    ENDIF.

    DO lv_veces TIMES.
      CLEAR: o_data, ir_kunnr, ir_kunnr_name, ir_kunwe, ir_kunwe_name, ir_werks, ir_city, ir_street.

      ADD 1 TO posicion.
      READ TABLE lt_filter_select_options_or INTO DATA(ls_option_or) INDEX posicion.
      IF sy-subrc = 0.
        lt_filter_select_options = lt_filter_select_options_and.
        APPEND ls_option_or TO lt_filter_select_options.
      ENDIF.
      "MTS: Ajustes filtro OR

* Maps filter table lines to function module parameters
      LOOP AT lt_filter_select_options INTO ls_filter.

        CASE ls_filter-property.
          WHEN 'KUNNR'.              " Equivalent to 'Cliente' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_kunnr ).

            LOOP AT lr_kunnr INTO ls_kunnr.
              ls_ir_kunnr-high = ls_kunnr-high.
              ls_ir_kunnr-low = ls_kunnr-low.
              ls_ir_kunnr-option = ls_kunnr-option.
              ls_ir_kunnr-sign = ls_kunnr-sign.
              APPEND ls_ir_kunnr TO ir_kunnr.
            ENDLOOP.
            CLEAR lr_kunnr.
          WHEN 'NAME_KUNNR'.              " Equivalent to 'NombreCliente' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_name_kunnr ).

            LOOP AT lr_name_kunnr INTO ls_name_kunnr.
              ls_ir_kunnr_name-high = ls_name_kunnr-high.
              ls_ir_kunnr_name-low = ls_name_kunnr-low.
              ls_ir_kunnr_name-option = ls_name_kunnr-option.
              ls_ir_kunnr_name-sign = ls_name_kunnr-sign.
              APPEND ls_ir_kunnr_name TO ir_kunnr_name.
            ENDLOOP.
            CLEAR lr_name_kunnr.
          WHEN 'KUNN2'.              " Equivalent to 'Destinatario' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_kunn2 ).

            LOOP AT lr_kunn2 INTO ls_kunn2.
              ls_ir_kunwe-high = ls_kunn2-high.
              ls_ir_kunwe-low = ls_kunn2-low.
              ls_ir_kunwe-option = ls_kunn2-option.
              ls_ir_kunwe-sign = ls_kunn2-sign.
              APPEND ls_ir_kunwe TO ir_kunwe.
            ENDLOOP.
            CLEAR lr_kunn2.
          WHEN 'NAME1_KUNN2'.              " Equivalent to 'NombreDestinatario' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_name1_kunn2 ).

            LOOP AT lr_name1_kunn2 INTO ls_name1_kunn2.
              ls_ir_kunwe_name-high = ls_name1_kunn2-high.
              ls_ir_kunwe_name-low = ls_name1_kunn2-low.
              ls_ir_kunwe_name-option = ls_name1_kunn2-option.
              ls_ir_kunwe_name-sign = ls_name1_kunn2-sign.
              APPEND ls_ir_kunwe_name TO ir_kunwe_name.
            ENDLOOP.
            CLEAR lr_name1_kunn2.
          WHEN 'WERKS'.              " Equivalent to 'Werks' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_werks ).

            LOOP AT lr_werks INTO ls_werks.
              ls_ir_werks-high = ls_werks-high.
              ls_ir_werks-low = ls_werks-low.
              ls_ir_werks-option = ls_werks-option.
              ls_ir_werks-sign = ls_werks-sign.
              APPEND ls_ir_werks TO ir_werks.
            ENDLOOP.
            CLEAR lr_werks.
          WHEN 'CITY'.              " Equivalent to 'Poblacion' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_city ).

            LOOP AT lr_city INTO ls_city.
              ls_ir_city-sign = ls_city-sign.
              ls_ir_city-option = ls_city-option.
              ls_ir_city-low = ls_city-low.
              ls_ir_city-high = ls_city-high.
              APPEND ls_ir_city TO ir_city.
            ENDLOOP.
            CLEAR lr_city.
          WHEN 'STREET'.              " Equivalent to 'Direccion' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_street ).

            LOOP AT lr_street INTO ls_street.
              ls_ir_street-sign = ls_street-sign.
              ls_ir_street-option = ls_street-option.
              ls_ir_street-low = ls_street-low.
              ls_ir_street-high = ls_street-high.
              APPEND ls_ir_street TO ir_street.
            ENDLOOP.
            CLEAR lr_street.
          WHEN OTHERS.
*       SARCE INI 3###########################################
            " Log message in the application log
            IF NOT iv_search_string IS INITIAL.
              DATA(vv_jump_search) = 'X'.
              CONTINUE.
            ENDIF.
*      SARCE FIN 3###########################################
            " Log message in the application log
            me->/iwbep/if_sb_dpc_comm_services~log_message(
              EXPORTING
                iv_msg_type   = 'E'
                iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
                iv_msg_number = 020
                iv_msg_v1     = ls_filter-property ).
            " Raise Exception
            RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
              EXPORTING
                textid = /iwbep/cx_mgw_tech_exception=>internal_error.
        ENDCASE.

      ENDLOOP.

*      SARCE INI 4###########################################
      IF vv_jump_search = 'X'.
        vv_jump_search = ''.
        CONTINUE.
      ENDIF.
      "MTS: Ajustes
*      SARCE FIN 4###########################################

* Get RFC destination
      lo_dp_facade = /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ).
      lv_destination = /iwbep/cl_sb_gen_dpc_rt_util=>get_rfc_destination( io_dp_facade = lo_dp_facade ).

*-------------------------------------------------------------
*  Call RFC function module
*-------------------------------------------------------------
      lv_rfc_name = 'ZUI5_CM_GET_CLIENTES_DESTINA'.

      IF lv_destination IS INITIAL OR lv_destination EQ 'NONE'.

        TRY.
            CALL FUNCTION lv_rfc_name
              EXPORTING
                ir_kunnr       = ir_kunnr
                ir_kunnr_name  = ir_kunnr_name
                ir_kunwe       = ir_kunwe
                ir_kunwe_name  = ir_kunwe_name
                ir_werks       = ir_werks
                ir_city        = ir_city
                ir_street      = ir_street
              IMPORTING
                o_return       = o_return
                o_data         = o_data
              EXCEPTIONS
                system_failure = 1000 message lv_exc_msg
                OTHERS         = 1002.

            lv_subrc = sy-subrc.
*in case of co-deployment the exception is raised and needs to be caught
          CATCH cx_root INTO lx_root.
            lv_subrc = 1001.
            lv_exc_msg = lx_root->if_message~get_text( ).
        ENDTRY.

      ELSE.

        CALL FUNCTION lv_rfc_name DESTINATION lv_destination
          EXPORTING
            ir_kunnr              = ir_kunnr
            ir_kunnr_name         = ir_kunnr_name
            ir_kunwe              = ir_kunwe
            ir_kunwe_name         = ir_kunwe_name
            ir_werks              = ir_werks
            ir_city               = ir_city
            ir_street             = ir_street
          IMPORTING
            o_return              = o_return
            o_data                = o_data
          EXCEPTIONS
            system_failure        = 1000 MESSAGE lv_exc_msg
            communication_failure = 1001 MESSAGE lv_exc_msg
            OTHERS                = 1002.

        lv_subrc = sy-subrc.

      ENDIF.

      "MTS: Ajustes
      APPEND LINES OF o_data TO e_data_temp.
*-------------------------------------------------------------
*  Map the RFC response to the caller interface - Only mapped attributes
*-------------------------------------------------------------
*-------------------------------------------------------------
* Error and exception handling
*-------------------------------------------------------------
      IF lv_subrc <> 0.
* Execute the RFC exception handling process
        me->/iwbep/if_sb_dpc_comm_services~rfc_exception_handling(
          EXPORTING
            iv_subrc            = lv_subrc
            iv_exp_message_text = lv_exc_msg ).
      ENDIF.

      IF o_return IS NOT INITIAL.
        me->/iwbep/if_sb_dpc_comm_services~rfc_save_log(
          EXPORTING
            iv_entity_type = iv_entity_name
            it_return      = o_return
            it_key_tab     = it_key_tab ).
      ENDIF.

    ENDDO. "MTS Ajustes
    o_data = e_data_temp.

*-------------------------------------------------------------------------*
*             - Post Backend Call -
*-------------------------------------------------------------------------*
    IF ls_paging-skip IS NOT INITIAL.
*  If the Skip value was requested at runtime
*  the response table will provide backend entries from skip + 1, meaning start from skip +1
*  for example: skip=5 means to start get results from the 6th row
      lv_skip = ls_paging-skip + 1.
    ENDIF.
*  The Top value was requested at runtime but was not handled as part of the function interface
    IF  ls_paging-top <> 0
    AND lv_skip IS NOT INITIAL.
*  if lv_skip > 0 retrieve the entries from lv_skip + Top - 1
*  for example: skip=5 and top=2 means to start get results from the 6th row and end in row number 7
      lv_top = ls_paging-top + lv_skip - 1.
    ELSEIF ls_paging-top <> 0
    AND    lv_skip IS INITIAL.
      lv_top = ls_paging-top.
    ELSE.
      lv_top = lines( o_data ).
    ENDIF.

    "Ordenamos
    IF it_order IS NOT INITIAL.
      SORT o_data BY zcl_search_dpc=>sort_string( EXPORTING iv_instancia = me ).
      DELETE ADJACENT DUPLICATES FROM o_data.
    ENDIF.

*  - Map properties from the backend to the Gateway output response table -

    LOOP AT o_data INTO ls_o_data
*  Provide the response entries according to the Top and Skip parameters that were provided at runtime
         FROM lv_skip TO lv_top.
*  Only fields that were mapped will be delivered to the response table
      ls_gw_o_data-kunnr = ls_o_data-kunnr.
      ls_gw_o_data-name_kunnr = ls_o_data-name_kunnr.
      ls_gw_o_data-kunn2 = ls_o_data-kunn2.
      ls_gw_o_data-name1_kunn2 = ls_o_data-name1_kunn2.
      ls_gw_o_data-werks = ls_o_data-werks.
      ls_gw_o_data-credito_excedido = ls_o_data-credito_excedido.
      ls_gw_o_data-city = ls_o_data-city.
      ls_gw_o_data-street = ls_o_data-street.
      APPEND ls_gw_o_data TO et_entityset.
      CLEAR ls_gw_o_data.
    ENDLOOP.

  ENDMETHOD.
  METHOD ayudaconductorse_get_entityset.
*-------------------------------------------------------------
*  Data declaration
*-------------------------------------------------------------
    DATA lo_filter TYPE  REF TO /iwbep/if_mgw_req_filter.
    DATA lt_filter_select_options TYPE /iwbep/t_mgw_select_option.
    DATA lv_filter_str TYPE string.
    DATA lv_max_hits TYPE i.
    DATA ls_paging TYPE /iwbep/s_mgw_paging.
    DATA ls_converted_keys LIKE LINE OF et_entityset.
    DATA ls_message TYPE bapiret2.
    DATA lt_selopt TYPE ddshselops.
    DATA ls_selopt LIKE LINE OF lt_selopt.
    DATA ls_filter TYPE /iwbep/s_mgw_select_option.
    DATA ls_filter_range TYPE /iwbep/s_cod_select_option.
    DATA lr_werks LIKE RANGE OF ls_converted_keys-werks.
    DATA ls_werks LIKE LINE OF lr_werks.
    DATA lr_lgort LIKE RANGE OF ls_converted_keys-lgort.
    DATA ls_lgort LIKE LINE OF lr_lgort.
    DATA lr_conductor LIKE RANGE OF ls_converted_keys-conductor.
    DATA ls_conductor LIKE LINE OF lr_conductor.
    DATA lr_dni LIKE RANGE OF ls_converted_keys-dni.
    DATA ls_dni LIKE LINE OF lr_dni.
    DATA lr_matricula LIKE RANGE OF ls_converted_keys-matricula.
    DATA ls_matricula LIKE LINE OF lr_matricula.
    DATA lr_remolque LIKE RANGE OF ls_converted_keys-remolque.
    DATA ls_remolque LIKE LINE OF lr_remolque.
    DATA lr_telefono LIKE RANGE OF ls_converted_keys-telefono.
    DATA ls_telefono LIKE LINE OF lr_telefono.
    DATA lt_result_list TYPE /iwbep/if_sb_gendpc_shlp_data=>tt_result_list.
    DATA lv_next TYPE i VALUE 1.
    DATA ls_entityset LIKE LINE OF et_entityset.
    DATA ls_result_list_next LIKE LINE OF lt_result_list.
    DATA ls_result_list LIKE LINE OF lt_result_list.

    "MTS: Ajustes filtro OR
    DATA lt_filter_select_options_and TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_temp TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_or TYPE /iwbep/t_mgw_select_option.
    DATA lt_entityset_temp TYPE zcl_zsui5_cm_gestion_t_mpc=>tt_ayudaconductor.
    DATA lv_veces TYPE i.
    DATA posicion TYPE i.
    "MTS: Ajustes filtro OR

*-------------------------------------------------------------
*  Map the runtime request to the Search Help select option - Only mapped attributes
*-------------------------------------------------------------
* Get all input information from the technical request context object
* Since DPC works with internal property names and runtime API interface holds external property names
* the process needs to get the all needed input information from the technical request context object
* Get filter or select option information
    lo_filter = io_tech_request_context->get_filter( ).
    lt_filter_select_options = lo_filter->get_filter_select_options( ).
    lv_filter_str = lo_filter->get_filter_string( ).

* Check if the supplied filter is supported by standard gateway runtime process
    IF  lv_filter_str            IS NOT INITIAL
    AND lt_filter_select_options IS INITIAL.
      " If the string of the Filter System Query Option is not automatically converted into
      " filter option table (lt_filter_select_options), then the filtering combination is not supported
      " Log message in the application log
*      me->/iwbep/if_sb_dpc_comm_services~log_message(
*        EXPORTING
*          iv_msg_type   = 'E'
*          iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
*          iv_msg_number = 025 ).
*      " Raise Exception
*      RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
*        EXPORTING
*          textid = /iwbep/cx_mgw_tech_exception=>internal_error.
      zcl_search_dpc=>filtros_or( EXPORTING iv_instancia = me iv_data = ls_entityset IMPORTING et_filter_select_options_and = lt_filter_select_options_and et_filter_select_options_or = lt_filter_select_options_or ).
      "MTS: Ajustes filtro OR
    ENDIF.
    IF iv_search_string IS NOT INITIAL.
      zcl_search_dpc=>search_or( EXPORTING iv_instancia = me iv_search = iv_search_string iv_data = ls_entityset it_filter_select_options = lt_filter_select_options
                 IMPORTING et_filter_select_options_or = lt_filter_select_options_or ).
    ENDIF.


* Get key table information
    io_tech_request_context->get_converted_source_keys(
      IMPORTING
        es_key_values  = ls_converted_keys ).

    ls_paging-top = io_tech_request_context->get_top( ).
    ls_paging-skip = io_tech_request_context->get_skip( ).

    " Calculate the number of max hits to be fetched from the function module
    " The lv_max_hits value is a summary of the Top and Skip values
    IF ls_paging-top > 0.
      lv_max_hits = is_paging-top + is_paging-skip.
    ENDIF.

    "MTS: Ajustes filtro OR
    IF lt_filter_select_options_or IS NOT INITIAL OR lt_filter_select_options_and IS NOT INITIAL.
      DESCRIBE TABLE lt_filter_select_options_or LINES lv_veces.
      IF lv_veces IS INITIAL.
        lv_veces = 1.
      ENDIF.
    ELSE.
      lv_veces = 1.
    ENDIF.

    CLEAR posicion.

    IF lt_filter_select_options IS NOT INITIAL.
      zcl_search_dpc=>filtro_mayusculas(
     EXPORTING
       iv_data = ls_entityset
       CHANGING
       ct_filter_select_options = lt_filter_select_options ).

      APPEND LINES OF lt_filter_select_options TO lt_filter_select_options_and.
    ENDIF.

    DO lv_veces TIMES.
      CLEAR: lt_result_list, ls_message, lt_selopt.

      ADD 1 TO posicion.
      READ TABLE lt_filter_select_options_or INTO DATA(ls_option_or) INDEX posicion.
      IF sy-subrc = 0.
        lt_filter_select_options = lt_filter_select_options_and.
        APPEND ls_option_or TO lt_filter_select_options.
      ELSE.
        lt_filter_select_options = lt_filter_select_options_and.
      ENDIF.
      "MTS: Ajustes filtro OR

* Maps filter table lines to the Search Help select option table
      LOOP AT lt_filter_select_options INTO ls_filter.

        CASE ls_filter-property.
          WHEN 'WERKS'.              " Equivalent to 'Werks' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_werks ).

            LOOP AT lr_werks INTO ls_werks.
              ls_selopt-sign = ls_werks-sign.
              ls_selopt-option = ls_werks-option.
              ls_selopt-low = ls_werks-low.
              ls_selopt-high = ls_werks-high.
              ls_selopt-shlpfield = 'WERKS'.
              ls_selopt-shlpname = 'ZCMH_CONDUCTORES'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.
          WHEN 'LGORT'.              " Equivalent to 'Lgort' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_lgort ).

            LOOP AT lr_lgort INTO ls_lgort.
              ls_selopt-sign = ls_lgort-sign.
              ls_selopt-option = ls_lgort-option.
              ls_selopt-low = ls_lgort-low.
              ls_selopt-high = ls_lgort-high.
              ls_selopt-shlpfield = 'LGORT'.
              ls_selopt-shlpname = 'ZCMH_CONDUCTORES'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.
          WHEN 'CONDUCTOR'.              " Equivalent to 'Conductor' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_conductor ).

            LOOP AT lr_conductor INTO ls_conductor.
              ls_selopt-sign = ls_conductor-sign.
              ls_selopt-option = ls_conductor-option.
              ls_selopt-low = ls_conductor-low.
              ls_selopt-high = ls_conductor-high.
              ls_selopt-shlpfield = 'CONDUCTOR'.
              ls_selopt-shlpname = 'ZCMH_CONDUCTORES'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.
          WHEN 'DNI'.              " Equivalent to 'Dni' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_dni ).

            LOOP AT lr_dni INTO ls_dni.
              ls_selopt-sign = ls_dni-sign.
              ls_selopt-option = ls_dni-option.
              ls_selopt-low = ls_dni-low.
              ls_selopt-high = ls_dni-high.
              ls_selopt-shlpfield = 'DNI'.
              ls_selopt-shlpname = 'ZCMH_CONDUCTORES'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.
          WHEN 'MATRICULA'.              " Equivalent to 'Matricula' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_matricula ).

            LOOP AT lr_matricula INTO ls_matricula.
              ls_selopt-sign = ls_matricula-sign.
              ls_selopt-option = ls_matricula-option.
              ls_selopt-low = ls_matricula-low.
              ls_selopt-high = ls_matricula-high.
              ls_selopt-shlpfield = 'MATRICULA'.
              ls_selopt-shlpname = 'ZCMH_CONDUCTORES'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.
          WHEN 'REMOLQUE'.              " Equivalent to 'Remolque' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_remolque ).

            LOOP AT lr_remolque INTO ls_remolque.
              ls_selopt-sign = ls_remolque-sign.
              ls_selopt-option = ls_remolque-option.
              ls_selopt-low = ls_remolque-low.
              ls_selopt-high = ls_remolque-high.
              ls_selopt-shlpfield = 'REMOLQUE'.
              ls_selopt-shlpname = 'ZCMH_CONDUCTORES'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.
          WHEN 'TELEFONO'.              " Equivalent to 'Telefono' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_telefono ).

            LOOP AT lr_telefono INTO ls_telefono.
              ls_selopt-sign = ls_telefono-sign.
              ls_selopt-option = ls_telefono-option.
              ls_selopt-low = ls_telefono-low.
              ls_selopt-high = ls_telefono-high.
              ls_selopt-shlpfield = 'TELEFONO'.
              ls_selopt-shlpname = 'ZCMH_CONDUCTORES'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.

          WHEN OTHERS.
*       sarce ini 3###########################################
            " Log message in the application log
            IF NOT iv_search_string IS INITIAL.
              DATA(vv_jump_search) = 'X'.
              CONTINUE.
            ENDIF.
*      SARCE FIN 3###########################################
            " Log message in the application log
            me->/iwbep/if_sb_dpc_comm_services~log_message(
              EXPORTING
                iv_msg_type   = 'E'
                iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
                iv_msg_number = 020
                iv_msg_v1     = ls_filter-property ).
            " Raise Exception
            RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
              EXPORTING
                textid = /iwbep/cx_mgw_tech_exception=>internal_error.
        ENDCASE.
      ENDLOOP.

*      SARCE INI 4###########################################
      IF vv_jump_search = 'X'.
        vv_jump_search = ''.
        CONTINUE.
      ENDIF.
      "MTS: Ajustes
*      SARCE FIN 4###########################################

*-------------------------------------------------------------
*  Call to Search Help get values mechanism
*-------------------------------------------------------------
* Get search help values
      me->/iwbep/if_sb_gendpc_shlp_data~get_search_help_values(
        EXPORTING
          iv_shlp_name = 'ZCMH_CONDUCTORES'
          iv_maxrows = lv_max_hits
          iv_sort = 'X'
          iv_call_shlt_exit = 'X'
          it_selopt = lt_selopt
        IMPORTING
          et_return_list = lt_result_list
          es_message = ls_message ).

*-------------------------------------------------------------
*  Map the Search Help returned results to the caller interface - Only mapped attributes
*-------------------------------------------------------------
      IF ls_message IS NOT INITIAL.
* Call RFC call exception handling
        me->/iwbep/if_sb_dpc_comm_services~rfc_save_log(
          EXPORTING
            is_return      = ls_message
            iv_entity_type = iv_entity_name
            it_key_tab     = it_key_tab ).
      ENDIF.

      CLEAR et_entityset.

      LOOP AT lt_result_list INTO ls_result_list
        WHERE record_number > ls_paging-skip.

        " Move SH results to GW request responce table
        lv_next = sy-tabix + 1. " next loop iteration
        CASE ls_result_list-field_name.
          WHEN 'CONDUCTOR'.
            ls_entityset-conductor = ls_result_list-field_value.
          WHEN 'DNI'.
            ls_entityset-dni = ls_result_list-field_value.
          WHEN 'LGORT'.
            ls_entityset-lgort = ls_result_list-field_value.
          WHEN 'MATRICULA'.
            ls_entityset-matricula = ls_result_list-field_value.
          WHEN 'REMOLQUE'.
            ls_entityset-remolque = ls_result_list-field_value.
          WHEN 'TELEFONO'.
            ls_entityset-telefono = ls_result_list-field_value.
          WHEN 'WERKS'.
            ls_entityset-werks = ls_result_list-field_value.
        ENDCASE.

        " Check if the next line in the result list is a new record
        READ TABLE lt_result_list INTO ls_result_list_next INDEX lv_next.
        IF sy-subrc <> 0
        OR ls_result_list-record_number <> ls_result_list_next-record_number.
          " Save the collected SH result in the GW request table
          APPEND ls_entityset TO et_entityset.
          CLEAR: ls_result_list_next, ls_entityset.
        ENDIF.

      ENDLOOP.
      "MTS: Ajustes filtro OR
      APPEND LINES OF et_entityset TO lt_entityset_temp.
    ENDDO.   "MTS: Ajustes filtro OR

    "MTS: Ajustes filtro OR
    SORT lt_entityset_temp BY zcl_search_dpc=>sort_string( EXPORTING iv_instancia = me ).
    DELETE ADJACENT DUPLICATES FROM lt_entityset_temp.
    CLEAR et_entityset.
    IF lv_max_hits NE 0.
      LOOP AT lt_entityset_temp INTO ls_entityset FROM is_paging-skip TO lv_max_hits.
        APPEND ls_entityset TO et_entityset.
      ENDLOOP.
    ELSE.
      et_entityset = lt_entityset_temp.
    ENDIF.
    "MTS: Ajustes filtro OR

  ENDMETHOD.
  METHOD ayudadestinatari_get_entityset.
*-------------------------------------------------------------
*  Data declaration
*-------------------------------------------------------------
    DATA lo_filter TYPE  REF TO /iwbep/if_mgw_req_filter.
    DATA lt_filter_select_options TYPE /iwbep/t_mgw_select_option.
    DATA lv_filter_str TYPE string.
    DATA lv_max_hits TYPE i.
    DATA ls_paging TYPE /iwbep/s_mgw_paging.
    DATA ls_converted_keys LIKE LINE OF et_entityset.
    DATA ls_message TYPE bapiret2.
    DATA lt_selopt TYPE ddshselops.
    DATA ls_selopt LIKE LINE OF lt_selopt.
    DATA ls_filter TYPE /iwbep/s_mgw_select_option.
    DATA ls_filter_range TYPE /iwbep/s_cod_select_option.
    DATA lr_kunnr LIKE RANGE OF ls_converted_keys-kunnr.
    DATA ls_kunnr LIKE LINE OF lr_kunnr.
    DATA lr_mcod1 LIKE RANGE OF ls_converted_keys-mcod1.
    DATA ls_mcod1 LIKE LINE OF lr_mcod1.
    DATA lr_mcod3 LIKE RANGE OF ls_converted_keys-mcod3.
    DATA ls_mcod3 LIKE LINE OF lr_mcod3.
    DATA lr_pstlz LIKE RANGE OF ls_converted_keys-pstlz.
    DATA ls_pstlz LIKE LINE OF lr_pstlz.
    DATA lr_land1 LIKE RANGE OF ls_converted_keys-land1.
    DATA ls_land1 LIKE LINE OF lr_land1.
    DATA lt_result_list TYPE /iwbep/if_sb_gendpc_shlp_data=>tt_result_list.
    DATA lv_next TYPE i VALUE 1.
    DATA ls_entityset LIKE LINE OF et_entityset.
    DATA ls_result_list_next LIKE LINE OF lt_result_list.
    DATA ls_result_list LIKE LINE OF lt_result_list.
    DATA lo_filter_tree TYPE REF TO /iwbep/if_mgw_expr_node.

    "MTS: Ajustes filtro OR
    DATA lt_filter_select_options_and TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_temp TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_or TYPE /iwbep/t_mgw_select_option.
    DATA lt_entityset_temp TYPE zcl_zsui5_cm_gestion_t_mpc=>tt_ayudadestinatario.
    DATA lv_veces TYPE i.
    DATA posicion TYPE i.
    "MTS: Ajustes filtro OR

*-------------------------------------------------------------
*  Map the runtime request to the Search Help select option - Only mapped attributes
*-------------------------------------------------------------
* Get all input information from the technical request context object
* Since DPC works with internal property names and runtime API interface holds external property names
* the process needs to get the all needed input information from the technical request context object
* Get filter or select option information
    lo_filter = io_tech_request_context->get_filter( ).
    lt_filter_select_options = lo_filter->get_filter_select_options( ).
    lv_filter_str = lo_filter->get_filter_string( ).

* Check if the supplied filter is supported by standard gateway runtime process
    IF  lv_filter_str            IS NOT INITIAL
    AND lt_filter_select_options IS INITIAL.
      " If the string of the Filter System Query Option is not automatically converted into
      " filter option table (lt_filter_select_options), then the filtering combination is not supported
      " Log message in the application log

      "MTS: Ajustes filtro OR
*      me->/iwbep/if_sb_dpc_comm_services~log_message(
*        EXPORTING
*          iv_msg_type   = 'E'
*          iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
*          iv_msg_number = 025 ).
*      " Raise Exception
*      RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
*        EXPORTING
*          textid = /iwbep/cx_mgw_tech_exception=>internal_error.
*      CALL FUNCTION 'ZUI5_CM_FILTRO_OR'
*        EXPORTING
*          i_filter_string = lv_filter_str
*        IMPORTING
*          lt_filter_or    = lt_filter_select_options_or
*          lt_filter_and   = lt_filter_select_options.
      "MTS: Ajustes filtro OR
      zcl_search_dpc=>filtros_or( EXPORTING iv_instancia = me iv_data = ls_entityset IMPORTING et_filter_select_options_and = lt_filter_select_options_and et_filter_select_options_or = lt_filter_select_options_or ).
      "MTS: Ajustes filtro OR
    ENDIF.
    IF iv_search_string IS NOT INITIAL.
      zcl_search_dpc=>search_or( EXPORTING iv_instancia = me iv_search = iv_search_string iv_data = ls_entityset it_filter_select_options = lt_filter_select_options
                 IMPORTING et_filter_select_options_or = lt_filter_select_options_or ).
    ENDIF.

* Get key table information
    io_tech_request_context->get_converted_source_keys(
      IMPORTING
        es_key_values  = ls_converted_keys ).

    ls_paging-top = io_tech_request_context->get_top( ).
    ls_paging-skip = io_tech_request_context->get_skip( ).

    " Calculate the number of max hits to be fetched from the function module
    " The lv_max_hits value is a summary of the Top and Skip values
    IF ls_paging-top > 0.
      lv_max_hits = is_paging-top + is_paging-skip.
    ENDIF.

    "MTS: Ajustes filtro OR
    IF lt_filter_select_options_or IS NOT INITIAL OR lt_filter_select_options_and IS NOT INITIAL.
      DESCRIBE TABLE lt_filter_select_options_or LINES lv_veces.
      IF lv_veces IS INITIAL.
        lv_veces = 1.
      ENDIF.
    ELSE.
      lv_veces = 1.
    ENDIF.

    CLEAR posicion.

    IF lt_filter_select_options IS NOT INITIAL.
      zcl_search_dpc=>filtro_mayusculas(
     EXPORTING
       iv_data = ls_entityset
       CHANGING
       ct_filter_select_options = lt_filter_select_options ).

      APPEND LINES OF lt_filter_select_options TO lt_filter_select_options_and.
    ENDIF.

    DO lv_veces TIMES.
      CLEAR: lt_result_list, ls_message, lt_selopt.

      ADD 1 TO posicion.
      READ TABLE lt_filter_select_options_or INTO DATA(ls_option_or) INDEX posicion.
      IF sy-subrc = 0.
        lt_filter_select_options = lt_filter_select_options_and.
        APPEND ls_option_or TO lt_filter_select_options.
      ELSE.
        lt_filter_select_options = lt_filter_select_options_and.
      ENDIF.
      "MTS: Ajustes filtro OR

* Maps filter table lines to the Search Help select option table
      LOOP AT lt_filter_select_options INTO ls_filter.

        CASE ls_filter-property.
          WHEN 'KUNNR'.              " Equivalent to 'Kunnr' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_kunnr ).

            LOOP AT lr_kunnr INTO ls_kunnr.
              ls_selopt-high = ls_kunnr-high.
              ls_selopt-low = ls_kunnr-low.
              ls_selopt-option = ls_kunnr-option.
              ls_selopt-sign = ls_kunnr-sign.
              ls_selopt-shlpfield = 'KUNNR'.
              ls_selopt-shlpname = 'DEBIA'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.
          WHEN 'MCOD1'.              " Equivalent to 'Mcod1' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_mcod1 ).

            LOOP AT lr_mcod1 INTO ls_mcod1.
              ls_selopt-high = ls_mcod1-high.
              ls_selopt-low = ls_mcod1-low.
              ls_selopt-option = ls_mcod1-option.
              ls_selopt-sign = ls_mcod1-sign.
              ls_selopt-shlpfield = 'MCOD1'.
              ls_selopt-shlpname = 'DEBIA'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.
          WHEN 'MCOD3'.              " Equivalent to 'Mcod3' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_mcod3 ).

            LOOP AT lr_mcod3 INTO ls_mcod3.
              ls_selopt-high = ls_mcod3-high.
              ls_selopt-low = ls_mcod3-low.
              ls_selopt-option = ls_mcod3-option.
              ls_selopt-sign = ls_mcod3-sign.
              ls_selopt-shlpfield = 'MCOD3'.
              ls_selopt-shlpname = 'DEBIA'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.
          WHEN 'PSTLZ'.              " Equivalent to 'Pstlz' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_pstlz ).

            LOOP AT lr_pstlz INTO ls_pstlz.
              ls_selopt-high = ls_pstlz-high.
              ls_selopt-low = ls_pstlz-low.
              ls_selopt-option = ls_pstlz-option.
              ls_selopt-sign = ls_pstlz-sign.
              ls_selopt-shlpfield = 'PSTLZ'.
              ls_selopt-shlpname = 'DEBIA'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.
          WHEN 'LAND1'.              " Equivalent to 'Land1' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_land1 ).

            LOOP AT lr_land1 INTO ls_land1.
              ls_selopt-high = ls_land1-high.
              ls_selopt-low = ls_land1-low.
              ls_selopt-option = ls_land1-option.
              ls_selopt-sign = ls_land1-sign.
              ls_selopt-shlpfield = 'LAND1'.
              ls_selopt-shlpname = 'DEBIA'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.

          WHEN OTHERS.
*       SARCE INI 3###########################################
            " Log message in the application log
            IF NOT iv_search_string IS INITIAL.
              DATA(vv_jump_search) = 'X'.
              CONTINUE.
            ENDIF.
*      SARCE FIN 3###########################################
            " Log message in the application log
            me->/iwbep/if_sb_dpc_comm_services~log_message(
              EXPORTING
                iv_msg_type   = 'E'
                iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
                iv_msg_number = 020
                iv_msg_v1     = ls_filter-property ).
            " Raise Exception
            RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
              EXPORTING
                textid = /iwbep/cx_mgw_tech_exception=>internal_error.
        ENDCASE.
      ENDLOOP.

*      SARCE INI 4###########################################
      IF vv_jump_search = 'X'.
        vv_jump_search = ''.
        CONTINUE.
      ENDIF.
      "MTS: Ajustes
*      SARCE FIN 4###########################################

*-------------------------------------------------------------
*  Call to Search Help get values mechanism
*-------------------------------------------------------------
* Get search help values
      me->/iwbep/if_sb_gendpc_shlp_data~get_search_help_values(
        EXPORTING
          iv_shlp_name = 'DEBIA'
          iv_maxrows = lv_max_hits
          iv_sort = 'X'
          iv_call_shlt_exit = 'X'
          it_selopt = lt_selopt
        IMPORTING
          et_return_list = lt_result_list
          es_message = ls_message ).

*-------------------------------------------------------------
*  Map the Search Help returned results to the caller interface - Only mapped attributes
*-------------------------------------------------------------
      IF ls_message IS NOT INITIAL.
* Call RFC call exception handling
        me->/iwbep/if_sb_dpc_comm_services~rfc_save_log(
          EXPORTING
            is_return      = ls_message
            iv_entity_type = iv_entity_name
            it_key_tab     = it_key_tab ).
      ENDIF.

      CLEAR et_entityset.

      LOOP AT lt_result_list INTO ls_result_list
        WHERE record_number > ls_paging-skip.

        " Move SH results to GW request responce table
        lv_next = sy-tabix + 1. " next loop iteration
        CASE ls_result_list-field_name.
          WHEN 'KUNNR'.
            ls_entityset-kunnr = ls_result_list-field_value.
          WHEN 'LAND1'.
            ls_entityset-land1 = ls_result_list-field_value.
          WHEN 'MCOD1'.
            ls_entityset-mcod1 = ls_result_list-field_value.
          WHEN 'MCOD3'.
            ls_entityset-mcod3 = ls_result_list-field_value.
          WHEN 'PSTLZ'.
            ls_entityset-pstlz = ls_result_list-field_value.
        ENDCASE.

        " Check if the next line in the result list is a new record
        READ TABLE lt_result_list INTO ls_result_list_next INDEX lv_next.
        IF sy-subrc <> 0
        OR ls_result_list-record_number <> ls_result_list_next-record_number.
          " Save the collected SH result in the GW request table
          APPEND ls_entityset TO et_entityset.
          CLEAR: ls_result_list_next, ls_entityset.
        ENDIF.

      ENDLOOP.

      "MTS: Ajustes filtro OR
      APPEND LINES OF et_entityset TO lt_entityset_temp.
    ENDDO.   "MTS: Ajustes filtro OR

    "MTS: Ajustes filtro OR
    SORT lt_entityset_temp BY zcl_search_dpc=>sort_string( EXPORTING iv_instancia = me ).
    DELETE ADJACENT DUPLICATES FROM lt_entityset_temp.
    CLEAR et_entityset.
    IF lv_max_hits NE 0.
      LOOP AT lt_entityset_temp INTO ls_entityset FROM is_paging-skip TO lv_max_hits.
        APPEND ls_entityset TO et_entityset.
      ENDLOOP.
    ELSE.
      et_entityset = lt_entityset_temp.
    ENDIF.
    "MTS: Ajustes filtro OR

  ENDMETHOD.
  METHOD ayudamotivopedid_get_entityset.
*-------------------------------------------------------------
*  Data declaration
*-------------------------------------------------------------
    DATA lo_filter TYPE  REF TO /iwbep/if_mgw_req_filter.
    DATA lt_filter_select_options TYPE /iwbep/t_mgw_select_option.
    DATA lv_filter_str TYPE string.
    DATA lv_max_hits TYPE i.
    DATA ls_paging TYPE /iwbep/s_mgw_paging.
    DATA ls_converted_keys LIKE LINE OF et_entityset.
    DATA ls_message TYPE bapiret2.
    DATA lt_selopt TYPE ddshselops.
    DATA ls_selopt LIKE LINE OF lt_selopt.
    DATA ls_filter TYPE /iwbep/s_mgw_select_option.
    DATA ls_filter_range TYPE /iwbep/s_cod_select_option.
    DATA lr_bezei LIKE RANGE OF ls_converted_keys-bezei.
    DATA ls_bezei LIKE LINE OF lr_bezei.
    DATA lr_augru LIKE RANGE OF ls_converted_keys-augru.
    DATA ls_augru LIKE LINE OF lr_augru.
    DATA lt_result_list TYPE /iwbep/if_sb_gendpc_shlp_data=>tt_result_list.
    DATA lv_next TYPE i VALUE 1.
    DATA ls_entityset LIKE LINE OF et_entityset.
    DATA ls_result_list_next LIKE LINE OF lt_result_list.
    DATA ls_result_list LIKE LINE OF lt_result_list.

    "MTS: Ajustes filtro OR
    DATA lt_filter_select_options_and TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_temp TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_or TYPE /iwbep/t_mgw_select_option.
    DATA lt_entityset_temp TYPE zcl_zsui5_cm_gestion_t_mpc=>tt_ayudamotivopedido.
    DATA lv_veces TYPE i.
    DATA posicion TYPE i.
    "MTS: Ajustes filtro OR
*-------------------------------------------------------------
*  Map the runtime request to the Search Help select option - Only mapped attributes
*-------------------------------------------------------------
* Get all input information from the technical request context object
* Since DPC works with internal property names and runtime API interface holds external property names
* the process needs to get the all needed input information from the technical request context object
* Get filter or select option information
    lo_filter = io_tech_request_context->get_filter( ).
    lt_filter_select_options = lo_filter->get_filter_select_options( ).
    lv_filter_str = lo_filter->get_filter_string( ).

* Check if the supplied filter is supported by standard gateway runtime process
    IF  lv_filter_str            IS NOT INITIAL
    AND lt_filter_select_options IS INITIAL.
      " If the string of the Filter System Query Option is not automatically converted into
      " filter option table (lt_filter_select_options), then the filtering combination is not supported
      " Log message in the application log
*  me->/iwbep/if_sb_dpc_comm_services~log_message(
*    EXPORTING
*      iv_msg_type   = 'E'
*      iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
*      iv_msg_number = 025 ).
*  " Raise Exception
*  RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
*    EXPORTING
*      textid = /iwbep/cx_mgw_tech_exception=>internal_error.
      zcl_search_dpc=>filtros_or( EXPORTING iv_instancia = me iv_data = ls_entityset IMPORTING et_filter_select_options_and = lt_filter_select_options_and et_filter_select_options_or = lt_filter_select_options_or ).
      "MTS: Ajustes filtro OR
    ENDIF.
    IF iv_search_string IS NOT INITIAL.
      zcl_search_dpc=>search_or( EXPORTING iv_instancia = me iv_search = iv_search_string iv_data = ls_entityset it_filter_select_options = lt_filter_select_options
                 IMPORTING et_filter_select_options_or = lt_filter_select_options_or ).
    ENDIF.

* Get key table information
    io_tech_request_context->get_converted_source_keys(
      IMPORTING
        es_key_values  = ls_converted_keys ).

    ls_paging-top = io_tech_request_context->get_top( ).
    ls_paging-skip = io_tech_request_context->get_skip( ).

    " Calculate the number of max hits to be fetched from the function module
    " The lv_max_hits value is a summary of the Top and Skip values
    IF ls_paging-top > 0.
      lv_max_hits = is_paging-top + is_paging-skip.
    ENDIF.

    "MTS: Ajustes filtro OR
    IF lt_filter_select_options_or IS NOT INITIAL OR lt_filter_select_options_and IS NOT INITIAL.
      DESCRIBE TABLE lt_filter_select_options_or LINES lv_veces.
      IF lv_veces IS INITIAL.
        lv_veces = 1.
      ENDIF.
    ELSE.
      lv_veces = 1.
    ENDIF.

    CLEAR posicion.

    IF lt_filter_select_options IS NOT INITIAL.
      zcl_search_dpc=>filtro_mayusculas(
     EXPORTING
       iv_data = ls_entityset
       CHANGING
       ct_filter_select_options = lt_filter_select_options ).

      APPEND LINES OF lt_filter_select_options TO lt_filter_select_options_and.
    ENDIF.

    DO lv_veces TIMES.
      CLEAR: lt_result_list, ls_message, lt_selopt.

      ADD 1 TO posicion.
      READ TABLE lt_filter_select_options_or INTO DATA(ls_option_or) INDEX posicion.
      IF sy-subrc = 0.
        lt_filter_select_options = lt_filter_select_options_and.
        APPEND ls_option_or TO lt_filter_select_options.
      ELSE.
        lt_filter_select_options = lt_filter_select_options_and.
      ENDIF.
      "MTS: Ajustes filtro OR

* Maps filter table lines to the Search Help select option table
      LOOP AT lt_filter_select_options INTO ls_filter.

        CASE ls_filter-property.
          WHEN 'BEZEI'.              " Equivalent to 'Bezei' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_bezei ).

            LOOP AT lr_bezei INTO ls_bezei.
              ls_selopt-sign = ls_bezei-sign.
              ls_selopt-option = ls_bezei-option.
              ls_selopt-low = ls_bezei-low.
              ls_selopt-high = ls_bezei-high.
              ls_selopt-shlpfield = 'BEZEI'.
              ls_selopt-shlpname = 'H_TVAU'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.
          WHEN 'AUGRU'.              " Equivalent to 'Augru' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_augru ).

            LOOP AT lr_augru INTO ls_augru.
              ls_selopt-sign = ls_augru-sign.
              ls_selopt-option = ls_augru-option.
              ls_selopt-low = ls_augru-low.
              ls_selopt-high = ls_augru-high.
              ls_selopt-shlpfield = 'AUGRU'.
              ls_selopt-shlpname = 'H_TVAU'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.

          WHEN OTHERS.
*       sarce ini 3###########################################
            " Log message in the application log
            IF NOT iv_search_string IS INITIAL.
              DATA(vv_jump_search) = 'X'.
              CONTINUE.
            ENDIF.
*      SARCE FIN 3###########################################
            " Log message in the application log
            me->/iwbep/if_sb_dpc_comm_services~log_message(
              EXPORTING
                iv_msg_type   = 'E'
                iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
                iv_msg_number = 020
                iv_msg_v1     = ls_filter-property ).
            " Raise Exception
            RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
              EXPORTING
                textid = /iwbep/cx_mgw_tech_exception=>internal_error.
        ENDCASE.
      ENDLOOP.

*      SARCE INI 4###########################################
      IF vv_jump_search = 'X'.
        vv_jump_search = ''.
        CONTINUE.
      ENDIF.
      "MTS: Ajustes
*      SARCE FIN 4###########################################

*-------------------------------------------------------------
*  Call to Search Help get values mechanism
*-------------------------------------------------------------
* Get search help values
      me->/iwbep/if_sb_gendpc_shlp_data~get_search_help_values(
        EXPORTING
          iv_shlp_name = 'H_TVAU'
          iv_maxrows = lv_max_hits
          iv_sort = 'X'
          iv_call_shlt_exit = 'X'
          it_selopt = lt_selopt
        IMPORTING
          et_return_list = lt_result_list
          es_message = ls_message ).

*-------------------------------------------------------------
*  Map the Search Help returned results to the caller interface - Only mapped attributes
*-------------------------------------------------------------
      IF ls_message IS NOT INITIAL.
* Call RFC call exception handling
        me->/iwbep/if_sb_dpc_comm_services~rfc_save_log(
          EXPORTING
            is_return      = ls_message
            iv_entity_type = iv_entity_name
            it_key_tab     = it_key_tab ).
      ENDIF.

      CLEAR et_entityset.

      LOOP AT lt_result_list INTO ls_result_list
        WHERE record_number > ls_paging-skip.

        " Move SH results to GW request responce table
        lv_next = sy-tabix + 1. " next loop iteration
        CASE ls_result_list-field_name.
          WHEN 'AUGRU'.
            ls_entityset-augru = ls_result_list-field_value.
          WHEN 'BEZEI'.
            ls_entityset-bezei = ls_result_list-field_value.
        ENDCASE.

        " Check if the next line in the result list is a new record
        READ TABLE lt_result_list INTO ls_result_list_next INDEX lv_next.
        IF sy-subrc <> 0
        OR ls_result_list-record_number <> ls_result_list_next-record_number.
          " Save the collected SH result in the GW request table
          APPEND ls_entityset TO et_entityset.
          CLEAR: ls_result_list_next, ls_entityset.
        ENDIF.

      ENDLOOP.

      "MTS: Ajustes filtro OR
      APPEND LINES OF et_entityset TO lt_entityset_temp.
    ENDDO.   "MTS: Ajustes filtro OR

    "MTS: Ajustes filtro OR
    SORT lt_entityset_temp BY zcl_search_dpc=>sort_string( EXPORTING iv_instancia = me ).
    DELETE ADJACENT DUPLICATES FROM lt_entityset_temp.
    CLEAR et_entityset.
    IF lv_max_hits NE 0.
      LOOP AT lt_entityset_temp INTO ls_entityset FROM is_paging-skip TO lv_max_hits.
        APPEND ls_entityset TO et_entityset.
      ENDLOOP.
    ELSE.
      et_entityset = lt_entityset_temp.
    ENDIF.
    "MTS: Ajustes filtro OR

  ENDMETHOD.
  METHOD ayudapuestoexped_get_entityset.
*-------------------------------------------------------------
*  Data declaration
*-------------------------------------------------------------
    DATA ir_vstel  TYPE zif_zui5_cm_get_puesto_expedic=>rjksd_vstel_range_tab.
    DATA ir_vstel_name  TYPE zif_zui5_cm_get_puesto_expedic=>ris_t_select_option.
    DATA ir_werks  TYPE zif_zui5_cm_get_puesto_expedic=>range_t_werks_d.
    DATA o_data  TYPE zif_zui5_cm_get_puesto_expedic=>zsuitt_cm_puestos_expedicion.
    DATA o_return  TYPE zif_zui5_cm_get_puesto_expedic=>bapiret2_t.
    DATA ls_ir_vstel  TYPE LINE OF zif_zui5_cm_get_puesto_expedic=>rjksd_vstel_range_tab.
    DATA ls_ir_vstel_name  TYPE LINE OF zif_zui5_cm_get_puesto_expedic=>ris_t_select_option.
    DATA ls_ir_werks  TYPE LINE OF zif_zui5_cm_get_puesto_expedic=>range_t_werks_d.
    DATA ls_o_data  TYPE LINE OF zif_zui5_cm_get_puesto_expedic=>zsuitt_cm_puestos_expedicion.
    DATA ls_o_return  TYPE LINE OF zif_zui5_cm_get_puesto_expedic=>bapiret2_t.
    DATA lv_rfc_name TYPE tfdir-funcname.
    DATA lv_destination TYPE rfcdest.
    DATA lv_subrc TYPE syst-subrc.
    DATA lv_exc_msg TYPE /iwbep/mgw_bop_rfc_excep_text.
    DATA lx_root TYPE REF TO cx_root.
    DATA lo_filter TYPE  REF TO /iwbep/if_mgw_req_filter.
    DATA lt_filter_select_options TYPE /iwbep/t_mgw_select_option.
    DATA lv_filter_str TYPE string.
    DATA ls_paging TYPE /iwbep/s_mgw_paging.
    DATA ls_converted_keys LIKE LINE OF et_entityset.
    DATA ls_filter TYPE /iwbep/s_mgw_select_option.
    DATA ls_filter_range TYPE /iwbep/s_cod_select_option.
    DATA lr_vstel LIKE RANGE OF ls_converted_keys-vstel.
    DATA ls_vstel LIKE LINE OF lr_vstel.
    DATA lr_vtext LIKE RANGE OF ls_converted_keys-vtext.
    DATA ls_vtext LIKE LINE OF lr_vtext.
    DATA lr_werks LIKE RANGE OF ls_converted_keys-werks.
    DATA ls_werks LIKE LINE OF lr_werks.
    DATA lo_dp_facade TYPE REF TO /iwbep/if_mgw_dp_facade.
    DATA ls_gw_o_data LIKE LINE OF et_entityset.
    DATA lv_skip     TYPE int4.
    DATA lv_top      TYPE int4.


    "MTS: Ajustes filtro OR
    DATA lt_filter_select_options_and TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_temp TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_or TYPE /iwbep/t_mgw_select_option.
    DATA lv_veces TYPE i.
    DATA posicion TYPE i.
    DATA o_data_temp  TYPE zcl_zsui5_cm_gestion_t_mpc=>tt_ayudapuestoexpedicion.
    "MTS: Ajustes filtro OR

*-------------------------------------------------------------
*  Map the runtime request to the RFC - Only mapped attributes
*-------------------------------------------------------------
* Get all input information from the technical request context object
* Since DPC works with internal property names and runtime API interface holds external property names
* the process needs to get the all needed input information from the technical request context object
* Get filter or select option information
    lo_filter = io_tech_request_context->get_filter( ).
    lt_filter_select_options = lo_filter->get_filter_select_options( ).
    lv_filter_str = lo_filter->get_filter_string( ).

* Check if the supplied filter is supported by standard gateway runtime process
    IF  lv_filter_str            IS NOT INITIAL
    AND lt_filter_select_options IS INITIAL.
      " If the string of the Filter System Query Option is not automatically converted into
      " filter option table (lt_filter_select_options), then the filtering combination is not supported
      " Log message in the application log
*      me->/iwbep/if_sb_dpc_comm_services~log_message(
*        EXPORTING
*          iv_msg_type   = 'E'
*          iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
*          iv_msg_number = 025 ).
*      " Raise Exception
*      RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
*        EXPORTING
*          textid = /iwbep/cx_mgw_tech_exception=>internal_error.
      "MTS: Ajustes filtro OR
      zcl_search_dpc=>filtros_or( EXPORTING iv_instancia = me iv_data = ls_gw_o_data IMPORTING et_filter_select_options_and = lt_filter_select_options_and et_filter_select_options_or = lt_filter_select_options_or ).
      "MTS: Ajustes filtro OR
    ENDIF.
    IF iv_search_string IS NOT INITIAL.
      zcl_search_dpc=>search_or( EXPORTING iv_instancia = me iv_search = iv_search_string iv_data = ls_gw_o_data it_filter_select_options = lt_filter_select_options
                 IMPORTING et_filter_select_options_or = lt_filter_select_options_or ).
    ENDIF.

* Get key table information
    io_tech_request_context->get_converted_source_keys(
      IMPORTING
        es_key_values  = ls_converted_keys ).

    ls_paging-top = io_tech_request_context->get_top( ).
    ls_paging-skip = io_tech_request_context->get_skip( ).

    "MTS: Ajustes filtro OR
    IF lt_filter_select_options_or IS NOT INITIAL OR lt_filter_select_options_and IS NOT INITIAL.
      DESCRIBE TABLE lt_filter_select_options_or LINES lv_veces.
      IF lv_veces IS INITIAL.
        lv_veces = 1.
      ENDIF.
    ELSE.
      lv_veces = 1.
    ENDIF.

    CLEAR posicion.

    IF lt_filter_select_options IS NOT INITIAL.
      zcl_search_dpc=>filtro_mayusculas(
     EXPORTING
       iv_data = ls_gw_o_data
       CHANGING
       ct_filter_select_options = lt_filter_select_options ).

      APPEND LINES OF lt_filter_select_options TO lt_filter_select_options_and.
    ENDIF.

    DO lv_veces TIMES.
      CLEAR: o_data, ir_vstel, ir_vstel_name, ir_werks.

      ADD 1 TO posicion.
      READ TABLE lt_filter_select_options_or INTO DATA(ls_option_or) INDEX posicion.
      IF sy-subrc = 0.
        lt_filter_select_options = lt_filter_select_options_and.

        APPEND ls_option_or TO lt_filter_select_options.
      ELSE.
        lt_filter_select_options = lt_filter_select_options_and.
      ENDIF.
      "MTS: Ajustes filtro OR

* Maps filter table lines to function module parameters
      LOOP AT lt_filter_select_options INTO ls_filter.

        CASE ls_filter-property.
          WHEN 'VSTEL'.              " Equivalent to 'Vstel' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_vstel ).

            LOOP AT lr_vstel INTO ls_vstel.
              ls_ir_vstel-sign = ls_vstel-sign.
              ls_ir_vstel-option = ls_vstel-option.
              ls_ir_vstel-low = ls_vstel-low.
              ls_ir_vstel-high = ls_vstel-high.
              APPEND ls_ir_vstel TO ir_vstel.
            ENDLOOP.
            CLEAR lr_vstel.
          WHEN 'VTEXT'.              " Equivalent to 'Vtext' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_vtext ).

            LOOP AT lr_vtext INTO ls_vtext.
              ls_ir_vstel_name-sign = ls_vtext-sign.
              ls_ir_vstel_name-option = ls_vtext-option.
              ls_ir_vstel_name-low = ls_vtext-low.
              ls_ir_vstel_name-high = ls_vtext-high.
              APPEND ls_ir_vstel_name TO ir_vstel_name.
            ENDLOOP.
            CLEAR lr_vtext.
          WHEN 'WERKS'.              " Equivalent to 'Werks' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_werks ).

            LOOP AT lr_werks INTO ls_werks.
              ls_ir_werks-sign = ls_werks-sign.
              ls_ir_werks-option = ls_werks-option.
              ls_ir_werks-low = ls_werks-low.
              ls_ir_werks-high = ls_werks-high.
              APPEND ls_ir_werks TO ir_werks.
            ENDLOOP.
            CLEAR lr_werks.

          WHEN OTHERS.
*       SARCE INI 3###########################################
            " Log message in the application log
            IF NOT iv_search_string IS INITIAL.
              DATA(vv_jump_search) = 'X'.
              CONTINUE.
            ENDIF.
*      SARCE FIN 3###########################################
            " Log message in the application log
            me->/iwbep/if_sb_dpc_comm_services~log_message(
              EXPORTING
                iv_msg_type   = 'E'
                iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
                iv_msg_number = 020
                iv_msg_v1     = ls_filter-property ).
            " Raise Exception
            RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
              EXPORTING
                textid = /iwbep/cx_mgw_tech_exception=>internal_error.
        ENDCASE.

      ENDLOOP.
*      SARCE INI 4###########################################
      IF vv_jump_search = 'X'.
        vv_jump_search = ''.
        CONTINUE.
      ENDIF.
      "MTS: Ajustes

* Get RFC destination
      lo_dp_facade = /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ).
      lv_destination = /iwbep/cl_sb_gen_dpc_rt_util=>get_rfc_destination( io_dp_facade = lo_dp_facade ).

*-------------------------------------------------------------
*  Call RFC function module
*-------------------------------------------------------------
      lv_rfc_name = 'ZUI5_CM_GET_PUESTO_EXPEDICION'.

      IF lv_destination IS INITIAL OR lv_destination EQ 'NONE'.

        TRY.
            CALL FUNCTION lv_rfc_name
              EXPORTING
                ir_vstel       = ir_vstel
                ir_vstel_name  = ir_vstel_name
                ir_werks       = ir_werks
              IMPORTING
                o_return       = o_return
                o_data         = o_data
              EXCEPTIONS
                system_failure = 1000 message lv_exc_msg
                OTHERS         = 1002.

            lv_subrc = sy-subrc.
*in case of co-deployment the exception is raised and needs to be caught
          CATCH cx_root INTO lx_root.
            lv_subrc = 1001.
            lv_exc_msg = lx_root->if_message~get_text( ).
        ENDTRY.

      ELSE.

        CALL FUNCTION lv_rfc_name DESTINATION lv_destination
          EXPORTING
            ir_vstel              = ir_vstel
            ir_vstel_name         = ir_vstel_name
            ir_werks              = ir_werks
          IMPORTING
            o_return              = o_return
            o_data                = o_data
          EXCEPTIONS
            system_failure        = 1000 MESSAGE lv_exc_msg
            communication_failure = 1001 MESSAGE lv_exc_msg
            OTHERS                = 1002.

        lv_subrc = sy-subrc.

      ENDIF.
     "MTS: Ajustes
      APPEND LINES OF o_data TO o_data_temp.
*-------------------------------------------------------------
*  Map the RFC response to the caller interface - Only mapped attributes
*-------------------------------------------------------------
*-------------------------------------------------------------
* Error and exception handling
*-------------------------------------------------------------
      IF lv_subrc <> 0.
* Execute the RFC exception handling process
        me->/iwbep/if_sb_dpc_comm_services~rfc_exception_handling(
          EXPORTING
            iv_subrc            = lv_subrc
            iv_exp_message_text = lv_exc_msg ).
      ENDIF.

      IF o_return IS NOT INITIAL.
        me->/iwbep/if_sb_dpc_comm_services~rfc_save_log(
          EXPORTING
            iv_entity_type = iv_entity_name
            it_return      = o_return
            it_key_tab     = it_key_tab ).
      ENDIF.

    ENDDO. "MTS Ajustes
    o_data = o_data_temp.
*-------------------------------------------------------------------------*
*             - Post Backend Call -
*-------------------------------------------------------------------------*
    IF ls_paging-skip IS NOT INITIAL.
*  If the Skip value was requested at runtime
*  the response table will provide backend entries from skip + 1, meaning start from skip +1
*  for example: skip=5 means to start get results from the 6th row
      lv_skip = ls_paging-skip + 1.
    ENDIF.
*  The Top value was requested at runtime but was not handled as part of the function interface
    IF  ls_paging-top <> 0
    AND lv_skip IS NOT INITIAL.
*  if lv_skip > 0 retrieve the entries from lv_skip + Top - 1
*  for example: skip=5 and top=2 means to start get results from the 6th row and end in row number 7
      lv_top = ls_paging-top + lv_skip - 1.
    ELSEIF ls_paging-top <> 0
    AND    lv_skip IS INITIAL.
      lv_top = ls_paging-top.
    ELSE.
      lv_top = lines( o_data ).
    ENDIF.


    "Ordenamos
    IF it_order IS NOT INITIAL.
      SORT o_data BY zcl_search_dpc=>sort_string( EXPORTING iv_instancia = me  ).
      DELETE ADJACENT DUPLICATES FROM o_data.
    ENDIF.

*  - Map properties from the backend to the Gateway output response table -

    LOOP AT o_data INTO ls_o_data
*  Provide the response entries according to the Top and Skip parameters that were provided at runtime
         FROM lv_skip TO lv_top.
*  Only fields that were mapped will be delivered to the response table
      ls_gw_o_data-werks = ls_o_data-werks.
      ls_gw_o_data-vtext = ls_o_data-vtext.
      ls_gw_o_data-vstel = ls_o_data-vstel.
      APPEND ls_gw_o_data TO et_entityset.
      CLEAR ls_gw_o_data.
    ENDLOOP.

  ENDMETHOD.
  METHOD ayudatipopallets_get_entityset.
*-------------------------------------------------------------
*  Data declaration
*-------------------------------------------------------------
    DATA e_data  TYPE zif_zui5_cm_get_tipo_pallets=>zscmtt_material_palets_centro.
    DATA e_data_temp  TYPE zif_zui5_cm_get_tipo_pallets=>zscmtt_material_palets_centro.
    DATA e_return  TYPE zif_zui5_cm_get_tipo_pallets=>bapiret2_t.
    DATA ir_lgort  TYPE zif_zui5_cm_get_tipo_pallets=>range_t_lgort_d.
    DATA ir_matnr  TYPE zif_zui5_cm_get_tipo_pallets=>range_t_matnr.
    DATA ir_werks  TYPE zif_zui5_cm_get_tipo_pallets=>range_t_werks_d.
    DATA ls_e_data  TYPE LINE OF zif_zui5_cm_get_tipo_pallets=>zscmtt_material_palets_centro.
    DATA ls_e_return  TYPE LINE OF zif_zui5_cm_get_tipo_pallets=>bapiret2_t.
    DATA ls_ir_lgort  TYPE LINE OF zif_zui5_cm_get_tipo_pallets=>range_t_lgort_d.
    DATA ls_ir_matnr  TYPE LINE OF zif_zui5_cm_get_tipo_pallets=>range_t_matnr.
    DATA ls_ir_werks  TYPE LINE OF zif_zui5_cm_get_tipo_pallets=>range_t_werks_d.
    DATA lv_rfc_name TYPE tfdir-funcname.
    DATA lv_destination TYPE rfcdest.
    DATA lv_subrc TYPE syst-subrc.
    DATA lv_exc_msg TYPE /iwbep/mgw_bop_rfc_excep_text.
    DATA lx_root TYPE REF TO cx_root.
    DATA lo_filter TYPE  REF TO /iwbep/if_mgw_req_filter.
    DATA lt_filter_select_options TYPE /iwbep/t_mgw_select_option.
    DATA lv_filter_str TYPE string.
    DATA ls_paging TYPE /iwbep/s_mgw_paging.
    DATA ls_converted_keys LIKE LINE OF et_entityset.
    DATA ls_filter TYPE /iwbep/s_mgw_select_option.
    DATA ls_filter_range TYPE /iwbep/s_cod_select_option.
    DATA lr_werks LIKE RANGE OF ls_converted_keys-werks.
    DATA ls_werks LIKE LINE OF lr_werks.
    DATA lr_lgort LIKE RANGE OF ls_converted_keys-lgort.
    DATA ls_lgort LIKE LINE OF lr_lgort.
    DATA lr_matnr LIKE RANGE OF ls_converted_keys-matnr.
    DATA ls_matnr LIKE LINE OF lr_matnr.
    DATA lo_dp_facade TYPE REF TO /iwbep/if_mgw_dp_facade.
    DATA ls_gw_e_data LIKE LINE OF et_entityset.
    DATA lv_skip     TYPE int4.
    DATA lv_top      TYPE int4.


    "MTS: Ajustes filtro OR
    DATA lt_filter_select_options_and TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_temp TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_or TYPE /iwbep/t_mgw_select_option.
    DATA lv_veces TYPE i.
    DATA posicion TYPE i.
    "MTS: Ajustes filtro OR

*-------------------------------------------------------------
*  Map the runtime request to the RFC - Only mapped attributes
*-------------------------------------------------------------
* Get all input information from the technical request context object
* Since DPC works with internal property names and runtime API interface holds external property names
* the process needs to get the all needed input information from the technical request context object
* Get filter or select option information
    lo_filter = io_tech_request_context->get_filter( ).
    lt_filter_select_options = lo_filter->get_filter_select_options( ).
    lv_filter_str = lo_filter->get_filter_string( ).

* Check if the supplied filter is supported by standard gateway runtime process
    IF  lv_filter_str            IS NOT INITIAL
    AND lt_filter_select_options IS INITIAL.
      " If the string of the Filter System Query Option is not automatically converted into
      " filter option table (lt_filter_select_options), then the filtering combination is not supported
      " Log message in the application log
*   me->/iwbep/if_sb_dpc_comm_services~log_message(
*     EXPORTING
*       iv_msg_type   = 'E'
*       iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
*       iv_msg_number = 025 ).
*   " Raise Exception
*   RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
*     EXPORTING
*       textid = /iwbep/cx_mgw_tech_exception=>internal_error.
      "MTS: Ajustes filtro OR
      zcl_search_dpc=>filtros_or( EXPORTING iv_instancia = me iv_data = ls_gw_e_data IMPORTING et_filter_select_options_and = lt_filter_select_options_and et_filter_select_options_or = lt_filter_select_options_or ).
      "MTS: Ajustes filtro OR
    ENDIF.
    IF iv_search_string IS NOT INITIAL.
      zcl_search_dpc=>search_or( EXPORTING iv_instancia = me iv_search = iv_search_string iv_data = ls_gw_e_data it_filter_select_options = lt_filter_select_options
                 IMPORTING et_filter_select_options_or = lt_filter_select_options_or ).
    ENDIF.

* Get key table information
    io_tech_request_context->get_converted_source_keys(
      IMPORTING
        es_key_values  = ls_converted_keys ).

    ls_paging-top = io_tech_request_context->get_top( ).
    ls_paging-skip = io_tech_request_context->get_skip( ).

    "MTS: Ajustes filtro OR
    IF lt_filter_select_options_or IS NOT INITIAL OR lt_filter_select_options_and IS NOT INITIAL.
      DESCRIBE TABLE lt_filter_select_options_or LINES lv_veces.
      IF lv_veces IS INITIAL.
        lv_veces = 1.
      ENDIF.
    ELSE.
      lv_veces = 1.
    ENDIF.

    CLEAR posicion.

    IF lt_filter_select_options IS NOT INITIAL.
      zcl_search_dpc=>filtro_mayusculas(
     EXPORTING
       iv_data = ls_gw_e_data
       CHANGING
       ct_filter_select_options = lt_filter_select_options ).

      APPEND LINES OF lt_filter_select_options TO lt_filter_select_options_and.
    ENDIF.



    DO lv_veces TIMES.
      CLEAR: e_data, ir_lgort, ir_matnr, ir_werks.

      ADD 1 TO posicion.
      READ TABLE lt_filter_select_options_or INTO DATA(ls_option_or) INDEX posicion.
      IF sy-subrc = 0.
        lt_filter_select_options = lt_filter_select_options_and.

        APPEND ls_option_or TO lt_filter_select_options.
      ELSE.
        lt_filter_select_options = lt_filter_select_options_and.
      ENDIF.
      "MTS: Ajustes filtro OR

* Maps filter table lines to function module parameters
      LOOP AT lt_filter_select_options INTO ls_filter.

        CASE ls_filter-property.
          WHEN 'WERKS'.              " Equivalent to 'Werks' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_werks ).

            LOOP AT lr_werks INTO ls_werks.
              ls_ir_werks-high = ls_werks-high.
              ls_ir_werks-low = ls_werks-low.
              ls_ir_werks-option = ls_werks-option.
              ls_ir_werks-sign = ls_werks-sign.
              APPEND ls_ir_werks TO ir_werks.
            ENDLOOP.
            CLEAR lr_werks.
          WHEN 'LGORT'.              " Equivalent to 'Lgort' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_lgort ).

            LOOP AT lr_lgort INTO ls_lgort.
              ls_ir_lgort-high = ls_lgort-high.
              ls_ir_lgort-low = ls_lgort-low.
              ls_ir_lgort-option = ls_lgort-option.
              ls_ir_lgort-sign = ls_lgort-sign.
              APPEND ls_ir_lgort TO ir_lgort.
            ENDLOOP.
            CLEAR lr_lgort.
          WHEN 'MATNR'.              " Equivalent to 'Matnr' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_matnr ).

            LOOP AT lr_matnr INTO ls_matnr.
              ls_ir_matnr-high = ls_matnr-high.
              ls_ir_matnr-low = ls_matnr-low.
              ls_ir_matnr-option = ls_matnr-option.
              ls_ir_matnr-sign = ls_matnr-sign.
              APPEND ls_ir_matnr TO ir_matnr.
            ENDLOOP.
            CLEAR lr_matnr.

          WHEN OTHERS.
*       SARCE INI 3###########################################
            " Log message in the application log
            IF NOT iv_search_string IS INITIAL.
              DATA(vv_jump_search) = 'X'.
              CONTINUE.
            ENDIF.
*      SARCE FIN 3###########################################
            " Log message in the application log
            me->/iwbep/if_sb_dpc_comm_services~log_message(
              EXPORTING
                iv_msg_type   = 'E'
                iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
                iv_msg_number = 020
                iv_msg_v1     = ls_filter-property ).
            " Raise Exception
            RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
              EXPORTING
                textid = /iwbep/cx_mgw_tech_exception=>internal_error.
        ENDCASE.

      ENDLOOP.

*      SARCE INI 4###########################################
      IF vv_jump_search = 'X'.
        vv_jump_search = ''.
        CONTINUE.
      ENDIF.
      "MTS: Ajustes
*      SARCE FIN 4###########################################

* Get RFC destination
      lo_dp_facade = /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ).
      lv_destination = /iwbep/cl_sb_gen_dpc_rt_util=>get_rfc_destination( io_dp_facade = lo_dp_facade ).

*-------------------------------------------------------------
*  Call RFC function module
*-------------------------------------------------------------
      lv_rfc_name = 'ZUI5_CM_GET_TIPO_PALLETS'.

      IF lv_destination IS INITIAL OR lv_destination EQ 'NONE'.

        TRY.
            CALL FUNCTION lv_rfc_name
              EXPORTING
                ir_werks       = ir_werks
                ir_lgort       = ir_lgort
                ir_matnr       = ir_matnr
              IMPORTING
                e_return       = e_return
                e_data         = e_data
              EXCEPTIONS
                system_failure = 1000 message lv_exc_msg
                OTHERS         = 1002.

            lv_subrc = sy-subrc.
*in case of co-deployment the exception is raised and needs to be caught
          CATCH cx_root INTO lx_root.
            lv_subrc = 1001.
            lv_exc_msg = lx_root->if_message~get_text( ).
        ENDTRY.

      ELSE.

        CALL FUNCTION lv_rfc_name DESTINATION lv_destination
          EXPORTING
            ir_werks              = ir_werks
            ir_lgort              = ir_lgort
            ir_matnr              = ir_matnr
          IMPORTING
            e_return              = e_return
            e_data                = e_data
          EXCEPTIONS
            system_failure        = 1000 MESSAGE lv_exc_msg
            communication_failure = 1001 MESSAGE lv_exc_msg
            OTHERS                = 1002.

        lv_subrc = sy-subrc.

      ENDIF.

      "MTS: Ajustes
      APPEND LINES OF e_data TO e_data_temp.
*-------------------------------------------------------------
*  Map the RFC response to the caller interface - Only mapped attributes
*-------------------------------------------------------------
*-------------------------------------------------------------
* Error and exception handling
*-------------------------------------------------------------
      IF lv_subrc <> 0.
* Execute the RFC exception handling process
        me->/iwbep/if_sb_dpc_comm_services~rfc_exception_handling(
          EXPORTING
            iv_subrc            = lv_subrc
            iv_exp_message_text = lv_exc_msg ).
      ENDIF.

      IF e_return IS NOT INITIAL.
        me->/iwbep/if_sb_dpc_comm_services~rfc_save_log(
          EXPORTING
            iv_entity_type = iv_entity_name
            it_return      = e_return
            it_key_tab     = it_key_tab ).
      ENDIF.

    ENDDO. "MTS Ajustes
    e_data = e_data_temp.
*-------------------------------------------------------------------------*
*             - Post Backend Call -
*-------------------------------------------------------------------------*
    IF ls_paging-skip IS NOT INITIAL.
*  If the Skip value was requested at runtime
*  the response table will provide backend entries from skip + 1, meaning start from skip +1
*  for example: skip=5 means to start get results from the 6th row
      lv_skip = ls_paging-skip + 1.
    ENDIF.
*  The Top value was requested at runtime but was not handled as part of the function interface
    IF  ls_paging-top <> 0
    AND lv_skip IS NOT INITIAL.
*  if lv_skip > 0 retrieve the entries from lv_skip + Top - 1
*  for example: skip=5 and top=2 means to start get results from the 6th row and end in row number 7
      lv_top = ls_paging-top + lv_skip - 1.
    ELSEIF ls_paging-top <> 0
    AND    lv_skip IS INITIAL.
      lv_top = ls_paging-top.
    ELSE.
      lv_top = lines( e_data ).
    ENDIF.

    "Ordenamos
    IF it_order IS NOT INITIAL.
      SORT e_data BY zcl_search_dpc=>sort_string( EXPORTING iv_instancia = me  ).
      DELETE ADJACENT DUPLICATES FROM e_data.
    ENDIF.
*  - Map properties from the backend to the Gateway output response table -

    LOOP AT e_data INTO ls_e_data
*  Provide the response entries according to the Top and Skip parameters that were provided at runtime
         FROM lv_skip TO lv_top.
*  Only fields that were mapped will be delivered to the response table
      ls_gw_e_data-maktx = ls_e_data-maktx.
      ls_gw_e_data-werks = ls_e_data-werks.
      ls_gw_e_data-lgort = ls_e_data-lgort.
      ls_gw_e_data-matnr = ls_e_data-matnr.
      APPEND ls_gw_e_data TO et_entityset.
      CLEAR ls_gw_e_data.
    ENDLOOP.

  ENDMETHOD.
  METHOD ayudatransport01_get_entityset.
*-------------------------------------------------------------
*  Data declaration
*-------------------------------------------------------------
    DATA lo_filter TYPE  REF TO /iwbep/if_mgw_req_filter.
    DATA lt_filter_select_options TYPE /iwbep/t_mgw_select_option.
    DATA lv_filter_str TYPE string.
    DATA lv_max_hits TYPE i.
    DATA ls_paging TYPE /iwbep/s_mgw_paging.
    DATA ls_converted_keys LIKE LINE OF et_entityset.
    DATA ls_message TYPE bapiret2.
    DATA lt_selopt TYPE ddshselops.
    DATA ls_selopt LIKE LINE OF lt_selopt.
    DATA ls_filter TYPE /iwbep/s_mgw_select_option.
    DATA ls_filter_range TYPE /iwbep/s_cod_select_option.
    DATA lr_land1 LIKE RANGE OF ls_converted_keys-land1.
    DATA ls_land1 LIKE LINE OF lr_land1.
    DATA lr_pstlz LIKE RANGE OF ls_converted_keys-pstlz.
    DATA ls_pstlz LIKE LINE OF lr_pstlz.
    DATA lr_mcod3 LIKE RANGE OF ls_converted_keys-mcod3.
    DATA ls_mcod3 LIKE LINE OF lr_mcod3.
    DATA lr_mcod1 LIKE RANGE OF ls_converted_keys-mcod1.
    DATA ls_mcod1 LIKE LINE OF lr_mcod1.
    DATA lr_lifnr LIKE RANGE OF ls_converted_keys-lifnr.
    DATA ls_lifnr LIKE LINE OF lr_lifnr.
    DATA lt_result_list TYPE /iwbep/if_sb_gendpc_shlp_data=>tt_result_list.
    DATA lv_next TYPE i VALUE 1.
    DATA ls_entityset LIKE LINE OF et_entityset.
    DATA ls_result_list_next LIKE LINE OF lt_result_list.
    DATA ls_result_list LIKE LINE OF lt_result_list.

    "MTS: Ajustes filtro OR
    DATA lt_filter_select_options_and TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_temp TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_or TYPE /iwbep/t_mgw_select_option.
    DATA lt_entityset_temp TYPE zcl_zsui5_cm_gestion_t_mpc=>tt_ayudatransportista.
    DATA lv_veces TYPE i.
    DATA posicion TYPE i.
    "MTS: Ajustes filtro OR

*-------------------------------------------------------------
*  Map the runtime request to the Search Help select option - Only mapped attributes
*-------------------------------------------------------------
* Get all input information from the technical request context object
* Since DPC works with internal property names and runtime API interface holds external property names
* the process needs to get the all needed input information from the technical request context object
* Get filter or select option information
    lo_filter = io_tech_request_context->get_filter( ).
    lt_filter_select_options = lo_filter->get_filter_select_options( ).
    lv_filter_str = lo_filter->get_filter_string( ).

* Check if the supplied filter is supported by standard gateway runtime process
    IF  lv_filter_str            IS NOT INITIAL
    AND lt_filter_select_options IS INITIAL.
      " If the string of the Filter System Query Option is not automatically converted into
      " filter option table (lt_filter_select_options), then the filtering combination is not supported
      " Log message in the application log
*  me->/iwbep/if_sb_dpc_comm_services~log_message(
*    EXPORTING
*      iv_msg_type   = 'E'
*      iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
*      iv_msg_number = 025 ).
*  " Raise Exception
*  RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
*    EXPORTING
*      textid = /iwbep/cx_mgw_tech_exception=>internal_error.
      "MTS: Ajustes filtro OR
      zcl_search_dpc=>filtros_or( EXPORTING iv_instancia = me iv_data = ls_entityset IMPORTING et_filter_select_options_and = lt_filter_select_options_and et_filter_select_options_or = lt_filter_select_options_or ).
      "MTS: Ajustes filtro OR
    ENDIF.
    IF iv_search_string IS NOT INITIAL.
      zcl_search_dpc=>search_or( EXPORTING iv_instancia = me iv_search = iv_search_string iv_data = ls_entityset it_filter_select_options = lt_filter_select_options
                 IMPORTING et_filter_select_options_or = lt_filter_select_options_or ).
    ENDIF.


* Get key table information
    io_tech_request_context->get_converted_source_keys(
      IMPORTING
        es_key_values  = ls_converted_keys ).

    ls_paging-top = io_tech_request_context->get_top( ).
    ls_paging-skip = io_tech_request_context->get_skip( ).

    " Calculate the number of max hits to be fetched from the function module
    " The lv_max_hits value is a summary of the Top and Skip values
    IF ls_paging-top > 0.
      lv_max_hits = is_paging-top + is_paging-skip.
    ENDIF.

    "MTS: Ajustes filtro OR
    IF lt_filter_select_options_or IS NOT INITIAL OR lt_filter_select_options_and IS NOT INITIAL.
      DESCRIBE TABLE lt_filter_select_options_or LINES lv_veces.
      IF lv_veces IS INITIAL.
        lv_veces = 1.
      ENDIF.
    ELSE.
      lv_veces = 1.
    ENDIF.

    CLEAR posicion.

    IF lt_filter_select_options IS NOT INITIAL.
      zcl_search_dpc=>filtro_mayusculas(
     EXPORTING
       iv_data = ls_entityset
       CHANGING
       ct_filter_select_options = lt_filter_select_options ).

      APPEND LINES OF lt_filter_select_options TO lt_filter_select_options_and.
    ENDIF.

    DO lv_veces TIMES.
      CLEAR: lt_result_list, ls_message, lt_selopt.

      ADD 1 TO posicion.
      READ TABLE lt_filter_select_options_or INTO DATA(ls_option_or) INDEX posicion.
      IF sy-subrc = 0.
        lt_filter_select_options = lt_filter_select_options_and.
        APPEND ls_option_or TO lt_filter_select_options.
      ELSE.
        lt_filter_select_options = lt_filter_select_options_and.
      ENDIF.
      "MTS: Ajustes filtro OR

* Maps filter table lines to the Search Help select option table
      LOOP AT lt_filter_select_options INTO ls_filter.

        CASE ls_filter-property.
          WHEN 'LAND1'.              " Equivalent to 'Land1' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_land1 ).

            LOOP AT lr_land1 INTO ls_land1.
              ls_selopt-high = ls_land1-high.
              ls_selopt-low = ls_land1-low.
              ls_selopt-option = ls_land1-option.
              ls_selopt-sign = ls_land1-sign.
              ls_selopt-shlpfield = 'LAND1'.
              ls_selopt-shlpname = 'KREDA'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.
          WHEN 'PSTLZ'.              " Equivalent to 'Pstlz' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_pstlz ).

            LOOP AT lr_pstlz INTO ls_pstlz.
              ls_selopt-high = ls_pstlz-high.
              ls_selopt-low = ls_pstlz-low.
              ls_selopt-option = ls_pstlz-option.
              ls_selopt-sign = ls_pstlz-sign.
              ls_selopt-shlpfield = 'PSTLZ'.
              ls_selopt-shlpname = 'KREDA'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.
          WHEN 'MCOD3'.              " Equivalent to 'Mcod3' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_mcod3 ).

            LOOP AT lr_mcod3 INTO ls_mcod3.
              ls_selopt-high = ls_mcod3-high.
              ls_selopt-low = ls_mcod3-low.
              ls_selopt-option = ls_mcod3-option.
              ls_selopt-sign = ls_mcod3-sign.
              ls_selopt-shlpfield = 'MCOD3'.
              ls_selopt-shlpname = 'KREDA'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.
          WHEN 'MCOD1'.              " Equivalent to 'Mcod1' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_mcod1 ).

            LOOP AT lr_mcod1 INTO ls_mcod1.
              ls_selopt-high = ls_mcod1-high.
              ls_selopt-low = ls_mcod1-low.
              ls_selopt-option = ls_mcod1-option.
              ls_selopt-sign = ls_mcod1-sign.
              ls_selopt-shlpfield = 'MCOD1'.
              ls_selopt-shlpname = 'KREDA'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.
          WHEN 'LIFNR'.              " Equivalent to 'Lifnr' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_lifnr ).

            LOOP AT lr_lifnr INTO ls_lifnr.
              ls_selopt-high = ls_lifnr-high.
              ls_selopt-low = ls_lifnr-low.
              ls_selopt-option = ls_lifnr-option.
              ls_selopt-sign = ls_lifnr-sign.
              ls_selopt-shlpfield = 'LIFNR'.
              ls_selopt-shlpname = 'KREDA'.
              APPEND ls_selopt TO lt_selopt.
              CLEAR ls_selopt.
            ENDLOOP.

          WHEN OTHERS.
*       SARCE INI 3###########################################
            " Log message in the application log
            IF NOT iv_search_string IS INITIAL.
              DATA(vv_jump_search) = 'X'.
              CONTINUE.
            ENDIF.
*      SARCE FIN 3###########################################
            " Log message in the application log
            me->/iwbep/if_sb_dpc_comm_services~log_message(
              EXPORTING
                iv_msg_type   = 'E'
                iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
                iv_msg_number = 020
                iv_msg_v1     = ls_filter-property ).
            " Raise Exception
            RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
              EXPORTING
                textid = /iwbep/cx_mgw_tech_exception=>internal_error.
        ENDCASE.
      ENDLOOP.

*      SARCE INI 4###########################################
      IF vv_jump_search = 'X'.
        vv_jump_search = ''.
        CONTINUE.
      ENDIF.
      "MTS: Ajustes
*      SARCE FIN 4###########################################


*-------------------------------------------------------------
*  Call to Search Help get values mechanism
*-------------------------------------------------------------
* Get search help values
      me->/iwbep/if_sb_gendpc_shlp_data~get_search_help_values(
        EXPORTING
          iv_shlp_name = 'KREDA'
          iv_maxrows = lv_max_hits
          iv_sort = 'X'
          iv_call_shlt_exit = 'X'
          it_selopt = lt_selopt
        IMPORTING
          et_return_list = lt_result_list
          es_message = ls_message ).

*-------------------------------------------------------------
*  Map the Search Help returned results to the caller interface - Only mapped attributes
*-------------------------------------------------------------
      IF ls_message IS NOT INITIAL.
* Call RFC call exception handling
        me->/iwbep/if_sb_dpc_comm_services~rfc_save_log(
          EXPORTING
            is_return      = ls_message
            iv_entity_type = iv_entity_name
            it_key_tab     = it_key_tab ).
      ENDIF.

      CLEAR et_entityset.

      LOOP AT lt_result_list INTO ls_result_list
        WHERE record_number > ls_paging-skip.

        " Move SH results to GW request responce table
        lv_next = sy-tabix + 1. " next loop iteration
        CASE ls_result_list-field_name.
          WHEN 'LAND1'.
            ls_entityset-land1 = ls_result_list-field_value.
          WHEN 'LIFNR'.
            ls_entityset-lifnr = ls_result_list-field_value.
          WHEN 'MCOD1'.
            ls_entityset-mcod1 = ls_result_list-field_value.
          WHEN 'MCOD3'.
            ls_entityset-mcod3 = ls_result_list-field_value.
          WHEN 'PSTLZ'.
            ls_entityset-pstlz = ls_result_list-field_value.
        ENDCASE.

        " Check if the next line in the result list is a new record
        READ TABLE lt_result_list INTO ls_result_list_next INDEX lv_next.
        IF sy-subrc <> 0
        OR ls_result_list-record_number <> ls_result_list_next-record_number.
          " Save the collected SH result in the GW request table
          APPEND ls_entityset TO et_entityset.
          CLEAR: ls_result_list_next, ls_entityset.
        ENDIF.

      ENDLOOP.
      "MTS: Ajustes filtro OR
      APPEND LINES OF et_entityset TO lt_entityset_temp.
    ENDDO.   "MTS: Ajustes filtro OR

    "MTS: Ajustes filtro OR
    SORT lt_entityset_temp BY zcl_search_dpc=>sort_string( EXPORTING iv_instancia = me ).
    DELETE ADJACENT DUPLICATES FROM lt_entityset_temp.
    CLEAR et_entityset.
    IF lv_max_hits NE 0.
      LOOP AT lt_entityset_temp INTO ls_entityset FROM is_paging-skip TO lv_max_hits.
        APPEND ls_entityset TO et_entityset.
      ENDLOOP.
    ELSE.
      et_entityset = lt_entityset_temp.
    ENDIF.
    "MTS: Ajustes filtro OR
  ENDMETHOD.
  METHOD custome_create_deep_entregas.
    DATA: lr_deep_entity TYPE zcl_zsui5_cm_gestion_t_mpc_ext=>ts_deep_entity_entrega,
          i_header       TYPE  zsuis_cm_entregas,
          i_positions    TYPE  zsuitt_cm_posiciones_entrega,
          lt_return      TYPE  bapiret2_t,
          ls_entrega     TYPE  zsuis_cm_entregas.

    DATA vl_charg_2d TYPE charg_d.
    DATA vl_charg_3d TYPE charg_d.
*    DATA tl_return TYPE STANDARD TABLE OF bapiret2.

    io_data_provider->read_entry_data(
      IMPORTING
      es_data = lr_deep_entity ).

    MOVE-CORRESPONDING lr_deep_entity TO i_header.
    MOVE-CORRESPONDING lr_deep_entity-entregaposiciones TO i_positions.
    IF i_header-vbeln IS INITIAL.



      CALL FUNCTION 'ZUI5_CM_CREAR_ENTREGA'
        EXPORTING
          i_header    = i_header
          i_positions = i_positions
        IMPORTING
          o_return    = lt_return
          o_entrega   = ls_entrega.


    ELSE.
      CALL FUNCTION 'ZUI5_CM_MODIFICAR_ENTREGA'
        EXPORTING
          i_header    = i_header
          i_positions = i_positions
        IMPORTING
          o_return    = lt_return
          o_entrega   = ls_entrega.
    ENDIF.

    MOVE-CORRESPONDING ls_entrega TO er_deep_entity.

    MOVE-CORRESPONDING lt_return TO er_return.

  ENDMETHOD.
  METHOD custome_create_deep_transporte.
    DATA: lr_deep_entity TYPE zcl_zsui5_cm_gestion_t_mpc_ext=>ts_deep_entity_transporte.

    io_data_provider->read_entry_data(
      IMPORTING
      es_data = lr_deep_entity ).

    er_deep_entity-tknum = '12233'.

    APPEND INITIAL LINE TO er_deep_entity-transporteentregas  ASSIGNING FIELD-SYMBOL(<ls_entrega>).
    <ls_entrega>-vbeln = '23432323'.

  ENDMETHOD.
  METHOD entregastranspor_get_entity.
*-------------------------------------------------------------
*  Data declaration
*-------------------------------------------------------------
    DATA i_tknum TYPE zif_zui5_cm_get_entregas_trans=>tknum.
    DATA i_vbeln TYPE zif_zui5_cm_get_entregas_trans=>vbeln_vl.
    DATA o_data  TYPE zif_zui5_cm_get_entregas_trans=>zsuitt_cm_entregas.
    DATA o_return  TYPE zif_zui5_cm_get_entregas_trans=>bapiret2_t.
    DATA ls_o_data  TYPE LINE OF zif_zui5_cm_get_entregas_trans=>zsuitt_cm_entregas.
    DATA ls_o_return  TYPE LINE OF zif_zui5_cm_get_entregas_trans=>bapiret2_t.
    DATA lv_rfc_name TYPE tfdir-funcname.
    DATA lv_destination TYPE rfcdest.
    DATA lv_subrc TYPE syst-subrc.
    DATA lv_exc_msg TYPE /iwbep/mgw_bop_rfc_excep_text.
    DATA lx_root TYPE REF TO cx_root.
    DATA ls_converted_keys LIKE er_entity.
    DATA lv_source_entity_set_name TYPE string.
    DATA lo_dp_facade TYPE REF TO /iwbep/if_mgw_dp_facade.

*-------------------------------------------------------------
*  Map the runtime request to the RFC - Only mapped attributes
*-------------------------------------------------------------
* Get all input information from the technical request context object
* Since DPC works with internal property names and runtime API interface holds external property names
* the process needs to get the all needed input information from the technical request context object
* Get key table information - for direct call
    io_tech_request_context->get_converted_keys(
      IMPORTING
        es_key_values = ls_converted_keys ).

* Maps key fields to function module parameters

    lv_source_entity_set_name = io_tech_request_context->get_source_entity_set_name( ).

    IF lv_source_entity_set_name = 'EntregasTransporteSet' AND
       lv_source_entity_set_name NE io_tech_request_context->get_entity_set_name( ).

      io_tech_request_context->get_converted_source_keys(
      IMPORTING es_key_values = ls_converted_keys ).

    ENDIF.

    i_tknum = ls_converted_keys-tknum.
    i_vbeln = ls_converted_keys-vbeln.

    "Aadimos la tabla de navegacin
    IF it_navigation_path IS NOT INITIAL.
      LOOP AT it_navigation_path INTO DATA(ls_nav_path) WHERE nav_prop = 'TransporteEntregas'.
        LOOP AT ls_nav_path-key_tab INTO DATA(ls_key_tab).
          CASE ls_key_tab-name.
            WHEN 'Tknum'.
              i_tknum = ls_key_tab-value.
            WHEN 'Vbeln'.
              i_vbeln = ls_key_tab-value.
          ENDCASE.
        ENDLOOP.
      ENDLOOP.
    ENDIF.

* Get RFC destination
    lo_dp_facade = /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ).
    lv_destination = /iwbep/cl_sb_gen_dpc_rt_util=>get_rfc_destination( io_dp_facade = lo_dp_facade ).

*-------------------------------------------------------------
*  Call RFC function module
*-------------------------------------------------------------
    lv_rfc_name = 'ZUI5_CM_GET_ENTREGAS_TRANS'.

    IF lv_destination IS INITIAL OR lv_destination EQ 'NONE'.

      TRY.
          CALL FUNCTION lv_rfc_name
            EXPORTING
              i_tknum        = i_tknum
              i_vbeln        = i_vbeln
            IMPORTING
              o_return       = o_return
              o_data         = o_data
            EXCEPTIONS
              system_failure = 1000 message lv_exc_msg
              OTHERS         = 1002.

          lv_subrc = sy-subrc.
*in case of co-deployment the exception is raised and needs to be caught
        CATCH cx_root INTO lx_root.
          lv_subrc = 1001.
          lv_exc_msg = lx_root->if_message~get_text( ).
      ENDTRY.

    ELSE.

      CALL FUNCTION lv_rfc_name DESTINATION lv_destination
        EXPORTING
          i_tknum               = i_tknum
          i_vbeln               = i_vbeln
        IMPORTING
          o_return              = o_return
          o_data                = o_data
        EXCEPTIONS
          system_failure        = 1000 MESSAGE lv_exc_msg
          communication_failure = 1001 MESSAGE lv_exc_msg
          OTHERS                = 1002.

      lv_subrc = sy-subrc.

    ENDIF.

*-------------------------------------------------------------
*  Map the RFC response to the caller interface - Only mapped attributes
*-------------------------------------------------------------
*-------------------------------------------------------------
* Error and exception handling
*-------------------------------------------------------------
    IF lv_subrc <> 0.
* Execute the RFC exception handling process
      me->/iwbep/if_sb_dpc_comm_services~rfc_exception_handling(
        EXPORTING
          iv_subrc            = lv_subrc
          iv_exp_message_text = lv_exc_msg ).
    ENDIF.

    IF o_return IS NOT INITIAL.
      me->/iwbep/if_sb_dpc_comm_services~rfc_save_log(
        EXPORTING
          iv_entity_type = iv_entity_name
          it_return      = o_return
          it_key_tab     = it_key_tab ).
    ENDIF.

*-------------------------------------------------------------------------*
*             - Post Backend Call -
*-------------------------------------------------------------------------*
* Map properties from the backend to the Gateway output response structure


* In GetEntity operation we support only read for the first entry in the response table

    READ TABLE o_data INTO ls_o_data INDEX 1.
    er_entity-kunwe = ls_o_data-kunwe.
    er_entity-kunwe_name = ls_o_data-kunwe_name.
    er_entity-wadat = ls_o_data-wadat.
    er_entity-route = ls_o_data-route.
    er_entity-inco1 = ls_o_data-inco1.
    er_entity-kunag = ls_o_data-kunag.
    er_entity-kunag_name = ls_o_data-kunag_name.
    er_entity-tknum = ls_o_data-tknum.
    er_entity-vbeln = ls_o_data-vbeln.
    er_entity-vstel = ls_o_data-vstel.
    er_entity-vstel_name = ls_o_data-vstel_name.
    er_entity-devolucion = ls_o_data-devolucion.
    er_entity-augru = ls_o_data-augru.
    er_entity-augru_name = ls_o_data-augru_name.
    er_entity-bstkd = ls_o_data-bstkd.
    er_entity-street = ls_o_data-street.
    er_entity-city = ls_o_data-city.
  ENDMETHOD.
  METHOD entregastranspor_get_entityset.
*-------------------------------------------------------------
*  Data declaration
*-------------------------------------------------------------
    DATA ir_cliente  TYPE zif_zui5_cm_get_entregas_trans=>shp_kunwe_range_t.
    DATA ir_cliente_nombre  TYPE zif_zui5_cm_get_entregas_trans=>zsuis_cm_nombres_rang.
    DATA ir_destinatario  TYPE zif_zui5_cm_get_entregas_trans=>shp_kunwe_range_t.
    DATA ir_destinatario_nombre  TYPE zif_zui5_cm_get_entregas_trans=>zsuis_cm_nombres_rang.
    DATA ir_fecha  TYPE zif_zui5_cm_get_entregas_trans=>date_t_range.
    DATA ir_incoterm  TYPE zif_zui5_cm_get_entregas_trans=>shp_inco1_range_t.
    DATA ir_ruta  TYPE zif_zui5_cm_get_entregas_trans=>shp_route_range_t.
    DATA ir_tknum  TYPE zif_zui5_cm_get_entregas_trans=>shp_tknum_range_t.
    DATA ir_tknum_nav  TYPE zif_zui5_cm_get_entregas_trans=>shp_tknum_range_t.
    DATA ir_vbeln  TYPE zif_zui5_cm_get_entregas_trans=>/eby/_lbapidlv_range_vbeln.
    DATA o_data  TYPE zif_zui5_cm_get_entregas_trans=>zsuitt_cm_entregas.
    DATA o_return  TYPE zif_zui5_cm_get_entregas_trans=>bapiret2_t.
    DATA ls_ir_cliente  TYPE LINE OF zif_zui5_cm_get_entregas_trans=>shp_kunwe_range_t.
    DATA ls_ir_cliente_nombre  TYPE LINE OF zif_zui5_cm_get_entregas_trans=>zsuis_cm_nombres_rang.
    DATA ls_ir_destinatario  TYPE LINE OF zif_zui5_cm_get_entregas_trans=>shp_kunwe_range_t.
    DATA ls_ir_destinatario_nombre  TYPE LINE OF zif_zui5_cm_get_entregas_trans=>zsuis_cm_nombres_rang.
    DATA ls_ir_fecha  TYPE LINE OF zif_zui5_cm_get_entregas_trans=>date_t_range.
    DATA ls_ir_incoterm  TYPE LINE OF zif_zui5_cm_get_entregas_trans=>shp_inco1_range_t.
    DATA ls_ir_ruta  TYPE LINE OF zif_zui5_cm_get_entregas_trans=>shp_route_range_t.
    DATA ls_ir_tknum  TYPE LINE OF zif_zui5_cm_get_entregas_trans=>shp_tknum_range_t.
    DATA ls_ir_vbeln  TYPE LINE OF zif_zui5_cm_get_entregas_trans=>/eby/_lbapidlv_range_vbeln.
    DATA ls_o_data  TYPE LINE OF zif_zui5_cm_get_entregas_trans=>zsuitt_cm_entregas.
    DATA ls_o_return  TYPE LINE OF zif_zui5_cm_get_entregas_trans=>bapiret2_t.
    DATA lv_rfc_name TYPE tfdir-funcname.
    DATA lv_destination TYPE rfcdest.
    DATA lv_subrc TYPE syst-subrc.
    DATA lv_exc_msg TYPE /iwbep/mgw_bop_rfc_excep_text.
    DATA lx_root TYPE REF TO cx_root.
    DATA lo_filter TYPE  REF TO /iwbep/if_mgw_req_filter.
    DATA lt_filter_select_options TYPE /iwbep/t_mgw_select_option.
    DATA lv_filter_str TYPE string.
    DATA ls_paging TYPE /iwbep/s_mgw_paging.
    DATA ls_converted_keys LIKE LINE OF et_entityset.
    DATA lv_source_entity_set_name TYPE string.
    DATA transportesset_get_entityset TYPE LINE OF zcl_zsui5_cm_gestion_t_mpc=>tt_transportes.
    DATA ls_filter TYPE /iwbep/s_mgw_select_option.
    DATA ls_filter_range TYPE /iwbep/s_cod_select_option.
    DATA lr_vbeln LIKE RANGE OF ls_converted_keys-vbeln.
    DATA ls_vbeln LIKE LINE OF lr_vbeln.
    DATA lr_kunwe LIKE RANGE OF ls_converted_keys-kunwe.
    DATA ls_kunwe LIKE LINE OF lr_kunwe.
    DATA lr_kunwe_name LIKE RANGE OF ls_converted_keys-kunwe_name.
    DATA ls_kunwe_name LIKE LINE OF lr_kunwe_name.
    DATA lr_wadat LIKE RANGE OF ls_converted_keys-wadat.
    DATA ls_wadat LIKE LINE OF lr_wadat.
    DATA lr_route LIKE RANGE OF ls_converted_keys-route.
    DATA ls_route LIKE LINE OF lr_route.
    DATA lr_inco1 LIKE RANGE OF ls_converted_keys-inco1.
    DATA ls_inco1 LIKE LINE OF lr_inco1.
    DATA lr_kunag LIKE RANGE OF ls_converted_keys-kunag.
    DATA ls_kunag LIKE LINE OF lr_kunag.
    DATA lr_kunag_name LIKE RANGE OF ls_converted_keys-kunag_name.
    DATA ls_kunag_name LIKE LINE OF lr_kunag_name.
    DATA lr_tknum LIKE RANGE OF ls_converted_keys-tknum.
    DATA ls_tknum LIKE LINE OF lr_tknum.
    DATA lo_dp_facade TYPE REF TO /iwbep/if_mgw_dp_facade.
    DATA ls_gw_o_data LIKE LINE OF et_entityset.
    DATA lv_skip     TYPE int4.
    DATA lv_top      TYPE int4.

    "MTS: Ajustes filtro OR
    DATA lt_filter_select_options_and TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_temp TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_or TYPE /iwbep/t_mgw_select_option.
    DATA lv_veces TYPE i.
    DATA posicion TYPE i.
    DATA o_data_temp  TYPE zif_zui5_cm_get_entregas_trans=>zsuitt_cm_entregas.
    "MTS: Ajustes filtro OR

*-------------------------------------------------------------
*  Map the runtime request to the RFC - Only mapped attributes
*-------------------------------------------------------------
* Get all input information from the technical request context object
* Since DPC works with internal property names and runtime API interface holds external property names
* the process needs to get the all needed input information from the technical request context object
* Get filter or select option information
    lo_filter = io_tech_request_context->get_filter( ).
    lt_filter_select_options = lo_filter->get_filter_select_options( ).
    lv_filter_str = lo_filter->get_filter_string( ).

* Check if the supplied filter is supported by standard gateway runtime process
    IF  lv_filter_str            IS NOT INITIAL
    AND lt_filter_select_options IS INITIAL.
      " If the string of the Filter System Query Option is not automatically converted into
      " filter option table (lt_filter_select_options), then the filtering combination is not supported
      " Log message in the application log
*   me->/iwbep/if_sb_dpc_comm_services~log_message(
*     EXPORTING
*       iv_msg_type   = 'E'
*       iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
*       iv_msg_number = 025 ).
*   " Raise Exception
*   RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
*     EXPORTING
*       textid = /iwbep/cx_mgw_tech_exception=>internal_error.
      "MTS: Ajustes filtro OR
      zcl_search_dpc=>filtros_or( EXPORTING iv_instancia = me iv_data = ls_gw_o_data IMPORTING et_filter_select_options_and = lt_filter_select_options_and et_filter_select_options_or = lt_filter_select_options_or ).
      "MTS: Ajustes filtro OR
    ENDIF.
    IF iv_search_string IS NOT INITIAL.
      zcl_search_dpc=>search_or( EXPORTING iv_instancia = me iv_search = iv_search_string iv_data = ls_gw_o_data it_filter_select_options = lt_filter_select_options
                 IMPORTING et_filter_select_options_or = lt_filter_select_options_or ).
    ENDIF.

* Get key table information
    io_tech_request_context->get_converted_source_keys(
      IMPORTING
        es_key_values  = ls_converted_keys ).

    ls_paging-top = io_tech_request_context->get_top( ).
    ls_paging-skip = io_tech_request_context->get_skip( ).

* Maps key fields to function module parameters
    IF it_key_tab IS NOT INITIAL.

      lv_source_entity_set_name = io_tech_request_context->get_source_entity_set_name( ).

      IF  lv_source_entity_set_name = 'TransportesSet'.
        " Convert keys to appropriate entity set structure
        io_tech_request_context->get_converted_source_keys(
          IMPORTING
            es_key_values  = transportesset_get_entityset ).
        ls_ir_tknum-low = transportesset_get_entityset-tknum. " Equivalent to 'Tknum' property in the service
        ls_ir_tknum-option = 'EQ'.
        ls_ir_tknum-sign = 'I'.
        APPEND ls_ir_tknum TO ir_tknum_nav.

      ENDIF.

    ENDIF.

*    IF it_filter_select_options IS NOT INITIAL.

    "MTS: Ajustes filtro OR
    IF lt_filter_select_options_or IS NOT INITIAL OR lt_filter_select_options_and IS NOT INITIAL.
      DESCRIBE TABLE lt_filter_select_options_or LINES lv_veces.
      IF lv_veces IS INITIAL.
        lv_veces = 1.
      ENDIF.
    ELSE.
      lv_veces = 1.
    ENDIF.

    CLEAR posicion.

    IF lt_filter_select_options IS NOT INITIAL.
      zcl_search_dpc=>filtro_mayusculas(
     EXPORTING
       iv_data = ls_gw_o_data
       CHANGING
       ct_filter_select_options = lt_filter_select_options ).

      APPEND LINES OF lt_filter_select_options TO lt_filter_select_options_and.
    ENDIF.

    DO lv_veces TIMES.
      CLEAR: o_data, ir_cliente, ir_cliente_nombre, ir_destinatario, ir_destinatario_nombre, ir_fecha, ir_incoterm, ir_ruta, ir_tknum, ir_vbeln.

      IF ir_tknum_nav IS NOT INITIAL.
        APPEND LINES OF ir_tknum_nav TO ir_tknum.
      ENDIF.

      ADD 1 TO posicion.
      READ TABLE lt_filter_select_options_or INTO DATA(ls_option_or) INDEX posicion.
      IF sy-subrc = 0.
        lt_filter_select_options = lt_filter_select_options_and.

        APPEND ls_option_or TO lt_filter_select_options.
      ENDIF.
      "MTS: Ajustes filtro OR

* Maps filter table lines to function module parameters
      LOOP AT lt_filter_select_options INTO ls_filter.

        CASE ls_filter-property.
          WHEN 'VBELN'.              " Equivalent to 'Vbeln' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_vbeln ).

            LOOP AT lr_vbeln INTO ls_vbeln.
              ls_ir_vbeln-deliv_numb_high = ls_vbeln-high.
              ls_ir_vbeln-deliv_numb_low = ls_vbeln-low.
              ls_ir_vbeln-option = ls_vbeln-option.
              ls_ir_vbeln-sign = ls_vbeln-sign.
              APPEND ls_ir_vbeln TO ir_vbeln.
            ENDLOOP.
            CLEAR lr_vbeln.
          WHEN 'KUNWE'.              " Equivalent to 'Kunwe' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_kunwe ).

            LOOP AT lr_kunwe INTO ls_kunwe.
              ls_ir_destinatario-high = ls_kunwe-high.
              ls_ir_destinatario-low = ls_kunwe-low.
              ls_ir_destinatario-option = ls_kunwe-option.
              ls_ir_destinatario-sign = ls_kunwe-sign.
              APPEND ls_ir_destinatario TO ir_destinatario.
            ENDLOOP.
            CLEAR lr_kunwe.
          WHEN 'KUNWE_NAME'.              " Equivalent to 'KunweName' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_kunwe_name ).

            LOOP AT lr_kunwe_name INTO ls_kunwe_name.
              ls_ir_destinatario_nombre-high = ls_kunwe_name-high.
              ls_ir_destinatario_nombre-low = ls_kunwe_name-low.
              ls_ir_destinatario_nombre-option = ls_kunwe_name-option.
              ls_ir_destinatario_nombre-sign = ls_kunwe_name-sign.
              APPEND ls_ir_destinatario_nombre TO ir_destinatario_nombre.
            ENDLOOP.
            CLEAR lr_kunwe_name.
          WHEN 'WADAT'.              " Equivalent to 'Wadat' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_wadat ).

            LOOP AT lr_wadat INTO ls_wadat.
              ls_ir_fecha-high = ls_wadat-high.
              ls_ir_fecha-low = ls_wadat-low.
              ls_ir_fecha-option = ls_wadat-option.
              ls_ir_fecha-sign = ls_wadat-sign.
              APPEND ls_ir_fecha TO ir_fecha.
            ENDLOOP.
            CLEAR lr_wadat.
          WHEN 'ROUTE'.              " Equivalent to 'Route' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_route ).

            LOOP AT lr_route INTO ls_route.
              ls_ir_ruta-high = ls_route-high.
              ls_ir_ruta-low = ls_route-low.
              ls_ir_ruta-option = ls_route-option.
              ls_ir_ruta-sign = ls_route-sign.
              APPEND ls_ir_ruta TO ir_ruta.
            ENDLOOP.
            CLEAR lr_route.
          WHEN 'INCO1'.              " Equivalent to 'Inco1' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_inco1 ).

            LOOP AT lr_inco1 INTO ls_inco1.
              ls_ir_incoterm-high = ls_inco1-high.
              ls_ir_incoterm-low = ls_inco1-low.
              ls_ir_incoterm-option = ls_inco1-option.
              ls_ir_incoterm-sign = ls_inco1-sign.
              APPEND ls_ir_incoterm TO ir_incoterm.
            ENDLOOP.
            CLEAR lr_inco1.
          WHEN 'KUNAG'.              " Equivalent to 'Kunag' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_kunag ).

            LOOP AT lr_kunag INTO ls_kunag.
              ls_ir_cliente-high = ls_kunag-high.
              ls_ir_cliente-low = ls_kunag-low.
              ls_ir_cliente-option = ls_kunag-option.
              ls_ir_cliente-sign = ls_kunag-sign.
              APPEND ls_ir_cliente TO ir_cliente.
            ENDLOOP.
            CLEAR lr_kunag.
          WHEN 'KUNAG_NAME'.              " Equivalent to 'KunagName' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_kunag_name ).

            LOOP AT lr_kunag_name INTO ls_kunag_name.
              ls_ir_cliente_nombre-high = ls_kunag_name-high.
              ls_ir_cliente_nombre-low = ls_kunag_name-low.
              ls_ir_cliente_nombre-option = ls_kunag_name-option.
              ls_ir_cliente_nombre-sign = ls_kunag_name-sign.
              APPEND ls_ir_cliente_nombre TO ir_cliente_nombre.
            ENDLOOP.
            CLEAR lr_kunag_name.
          WHEN 'TKNUM'.              " Equivalent to 'Tknum' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_tknum ).

            LOOP AT lr_tknum INTO ls_tknum.
              ls_ir_tknum-high = ls_tknum-high.
              ls_ir_tknum-low = ls_tknum-low.
              ls_ir_tknum-option = ls_tknum-option.
              ls_ir_tknum-sign = ls_tknum-sign.
              APPEND ls_ir_tknum TO ir_tknum.
            ENDLOOP.
            CLEAR lr_tknum.

          WHEN OTHERS.
*       SARCE INI 3###########################################
            " Log message in the application log
            IF NOT iv_search_string IS INITIAL.
              DATA(vv_jump_search) = 'X'.
              CONTINUE.
            ENDIF.
*      SARCE FIN 3###########################################
            " Log message in the application log
            me->/iwbep/if_sb_dpc_comm_services~log_message(
              EXPORTING
                iv_msg_type   = 'E'
                iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
                iv_msg_number = 020
                iv_msg_v1     = ls_filter-property ).
            " Raise Exception
            RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
              EXPORTING
                textid = /iwbep/cx_mgw_tech_exception=>internal_error.
        ENDCASE.

      ENDLOOP.
*      SARCE INI 4###########################################
      IF vv_jump_search = 'X'.
        vv_jump_search = ''.
        CONTINUE.
      ENDIF.
      "MTS: Ajustes
*      SARCE FIN 4###########################################


* Get RFC destination
      lo_dp_facade = /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ).
      lv_destination = /iwbep/cl_sb_gen_dpc_rt_util=>get_rfc_destination( io_dp_facade = lo_dp_facade ).

*-------------------------------------------------------------
*  Call RFC function module
*-------------------------------------------------------------
      lv_rfc_name = 'ZUI5_CM_GET_ENTREGAS_TRANS'.

      IF lv_destination IS INITIAL OR lv_destination EQ 'NONE'.

        TRY.
            CALL FUNCTION lv_rfc_name
              EXPORTING
                ir_vbeln               = ir_vbeln
                ir_destinatario        = ir_destinatario
                ir_destinatario_nombre = ir_destinatario_nombre
                ir_fecha               = ir_fecha
                ir_ruta                = ir_ruta
                ir_incoterm            = ir_incoterm
                ir_cliente             = ir_cliente
                ir_cliente_nombre      = ir_cliente_nombre
                ir_tknum               = ir_tknum
              IMPORTING
                o_return               = o_return
                o_data                 = o_data
              EXCEPTIONS
                system_failure         = 1000 message lv_exc_msg
                OTHERS                 = 1002.

            lv_subrc = sy-subrc.
*in case of co-deployment the exception is raised and needs to be caught
          CATCH cx_root INTO lx_root.
            lv_subrc = 1001.
            lv_exc_msg = lx_root->if_message~get_text( ).
        ENDTRY.

      ELSE.

        CALL FUNCTION lv_rfc_name DESTINATION lv_destination
          EXPORTING
            ir_vbeln               = ir_vbeln
            ir_destinatario        = ir_destinatario
            ir_destinatario_nombre = ir_destinatario_nombre
            ir_fecha               = ir_fecha
            ir_ruta                = ir_ruta
            ir_incoterm            = ir_incoterm
            ir_cliente             = ir_cliente
            ir_cliente_nombre      = ir_cliente_nombre
            ir_tknum               = ir_tknum
          IMPORTING
            o_return               = o_return
            o_data                 = o_data
          EXCEPTIONS
            system_failure         = 1000 MESSAGE lv_exc_msg
            communication_failure  = 1001 MESSAGE lv_exc_msg
            OTHERS                 = 1002.

        lv_subrc = sy-subrc.

      ENDIF.

      "MTS: Ajustes
      APPEND LINES OF o_data TO o_data_temp.

*-------------------------------------------------------------
*  Map the RFC response to the caller interface - Only mapped attributes
*-------------------------------------------------------------
*-------------------------------------------------------------
* Error and exception handling
*-------------------------------------------------------------
      IF lv_subrc <> 0.
* Execute the RFC exception handling process
        me->/iwbep/if_sb_dpc_comm_services~rfc_exception_handling(
          EXPORTING
            iv_subrc            = lv_subrc
            iv_exp_message_text = lv_exc_msg ).
      ENDIF.

      IF o_return IS NOT INITIAL.
        me->/iwbep/if_sb_dpc_comm_services~rfc_save_log(
          EXPORTING
            iv_entity_type = iv_entity_name
            it_return      = o_return
            it_key_tab     = it_key_tab ).
      ENDIF.

    ENDDO. "MTS Ajustes
    o_data = o_data_temp.
*-------------------------------------------------------------------------*
*             - Post Backend Call -
*-------------------------------------------------------------------------*
    IF ls_paging-skip IS NOT INITIAL.
*  If the Skip value was requested at runtime
*  the response table will provide backend entries from skip + 1, meaning start from skip +1
*  for example: skip=5 means to start get results from the 6th row
      lv_skip = ls_paging-skip + 1.
    ENDIF.
*  The Top value was requested at runtime but was not handled as part of the function interface
    IF  ls_paging-top <> 0
    AND lv_skip IS NOT INITIAL.
*  if lv_skip > 0 retrieve the entries from lv_skip + Top - 1
*  for example: skip=5 and top=2 means to start get results from the 6th row and end in row number 7
      lv_top = ls_paging-top + lv_skip - 1.
    ELSEIF ls_paging-top <> 0
    AND    lv_skip IS INITIAL.
      lv_top = ls_paging-top.
    ELSE.
      lv_top = lines( o_data ).
    ENDIF.

    "Ordenamos
    IF it_order IS NOT INITIAL.
      SORT o_data BY zcl_search_dpc=>sort_string( EXPORTING iv_instancia = me ).
      DELETE ADJACENT DUPLICATES FROM o_data.
    ENDIF.


*  - Map properties from the backend to the Gateway output response table -

    LOOP AT o_data INTO ls_o_data
*  Provide the response entries according to the Top and Skip parameters that were provided at runtime
         FROM lv_skip TO lv_top.
*  Only fields that were mapped will be delivered to the response table
      ls_gw_o_data-tknum = ls_o_data-tknum.
      ls_gw_o_data-vbeln = ls_o_data-vbeln.
      ls_gw_o_data-kunwe = ls_o_data-kunwe.
      ls_gw_o_data-kunwe_name = ls_o_data-kunwe_name.
      ls_gw_o_data-wadat = ls_o_data-wadat.
      ls_gw_o_data-route = ls_o_data-route.
      ls_gw_o_data-inco1 = ls_o_data-inco1.
      ls_gw_o_data-kunag = ls_o_data-kunag.
      ls_gw_o_data-kunag_name = ls_o_data-kunag_name.
      ls_gw_o_data-vstel = ls_o_data-vstel.
      ls_gw_o_data-vstel_name = ls_o_data-vstel_name.
      ls_gw_o_data-devolucion = ls_o_data-devolucion.
      ls_gw_o_data-augru = ls_o_data-augru.
      ls_gw_o_data-augru_name = ls_o_data-augru_name.
      ls_gw_o_data-bstkd = ls_o_data-bstkd.
      ls_gw_o_data-city = ls_o_data-city.
      ls_gw_o_data-street = ls_o_data-street.
      APPEND ls_gw_o_data TO et_entityset.
      CLEAR ls_gw_o_data.
    ENDLOOP.

  ENDMETHOD.
  METHOD materialesdevset_get_entityset.
*-------------------------------------------------------------
*  Data declaration
*-------------------------------------------------------------
    DATA i_almacen_montaje TYPE zif_zui5_cm_get_materiales_dev=>lgort_d.
    DATA i_centro_montaje TYPE zif_zui5_cm_get_materiales_dev=>werks_d.
    DATA ir_alto  TYPE zif_zui5_cm_get_materiales_dev=>zsuitt_cm_dimensiones_range.
    DATA ir_ancho  TYPE zif_zui5_cm_get_materiales_dev=>zsuitt_cm_dimensiones_range.
    DATA ir_kunnr  TYPE zif_zui5_cm_get_materiales_dev=>zsui_cm_kunnr_range_t.
    DATA ir_largo  TYPE zif_zui5_cm_get_materiales_dev=>zsuitt_cm_dimensiones_range.
    DATA ir_lote  TYPE zif_zui5_cm_get_materiales_dev=>ranges_charg_tt.
    DATA ir_maktx  TYPE zif_zui5_cm_get_materiales_dev=>fip_t_maktx_range.
    DATA ir_matnr  TYPE zif_zui5_cm_get_materiales_dev=>ranges_matnr_tt.
    DATA ir_status  TYPE zif_zui5_cm_get_materiales_dev=>zui5r_cm_status.
    DATA ir_stock_libre  TYPE zif_zui5_cm_get_materiales_dev=>zsuitt_cm_cantidad_range.
    DATA ir_stock_pedido  TYPE zif_zui5_cm_get_materiales_dev=>zsuitt_cm_cantidad_range.
    DATA ir_stock_total  TYPE zif_zui5_cm_get_materiales_dev=>zsuitt_cm_cantidad_range.
    DATA ir_dimensiones  TYPE rseloption.
    DATA ir_vbeln  TYPE zif_zui5_cm_get_materiales_dev=>sd_vbeln_ranges.

    DATA o_data  TYPE zif_zui5_cm_get_materiales_dev=>zsuitt_cm_materiales_dev.
    DATA o_return  TYPE zif_zui5_cm_get_materiales_dev=>bapiret2_t.
    DATA ls_ir_alto  TYPE LINE OF zif_zui5_cm_get_materiales_dev=>zsuitt_cm_dimensiones_range.
    DATA ls_ir_ancho  TYPE LINE OF zif_zui5_cm_get_materiales_dev=>zsuitt_cm_dimensiones_range.
    DATA ls_ir_kunnr  TYPE LINE OF zif_zui5_cm_get_materiales_dev=>zsui_cm_kunnr_range_t.
    DATA ls_ir_largo  TYPE LINE OF zif_zui5_cm_get_materiales_dev=>zsuitt_cm_dimensiones_range.
    DATA ls_ir_lote  TYPE LINE OF zif_zui5_cm_get_materiales_dev=>ranges_charg_tt.
    DATA ls_ir_maktx  TYPE LINE OF zif_zui5_cm_get_materiales_dev=>fip_t_maktx_range.
    DATA ls_ir_matnr  TYPE LINE OF zif_zui5_cm_get_materiales_dev=>ranges_matnr_tt.
    DATA ls_ir_status  TYPE LINE OF zif_zui5_cm_get_materiales_dev=>zui5r_cm_status.
    DATA ls_ir_stock_libre  TYPE LINE OF zif_zui5_cm_get_materiales_dev=>zsuitt_cm_cantidad_range.
    DATA ls_ir_stock_pedido  TYPE LINE OF zif_zui5_cm_get_materiales_dev=>zsuitt_cm_cantidad_range.
    DATA ls_ir_stock_total  TYPE LINE OF zif_zui5_cm_get_materiales_dev=>zsuitt_cm_cantidad_range.
    DATA ls_o_data  TYPE LINE OF zif_zui5_cm_get_materiales_dev=>zsuitt_cm_materiales_dev.
    DATA ls_o_return  TYPE LINE OF zif_zui5_cm_get_materiales_dev=>bapiret2_t.
    DATA lv_rfc_name TYPE tfdir-funcname.
    DATA lv_destination TYPE rfcdest.
    DATA lv_subrc TYPE syst-subrc.
    DATA lv_exc_msg TYPE /iwbep/mgw_bop_rfc_excep_text.
    DATA lx_root TYPE REF TO cx_root.
    DATA lo_filter TYPE  REF TO /iwbep/if_mgw_req_filter.
    DATA lt_filter_select_options TYPE /iwbep/t_mgw_select_option.
    DATA lv_filter_str TYPE string.
    DATA ls_paging TYPE /iwbep/s_mgw_paging.
    DATA ls_converted_keys LIKE LINE OF et_entityset.
    DATA ls_filter TYPE /iwbep/s_mgw_select_option.
    DATA ls_filter_range TYPE /iwbep/s_cod_select_option.
    DATA lr_lgort LIKE RANGE OF ls_converted_keys-lgort.
    DATA ls_lgort LIKE LINE OF lr_lgort.
    DATA lr_werks LIKE RANGE OF ls_converted_keys-werks.
    DATA ls_werks LIKE LINE OF lr_werks.
    DATA lr_stock_total LIKE RANGE OF ls_converted_keys-stock_total.
    DATA ls_stock_total LIKE LINE OF lr_stock_total.
    DATA lr_stock_pedido LIKE RANGE OF ls_converted_keys-stock_pedido.
    DATA ls_stock_pedido LIKE LINE OF lr_stock_pedido.
    DATA lr_stock_libre LIKE RANGE OF ls_converted_keys-stock_libre.
    DATA ls_stock_libre LIKE LINE OF lr_stock_libre.
    DATA lr_status_lote LIKE RANGE OF ls_converted_keys-status_lote.
    DATA ls_status_lote LIKE LINE OF lr_status_lote.
    DATA lr_refdoc LIKE RANGE OF ls_converted_keys-refdoc.
    DATA ls_refdoc LIKE LINE OF lr_refdoc.
    DATA lr_matnr LIKE RANGE OF ls_converted_keys-matnr.
    DATA ls_matnr LIKE LINE OF lr_matnr.
    DATA lr_maktx LIKE RANGE OF ls_converted_keys-maktx.
    DATA ls_maktx LIKE LINE OF lr_maktx.
    DATA lr_charg LIKE RANGE OF ls_converted_keys-charg.
    DATA ls_charg LIKE LINE OF lr_charg.
    DATA lr_largo LIKE RANGE OF ls_converted_keys-largo.
    DATA ls_largo LIKE LINE OF lr_largo.
    DATA lr_kunnr LIKE RANGE OF ls_converted_keys-kunnr.
    DATA ls_kunnr LIKE LINE OF lr_kunnr.
    DATA lr_alto LIKE RANGE OF ls_converted_keys-alto.
    DATA ls_alto LIKE LINE OF lr_alto.
    DATA lr_ancho LIKE RANGE OF ls_converted_keys-ancho.
    DATA ls_ancho LIKE LINE OF lr_ancho.
    DATA lr_dimensiones LIKE RANGE OF ls_converted_keys-dimensiones.
    DATA ls_ir_vbeln  TYPE LINE OF zif_zui5_cm_get_materiales_dev=>sd_vbeln_ranges.
    DATA ls_dimensiones LIKE LINE OF lr_dimensiones.
    DATA lo_dp_facade TYPE REF TO /iwbep/if_mgw_dp_facade.
    DATA ls_gw_o_data LIKE LINE OF et_entityset.
    DATA lv_skip     TYPE int4.
    DATA lv_top      TYPE int4.

    "MTS: Ajustes filtro OR
    DATA lt_filter_select_options_and TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_temp TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_or TYPE /iwbep/t_mgw_select_option.
    DATA lv_veces TYPE i.
    DATA posicion TYPE i.
    DATA o_data_temp  TYPE zif_zui5_cm_get_materiales_dev=>zsuitt_cm_materiales_dev.
    "MTS: Ajustes filtro OR

*-------------------------------------------------------------
*  Map the runtime request to the RFC - Only mapped attributes
*-------------------------------------------------------------
* Get all input information from the technical request context object
* Since DPC works with internal property names and runtime API interface holds external property names
* the process needs to get the all needed input information from the technical request context object
* Get filter or select option information
    lo_filter = io_tech_request_context->get_filter( ).
    lt_filter_select_options = lo_filter->get_filter_select_options( ).
    lv_filter_str = lo_filter->get_filter_string( ).

* Check if the supplied filter is supported by standard gateway runtime process
    IF  lv_filter_str            IS NOT INITIAL
    AND lt_filter_select_options IS INITIAL.
      " If the string of the Filter System Query Option is not automatically converted into
      " filter option table (lt_filter_select_options), then the filtering combination is not supported
      " Log message in the application log
*      me->/iwbep/if_sb_dpc_comm_services~log_message(
*        EXPORTING
*          iv_msg_type   = 'E'
*          iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
*          iv_msg_number = 025 ).
*      " Raise Exception
*      RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
*        EXPORTING
*          textid = /iwbep/cx_mgw_tech_exception=>internal_error.
      "MTS: Ajustes filtro OR
      zcl_search_dpc=>filtros_or( EXPORTING iv_instancia = me iv_data = ls_gw_o_data IMPORTING et_filter_select_options_and = lt_filter_select_options_and et_filter_select_options_or = lt_filter_select_options_or ).
      "MTS: Ajustes filtro OR
    ENDIF.
    IF iv_search_string IS NOT INITIAL.
      zcl_search_dpc=>search_or( EXPORTING iv_instancia = me iv_search = iv_search_string iv_data = ls_gw_o_data it_filter_select_options = lt_filter_select_options
                 IMPORTING et_filter_select_options_or = lt_filter_select_options_or ).
    ENDIF.

* Get key table information
    io_tech_request_context->get_converted_source_keys(
      IMPORTING
        es_key_values  = ls_converted_keys ).

    ls_paging-top = io_tech_request_context->get_top( ).
    ls_paging-skip = io_tech_request_context->get_skip( ).

    "MTS: Ajustes filtro OR
    IF lt_filter_select_options_or IS NOT INITIAL OR lt_filter_select_options_and IS NOT INITIAL.
      DESCRIBE TABLE lt_filter_select_options_or LINES lv_veces.
      IF lv_veces IS INITIAL.
        lv_veces = 1.
      ENDIF.
    ELSE.
      lv_veces = 1.
    ENDIF.

    CLEAR posicion.

    IF lt_filter_select_options IS NOT INITIAL.
      zcl_search_dpc=>filtro_mayusculas(
     EXPORTING
       iv_data = ls_gw_o_data
       CHANGING
       ct_filter_select_options = lt_filter_select_options ).

      APPEND LINES OF lt_filter_select_options TO lt_filter_select_options_and.
    ENDIF.

    DO lv_veces TIMES.
      CLEAR: o_data, ir_vbeln, ir_alto, ir_ancho, ir_kunnr, ir_largo, ir_lote, ir_maktx, ir_matnr, ir_status, ir_stock_libre, ir_stock_pedido, ir_stock_total,ir_dimensiones.

      ADD 1 TO posicion.
      READ TABLE lt_filter_select_options_or INTO DATA(ls_option_or) INDEX posicion.
      IF sy-subrc = 0.
        lt_filter_select_options = lt_filter_select_options_and.

        APPEND ls_option_or TO lt_filter_select_options.
      ELSE.
        lt_filter_select_options = lt_filter_select_options_and.
      ENDIF.
      "MTS: Ajustes filtro OR

* Maps filter table lines to function module parameters
      LOOP AT lt_filter_select_options INTO ls_filter.

        CASE ls_filter-property.
          WHEN 'REFDOC'.              " Equivalent to 'Refdoc' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_refdoc ).

            LOOP AT lr_refdoc INTO ls_refdoc.
              ls_ir_vbeln-sign = ls_refdoc-sign.
              ls_ir_vbeln-option = ls_refdoc-option.
              ls_ir_vbeln-low = ls_refdoc-low.
              ls_ir_vbeln-high = ls_refdoc-high.
              APPEND ls_ir_vbeln TO ir_vbeln.
            ENDLOOP.
            CLEAR lr_refdoc.
          WHEN 'LGORT'.
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_lgort ).

            READ TABLE lr_lgort INTO ls_lgort INDEX 1.
            IF sy-subrc = 0.
              i_almacen_montaje = ls_lgort-low.
            ENDIF.
          WHEN 'WERKS'.
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_werks ).

            READ TABLE lr_werks INTO ls_werks INDEX 1.
            IF sy-subrc = 0.
              i_centro_montaje = ls_werks-low.
            ENDIF.
          WHEN 'STOCK_TOTAL'.              " Equivalent to 'StockTotal' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_stock_total ).

            LOOP AT lr_stock_total INTO ls_stock_total.
              ls_ir_stock_total-sign = ls_stock_total-sign.
              ls_ir_stock_total-option = ls_stock_total-option.
              ls_ir_stock_total-low = ls_stock_total-low.
              ls_ir_stock_total-high = ls_stock_total-high.
              APPEND ls_ir_stock_total TO ir_stock_total.
            ENDLOOP.
            CLEAR lr_stock_total.
          WHEN 'STOCK_PEDIDO'.              " Equivalent to 'StockPedido' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_stock_pedido ).

            LOOP AT lr_stock_pedido INTO ls_stock_pedido.
              ls_ir_stock_pedido-sign = ls_stock_pedido-sign.
              ls_ir_stock_pedido-option = ls_stock_pedido-option.
              ls_ir_stock_pedido-low = ls_stock_pedido-low.
              ls_ir_stock_pedido-high = ls_stock_pedido-high.
              APPEND ls_ir_stock_pedido TO ir_stock_pedido.
            ENDLOOP.
            CLEAR lr_stock_pedido.
          WHEN 'STOCK_LIBRE'.              " Equivalent to 'StockLibre' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_stock_libre ).

            LOOP AT lr_stock_libre INTO ls_stock_libre.
              ls_ir_stock_libre-sign = ls_stock_libre-sign.
              ls_ir_stock_libre-option = ls_stock_libre-option.
              ls_ir_stock_libre-low = ls_stock_libre-low.
              ls_ir_stock_libre-high = ls_stock_libre-high.
              APPEND ls_ir_stock_libre TO ir_stock_libre.
            ENDLOOP.
            CLEAR lr_stock_libre.
          WHEN 'STATUS_LOTE'.              " Equivalent to 'StatusLote' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_status_lote ).

            LOOP AT lr_status_lote INTO ls_status_lote.
              ls_ir_status-sign = ls_status_lote-sign.
              ls_ir_status-option = ls_status_lote-option.
              ls_ir_status-low = ls_status_lote-low.
              ls_ir_status-high = ls_status_lote-high.
              APPEND ls_ir_status TO ir_status.
            ENDLOOP.
            CLEAR lr_status_lote.
          WHEN 'MATNR'.              " Equivalent to 'Matnr' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_matnr ).

            LOOP AT lr_matnr INTO ls_matnr.
              ls_ir_matnr-sign = ls_matnr-sign.
              ls_ir_matnr-option = ls_matnr-option.
              ls_ir_matnr-low = ls_matnr-low.
              ls_ir_matnr-high = ls_matnr-high.
              APPEND ls_ir_matnr TO ir_matnr.
            ENDLOOP.
            CLEAR lr_matnr.
          WHEN 'MAKTX'.              " Equivalent to 'Maktx' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_maktx ).

            LOOP AT lr_maktx INTO ls_maktx.
              ls_ir_maktx-sign = ls_maktx-sign.
              ls_ir_maktx-option = ls_maktx-option.
              ls_ir_maktx-low = ls_maktx-low.
              ls_ir_maktx-high = ls_maktx-high.
              APPEND ls_ir_maktx TO ir_maktx.
            ENDLOOP.
            CLEAR lr_maktx.
          WHEN 'CHARG'.              " Equivalent to 'Charg' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_charg ).

            LOOP AT lr_charg INTO ls_charg.
              ls_ir_lote-sign = ls_charg-sign.
              ls_ir_lote-option = ls_charg-option.
              ls_ir_lote-low = ls_charg-low.
              ls_ir_lote-high = ls_charg-high.
              APPEND ls_ir_lote TO ir_lote.
            ENDLOOP.
            CLEAR lr_charg.
          WHEN 'LARGO'.              " Equivalent to 'Largo' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_largo ).

            LOOP AT lr_largo INTO ls_largo.
              ls_ir_largo-sign = ls_largo-sign.
              ls_ir_largo-option = ls_largo-option.
              ls_ir_largo-low = ls_largo-low.
              ls_ir_largo-high = ls_largo-high.
              APPEND ls_ir_largo TO ir_largo.
            ENDLOOP.
            CLEAR lr_largo.
          WHEN 'KUNNR'.              " Equivalent to 'Kunnr' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_kunnr ).

            LOOP AT lr_kunnr INTO ls_kunnr.
              ls_ir_kunnr-sign = ls_kunnr-sign.
              ls_ir_kunnr-option = ls_kunnr-option.
              ls_ir_kunnr-low = ls_kunnr-low.
              ls_ir_kunnr-high = ls_kunnr-high.
              APPEND ls_ir_kunnr TO ir_kunnr.
            ENDLOOP.
            CLEAR lr_kunnr.
          WHEN 'ALTO'.              " Equivalent to 'Alto' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_alto ).

            LOOP AT lr_alto INTO ls_alto.
              ls_ir_alto-sign = ls_alto-sign.
              ls_ir_alto-option = ls_alto-option.
              ls_ir_alto-low = ls_alto-low.
              ls_ir_alto-high = ls_alto-high.
              APPEND ls_ir_alto TO ir_alto.
            ENDLOOP.
            CLEAR lr_alto.
          WHEN 'ANCHO'.              " Equivalent to 'Ancho' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_ancho ).

            LOOP AT lr_ancho INTO ls_ancho.
              ls_ir_ancho-sign = ls_ancho-sign.
              ls_ir_ancho-option = ls_ancho-option.
              ls_ir_ancho-low = ls_ancho-low.
              ls_ir_ancho-high = ls_ancho-high.
              APPEND ls_ir_ancho TO ir_ancho.
            ENDLOOP.
            CLEAR lr_ancho.

          WHEN 'DIMENSIONES'.              " Equivalent to 'Dimensiones' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_dimensiones ).

            LOOP AT lr_dimensiones INTO ls_dimensiones.
              APPEND VALUE #( sign = ls_dimensiones-sign option = ls_dimensiones-option low = ls_dimensiones-low high = ls_dimensiones-high ) TO ir_dimensiones.

            ENDLOOP.
            CLEAR lr_dimensiones.

          WHEN OTHERS.
            " Log message in the application log
*       SARCE INI 3###########################################
            " Log message in the application log
            IF NOT iv_search_string IS INITIAL.
              DATA(vv_jump_search) = 'X'.
              CONTINUE.
            ENDIF.
*      SARCE FIN 3###########################################

            me->/iwbep/if_sb_dpc_comm_services~log_message(
              EXPORTING
                iv_msg_type   = 'E'
                iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
                iv_msg_number = 020
                iv_msg_v1     = ls_filter-property ).
            " Raise Exception
            RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
              EXPORTING
                textid = /iwbep/cx_mgw_tech_exception=>internal_error.
        ENDCASE.

      ENDLOOP.

*      SARCE INI 4###########################################
      IF vv_jump_search = 'X'.
        vv_jump_search = ''.
        CONTINUE.
      ENDIF.
      "MTS: Ajustes
*      SARCE FIN 4###########################################

* Get RFC destination
      lo_dp_facade = /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ).
      lv_destination = /iwbep/cl_sb_gen_dpc_rt_util=>get_rfc_destination( io_dp_facade = lo_dp_facade ).

*-------------------------------------------------------------
*  Call RFC function module
*-------------------------------------------------------------
      lv_rfc_name = 'ZUI5_CM_GET_MATERIALES_DEV'.

      IF lv_destination IS INITIAL OR lv_destination EQ 'NONE'.

        TRY.
            CALL FUNCTION lv_rfc_name
              EXPORTING
                i_almacen_montaje = i_almacen_montaje
                i_centro_montaje  = i_centro_montaje
                ir_stock_total    = ir_stock_total
                ir_stock_pedido   = ir_stock_pedido
                ir_stock_libre    = ir_stock_libre
                ir_status         = ir_status
                ir_matnr          = ir_matnr
                ir_maktx          = ir_maktx
                ir_lote           = ir_lote
                ir_largo          = ir_largo
                ir_kunnr          = ir_kunnr
                ir_alto           = ir_alto
                ir_ancho          = ir_ancho
                ir_medidascaja    = ir_dimensiones
                ir_vbeln = ir_vbeln
              IMPORTING
                o_return          = o_return
                o_data            = o_data
              EXCEPTIONS
                system_failure    = 1000 message lv_exc_msg
                OTHERS            = 1002.

            lv_subrc = sy-subrc.
*in case of co-deployment the exception is raised and needs to be caught
          CATCH cx_root INTO lx_root.
            lv_subrc = 1001.
            lv_exc_msg = lx_root->if_message~get_text( ).
        ENDTRY.

      ELSE.

        CALL FUNCTION lv_rfc_name DESTINATION lv_destination
          EXPORTING
            i_almacen_montaje     = i_almacen_montaje
            i_centro_montaje      = i_centro_montaje
            ir_stock_total        = ir_stock_total
            ir_stock_pedido       = ir_stock_pedido
            ir_stock_libre        = ir_stock_libre
            ir_status             = ir_status
            ir_matnr              = ir_matnr
            ir_maktx              = ir_maktx
            ir_lote               = ir_lote
            ir_largo              = ir_largo
            ir_kunnr              = ir_kunnr
            ir_alto               = ir_alto
            ir_ancho              = ir_ancho
            ir_medidascaja        = ir_dimensiones
            ir_vbeln = ir_vbeln
          IMPORTING
            o_return              = o_return
            o_data                = o_data
          EXCEPTIONS
            system_failure        = 1000 MESSAGE lv_exc_msg
            communication_failure = 1001 MESSAGE lv_exc_msg
            OTHERS                = 1002.

        lv_subrc = sy-subrc.

      ENDIF.
      "MTS: Ajustes
      APPEND LINES OF o_data TO o_data_temp.
*-------------------------------------------------------------
*  Map the RFC response to the caller interface - Only mapped attributes
*-------------------------------------------------------------
*-------------------------------------------------------------
* Error and exception handling
*-------------------------------------------------------------
      IF lv_subrc <> 0.
* Execute the RFC exception handling process
        me->/iwbep/if_sb_dpc_comm_services~rfc_exception_handling(
          EXPORTING
            iv_subrc            = lv_subrc
            iv_exp_message_text = lv_exc_msg ).
      ENDIF.

      IF o_return IS NOT INITIAL.
        me->/iwbep/if_sb_dpc_comm_services~rfc_save_log(
          EXPORTING
            iv_entity_type = iv_entity_name
            it_return      = o_return
            it_key_tab     = it_key_tab ).
      ENDIF.
    ENDDO. "MTS Ajustes
    o_data = o_data_temp.
*-------------------------------------------------------------------------*
*             - Post Backend Call -
*-------------------------------------------------------------------------*
    IF ls_paging-skip IS NOT INITIAL.
*  If the Skip value was requested at runtime
*  the response table will provide backend entries from skip + 1, meaning start from skip +1
*  for example: skip=5 means to start get results from the 6th row
      lv_skip = ls_paging-skip + 1.
    ENDIF.
*  The Top value was requested at runtime but was not handled as part of the function interface
    IF  ls_paging-top <> 0
    AND lv_skip IS NOT INITIAL.
*  if lv_skip > 0 retrieve the entries from lv_skip + Top - 1
*  for example: skip=5 and top=2 means to start get results from the 6th row and end in row number 7
      lv_top = ls_paging-top + lv_skip - 1.
    ELSEIF ls_paging-top <> 0
    AND    lv_skip IS INITIAL.
      lv_top = ls_paging-top.
    ELSE.
      lv_top = lines( o_data ).
    ENDIF.

*  - Map properties from the backend to the Gateway output response table -
    "Ordenamos
    IF it_order IS NOT INITIAL.
      SORT o_data BY zcl_search_dpc=>sort_string( EXPORTING iv_instancia = me  ).
      DELETE ADJACENT DUPLICATES FROM o_data.
    ENDIF.

    LOOP AT o_data INTO ls_o_data
*  Provide the response entries according to the Top and Skip parameters that were provided at runtime
         FROM lv_skip TO lv_top.
*  Only fields that were mapped will be delivered to the response table
      ls_gw_o_data-refdoc = ls_o_data-refdoc.
      ls_gw_o_data-refdocitem = ls_o_data-refdocitem.
      ls_gw_o_data-matnr = ls_o_data-matnr.
      ls_gw_o_data-maktx = ls_o_data-maktx.
      ls_gw_o_data-werks = ls_o_data-werks.
      ls_gw_o_data-lgort = ls_o_data-lgort.
      ls_gw_o_data-largo = ls_o_data-largo.
      ls_gw_o_data-largo_uom = ls_o_data-largo_uom.
      ls_gw_o_data-ancho = ls_o_data-ancho.
      ls_gw_o_data-ancho_uom = ls_o_data-ancho_uom.
      ls_gw_o_data-alto = ls_o_data-alto.
      ls_gw_o_data-alto_uom = ls_o_data-alto_uom.
      ls_gw_o_data-status_lote = ls_o_data-status_lote.
      ls_gw_o_data-status_text = ls_o_data-status_text.
      ls_gw_o_data-kunnr = ls_o_data-kunnr.
      ls_gw_o_data-kunnr_name = ls_o_data-kunnr_name.
      ls_gw_o_data-gualdera = ls_o_data-gualdera.
      ls_gw_o_data-stock_libre = ls_o_data-stock_libre.
      ls_gw_o_data-stock_pedido = ls_o_data-stock_pedido.
      ls_gw_o_data-stock_total = ls_o_data-stock_total.
      ls_gw_o_data-charg = ls_o_data-charg.
      ls_gw_o_data-meins = ls_o_data-meins.
      ls_gw_o_data-estado = ls_o_data-estado.
      ls_gw_o_data-tipo_pallet = ls_o_data-tipo_pallet.
      ls_gw_o_data-num_pallets = ls_o_data-num_pallets.
      ls_gw_o_data-cajas_pallets = ls_o_data-cajas_pallets.
      ls_gw_o_data-dimensiones = ls_o_data-dimensiones.
      ls_gw_o_data-txt_tipo_pallet = ls_o_data-txt_tipo_pallet.
      APPEND ls_gw_o_data TO et_entityset.
      CLEAR ls_gw_o_data.
    ENDLOOP.
  ENDMETHOD.
  METHOD materialesset_get_entityset.
*-------------------------------------------------------------
*  Data declaration
*-------------------------------------------------------------
    DATA i_almacen_montaje TYPE zif_zui5_cm_get_materiales=>lgort_d.
    DATA i_centro_montaje TYPE zif_zui5_cm_get_materiales=>werks_d.
    DATA i_tknum TYPE zif_zui5_cm_get_materiales=>tknum.
    DATA ir_alto  TYPE zif_zui5_cm_get_materiales=>zsuitt_cm_dimensiones_range.
    DATA ir_ancho  TYPE zif_zui5_cm_get_materiales=>zsuitt_cm_dimensiones_range.
    DATA ir_kunnr  TYPE zif_zui5_cm_get_materiales=>zsui_cm_kunnr_range_t.
    DATA ir_largo  TYPE zif_zui5_cm_get_materiales=>zsuitt_cm_dimensiones_range.
    DATA ir_lote  TYPE zif_zui5_cm_get_materiales=>ranges_charg_tt.
    DATA ir_maktx  TYPE zif_zui5_cm_get_materiales=>fip_t_maktx_range.
    DATA ir_matnr  TYPE zif_zui5_cm_get_materiales=>ranges_matnr_tt.
    DATA ir_medidacaja  TYPE zif_zui5_cm_get_materiales1=>rseloption.
    DATA ir_status  TYPE zif_zui5_cm_get_materiales=>zui5r_cm_status.
    DATA ir_stock_libre  TYPE zif_zui5_cm_get_materiales=>zsuitt_cm_cantidad_range.
    DATA ir_stock_pedido  TYPE zif_zui5_cm_get_materiales=>zsuitt_cm_cantidad_range.
    DATA ir_stock_total  TYPE zif_zui5_cm_get_materiales=>zsuitt_cm_cantidad_range.
    DATA o_data  TYPE zif_zui5_cm_get_materiales=>zsuitt_cm_materiales.
    DATA o_return  TYPE zif_zui5_cm_get_materiales=>bapiret2_t.
    DATA ls_ir_alto  TYPE LINE OF zif_zui5_cm_get_materiales=>zsuitt_cm_dimensiones_range.
    DATA ls_ir_ancho  TYPE LINE OF zif_zui5_cm_get_materiales=>zsuitt_cm_dimensiones_range.
    DATA ls_ir_kunnr  TYPE LINE OF zif_zui5_cm_get_materiales=>zsui_cm_kunnr_range_t.
    DATA ls_ir_largo  TYPE LINE OF zif_zui5_cm_get_materiales=>zsuitt_cm_dimensiones_range.
    DATA ls_ir_lote  TYPE LINE OF zif_zui5_cm_get_materiales=>ranges_charg_tt.
    DATA ls_ir_maktx  TYPE LINE OF zif_zui5_cm_get_materiales=>fip_t_maktx_range.
    DATA ls_ir_matnr  TYPE LINE OF zif_zui5_cm_get_materiales=>ranges_matnr_tt.
    DATA ls_ir_medidacaja  TYPE LINE OF zif_zui5_cm_get_materiales1=>rseloption.
    DATA ls_ir_status  TYPE LINE OF zif_zui5_cm_get_materiales=>zui5r_cm_status.
    DATA ls_ir_stock_libre  TYPE LINE OF zif_zui5_cm_get_materiales=>zsuitt_cm_cantidad_range.
    DATA ls_ir_stock_pedido  TYPE LINE OF zif_zui5_cm_get_materiales=>zsuitt_cm_cantidad_range.
    DATA ls_ir_stock_total  TYPE LINE OF zif_zui5_cm_get_materiales=>zsuitt_cm_cantidad_range.
    DATA ls_o_data  TYPE LINE OF zif_zui5_cm_get_materiales=>zsuitt_cm_materiales.
    DATA ls_o_return  TYPE LINE OF zif_zui5_cm_get_materiales=>bapiret2_t.
    DATA lv_rfc_name TYPE tfdir-funcname.
    DATA lv_destination TYPE rfcdest.
    DATA lv_subrc TYPE syst-subrc.
    DATA lv_exc_msg TYPE /iwbep/mgw_bop_rfc_excep_text.
    DATA lx_root TYPE REF TO cx_root.
    DATA lo_filter TYPE  REF TO /iwbep/if_mgw_req_filter.
    DATA lt_filter_select_options TYPE /iwbep/t_mgw_select_option.
    DATA lv_filter_str TYPE string.
    DATA ls_paging TYPE /iwbep/s_mgw_paging.
    DATA ls_converted_keys LIKE LINE OF et_entityset.
    DATA ls_filter TYPE /iwbep/s_mgw_select_option.
    DATA ls_filter_range TYPE /iwbep/s_cod_select_option.
    DATA lr_tknum LIKE RANGE OF ls_converted_keys-tknum.
    DATA ls_tknum LIKE LINE OF lr_tknum.
    DATA lr_werks LIKE RANGE OF ls_converted_keys-werks.
    DATA ls_werks LIKE LINE OF lr_werks.
    DATA lr_lgort LIKE RANGE OF ls_converted_keys-lgort.
    DATA ls_lgort LIKE LINE OF lr_lgort.
    DATA lr_matnr LIKE RANGE OF ls_converted_keys-matnr.
    DATA ls_matnr LIKE LINE OF lr_matnr.
    DATA lr_maktx LIKE RANGE OF ls_converted_keys-maktx.
    DATA ls_maktx LIKE LINE OF lr_maktx.
    DATA lr_largo LIKE RANGE OF ls_converted_keys-largo.
    DATA ls_largo LIKE LINE OF lr_largo.
    DATA lr_ancho LIKE RANGE OF ls_converted_keys-ancho.
    DATA ls_ancho LIKE LINE OF lr_ancho.
    DATA lr_alto LIKE RANGE OF ls_converted_keys-alto.
    DATA ls_alto LIKE LINE OF lr_alto.
    DATA lr_status_lote LIKE RANGE OF ls_converted_keys-status_lote.
    DATA ls_status_lote LIKE LINE OF lr_status_lote.
    DATA lr_kunnr LIKE RANGE OF ls_converted_keys-kunnr.
    DATA ls_kunnr LIKE LINE OF lr_kunnr.
    DATA lr_stock_libre LIKE RANGE OF ls_converted_keys-stock_libre.
    DATA ls_stock_libre LIKE LINE OF lr_stock_libre.
    DATA lr_stock_pedido LIKE RANGE OF ls_converted_keys-stock_pedido.
    DATA ls_stock_pedido LIKE LINE OF lr_stock_pedido.
    DATA lr_stock_total LIKE RANGE OF ls_converted_keys-stock_total.
    DATA ls_stock_total LIKE LINE OF lr_stock_total.
    DATA lr_charg LIKE RANGE OF ls_converted_keys-charg.
    DATA ls_charg LIKE LINE OF lr_charg.
    DATA lr_dimensiones LIKE RANGE OF ls_converted_keys-dimensiones.
    DATA ls_dimensiones LIKE LINE OF lr_dimensiones.
    DATA lo_dp_facade TYPE REF TO /iwbep/if_mgw_dp_facade.
    DATA ls_gw_o_data LIKE LINE OF et_entityset.
    DATA lv_skip     TYPE int4.
    DATA lv_top      TYPE int4.

    "MTS: Ajustes filtro OR
    DATA lt_filter_select_options_and TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_temp TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_or TYPE /iwbep/t_mgw_select_option.
    DATA lv_veces TYPE i.
    DATA posicion TYPE i.
    DATA o_data_temp  TYPE zif_zui5_cm_get_materiales=>zsuitt_cm_materiales.
    "MTS: Ajustes filtro OR

*-------------------------------------------------------------
*  Map the runtime request to the RFC - Only mapped attributes
*-------------------------------------------------------------
* Get all input information from the technical request context object
* Since DPC works with internal property names and runtime API interface holds external property names
* the process needs to get the all needed input information from the technical request context object
* Get filter or select option information
    lo_filter = io_tech_request_context->get_filter( ).
    lt_filter_select_options = lo_filter->get_filter_select_options( ).
    lv_filter_str = lo_filter->get_filter_string( ).

* Check if the supplied filter is supported by standard gateway runtime process
    IF  lv_filter_str            IS NOT INITIAL
    AND lt_filter_select_options IS INITIAL.
      " If the string of the Filter System Query Option is not automatically converted into
      " filter option table (lt_filter_select_options), then the filtering combination is not supported
      " Log message in the application log
*      me->/iwbep/if_sb_dpc_comm_services~log_message(
*        EXPORTING
*          iv_msg_type   = 'E'
*          iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
*          iv_msg_number = 025 ).
*      " Raise Exception
*      RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
*        EXPORTING
*          textid = /iwbep/cx_mgw_tech_exception=>internal_error.
      "MTS: Ajustes filtro OR
      zcl_search_dpc=>filtros_or( EXPORTING iv_instancia = me iv_data = ls_gw_o_data IMPORTING et_filter_select_options_and = lt_filter_select_options_and et_filter_select_options_or = lt_filter_select_options_or ).
      "MTS: Ajustes filtro OR
    ENDIF.
    IF iv_search_string IS NOT INITIAL.
      zcl_search_dpc=>search_or( EXPORTING iv_instancia = me iv_search = iv_search_string iv_data = ls_gw_o_data it_filter_select_options = lt_filter_select_options
                 IMPORTING et_filter_select_options_or = lt_filter_select_options_or ).
    ENDIF.

* Get key table information
    io_tech_request_context->get_converted_source_keys(
      IMPORTING
        es_key_values  = ls_converted_keys ).

    ls_paging-top = io_tech_request_context->get_top( ).
    ls_paging-skip = io_tech_request_context->get_skip( ).

    "MTS: Ajustes filtro OR
    IF lt_filter_select_options_or IS NOT INITIAL OR lt_filter_select_options_and IS NOT INITIAL.
      DESCRIBE TABLE lt_filter_select_options_or LINES lv_veces.
      IF lv_veces IS INITIAL.
        lv_veces = 1.
      ENDIF.
    ELSE.
      lv_veces = 1.
    ENDIF.

    CLEAR posicion.

    IF lt_filter_select_options IS NOT INITIAL.
      zcl_search_dpc=>filtro_mayusculas(
     EXPORTING
       iv_data = ls_gw_o_data
       CHANGING
       ct_filter_select_options = lt_filter_select_options ).

      APPEND LINES OF lt_filter_select_options TO lt_filter_select_options_and.
    ENDIF.



    DO lv_veces TIMES.
      CLEAR: o_data, ir_alto, ir_ancho, ir_kunnr, ir_largo, ir_lote, ir_maktx, ir_matnr, ir_status, ir_stock_libre, ir_stock_pedido, ir_stock_total.

      ADD 1 TO posicion.
      READ TABLE lt_filter_select_options_or INTO DATA(ls_option_or) INDEX posicion.
      IF sy-subrc = 0.
        lt_filter_select_options = lt_filter_select_options_and.

        APPEND ls_option_or TO lt_filter_select_options.
      ELSE.
        lt_filter_select_options = lt_filter_select_options_and.
      ENDIF.
      "MTS: Ajustes filtro OR

* Maps filter table lines to function module parameters
      LOOP AT lt_filter_select_options INTO ls_filter.

        CASE ls_filter-property.
          WHEN 'TKNUM'.
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_tknum ).

            READ TABLE lr_tknum INTO ls_tknum INDEX 1.
            IF sy-subrc = 0.
              i_tknum = ls_tknum-low.
            ENDIF.

          WHEN 'WERKS'.
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_werks ).

            READ TABLE lr_werks INTO ls_werks INDEX 1.
            IF sy-subrc = 0.
              i_centro_montaje = ls_werks-low.
            ENDIF.
          WHEN 'LGORT'.
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_lgort ).

            READ TABLE lr_lgort INTO ls_lgort INDEX 1.
            IF sy-subrc = 0.
              i_almacen_montaje = ls_lgort-low.
            ENDIF.
          WHEN 'MATNR'.              " Equivalent to 'Matnr' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_matnr ).

            LOOP AT lr_matnr INTO ls_matnr.
              ls_ir_matnr-high = ls_matnr-high.
              ls_ir_matnr-low = ls_matnr-low.
              ls_ir_matnr-option = ls_matnr-option.
              ls_ir_matnr-sign = ls_matnr-sign.
              APPEND ls_ir_matnr TO ir_matnr.
            ENDLOOP.
            CLEAR lr_matnr.
          WHEN 'MAKTX'.              " Equivalent to 'Maktx' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_maktx ).

            LOOP AT lr_maktx INTO ls_maktx.
              ls_ir_maktx-high = ls_maktx-high.
              ls_ir_maktx-low = ls_maktx-low.
              ls_ir_maktx-option = ls_maktx-option.
              ls_ir_maktx-sign = ls_maktx-sign.
              APPEND ls_ir_maktx TO ir_maktx.
            ENDLOOP.
            CLEAR lr_maktx.
          WHEN 'LARGO'.              " Equivalent to 'Largo' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_largo ).

            LOOP AT lr_largo INTO ls_largo.
              ls_ir_largo-high = ls_largo-high.
              ls_ir_largo-low = ls_largo-low.
              ls_ir_largo-option = ls_largo-option.
              ls_ir_largo-sign = ls_largo-sign.
              APPEND ls_ir_largo TO ir_largo.
            ENDLOOP.
            CLEAR lr_largo.
          WHEN 'ANCHO'.              " Equivalent to 'Ancho' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_ancho ).

            LOOP AT lr_ancho INTO ls_ancho.
              ls_ir_ancho-high = ls_ancho-high.
              ls_ir_ancho-low = ls_ancho-low.
              ls_ir_ancho-option = ls_ancho-option.
              ls_ir_ancho-sign = ls_ancho-sign.
              APPEND ls_ir_ancho TO ir_ancho.
            ENDLOOP.
            CLEAR lr_ancho.
          WHEN 'ALTO'.              " Equivalent to 'Alto' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_alto ).

            LOOP AT lr_alto INTO ls_alto.
              ls_ir_alto-high = ls_alto-high.
              ls_ir_alto-low = ls_alto-low.
              ls_ir_alto-option = ls_alto-option.
              ls_ir_alto-sign = ls_alto-sign.
              APPEND ls_ir_alto TO ir_alto.
            ENDLOOP.
            CLEAR lr_alto.
          WHEN 'STATUS_LOTE'.              " Equivalent to 'StatusLote' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_status_lote ).

            LOOP AT lr_status_lote INTO ls_status_lote.
              ls_ir_status-high = ls_status_lote-high.
              ls_ir_status-low = ls_status_lote-low.
              ls_ir_status-option = ls_status_lote-option.
              ls_ir_status-sign = ls_status_lote-sign.
              APPEND ls_ir_status TO ir_status.
            ENDLOOP.
            CLEAR lr_status_lote.
          WHEN 'KUNNR'.              " Equivalent to 'Kunnr' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_kunnr ).

            LOOP AT lr_kunnr INTO ls_kunnr.
              ls_ir_kunnr-high = ls_kunnr-high.
              ls_ir_kunnr-low = ls_kunnr-low.
              ls_ir_kunnr-option = ls_kunnr-option.
              ls_ir_kunnr-sign = ls_kunnr-sign.
              APPEND ls_ir_kunnr TO ir_kunnr.
            ENDLOOP.
            CLEAR lr_kunnr.
          WHEN 'STOCK_LIBRE'.              " Equivalent to 'StockLibre' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_stock_libre ).

            LOOP AT lr_stock_libre INTO ls_stock_libre.
              ls_ir_stock_libre-high = ls_stock_libre-high.
              ls_ir_stock_libre-low = ls_stock_libre-low.
              ls_ir_stock_libre-option = ls_stock_libre-option.
              ls_ir_stock_libre-sign = ls_stock_libre-sign.
              APPEND ls_ir_stock_libre TO ir_stock_libre.
            ENDLOOP.
            CLEAR lr_stock_libre.
          WHEN 'STOCK_PEDIDO'.              " Equivalent to 'StockPedido' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_stock_pedido ).

            LOOP AT lr_stock_pedido INTO ls_stock_pedido.
              ls_ir_stock_pedido-high = ls_stock_pedido-high.
              ls_ir_stock_pedido-low = ls_stock_pedido-low.
              ls_ir_stock_pedido-option = ls_stock_pedido-option.
              ls_ir_stock_pedido-sign = ls_stock_pedido-sign.
              APPEND ls_ir_stock_pedido TO ir_stock_pedido.
            ENDLOOP.
            CLEAR lr_stock_pedido.
          WHEN 'STOCK_TOTAL'.              " Equivalent to 'StockTotal' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_stock_total ).

            LOOP AT lr_stock_total INTO ls_stock_total.
              ls_ir_stock_total-high = ls_stock_total-high.
              ls_ir_stock_total-low = ls_stock_total-low.
              ls_ir_stock_total-option = ls_stock_total-option.
              ls_ir_stock_total-sign = ls_stock_total-sign.
              APPEND ls_ir_stock_total TO ir_stock_total.
            ENDLOOP.
            CLEAR lr_stock_total.
          WHEN 'CHARG'.              " Equivalent to 'Charg' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_charg ).

            LOOP AT lr_charg INTO ls_charg.
              ls_ir_lote-high = ls_charg-high.
              ls_ir_lote-low = ls_charg-low.
              ls_ir_lote-option = ls_charg-option.
              ls_ir_lote-sign = ls_charg-sign.
              APPEND ls_ir_lote TO ir_lote.
            ENDLOOP.
            CLEAR lr_charg.
          WHEN 'DIMENSIONES'.              " Equivalent to 'Dimensiones' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_dimensiones ).

            LOOP AT lr_dimensiones INTO ls_dimensiones.
              ls_ir_medidacaja-sign = ls_dimensiones-sign.
              ls_ir_medidacaja-option = ls_dimensiones-option.
              ls_ir_medidacaja-low = ls_dimensiones-low.
              ls_ir_medidacaja-high = ls_dimensiones-high.
              APPEND ls_ir_medidacaja TO ir_medidacaja.
            ENDLOOP.
            CLEAR lr_dimensiones.
          WHEN OTHERS.
*       SARCE INI 3###########################################
            " Log message in the application log
            IF NOT iv_search_string IS INITIAL.
              DATA(vv_jump_search) = 'X'.
              CONTINUE.
            ENDIF.
*      SARCE FIN 3###########################################
            " Log message in the application log
            me->/iwbep/if_sb_dpc_comm_services~log_message(
              EXPORTING
                iv_msg_type   = 'E'
                iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
                iv_msg_number = 020
                iv_msg_v1     = ls_filter-property ).
            " Raise Exception
            RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
              EXPORTING
                textid = /iwbep/cx_mgw_tech_exception=>internal_error.
        ENDCASE.

      ENDLOOP.

*      SARCE INI 4###########################################
      IF vv_jump_search = 'X'.
        vv_jump_search = ''.
        CONTINUE.
      ENDIF.
      "MTS: Ajustes
*      SARCE FIN 4###########################################

* Get RFC destination
      lo_dp_facade = /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ).
      lv_destination = /iwbep/cl_sb_gen_dpc_rt_util=>get_rfc_destination( io_dp_facade = lo_dp_facade ).

*-------------------------------------------------------------
*  Call RFC function module
*-------------------------------------------------------------
      lv_rfc_name = 'ZUI5_CM_GET_MATERIALES'.

      IF lv_destination IS INITIAL OR lv_destination EQ 'NONE'.

        TRY.
            CALL FUNCTION lv_rfc_name
              EXPORTING
                ir_matnr          = ir_matnr
                ir_maktx          = ir_maktx
                i_centro_montaje  = i_centro_montaje
                i_almacen_montaje = i_almacen_montaje
                ir_largo          = ir_largo
                ir_ancho          = ir_ancho
                ir_alto           = ir_alto
                ir_status         = ir_status
                ir_kunnr          = ir_kunnr
                ir_stock_libre    = ir_stock_libre
                ir_stock_pedido   = ir_stock_pedido
                ir_stock_total    = ir_stock_total
                ir_lote           = ir_lote
                i_tknum           = i_tknum
                ir_medidacaja     = ir_medidacaja
                i_top             = lv_top
                i_skip            = lv_skip
*               it_order          = lt_order
              IMPORTING
                o_return          = o_return
                o_data            = o_data
              EXCEPTIONS
                system_failure    = 1000 message lv_exc_msg
                OTHERS            = 1002.

            lv_subrc = sy-subrc.
*in case of co-deployment the exception is raised and needs to be caught
          CATCH cx_root INTO lx_root.
            lv_subrc = 1001.
            lv_exc_msg = lx_root->if_message~get_text( ).
        ENDTRY.

      ELSE.

        CALL FUNCTION lv_rfc_name DESTINATION lv_destination
          EXPORTING
            ir_matnr              = ir_matnr
            ir_maktx              = ir_maktx
            i_centro_montaje      = i_centro_montaje
            i_almacen_montaje     = i_almacen_montaje
            ir_largo              = ir_largo
            ir_ancho              = ir_ancho
            ir_alto               = ir_alto
            ir_status             = ir_status
            ir_kunnr              = ir_kunnr
            ir_stock_libre        = ir_stock_libre
            ir_stock_pedido       = ir_stock_pedido
            ir_stock_total        = ir_stock_total
            ir_lote               = ir_lote
            i_tknum               = i_tknum
            ir_medidacaja         = ir_medidacaja
            i_top                 = lv_top
            i_skip                = lv_skip
*           it_order              = lt_order
          IMPORTING
            o_return              = o_return
            o_data                = o_data
          EXCEPTIONS
            system_failure        = 1000 MESSAGE lv_exc_msg
            communication_failure = 1001 MESSAGE lv_exc_msg
            OTHERS                = 1002.

        lv_subrc = sy-subrc.

      ENDIF.

      "MTS: Ajustes
      APPEND LINES OF o_data TO o_data_temp.
*-------------------------------------------------------------
*  Map the RFC response to the caller interface - Only mapped attributes
*-------------------------------------------------------------
*-------------------------------------------------------------
* Error and exception handling
*-------------------------------------------------------------
      IF lv_subrc <> 0.
* Execute the RFC exception handling process
        me->/iwbep/if_sb_dpc_comm_services~rfc_exception_handling(
          EXPORTING
            iv_subrc            = lv_subrc
            iv_exp_message_text = lv_exc_msg ).
      ENDIF.

      IF o_return IS NOT INITIAL.
        me->/iwbep/if_sb_dpc_comm_services~rfc_save_log(
          EXPORTING
            iv_entity_type = iv_entity_name
            it_return      = o_return
            it_key_tab     = it_key_tab ).
      ENDIF.

    ENDDO. "MTS Ajustes
    o_data = o_data_temp.
*-------------------------------------------------------------------------*
*             - Post Backend Call -
*-------------------------------------------------------------------------*
    IF ls_paging-skip IS NOT INITIAL.
*  If the Skip value was requested at runtime
*  the response table will provide backend entries from skip + 1, meaning start from skip +1
*  for example: skip=5 means to start get results from the 6th row
      lv_skip = ls_paging-skip + 1.
    ENDIF.
*  The Top value was requested at runtime but was not handled as part of the function interface
    IF  ls_paging-top <> 0
    AND lv_skip IS NOT INITIAL.
*  if lv_skip > 0 retrieve the entries from lv_skip + Top - 1
*  for example: skip=5 and top=2 means to start get results from the 6th row and end in row number 7
      lv_top = ls_paging-top + lv_skip - 1.
    ELSEIF ls_paging-top <> 0
    AND    lv_skip IS INITIAL.
      lv_top = ls_paging-top.
    ELSE.
      lv_top = lines( o_data ).
    ENDIF.
    "Ordenamos
    IF it_order IS NOT INITIAL.
      SORT o_data BY zcl_search_dpc=>sort_string( EXPORTING iv_instancia = me  ).
      DELETE ADJACENT DUPLICATES FROM o_data.
    ENDIF.
*  - Map properties from the backend to the Gateway output response table -

    LOOP AT o_data INTO ls_o_data
*  Provide the response entries according to the Top and Skip parameters that were provided at runtime
         FROM lv_skip TO lv_top. " lo estoy aplicando en el interior del formulario SARCE 02.04.2024 10:45:58
*  Only fields that were mapped will be delivered to the response table
      ls_gw_o_data-largo_uom = ls_o_data-largo_uom.
      ls_gw_o_data-ancho_uom = ls_o_data-ancho_uom.
      ls_gw_o_data-alto_uom = ls_o_data-alto_uom.
      ls_gw_o_data-status_text = ls_o_data-status_text.
      ls_gw_o_data-kunnr_name = ls_o_data-kunnr_name.
      ls_gw_o_data-gualdera = ls_o_data-gualdera.
      ls_gw_o_data-meins = ls_o_data-meins.
      ls_gw_o_data-estado = ls_o_data-estado.
      ls_gw_o_data-matnr = ls_o_data-matnr.
      ls_gw_o_data-maktx = ls_o_data-maktx.
      ls_gw_o_data-werks = ls_o_data-werks.
      ls_gw_o_data-lgort = ls_o_data-lgort.
      ls_gw_o_data-largo = ls_o_data-largo.
      ls_gw_o_data-ancho = ls_o_data-ancho.
      ls_gw_o_data-alto = ls_o_data-alto.
      ls_gw_o_data-status_lote = ls_o_data-status_lote.
      ls_gw_o_data-kunnr = ls_o_data-kunnr.
      ls_gw_o_data-stock_libre = ls_o_data-stock_libre.
      ls_gw_o_data-stock_pedido = ls_o_data-stock_pedido.
      ls_gw_o_data-stock_total = ls_o_data-stock_total.
      ls_gw_o_data-charg = ls_o_data-charg.
      ls_gw_o_data-dimensiones = ls_o_data-dimensiones.
      ls_gw_o_data-tipo_pallet = ls_o_data-tipo_pallet.
      ls_gw_o_data-num_pallets = ls_o_data-num_pallets.
      ls_gw_o_data-cajas_pallets = ls_o_data-cajas_pallets.
      ls_gw_o_data-txt_tipo_pallet = ls_o_data-txt_tipo_pallet.
      APPEND ls_gw_o_data TO et_entityset.
      CLEAR ls_gw_o_data.
    ENDLOOP.

  ENDMETHOD.
  METHOD posicionesentreg_get_entityset.
*-------------------------------------------------------------
*  Data declaration
*-------------------------------------------------------------
    DATA ir_alto  TYPE zif_zui5_cm_get_pos_entregas=>zsuitt_cm_dimensiones_range.
    DATA ir_ancho  TYPE zif_zui5_cm_get_pos_entregas=>zsuitt_cm_dimensiones_range.
    DATA ir_kunnr  TYPE zif_zui5_cm_get_pos_entregas=>zsui_cm_kunnr_range_t.
    DATA ir_largo  TYPE zif_zui5_cm_get_pos_entregas=>zsuitt_cm_dimensiones_range.
    DATA ir_lote  TYPE zif_zui5_cm_get_pos_entregas=>ranges_charg_tt.
    DATA ir_maktx  TYPE zif_zui5_cm_get_pos_entregas=>fip_t_maktx_range.
    DATA ir_matnr  TYPE zif_zui5_cm_get_pos_entregas=>ranges_matnr_tt.
    DATA ir_status  TYPE zif_zui5_cm_get_pos_entregas=>zui5r_cm_status.
    DATA ir_tknum  TYPE zif_zui5_cm_get_pos_entregas=>shp_tknum_range_t.
    DATA ir_tplst  TYPE zif_zui5_cm_get_pos_entregas=>zsuitt_cm_tplst_range.
    DATA ir_vbeln  TYPE zif_zui5_cm_get_pos_entregas=>/eby/_lbapidlv_range_vbeln.
    DATA o_data  TYPE zif_zui5_cm_get_pos_entregas=>zsuitt_cm_posiciones_entrega.
    DATA o_return  TYPE zif_zui5_cm_get_pos_entregas=>bapiret2_t.
    DATA ls_ir_alto  TYPE LINE OF zif_zui5_cm_get_pos_entregas=>zsuitt_cm_dimensiones_range.
    DATA ls_ir_ancho  TYPE LINE OF zif_zui5_cm_get_pos_entregas=>zsuitt_cm_dimensiones_range.
    DATA ls_ir_kunnr  TYPE LINE OF zif_zui5_cm_get_pos_entregas=>zsui_cm_kunnr_range_t.
    DATA ls_ir_largo  TYPE LINE OF zif_zui5_cm_get_pos_entregas=>zsuitt_cm_dimensiones_range.
    DATA ls_ir_lote  TYPE LINE OF zif_zui5_cm_get_pos_entregas=>ranges_charg_tt.
    DATA ls_ir_maktx  TYPE LINE OF zif_zui5_cm_get_pos_entregas=>fip_t_maktx_range.
    DATA ls_ir_matnr  TYPE LINE OF zif_zui5_cm_get_pos_entregas=>ranges_matnr_tt.
    DATA ls_ir_status  TYPE LINE OF zif_zui5_cm_get_pos_entregas=>zui5r_cm_status.
    DATA ls_ir_tknum  TYPE LINE OF zif_zui5_cm_get_pos_entregas=>shp_tknum_range_t.
    DATA ls_ir_tplst  TYPE LINE OF zif_zui5_cm_get_pos_entregas=>zsuitt_cm_tplst_range.
    DATA ls_ir_vbeln  TYPE LINE OF zif_zui5_cm_get_pos_entregas=>/eby/_lbapidlv_range_vbeln.
    DATA ls_o_data  TYPE LINE OF zif_zui5_cm_get_pos_entregas=>zsuitt_cm_posiciones_entrega.
    DATA ls_o_return  TYPE LINE OF zif_zui5_cm_get_pos_entregas=>bapiret2_t.
    DATA lv_rfc_name TYPE tfdir-funcname.
    DATA lv_destination TYPE rfcdest.
    DATA lv_subrc TYPE syst-subrc.
    DATA lv_exc_msg TYPE /iwbep/mgw_bop_rfc_excep_text.
    DATA lx_root TYPE REF TO cx_root.
    DATA lo_filter TYPE  REF TO /iwbep/if_mgw_req_filter.
    DATA lt_filter_select_options TYPE /iwbep/t_mgw_select_option.
    DATA lv_filter_str TYPE string.
    DATA ls_paging TYPE /iwbep/s_mgw_paging.
    DATA ls_converted_keys LIKE LINE OF et_entityset.
    DATA lv_source_entity_set_name TYPE string.
    DATA entregastranspor_get_entityset TYPE LINE OF zcl_zsui5_cm_gestion_t_mpc=>tt_entregastransporte.
    DATA transportesset_get_entityset TYPE LINE OF zcl_zsui5_cm_gestion_t_mpc=>tt_transportes.
    DATA ls_filter TYPE /iwbep/s_mgw_select_option.
    DATA ls_filter_range TYPE /iwbep/s_cod_select_option.
    DATA lr_vbeln LIKE RANGE OF ls_converted_keys-vbeln.
    DATA ls_vbeln LIKE LINE OF lr_vbeln.
    DATA lr_matnr LIKE RANGE OF ls_converted_keys-matnr.
    DATA ls_matnr LIKE LINE OF lr_matnr.
    DATA lr_maktx LIKE RANGE OF ls_converted_keys-maktx.
    DATA ls_maktx LIKE LINE OF lr_maktx.
    DATA lr_werks LIKE RANGE OF ls_converted_keys-werks.
    DATA ls_werks LIKE LINE OF lr_werks.
    DATA lr_lgort LIKE RANGE OF ls_converted_keys-lgort.
    DATA ls_lgort LIKE LINE OF lr_lgort.
    DATA lr_largo LIKE RANGE OF ls_converted_keys-largo.
    DATA ls_largo LIKE LINE OF lr_largo.
    DATA lr_ancho LIKE RANGE OF ls_converted_keys-ancho.
    DATA ls_ancho LIKE LINE OF lr_ancho.
    DATA lr_alto LIKE RANGE OF ls_converted_keys-alto.
    DATA ls_alto LIKE LINE OF lr_alto.
    DATA lr_status_lote LIKE RANGE OF ls_converted_keys-status_lote.
    DATA ls_status_lote LIKE LINE OF lr_status_lote.
    DATA lr_charg LIKE RANGE OF ls_converted_keys-charg.
    DATA ls_charg LIKE LINE OF lr_charg.
    DATA lr_kunnr LIKE RANGE OF ls_converted_keys-kunnr.
    DATA ls_kunnr LIKE LINE OF lr_kunnr.
    DATA lr_tknum LIKE RANGE OF ls_converted_keys-tknum.
    DATA ls_tknum LIKE LINE OF lr_tknum.
    DATA lo_dp_facade TYPE REF TO /iwbep/if_mgw_dp_facade.
    DATA ls_gw_o_data LIKE LINE OF et_entityset.
    DATA lv_skip     TYPE int4.
    DATA lv_top      TYPE int4.
    DATA: i_tknum TYPE tknum,
          i_vbeln TYPE vbeln_vl.



    "MTS: Ajustes filtro OR
    DATA o_data_temp  TYPE zif_zui5_cm_get_pos_entregas=>zsuitt_cm_posiciones_entrega.
    DATA lt_filter_select_options_and TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_temp TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_or TYPE /iwbep/t_mgw_select_option.
    DATA lv_veces TYPE i.
    DATA posicion TYPE i.
    "MTS: Ajustes filtro OR
*-------------------------------------------------------------
*  Map the runtime request to the RFC - Only mapped attributes
*-------------------------------------------------------------
* Get all input information from the technical request context object
* Since DPC works with internal property names and runtime API interface holds external property names
* the process needs to get the all needed input information from the technical request context object
* Get filter or select option information
    lo_filter = io_tech_request_context->get_filter( ).
    lt_filter_select_options = lo_filter->get_filter_select_options( ).
    lv_filter_str = lo_filter->get_filter_string( ).

* Check if the supplied filter is supported by standard gateway runtime process
    IF  lv_filter_str            IS NOT INITIAL
    AND lt_filter_select_options IS INITIAL.
      " If the string of the Filter System Query Option is not automatically converted into
      " filter option table (lt_filter_select_options), then the filtering combination is not supported
      " Log message in the application log
*      me->/iwbep/if_sb_dpc_comm_services~log_message(
*        EXPORTING
*          iv_msg_type   = 'E'
*          iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
*          iv_msg_number = 025 ).
*      " Raise Exception
*      RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
*        EXPORTING
*          textid = /iwbep/cx_mgw_tech_exception=>internal_error.
      "MTS: Ajustes filtro OR
      zcl_search_dpc=>filtros_or( EXPORTING iv_instancia = me iv_data = ls_gw_o_data IMPORTING et_filter_select_options_and = lt_filter_select_options_and et_filter_select_options_or = lt_filter_select_options_or ).
      "MTS: Ajustes filtro OR
    ENDIF.
    IF iv_search_string IS NOT INITIAL.
      zcl_search_dpc=>search_or( EXPORTING iv_instancia = me iv_search = iv_search_string iv_data = ls_gw_o_data it_filter_select_options = lt_filter_select_options
                 IMPORTING et_filter_select_options_or = lt_filter_select_options_or ).
    ENDIF.

* Get key table information
    io_tech_request_context->get_converted_source_keys(
      IMPORTING
        es_key_values  = ls_converted_keys ).

    ls_paging-top = io_tech_request_context->get_top( ).
    ls_paging-skip = io_tech_request_context->get_skip( ).

* Maps key fields to function module parameters
    IF it_key_tab IS NOT INITIAL.

      lv_source_entity_set_name = io_tech_request_context->get_source_entity_set_name( ).

      IF  lv_source_entity_set_name = 'EntregasTransporteSet'.
        " Convert keys to appropriate entity set structure
        io_tech_request_context->get_converted_source_keys(
          IMPORTING
            es_key_values  = entregastranspor_get_entityset ).
        ls_ir_vbeln-deliv_numb_low = entregastranspor_get_entityset-tknum. " Equivalent to 'Vbeln' property in the service
        ls_ir_vbeln-option = 'EQ'.
        ls_ir_vbeln-sign = 'I'.
        APPEND ls_ir_vbeln TO ir_vbeln.

        ls_ir_vbeln-deliv_numb_low = entregastranspor_get_entityset-vbeln. " Equivalent to 'Vbeln' property in the service
        ls_ir_vbeln-option = 'EQ'.
        ls_ir_vbeln-sign = 'I'.
        APPEND ls_ir_vbeln TO ir_vbeln.

      ENDIF.

      IF  lv_source_entity_set_name = 'TransportesSet'.
        " Convert keys to appropriate entity set structure
        io_tech_request_context->get_converted_source_keys(
          IMPORTING
            es_key_values  = transportesset_get_entityset ).
        ls_ir_tknum-low = transportesset_get_entityset-tknum. " Equivalent to 'Tknum' property in the service
        ls_ir_tknum-option = 'EQ'.
        ls_ir_tknum-sign = 'I'.
        APPEND ls_ir_tknum TO ir_tknum.

      ENDIF.

    ENDIF.


    "Aadimos la tabla de navegacin
    IF it_navigation_path IS NOT INITIAL.
      LOOP AT it_navigation_path INTO DATA(ls_nav_path) WHERE nav_prop = 'TransporteEntregas'.
        LOOP AT ls_nav_path-key_tab INTO DATA(ls_key_tab).
          CASE ls_key_tab-name.
            WHEN 'Tknum'.
              i_tknum = ls_key_tab-value.
            WHEN 'Vbeln'.
              i_vbeln = ls_key_tab-value.
          ENDCASE.
        ENDLOOP.
      ENDLOOP.
    ENDIF.

    "MTS: Ajustes filtro OR
    IF lt_filter_select_options_or IS NOT INITIAL OR lt_filter_select_options_and IS NOT INITIAL.
      DESCRIBE TABLE lt_filter_select_options_or LINES lv_veces.
      IF lv_veces IS INITIAL.
        lv_veces = 1.
      ENDIF.
    ELSE.
      lv_veces = 1.
    ENDIF.

    CLEAR posicion.

    IF lt_filter_select_options IS NOT INITIAL.
      zcl_search_dpc=>filtro_mayusculas(
     EXPORTING
       iv_data = ls_gw_o_data
       CHANGING
       ct_filter_select_options = lt_filter_select_options ).

      APPEND LINES OF lt_filter_select_options TO lt_filter_select_options_and.
    ENDIF.

    DO lv_veces TIMES.
      CLEAR: o_data, ir_alto, ir_ancho, ir_kunnr, ir_largo, ir_lote, ir_maktx, ir_matnr, ir_status, ir_tknum, ir_tplst, ir_vbeln.

      ADD 1 TO posicion.
      READ TABLE lt_filter_select_options_or INTO DATA(ls_option_or) INDEX posicion.
      IF sy-subrc = 0.
        lt_filter_select_options = lt_filter_select_options_and.

        APPEND ls_option_or TO lt_filter_select_options.
      ENDIF.
      "MTS: Ajustes filtro OR
      IF it_filter_select_options IS NOT INITIAL.


* Maps filter table lines to function module parameters
        LOOP AT lt_filter_select_options INTO ls_filter.


          CASE ls_filter-property.
            WHEN 'VBELN'.              " Equivalent to 'Vbeln' property in the service
              lo_filter->convert_select_option(
                EXPORTING
                  is_select_option = ls_filter
                IMPORTING
                  et_select_option = lr_vbeln ).

              LOOP AT lr_vbeln INTO ls_vbeln.
                ls_ir_vbeln-deliv_numb_high = ls_vbeln-high.
                ls_ir_vbeln-deliv_numb_low = ls_vbeln-low.
                ls_ir_vbeln-option = ls_vbeln-option.
                ls_ir_vbeln-sign = ls_vbeln-sign.
                APPEND ls_ir_vbeln TO ir_vbeln.
              ENDLOOP.
              CLEAR lr_vbeln.
            WHEN 'MATNR'.              " Equivalent to 'Matnr' property in the service
              lo_filter->convert_select_option(
                EXPORTING
                  is_select_option = ls_filter
                IMPORTING
                  et_select_option = lr_matnr ).

              LOOP AT lr_matnr INTO ls_matnr.
                ls_ir_matnr-high = ls_matnr-high.
                ls_ir_matnr-low = ls_matnr-low.
                ls_ir_matnr-option = ls_matnr-option.
                ls_ir_matnr-sign = ls_matnr-sign.
                APPEND ls_ir_matnr TO ir_matnr.
              ENDLOOP.
              CLEAR lr_matnr.
            WHEN 'MAKTX'.              " Equivalent to 'Maktx' property in the service
              lo_filter->convert_select_option(
                EXPORTING
                  is_select_option = ls_filter
                IMPORTING
                  et_select_option = lr_maktx ).

              LOOP AT lr_maktx INTO ls_maktx.
                ls_ir_maktx-high = ls_maktx-high.
                ls_ir_maktx-low = ls_maktx-low.
                ls_ir_maktx-option = ls_maktx-option.
                ls_ir_maktx-sign = ls_maktx-sign.
                APPEND ls_ir_maktx TO ir_maktx.
              ENDLOOP.
              CLEAR lr_maktx.
            WHEN 'WERKS'.              " Equivalent to 'Werks' property in the service
              lo_filter->convert_select_option(
                EXPORTING
                  is_select_option = ls_filter
                IMPORTING
                  et_select_option = lr_werks ).

              LOOP AT lr_werks INTO ls_werks.
                ls_ir_tplst-tplst_high = ls_werks-high.
                ls_ir_tplst-tplst_low = ls_werks-low.
                ls_ir_tplst-tplst_option = ls_werks-option.
                ls_ir_tplst-tplst_sign = ls_werks-sign.
                APPEND ls_ir_tplst TO ir_tplst.
              ENDLOOP.
              CLEAR lr_werks.
            WHEN 'LGORT'.              " Equivalent to 'Lgort' property in the service
              lo_filter->convert_select_option(
                EXPORTING
                  is_select_option = ls_filter
                IMPORTING
                  et_select_option = lr_lgort ).

              LOOP AT lr_lgort INTO ls_lgort.
                ls_ir_tplst-tplst_high = ls_lgort-high.
                ls_ir_tplst-tplst_low = ls_lgort-low.
                ls_ir_tplst-tplst_option = ls_lgort-option.
                ls_ir_tplst-tplst_sign = ls_lgort-sign.
                APPEND ls_ir_tplst TO ir_tplst.
              ENDLOOP.
              CLEAR lr_lgort.
            WHEN 'LARGO'.              " Equivalent to 'Largo' property in the service
              lo_filter->convert_select_option(
                EXPORTING
                  is_select_option = ls_filter
                IMPORTING
                  et_select_option = lr_largo ).

              LOOP AT lr_largo INTO ls_largo.
                ls_ir_largo-high = ls_largo-high.
                ls_ir_largo-low = ls_largo-low.
                ls_ir_largo-option = ls_largo-option.
                ls_ir_largo-sign = ls_largo-sign.
                APPEND ls_ir_largo TO ir_largo.
              ENDLOOP.
              CLEAR lr_largo.
            WHEN 'ANCHO'.              " Equivalent to 'Ancho' property in the service
              lo_filter->convert_select_option(
                EXPORTING
                  is_select_option = ls_filter
                IMPORTING
                  et_select_option = lr_ancho ).

              LOOP AT lr_ancho INTO ls_ancho.
                ls_ir_ancho-high = ls_ancho-high.
                ls_ir_ancho-low = ls_ancho-low.
                ls_ir_ancho-option = ls_ancho-option.
                ls_ir_ancho-sign = ls_ancho-sign.
                APPEND ls_ir_ancho TO ir_ancho.
              ENDLOOP.
              CLEAR lr_ancho.
            WHEN 'ALTO'.              " Equivalent to 'Alto' property in the service
              lo_filter->convert_select_option(
                EXPORTING
                  is_select_option = ls_filter
                IMPORTING
                  et_select_option = lr_alto ).

              LOOP AT lr_alto INTO ls_alto.
                ls_ir_alto-high = ls_alto-high.
                ls_ir_alto-low = ls_alto-low.
                ls_ir_alto-option = ls_alto-option.
                ls_ir_alto-sign = ls_alto-sign.
                APPEND ls_ir_alto TO ir_alto.
              ENDLOOP.
              CLEAR lr_alto.
            WHEN 'STATUS_LOTE'.              " Equivalent to 'StatusLote' property in the service
              lo_filter->convert_select_option(
                EXPORTING
                  is_select_option = ls_filter
                IMPORTING
                  et_select_option = lr_status_lote ).

              LOOP AT lr_status_lote INTO ls_status_lote.
                ls_ir_status-high = ls_status_lote-high.
                ls_ir_status-low = ls_status_lote-low.
                ls_ir_status-option = ls_status_lote-option.
                ls_ir_status-sign = ls_status_lote-sign.
                APPEND ls_ir_status TO ir_status.
              ENDLOOP.
              CLEAR lr_status_lote.
            WHEN 'CHARG'.              " Equivalent to 'Charg' property in the service
              lo_filter->convert_select_option(
                EXPORTING
                  is_select_option = ls_filter
                IMPORTING
                  et_select_option = lr_charg ).

              LOOP AT lr_charg INTO ls_charg.
                ls_ir_lote-high = ls_charg-high.
                ls_ir_lote-low = ls_charg-low.
                ls_ir_lote-option = ls_charg-option.
                ls_ir_lote-sign = ls_charg-sign.
                APPEND ls_ir_lote TO ir_lote.
              ENDLOOP.
              CLEAR lr_charg.
            WHEN 'KUNNR'.              " Equivalent to 'Kunnr' property in the service
              lo_filter->convert_select_option(
                EXPORTING
                  is_select_option = ls_filter
                IMPORTING
                  et_select_option = lr_kunnr ).

              LOOP AT lr_kunnr INTO ls_kunnr.
                ls_ir_kunnr-high = ls_kunnr-high.
                ls_ir_kunnr-low = ls_kunnr-low.
                ls_ir_kunnr-option = ls_kunnr-option.
                ls_ir_kunnr-sign = ls_kunnr-sign.
                APPEND ls_ir_kunnr TO ir_kunnr.
              ENDLOOP.
              CLEAR lr_kunnr.
            WHEN 'TKNUM'.              " Equivalent to 'Tknum' property in the service
              lo_filter->convert_select_option(
                EXPORTING
                  is_select_option = ls_filter
                IMPORTING
                  et_select_option = lr_tknum ).

              LOOP AT lr_tknum INTO ls_tknum.
                ls_ir_tknum-high = ls_tknum-high.
                ls_ir_tknum-low = ls_tknum-low.
                ls_ir_tknum-option = ls_tknum-option.
                ls_ir_tknum-sign = ls_tknum-sign.
                APPEND ls_ir_tknum TO ir_tknum.
              ENDLOOP.
              CLEAR lr_tknum.

            WHEN OTHERS.
*       SARCE INI 3###########################################
              " Log message in the application log
              IF NOT iv_search_string IS INITIAL.
                DATA(vv_jump_search) = 'X'.
                CONTINUE.
              ENDIF.
*      SARCE FIN 3###########################################
              " Log message in the application log
              me->/iwbep/if_sb_dpc_comm_services~log_message(
                EXPORTING
                  iv_msg_type   = 'E'
                  iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
                  iv_msg_number = 020
                  iv_msg_v1     = ls_filter-property ).
              " Raise Exception
              RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
                EXPORTING
                  textid = /iwbep/cx_mgw_tech_exception=>internal_error.
          ENDCASE.

        ENDLOOP.
*      SARCE INI 4###########################################
        IF vv_jump_search = 'X'.
          vv_jump_search = ''.
          CONTINUE.
        ENDIF.
        "MTS: Ajustes
*      SARCE FIN 4###########################################
      ENDIF.

* Get RFC destination
      lo_dp_facade = /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ).
      lv_destination = /iwbep/cl_sb_gen_dpc_rt_util=>get_rfc_destination( io_dp_facade = lo_dp_facade ).

*-------------------------------------------------------------
*  Call RFC function module
*-------------------------------------------------------------
      lv_rfc_name = 'ZUI5_CM_GET_POS_ENTREGAS'.

      IF lv_destination IS INITIAL OR lv_destination EQ 'NONE'.

        TRY.
            CALL FUNCTION lv_rfc_name
              EXPORTING
                ir_vbeln       = ir_vbeln
                ir_matnr       = ir_matnr
                ir_maktx       = ir_maktx
                ir_tplst       = ir_tplst
                ir_largo       = ir_largo
                ir_ancho       = ir_ancho
                ir_alto        = ir_alto
                ir_status      = ir_status
                ir_lote        = ir_lote
                ir_kunnr       = ir_kunnr
                ir_tknum       = ir_tknum
                i_tknum        = i_tknum
                i_vbeln        = i_vbeln
              IMPORTING
                o_return       = o_return
                o_data         = o_data
              EXCEPTIONS
                system_failure = 1000 message lv_exc_msg
                OTHERS         = 1002.

            lv_subrc = sy-subrc.
*in case of co-deployment the exception is raised and needs to be caught
          CATCH cx_root INTO lx_root.
            lv_subrc = 1001.
            lv_exc_msg = lx_root->if_message~get_text( ).
        ENDTRY.

      ELSE.

        CALL FUNCTION lv_rfc_name DESTINATION lv_destination
          EXPORTING
            ir_vbeln              = ir_vbeln
            ir_matnr              = ir_matnr
            ir_maktx              = ir_maktx
            ir_tplst              = ir_tplst
            ir_largo              = ir_largo
            ir_ancho              = ir_ancho
            ir_alto               = ir_alto
            ir_status             = ir_status
            ir_lote               = ir_lote
            ir_kunnr              = ir_kunnr
            ir_tknum              = ir_tknum
            i_tknum               = i_tknum
            i_vbeln               = i_vbeln
          IMPORTING
            o_return              = o_return
            o_data                = o_data
          EXCEPTIONS
            system_failure        = 1000 MESSAGE lv_exc_msg
            communication_failure = 1001 MESSAGE lv_exc_msg
            OTHERS                = 1002.

        lv_subrc = sy-subrc.

      ENDIF.

      "MTS: Ajustes
      APPEND LINES OF o_data TO o_data_temp.

*-------------------------------------------------------------
*  Map the RFC response to the caller interface - Only mapped attributes
*-------------------------------------------------------------
*-------------------------------------------------------------
* Error and exception handling
*-------------------------------------------------------------
      IF lv_subrc <> 0.
* Execute the RFC exception handling process
        me->/iwbep/if_sb_dpc_comm_services~rfc_exception_handling(
          EXPORTING
            iv_subrc            = lv_subrc
            iv_exp_message_text = lv_exc_msg ).
      ENDIF.

      IF o_return IS NOT INITIAL.
        me->/iwbep/if_sb_dpc_comm_services~rfc_save_log(
          EXPORTING
            iv_entity_type = iv_entity_name
            it_return      = o_return
            it_key_tab     = it_key_tab ).
      ENDIF.

    ENDDO. "MTS Ajustes
    o_data = o_data_temp.
*-------------------------------------------------------------------------*
*             - Post Backend Call -
*-------------------------------------------------------------------------*
    IF ls_paging-skip IS NOT INITIAL.
*  If the Skip value was requested at runtime
*  the response table will provide backend entries from skip + 1, meaning start from skip +1
*  for example: skip=5 means to start get results from the 6th row
      lv_skip = ls_paging-skip + 1.
    ENDIF.
*  The Top value was requested at runtime but was not handled as part of the function interface
    IF  ls_paging-top <> 0
    AND lv_skip IS NOT INITIAL.
*  if lv_skip > 0 retrieve the entries from lv_skip + Top - 1
*  for example: skip=5 and top=2 means to start get results from the 6th row and end in row number 7
      lv_top = ls_paging-top + lv_skip - 1.
    ELSEIF ls_paging-top <> 0
    AND    lv_skip IS INITIAL.
      lv_top = ls_paging-top.
    ELSE.
      lv_top = lines( o_data ).
    ENDIF.

    "Ordenamos
    IF it_order IS NOT INITIAL.
      SORT o_data BY zcl_search_dpc=>sort_string( EXPORTING iv_instancia = me ).
      DELETE ADJACENT DUPLICATES FROM o_data.
    ENDIF.


*  - Map properties from the backend to the Gateway output response table -

    LOOP AT o_data INTO ls_o_data
*  Provide the response entries according to the Top and Skip parameters that were provided at runtime
         FROM lv_skip TO lv_top.
*  Only fields that were mapped will be delivered to the response table
      ls_gw_o_data-posnr = ls_o_data-posnr.
      ls_gw_o_data-largo_uom = ls_o_data-largo_uom.
      ls_gw_o_data-ancho_uom = ls_o_data-ancho_uom.
      ls_gw_o_data-alto_uom = ls_o_data-alto_uom.
      ls_gw_o_data-status_text = ls_o_data-status_text.
      ls_gw_o_data-lfimg = ls_o_data-lfimg.
      ls_gw_o_data-meins = ls_o_data-meins.
      ls_gw_o_data-kunnr = ls_o_data-kunnr.
      ls_gw_o_data-tipo_pallet = ls_o_data-tipo_pallet.
      ls_gw_o_data-num_pallets = ls_o_data-num_pallets.
      ls_gw_o_data-cajas_pallets = ls_o_data-cajas_pallets.
      ls_gw_o_data-vbeln = ls_o_data-vbeln.
      ls_gw_o_data-matnr = ls_o_data-matnr.
      ls_gw_o_data-maktx = ls_o_data-maktx.
      ls_gw_o_data-werks = ls_o_data-werks.
      ls_gw_o_data-lgort = ls_o_data-lgort.
      ls_gw_o_data-largo = ls_o_data-largo.
      ls_gw_o_data-ancho = ls_o_data-ancho.
      ls_gw_o_data-alto = ls_o_data-alto.
      ls_gw_o_data-status_lote = ls_o_data-status_lote.
      ls_gw_o_data-charg = ls_o_data-charg.
      ls_gw_o_data-kunnr_name = ls_o_data-kunnr_name.
      ls_gw_o_data-tknum = ls_o_data-tknum.
      ls_gw_o_data-txt_tipo_pallet = ls_o_data-txt_tipo_pallet.
      ls_gw_o_data-flagmontado = ls_o_data-flagmontado.
      ls_gw_o_data-refdoc = ls_o_data-refdoc.
      ls_gw_o_data-refdocitem = ls_o_data-refdocitem.
      APPEND ls_gw_o_data TO et_entityset.
      CLEAR ls_gw_o_data.
    ENDLOOP.

  ENDMETHOD.
  METHOD transportesset_get_entityset.
*-------------------------------------------------------------
*  Data declaration
*-------------------------------------------------------------
    DATA e_data  TYPE zif_zui5_cm_get_transportes=>zsuitt_cm_get_transportes.
    DATA e_data_temp  TYPE zif_zui5_cm_get_transportes=>zsuitt_cm_get_transportes.
    DATA e_return  TYPE zif_zui5_cm_get_transportes=>bapiret2_t.
    DATA ir_conductor  TYPE zif_zui5_cm_get_transportes=>zsuis_cm_zzconductor_rang.
    DATA ir_destinatario  TYPE zif_zui5_cm_get_transportes=>shp_kunwe_range_t.
    DATA ir_destinatario_nombre  TYPE zif_zui5_cm_get_transportes=>zsuis_cm_nombres_rang.
    DATA ir_fecha_crea  TYPE zif_zui5_cm_get_transportes=>date_t_range.
    DATA ir_lgort  TYPE zif_zui5_cm_get_transportes=>range_t_lgort_d.
    DATA ir_matricula  TYPE zif_zui5_cm_get_transportes=>isi_signi_ra.
    DATA ir_status  TYPE zif_zui5_cm_get_transportes=>zsuis_cm_status_trans_range.
    DATA ir_status_nombre  TYPE zif_zui5_cm_get_transportes=>zsuis_cm_textos_dominio_rang.
    DATA ir_transporte  TYPE zif_zui5_cm_get_transportes=>shp_tknum_range_t.
    DATA ir_transportista  TYPE zif_zui5_cm_get_transportes=>md_range_t_lifnr.
    DATA ir_transportista_nombre  TYPE zif_zui5_cm_get_transportes=>zsuis_cm_nombres_rang.
    DATA ir_werks  TYPE zif_zui5_cm_get_transportes=>range_t_werks_d.
    DATA ir_shtyp  TYPE rseloption.
    DATA ir_monitor  TYPE rseloption.
    DATA ls_e_data  TYPE LINE OF zif_zui5_cm_get_transportes=>zsuitt_cm_get_transportes.
    DATA ls_e_return  TYPE LINE OF zif_zui5_cm_get_transportes=>bapiret2_t.
    DATA ls_ir_conductor  TYPE LINE OF zif_zui5_cm_get_transportes=>zsuis_cm_zzconductor_rang.
    DATA ls_ir_destinatario  TYPE LINE OF zif_zui5_cm_get_transportes=>shp_kunwe_range_t.
    DATA ls_ir_destinatario_nombre  TYPE LINE OF zif_zui5_cm_get_transportes=>zsuis_cm_nombres_rang.
    DATA ls_ir_fecha_crea  TYPE LINE OF zif_zui5_cm_get_transportes=>date_t_range.
    DATA ls_ir_lgort  TYPE LINE OF zif_zui5_cm_get_transportes=>range_t_lgort_d.
    DATA ls_ir_matricula  TYPE LINE OF zif_zui5_cm_get_transportes=>isi_signi_ra.
    DATA ls_ir_status  TYPE LINE OF zif_zui5_cm_get_transportes=>zsuis_cm_status_trans_range.
    DATA ls_ir_status_nombre  TYPE LINE OF zif_zui5_cm_get_transportes=>zsuis_cm_textos_dominio_rang.
    DATA ls_ir_transporte  TYPE LINE OF zif_zui5_cm_get_transportes=>shp_tknum_range_t.
    DATA ls_ir_transportista  TYPE LINE OF zif_zui5_cm_get_transportes=>md_range_t_lifnr.
    DATA ls_ir_transportista_nombre  TYPE LINE OF zif_zui5_cm_get_transportes=>zsuis_cm_nombres_rang.
    DATA ls_ir_werks  TYPE LINE OF zif_zui5_cm_get_transportes=>range_t_werks_d.
    DATA ls_ir_shtyp  TYPE rsdsselopt.
    DATA lv_rfc_name TYPE tfdir-funcname.
    DATA lv_destination TYPE rfcdest.
    DATA lv_subrc TYPE syst-subrc.
    DATA lv_exc_msg TYPE /iwbep/mgw_bop_rfc_excep_text.
    DATA lx_root TYPE REF TO cx_root.
    DATA lo_filter TYPE  REF TO /iwbep/if_mgw_req_filter.
    DATA lt_filter_select_options TYPE /iwbep/t_mgw_select_option.
    DATA lv_filter_str TYPE string.
    DATA ls_paging TYPE /iwbep/s_mgw_paging.
    DATA ls_converted_keys LIKE LINE OF et_entityset.
    DATA ls_filter TYPE /iwbep/s_mgw_select_option.
    DATA ls_filter_range TYPE /iwbep/s_cod_select_option.
    DATA lr_lgort LIKE RANGE OF ls_converted_keys-lgort.
    DATA ls_lgort LIKE LINE OF lr_lgort.
    DATA lr_werks LIKE RANGE OF ls_converted_keys-werks.
    DATA ls_werks LIKE LINE OF lr_werks.
    DATA lr_almacen_montaje LIKE RANGE OF ls_converted_keys-almacen_montaje.
    DATA ls_almacen_montaje LIKE LINE OF lr_almacen_montaje.
    DATA lr_kunwe_name LIKE RANGE OF ls_converted_keys-kunwe_name.
    DATA ls_kunwe_name LIKE LINE OF lr_kunwe_name.
    DATA lr_kunwe LIKE RANGE OF ls_converted_keys-kunwe.
    DATA ls_kunwe LIKE LINE OF lr_kunwe.
    DATA lr_erdat LIKE RANGE OF ls_converted_keys-erdat.
    DATA ls_erdat LIKE LINE OF lr_erdat.
    DATA lr_sttrg_name LIKE RANGE OF ls_converted_keys-sttrg_name.
    DATA ls_sttrg_name LIKE LINE OF lr_sttrg_name.
    DATA lr_sttrg LIKE RANGE OF ls_converted_keys-sttrg.
    DATA ls_sttrg LIKE LINE OF lr_sttrg.
    DATA lr_signi LIKE RANGE OF ls_converted_keys-signi.
    DATA ls_signi LIKE LINE OF lr_signi.
    DATA lr_zzconductor LIKE RANGE OF ls_converted_keys-zzconductor.
    DATA ls_zzconductor LIKE LINE OF lr_zzconductor.
    DATA lr_tdlnr_name LIKE RANGE OF ls_converted_keys-tdlnr_name.
    DATA ls_tdlnr_name LIKE LINE OF lr_tdlnr_name.
    DATA lr_tdlnr LIKE RANGE OF ls_converted_keys-tdlnr.
    DATA ls_tdlnr LIKE LINE OF lr_tdlnr.
    DATA lr_tknum LIKE RANGE OF ls_converted_keys-tknum.
    DATA ls_tknum LIKE LINE OF lr_tknum.
    DATA lr_tipo_trans LIKE RANGE OF ls_converted_keys-shtyp.
    DATA lr_monitor LIKE RANGE OF ls_converted_keys-monitor.
    DATA ls_tipo_trans LIKE LINE OF lr_tipo_trans.
    DATA lr_centro_montaje LIKE RANGE OF ls_converted_keys-centro_montaje.
    DATA ls_centro_montaje LIKE LINE OF lr_centro_montaje.
    DATA lo_dp_facade TYPE REF TO /iwbep/if_mgw_dp_facade.
    DATA ls_gw_e_data LIKE LINE OF et_entityset.
    DATA lv_skip     TYPE int4.
    DATA lv_top      TYPE int4.

    "MTS: Ajustes filtro OR
    DATA lt_filter_select_options_and TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_temp TYPE /iwbep/t_mgw_select_option.
    DATA lt_filter_select_options_or TYPE /iwbep/t_mgw_select_option.
    DATA lv_veces TYPE i.
    DATA posicion TYPE i.
    "MTS: Ajustes filtro OR
*-------------------------------------------------------------
*  Map the runtime request to the RFC - Only mapped attributes
*-------------------------------------------------------------
* Get all input information from the technical request context object
* Since DPC works with internal property names and runtime API interface holds external property names
* the process needs to get the all needed input information from the technical request context object
* Get filter or select option information
    lo_filter = io_tech_request_context->get_filter( ).
    lt_filter_select_options = lo_filter->get_filter_select_options( ).
    lv_filter_str = lo_filter->get_filter_string( ).

* Check if the supplied filter is supported by standard gateway runtime process
    IF  lv_filter_str            IS NOT INITIAL
    AND lt_filter_select_options IS INITIAL.
      " If the string of the Filter System Query Option is not automatically converted into
      " filter option table (lt_filter_select_options), then the filtering combination is not supported
      " Log message in the application log
*      me->/iwbep/if_sb_dpc_comm_services~log_message(
*        EXPORTING
*          iv_msg_type   = 'E'
*          iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
*          iv_msg_number = 025 ).
*      " Raise Exception
*      RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
*        EXPORTING
*          textid = /iwbep/cx_mgw_tech_exception=>internal_error.

      "MTS: Ajustes filtro OR
      zcl_search_dpc=>filtros_or( EXPORTING iv_instancia = me iv_data = ls_gw_e_data IMPORTING et_filter_select_options_and = lt_filter_select_options_and et_filter_select_options_or = lt_filter_select_options_or ).
      "MTS: Ajustes filtro OR
    ENDIF.
    IF iv_search_string IS NOT INITIAL.
      zcl_search_dpc=>search_or( EXPORTING iv_instancia = me iv_search = iv_search_string iv_data = ls_gw_e_data it_filter_select_options = lt_filter_select_options
                 IMPORTING et_filter_select_options_or = lt_filter_select_options_or ).
    ENDIF.

* Get key table information
    io_tech_request_context->get_converted_source_keys(
      IMPORTING
        es_key_values  = ls_converted_keys ).

    ls_paging-top = io_tech_request_context->get_top( ).
    ls_paging-skip = io_tech_request_context->get_skip( ).

    "MTS: Ajustes filtro OR
    IF lt_filter_select_options_or IS NOT INITIAL OR lt_filter_select_options_and IS NOT INITIAL.
      DESCRIBE TABLE lt_filter_select_options_or LINES lv_veces.
      IF lv_veces IS INITIAL.
        lv_veces = 1.
      ENDIF.
    ELSE.
      lv_veces = 1.
    ENDIF.

    CLEAR posicion.

    IF lt_filter_select_options IS NOT INITIAL.
      zcl_search_dpc=>filtro_mayusculas(
     EXPORTING
       iv_data = ls_gw_e_data
       CHANGING
       ct_filter_select_options = lt_filter_select_options ).

      APPEND LINES OF lt_filter_select_options TO lt_filter_select_options_and.
    ENDIF.

    DO lv_veces TIMES.
      CLEAR: e_data, ir_lgort, ir_conductor, ir_destinatario, ir_destinatario_nombre, ir_fecha_crea, ir_matricula, ir_status,
      ir_status_nombre, ir_transporte, ir_transportista, ir_transportista_nombre, ir_werks.

      ADD 1 TO posicion.
      READ TABLE lt_filter_select_options_or INTO DATA(ls_option_or) INDEX posicion.
      IF sy-subrc = 0.
        lt_filter_select_options = lt_filter_select_options_and.

        APPEND ls_option_or TO lt_filter_select_options.
      ELSE.
        lt_filter_select_options = lt_filter_select_options_and.
      ENDIF.
      "MTS: Ajustes filtro OR

* Maps filter table lines to function module parameters
      LOOP AT lt_filter_select_options INTO ls_filter.

        CASE ls_filter-property.
          WHEN 'LGORT'.              " Equivalent to 'Lgort' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_lgort ).

            LOOP AT lr_lgort INTO ls_lgort.
              ls_ir_lgort-sign = ls_lgort-sign.
              ls_ir_lgort-option = ls_lgort-option.
              ls_ir_lgort-low = ls_lgort-low.
              ls_ir_lgort-high = ls_lgort-high.
              APPEND ls_ir_lgort TO ir_lgort.
            ENDLOOP.
            CLEAR lr_lgort.
          WHEN 'WERKS'.              " Equivalent to 'Werks' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_werks ).

            LOOP AT lr_werks INTO ls_werks.
              ls_ir_werks-sign = ls_werks-sign.
              ls_ir_werks-option = ls_werks-option.
              ls_ir_werks-low = ls_werks-low.
              ls_ir_werks-high = ls_werks-high.
              APPEND ls_ir_werks TO ir_werks.
            ENDLOOP.
            CLEAR lr_werks.
          WHEN 'ALMACEN_MONTAJE'.              " Equivalent to 'AlmacenMontaje' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_almacen_montaje ).

            LOOP AT lr_almacen_montaje INTO ls_almacen_montaje.
              ls_ir_lgort-sign = ls_almacen_montaje-sign.
              ls_ir_lgort-option = ls_almacen_montaje-option.
              ls_ir_lgort-low = ls_almacen_montaje-low.
              ls_ir_lgort-high = ls_almacen_montaje-high.
              APPEND ls_ir_lgort TO ir_lgort.
            ENDLOOP.
            CLEAR lr_almacen_montaje.
          WHEN 'KUNWE_NAME'.              " Equivalent to 'KunweName' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_kunwe_name ).

            LOOP AT lr_kunwe_name INTO ls_kunwe_name.
              ls_ir_destinatario_nombre-high = ls_kunwe_name-high.
              ls_ir_destinatario_nombre-low = ls_kunwe_name-low.
              ls_ir_destinatario_nombre-option = ls_kunwe_name-option.
              ls_ir_destinatario_nombre-sign = ls_kunwe_name-sign.
              APPEND ls_ir_destinatario_nombre TO ir_destinatario_nombre.
            ENDLOOP.
            CLEAR lr_kunwe_name.
          WHEN 'KUNWE'.              " Equivalent to 'Kunwe' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_kunwe ).

            LOOP AT lr_kunwe INTO ls_kunwe.
              ls_ir_destinatario-high = ls_kunwe-high.
              ls_ir_destinatario-low = ls_kunwe-low.
              ls_ir_destinatario-option = ls_kunwe-option.
              ls_ir_destinatario-sign = ls_kunwe-sign.
              APPEND ls_ir_destinatario TO ir_destinatario.
            ENDLOOP.
            CLEAR lr_kunwe.
          WHEN 'ERDAT'.              " Equivalent to 'Erdat' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_erdat ).

            LOOP AT lr_erdat INTO ls_erdat.
              ls_ir_fecha_crea-high = ls_erdat-high.
              ls_ir_fecha_crea-low = ls_erdat-low.
              ls_ir_fecha_crea-option = ls_erdat-option.
              ls_ir_fecha_crea-sign = ls_erdat-sign.
              APPEND ls_ir_fecha_crea TO ir_fecha_crea.
            ENDLOOP.
            CLEAR lr_erdat.
          WHEN 'STTRG_NAME'.              " Equivalent to 'SttrgName' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_sttrg_name ).

            LOOP AT lr_sttrg_name INTO ls_sttrg_name.
              ls_ir_status_nombre-high = ls_sttrg_name-high.
              ls_ir_status_nombre-low = ls_sttrg_name-low.
              ls_ir_status_nombre-option = ls_sttrg_name-option.
              ls_ir_status_nombre-sign = ls_sttrg_name-sign.
              APPEND ls_ir_status_nombre TO ir_status_nombre.
            ENDLOOP.
            CLEAR lr_sttrg_name.
          WHEN 'STTRG'.              " Equivalent to 'Sttrg' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_sttrg ).

            LOOP AT lr_sttrg INTO ls_sttrg.
              ls_ir_status-high = ls_sttrg-high.
              ls_ir_status-low = ls_sttrg-low.
              ls_ir_status-option = ls_sttrg-option.
              ls_ir_status-sign = ls_sttrg-sign.
              APPEND ls_ir_status TO ir_status.
            ENDLOOP.
            CLEAR lr_sttrg.
          WHEN 'SIGNI'.              " Equivalent to 'Signi' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_signi ).

            LOOP AT lr_signi INTO ls_signi.
              ls_ir_matricula-high = ls_signi-high.
              ls_ir_matricula-low = ls_signi-low.
              ls_ir_matricula-option = ls_signi-option.
              ls_ir_matricula-sign = ls_signi-sign.
              APPEND ls_ir_matricula TO ir_matricula.
            ENDLOOP.
            CLEAR lr_signi.
          WHEN 'ZZCONDUCTOR'.              " Equivalent to 'Zzconductor' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_zzconductor ).

            LOOP AT lr_zzconductor INTO ls_zzconductor.
              ls_ir_conductor-high = ls_zzconductor-high.
              ls_ir_conductor-low = ls_zzconductor-low.
              ls_ir_conductor-option = ls_zzconductor-option.
              ls_ir_conductor-sign = ls_zzconductor-sign.
              APPEND ls_ir_conductor TO ir_conductor.
            ENDLOOP.
            CLEAR lr_zzconductor.
          WHEN 'TDLNR_NAME'.              " Equivalent to 'TdlnrName' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_tdlnr_name ).

            LOOP AT lr_tdlnr_name INTO ls_tdlnr_name.
              ls_ir_transportista_nombre-high = ls_tdlnr_name-high.
              ls_ir_transportista_nombre-low = ls_tdlnr_name-low.
              ls_ir_transportista_nombre-option = ls_tdlnr_name-option.
              ls_ir_transportista_nombre-sign = ls_tdlnr_name-sign.
              APPEND ls_ir_transportista_nombre TO ir_transportista_nombre.
            ENDLOOP.
            CLEAR lr_tdlnr_name.
          WHEN 'TDLNR'.              " Equivalent to 'Tdlnr' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_tdlnr ).

            LOOP AT lr_tdlnr INTO ls_tdlnr.
              ls_ir_transportista-high = ls_tdlnr-high.
              ls_ir_transportista-low = ls_tdlnr-low.
              ls_ir_transportista-option = ls_tdlnr-option.
              ls_ir_transportista-sign = ls_tdlnr-sign.
              APPEND ls_ir_transportista TO ir_transportista.
            ENDLOOP.
            CLEAR lr_tdlnr.
          WHEN 'TKNUM'.              " Equivalent to 'Tknum' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_tknum ).

            LOOP AT lr_tknum INTO ls_tknum.
              ls_ir_transporte-high = ls_tknum-high.
              ls_ir_transporte-low = ls_tknum-low.
              ls_ir_transporte-option = ls_tknum-option.
              ls_ir_transporte-sign = ls_tknum-sign.
              APPEND ls_ir_transporte TO ir_transporte.
            ENDLOOP.
            CLEAR lr_tknum.
          WHEN 'CENTRO_MONTAJE'.              " Equivalent to 'CentroMontaje' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_centro_montaje ).

            LOOP AT lr_centro_montaje INTO ls_centro_montaje.
              ls_ir_werks-sign = ls_centro_montaje-sign.
              ls_ir_werks-option = ls_centro_montaje-option.
              ls_ir_werks-low = ls_centro_montaje-low.
              ls_ir_werks-high = ls_centro_montaje-high.
              APPEND ls_ir_werks TO ir_werks.
            ENDLOOP.
            CLEAR lr_centro_montaje.

          WHEN 'SHTYP'.              " Equivalent to 'CentroMontaje' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_tipo_trans ).

            LOOP AT lr_tipo_trans INTO ls_tipo_trans.

              APPEND VALUE #( sign = ls_tipo_trans-sign option = ls_tipo_trans-option
                              low = ls_tipo_trans-low high = ls_tipo_trans-high ) TO ir_shtyp.

            ENDLOOP.
            CLEAR lr_tipo_trans.
          WHEN 'MONITOR'.              " Equivalent to 'CentroMontaje' property in the service
            lo_filter->convert_select_option(
              EXPORTING
                is_select_option = ls_filter
              IMPORTING
                et_select_option = lr_monitor ).

            LOOP AT lr_monitor INTO DATA(ls_monitor).

              APPEND VALUE #( sign = ls_monitor-sign option = ls_monitor-option
                              low = ls_monitor-low high = ls_monitor-high ) TO ir_monitor.

            ENDLOOP.
            CLEAR lr_monitor.

          WHEN OTHERS.
*       SARCE INI 3###########################################
            " Log message in the application log
            IF NOT iv_search_string IS INITIAL.
              DATA(vv_jump_search) = 'X'.
              CONTINUE.
            ENDIF.
*      SARCE FIN 3###########################################
            " Log message in the application log
            me->/iwbep/if_sb_dpc_comm_services~log_message(
              EXPORTING
                iv_msg_type   = 'E'
                iv_msg_id     = '/IWBEP/MC_SB_DPC_ADM'
                iv_msg_number = 020
                iv_msg_v1     = ls_filter-property ).
            " Raise Exception
            RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
              EXPORTING
                textid = /iwbep/cx_mgw_tech_exception=>internal_error.
        ENDCASE.

      ENDLOOP.

*      SARCE INI 4###########################################
      IF vv_jump_search = 'X'.
        vv_jump_search = ''.
        CONTINUE.
      ENDIF.
      "MTS: Ajustes
*      SARCE FIN 4###########################################

* Get RFC destination
      lo_dp_facade = /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ).
      lv_destination = /iwbep/cl_sb_gen_dpc_rt_util=>get_rfc_destination( io_dp_facade = lo_dp_facade ).

*-------------------------------------------------------------
*  Call RFC function module
*-------------------------------------------------------------
      lv_rfc_name = 'ZUI5_CM_GET_TRANSPORTES'.

      IF lv_destination IS INITIAL OR lv_destination EQ 'NONE'.

        TRY.
            CALL FUNCTION lv_rfc_name
              EXPORTING
                ir_lgort                = ir_lgort
                ir_werks                = ir_werks
                ir_destinatario_nombre  = ir_destinatario_nombre
                ir_destinatario         = ir_destinatario
                ir_fecha_crea           = ir_fecha_crea
                ir_status_nombre        = ir_status_nombre
                ir_status               = ir_status
                ir_matricula            = ir_matricula
                ir_conductor            = ir_conductor
                ir_transportista_nombre = ir_transportista_nombre
                ir_transportista        = ir_transportista
                ir_transporte           = ir_transporte
                ir_shtyp                = ir_shtyp
                ir_monitor              = ir_monitor
              IMPORTING
                e_return                = e_return
                e_data                  = e_data
              EXCEPTIONS
                system_failure          = 1000 message lv_exc_msg
                OTHERS                  = 1002.

            lv_subrc = sy-subrc.
*in case of co-deployment the exception is raised and needs to be caught
          CATCH cx_root INTO lx_root.
            lv_subrc = 1001.
            lv_exc_msg = lx_root->if_message~get_text( ).
        ENDTRY.

      ELSE.

        CALL FUNCTION lv_rfc_name DESTINATION lv_destination
          EXPORTING
            ir_lgort                = ir_lgort
            ir_werks                = ir_werks
            ir_destinatario_nombre  = ir_destinatario_nombre
            ir_destinatario         = ir_destinatario
            ir_fecha_crea           = ir_fecha_crea
            ir_status_nombre        = ir_status_nombre
            ir_status               = ir_status
            ir_matricula            = ir_matricula
            ir_conductor            = ir_conductor
            ir_transportista_nombre = ir_transportista_nombre
            ir_transportista        = ir_transportista
            ir_transporte           = ir_transporte
            ir_shtyp                = ir_shtyp
            ir_monitor              = ir_monitor
          IMPORTING
            e_return                = e_return
            e_data                  = e_data
          EXCEPTIONS
            system_failure          = 1000 MESSAGE lv_exc_msg
            communication_failure   = 1001 MESSAGE lv_exc_msg
            OTHERS                  = 1002.

        lv_subrc = sy-subrc.

      ENDIF.

      "MTS: Ajustes
      APPEND LINES OF e_data TO e_data_temp.
*-------------------------------------------------------------
*  Map the RFC response to the caller interface - Only mapped attributes
*-------------------------------------------------------------
*-------------------------------------------------------------
* Error and exception handling
*-------------------------------------------------------------
      IF lv_subrc <> 0.
* Execute the RFC exception handling process
        me->/iwbep/if_sb_dpc_comm_services~rfc_exception_handling(
          EXPORTING
            iv_subrc            = lv_subrc
            iv_exp_message_text = lv_exc_msg ).
      ENDIF.

      IF e_return IS NOT INITIAL.
        me->/iwbep/if_sb_dpc_comm_services~rfc_save_log(
          EXPORTING
            iv_entity_type = iv_entity_name
            it_return      = e_return
            it_key_tab     = it_key_tab ).
      ENDIF.

    ENDDO. "MTS Ajustes
    e_data = e_data_temp.

*-------------------------------------------------------------------------*
*             - Post Backend Call -
*-------------------------------------------------------------------------*
    IF ls_paging-skip IS NOT INITIAL.
*  If the Skip value was requested at runtime
*  the response table will provide backend entries from skip + 1, meaning start from skip +1
*  for example: skip=5 means to start get results from the 6th row
      lv_skip = ls_paging-skip + 1.
    ENDIF.
*  The Top value was requested at runtime but was not handled as part of the function interface
    IF  ls_paging-top <> 0
    AND lv_skip IS NOT INITIAL.
*  if lv_skip > 0 retrieve the entries from lv_skip + Top - 1
*  for example: skip=5 and top=2 means to start get results from the 6th row and end in row number 7
      lv_top = ls_paging-top + lv_skip - 1.
    ELSEIF ls_paging-top <> 0
    AND    lv_skip IS INITIAL.
      lv_top = ls_paging-top.
    ELSE.
      lv_top = lines( e_data ).
    ENDIF.

    "Ordenamos
    IF it_order IS NOT INITIAL.
      SORT e_data BY zcl_search_dpc=>sort_string( EXPORTING iv_instancia = me  ).
      DELETE ADJACENT DUPLICATES FROM e_data.
    ENDIF.


*  - Map properties from the backend to the Gateway output response table -

    LOOP AT e_data INTO ls_e_data
*  Provide the response entries according to the Top and Skip parameters that were provided at runtime
         FROM lv_skip TO lv_top.
*  Only fields that were mapped will be delivered to the response table
      ls_gw_e_data-almacen_montaje = ls_e_data-almacen_montaje.
      ls_gw_e_data-kunwe_name = ls_e_data-kunwe_name.
      ls_gw_e_data-kunwe = ls_e_data-kunwe.
      ls_gw_e_data-erdat = ls_e_data-erdat.
      ls_gw_e_data-sttrg_name = ls_e_data-sttrg_name.
      ls_gw_e_data-sttrg = ls_e_data-sttrg.
      ls_gw_e_data-signi = ls_e_data-signi.
      ls_gw_e_data-zzconductor = ls_e_data-zzconductor.
      ls_gw_e_data-tdlnr_name = ls_e_data-tdlnr_name.
      ls_gw_e_data-tdlnr = ls_e_data-tdlnr.
      ls_gw_e_data-tknum = ls_e_data-tknum.
      ls_gw_e_data-centro_montaje = ls_e_data-centro_montaje.
      ls_gw_e_data-borrable = ls_e_data-borrable.
      ls_gw_e_data-editable = ls_e_data-editable.
      ls_gw_e_data-route_name = ls_e_data-route_name.
      ls_gw_e_data-zzconductor_name = ls_e_data-zzconductor_name.
      ls_gw_e_data-route = ls_e_data-route.
      ls_gw_e_data-shtyp = ls_e_data-shtyp.
      ls_gw_e_data-tipotrans = ls_e_data-tipotrans.
      ls_gw_e_data-remolque = ls_e_data-remolque.
      ls_gw_e_data-telefono = ls_e_data-telefono.
      ls_gw_e_data-monitor = ls_e_data-monitor.
      ls_gw_e_data-werks = ls_e_data-werks.
      ls_gw_e_data-lgort = ls_e_data-almacen_montaje.
      APPEND ls_gw_e_data TO et_entityset.
      CLEAR ls_gw_e_data.
    ENDLOOP.

  ENDMETHOD.
