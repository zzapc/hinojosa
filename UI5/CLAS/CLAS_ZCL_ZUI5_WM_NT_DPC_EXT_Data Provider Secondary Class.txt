
class ZCL_ZUI5_WM_NT_DPC_EXT definition
  public
  inheriting from ZCL_ZUI5_WM_NT_DPC
  create public .

public section.

  constants GC_ACTION_MOVE_BOBINE type STRING value 'moveBobine' ##NO_TEXT.
  constants GC_ACTION_GET_BOBINE_FOR_MATNR type STRING value 'getBobineForPedidoMatnr' ##NO_TEXT.
  constants GC_ACTION_UBICACION_PROP_UA type STRING value 'getUbicacionPropuestaUA' ##NO_TEXT.

  methods VALIDAR_LECTURA_UA
    importing
      !VP_WERKS type WERKS_D
      !VP_LENUM type LENUM
      !VP_BENUM type LTBK-BENUM
      !VP_NLPLA type LTBK-NLPLA
      !VP_TBNUM type LTBK-TBNUM
    returning
      value(WP_RETURN) type BAPIRET2
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods UNIDADES_ALMACEN_GETLIST
    importing
      value(VP_WERKS) type ZWM_NT_UI5_S_UNIDADES_ALMACEN-WERKS
      !IO_TECH_REQUEST_CONTEXT type ref to /IWBEP/IF_MGW_REQ_ENTITYSET optional
    returning
      value(TP_UNIDADES_ALMAC) type ZWM_NT_UI5_T_UNIDADES_ALMACEN
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods UNIDADES_ALMACEN_GETDETAIL
    importing
      value(VP_WERKS) type ZWM_NT_UI5_S_UNIDADES_ALMACEN-WERKS
      value(VP_LENUM) type ZWM_NT_UI5_S_UNIDADES_ALMACEN-LENUM
    returning
      value(WP_UNIDADES_ALMAC) type ZWM_NT_UI5_S_UNIDADES_ALMACEN
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods UBICACIONES_GETLIST
    importing
      value(VP_WERKS) type ZWM_NT_UI5_UBICACIONES_STR-WERKS
    returning
      value(TP_UBICACION) type ZWM_NT_UI5_UBICACIONES_TAB
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods UBICACIONES_GETDETAIL
    importing
      value(VP_WERKS) type ZWM_NT_UI5_UBICACIONES_STR-WERKS
      value(VP_LGPLA) type ZWM_NT_UI5_UBICACIONES_STR-LGPLA
    returning
      value(WP_UBICACION) type ZWM_NT_UI5_UBICACIONES_STR
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_VALID_GENERAR_NEC
    importing
      value(VP_COD_PARTE_REBOB) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-COD_PARTE_REBOB
      value(VP_ID_MAQUINA) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-ID_MAQUINA
      value(VP_WERKS) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-WERKS
    returning
      value(TP_RETURN) type BAPIRET2_T
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_REABRIR_PARTE
    importing
      value(VP_COD_PARTE_REBOB) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-COD_PARTE_REBOB
      value(VP_ID_MAQUINA) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-ID_MAQUINA
      value(VP_WERKS) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-WERKS
    returning
      value(WP_RETURN) type BAPIRET2
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_GENERAR_NEC
    importing
      value(VP_COD_PARTE_REBOB) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-COD_PARTE_REBOB
      value(VP_ID_MAQUINA) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-ID_MAQUINA
      value(VP_WERKS) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-WERKS
    returning
      value(WP_RETURN) type BAPIRET2
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_CERRAR_PARTE
    importing
      value(VP_COD_PARTE_REBOB) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-COD_PARTE_REBOB
      value(VP_ID_MAQUINA) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-ID_MAQUINA
      value(VP_WERKS) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-WERKS
    returning
      value(WP_RETURN) type BAPIRET2
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_CAB_UPDATE
    changing
      !WP_PARTE_REBOB_CAB type ZWM_NT_UI5_S_PARTE_REBOB_CAB
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_CAB_GETLIST
    importing
      value(VP_ID_MAQUINA) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-ID_MAQUINA
      value(VP_WERKS) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-WERKS
    returning
      value(TP_PARTE_REBOB_CAB) type ZWM_NT_UI5_T_PARTE_REBOB_CAB
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_CAB_GETDETAIL
    importing
      value(VP_COD_PARTE_REBOB) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-COD_PARTE_REBOB
      value(VP_ID_MAQUINA) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-ID_MAQUINA
      value(VP_WERKS) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-WERKS
    returning
      value(WP_PARTE_REBOB_CAB) type ZWM_NT_UI5_S_PARTE_REBOB_CAB
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_CAB_DELETE
    importing
      !WP_PARTE_REBOB_CAB type ZWM_NT_UI5_S_PARTE_REBOB_CAB
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_CAB_CREATE
    changing
      !WP_PARTE_REBOB_CAB type ZWM_NT_UI5_S_PARTE_REBOB_CAB
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_BOB_PROD_UPDATE
    changing
      !WP_PARTE_REBOB_BOB_PROD type ZWM_NT_UI5_S_PARTE_REBOB_BOB_P
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_BOB_PROD_GETLIST
    importing
      value(VP_COD_PARTE_REBOB) type ZWM_NT_UI5_S_PARTE_REBOB_BOB_P-COD_PARTE_REBOB
      value(VP_ID_MAQUINA) type ZWM_NT_UI5_S_PARTE_REBOB_BOB_P-ID_MAQUINA
      value(VP_WERKS) type ZWM_NT_UI5_S_PARTE_REBOB_BOB_P-WERKS
    returning
      value(TP_PARTE_REBOB_BOB_PROD) type ZWM_NT_UI5_T_PARTE_REBOB_BOB_P
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_BOB_PROD_GETDETAIL
    importing
      value(VP_COD_PARTE_REBOB) type ZWM_NT_UI5_S_PARTE_REBOB_BOB_P-COD_PARTE_REBOB
      value(VP_CONTADOR) type ZWM_NT_UI5_S_PARTE_REBOB_BOB_P-CONTADOR
      value(VP_ID_MAQUINA) type ZWM_NT_UI5_S_PARTE_REBOB_BOB_P-ID_MAQUINA
      value(VP_WERKS) type ZWM_NT_UI5_S_PARTE_REBOB_BOB_P-WERKS
    returning
      value(WP_PARTE_REBOB_BOB_PROD) type ZWM_NT_UI5_S_PARTE_REBOB_BOB_P
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_BOB_PROD_DELETE
    importing
      !WP_PARTE_REBOB_BOB_PROD type ZWM_NT_UI5_S_PARTE_REBOB_BOB_P
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_BOB_PROD_CREATE
    changing
      !WP_PARTE_REBOB_BOB_PROD type ZWM_NT_UI5_S_PARTE_REBOB_BOB_P
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_BOB_CONS_UPDATE
    changing
      !WP_PARTE_REBOB_BOB_CONS type ZWM_NT_UI5_S_PARTE_REBOB_BOB_C
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods CLIENTES_GETLIST
    importing
      value(VP_RSNUM) type RSNUM
      value(VP_LGNUM) type LGNUM
    returning
      value(TP_CLIENTES) type ZWM_NT_UI5_CLIENTES_TAB
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods GET_CALIDAD
    importing
      value(VP_WERKS) type WERKS_D
      value(VP_MATKL) type MATKL
    returning
      value(VP_CALIDAD) type CHAR03 .
  methods GET_CENTROS_LOGO
    importing
      !VP_WERKS type WERKS_D
    returning
      value(VP_LOGO) type XSTRING
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods GET_DATOS_REUBICAR_RESTO
    importing
      value(VP_WERKS) type WERKS_D
      value(VP_LENUM) type LENUM
      value(VP_LGPLA) type LGPLA
    returning
      value(WP_DATOS) type ZWM_NT_UI5_DATOS_REUBIC_RESTO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods GRUPOS_MAQUINAS_GETDETAIL
    importing
      value(VP_LGNUM) type LGNUM
      value(VP_GRUPO) type ZWM_NT_UI5_GRUPOS_MAQUINAS_STR-GRUPO
    returning
      value(WP_GRUPO_MAQUINAS) type ZWM_NT_UI5_GRUPOS_MAQUINAS_STR
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods LISTA_APROV_PP_GETLIST
    importing
      value(VP_WERKS) type WERKS_D
      value(VP_LGPLA) type LGPLA
      value(VP_ID) type ZWM_ID optional
      value(VP_LISTA_APRO) type XFELD default SPACE
      value(VP_MARGEN_SEL_ORDENES) type INT4 default 0
      value(VP_MOSTRAR_INACTIVOS) type XFELD default SPACE
    returning
      value(TP_LISTA) type ZWM_NT_UI5_APROV_LIST_TAB
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods MAQUINAS_GETLIST
    importing
      value(VP_LGNUM) type LGNUM
      value(VP_GRUPO) type ZWM_GRUPO_MAQ optional
    returning
      value(TP_MAQUINAS) type ZWM_NT_UI5_MAQUINAS_TAB
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods MATERIALES_GETDETAIL
    importing
      value(VP_WERKS) type ZWM_NT_UI5_S_MATERIALES-WERKS
      value(VP_MATNR) type ZWM_NT_UI5_S_MATERIALES-MATNR
    returning
      value(WP_MATERIAL) type ZWM_NT_UI5_S_MATERIALES
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods MATERIALES_GETLIST
    importing
      value(VP_WERKS) type ZWM_NT_UI5_S_MATERIALES-WERKS
    returning
      value(TP_MATERIALES) type ZWM_NT_UI5_T_MATERIALES
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_ANULAR_NEC
    importing
      value(VP_COD_PARTE_REBOB) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-COD_PARTE_REBOB
      value(VP_ID_MAQUINA) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-ID_MAQUINA
      value(VP_WERKS) type ZWM_NT_UI5_S_PARTE_REBOB_CAB-WERKS
    returning
      value(WP_RETURN) type BAPIRET2
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_BOB_CONS_CREATE
    changing
      !WP_PARTE_REBOB_BOB_CONS type ZWM_NT_UI5_S_PARTE_REBOB_BOB_C
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_BOB_CONS_DELETE
    importing
      !WP_PARTE_REBOB_BOB_CONS type ZWM_NT_UI5_S_PARTE_REBOB_BOB_C
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_BOB_CONS_GETDETAIL
    importing
      value(VP_COD_PARTE_REBOB) type ZWM_NT_UI5_S_PARTE_REBOB_BOB_C-COD_PARTE_REBOB
      value(VP_CONTADOR) type ZWM_NT_UI5_S_PARTE_REBOB_BOB_C-CONTADOR
      value(VP_ID_MAQUINA) type ZWM_NT_UI5_S_PARTE_REBOB_BOB_C-ID_MAQUINA
      value(VP_WERKS) type ZWM_NT_UI5_S_PARTE_REBOB_BOB_C-WERKS
    returning
      value(WP_PARTE_REBOB_BOB_CONS) type ZWM_NT_UI5_S_PARTE_REBOB_BOB_C
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_BOB_CONS_GETLIST
    importing
      value(VP_COD_PARTE_REBOB) type ZWM_NT_UI5_S_PARTE_REBOB_BOB_C-COD_PARTE_REBOB
      value(VP_ID_MAQUINA) type ZWM_NT_UI5_S_PARTE_REBOB_BOB_C-ID_MAQUINA
      value(VP_WERKS) type ZWM_NT_UI5_S_PARTE_REBOB_BOB_C-WERKS
    returning
      value(TP_PARTE_REBOB_BOB_CONS) type ZWM_NT_UI5_T_PARTE_REBOB_BOB_C
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods VALIDAR_REGULARIZAR_UA
    importing
      value(VP_WERKS) type WERKS_D
      value(VP_LGPLA) type LGPLA
      value(VP_UA) type LTAP-VLENR
    returning
      value(WP_BOBINA) type ZWM_NT_UI5_APLIST_BOBINE_STR
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods IMPRIMIR_UA
    importing
      value(VP_WERKS) type WERKS_D
      value(VP_LGPLA) type LGPLA
      value(VP_UA) type LTAP-VLENR
    returning
      value(WP_RETURN) type BAPIRET2
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods REGULARIZAR_UA
    importing
      value(VP_WERKS) type WERKS_D
      value(VP_LGPLA) type LGPLA
      value(VP_UA) type LTAP-VLENR
      value(VP_MENGE) type EKPO-MENGE
      value(VP_MEINS) type EKPO-MEINS
    returning
      value(WP_RETURN) type BAPIRET2
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods ENVIO_ZONA_ROJA
    importing
      value(VP_WERKS) type WERKS_D
      value(VP_LGPLA) type LGPLA
      value(VP_UA) type LTAP-VLENR
    returning
      value(WP_RETURN) type BAPIRET2
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods VALIDAR_ENVIO_ZONA_ROJA
    importing
      value(VP_WERKS) type WERKS_D
      value(VP_UA) type LTAP-VLENR
    returning
      value(WP_UA) type ZWM_NT_UI5_S_UNIDADES_ALMACEN
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .

  methods /IWBEP/IF_MGW_APPL_SRV_RUNTIME~EXECUTE_ACTION
    redefinition .
  methods /IWBEP/IF_MGW_APPL_SRV_RUNTIME~GET_STREAM
    redefinition .
protected section.

  methods MATERIALES_GETLIST_EXT
    changing
      value(TP_MATERIALES) type ZWM_NT_UI5_T_MATERIALES
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_CAB_GETLIST_EXT
    changing
      value(TP_PARTE_REBOB_CAB) type ZWM_NT_UI5_T_PARTE_REBOB_CAB
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods PARTE_REBOB_BOBPROD_GETLIST_EX
    changing
      value(TP_PARTE_REBOB_BOB_PROD) type ZWM_NT_UI5_T_PARTE_REBOB_BOB_P
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods UBICACIONES_GETLIST_EXT
    changing
      !TP_UBICACION type ZWM_NT_UI5_UBICACIONES_TAB
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods UNIDADES_ALMACEN_GETLIST_EXT
    importing
      !IO_TECH_REQUEST_CONTEXT type ref to /IWBEP/IF_MGW_REQ_ENTITYSET optional
    changing
      value(TP_UNIDADES_ALMAC) type ZWM_NT_UI5_T_UNIDADES_ALMACEN
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods VALIDAR_PARTE_REBOB_BOB_PROD
    importing
      !WP_PARTE_REBOB_BOB_PROD type ZWM_NT_UI5_S_PARTE_REBOB_BOB_P
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods VALIDAR_PARTE_REBOB_CAB
    importing
      !WP_PARTE_REBOB_CAB type ZWM_NT_UI5_S_PARTE_REBOB_CAB
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods EXECUTE_ACTION_MOVE_BOBINE
    importing
      !IV_ACTION_NAME type STRING optional
      !IT_PARAMETER type /IWBEP/T_MGW_NAME_VALUE_PAIR optional
      !IO_TECH_REQUEST_CONTEXT type ref to /IWBEP/IF_MGW_REQ_FUNC_IMPORT optional
    exporting
      !ER_DATA type ref to DATA
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION
      /IWBEP/CX_MGW_TECH_EXCEPTION .
  methods EXECUTE_ACTION_GET_BOB_4_MATNR
    importing
      !IV_ACTION_NAME type STRING optional
      !IT_PARAMETER type /IWBEP/T_MGW_NAME_VALUE_PAIR optional
      !IO_TECH_REQUEST_CONTEXT type ref to /IWBEP/IF_MGW_REQ_FUNC_IMPORT optional
    exporting
      !ER_DATA type ref to DATA
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION
      /IWBEP/CX_MGW_TECH_EXCEPTION .
  methods TRATAR_KEY_ENTITYSET
    importing
      !IO_TECH_REQUEST_CONTEXT type ref to /IWBEP/IF_MGW_REQ_ENTITYSET optional
    exporting
      !WP_ENTITY type DATA
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods TRATAR_KEY_ENTITY
    importing
      !IO_TECH_REQUEST_CONTEXT type ref to /IWBEP/IF_MGW_REQ_ENTITY optional
    exporting
      !WP_ENTITY type DATA
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .

  methods APROVIDSET_GET_ENTITY
    redefinition .
  methods APROVIDSET_GET_ENTITYSET
    redefinition .
  methods BOBINEIDSET_GET_ENTITY
    redefinition .
  methods BOBINEIDSET_GET_ENTITYSET
    redefinition .
  methods BOBINEIDSET_UPDATE_ENTITY
    redefinition .
  methods CENTROSSET_GET_ENTITY
    redefinition .
  methods CLIENTES_GET_ENTITYSET
    redefinition .
  methods GRUPOSMAQUINAS_GET_ENTITY
    redefinition .
  methods MAQUINASSET_GET_ENTITY
    redefinition .
  methods MAQUINASSET_GET_ENTITYSET
    redefinition .
  methods MATERIALES_GET_ENTITY
    redefinition .
  methods MATERIALES_GET_ENTITYSET
    redefinition .
  methods PARTESREBOBBOB01_CREATE_ENTITY
    redefinition .
  methods PARTESREBOBBOB01_DELETE_ENTITY
    redefinition .
  methods PARTESREBOBBOB01_GET_ENTITY
    redefinition .
  methods PARTESREBOBBOB01_GET_ENTITYSET
    redefinition .
  methods PARTESREBOBBOB01_UPDATE_ENTITY
    redefinition .
  methods PARTESREBOBBOBCO_CREATE_ENTITY
    redefinition .
  methods PARTESREBOBBOBCO_DELETE_ENTITY
    redefinition .
  methods PARTESREBOBBOBCO_GET_ENTITY
    redefinition .
  methods PARTESREBOBBOBCO_GET_ENTITYSET
    redefinition .
  methods PARTESREBOBBOBCO_UPDATE_ENTITY
    redefinition .
  methods PARTESREBOBCAB_CREATE_ENTITY
    redefinition .
  methods PARTESREBOBCAB_DELETE_ENTITY
    redefinition .
  methods PARTESREBOBCAB_GET_ENTITY
    redefinition .
  methods PARTESREBOBCAB_GET_ENTITYSET
    redefinition .
  methods PARTESREBOBCAB_UPDATE_ENTITY
    redefinition .
  methods TVARVCSET_GET_ENTITY
    redefinition .
  methods TVARVCSET_GET_ENTITYSET
    redefinition .
  methods UBICACIONESSET_GET_ENTITY
    redefinition .
  methods UBICACIONESSET_GET_ENTITYSET
    redefinition .
  methods UNIDADESALMACEN_GET_ENTITY
    redefinition .
  methods UNIDADESALMACEN_GET_ENTITYSET
    redefinition .
private section.
endclass. "ZCL_ZUI5_WM_NT_DPC_EXT definition
class ZCL_ZUI5_WM_NT_DPC_EXT implementation.
  METHOD  /iwbep/if_mgw_appl_srv_runtime~execute_action.

    CASE iv_action_name.
      WHEN gc_action_move_bobine.
        me->execute_action_move_bobine(
          EXPORTING
            iv_action_name               = iv_action_name
            it_parameter                 = it_parameter
            io_tech_request_context      = io_tech_request_context
          IMPORTING
            er_data                      = er_data
        ).
      WHEN gc_action_get_bobine_for_matnr.
        me->execute_action_get_bob_4_matnr(
          EXPORTING
            iv_action_name               = iv_action_name
            it_parameter                 = it_parameter
            io_tech_request_context      = io_tech_request_context
          IMPORTING
            er_data                      = er_data
        ).
      WHEN gc_action_ubicacion_prop_ua.

        DATA: BEGIN OF wl_params_get_ubic_prop_ua,
                werks     TYPE werks_d,
                iv_bobine TYPE lenum,
              END OF wl_params_get_ubic_prop_ua.
        zcl_seis_odata_utils=>tratar_key( EXPORTING tp_key = it_parameter IMPORTING wp_return = wl_params_get_ubic_prop_ua ).

        wl_params_get_ubic_prop_ua-werks =  zcl_wm_nt_generic=>read_http_header_val( iv_name   = zcl_wm_nt_generic=>gc_http_head_werks
                                                                                     iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) ) ).
        CALL FUNCTION 'CONVERSION_EXIT_LENUM_INPUT'
          EXPORTING
            input           = wl_params_get_ubic_prop_ua-iv_bobine
          IMPORTING
            output          = wl_params_get_ubic_prop_ua-iv_bobine
          EXCEPTIONS
            check_failed    = 1
            not_numeric     = 2
            t344_get_failed = 3
            wrong_length    = 4
            OTHERS          = 5.


        copy_data_to_ref(
          EXPORTING is_data = zcl_wm_nt_generic=>get_ubicacion_prop_ua( vp_werks = wl_params_get_ubic_prop_ua-werks
                                                                        vp_lenum = wl_params_get_ubic_prop_ua-iv_bobine )
          CHANGING  cr_data = er_data ).


      WHEN 'getDatosReubicarResto'.

        DATA: BEGIN OF wl_params_get_datos_reub_resto,
                werks       TYPE werks_d,
                machine_id  TYPE lgpla,
                bobine TYPE lenum,
              END OF wl_params_get_datos_reub_resto.
        zcl_seis_odata_utils=>tratar_key( EXPORTING tp_key = it_parameter
                                          IMPORTING wp_return = wl_params_get_datos_reub_resto ).

        wl_params_get_datos_reub_resto-werks = zcl_wm_nt_generic=>read_http_header_val( iv_name   = zcl_wm_nt_generic=>gc_http_head_werks
                                                                                        iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) ) ).
        wl_params_get_datos_reub_resto-machine_id = zcl_wm_nt_generic=>read_http_header_val( iv_name   = zcl_wm_nt_generic=>gc_http_head_machine_id
                                                                                             iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) ) ).



        CALL FUNCTION 'CONVERSION_EXIT_LENUM_INPUT'
          EXPORTING
            input           = wl_params_get_datos_reub_resto-bobine
          IMPORTING
            output          = wl_params_get_datos_reub_resto-bobine
          EXCEPTIONS
            check_failed    = 1
            not_numeric     = 2
            t344_get_failed = 3
            wrong_length    = 4
            OTHERS          = 5.


        copy_data_to_ref( EXPORTING is_data = get_datos_reubicar_resto( vp_werks = wl_params_get_datos_reub_resto-werks
                                                                        vp_lgpla = wl_params_get_datos_reub_resto-machine_id
                                                                        vp_lenum = wl_params_get_datos_reub_resto-bobine )
                          CHANGING  cr_data = er_data ).



      WHEN 'validarLecturaUA'.
        DATA: BEGIN OF wl_validar_lectura_ua_params,
                werks         TYPE werks_d,
                iv_benum      TYPE ltbk-benum,
                iv_bobine     TYPE lenum,
                iv_dest_nlpla TYPE ltbk-nlpla,
                iv_tbnum      TYPE ltbk-tbnum,
              END OF wl_validar_lectura_ua_params.
        io_tech_request_context->get_converted_parameters( IMPORTING es_parameter_values = wl_validar_lectura_ua_params ).
        wl_validar_lectura_ua_params-werks =  zcl_wm_nt_generic=>read_http_header_val( iv_name   = zcl_wm_nt_generic=>gc_http_head_werks
                                                                                       iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) ) ).


        CALL FUNCTION 'CONVERSION_EXIT_LENUM_INPUT'
          EXPORTING
            input           = wl_validar_lectura_ua_params-iv_bobine
          IMPORTING
            output          = wl_validar_lectura_ua_params-iv_bobine
          EXCEPTIONS
            check_failed    = 1
            not_numeric     = 2
            t344_get_failed = 3
            wrong_length    = 4
            OTHERS          = 5.



        copy_data_to_ref(
          EXPORTING is_data = validar_lectura_ua( vp_werks = wl_validar_lectura_ua_params-werks
                                                  vp_lenum = wl_validar_lectura_ua_params-iv_bobine
                                                  vp_benum = wl_validar_lectura_ua_params-iv_benum
                                                  vp_nlpla = wl_validar_lectura_ua_params-iv_dest_nlpla
                                                  vp_tbnum = wl_validar_lectura_ua_params-iv_tbnum )
          CHANGING  cr_data = er_data ).



      WHEN 'validarRegularizarUA'.
        DATA: BEGIN OF wl_params_validar_regul_ua,
                ua    TYPE ltap-vlenr,
                werks TYPE werks_d,
                lgpla TYPE lgpla,
              END OF wl_params_validar_regul_ua.
        io_tech_request_context->get_converted_parameters( IMPORTING es_parameter_values = wl_params_validar_regul_ua ).
        CALL FUNCTION 'CONVERSION_EXIT_LENUM_INPUT'
          EXPORTING
            input           = wl_params_validar_regul_ua-ua
          IMPORTING
            output          = wl_params_validar_regul_ua-ua
          EXCEPTIONS
            check_failed    = 1
            not_numeric     = 2
            t344_get_failed = 3
            wrong_length    = 4
            OTHERS          = 5.

        copy_data_to_ref( EXPORTING is_data = validar_regularizar_ua(  vp_werks = wl_params_validar_regul_ua-werks
                                                                       vp_lgpla = wl_params_validar_regul_ua-lgpla
                                                                       vp_ua = wl_params_validar_regul_ua-ua )
                          CHANGING  cr_data = er_data ).


      WHEN 'regularizarUA'.
        DATA: BEGIN OF wl_params_regularizar_ua,
                werks TYPE werks_d,
                lgpla TYPE lgpla,
                ua    TYPE ltap-vlenr,
                menge TYPE ekpo-menge,
                meins TYPE ekpo-meins,
              END OF wl_params_regularizar_ua.
        io_tech_request_context->get_converted_parameters( IMPORTING es_parameter_values = wl_params_regularizar_ua ).

        CALL FUNCTION 'CONVERSION_EXIT_LENUM_INPUT'
          EXPORTING
            input           = wl_params_regularizar_ua-ua
          IMPORTING
            output          = wl_params_regularizar_ua-ua
          EXCEPTIONS
            check_failed    = 1
            not_numeric     = 2
            t344_get_failed = 3
            wrong_length    = 4
            OTHERS          = 5.

        copy_data_to_ref( EXPORTING is_data = regularizar_ua( vp_werks  = wl_params_regularizar_ua-werks
                                                              vp_lgpla  = wl_params_regularizar_ua-lgpla
                                                              vp_ua     = wl_params_regularizar_ua-ua
                                                              vp_menge  = wl_params_regularizar_ua-menge
                                                              vp_meins  = wl_params_regularizar_ua-meins )
                          CHANGING  cr_data = er_data ).


      WHEN 'imprimirUA'.
        DATA: BEGIN OF wl_params_imprimir_ua,
                werks TYPE werks_d,
                lgpla TYPE lgpla,
                ua    TYPE ltap-vlenr,
              END OF wl_params_imprimir_ua.
        io_tech_request_context->get_converted_parameters( IMPORTING es_parameter_values = wl_params_imprimir_ua ).

        CALL FUNCTION 'CONVERSION_EXIT_LENUM_INPUT'
          EXPORTING
            input           = wl_params_imprimir_ua-ua
          IMPORTING
            output          = wl_params_imprimir_ua-ua
          EXCEPTIONS
            check_failed    = 1
            not_numeric     = 2
            t344_get_failed = 3
            wrong_length    = 4
            OTHERS          = 5.

        copy_data_to_ref( EXPORTING is_data = imprimir_ua( vp_werks  = wl_params_imprimir_ua-werks
                                                           vp_lgpla  = wl_params_imprimir_ua-lgpla
                                                           vp_ua     = wl_params_imprimir_ua-ua )
                          CHANGING  cr_data = er_data ).


      WHEN 'parteRebobGenerarNecesidades'.
        DATA: BEGIN OF wl_params_parterebob_gen_nec,
                werks           TYPE ZWM_NT_UI5_S_PARTE_REBOB_CAB-werks,
                id_maquina      TYPE ZWM_NT_UI5_S_PARTE_REBOB_CAB-id_maquina,
                cod_parte_rebob TYPE ZWM_NT_UI5_S_PARTE_REBOB_CAB-cod_parte_rebob,
              END OF wl_params_parterebob_gen_nec.
        io_tech_request_context->get_converted_parameters( IMPORTING es_parameter_values = wl_params_parterebob_gen_nec ).

        copy_data_to_ref( EXPORTING is_data = parte_rebob_generar_nec( vp_werks           = wl_params_parterebob_gen_nec-werks
                                                                       vp_id_maquina      = wl_params_parterebob_gen_nec-id_maquina
                                                                       vp_cod_parte_rebob = wl_params_parterebob_gen_nec-cod_parte_rebob )
                          CHANGING  cr_data = er_data ).

      WHEN 'parteRebobValidGenerarNec'.
        io_tech_request_context->get_converted_parameters( IMPORTING es_parameter_values = wl_params_parterebob_gen_nec ).

        copy_data_to_ref( EXPORTING is_data = parte_rebob_valid_generar_nec( vp_werks           = wl_params_parterebob_gen_nec-werks
                                                                             vp_id_maquina      = wl_params_parterebob_gen_nec-id_maquina
                                                                             vp_cod_parte_rebob = wl_params_parterebob_gen_nec-cod_parte_rebob )
                          CHANGING  cr_data = er_data ).

      WHEN 'parteRebobAnularNecesidades'.
        io_tech_request_context->get_converted_parameters( IMPORTING es_parameter_values = wl_params_parterebob_gen_nec ).
        copy_data_to_ref( EXPORTING is_data = parte_rebob_anular_nec( vp_werks           = wl_params_parterebob_gen_nec-werks
                                                                      vp_id_maquina      = wl_params_parterebob_gen_nec-id_maquina
                                                                      vp_cod_parte_rebob = wl_params_parterebob_gen_nec-cod_parte_rebob )
                          CHANGING  cr_data = er_data ).
      WHEN 'parteRebobCerrarParte'.
        io_tech_request_context->get_converted_parameters( IMPORTING es_parameter_values = wl_params_parterebob_gen_nec ).
        copy_data_to_ref( EXPORTING is_data = parte_rebob_cerrar_parte( vp_werks           = wl_params_parterebob_gen_nec-werks
                                                                        vp_id_maquina      = wl_params_parterebob_gen_nec-id_maquina
                                                                        vp_cod_parte_rebob = wl_params_parterebob_gen_nec-cod_parte_rebob )
                          CHANGING  cr_data = er_data ).
      WHEN 'parteRebobReabrirParte'.
        io_tech_request_context->get_converted_parameters( IMPORTING es_parameter_values = wl_params_parterebob_gen_nec ).
        copy_data_to_ref( EXPORTING is_data = parte_rebob_reabrir_parte( vp_werks           = wl_params_parterebob_gen_nec-werks
                                                                         vp_id_maquina      = wl_params_parterebob_gen_nec-id_maquina
                                                                         vp_cod_parte_rebob = wl_params_parterebob_gen_nec-cod_parte_rebob )
                          CHANGING  cr_data = er_data ).

      WHEN 'validarEnvioZonaRoja'.
        DATA: BEGIN OF wl_params_val_envio_zona_roja,
                werks TYPE werks_d,
                ua    TYPE ltap-vlenr,
              END OF wl_params_val_envio_zona_roja.
        io_tech_request_context->get_converted_parameters( IMPORTING es_parameter_values = wl_params_val_envio_zona_roja ).

        CALL FUNCTION 'CONVERSION_EXIT_LENUM_INPUT'
          EXPORTING
            input           = wl_params_val_envio_zona_roja-ua
          IMPORTING
            output          = wl_params_val_envio_zona_roja-ua
          EXCEPTIONS
            check_failed    = 1
            not_numeric     = 2
            t344_get_failed = 3
            wrong_length    = 4
            OTHERS          = 5.

        copy_data_to_ref( EXPORTING is_data = validar_envio_zona_roja(  vp_werks  = wl_params_val_envio_zona_roja-werks
                                                                        vp_ua     = wl_params_val_envio_zona_roja-ua )
                          CHANGING  cr_data = er_data ).


      WHEN 'envioZonaRoja'.
        DATA: BEGIN OF wl_params_envio_zona_roja,
                werks TYPE werks_d,
                lgpla TYPE lgpla,
                ua    TYPE ltap-vlenr,
              END OF wl_params_envio_zona_roja.
        io_tech_request_context->get_converted_parameters( IMPORTING es_parameter_values = wl_params_envio_zona_roja ).

        CALL FUNCTION 'CONVERSION_EXIT_LENUM_INPUT'
          EXPORTING
            input           = wl_params_envio_zona_roja-ua
          IMPORTING
            output          = wl_params_envio_zona_roja-ua
          EXCEPTIONS
            check_failed    = 1
            not_numeric     = 2
            t344_get_failed = 3
            wrong_length    = 4
            OTHERS          = 5.

        copy_data_to_ref( EXPORTING is_data = envio_zona_roja(  vp_werks  = wl_params_envio_zona_roja-werks
                                                                vp_lgpla  = wl_params_envio_zona_roja-lgpla
                                                                vp_ua     = wl_params_envio_zona_roja-ua )
                          CHANGING  cr_data = er_data ).



      WHEN OTHERS.
        RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
          EXPORTING
            textid = /iwbep/cx_mgw_not_impl_exc=>method_not_implemented
            action = iv_action_name.
    ENDCASE.
  ENDMETHOD.
  METHOD /iwbep/if_mgw_appl_srv_runtime~get_stream.
    DATA: wl_stream  TYPE ty_s_media_resource.
    DATA: wl_header  TYPE ihttpnvp.


    CASE io_tech_request_context->get_entity_type_name( ).
      WHEN 'CentrosLogo'.
        DATA: wl_centros_logo TYPE zui5_wm_s_centros_logo.
        io_tech_request_context->get_converted_keys( IMPORTING es_key_values = wl_centros_logo ).
        IF wl_centros_logo IS INITIAL.
          io_tech_request_context->get_converted_source_keys( IMPORTING es_key_values = wl_centros_logo ).
        ENDIF.


        wl_stream-value = get_centros_logo( wl_centros_logo-werks ).
        wl_stream-mime_type = 'image/jpeg'.

        wl_header-name  = 'content-disposition'.
        wl_header-value = |inline; filename=logo.jpg|.

    ENDCASE.

    copy_data_to_ref( EXPORTING is_data = wl_stream
                      CHANGING  cr_data = er_stream ).


    IF wl_header IS NOT INITIAL.
      /iwbep/if_mgw_conv_srv_runtime~set_header( wl_header ).
    ENDIF.
  ENDMETHOD.
  METHOD aprovidset_get_entity.
    TRY.
        DATA(lv_werks) =  zcl_wm_nt_generic=>read_http_header_val( iv_name   = zcl_wm_nt_generic=>gc_http_head_werks
                                                                   iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) ) ).
        DATA(lv_machine_id) =  zcl_wm_nt_generic=>read_http_header_val( iv_name   = zcl_wm_nt_generic=>gc_http_head_machine_id
                                                                        iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) ) ).

        DATA(wl_centro) = zcl_wm_nt_generic=>get_instance( )->centros_getdetail( CONV #( lv_werks ) ).
        IF wl_centro-lista_apro_ui5_pp = space.
          DATA(lt_data) = zcl_wm_nt_generic=>get_instance( )->build_aprovis_list_ui5_v3( iv_lgnum       = zcl_wm_nt_generic=>get_lgnum( iv_werks = CONV #( lv_werks ) )
                                                                                         iv_machine_id  = CONV #( lv_machine_id )
                                                                                         iv_id          = CONV #( it_key_tab[ name = 'Id' ]-value ) ).
        ELSE.
          DATA(vl_lgpla) = CONV lgpla( lv_machine_id ).
          IF vl_lgpla IS INITIAL AND lv_werks  = '2001'.
            vl_lgpla = 'OND'.
          ENDIF.


          lt_data = lista_aprov_pp_getlist( vp_werks      = wl_centro-werks
                                            vp_lgpla      = vl_lgpla
                                            vp_id         = CONV #( it_key_tab[ name = 'Id' ]-value )
                                            vp_lista_apro = 'X' ).
        ENDIF.
      CATCH cx_root.
    ENDTRY.




    CHECK lines( lt_data ) > 0.
    er_entity = CORRESPONDING #( lt_data[ 1 ] ).
  ENDMETHOD.
  METHOD aprovidset_get_entityset.

    DATA(lv_werks) =  CONV werks_d( zcl_wm_nt_generic=>read_http_header_val(  iv_name   = zcl_wm_nt_generic=>gc_http_head_werks
                                                                iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) ) ) ).

    DATA(lv_machine_id) =  zcl_wm_nt_generic=>read_http_header_val( iv_name   = zcl_wm_nt_generic=>gc_http_head_machine_id
                                                                    iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) ) ).


    DATA(wl_centro) = zcl_wm_nt_generic=>get_instance( )->centros_getdetail( lv_werks ).


    IF wl_centro-lista_apro_ui5_pp = space.
      DATA(lt_data) = zcl_wm_nt_generic=>get_instance( )->build_aprovis_list_ui5_v3( iv_lgnum       = zcl_wm_nt_generic=>get_lgnum( iv_werks = lv_werks )
                                                                                     iv_machine_id  = CONV #( lv_machine_id ) ).
    ELSE.
      DATA(vl_lgpla) = CONV lgpla( lv_machine_id ).
      IF vl_lgpla IS INITIAL AND lv_werks  = '2001'.
        vl_lgpla = 'OND'.
      ENDIF.


      lt_data = lista_aprov_pp_getlist( vp_werks      = lv_werks
                                        vp_lgpla      = vl_lgpla
                                        vp_lista_apro = 'X'
                                        vp_margen_sel_ordenes = wl_centro-lista_apro_margen_sel_ordenes ).

    ENDIF.
    et_entityset = CORRESPONDING #( lt_data ).

    zcl_seis_odata_utils=>tratar_entityset( EXPORTING io_tech_request_context  = io_tech_request_context
                                            CHANGING  et_entityset             = et_entityset ).

  ENDMETHOD.
  METHOD bobineidset_get_entity.
    DATA(lv_lenum) = CONV lqua-lenum( it_key_tab[ name = 'Id' ]-value ).

    DATA(lv_werks) =  zcl_wm_nt_generic=>read_http_header_val(
    EXPORTING
      iv_name   = zcl_wm_nt_generic=>gc_http_head_werks
      iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) )
  ).

    CALL FUNCTION 'CONVERSION_EXIT_LENUM_INPUT'
      EXPORTING
        input           = lv_lenum    " External entry
      IMPORTING
        output          = lv_lenum    " Edited storage unit number for sto
      EXCEPTIONS
        check_failed    = 1
        not_numeric     = 2
        t344_get_failed = 3
        wrong_length    = 4
        OTHERS          = 5.

    SELECT SINGLE a~lenum, b~zzancho, b~zzlargo, b~matnr, b~meins,
  a~lgpla, a~verme
  FROM lqua AS a
  INNER JOIN mara AS b
  ON a~matnr = b~matnr
  INNER JOIN t320 AS c
  ON c~werks = a~werks
  AND c~lgort = a~lgort
  INTO @DATA(ls_lqua)
  "WHERE a~matnr IN @lr_matnr
  WHERE
   c~werks =  @lv_werks
  AND a~verme > 0
  AND a~lenum = @lv_lenum.
    "AND NOT EXISTS ( SELECT bobine FROM zwm_apl_bobine WHERE bobine = a~lenum ).

    CHECK sy-subrc = 0.
    er_entity = VALUE #(
            id = ls_lqua-lenum matnr = ls_lqua-matnr bobine = ls_lqua-lenum
              width = ls_lqua-zzancho length = ls_lqua-zzlargo meins = ls_lqua-meins
              substitute = COND #( WHEN ls_lqua-matnr = ls_lqua-matnr THEN abap_false ELSE abap_true ) ).
*    LOOP AT lt_lqua INTO DATA(ls_lqua).
*
**      IF ls_tbnum-menga < gc_tolerance.
**        EXIT.
**      ENDIF.
**      ls_tbnum-menga = ls_tbnum-menga - ls_lqua-verme.
*      APPEND VALUE #(
*            id = ls_lqua-lenum id_aprov_list = lv_id matnr = ls_lqua-matnr bobine = ls_lqua-lenum
*              width = ls_lqua-zzancho length = ls_lqua-zzlargo meins = ls_lqua-meins
*              substitute = COND #( WHEN ls_lqua-matnr = ls_tbnum-matnr THEN abap_false ELSE abap_true )
*
*      ) TO rt_data.
*    ENDLOOP.
*    TRY.
*        DATA(ls_data) = zcl_wm_zwm_apl_bobine_dao=>get_entry( iv_id = CONV #( it_key_tab[ name = 'Id' ]-value )  )->get_data( ).
*
*        er_entity = CORRESPONDING #( ls_data ).
*      CATCH zcx_wm_exception.    "
*    ENDTRY.

  ENDMETHOD.
  METHOD bobineidset_get_entityset.
*    RAISE EXCEPTION TYPE /iwbep/cx_mgw_not_impl_exc
*      EXPORTING
*        textid = /iwbep/cx_mgw_not_impl_exc=>method_not_implemented
*        method = 'BOBINEIDSET_GET_ENTITYSET'.
*
*    " discontinued

    DATA(lv_matnr) =  zcl_wm_nt_generic=>read_http_header_val(
    EXPORTING
      iv_name   = zcl_wm_nt_generic=>gc_http_head_matnr
      iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) )
  ).

    DATA(lv_nlpla_id) =  zcl_wm_nt_generic=>read_http_header_val(
      EXPORTING
        iv_name   = zcl_wm_nt_generic=>gc_http_head_nlplaid
        iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) )
    ).

    DATA(lv_werks) =  zcl_wm_nt_generic=>read_http_header_val(
      EXPORTING
        iv_name   = zcl_wm_nt_generic=>gc_http_head_werks
        iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) )
    ).
    DATA(lv_lgnum) = zcl_wm_nt_generic=>get_lgnum( iv_werks = CONV #( lv_werks ) ).


    DATA(lv_machine_id) =  zcl_wm_nt_generic=>read_http_header_val( iv_name   = zcl_wm_nt_generic=>gc_http_head_machine_id
                                                                    iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) ) ).


    IF line_exists( it_navigation_path[ nav_prop = 'BOBINEIDSet' ] )
    AND lines( it_key_tab ) > 0.
      " access via navigation prop
      DATA(lv_idaprovid) =  it_key_tab[ 1 ]-value.
    ENDIF.

    DATA(lt_data) = zcl_wm_nt_generic=>get_instance(
*                    iv_langu = SY-LANGU
                )->build_alist_bobine_ui5_v3(
                                        iv_lgnum          = lv_lgnum
                                        iv_machine_id     = CONV #( lv_machine_id )
                                        iv_id_aprov_list  = CONV #( lv_idaprovid )
                ).



    et_entityset = CORRESPONDING #( lt_data ).

    zcl_seis_odata_utils=>tratar_entityset( EXPORTING io_tech_request_context  =  io_tech_request_context
                                            CHANGING  et_entityset             =  et_entityset  ).

  ENDMETHOD.
  METHOD bobineidset_update_entity.

    DATA ls_data TYPE zcl_zui5_wm_nt_mpc=>ts_bobineid.
    io_data_provider->read_entry_data( IMPORTING es_data = ls_data ).
    IF ls_data-id_aprov_list IS INITIAL.
      ls_data-id_aprov_list = it_key_tab[ name = 'IdAprovList' ]-value.
    ENDIF.

    IF ls_data-estacion IS INITIAL.
      ls_data-estacion = it_key_tab[ name = 'Estacion' ]-value.
    ENDIF.
*    DATA(lv_nlpla_id) =  zcl_wm_nt_generic=>read_http_header_val(
*EXPORTING
*  iv_name   = zcl_wm_nt_generic=>gc_http_head_nlplaid
*  iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) )
*).
*    ls_data-estacion = 'EST' && lv_nlpla_id.

    TRY.
        TRY.
            DATA(lr_entry) = zcl_wm_zwm_apl_bobine_dao=>get_entry( iv_id = ls_data-id iv_id_aprov_list = ls_data-id_aprov_list iv_estacion = ls_data-estacion ).
          CATCH cx_root.
            lr_entry = zcl_wm_zwm_apl_bobine_dao=>create_entry( is_data = CORRESPONDING #( ls_data ) ).

        ENDTRY.
        lr_entry->update_values( is_data = CORRESPONDING #( ls_data ) ).
        lr_entry->save_data( ).
      CATCH cx_root.
    ENDTRY.
  ENDMETHOD.
  METHOD centrosset_get_entity.
*    DATA(vl_werks) =  zcl_wm_nt_generic=>read_http_header_val( iv_name   = zcl_wm_nt_generic=>gc_http_head_werks
*                                                               iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) ) ).

    tratar_key_entity( EXPORTING io_tech_request_context = io_tech_request_context
                       IMPORTING wp_entity               = er_entity ).

    er_entity = zcl_wm_nt_generic=>get_instance( )->centros_getdetail( er_entity-werks ).



  ENDMETHOD.
  METHOD clientes_get_entityset.

    DATA(vl_werks) =  zcl_wm_nt_generic=>read_http_header_val( iv_name   = zcl_wm_nt_generic=>gc_http_head_werks
                                                               iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) ) ).
    DATA(vl_lgnum) = zcl_wm_nt_generic=>get_lgnum( iv_werks = CONV #( vl_werks ) ).

    DATA wl_entity LIKE LINE OF et_entityset.
    tratar_key_entityset( EXPORTING io_tech_request_context = io_tech_request_context
                          IMPORTING wp_entity               = wl_entity ).

    DATA(tl_filter_so) = io_tech_request_context->get_filter( )->get_filter_select_options( ).
    LOOP AT tl_filter_so ASSIGNING FIELD-SYMBOL(<fs_filter_so>).
      ASSIGN COMPONENT <fs_filter_so>-property OF STRUCTURE wl_entity TO FIELD-SYMBOL(<fs>).
      IF sy-subrc = 0.
        <fs> = <fs_filter_so>-select_options[ 1 ]-low.
      ENDIF.
    ENDLOOP.


    et_entityset = clientes_getlist( vp_rsnum = wl_entity-rsnum
                                     vp_lgnum = vl_lgnum ).



    zcl_seis_odata_utils=>tratar_entityset( EXPORTING io_tech_request_context = io_tech_request_context
                                            CHANGING et_entityset             = et_entityset ).

  ENDMETHOD.
  METHOD clientes_getlist.

    DATA(tl_lista_apro) = zcl_wm_nt_generic=>get_instance( )->get_aprovis_list( iv_lgnum    = vp_lgnum
                                                                                iv_rsnum    = vp_rsnum
                                                                                iv_all_stat = abap_false ).
    CHECK tl_lista_apro IS NOT INITIAL.

    SELECT lgnum, tbnum, cliente, cliente2
      INTO TABLE @DATA(tl_zwm_ltbk_adit)
      FROM zwm_ltbk_adit
      FOR ALL ENTRIES IN @tl_lista_apro
      WHERE lgnum = @tl_lista_apro-lgnum AND
            tbnum = @tl_lista_apro-tbnum AND
            menge > 0.
    LOOP AT tl_zwm_ltbk_adit ASSIGNING FIELD-SYMBOL(<fs_zwm_ltbk_adit>).
      IF <fs_zwm_ltbk_adit>-cliente IS NOT INITIAL.
        APPEND INITIAL LINE TO tp_clientes ASSIGNING FIELD-SYMBOL(<fs_clientes>).
        <fs_clientes>-tbnum   = <fs_zwm_ltbk_adit>-tbnum.
        <fs_clientes>-cliente = <fs_zwm_ltbk_adit>-cliente.
      ENDIF.
      IF <FS_zwm_ltbk_adit>-cliente2 IS NOT INITIAL.
        APPEND INITIAL LINE TO tp_clientes ASSIGNING <fs_clientes>.
        <fs_clientes>-tbnum   = <fs_zwm_ltbk_adit>-tbnum.
        <fs_clientes>-cliente = <fs_zwm_ltbk_adit>-cliente2.
      ENDIF.
    ENDLOOP.

    SORT tp_clientes BY cliente.
    DELETE ADJACENT DUPLICATES FROM tp_clientes COMPARING cliente.

    LOOP AT tp_clientes ASSIGNING <fs_clientes>.
      <fs_clientes>-lgnum     = <fs_zwm_ltbk_adit>-lgnum.
      <fs_clientes>-rsnum     = vp_rsnum.
      <fs_clientes>-contador  = sy-tabix.
    ENDLOOP.

  ENDMETHOD.
  METHOD envio_zona_roja.
    "SAPMZ_WM_RF
    "12497554832703

    CONSTANTS: cg_bwlvs_999           TYPE bwlvs VALUE '999',
               cg_bwlvs_gestion_almac TYPE bwlvs VALUE '854'.


    DATA(wp_ua) = validar_envio_zona_roja( vp_werks = vp_werks
                                           vp_ua    = vp_ua ).

    DATA tl_rf_func TYPE TABLE OF zwm_rf_func.
    DATA(vl_where_rf_func) = |LG{ wp_ua-lgnum } = 'X'|.

    SELECT *
      INTO TABLE tl_rf_func
      FROM zwm_rf_func
      WHERE (vl_where_rf_func).

    SELECT SINGLE lgnum, lgber, lgtyp, lgpla
      INTO @DATA(wl_lagp)
      FROM lagp
      WHERE lgpla = @vp_lgpla AND
            lgnum = @wp_ua-lgnum.

    "*********************************
    "* CREATE_OT_SU
    "********************************
    DATA vl_tanum TYPE ltak-tanum.

    CALL FUNCTION 'HU_PACKING_REFRESH'.
    CALL FUNCTION 'L_TO_CREATE_MOVE_SU'
      EXPORTING
        i_lenum               = wp_ua-lenum
        i_bwlvs               = cg_bwlvs_999
        i_nltyp               = wl_lagp-lgtyp
        i_nlber               = wl_lagp-lgber
        i_nlpla               = wl_lagp-lgpla
        i_squit               = abap_true
        i_commit_work         = abap_true
      IMPORTING
        e_tanum               = vl_tanum
      EXCEPTIONS
        not_confirmed_to      = 1
        foreign_lock          = 2
        bwlvs_wrong           = 3
        betyp_wrong           = 4
        nltyp_wrong           = 5
        nlpla_wrong           = 6
        nltyp_missing         = 7
        nlpla_missing         = 8
        squit_forbidden       = 9
        lgber_wrong           = 10
        xfeld_wrong           = 11
        drukz_wrong           = 12
        ldest_wrong           = 13
        no_stock_on_su        = 14
        su_not_found          = 15
        update_without_commit = 16
        no_authority          = 17
        benum_required        = 18
        ltap_move_su_wrong    = 19
        lenum_wrong           = 20
        OTHERS                = 21.
    IF sy-subrc <> 0.
      IF sy-subrc = 2.
        CALL FUNCTION 'L_BIN_LOCATION_DEQUEUE'
          EXPORTING
            i_lgnum = wl_lagp-lgnum
            i_lgtyp = wl_lagp-lgtyp
            i_lgpla = wl_lagp-lgpla
            i_lenum = wp_ua-lenum.
      ENDIF.

      zcl_seis_odata_utils=>lanzar_excepcion( ).
    ENDIF.

    READ TABLE tl_rf_func TRANSPORTING NO FIELDS WITH KEY func = 'TRASPASO_BLOQUEADO_SEGUNDAS'.
    IF sy-subrc = 0.
      zcl_wm_gestion_stocks=>create_transf_stock(
        EXPORTING
           iv_lgnum            = wp_ua-lgnum
           iv_lgtyp            = wl_lagp-lgtyp
           iv_bwlvs            = cg_bwlvs_gestion_almac
           iv_lenum            = wp_ua-lenum
        EXCEPTIONS
           no_authority        = 1
           no_enqueue_possible = 2
           error_wm_posting    = 3
           error_im_posting    = 4
           OTHERS  = 5 ).
      IF sy-subrc <> 0.
        zcl_seis_odata_utils=>lanzar_excepcion( ).
      ENDIF.
    ENDIF.
  ENDMETHOD.
  METHOD execute_action_get_bob_4_matnr.
    DATA lt_ret TYPE zcl_zui5_wm_nt_mpc=>tt_bobineid.

    IF lines( it_parameter ) < 2.
      RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
        EXPORTING
          textid = /iwbep/cx_mgw_not_impl_exc=>wrong_data_container
          action = iv_action_name.
    ENDIF.

    DATA(lv_werks) =  zcl_wm_nt_generic=>read_http_header_val(
    EXPORTING
      iv_name   = zcl_wm_nt_generic=>gc_http_head_werks
      iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) )
  ).


    DATA(lv_lgnum) = zcl_wm_nt_generic=>get_lgnum(
                       iv_werks = CONV #( lv_werks )
*                       iv_lgort =
                   ).

    TRY.
        DATA(lv_id) = it_parameter[ name = 'Id' ]-value .
        DATA(lv_matnr) =  it_parameter[ name = 'Matnr' ]-value .
        DATA(lv_nlplaid) =  it_parameter[ name = 'NlplaId' ]-value .


        lt_ret = zcl_wm_nt_generic=>get_instance(
*                    iv_langu = SY-LANGU
            )->build_alist_bobine_ui5_v2(
                iv_lgnum         = lv_lgnum
                iv_matnr         = CONV #( lv_matnr )
                iv_id_aprov_list = CONV #( lv_id )
                iv_nlpla_nr      = CONV #( lv_nlplaid )
            ).

        me->copy_data_to_ref(
EXPORTING
is_data = lt_ret
CHANGING
cr_data = er_data
).

      CATCH cx_root.
        RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
          EXPORTING
            textid = /iwbep/cx_mgw_tech_exception=>key_structure_error
            action = iv_action_name.

    ENDTRY.






  ENDMETHOD.
  METHOD execute_action_move_bobine.

    DATA ls_bapiret2 TYPE bapiret2.

    IF lines( it_parameter ) < 2.
      RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
        EXPORTING
          textid = /iwbep/cx_mgw_not_impl_exc=>wrong_data_container
          action = iv_action_name.
    ENDIF.

    DATA(lv_werks) =  zcl_wm_nt_generic=>read_http_header_val(  iv_name   = zcl_wm_nt_generic=>gc_http_head_werks
                                                                iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) ) ).
    DATA(lv_machine_id) =  zcl_wm_nt_generic=>read_http_header_val(  iv_name   = zcl_wm_nt_generic=>gc_http_head_machine_id
                                                                iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) ) ).

    DATA(lv_lgnum) = zcl_wm_nt_generic=>get_lgnum( iv_werks = CONV #( lv_werks ) ).

    DATA(wl_centro) = zcl_wm_nt_generic=>get_instance( )->centros_getdetail( CONV #( lv_werks ) ).


    DATA: BEGIN OF wl_parametros,
            iv_bobine     TYPE lqua-lenum,
            iv_dest_nlpla TYPE ltbk-nlpla,
            iv_tbnum      TYPE ltbk-tbnum,
            iv_tipo       TYPE zwm_movebobine_tipo,
            iv_benum      TYPE ltbk-benum,
          END OF wl_parametros.
    io_tech_request_context->get_converted_parameters( IMPORTING es_parameter_values = wl_parametros ).

    CALL FUNCTION 'CONVERSION_EXIT_LENUM_INPUT'
      EXPORTING
        input           = wl_parametros-iv_bobine
      IMPORTING
        output          = wl_parametros-iv_bobine
      EXCEPTIONS
        check_failed    = 1
        not_numeric     = 2
        t344_get_failed = 3
        wrong_length    = 4
        OTHERS          = 5.

    "JCB Parte rebobinado: Si se anula, estn las dos necesidades de transporte, pero la segunda marcada como 'E'
    "Esta comprobacin encuentra la primera, por ahora voy a buscar con status <> E slo para partes rebobinado.
    "Pendiente saber si se puede extender al resto
    DATA tl_statu_rg TYPE RANGE OF ltbk-statu.
    TRY.
        DATA(wl_maquina) = zcl_wm_nt_generic=>get_instance( )->maquinas_getdetail( CONV #( lv_machine_id ) ).
        IF wl_maquina-parte_rebobinado = 'X'.
          tl_statu_rg = VALUE #( ( sign = 'I' option = 'NE' low = 'E' ) ).
        ENDIF.
      CATCH /iwbep/cx_mgw_busi_exception.
    ENDTRY.

    IF wl_centro-lista_apro_ui5_pp = space.
      SELECT SINGLE tbnum FROM ltbk " cvivo - veriricamos si se ha borrado
        WHERE nlpla EQ @wl_parametros-iv_dest_nlpla
         AND benum EQ @wl_parametros-iv_benum
         AND lgnum EQ @lv_lgnum
         AND statu IN @tl_statu_rg
        INTO @DATA(new_tbnum).

      IF new_tbnum NE wl_parametros-iv_tbnum. " la NT ha cambiado desde que se ha cargado la pantalla
        wl_parametros-iv_tbnum = new_tbnum.
      ENDIF.
    ENDIF.

    SELECT SINGLE werks, lenum, matnr, benum
      FROM lqua
      INTO @DATA(wl_lqua)
      WHERE lgnum = @lv_lgnum AND
            lenum = @wl_parametros-iv_bobine.
    IF sy-subrc <> 0.
      "Verificar si ha existido en algn momento
      SELECT SINGLE lgnum, tanum, tapos
        INTO @DATA(wl_ltap)
        FROM ltap
        WHERE vlenr = @wl_parametros-iv_bobine.
      IF sy-subrc = 0.
        zcl_seis_odata_utils=>lanzar_excepcion( 'La UA introducida se encuentra consumida totalmente en el sistema./nSolicite al operario de mquina que la regularice'(003) ).
      ELSE.
        zcl_seis_odata_utils=>lanzar_excepcion( 'La UA introducida no existe en el sistema./nVerifique que ha ledo el cdigo de barras correcto'(004) ).
      ENDIF.
    ENDIF.


    "Verificar si ya la hemos leido para esta reserva
    IF wl_centro-lectura_bobinas_propuestas = 'X' AND
       wl_parametros-iv_tipo                = zcl_wm_nt_generic=>gc_tipo_mov_bobina_orden_trans.
      SELECT SINGLE rsnum
        INTO @DATA(vl_rsnum)
        FROM ltbk
        WHERE lgnum = @lv_lgnum AND
              tbnum = @wl_parametros-iv_tbnum.
      IF vl_rsnum IS NOT INITIAL.
        SELECT SINGLE ltap~lgnum, ltap~tanum, ltap~tapos
          INTO @wl_ltap
          FROM ltap INNER JOIN ltak ON  ltak~lgnum = ltap~lgnum AND
                                        ltak~tanum = ltap~tanum
                    INNER JOIN ltbk ON  ltak~benum = ltbk~benum AND
                                        ltak~lgnum = ltbk~lgnum AND
                                        ltap~nlpla = ltbk~nlpla
                LEFT OUTER JOIN zwm_ltak_adit ON zwm_ltak_adit~tanum EQ ltak~tanum
                                              AND zwm_ltak_adit~lgnum EQ ltak~lgnum " cvivo -65087- no tener en cuenta si est retrocedida
          WHERE ltak~lgnum = @lv_lgnum AND
                ltbk~rsnum = @vl_rsnum AND
                ltap~vlenr = @wl_parametros-iv_bobine AND
                ( zwm_ltak_adit~retro NE @abap_true OR
                  zwm_ltak_adit~retro IS NULL ).
        IF sy-subrc = 0.
          zcl_seis_odata_utils=>lanzar_excepcion( 'La UA introducida ya se ha ledo en esta estacin' ).
        ENDIF.

      ELSE.
        SELECT SINGLE ltap~lgnum, ltap~tanum, ltap~tapos
          INTO @wl_ltap
          FROM ltap INNER JOIN ltak ON  ltak~lgnum = ltap~lgnum AND
                                        ltak~tanum = ltap~tanum
                    INNER JOIN ltbk ON  ltak~benum = ltbk~benum AND
                                        ltak~lgnum = ltbk~lgnum AND
                                        ltap~nlpla = ltbk~nlpla
                LEFT OUTER JOIN zwm_ltak_adit ON zwm_ltak_adit~tanum EQ ltak~tanum
                                              AND zwm_ltak_adit~lgnum EQ ltak~lgnum " cvivo -65087- no tener en cuenta si est retrocedida
          WHERE ltak~lgnum = @lv_lgnum AND
                ltbk~benum = @wl_parametros-iv_benum  AND
                ltap~vlenr = @wl_parametros-iv_bobine AND
*                ltap~nlpla = @wl_parametros-iv_dest_nlpla AND    "TODO JCB 20.05.22 -- Me da la impresin que lo vamos a necesitar... pero no estoy seguro
                ( zwm_ltak_adit~retro NE @abap_true OR
                  zwm_ltak_adit~retro IS NULL ).
        IF sy-subrc = 0.
          zcl_seis_odata_utils=>lanzar_excepcion( 'La UA introducida ya se ha ledo en esta estacin' ).
        ENDIF.
      ENDIF.





    ENDIF.

*    SELECT ltap~lgnum, ltap~tanum, ltap~tapos, ltap~vlenr, ltap~nlpla, ltak~benum,
*           ltbk~rsnum, ltap~meins, ltap~nistm, ltap~matnr
*      FROM ltap INNER JOIN ltak ON  ltak~lgnum = ltap~lgnum AND
*                                    ltak~tanum = ltap~tanum
*                INNER JOIN ltbk ON  ltak~benum = ltbk~benum " ahora cogemos todas las necesidades para la reserva
*                                AND ltak~lgnum = ltbk~lgnum
*                                AND ltap~nlpla = ltbk~nlpla
*      FOR ALL ENTRIES IN @rt_data
*          WHERE ltak~lgnum = @iv_lgnum
*      AND ( ltbk~rsnum = @rt_data-nlpla1_rsnum OR
*            ltbk~rsnum = @rt_data-nlpla2_rsnum OR
*            ltbk~rsnum = @rt_data-nlpla3_rsnum OR
*            ltbk~rsnum = @rt_data-nlpla4_rsnum OR
*            ltbk~rsnum = @rt_data-nlpla5_rsnum )
*      AND ltbk~rsnum NE @space
*      INTO TABLE @DATA(tl_ltap).








    DATA(vl_bwlvs) = SWITCH #( wl_parametros-iv_tipo WHEN zcl_wm_nt_generic=>gc_tipo_mov_bobina_reubicar
                                                     THEN zcl_wm_nt_generic=>gc_move_type_998
                                                     ELSE zcl_wm_nt_generic=>gc_move_type_918 ).
    zcl_wm_nt_generic=>movebobine(
      EXPORTING
        iv_bobine           = wl_parametros-iv_bobine
        iv_dest_nlpla       = wl_parametros-iv_dest_nlpla
        iv_lgnum            = lv_lgnum
        iv_tbnum            = wl_parametros-iv_tbnum
        iv_bwlvs            = vl_bwlvs
        iv_tipo_mov_bobina  = wl_parametros-iv_tipo
      IMPORTING
        es_ltak       = DATA(ls_ltak)
        ev_subrc      = DATA(lv_subrc)
        ev_retro      = DATA(lv_retro)
    ).

    IF lv_subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( ).
    ENDIF.


*    IF ls_bapiret2 IS INITIAL.
*      ls_bapiret2-type = COND #( WHEN lv_subrc = 0 THEN 'S' ELSE 'E' ).
*      ls_bapiret2-message = ls_ltak-lgnum && '/' && ls_ltak-tanum.
*    ENDIF.

    DATA: wl_movebobine_out TYPE zwm_nt_ui5_movebobine_out_str.
    wl_movebobine_out-lenum = wl_parametros-iv_bobine.
    wl_movebobine_out-nlpla = wl_parametros-iv_dest_nlpla.
    wl_movebobine_out-tbnum = wl_parametros-iv_tbnum.
    wl_movebobine_out-tipo  = wl_parametros-iv_tipo.
    wl_movebobine_out-retro = lv_retro.
    wl_movebobine_out-benum   = wl_lqua-benum.

    IF wl_movebobine_out-benum IS NOT INITIAL.
      DATA wl_id TYPE zcl_wm_constants=>gty_aprovis_list.
      wl_id-lgnum = lv_lgnum.
      wl_id-benum = wl_movebobine_out-benum.
      wl_movebobine_out-aprovid = zcl_wm_nt_generic=>code_line_id( wl_id ).
    ENDIF.

    "JCB 07.02.22. Tratamiento partes rebobinado, si se aprovisiona una UA distinta a la declarada
    IF wl_parametros-iv_tipo = zcl_wm_nt_generic=>gc_tipo_mov_bobina_orden_trans.
      SELECT SINGLE bp~werks, bp~id_maquina, bp~cod_parte_rebob, bp~tbnum, cab~bobina_cons
        INTO @DATA(wl_parte_rebob)
        FROM zwm_parte_reb_bp AS bp INNER JOIN zwm_parte_reb_c AS cab ON cab~werks            = bp~werks AND
                                                                         cab~id_maquina       = bp~id_maquina AND
                                                                         cab~cod_parte_rebob  = bp~cod_parte_rebob
        WHERE bp~werks       = @lv_werks AND
              bp~id_maquina  = @lv_machine_id AND
              bp~tbnum       = @wl_parametros-iv_tbnum.
      IF sy-subrc = 0 AND wl_parte_rebob-bobina_cons <> wl_parametros-iv_bobine.
        UPDATE zwm_parte_reb_c
          SET bobina_cons = wl_parametros-iv_bobine
          WHERE werks            = wl_parte_rebob-werks       AND
                id_maquina       = wl_parte_rebob-id_maquina  AND
                cod_parte_rebob  = wl_parte_rebob-cod_parte_rebob.

      ENDIF.
    ENDIF.
    "JCB 07.02.22. FIN Tratamiento partes rebobinado, si se aprovisiona una UA distinta a la declarada


    me->copy_data_to_ref(
                            EXPORTING
                              is_data = wl_movebobine_out
                            CHANGING
                              cr_data = er_data
                          ).


  ENDMETHOD.
  METHOD get_calidad.

    SELECT SINGLE zcodigo
      INTO @DATA(vl_codigo)
      FROM ztpi0001
      WHERE zdescripcion = 'CALIDAD'.
    IF vl_codigo IS NOT INITIAL.
      SELECT SINGLE ztpi0013~calidad
        INTO @vp_calidad
        FROM ztpi0003 INNER JOIN ztpi0013 ON ztpi0013~valor_externo = ztpi0003~zvalor_externo
        WHERE zcodigo     = @vl_codigo AND
              werks       = @vp_werks AND
              zvalor_sap  = @vp_matkl.
      IF sy-subrc <> 0.
        SELECT SINGLE ztpi0014~calidad
          FROM ztpi0014
          INTO vp_calidad
          WHERE matkl = vp_matkl AND
                werks = vp_werks.
      ENDIF.
    ENDIF.

  ENDMETHOD.
  METHOD GET_CENTROS_LOGO.


    DATA: filename TYPE string,
          buffer   TYPE xstring,
          mlen     TYPE i,
          alen     TYPE i.

    filename = |/logos/{ vp_werks }.jpg|.

    OPEN DATASET filename FOR INPUT IN BINARY MODE.
    IF sy-subrc = 0.
      mlen = 1024.
      alen = 9999.
      WHILE alen <> 0.
        READ DATASET filename INTO buffer MAXIMUM LENGTH mlen ACTUAL LENGTH alen.
        IF sy-subrc = 0.
          CONCATENATE vp_logo buffer INTO vp_logo IN BYTE MODE.
        ENDIF.
      ENDWHILE.
      CLOSE DATASET filename.
    ELSE.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Error al abrir fichero' ).
    ENDIF.




  ENDMETHOD.
  METHOD get_datos_reubicar_resto.

    DATA(wl_centro) = zcl_wm_nt_generic=>get_instance( )->centros_getdetail( vp_werks ).
    wp_datos-lgnum  = wl_centro-lgnum.
    wp_datos-lenum  = vp_lenum.


    SELECT SINGLE lqua~matnr, lqua~charg, lqua~werks
      INTO @DATA(wl_lqua)
      FROM lqua INNER JOIN t320 ON t320~werks = lqua~werks AND
                                   t320~lgort = lqua~lgort
      WHERE t320~werks = @vp_werks AND
            lqua~lenum = @vp_lenum AND
            lqua~verme > 0.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Bobina incorrecta' ).
    ENDIF.

    wp_datos-matnr = wl_lqua-matnr.
    SELECT SINGLE *
      INTO @DATA(wl_mara)
      FROM mara
      WHERE mara~matnr = @wp_datos-matnr.
    wp_datos-maktx = zcl_wm_nt_generic=>get_mat_txt_omp( iv_werks = vp_werks
                                                         is_mara  = wl_mara ).
    SELECT SINGLE lfa1~lifnr, lfa1~name1
      INTO @DATA(wl_lfa1)
      FROM mch1 INNER JOIN lfa1 ON lfa1~lifnr = mch1~lifnr
      WHERE charg = @wl_lqua-charg AND
            matnr = @wl_lqua-matnr.
    IF sy-subrc = 0.
      wp_datos-lifnr = wl_lfa1-lifnr.
      wp_datos-name1 = wl_lfa1-name1.
    ENDIF.


    IF wl_centro-cla_reg_ua_ultima_ot = 'X'.
      DATA(vl_nlpla_like) =  |{ vp_lgpla }%|.
      SELECT ltak~lgnum, ltak~tanum, ltap~qdatu, ltap~qzeit,
             ltap~vltyp, ltap~vlpla, ltap~nltyp, ltap~nlpla
        INTO TABLE @DATA(tl_ltap)
        UP TO 1 ROWS
        FROM ltap INNER JOIN ltak ON ltak~lgnum =  ltap~lgnum AND
                                     ltak~tanum =  ltap~tanum
        WHERE ltak~lgnum = @wp_datos-lgnum  AND
              ltak~bwlvs = '918'            AND
              ltap~vlenr = @vp_lenum        AND
              ltap~vltyp LIKE '02_'         AND
              ltap~nlpla LIKE @vl_nlpla_like
        ORDER BY ltap~qdatu DESCENDING, ltap~qzeit DESCENDING.
      READ TABLE tl_ltap ASSIGNING FIELD-SYMBOL(<fs_ltap>) INDEX 1.
      IF sy-subrc = 0.
        wp_datos-lgtyp = <fs_ltap>-vltyp.
        wp_datos-lgpla = <fs_ltap>-vlpla.
      ENDIF.
    ENDIF.


    IF wp_datos-lgpla IS INITIAL.
      DATA(wl_ubicacion) = zcl_wm_nt_generic=>get_ubicacion_prop_ua( vp_werks = vp_werks
                                                                     vp_lenum = vp_lenum ).
      wp_datos-lgtyp  = wl_ubicacion-lgtyp.
      wp_datos-lgpla  = wl_ubicacion-lgpla.
    ENDIF.








  ENDMETHOD.
  METHOD grupos_maquinas_getdetail.

    SELECT SINGLE *
      INTO CORRESPONDING FIELDS OF wp_grupo_maquinas
      FROM zwm_param_grmaq
      WHERE lgnum = vp_lgnum AND
            grupo = vp_grupo.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Grupo de mquinas incorrecto' ).
    ENDIF.

  ENDMETHOD.
  method GRUPOSMAQUINAS_GET_ENTITY.
    DATA(vl_werks) =  zcl_wm_nt_generic=>read_http_header_val( iv_name   = zcl_wm_nt_generic=>gc_http_head_werks
                                                               iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) ) ).
    DATA(vl_lgnum) = zcl_wm_nt_generic=>get_lgnum( iv_werks = CONV #( vl_werks ) ).


    tratar_key_entity( EXPORTING io_tech_request_context = io_tech_request_context
                       IMPORTING wp_entity               = er_entity ).

    er_entity = grupos_maquinas_getdetail( vp_lgnum =  vl_lgnum
                                           vp_grupo = er_entity-grupo ).
  endmethod.
  METHOD imprimir_ua.
    DATA(rl_consumos_imp) = NEW zcl_zui5_wm_consumos_dpc_imp( ).

    wp_return = rl_consumos_imp->imprimir_ua( vp_lgpla      = vp_lgpla
                                              vp_werks      = vp_werks
                                              vp_ua         = vp_ua
                                              vp_cla_aprov  = 'X' ).

  ENDMETHOD.
  METHOD lista_aprov_pp_getlist.

    CONSTANTS: cl_status_length_rojo     TYPE zwm_aprov_list_status_largo VALUE '1',
               cl_status_length_amarillo TYPE zwm_aprov_list_status_largo VALUE '2',
               cl_status_length_azul     TYPE zwm_aprov_list_status_largo VALUE '3',
               cl_status_length_verde    TYPE zwm_aprov_list_status_largo VALUE '4'.


    TRY .
        DATA(wl_estacion) = zcl_wm_nt_generic=>get_instance( )->maquinas_getdetail( vp_machine_id = vp_lgpla ).
        DATA(wl_centro)   = zcl_wm_nt_generic=>get_instance( )->centros_getdetail( vp_werks ).
      CATCH /iwbep/cx_mgw_busi_exception.
    ENDTRY.
    DATA(vl_meins) = SWITCH meins( wl_estacion-gestiona_palets  WHEN 'X' THEN 'ST' ELSE 'M' ).



    DATA: tl_inactivo_rg TYPE RANGE OF zwm_intf_omp_sap-inactivo.
    IF vp_mostrar_inactivos = space.
      tl_inactivo_rg = VALUE #( ( sign = 'I' option = 'EQ' low = space ) ).
    ENDIF.


    DATA: tl_zzcinumber_rg TYPE RANGE OF zsppt_cinumbers-ci_number.

    DATA vl_lgnum TYPE ltbk-lgnum.
    DATA vl_benum TYPE ltbk-benum.
    DATA tl_benum_rg TYPE RANGE OF ltak-benum.

    IF vp_id IS NOT INITIAL.
      SPLIT vp_id AT '-' INTO vl_lgnum vl_benum.

      "JCB: OJO!!!. En ZSPPT_CINUMBER est en formato externo, mientras que en LTBK est en formato interno!!!!
      "Consultar con Kiko
      tl_zzcinumber_rg = VALUE #( ( sign = 'I' option = 'EQ' low = vl_benum ) ).

      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = vl_benum
        IMPORTING
          output = vl_benum.

      tl_benum_rg = VALUE #( ( sign = 'I' option = 'EQ' low = vl_benum  ) ).
    ENDIF.

*    Estado Liberado. Entendemos que en cualquier otro estado (abierto, cierre tcnico)... no se van a mostrar en el listado
*        Confirmar las clases de rdenes que se van a mostrar (ZPP1, ZPAC, ZSAR...)
*ZPAC hace referencia a PACS y las OFs que se crearn en este centro. Cada centro tendr su propia clase de OF,
*debido a que queran diferenciar secuenciales. Entonces,
*para el caso, yo creara un parmetro que apunte a la planta y la clase de OF asociada.
*En este caso ZPAC. ZSAR, no afecta, porque como ya te dije, no manejan consumos de MP con las aplicaciones.
*
*    Debe disponer de CI_NUMBER (campo ZZCINUMBER en tabla AUFK) Efectivamente. La interfaz de OMP a SAP, cuando planifiquen desde OMP,
*liberar la OF y adems informar de este campo en el campo que indicas. Todas las OF deben tener ese nmero informado.
*
*    Debe tener una operacin del puesto 2001_101 (Tren Ondular BHS)
*        Para evitar el hardcode, puedo basarme en algn parmetro del puesto de trabajo o de la posicin, o
*tendremos que crear un nuevo parmetro? Igual que antes, 2001_101, apunta a un PdT de Pacs.
*Cuando lleguemos a Xtiva ser otro. Yo creara un
*parmetro en alguna tabla por centro y PdT.
*
*    Debe tener componentes asociados a la operacin seleccionada, del tipo Papel
*        Confirmar tipos de material (ZPAP) Para el caso de Pacs as es. Cuando lleguemos a otros centros con mquinas
*de converting, tendremos otras operaciones, otros PdTs asociados a esas mquinas y otros tipos de papel.
*
*    Deben haberse generado Necesidades de transporte asociadas a las reservas (componentes de la orden)
*        En esas necesidades debe estar indicada la ubicacin destino, que se corresponder a la estacin de la onduladora
*asociada para el aprovisionamiento Correcto. Lo confirmo que esto va a ser as.

    DATA tl_lgpla TYPE TABLE OF lgpla.
*    IF vp_lista_apro = 'X'.
*      DO 5 TIMES.
*        APPEND |{ vp_lgpla }{ sy-index }| TO tl_lgpla.
*      ENDDO.
*    ELSE.
*      APPEND vp_lgpla TO tl_lgpla.
*    ENDIF.

    DATA vl_lgpla_sup LIKE vp_lgpla.
    vl_lgpla_sup = vp_lgpla.
    IF vp_lista_apro = space.
      DATA(vl_len) = strlen( vl_lgpla_sup ) - 1.
      vl_lgpla_sup = vl_lgpla_sup(vl_len).
    ENDIF.


    DO 5 TIMES.
      APPEND |{ vl_lgpla_sup }{ sy-index }| TO tl_lgpla.
    ENDDO.


    SELECT aufk~werks, aufk~aufnr, afko~plnbez, afko~rsnum, afko~aufpl, "aufk~zzcinumber,
           afko~gamng, mara~meins, mara~matkl, mara~zzancho,
           afko~gstrs, afko~gsuzs, CAST( ' ' AS CHAR( 50 ) ) AS clave_marc
      INTO TABLE @DATA(tl_ordenes)
      FROM afko INNER JOIN aufk ON aufk~aufnr = afko~aufnr
                INNER JOIN mara ON afko~plnbez = mara~matnr
      WHERE aufk~werks = @vp_werks                AND
            aufk~auart IN ('ZPAC')                AND
            mara~mtart IN ('ZPAP', 'ZPTO', 'ZPSE')        AND
            EXISTS ( SELECT objnr FROM jest
                                  WHERE jest~objnr = aufk~objnr AND
                                        jest~stat  = 'I0002'    AND "Liberado
                                        jest~inact = @space )
      ORDER BY afko~gstrs, afko~gsuzs.
    CHECK sy-subrc = 0.
    LOOP AT tl_ordenes ASSIGNING FIELD-SYMBOL(<fs_ordenes>).
      CONCATENATE <fs_ordenes>-plnbez <fs_ordenes>-werks INTO <fs_ordenes>-clave_marc RESPECTING BLANKS.
    ENDLOOP.

    DATA: vl_fecha_ini TYPE dats,
          vl_hora_ini  TYPE tims.
    IF vp_margen_sel_ordenes <> 0.
      CALL FUNCTION 'START_TIME_DETERMINE'
        EXPORTING
          duration                   = vp_margen_sel_ordenes
          unit                       = 'H'
        IMPORTING
          start_date                 = vl_fecha_ini
          start_time                 = vl_hora_ini
        CHANGING
          end_date                   = sy-datum
          end_time                   = sy-uzeit
        EXCEPTIONS
          factory_calendar_not_found = 1
          date_out_of_calendar_range = 2
          date_not_valid             = 3
          unit_conversion_error      = 4
          si_unit_missing            = 5
          parameters_not_valid       = 6
          OTHERS                     = 7.

      DATA(vl_timestamp_ini) = vl_fecha_ini && vl_hora_ini.
    ENDIF.

    TYPES: BEGIN OF st_cinumbers,
             lgnum              TYPE ltbk-lgnum,
             ci_number          TYPE ltbk-benum,
             aufnr              TYPE aufk-aufnr,
             fecha_ini          TYPE dats,
             hora_ini           TYPE tims,
             calidad            TYPE zwm_intf_omp_sap-quality,
             zzancho            TYPE mara-zzancho,
             plannedtrim        TYPE zwm_intf_omp_sap-planned_trim,
             estacion           TYPE lgpla,
             matnr              TYPE mara-matnr,
             tbnum              TYPE ltbk-tbnum,
             rsnum              TYPE resb-rsnum,
             rspos              TYPE resb-rspos,
             um_step            TYPE meins,
             cant_step          TYPE zwm_intf_omp_sap-paper1length_m,
             tbktx              TYPE ltbk-tbktx,
             porcentaje_reserva TYPE p LENGTH 9 DECIMALS 6,
           END OF st_cinumbers.
    TYPES: tt_cinumbers TYPE TABLE OF st_cinumbers.


    DATA: tl_cinumbers TYPE tt_cinumbers,
          wl_cinumbers LIKE LINE OF tl_cinumbers.


    SELECT lgnum, upper_orderid, lower_orderid, benum, start_date, start_time, quality, planned_trim,
            nlpla1, matnr1, paper1length_m,
            nlpla2, matnr2, paper2length_m,
            nlpla3, matnr3, paper3length_m,
            nlpla4, matnr4, paper4length_m,
            nlpla5, matnr5, paper5length_m,
            nlpla6, matnr6, paper6length_m,
            stepcontribution_upper, stepcontribution_lower
      INTO TABLE @DATA(tl_intf_omp)
      FROM zwm_intf_omp_sap
      FOR ALL ENTRIES IN @tl_ordenes
      WHERE lgnum     = @wl_centro-lgnum   AND
            inactivo  IN @tl_inactivo_rg   AND
            benum     IN @tl_benum_rg      AND
            ( upper_orderid = @tl_ordenes-aufnr OR
              lower_orderid = @tl_ordenes-aufnr ).
    CHECK sy-subrc = 0.

    LOOP AT tl_intf_omp ASSIGNING FIELD-SYMBOL(<fs_intf_omp>).

      DO 2 TIMES.
        DATA(vl_aufnr)            = COND #( WHEN sy-index = 1 THEN <fs_intf_omp>-upper_orderid ELSE <fs_intf_omp>-lower_orderid ).
        DATA(vl_stepcontribution) = COND #( WHEN sy-index = 1 THEN <fs_intf_omp>-stepcontribution_upper ELSE <fs_intf_omp>-stepcontribution_lower ).
        CHECK vl_aufnr IS NOT INITIAL.

        READ TABLE tl_ordenes ASSIGNING <fs_ordenes> WITH KEY aufnr = vl_aufnr.
        CHECK sy-subrc = 0.

        CLEAR wl_cinumbers.
        wl_cinumbers-lgnum        = <fs_intf_omp>-lgnum.
        wl_cinumbers-ci_number    = <fs_intf_omp>-benum.
        wl_cinumbers-aufnr        = vl_aufnr.
        wl_cinumbers-fecha_ini    = <fs_intf_omp>-start_date.
        wl_cinumbers-hora_ini     = <fs_intf_omp>-start_time.
        wl_cinumbers-calidad      = <fs_intf_omp>-quality.
        wl_cinumbers-plannedtrim  = <fs_intf_omp>-planned_trim.
        wl_cinumbers-um_step      = vl_meins.
        wl_cinumbers-rsnum        = <fs_ordenes>-rsnum.
        IF <fs_intf_omp>-lower_orderid IS INITIAL.
          wl_cinumbers-tbktx        = vl_aufnr.
        ELSE.
          wl_cinumbers-tbktx = |{ <fs_intf_omp>-upper_orderid }/{ <fs_intf_omp>-lower_orderid }|.
        ENDIF.

        DO 6 TIMES.
          DATA(vl_index) = sy-index.
          ASSIGN COMPONENT |PAPER{ vl_index }LENGTH_M|   OF STRUCTURE <fs_intf_omp> TO FIELD-SYMBOL(<fs_paper_length>).
          ASSIGN COMPONENT |NLPLA{ vl_index }|            OF STRUCTURE <fs_intf_omp> TO FIELD-SYMBOL(<fs_nlpla>).
          ASSIGN COMPONENT |MATNR{ vl_index }|            OF STRUCTURE <fs_intf_omp> TO FIELD-SYMBOL(<fs_matnr>).
          CHECK <fs_matnr> IS NOT INITIAL.

          wl_cinumbers-estacion   = <fs_nlpla>.
          wl_cinumbers-matnr      = <fs_matnr>.
          wl_cinumbers-cant_step  = <fs_paper_length> * vl_stepcontribution.
          APPEND wl_cinumbers TO tl_cinumbers.
        ENDDO.
      ENDDO.
    ENDLOOP.
    CHECK tl_cinumbers IS NOT INITIAL.


    SELECT resb~rsnum, resb~rspos, resb~rsart, resb~matnr, resb~aufnr, resb~werks,
           resb~bdmng, resb~meins, resb~enmng, resb~sortf,
           mara~zzgramaje, mara~zzancho, mara~zzlargo, mara~mtart, t023t~wgbez60
      INTO TABLE @DATA(tl_resb)
      FROM resb INNER JOIN ( mara LEFT OUTER JOIN t023t ON t023t~spras = @sy-langu AND
                                                           t023t~matkl = mara~matkl )
                ON mara~matnr = resb~matnr
      FOR ALL ENTRIES IN @tl_cinumbers
      WHERE resb~rsnum = @tl_cinumbers-rsnum    AND
            resb~matnr = @tl_cinumbers-matnr    AND
            resb~sortf = @tl_cinumbers-estacion AND
            resb~xloek = @space.
    CHECK sy-subrc = 0.

    SELECT ltbp~lgnum, ltbp~tbnum, ltbp~tbpos,
           ltbk~rsnum, ltbp~rspos, ltbp~rsart, ltbk~nlpla, ltbp~werks, ltbp~matnr,
           ltbp~menge, ltbp~meins, ltbp~menga, ltbp~altme, ltbk~benum, ltbk~tbktx
      INTO TABLE @DATA(tl_ltbp)
      FROM ltbp INNER JOIN ltbk ON ltbk~lgnum = ltbp~lgnum AND
                                   ltbk~tbnum = ltbp~tbnum
      FOR ALL ENTRIES IN @tl_cinumbers
      WHERE ltbk~lgnum =  @tl_cinumbers-lgnum     AND
*            ltbk~tbktx =  @tl_cinumbers-tbktx    AND
            ltbk~benum =  @tl_cinumbers-ci_number AND
            ltbk~nlpla =  @tl_cinumbers-estacion  AND
            ltbp~matnr =  @tl_cinumbers-matnr     AND
            ltbk~benum IN @tl_benum_rg.
    CHECK sy-subrc = 0.

    "Corregimos fecha inicio y fin de los cinumbers, por lo que hay en la operacin de la orden
    "Tambin las calidades
    SELECT yhp_idx_td010~object_key, yhp_idx_td110~board
      INTO TABLE @DATA(tl_calidades)
      FROM yhp_idx_td010 INNER JOIN yhp_idx_td110 ON yhp_idx_td110~cuobj = yhp_idx_td010~cuobj AND
                                                     yhp_idx_td110~mboar = 'P'
      FOR ALL ENTRIES IN @tl_ordenes
      WHERE yhp_idx_td010~object_type = 'MARC' AND
            yhp_idx_td010~object_key  = @tl_ordenes-clave_marc.
    LOOP AT tl_calidades ASSIGNING FIELD-SYMBOL(<fs_calidades>) WHERE board CP '*_P'.
      "Quitamos los dos ltimos caracteres
      vl_len = strlen( <fs_calidades>-board ).
      SUBTRACT 2 FROM vl_len.
      <fs_calidades>-board = <fs_calidades>-board(vl_len).
    ENDLOOP.


    LOOP AT tl_cinumbers ASSIGNING FIELD-SYMBOL(<fs_cinumbers>).
      READ TABLE tl_ordenes ASSIGNING <fs_ordenes> WITH KEY aufnr = <fs_cinumbers>-aufnr.
      IF sy-subrc = 0.
        READ TABLE tl_calidades ASSIGNING <fs_calidades> WITH KEY object_key = <fs_ordenes>-clave_marc.
      ENDIF.
      IF sy-subrc = 0.
        <fs_cinumbers>-calidad = <fs_calidades>-board.
      ENDIF.


      READ TABLE tl_resb ASSIGNING FIELD-SYMBOL(<fs_resb>) WITH KEY rsnum = <fs_cinumbers>-rsnum
                                                                    matnr = <fs_cinumbers>-matnr
                                                                    sortf = <fs_cinumbers>-estacion.
      IF sy-subrc = 0.
        DATA(vl_tabix_resb) = sy-tabix.
        <fs_cinumbers>-rspos    = <fs_resb>-rspos.
        <fs_cinumbers>-zzancho  = <fs_resb>-zzancho.
      ENDIF.

      READ TABLE tl_ltbp ASSIGNING FIELD-SYMBOL(<fs_ltbp>) WITH KEY lgnum = <fs_cinumbers>-lgnum
                                                                    tbktx = <fs_cinumbers>-tbktx
                                                                    nlpla = <fs_cinumbers>-estacion
                                                                    matnr = <fs_cinumbers>-matnr.
      IF sy-subrc = 0.
        <fs_cinumbers>-tbnum = <fs_ltbp>-tbnum.
      ENDIF.
    ENDLOOP.

    "Si hay la misma reserva en distinto ci number calculamos base reparto
    TYPES: BEGIN OF st_total_pos_reserva,
             rsnum     TYPE resb-rsnum,
             rspos     TYPE resb-rspos,
             cant_step TYPE  zwm_intf_omp_sap-paper1length_m,
           END OF st_total_pos_reserva.
    DATA: wl_total_pos_reserva TYPE st_total_pos_reserva,
          tl_total_pos_reserva LIKE TABLE OF wl_total_pos_reserva.

    LOOP AT tl_cinumbers ASSIGNING <fs_cinumbers>.
      MOVE-CORRESPONDING <fs_cinumbers> TO wl_total_pos_reserva.
      COLLECT wl_total_pos_reserva INTO tl_total_pos_reserva.
    ENDLOOP.

    LOOP AT tl_cinumbers ASSIGNING <fs_cinumbers>.
      READ TABLE tl_total_pos_reserva ASSIGNING FIELD-SYMBOL(<fs_total_pos_reserva>) WITH KEY rsnum = <fs_cinumbers>-rsnum
                                                                                              rspos = <fs_cinumbers>-rspos.
      IF sy-subrc = 0 AND <fs_total_pos_reserva>-cant_step <> 0.
        <fs_cinumbers>-porcentaje_reserva = <fs_cinumbers>-cant_step / <fs_total_pos_reserva>-cant_step.
      ENDIF.
    ENDLOOP.



    SELECT ltap~lgnum, ltap~tanum, ltap~tapos, ltap~vlenr, ltap~nlpla, ltak~benum, ltak~rsnum, ltap~meins, ltap~nistm, ltap~matnr
      INTO TABLE @DATA(tl_ltap)
      FROM ltap INNER JOIN ltak ON ltak~lgnum = ltap~lgnum AND
                                   ltak~tanum = ltap~tanum
      FOR ALL ENTRIES IN @tl_ltbp
      WHERE ltak~lgnum = @tl_ltbp-lgnum AND
            ltak~benum = @tl_ltbp-benum AND
            ltap~nlpla = @tl_ltbp-nlpla.

    SELECT SINGLE low
      INTO @DATA(vl_length_max)
      FROM tvarvc
      WHERE name = 'ZUI5_LISTADOAPRV_GRAPH_MAX' AND
            type = 'P'                          AND
            numb = '0000'.

    DATA wl_mara  TYPE mara.
    DATA vl_id TYPE zwm_id.

    SORT tl_cinumbers BY fecha_ini hora_ini estacion calidad zzancho ci_number .


    LOOP AT tl_cinumbers ASSIGNING <fs_cinumbers>.
      IF vl_fecha_ini IS NOT INITIAL.
        DATA(vl_timestamp_cinumber) = <fs_cinumbers>-fecha_ini && <fs_cinumbers>-hora_ini.
        CHECK vl_timestamp_cinumber >= vl_timestamp_ini.
      ENDIF.

      DATA(vl_orden_out)  = CONV lvs_benum( |{ <fs_cinumbers>-aufnr ALPHA = OUT }| ).
      READ TABLE tl_ordenes ASSIGNING <fs_ordenes> WITH KEY aufnr = <fs_cinumbers>-aufnr.
      CHECK sy-subrc = 0.

      DATA(vl_lgpla) = <fs_cinumbers>-estacion.
      READ TABLE tl_lgpla TRANSPORTING NO FIELDS WITH KEY table_line = vl_lgpla.
      CHECK sy-subrc = 0.
      DATA(vl_idx_estacion) = sy-tabix.

      IF <fs_cinumbers>-um_step <> 'M'.
        CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
          EXPORTING
            i_matnr              = <fs_cinumbers>-matnr
            i_in_me              = <fs_cinumbers>-um_step
            i_out_me             = 'M'
            i_menge              = <fs_cinumbers>-cant_step
          IMPORTING
            e_menge              = <fs_cinumbers>-cant_step
          EXCEPTIONS
            error_in_application = 1
            error                = 2
            OTHERS               = 3.
        IF sy-subrc = 0.
          <fs_cinumbers>-um_step = 'M'.
        ENDIF.
      ENDIF.


      "Miramos si hay varias rdenes en este ci number
      DATA(vl_varias_ordenes) = space.
      DATA tl_ordenes_tbktx TYPE TABLE OF aufk-aufnr.
      CLEAR tl_ordenes_tbktx.
      SPLIT <fs_cinumbers>-tbktx AT '/' INTO TABLE tl_ordenes_tbktx.
      IF lines( tl_ordenes_tbktx ) > 1.
        vl_varias_ordenes = 'X'.
      ENDIF.



      "Miramos si creamos nuevo registro o si agrupamos
*      DATA(vl_nuevo_registro) = space.
      vl_id = |{ wl_centro-lgnum }-{ <fs_cinumbers>-ci_number }|.
      READ TABLE tp_lista ASSIGNING FIELD-SYMBOL(<fs_lista>) WITH KEY id = vl_id.
      IF sy-subrc <> 0.
        APPEND INITIAL LINE TO tp_lista ASSIGNING <fs_lista>.
        <fs_lista>-id         = vl_id.
        <fs_lista>-related_id = <fs_cinumbers>-ci_number.
        <fs_lista>-quality    = <fs_cinumbers>-calidad.
        <fs_lista>-meins      = <fs_cinumbers>-um_step.
        <fs_lista>-width      = <fs_cinumbers>-zzancho.
        <fs_lista>-ztrim      = <fs_cinumbers>-plannedtrim * 100. "De metros a centmetros
        <fs_lista>-length_max = vl_length_max.
        <fs_lista>-fecha      = <fs_cinumbers>-fecha_ini.
        <fs_lista>-hora       = <fs_cinumbers>-hora_ini.
        <fs_lista>-pedido     = vl_orden_out.
        IF vl_varias_ordenes = 'X'.
          <fs_lista>-pedido = |{ <fs_lista>-pedido }+|.
        ENDIF.

        "El canal es la parte de letras despus de los nmeros de la calidad
        <fs_lista>-canal = <fs_lista>-quality.
        DATA(vl_pos) = 0.
        DO strlen( <fs_lista>-canal ) TIMES.
          IF <fs_lista>-canal+vl_pos(1) CO '0123456789'.
            CLEAR <fs_lista>-canal+vl_pos(1).
          ENDIF.
          ADD 1 TO vl_pos.
        ENDDO.
        CONDENSE <fs_lista>-canal.


      ENDIF.

*      ADD <fs_cinumbers>-cant_step TO <fs_lista>-length.


      DATA vl_idx TYPE i.
      CLEAR vl_idx.
      LOOP AT tl_resb ASSIGNING <fs_resb> WHERE rsnum = <fs_cinumbers>-rsnum AND
                                                rspos = <fs_cinumbers>-rspos.
        CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
          EXPORTING
            i_matnr              = <fs_resb>-matnr
            i_in_me              = <fs_resb>-meins
            i_out_me             = vl_meins
            i_menge              = <fs_resb>-bdmng
          IMPORTING
            e_menge              = <fs_resb>-bdmng
          EXCEPTIONS
            error_in_application = 1
            error                = 2
            OTHERS               = 3.
        IF sy-subrc <> 0.
          CONTINUE.
        ENDIF.

        IF vl_idx_estacion = 1.
          CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
            EXPORTING
              i_matnr              = <fs_resb>-matnr
              i_in_me              = <fs_resb>-meins
              i_out_me             = vl_meins
              i_menge              = <fs_resb>-enmng
            IMPORTING
              e_menge              = <fs_resb>-enmng
            EXCEPTIONS
              error_in_application = 1
              error                = 2
              OTHERS               = 3.
          IF sy-subrc <> 0.
            CONTINUE.
          ENDIF.
          <fs_lista>-length = <fs_lista>-length - <fs_resb>-enmng * <fs_cinumbers>-porcentaje_reserva.

*          SUBTRACT <fs_resb>-enmng FROM <fs_lista>-length.
          IF <fs_lista>-length < 0. <fs_lista>-length  = 0. ENDIF.

*          "Vaciamos la cantidad tomada para no volverla a usar
*          CLEAR <fs_resb>-enmng.
        ENDIF.

        <fs_resb>-meins = vl_meins.
        ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }|             OF STRUCTURE <fs_lista> TO <fs_nlpla>.
        ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_MATNR|       OF STRUCTURE <fs_lista> TO FIELD-SYMBOL(<fs_nlpla_matnr>).
        ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_MAT_ID|      OF STRUCTURE <fs_lista> TO FIELD-SYMBOL(<fs_nlpla_mat_id>).
        ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_MENGE|       OF STRUCTURE <fs_lista> TO FIELD-SYMBOL(<fs_nlpla_menge>).
        ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_MENGE_ACUM|  OF STRUCTURE <fs_lista> TO FIELD-SYMBOL(<fs_nlpla_menge_acum>).
        ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_MENGE_SERV|  OF STRUCTURE <fs_lista> TO FIELD-SYMBOL(<fs_nlpla_menge_serv>).
        ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_MEINS|       OF STRUCTURE <fs_lista> TO FIELD-SYMBOL(<fs_nlpla_meins>).
        ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_GROUP|       OF STRUCTURE <fs_lista> TO FIELD-SYMBOL(<fs_nlpla_group>).
        ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_WGBEZ60|     OF STRUCTURE <fs_lista> TO FIELD-SYMBOL(<fs_nlpla_wgbez60>).
        ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_GRAMAJE|     OF STRUCTURE <fs_lista> TO FIELD-SYMBOL(<fs_nlpla_gramaje>).
        ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_ANCHO|       OF STRUCTURE <fs_lista> TO FIELD-SYMBOL(<fs_nlpla_ancho>).
        ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_STATUS|      OF STRUCTURE <fs_lista> TO FIELD-SYMBOL(<fs_nlpla_status>).
        ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_MAKTX|       OF STRUCTURE <fs_lista> TO FIELD-SYMBOL(<fs_nlpla_maktx>).
        ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_TBNUM|       OF STRUCTURE <fs_lista> TO FIELD-SYMBOL(<fs_nlpla_tbnum>).
        ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_RSNUM|       OF STRUCTURE <fs_lista> TO FIELD-SYMBOL(<fs_nlpla_rsnum>).
        ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_FSC|         OF STRUCTURE <fs_lista> TO FIELD-SYMBOL(<fs_nlpla_fsc>).

        <fs_nlpla>             = vl_lgpla.
        <fs_nlpla_matnr>       = <fs_resb>-matnr.
        <fs_nlpla_meins>       = <fs_resb>-meins.
        <fs_nlpla_ancho>       = <fs_resb>-zzancho.
        <fs_nlpla_gramaje>     = <fs_resb>-zzgramaje.
        <fs_nlpla_rsnum>       = <fs_resb>-rsnum.
        <fs_nlpla_wgbez60>     = <fs_resb>-wgbez60.
        <fs_nlpla_tbnum>       = <fs_cinumbers>-tbnum.
        <fs_nlpla_mat_id>      = <fs_resb>-matnr.
        <fs_nlpla_menge>       = <fs_nlpla_menge> + <fs_resb>-bdmng * <fs_cinumbers>-porcentaje_reserva.


        vl_benum = <fs_cinumbers>-ci_number.
        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
          EXPORTING
            input  = vl_benum
          IMPORTING
            output = vl_benum.


        LOOP AT tl_ltap ASSIGNING FIELD-SYMBOL(<fs_ltap>) WHERE benum = vl_benum AND
                                                                nlpla = <fs_nlpla>.
          DATA vl_menge TYPE menge_d.
          CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
            EXPORTING
              i_matnr              = <fs_ltap>-matnr
              i_in_me              = <fs_ltap>-meins
              i_out_me             = <fs_nlpla_meins>
              i_menge              = <fs_ltap>-nistm
            IMPORTING
              e_menge              = vl_menge
            EXCEPTIONS
              error_in_application = 1
              error                = 2
              OTHERS               = 3.
          IF sy-subrc <> 0.
            zcl_seis_odata_utils=>lanzar_excepcion( ).
          ENDIF.

          ADD vl_menge TO <fs_nlpla_menge_serv>.

          DELETE tl_ltap. "Para no volverlo a coger y repetir
        ENDLOOP.

        CLEAR wl_mara.
        MOVE-CORRESPONDING <fs_resb> TO wl_mara.
        <fs_nlpla_maktx> = zcl_wm_nt_generic=>get_mat_txt_omp( iv_werks = vp_werks
                                                               is_mara  = wl_mara ).
      ENDLOOP.

    ENDLOOP.



    "Ahora los acumulados
    DATA vl_matnr_ant TYPE matnr.
    DATA: vl_canal_ant LIKE <fs_lista>-quality.



    DO 5 TIMES.
      vl_idx = sy-index.
      UNASSIGN <fs_nlpla_menge_acum>.
      CLEAR vl_matnr_ant.
      LOOP AT tp_lista ASSIGNING <fs_lista>.
        ASSIGN COMPONENT |NLPLA{ vl_idx }_MATNR|       OF STRUCTURE <fs_lista> TO <fs_nlpla_matnr>.
        ASSIGN COMPONENT |NLPLA{ vl_idx }_MENGE|       OF STRUCTURE <fs_lista> TO <fs_nlpla_menge>.
        IF <fs_nlpla_matnr> IS INITIAL.
          CLEAR: vl_canal_ant, vl_matnr_ant. CONTINUE.
        ENDIF.

        IF vl_matnr_ant <> <fs_nlpla_matnr> OR vl_canal_ant <> <fs_lista>-canal.
          vl_matnr_ant = <fs_nlpla_matnr>.
          vl_canal_ant = <fs_lista>-canal.
          ASSIGN COMPONENT |NLPLA{ vl_idx }_MENGE_ACUM|  OF STRUCTURE <fs_lista> TO <fs_nlpla_menge_acum>.
          ASSIGN COMPONENT |NLPLA{ vl_idx }_MENGE_SERV|  OF STRUCTURE <fs_lista> TO <fs_nlpla_menge_serv>.
          ASSIGN COMPONENT |NLPLA{ vl_idx }_STATUS|  OF STRUCTURE <fs_lista> TO <fs_nlpla_status>.
        ENDIF.
        IF <fs_nlpla_menge_acum> IS ASSIGNED.
          ADD <fs_nlpla_menge> TO <fs_nlpla_menge_acum>.
        ENDIF.

        IF <fs_nlpla_menge_serv> > 0.
          <fs_nlpla_status> = COND #( WHEN <fs_nlpla_menge_serv> < <fs_nlpla_menge_acum> THEN 'X' ELSE 'A' ).
        ENDIF.
      ENDLOOP.
    ENDDO.

    LOOP AT tp_lista ASSIGNING <fs_lista>.
      DO 5 TIMES.
        vl_idx = sy-index.
        ASSIGN COMPONENT |NLPLA{ vl_idx }_MENGE|  OF STRUCTURE <fs_lista> TO <fs_nlpla_menge>.
        IF <fs_nlpla_menge> IS NOT INITIAL.
          <fs_lista>-length = <fs_nlpla_menge>.

          "Calcular status:
          DATA(vl_porcentaje) = <fs_lista>-length / <fs_lista>-length_max * 100.
          <fs_lista>-status_largo = COND #( WHEN vl_porcentaje < 10 THEN cl_status_length_rojo
                                            WHEN vl_porcentaje < 25 THEN cl_status_length_amarillo
                                            WHEN vl_porcentaje < 75 THEN cl_status_length_azul
                                            ELSE cl_status_length_verde ).


          EXIT.
        ENDIF.
      ENDDO.
    ENDLOOP.



    IF vp_lista_apro = space.
      LOOP AT tp_lista ASSIGNING <fs_lista>.
        DO 5 TIMES.
          vl_idx_estacion = sy-index.
          ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }|             OF STRUCTURE <fs_lista> TO <fs_nlpla>.
          ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_MATNR|       OF STRUCTURE <fs_lista> TO <fs_nlpla_matnr>.
          ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_MAT_ID|      OF STRUCTURE <fs_lista> TO <fs_nlpla_mat_id>.
          ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_MENGE|       OF STRUCTURE <fs_lista> TO <fs_nlpla_menge>.
          ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_MENGE_ACUM|  OF STRUCTURE <fs_lista> TO <fs_nlpla_menge_acum>.
          ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_MENGE_SERV|  OF STRUCTURE <fs_lista> TO <fs_nlpla_menge_serv>.
          ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_MEINS|       OF STRUCTURE <fs_lista> TO <fs_nlpla_meins>.
          ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_GROUP|       OF STRUCTURE <fs_lista> TO <fs_nlpla_group>.
          ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_WGBEZ60|     OF STRUCTURE <fs_lista> TO <fs_nlpla_wgbez60>.
          ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_GRAMAJE|     OF STRUCTURE <fs_lista> TO <fs_nlpla_gramaje>.
          ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_ANCHO|       OF STRUCTURE <fs_lista> TO <fs_nlpla_ancho>.
          ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_STATUS|      OF STRUCTURE <fs_lista> TO <fs_nlpla_status>.
          ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_MAKTX|       OF STRUCTURE <fs_lista> TO <fs_nlpla_maktx>.
          ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_TBNUM|       OF STRUCTURE <fs_lista> TO <fs_nlpla_tbnum>.
          ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_RSNUM|       OF STRUCTURE <fs_lista> TO <fs_nlpla_rsnum>.
          ASSIGN COMPONENT |NLPLA{ vl_idx_estacion }_FSC|         OF STRUCTURE <fs_lista> TO <fs_nlpla_fsc>.

          IF <fs_nlpla> = vp_lgpla AND vl_idx_estacion > 1.
            <fs_lista>-nlpla1             = <fs_nlpla>.
            <fs_lista>-nlpla1_matnr       = <fs_nlpla_matnr>.
            <fs_lista>-nlpla1_mat_id      = <fs_nlpla_mat_id>.
            <fs_lista>-nlpla1_menge       = <fs_nlpla_menge>.
            <fs_lista>-nlpla1_menge_acum  = <fs_nlpla_menge_acum>.
            <fs_lista>-nlpla1_menge_serv  = <fs_nlpla_menge_serv>.
            <fs_lista>-nlpla1_meins       = <fs_nlpla_meins>.
            <fs_lista>-nlpla1_group       = <fs_nlpla_group>.
            <fs_lista>-nlpla1_wgbez60     = <fs_nlpla_wgbez60>.
            <fs_lista>-nlpla1_gramaje     = <fs_nlpla_gramaje>.
            <fs_lista>-nlpla1_ancho       = <fs_nlpla_ancho>.
            <fs_lista>-nlpla1_status      = <fs_nlpla_status>.
            <fs_lista>-nlpla1_maktx       = <fs_nlpla_maktx>.
            <fs_lista>-nlpla1_tbnum       = <fs_nlpla_tbnum>.
            <fs_lista>-nlpla1_rsnum       = <fs_nlpla_rsnum>.
            <fs_lista>-nlpla1_fsc         = <fs_nlpla_fsc>.
          ENDIF.

          IF <fs_nlpla> <> vp_lgpla OR vl_idx_estacion > 1.
            CLEAR: <fs_nlpla>,        <fs_nlpla_matnr>, <fs_nlpla_mat_id>,  <fs_nlpla_menge>,   <fs_nlpla_menge_acum>, <fs_nlpla_menge_serv>,
                   <fs_nlpla_meins>,  <fs_nlpla_group>, <fs_nlpla_wgbez60>, <fs_nlpla_gramaje>, <fs_nlpla_ancho>,      <fs_nlpla_status>,
                   <fs_nlpla_maktx>,  <fs_nlpla_tbnum>, <fs_nlpla_rsnum>,   <fs_nlpla_fsc>.
          ENDIF.
        ENDDO.
      ENDLOOP.
    ENDIF.




  ENDMETHOD.
  METHOD maquinas_getlist.
    DATA: tl_lgpla_rg TYPE RANGE OF lgpla.
    IF vp_grupo IS NOT       INITIAL.
      SELECT *
        INTO TABLE @DATA(tl_param_grmaqd)
        FROM zwm_param_grmaqd
        WHERE lgnum = @vp_lgnum AND
              grupo = @vp_grupo.
      CHECK sy-subrc = 0.
      LOOP AT tl_param_grmaqd ASSIGNING FIELD-SYMBOL(<fs_param_grmaqd>).
        APPEND INITIAL LINE TO tl_lgpla_rg ASSIGNING FIELD-SYMBOL(<fs_lgpla_rg>).
        <fs_lgpla_rg>-sign = 'I'. <fs_lgpla_rg>-option = 'EQ'. <fs_lgpla_rg>-low = <fs_param_grmaqd>-lgpla.
      ENDLOOP.
    ENDIF.

    SELECT lgpla, nombre, imagen
      INTO TABLE @DATA(tl_param_maq)
      FROM zwm_param_maq
      WHERE lgnum =   @vp_lgnum AND
            lgpla IN  @tl_lgpla_rg.

    LOOP AT tl_param_maq ASSIGNING FIELD-SYMBOL(<fs_param_maq>).
      DATA(wl_maquina) = zcl_wm_nt_generic=>get_instance( )->maquinas_getdetail( <fs_param_maq>-lgpla ).
      wl_maquina-nombre =  <fs_param_maq>-nombre.
      wl_maquina-imagen =  <fs_param_maq>-imagen.

      READ TABLE tl_param_grmaqd ASSIGNING <fs_param_grmaqd> WITH KEY lgpla = <fs_param_maq>-lgpla.
      IF sy-subrc = 0.
        wl_maquina-num_orden = <fs_param_grmaqd>-num_orden.
      ENDIF.
      APPEND wl_maquina TO tp_maquinas.
    ENDLOOP.

    SORT tp_maquinas BY num_orden id.
  ENDMETHOD.
  METHOD maquinasset_get_entity.

*    DATA(vl_machine_id_header) =  zcl_wm_nt_generic=>read_http_header_val( iv_name   = zcl_wm_nt_generic=>gc_http_head_machine_id
*                                                                           iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) ) ).

    tratar_key_entity( EXPORTING io_tech_request_context = io_tech_request_context
                       IMPORTING wp_entity               = er_entity ).

    er_entity = zcl_wm_nt_generic=>get_instance( )->maquinas_getdetail( er_entity-id ).

  ENDMETHOD.
  METHOD maquinasset_get_entityset.


    DATA(vl_werks) =  zcl_wm_nt_generic=>read_http_header_val( iv_name   = zcl_wm_nt_generic=>gc_http_head_werks
                                                               iv_facade = CAST #( /iwbep/if_mgw_conv_srv_runtime~get_dp_facade( ) ) ).
    DATA(vl_lgnum) = zcl_wm_nt_generic=>get_lgnum( iv_werks = CONV #( vl_werks ) ).

    DATA wl_entity LIKE LINE OF et_entityset.

    DATA: BEGIN OF wl_key,
            grupo TYPE  zwm_grupo_maq,
          END OF wl_key.


    tratar_key_entityset( EXPORTING io_tech_request_context = io_tech_request_context
                          IMPORTING wp_entity               = wl_key ).


    et_entityset = maquinas_getlist( vp_lgnum = vl_lgnum
                                     VP_GRUPO = wl_key-grupo ).


  ENDMETHOD.
  METHOD materiales_get_entity.
    tratar_key_entity( EXPORTING io_tech_request_context = io_tech_request_context
                       IMPORTING wp_entity               = er_entity ).
    er_entity = materiales_getdetail( vp_werks = er_entity-werks
                                      vp_matnr = er_entity-matnr ).
  ENDMETHOD.
  method MATERIALES_GET_ENTITYSET.
    DATA wl_entity LIKE LINE OF et_entityset.
    tratar_key_entityset( EXPORTING io_tech_request_context = io_tech_request_context
                          IMPORTING wp_entity               = wl_entity ).

    et_entityset =  materiales_getlist( wl_entity-werks ).

    zcl_seis_odata_utils=>tratar_entityset( EXPORTING io_tech_request_context  = io_tech_request_context
                                            CHANGING et_entityset = et_entityset ).
  endmethod.
  METHOD materiales_getdetail.
    SELECT SINGLE marc~werks, marc~matnr, mara~mtart, mara~zzancho,
                  mara~zzgramaje, mara~zzlargo, mara~matkl
      INTO CORRESPONDING FIELDS OF @wp_material
      FROM marc INNER JOIN mara ON marc~matnr = mara~matnr
      WHERE marc~werks = @vp_werks AND
            marc~matnr = @vp_matnr AND
            marc~lvorm = @space    AND
            mara~lvorm = @space    and
            mara~mtart in ('ZPAP', 'ZCAB').

*    SELECT SINGLE @vp_werks AS werks, mara~matnr, mara~mtart, mara~zzancho,
*                  mara~zzgramaje, mara~zzlargo, mara~matkl
*      INTO CORRESPONDING FIELDS OF @wp_material
*      FROM mara
*      WHERE mara~lvorm = @space    AND
*            mara~matnr = @vp_matnr AND
*            mara~mtart = 'ZPAP'.


    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Material incorrecto' ).
    ENDIF.

    DATA tl_materiales LIKE TABLE OF wp_material.
    APPEND wp_material TO tl_materiales.
    materiales_getlist_ext( CHANGING tp_materiales =  tl_materiales ).
    wp_material = tl_materiales[ 1 ].

  ENDMETHOD.
  METHOD materiales_getlist.
    SELECT marc~werks, marc~matnr, mara~mtart, mara~zzancho,
           mara~zzgramaje, mara~zzlargo, mara~matkl
      INTO CORRESPONDING FIELDS OF TABLE @tp_materiales
      FROM marc INNER JOIN mara ON marc~matnr = mara~matnr
      WHERE marc~werks = @vp_werks AND
            marc~lvorm = @space    AND
            mara~lvorm = @space    AND
            mara~mtart in ('ZPAP', 'ZCAB').

*
*    SELECT @vp_werks as werks, mara~matnr, mara~mtart, mara~zzancho,
*            mara~zzgramaje, mara~zzlargo, mara~matkl
*      INTO CORRESPONDING FIELDS OF TABLE @tp_materiales
*      FROM mara
*      WHERE mara~lvorm = @space    and
*            mara~mtart = 'ZPAP'.


    materiales_getlist_ext( CHANGING tp_materiales =  tp_materiales ).

    SORT tp_materiales BY maktx.
  ENDMETHOD.
  METHOD materiales_getlist_ext.
    CHECK tp_materiales IS NOT INITIAL.


    SELECT matnr, maktx
      INTO TABLE @DATA(tl_makt)
      FROM makt
      FOR ALL ENTRIES IN @tp_materiales
      WHERE matnr = @tp_materiales-matnr AND
            spras = @sy-langu.


    SELECT matkl, werks, calidad
      INTO TABLE @DATA(tl_ztpi0014)
      FROM ztpi0014
      FOR ALL ENTRIES IN @tp_materiales
      WHERE werks = @tp_materiales-werks AND
            matkl = @tp_materiales-matkl.



    LOOP AT tp_materiales ASSIGNING FIELD-SYMBOL(<fs_materiales>).
      READ TABLE tl_makt ASSIGNING FIELD-SYMBOL(<fs_makt>) WITH KEY matnr = <fs_materiales>-matnr.
      IF sy-subrc = 0.
        <fs_materiales>-maktx = <fs_makt>-maktx.
      ENDIF.

      READ TABLE tl_ztpi0014 ASSIGNING FIELD-SYMBOL(<fs_ztpi0014>) WITH KEY werks = <fs_materiales>-werks
                                                                            matkl = <fs_materiales>-matkl.
      IF sy-subrc = 0.
        <fs_materiales>-calidad = <fs_ztpi0014>-calidad.
      ENDIF.

      <fs_materiales>-valor_filtro = |{ <fs_materiales>-matnr }_{ <fs_materiales>-maktx }|.
    ENDLOOP.


  ENDMETHOD.
  METHOD parte_rebob_anular_nec.
    DATA(wl_centro)   = zcl_wm_nt_generic=>get_instance( )->centros_getdetail( vp_werks ).
    DATA(wl_maquina)  = zcl_wm_nt_generic=>get_instance( )->maquinas_getdetail( vp_id_maquina ).
    DATA(wl_parte_cab) = parte_rebob_cab_getdetail( vp_werks            = vp_werks
                                                    vp_id_maquina       = vp_id_maquina
                                                    vp_cod_parte_rebob  = vp_cod_parte_rebob ).

    DATA(tl_parte_bob_prod) = parte_rebob_bob_prod_getlist( vp_cod_parte_rebob           = vp_cod_parte_rebob
                                                            vp_id_maquina                = vp_id_maquina
                                                            vp_werks                     = vp_werks ).

    IF wl_parte_cab-menge_cons IS NOT INITIAL.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Ya se han realizado consumos. El parte no se puede anular' ).
    ENDIF.

    LOOP AT tl_parte_bob_prod ASSIGNING FIELD-SYMBOL(<fs_parte_bob_prod>).
      IF <fs_parte_bob_prod>-menge_prod IS NOT INITIAL.
        zcl_seis_odata_utils=>lanzar_excepcion( 'Ya se ha indicado produccin. El parte no se puede anular' ).
      ENDIF.
    ENDLOOP.


    "ZCL_SI_PROD_REPLENISHMENT_UI5, mtodo ZII_SI_PROD_REPLENISHMENT_UI5~SI_PROD_REPLENISHMENT_UI5
    DATA tl_ltbc TYPE TABLE OF ltbc.
    DATA tl_bapiret2 TYPE bapiret2_t.
    LOOP AT tl_parte_bob_prod ASSIGNING <fs_parte_bob_prod>.
      SELECT *
        FROM ltbp
        INTO CORRESPONDING FIELDS OF TABLE tl_ltbc
        WHERE lgnum = wl_centro-lgnum AND
              tbnum = <fs_parte_bob_prod>-tbnum.
      IF sy-subrc <> 0.
        zcl_seis_odata_utils=>lanzar_excepcion( |No se ha podido anular la necesidad { <fs_parte_bob_prod>-tbnum }| ).
      ENDIF.

      CALL FUNCTION 'L_TR_CANCEL'
        EXPORTING
          i_save_only_all      = 'X'
          i_commit_work        = space
        TABLES
          t_ltbc               = tl_ltbc
        EXCEPTIONS
          item_error           = 1
          no_update_item_error = 2
          no_update_no_entry   = 3
          tr_locked            = 4
          OTHERS               = 5.
      DATA(vl_subrc) = sy-subrc.
      LOOP AT tl_ltbc ASSIGNING FIELD-SYMBOL(<fs_ltbc>).
        IF <fs_ltbc>-msgty CA 'EA'.
          APPEND INITIAL LINE TO tl_bapiret2 ASSIGNING FIELD-SYMBOL(<fs_bapiret2>).
          <fs_bapiret2>-id          = <fs_ltbc>-msgid.
          <fs_bapiret2>-type        = <fs_ltbc>-msgty.
          <fs_bapiret2>-number      = <fs_ltbc>-msgno.
          <fs_bapiret2>-message_v1  = <fs_ltbc>-msgv1.
          <fs_bapiret2>-message_v2  = <fs_ltbc>-msgv2.
          <fs_bapiret2>-message_v3  = <fs_ltbc>-msgv3.
          <fs_bapiret2>-message_v4  = <fs_ltbc>-msgv4.
        ENDIF.
      ENDLOOP.
      IF tl_bapiret2 IS NOT INITIAL.
        zcl_seis_odata_utils=>lanzar_excepcion( bapiret2_t = tl_bapiret2 ).
      ELSEIF vl_subrc <> 0.
        zcl_seis_odata_utils=>lanzar_excepcion( ).
      ENDIF.

    ENDLOOP.


    tl_bapiret2 = zcl_wm_nt_generic=>delete_reserv( iv_rsnum  = wl_parte_cab-rsnum ).
    zcl_seis_odata_utils=>lanzar_excepcion( bapiret2_t = tl_bapiret2 ).

    LOOP AT tl_parte_bob_prod ASSIGNING <fs_parte_bob_prod>.
      DELETE FROM zwm_ltbk_adit
        WHERE lgnum = wl_centro-lgnum AND
              tbnum = <fs_parte_bob_prod>-tbnum.
    ENDLOOP.


    CLEAR wl_parte_cab-rsnum.
    UPDATE zwm_parte_reb_c
      SET rsnum       = wl_parte_cab-rsnum
          cla_tratado = space
      WHERE werks           = wl_parte_cab-werks      AND
            id_maquina      = wl_parte_cab-id_maquina AND
            cod_parte_rebob = wl_parte_cab-cod_parte_rebob.


    UPDATE zwm_parte_reb_bp
      SET tbnum = space
      WHERE werks           = wl_parte_cab-werks      AND
            id_maquina      = wl_parte_cab-id_maquina AND
            cod_parte_rebob = wl_parte_cab-cod_parte_rebob.


  ENDMETHOD.
  METHOD parte_rebob_bob_cons_create.

    IF wp_parte_rebob_bob_cons-contador IS INITIAL.
      SELECT MAX( contador )
        INTO wp_parte_rebob_bob_cons-contador
        FROM zwm_parte_reb_bc
        WHERE werks           = wp_parte_rebob_bob_cons-werks       AND
              id_maquina      = wp_parte_rebob_bob_cons-id_maquina  AND
              cod_parte_rebob = wp_parte_rebob_bob_cons-cod_parte_rebob.
      ADD 1 TO wp_parte_rebob_bob_cons-contador.
    ENDIF.

    wp_parte_rebob_bob_cons-ersda = sy-datum.
    wp_parte_rebob_bob_cons-erzet = sy-uzeit.
    wp_parte_rebob_bob_cons-ernam = sy-uname.


    DATA wl_zwm_parte_reb_bc TYPE zwm_parte_reb_bc.
    MOVE-CORRESPONDING wp_parte_rebob_bob_cons TO wl_zwm_parte_reb_bc.
    INSERT zwm_parte_reb_bc FROM wl_zwm_parte_reb_bc.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Error al crear el la bobina a consumir' ).
    ENDIF.

  ENDMETHOD.
  METHOD parte_rebob_bob_cons_delete.
    DELETE FROM zwm_parte_reb_bc
      WHERE werks           = wp_parte_rebob_bob_cons-werks           AND
            id_maquina      = wp_parte_rebob_bob_cons-id_maquina      AND
            cod_parte_rebob = wp_parte_rebob_bob_cons-cod_parte_rebob AND
            contador        = wp_parte_rebob_bob_cons-contador.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Error al borrar la bobina a consumir' ).
    ENDIF.
  ENDMETHOD.
  METHOD parte_rebob_bob_cons_getdetail.

    SELECT SINGLE *
      INTO CORRESPONDING FIELDS OF wp_parte_rebob_bob_cons
      FROM zwm_parte_reb_bc
      WHERE werks           = vp_werks            AND
            id_maquina      = vp_id_maquina       AND
            cod_parte_rebob = vp_cod_parte_rebob  AND
            contador        = vp_contador.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'La bobina a consumir es incorrecta' ).
    ENDIF.

  ENDMETHOD.
  METHOD parte_rebob_bob_cons_getlist.
    SELECT *
      INTO CORRESPONDING FIELDS OF TABLE tp_parte_rebob_bob_cons
      FROM zwm_parte_reb_bc
      WHERE werks           = vp_werks      AND
            id_maquina      = vp_id_maquina AND
            cod_parte_rebob = vp_cod_parte_rebob
      ORDER BY contador.
  ENDMETHOD.
  METHOD parte_rebob_bob_cons_update.
    DATA wl_zwm_parte_reb_bc TYPE zwm_parte_reb_bc.

    wp_parte_rebob_bob_cons-aedat = sy-datum.
    wp_parte_rebob_bob_cons-aezet = sy-uzeit.
    wp_parte_rebob_bob_cons-aenam = sy-uname.


    MOVE-CORRESPONDING wp_parte_rebob_bob_cons TO wl_zwm_parte_reb_bc.
    UPDATE zwm_parte_reb_bc FROM wl_zwm_parte_reb_bc.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Error al actualizar la bobina a consumir' ).
    ENDIF.
  ENDMETHOD.
  METHOD parte_rebob_bob_prod_create.
    validar_parte_rebob_bob_prod( wp_parte_rebob_bob_prod ).

    IF wp_parte_rebob_bob_prod-contador IS INITIAL.
      SELECT MAX( contador )
        INTO wp_parte_rebob_bob_prod-contador
        FROM zwm_parte_reb_bp
        WHERE werks           = wp_parte_rebob_bob_prod-werks       AND
              id_maquina      = wp_parte_rebob_bob_prod-id_maquina  AND
              cod_parte_rebob = wp_parte_rebob_bob_prod-cod_parte_rebob.
      ADD 1 TO wp_parte_rebob_bob_prod-contador.
    ENDIF.

    wp_parte_rebob_bob_prod-ersda = sy-datum.
    wp_parte_rebob_bob_prod-erzet = sy-uzeit.
    wp_parte_rebob_bob_prod-ernam = sy-uname.


    DATA wl_zwm_parte_reb_bp TYPE zwm_parte_reb_bp.
    MOVE-CORRESPONDING wp_parte_rebob_bob_prod TO wl_zwm_parte_reb_bp.
    INSERT zwm_parte_reb_bp FROM wl_zwm_parte_reb_bp.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Error al crear el la bobina a producir' ).
    ENDIF.

  ENDMETHOD.
  METHOD parte_rebob_bob_prod_delete.

    DATA(wl_maquina) = zcl_wm_nt_generic=>get_instance( )->maquinas_getdetail( wp_parte_rebob_bob_prod-id_maquina ).
    IF wl_maquina-parte_rebobinado = space.
      zcl_seis_odata_utils=>lanzar_excepcion( 'La mquina no utiliza partes de rebobinado' ).
    ENDIF.


    DATA(wl_parte_cab) = parte_rebob_cab_getdetail( vp_werks            = wp_parte_rebob_bob_prod-werks
                                                    vp_id_maquina       = wp_parte_rebob_bob_prod-id_maquina
                                                    vp_cod_parte_rebob  = wp_parte_rebob_bob_prod-cod_parte_rebob ).
    IF wl_parte_cab-cla_tratado = 'X'.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Parte tratado. No se puede borrar' ).
    ENDIF.


    DELETE FROM zwm_parte_reb_bp
      WHERE werks           = wp_parte_rebob_bob_prod-werks           AND
            id_maquina      = wp_parte_rebob_bob_prod-id_maquina      AND
            cod_parte_rebob = wp_parte_rebob_bob_prod-cod_parte_rebob AND
            contador        = wp_parte_rebob_bob_prod-contador.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Error al borrar la bobina a producir' ).
    ENDIF.
  ENDMETHOD.
  METHOD parte_rebob_bob_prod_getdetail.
    SELECT SINGLE *
      INTO CORRESPONDING FIELDS OF wp_parte_rebob_bob_prod
      FROM zwm_parte_reb_bp
      WHERE werks           = vp_werks            AND
            id_maquina      = vp_id_maquina       AND
            cod_parte_rebob = vp_cod_parte_rebob  AND
            contador        = vp_contador.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'La bobina a producir es incorrecta' ).
    ENDIF.

    DATA: tl_parte_rebob_bob_prod LIKE TABLE OF wp_parte_rebob_bob_prod.
    APPEND wp_parte_rebob_bob_prod TO tl_parte_rebob_bob_prod.
    parte_rebob_bobprod_getlist_ex( CHANGING tp_parte_rebob_bob_prod = tl_parte_rebob_bob_prod ).
    wp_parte_rebob_bob_prod = tl_parte_rebob_bob_prod[ 1 ].

  ENDMETHOD.
  METHOD parte_rebob_bob_prod_getlist.
    SELECT *
      INTO CORRESPONDING FIELDS OF TABLE tp_parte_rebob_bob_prod
      FROM zwm_parte_reb_bp
      WHERE werks           = vp_werks      AND
            id_maquina      = vp_id_maquina AND
            cod_parte_rebob = vp_cod_parte_rebob
      ORDER BY contador.

      parte_rebob_bobprod_getlist_ex( CHANGING tp_parte_rebob_bob_prod = tp_parte_rebob_bob_prod ).

  ENDMETHOD.
  METHOD parte_rebob_bob_prod_update.
    validar_parte_rebob_bob_prod( wp_parte_rebob_bob_prod ).

    DATA wl_zwm_parte_reb_bp TYPE zwm_parte_reb_bp.

    wp_parte_rebob_bob_prod-aedat = sy-datum.
    wp_parte_rebob_bob_prod-aezet = sy-uzeit.
    wp_parte_rebob_bob_prod-aenam = sy-uname.

    MOVE-CORRESPONDING wp_parte_rebob_bob_prod TO wl_zwm_parte_reb_bp.
    UPDATE zwm_parte_reb_bp FROM wl_zwm_parte_reb_bp.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Error al actualizar la bobina a producir' ).
    ENDIF.
  ENDMETHOD.
  METHOD parte_rebob_bobprod_getlist_ex.
    CHECK tp_parte_rebob_bob_prod IS NOT INITIAL.

    DATA(wl_parte_rebob_cab) = parte_rebob_cab_getdetail(
                               vp_cod_parte_rebob           = tp_parte_rebob_bob_prod[ 1 ]-cod_parte_rebob
                               vp_id_maquina                = tp_parte_rebob_bob_prod[ 1 ]-id_maquina
                               vp_werks                     = tp_parte_rebob_bob_prod[ 1 ]-werks ).

    LOOP AT tp_parte_rebob_bob_prod ASSIGNING FIELD-SYMBOL(<fs_parte_rebob_bob_prod>).
      DATA(wl_material) = materiales_getdetail( vp_werks = <fs_parte_rebob_bob_prod>-werks
                                                vp_matnr = <fs_parte_rebob_bob_prod>-matnr ).

      <fs_parte_rebob_bob_prod>-maktx       = wl_material-maktx.
      <fs_parte_rebob_bob_prod>-zzancho     = wl_material-zzancho.
      <fs_parte_rebob_bob_prod>-cla_tratado = wl_parte_rebob_cab-cla_tratado.

      IF <fs_parte_rebob_bob_prod>-lenum IS NOT INITIAL.
        TRY.
            DATA(wl_ua) = unidades_almacen_getdetail(
                      vp_werks                     =  <fs_parte_rebob_bob_prod>-werks
                      vp_lenum                     =  <fs_parte_rebob_bob_prod>-lenum ).
            <fs_parte_rebob_bob_prod>-lgpla = wl_ua-lgpla.
            <fs_parte_rebob_bob_prod>-ltypt = wl_ua-ltypt.
          CATCH /iwbep/cx_mgw_busi_exception.
        ENDTRY.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.
  METHOD parte_rebob_cab_create.
    validar_parte_rebob_cab( wp_parte_rebob_cab ).

    IF wp_parte_rebob_cab-cod_parte_rebob IS INITIAL.
      SELECT MAX( cod_parte_rebob )
        INTO wp_parte_rebob_cab-cod_parte_rebob
        FROM zwm_parte_reb_c
        WHERE werks       = wp_parte_rebob_cab-werks AND
              id_maquina  = wp_parte_rebob_cab-id_maquina.
      ADD 1 TO wp_parte_rebob_cab-cod_parte_rebob.
    ENDIF.

    DATA(wl_ua) = unidades_almacen_getdetail( vp_werks = wp_parte_rebob_cab-werks
                                              vp_lenum = wp_parte_rebob_cab-bobina_cons ).

    wp_parte_rebob_cab-matnr = wl_ua-matnr.
    wp_parte_rebob_cab-menge = wl_ua-verme.
    wp_parte_rebob_cab-meins = wl_ua-meins.
    wp_parte_rebob_cab-lgpla = wl_ua-lgpla.
    wp_parte_rebob_cab-lgtyp = wl_ua-lgtyp.
    wp_parte_rebob_cab-lgnum = wl_ua-lgnum.
    wp_parte_rebob_cab-lifnr = wl_ua-lifnr.

    wp_parte_rebob_cab-ersda = sy-datum.
    wp_parte_rebob_cab-erzet = sy-uzeit.
    wp_parte_rebob_cab-ernam = sy-uname.

    DATA wl_zwm_parte_reb_c TYPE zwm_parte_reb_c.
    MOVE-CORRESPONDING wp_parte_rebob_cab TO wl_zwm_parte_reb_c.
    INSERT zwm_parte_reb_c FROM wl_zwm_parte_reb_c.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Error al crear el parte de rebobinado' ).
    ENDIF.

  ENDMETHOD.
  METHOD parte_rebob_cab_delete.

    DATA(wl_parte_cab) = parte_rebob_cab_getdetail( vp_werks            = wp_parte_rebob_cab-werks
                                                    vp_id_maquina       = wp_parte_rebob_cab-id_maquina
                                                    vp_cod_parte_rebob  = wp_parte_rebob_cab-cod_parte_rebob ).
    IF wl_parte_cab-cla_tratado = 'X'.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Parte tratado. No se puede borrar' ).
    ENDIF.

    DELETE FROM zwm_parte_reb_bc
      WHERE werks           = wp_parte_rebob_cab-werks AND
            id_maquina      = wp_parte_rebob_cab-id_maquina AND
            cod_parte_rebob = wp_parte_rebob_cab-cod_parte_rebob.

    DELETE FROM zwm_parte_reb_bp
      WHERE werks           = wp_parte_rebob_cab-werks AND
            id_maquina      = wp_parte_rebob_cab-id_maquina AND
            cod_parte_rebob = wp_parte_rebob_cab-cod_parte_rebob.


    DELETE FROM zwm_parte_reb_c
      WHERE werks           = wp_parte_rebob_cab-werks AND
            id_maquina      =  wp_parte_rebob_cab-id_maquina AND
            cod_parte_rebob = wp_parte_rebob_cab-cod_parte_rebob.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Error al borrar el parte de rebobinado' ).
    ENDIF.


  ENDMETHOD.
  METHOD parte_rebob_cab_getdetail.

    SELECT SINGLE zwm_parte_reb_c~*, lfa1~name1, t301t~ltypt
      INTO CORRESPONDING FIELDS OF @wp_parte_rebob_cab
      FROM zwm_parte_reb_c LEFT OUTER JOIN lfa1   ON lfa1~lifnr = zwm_parte_reb_c~lifnr
                           LEFT OUTER JOIN t301t  ON t301t~spras = @sy-langu              AND
                                                     t301t~lgnum = zwm_parte_reb_c~lgnum  AND
                                                     t301t~lgtyp = zwm_parte_reb_c~lgtyp
      WHERE zwm_parte_reb_c~werks           = @vp_werks      AND
            zwm_parte_reb_c~id_maquina      = @vp_id_maquina AND
            zwm_parte_reb_c~cod_parte_rebob = @vp_cod_parte_rebob.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'El parte de rebobinado es incorrecto' ).
    ENDIF.


    DATA tl_parte_rebob_cab LIKE TABLE OF wp_parte_rebob_cab.
    APPEND wp_parte_rebob_cab TO tl_parte_rebob_cab.
    parte_rebob_cab_getlist_ext( CHANGING tp_parte_rebob_cab  = tl_parte_rebob_cab ).
    wp_parte_rebob_cab = tl_parte_rebob_cab[ 1 ].
  ENDMETHOD.
  METHOD parte_rebob_cab_getlist.

    SELECT zwm_parte_reb_c~*, lfa1~name1, t301t~ltypt
      INTO CORRESPONDING FIELDS OF TABLE @tp_parte_rebob_cab
      FROM zwm_parte_reb_c LEFT OUTER JOIN lfa1   ON lfa1~lifnr = zwm_parte_reb_c~lifnr
                           LEFT OUTER JOIN t301t  ON t301t~spras = @sy-langu              AND
                                                     t301t~lgnum = zwm_parte_reb_c~lgnum  AND
                                                     t301t~lgtyp = zwm_parte_reb_c~lgtyp
      WHERE zwm_parte_reb_c~werks           = @vp_werks      AND
            zwm_parte_reb_c~id_maquina      = @vp_id_maquina
      ORDER BY cla_cerrado, prioridad, num_orden.


    parte_rebob_cab_getlist_ext( CHANGING tp_parte_rebob_cab  =   tp_parte_rebob_cab ).
  ENDMETHOD.
  METHOD parte_rebob_cab_getlist_ext.
    CHECK tp_parte_rebob_cab IS NOT INITIAL.


    LOOP AT tp_parte_rebob_cab ASSIGNING FIELD-SYMBOL(<fs_parte_rebob_cab>).

      DATA(wl_material) = materiales_getdetail( vp_werks = <fs_parte_rebob_cab>-werks
                                                vp_matnr = <fs_parte_rebob_cab>-matnr ).
      <fs_parte_rebob_cab>-maktx = wl_material-maktx.
      <fs_parte_rebob_cab>-ancho = wl_material-zzancho.

      <fs_parte_rebob_cab>-campo_filtro = |{ <fs_parte_rebob_cab>-cod_parte_rebob }_{ <fs_parte_rebob_cab>-bobina_cons }|.
    ENDLOOP.


    "Cantidad consumida
    SELECT charg, matnr, werks, nlenr
      INTO TABLE @DATA(tl_ltap)
      FROM ltap
      FOR ALL ENTRIES IN @tp_parte_rebob_cab
      WHERE matnr = @tp_parte_rebob_cab-matnr AND
            werks = @tp_parte_rebob_cab-werks AND
            nlenr = @tp_parte_rebob_cab-bobina_cons.

    LOOP AT tp_parte_rebob_cab ASSIGNING <fs_parte_rebob_cab>.
      READ TABLE tl_ltap ASSIGNING FIELD-SYMBOL(<fs_ltap>) WITH KEY matnr = <fs_parte_rebob_cab>-matnr
                                                                    werks = <fs_parte_rebob_cab>-werks
                                                                    nlenr = <fs_parte_rebob_cab>-bobina_cons.
      IF sy-subrc = 0.
        SELECT werks, matnr, charg, meins, SUM( menge ) AS menge
          INTO TABLE @DATA(tl_mseg)
          FROM mseg
          WHERE matnr = @<fs_ltap>-matnr AND
                werks = @<fs_ltap>-werks AND
                charg = @<fs_ltap>-charg AND
                bwart = '291'
          GROUP BY werks, matnr, charg, meins.
        LOOP AT tl_mseg ASSIGNING FIELD-SYMBOL(<fs_mseg>).
          IF <fs_mseg>-meins <> <fs_parte_rebob_cab>-meins.
            CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
              EXPORTING
                i_matnr              = <fs_mseg>-matnr
                i_in_me              = <fs_mseg>-meins
                i_out_me             = <fs_parte_rebob_cab>-meins
                i_menge              = <fs_mseg>-menge
              IMPORTING
                e_menge              = <fs_mseg>-menge
              EXCEPTIONS
                error_in_application = 1
                error                = 2
                OTHERS               = 3.
            IF sy-subrc <> 0.
              CLEAR <fs_mseg>-menge.
            ENDIF.
            <fs_mseg>-meins = <fs_parte_rebob_cab>-meins.
          ENDIF.
          ADD <fs_mseg>-menge TO <fs_parte_rebob_cab>-menge_cons.
        ENDLOOP.
      ENDIF.
    ENDLOOP.


  ENDMETHOD.
  METHOD parte_rebob_cab_update.
    validar_parte_rebob_cab( wp_parte_rebob_cab ).

    wp_parte_rebob_cab-aedat = sy-datum.
    wp_parte_rebob_cab-aezet = sy-uzeit.
    wp_parte_rebob_cab-aenam = sy-uname.

    DATA(wl_ua) = unidades_almacen_getdetail( vp_werks = wp_parte_rebob_cab-werks
                                              vp_lenum = wp_parte_rebob_cab-bobina_cons ).
    wp_parte_rebob_cab-matnr = wl_ua-matnr.
    wp_parte_rebob_cab-menge = wl_ua-verme.
    wp_parte_rebob_cab-meins = wl_ua-meins.
    wp_parte_rebob_cab-lgpla = wl_ua-lgpla.
    wp_parte_rebob_cab-lgtyp = wl_ua-lgtyp.
    wp_parte_rebob_cab-lgnum = wl_ua-lgnum.
    wp_parte_rebob_cab-lifnr = wl_ua-lifnr.

    DATA wl_zwm_parte_reb_c TYPE zwm_parte_reb_c.
    MOVE-CORRESPONDING wp_parte_rebob_cab TO wl_zwm_parte_reb_c.

    UPDATE zwm_parte_reb_c FROM wl_zwm_parte_reb_c.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Error al actualizar el parte de rebobinado' ).
    ENDIF.

  ENDMETHOD.
  METHOD parte_rebob_cerrar_parte.
    DATA(wl_parte_cab) = parte_rebob_cab_getdetail( vp_werks            = vp_werks
                                                    vp_id_maquina       = vp_id_maquina
                                                    vp_cod_parte_rebob  = vp_cod_parte_rebob ).

    IF wl_parte_cab-cla_cerrado = 'X'.
      zcl_seis_odata_utils=>lanzar_excepcion( 'El parte ya est cerrado' ).
    ENDIF.

    UPDATE zwm_parte_reb_c
      SET cla_cerrado = 'X'
      WHERE werks           = vp_werks      AND
            id_maquina      = vp_id_maquina AND
            cod_parte_rebob = vp_cod_parte_rebob.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Error al cerrar el parte' ).
    ENDIF.


    TRY.
        parte_rebob_anular_nec( vp_cod_parte_rebob           =  vp_cod_parte_rebob
                                vp_id_maquina                =  vp_id_maquina
                                vp_werks                     =  vp_werks ).


      CATCH /iwbep/cx_mgw_busi_exception.
    ENDTRY.




  ENDMETHOD.
  METHOD parte_rebob_generar_nec.
    "Validacin. Pasando de los warnings (que nos vienen den la tabla de retorno)
    parte_rebob_valid_generar_nec( vp_werks            = vp_werks
                                   vp_id_maquina       = vp_id_maquina
                                   vp_cod_parte_rebob  = vp_cod_parte_rebob ).

    DATA(wl_centro)   = zcl_wm_nt_generic=>get_instance( )->centros_getdetail( vp_werks ).
    DATA(wl_maquina)  = zcl_wm_nt_generic=>get_instance( )->maquinas_getdetail( vp_id_maquina ).
    DATA(wl_parte_cab) = parte_rebob_cab_getdetail( vp_werks            = vp_werks
                                                    vp_id_maquina       = vp_id_maquina
                                                    vp_cod_parte_rebob  = vp_cod_parte_rebob ).

    DATA(tl_parte_bob_prod) = parte_rebob_bob_prod_getlist( vp_cod_parte_rebob           = vp_cod_parte_rebob
                                                            vp_id_maquina                = vp_id_maquina
                                                            vp_werks                     = vp_werks ).

    "Me haba basado en este
    "ZCL_SI_OMP_PROD_REP_IN_OMP_TO, mtodo ZII_SI_PROD_REPLENISHMENT_UI5~SI_PROD_REPLENISHMENT_UI5

    "Pero creo que ser este en realidad
    "ZCL_SI_PROD_REPLENISHMENT_UI5, mtodo ZII_SI_PROD_REPLENISHMENT_UI5~SI_PROD_REPLENISHMENT_UI5

    """"""""""""""""""""
    "Definir datos y constantes
    """"""""""""""""""""
    DATA: tl_bapiret2 TYPE TABLE OF bapiret2,
          tl_ltba     TYPE TABLE OF ltba.
    DATA vl_aufnr TYPE aufnr.
    DATA vl_lgort TYPE lgort_d.
    DATA vl_bwart TYPE bwlvs.
    DATA wl_zwm_ltbk_adit TYPE zwm_ltbk_adit.


    "TODO JCB: Quitar estor hardcodes
    SELECT SINGLE valor1
      INTO vl_aufnr
      FROM ztwm001
      WHERE cprog   = 'INTF_OMP_SCY' AND
            param1  = 'AUFNR'        AND
            param2  = '01'.

    SELECT SINGLE valor1
      INTO @DATA(vl_valor1)
      FROM ztwm001
      WHERE cprog   = 'INTF_OMP_SCY' AND
            param1  = 'BWART'        AND
            param2  = '01'.
    IF sy-subrc = 0.
      vl_bwart = vl_valor1.
    ELSE.
      vl_bwart = '919'.
    ENDIF.

    vl_lgort = wl_centro-lgort.



    """"""""""""""""""""
    "CREAR RESERVA: Bobina a consumir
    """"""""""""""""""""
    DATA wl_reservation_header TYPE  bapi2093_res_head.

    wl_reservation_header-move_type = zcl_wm_constants=>gc_bwart_291.
    wl_reservation_header-orderid   = vl_aufnr.
    wl_reservation_header-res_date  = sy-datum.

    " must convert to KG
    DATA vl_menge_kg TYPE menge_d.
    CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
      EXPORTING
        i_matnr              = wl_parte_cab-matnr
        i_in_me              = wl_parte_cab-meins
        i_out_me             = 'KG'
        i_menge              = wl_parte_cab-menge
      IMPORTING
        e_menge              = vl_menge_kg
      EXCEPTIONS
        error_in_application = 1
        error                = 2
        OTHERS               = 3.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( ).
    ENDIF.

    DATA tl_reservation_items TYPE TABLE OF bapi2093_res_item.
    APPEND INITIAL LINE TO tl_reservation_items ASSIGNING FIELD-SYMBOL(<fs_reservation_items>).
    <fs_reservation_items>-material   = wl_parte_cab-matnr.
    <fs_reservation_items>-plant      = wl_parte_cab-werks.
    <fs_reservation_items>-stge_loc   = vl_lgort.
    <fs_reservation_items>-entry_qnt  = vl_menge_kg.
    <fs_reservation_items>-entry_uom  = 'KG'.
    <fs_reservation_items>-movement   = abap_true.
    <fs_reservation_items>-item_text  = tl_parte_bob_prod[ 1 ]-cod_parte_rebob && tl_parte_bob_prod[ 1 ]-contador.

    DATA: tl_profit TYPE TABLE OF bapi_profitability_segment,
          vl_rsnum  TYPE bapi2093_res_key-reserv_no.
    CALL FUNCTION 'BAPI_RESERVATION_CREATE1'
      EXPORTING
        reservationheader    = wl_reservation_header
      IMPORTING
        reservation          = vl_rsnum
      TABLES
        reservationitems     = tl_reservation_items
        profitabilitysegment = tl_profit
        return               = tl_bapiret2.

    zcl_seis_odata_utils=>lanzar_excepcion( bapiret2_t = tl_bapiret2 ).



    """"""""""""""""""""
    "CREAR NTs: Bobina/s a producir
    """"""""""""""""""""
    LOOP AT tl_parte_bob_prod ASSIGNING FIELD-SYMBOL(<fs_parte_bob_prod>).
      CLEAR tl_ltba. APPEND INITIAL LINE TO tl_ltba ASSIGNING FIELD-SYMBOL(<fs_ltba>).
      <fs_ltba>-werks = <fs_parte_bob_prod>-werks.
      <fs_ltba>-lgnum = wl_centro-lgnum.
      <fs_ltba>-rsnum = vl_rsnum.
      <fs_ltba>-matnr = <fs_parte_bob_prod>-matnr.
      <fs_ltba>-nlpla = <fs_parte_bob_prod>-id_maquina.
      <fs_ltba>-nltyp = wl_maquina-lgtyp.

      <fs_ltba>-pdatu = wl_parte_cab-fecha_estimada.

      "Cantidad a producir. Lo tomamos de la cantidad de la bobina de consumo
      "Asumimos que los metros producidos son los mismos que los de la bobina a consumir
      <fs_ltba>-menga = wl_parte_cab-menge.
      <fs_ltba>-altme = wl_parte_cab-meins.
      <fs_ltba>-lgort = vl_lgort.
      <fs_ltba>-bwlvs = vl_bwart.
      <fs_ltba>-betyp = 'O'.

      "BENUM corresponde a CI_NUMBER. Ponemos la clave de la lnea
      <fs_ltba>-benum = <fs_parte_bob_prod>-cod_parte_rebob && <fs_parte_bob_prod>-contador.
      <fs_ltba>-tbktx = wl_parte_cab-notas.
      "Nmero adicional de ref. a transporte (LZNUM). Char 20. Es una concatenacin de atributos del material
      DATA(wl_material) = materiales_getdetail( vp_werks  = <fs_parte_bob_prod>-werks
                                                vp_matnr  = <fs_parte_bob_prod>-matnr ).
*      <fs_ltba>-lznum = |{ wl_material-zzancho }/{ <fs_ltba>-benum }|.
      <fs_ltba>-lznum = |{ wl_material-zzancho }/{ wl_material-calidad }|.


      CALL FUNCTION 'L_TR_CREATE'
        EXPORTING
          i_single_item         = 'X'
          i_save_only_all       = 'X'
        TABLES
          t_ltba                = tl_ltba
        EXCEPTIONS
          item_error            = 1
          no_entry_in_int_table = 2
          item_without_number   = 3
          no_update_item_error  = 4
          OTHERS                = 5.
      DATA(vl_subrc) = sy-subrc.

      READ TABLE tl_ltba ASSIGNING <fs_ltba> INDEX 1.
      IF vl_subrc = 0.
        <fs_parte_bob_prod>-tbnum = <fs_ltba>-tbnum.
      ELSEIF <fs_ltba>-msgid IS NOT INITIAL.
        APPEND INITIAL LINE TO tl_bapiret2 ASSIGNING FIELD-SYMBOL(<fs_bapiret2>).
        <fs_bapiret2>-id          = <fs_ltba>-msgid.
        <fs_bapiret2>-number      = <fs_ltba>-msgno.
        <fs_bapiret2>-type        = 'E'.
        <fs_bapiret2>-message_v1  = <fs_ltba>-msgv1.
        <fs_bapiret2>-message_v2  = <fs_ltba>-msgv2.
        <fs_bapiret2>-message_v3  = <fs_ltba>-msgv3.
        <fs_bapiret2>-message_v4  = <fs_ltba>-msgv4.

        CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
        zcl_seis_odata_utils=>lanzar_excepcion( bapiret2_t = tl_bapiret2 ).
      ELSE.
        CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
        zcl_seis_odata_utils=>lanzar_excepcion(  ).
      ENDIF.

      parte_rebob_bob_prod_update( CHANGING wp_parte_rebob_bob_prod = <fs_parte_bob_prod> ).


      CLEAR wl_zwm_ltbk_adit.
      wl_zwm_ltbk_adit-lgnum = <fs_ltba>-lgnum.
      wl_zwm_ltbk_adit-tbnum = <fs_ltba>-tbnum.
      wl_zwm_ltbk_adit-benum = <fs_ltba>-benum.
      wl_zwm_ltbk_adit-fsc      = space.
      wl_zwm_ltbk_adit-cliente  = space.
      wl_zwm_ltbk_adit-cliente2 = space.
      wl_zwm_ltbk_adit-texto    = wl_parte_cab-notas.
      wl_zwm_ltbk_adit-nlpla    = <fs_ltba>-nlpla.
      wl_zwm_ltbk_adit-menge    = <fs_ltba>-menga.
      wl_zwm_ltbk_adit-meins    = <fs_ltba>-altme.
      INSERT zwm_ltbk_adit FROM wl_zwm_ltbk_adit.

    ENDLOOP.


    wl_parte_cab-rsnum       = vl_rsnum.
    wl_parte_cab-cla_tratado = 'X'.
    parte_rebob_cab_update( CHANGING wp_parte_rebob_cab = wl_parte_cab ).
  ENDMETHOD.
  METHOD parte_rebob_reabrir_parte.
    DATA(wl_parte_cab) = parte_rebob_cab_getdetail( vp_werks            = vp_werks
                                                    vp_id_maquina       = vp_id_maquina
                                                    vp_cod_parte_rebob  = vp_cod_parte_rebob ).

    IF wl_parte_cab-cla_cerrado = space.
      zcl_seis_odata_utils=>lanzar_excepcion( 'El parte ya est abierto' ).
    ENDIF.

    UPDATE zwm_parte_reb_c
      SET cla_cerrado = space
      WHERE werks           = vp_werks      AND
            id_maquina      = vp_id_maquina AND
            cod_parte_rebob = vp_cod_parte_rebob.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Error al reabrir el parte' ).
    ENDIF.
  ENDMETHOD.
  METHOD parte_rebob_valid_generar_nec.

    DATA(wl_maquina) = zcl_wm_nt_generic=>get_instance( )->maquinas_getdetail( vp_id_maquina ).
    IF wl_maquina-parte_rebobinado = space.
      zcl_seis_odata_utils=>lanzar_excepcion( 'La mquina no utiliza partes de rebobinado' ).
    ENDIF.


    DATA(wl_parte_cab) = parte_rebob_cab_getdetail( vp_werks            = vp_werks
                                                    vp_id_maquina       = vp_id_maquina
                                                    vp_cod_parte_rebob  = vp_cod_parte_rebob ).

    DATA(tl_parte_bob_prod) = parte_rebob_bob_prod_getlist( vp_cod_parte_rebob           = vp_cod_parte_rebob
                                                            vp_id_maquina                = vp_id_maquina
                                                            vp_werks                     = vp_werks ).

    DATA: vl_ancho TYPE menge_d.
    DATA: vl_ancho_bobinas_prod TYPE menge_d.
    vl_ancho = wl_parte_cab-ancho.

    LOOP AT tl_parte_bob_prod ASSIGNING FIELD-SYMBOL(<fs_parte_bob_prod>).
      ADD <fs_parte_bob_prod>-zzancho TO vl_ancho_bobinas_prod.
    ENDLOOP.

    IF wl_parte_cab-cla_tratado = 'X'.
      zcl_seis_odata_utils=>lanzar_excepcion( 'El parte ya ha sido tratado' ).
    ENDIF.


    IF vl_ancho < vl_ancho_bobinas_prod.
      zcl_seis_odata_utils=>lanzar_excepcion( 'El ancho de las bobinas a producir es superior a la bobina origen' ).
    ELSEIF vl_ancho > vl_ancho_bobinas_prod.
      APPEND INITIAL LINE TO tp_return ASSIGNING FIELD-SYMBOL(<fs_return>).
      <fs_return>-type = 'W'. <fs_return>-message = 'El ancho de las bobinas a producir es inferior a la bobina origen'.
    ENDIF.



  ENDMETHOD.
  method PARTESREBOBBOB01_CREATE_ENTITY.
    io_data_provider->read_entry_data( IMPORTING es_data = er_entity ).
    parte_rebob_bob_prod_create( CHANGING wp_parte_rebob_bob_prod = er_entity ).
  endmethod.
  METHOD partesrebobbob01_delete_entity.
    DATA: wl_entity TYPE zwm_nt_ui5_s_parte_rebob_bob_p.
    io_tech_request_context->get_converted_keys( IMPORTING es_key_values  = wl_entity ).
    parte_rebob_bob_prod_delete( wl_entity ).
  ENDMETHOD.
  METHOD partesrebobbob01_get_entity.
    tratar_key_entity( EXPORTING io_tech_request_context = io_tech_request_context
                       IMPORTING wp_entity               = er_entity ).
    er_entity = parte_rebob_bob_prod_getdetail( vp_werks           = er_entity-werks
                                                vp_id_maquina      = er_entity-id_maquina
                                                vp_cod_parte_rebob = er_entity-cod_parte_rebob
                                                vp_contador        = er_entity-contador ).
  ENDMETHOD.
  METHOD partesrebobbob01_get_entityset.
    DATA wl_entity LIKE LINE OF et_entityset.
    tratar_key_entityset( EXPORTING io_tech_request_context = io_tech_request_context
                          IMPORTING wp_entity               = wl_entity ).

    et_entityset =  parte_rebob_bob_prod_getlist( vp_cod_parte_rebob = wl_entity-cod_parte_rebob
                                                  vp_id_maquina      = wl_entity-id_maquina
                                                  vp_werks           = wl_entity-werks ).

    zcl_seis_odata_utils=>tratar_entityset( EXPORTING io_tech_request_context  = io_tech_request_context
                                            CHANGING et_entityset = et_entityset ).


  ENDMETHOD.
  method PARTESREBOBBOB01_UPDATE_ENTITY.
    io_data_provider->read_entry_data( IMPORTING es_data = er_entity ).
    parte_rebob_bob_prod_update( CHANGING wp_parte_rebob_bob_prod = er_entity ).
  endmethod.
  method PARTESREBOBBOBCO_CREATE_ENTITY.
    io_data_provider->read_entry_data( IMPORTING es_data = er_entity ).
    parte_rebob_bob_cons_create( CHANGING wp_parte_rebob_bob_cons = er_entity ).
  endmethod.
  METHOD partesrebobbobco_delete_entity.
    DATA: wl_entity TYPE zwm_nt_ui5_s_parte_rebob_bob_c.
    io_tech_request_context->get_converted_keys( IMPORTING es_key_values  = wl_entity ).
    parte_rebob_bob_cons_delete( wl_entity ).
  ENDMETHOD.
  method PARTESREBOBBOBCO_GET_ENTITY.
    tratar_key_entity( EXPORTING io_tech_request_context = io_tech_request_context
                       IMPORTING wp_entity               = er_entity ).
    er_entity = parte_rebob_bob_cons_getdetail( vp_werks           = er_entity-werks
                                                vp_id_maquina      = er_entity-id_maquina
                                                vp_cod_parte_rebob = er_entity-cod_parte_rebob
                                                vp_contador        = er_entity-contador ).
  endmethod.
  METHOD partesrebobbobco_get_entityset.
    DATA wl_entity LIKE LINE OF et_entityset.
    tratar_key_entityset( EXPORTING io_tech_request_context = io_tech_request_context
                          IMPORTING wp_entity               = wl_entity ).

    et_entityset =  parte_rebob_bob_cons_getlist( vp_cod_parte_rebob = wl_entity-cod_parte_rebob
                                                  vp_id_maquina      = wl_entity-id_maquina
                                                  vp_werks           = wl_entity-werks ).

    zcl_seis_odata_utils=>tratar_entityset( EXPORTING io_tech_request_context  = io_tech_request_context
                                            CHANGING et_entityset = et_entityset ).
  ENDMETHOD.
  method PARTESREBOBBOBCO_UPDATE_ENTITY.
    io_data_provider->read_entry_data( IMPORTING es_data = er_entity ).
    parte_rebob_bob_cons_update( CHANGING wp_parte_rebob_bob_cons = er_entity ).
  endmethod.
  method PARTESREBOBCAB_CREATE_ENTITY.
    io_data_provider->read_entry_data( IMPORTING es_data = er_entity ).
    parte_rebob_cab_create( CHANGING wp_parte_rebob_Cab = er_entity ).
  endmethod.
  method PARTESREBOBCAB_DELETE_ENTITY.
    DATA: wl_entity TYPE zwm_nt_ui5_s_parte_rebob_cab.
    io_tech_request_context->get_converted_keys( IMPORTING es_key_values  = wl_entity ).
    parte_rebob_cab_delete( wl_entity ).
  endmethod.
  method PARTESREBOBCAB_GET_ENTITY.
    tratar_key_entity( EXPORTING io_tech_request_context = io_tech_request_context
                       IMPORTING wp_entity               = er_entity ).
    er_entity = parte_rebob_cab_getdetail( vp_werks           = er_entity-werks
                                           vp_id_maquina      = er_entity-id_maquina
                                           vp_cod_parte_rebob = er_entity-cod_parte_rebob ).
  endmethod.
  METHOD partesrebobcab_get_entityset.
    DATA wl_entity LIKE LINE OF et_entityset.
    tratar_key_entityset( EXPORTING io_tech_request_context = io_tech_request_context
                          IMPORTING wp_entity               = wl_entity ).

    et_entityset =  parte_rebob_cab_getlist( vp_id_maquina = wl_entity-id_maquina
                                             vp_werks      = wl_entity-werks ).

    zcl_seis_odata_utils=>tratar_entityset( EXPORTING io_tech_request_context  = io_tech_request_context
                                            CHANGING et_entityset = et_entityset ).

  ENDMETHOD.
  METHOD partesrebobcab_update_entity.
    io_data_provider->read_entry_data( IMPORTING es_data = er_entity ).
    parte_rebob_cab_update( CHANGING wp_parte_rebob_cab = er_entity ).
  ENDMETHOD.
  METHOD regularizar_ua.
    DATA(rl_consumos_imp) = NEW zcl_zui5_wm_consumos_dpc_imp( ).
    wp_return = rl_consumos_imp->regularizar_ua( vp_werks       = vp_werks
                                                 vp_lgpla       = vp_lgpla
                                                 vp_ua          = vp_ua
                                                 vp_menge       = vp_menge
                                                 vp_meins       = vp_meins
                                                 vp_cla_aprov   = 'X' ).


  ENDMETHOD.
  METHOD tratar_key_entity.


    DATA(vl_source_entity_type_name)  = io_tech_request_context->get_source_entity_type_name( ).
    DATA(vl_entity_type_name)         = io_tech_request_context->get_entity_type_name( ).


    CASE vl_source_entity_type_name.
*      WHEN 'AlbaranesCab'.
*        DATA wl_albaranes_cab TYPE zmm_ui5_s_albaranes_cab.
*        io_tech_request_context->get_converted_source_keys( IMPORTING es_key_values  = wl_albaranes_cab ).
*        wl_albaranes_cab = albaranes_cab_getdetail(
*                              vp_werks         = wl_albaranes_cab-werks
*                              vp_contador      = wl_albaranes_cab-contador
*                              vp_posicion_alb  = wl_albaranes_cab-posicion_alb ).
*        MOVE-CORRESPONDING wl_albaranes_cab TO wp_entity.
*
      WHEN OTHERS.
        io_tech_request_context->get_converted_keys( IMPORTING es_key_values  = wp_entity ).
    ENDCASE.

  ENDMETHOD.
  METHOD tratar_key_entityset.
    DATA(vl_source_entity_type_name)  = io_tech_request_context->get_source_entity_type_name( ).
    DATA(vl_entity_type_name)         = io_tech_request_context->get_entity_type_name( ).

    CASE vl_source_entity_type_name.
      WHEN 'Maquinas'.
        DATA wl_maquina TYPE zwm_nt_ui5_maquinas_str.
        io_tech_request_context->get_converted_source_keys( IMPORTING es_key_values  = wl_maquina ).
        wl_maquina = zcl_wm_nt_generic=>get_instance( )->maquinas_getdetail( wl_maquina-id ).
        MOVE-CORRESPONDING wl_maquina TO wp_entity.

        IF vl_entity_type_name = 'PartesRebobCab'.
          ASSIGN COMPONENT 'ID_MAQUINA' OF STRUCTURE wp_entity TO FIELD-SYMBOL(<fs_id_maquina>).
          <fs_id_maquina> = wl_maquina-id.
        ENDIF.

      WHEN 'GruposMaquinas'.
        io_tech_request_context->get_converted_source_keys( IMPORTING es_key_values  = wp_entity ).

      WHEN OTHERS.
        io_tech_request_context->get_converted_source_keys( IMPORTING es_key_values  = wp_entity ).
    ENDCASE.


  ENDMETHOD.
  METHOD tvarvcset_get_entity.
    IF lines( it_key_tab ) = 0.
      RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
        EXPORTING
          textid = VALUE #( msgid = 'ZUI5' msgno = '001' ).
    ENDIF.
    TRY.
        DATA(lv_name) = CONV tvarvc-name( it_key_tab[ name = 'Name' ]-value ).
        DATA(lv_type) = CONV tvarvc-type( it_key_tab[ name = 'Type' ]-value ).
        DATA(lv_numb) = CONV tvarvc-numb( it_key_tab[ name = 'Numb' ]-value ).
      CATCH cx_root.
        RAISE EXCEPTION TYPE /iwbep/cx_mgw_tech_exception
          EXPORTING
            textid = VALUE #( msgid = 'ZUI5' msgno = '001' ).

    ENDTRY.

    SELECT SINGLE * FROM tvarvc INTO CORRESPONDING FIELDS OF er_entity
      WHERE name = lv_name AND type = lv_type AND numb = lv_numb.


  ENDMETHOD.
  METHOD tvarvcset_get_entityset.

    SELECT * FROM tvarvc UP TO 10 ROWS
      INTO CORRESPONDING FIELDS OF TABLE et_entityset
      WHERE (iv_filter_string).
  ENDMETHOD.
  METHOD ubicaciones_getdetail.


    wp_ubicacion-werks = vp_werks.
    DATA(vl_lgnum) = zcl_wm_nt_generic=>get_instance( )->get_lgnum( iv_werks = vp_werks ).

    SELECT SINGLE lgnum, lgpla, lgtyp
      INTO CORRESPONDING FIELDS OF @wp_ubicacion
      FROM lagp
      WHERE lgnum = @vl_lgnum AND
            lgpla = @vp_lgpla.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'No se ha encontrado la ubicacin' ).
    ENDIF.



    DATA: tl_ubicacion LIKE TABLE OF wp_ubicacion.
    APPEND wp_ubicacion TO tl_ubicacion.
    ubicaciones_getlist_ext( CHANGING tp_ubicacion = tl_ubicacion ).
    wp_ubicacion = tl_ubicacion[ 1 ].


  ENDMETHOD.
  METHOD ubicaciones_getlist.

    DATA(vl_lgnum) = zcl_wm_nt_generic=>get_instance( )->get_lgnum( iv_werks = vp_werks ).


    SELECT lgnum, lgpla, lgtyp, @vp_werks AS werks
      INTO CORRESPONDING FIELDS OF TABLE @tp_ubicacion
      FROM lagp
      WHERE lgnum = @vl_lgnum.



    ubicaciones_getlist_ext( CHANGING tp_ubicacion = tp_ubicacion ).

  ENDMETHOD.
  METHOD ubicaciones_getlist_ext.


    CHECK tp_ubicacion IS NOT INITIAL.

    SELECT *
      INTO TABLE @DATA(tl_zwm_rf_mat_pend)
      FROM zwm_rf_mat_pend
      FOR ALL ENTRIES IN @tp_ubicacion
      WHERE lgnum = @tp_ubicacion-lgnum AND
            lgpla = @tp_ubicacion-lgpla.

    LOOP AT tp_ubicacion ASSIGNING FIELD-SYMBOL(<fs_ubicacion>).
      READ TABLE tl_zwm_rf_mat_pend ASSIGNING FIELD-SYMBOL(<fs_zwm_rf_mat_pend>) WITH KEY lgnum = <fs_ubicacion>-lgnum
                                                                                          lgpla = <fs_ubicacion>-lgpla.
      IF sy-subrc = 0.
        <fs_ubicacion>-zona_roja = 'X'.
        <fs_ubicacion>-descripcion = <fs_zwm_rf_mat_pend>-descripcion.
      ENDIF.


      IF <fs_ubicacion>-descripcion IS INITIAL. <fs_ubicacion>-descripcion = <fs_ubicacion>-lgpla. ENDIF.
    ENDLOOP.



  ENDMETHOD.
  METHOD ubicacionesset_get_entity.
    tratar_key_entity( EXPORTING io_tech_request_context = io_tech_request_context
                       IMPORTING wp_entity               = er_entity ).

    er_entity = ubicaciones_getdetail( vp_werks = er_entity-werks
                                       vp_lgpla = er_entity-lgpla ).
  ENDMETHOD.
  method UBICACIONESSET_GET_ENTITYSET.
    DATA wl_entity LIKE LINE OF et_entityset.
    tratar_key_entityset( EXPORTING io_tech_request_context = io_tech_request_context
                          IMPORTING wp_entity               = wl_entity ).

    et_entityset =  ubicaciones_getlist( wl_entity-werks ).

    zcl_seis_odata_utils=>tratar_entityset( EXPORTING io_tech_request_context  = io_tech_request_context
                                            CHANGING et_entityset = et_entityset ).

  endmethod.
  METHOD unidades_almacen_getdetail.

    SELECT SINGLE lqua~werks, lqua~lenum, lqua~lgtyp, lqua~lgpla, lqua~lgnum, lqua~lqnum,
                  lqua~matnr, lqua~verme, lqua~meins, lqua~charg,
                  t301t~ltypt, lfa1~lifnr, lfa1~name1
      INTO CORRESPONDING FIELDS OF @wp_unidades_almac
      FROM lqua INNER JOIN mara ON mara~matnr = lqua~matnr
                LEFT OUTER JOIN t301t ON  t301t~spras = @sy-langu   AND
                                          t301t~lgnum = lqua~lgnum  AND
                                          t301t~lgtyp = lqua~lgtyp
                LEFT OUTER JOIN ( likp INNER JOIN lfa1 ON lfa1~lifnr = likp~lifnr )
                ON likp~vbeln = lqua~vbeln
      WHERE lqua~werks = @vp_werks   AND
            lqua~lenum = @vp_lenum   AND
            lqua~verme > 0           and
            mara~mtart IN ('ZPAP', 'ZCAB').
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'No se ha encontrado la UA seleccionada' ).
    ENDIF.


    DATA tl_unidades_almacen LIKE TABLE OF wp_unidades_almac.
    APPEND wp_unidades_almac TO tl_unidades_almacen.
    unidades_almacen_getlist_ext( CHANGING tp_unidades_almac  =  tl_unidades_almacen ).
    wp_unidades_almac = tl_unidades_almacen[ 1 ].
  ENDMETHOD.
  METHOD unidades_almacen_getlist.

    SELECT lqua~werks, lqua~lenum, lqua~lgtyp, lqua~lgpla, lqua~lgnum, lqua~lqnum,
           lqua~matnr, lqua~verme, lqua~meins, lqua~charg,
           t301t~ltypt, lfa1~lifnr, lfa1~name1
      INTO CORRESPONDING FIELDS OF TABLE @tp_unidades_almac
      FROM lqua INNER JOIN mara ON mara~matnr = lqua~matnr
                LEFT OUTER JOIN t301t ON  t301t~spras = @sy-langu   AND
                                          t301t~lgnum = lqua~lgnum  AND
                                          t301t~lgtyp = lqua~lgtyp
                LEFT OUTER JOIN ( likp INNER JOIN lfa1 ON lfa1~lifnr = likp~lifnr )
                ON likp~vbeln = lqua~vbeln
      WHERE lqua~werks = @vp_werks   AND
            lqua~lenum <> ''         AND
            lqua~verme > 0           AND
            lqua~lgtyp NOT BETWEEN '900' AND '999' AND
            mara~mtart IN ('ZPAP', 'ZCAB').

    unidades_almacen_getlist_ext(  EXPORTING io_tech_request_context = io_tech_request_context
                                   CHANGING tp_unidades_almac = tp_unidades_almac  ).
  ENDMETHOD.
  METHOD unidades_almacen_getlist_ext.
    CHECK tp_unidades_almac IS NOT INITIAL.

    DATA tl_materiales TYPE TABLE OF zwm_nt_ui5_s_materiales.



    SELECT mara~matnr, mara~mtart, mara~zzancho
      INTO TABLE @tl_materiales
      FROM  mara LEFT OUTER JOIN makt ON makt~matnr = mara~matnr AND
                                         makt~spras = @sy-langu
      FOR ALL ENTRIES IN @tp_unidades_almac
      WHERE mara~matnr = @tp_unidades_almac-matnr.


    LOOP AT tp_unidades_almac ASSIGNING FIELD-SYMBOL(<fs_unidades_almac>).
      READ TABLE tl_materiales ASSIGNING FIELD-SYMBOL(<fs_material>) WITH KEY matnr = <fs_unidades_almac>-matnr.
      IF sy-subrc = 0.
        <fs_unidades_almac>-maktx   = <fs_material>-maktx.
        <fs_unidades_almac>-zzancho = <fs_material>-zzancho.
*        APPEND INITIAL LINE TO tl_materiales ASSIGNING <fs_material>.
*        <fs_material> = materiales_getdetail( vp_werks = <fs_unidades_almac>-werks
*                                              vp_matnr = <fs_unidades_almac>-matnr ).
      ENDIF.


      <fs_unidades_almac>-valor_filtro = |{ <fs_unidades_almac>-lenum }_{ <fs_unidades_almac>-matnr }_{ <fs_unidades_almac>-maktx }_{ <fs_unidades_almac>-lgpla }|.
    ENDLOOP.


    IF io_tech_request_context IS SUPPLIED AND io_tech_request_context IS NOT INITIAL.
      zcl_seis_odata_utils=>tratar_entityset( EXPORTING io_tech_request_context  = io_tech_request_context
                                              CHANGING et_entityset = tp_unidades_almac ).
    ENDIF.


    LOOP AT tp_unidades_almac ASSIGNING <fs_unidades_almac>.
      "Convertir a metros
      DATA: vl_menge TYPE ekpo-menge.
      CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
        EXPORTING
          i_matnr              = <fs_unidades_almac>-matnr
          i_in_me              = <fs_unidades_almac>-meins
          i_out_me             = 'M'
          i_menge              = <fs_unidades_almac>-verme
        IMPORTING
          e_menge              = vl_menge
        EXCEPTIONS
          error_in_application = 1
          error                = 2
          OTHERS               = 3.
      IF sy-subrc = 0.
        <fs_unidades_almac>-verme = vl_menge.
        <fs_unidades_almac>-meins = 'M'.
      ENDIF.
    ENDLOOP.


  ENDMETHOD.
  method UNIDADESALMACEN_GET_ENTITY.
    tratar_key_entity( EXPORTING io_tech_request_context = io_tech_request_context
                       IMPORTING wp_entity               = er_entity ).
    er_entity = unidades_almacen_getdetail( vp_werks = er_entity-werks
                                            vp_lenum = er_entity-lenum ).
  endmethod.
  METHOD unidadesalmacen_get_entityset.
    DATA wl_entity LIKE LINE OF et_entityset.
    tratar_key_entityset( EXPORTING io_tech_request_context = io_tech_request_context
                          IMPORTING wp_entity               = wl_entity ).

    et_entityset =  unidades_almacen_getlist( vp_werks = wl_entity-werks
                                              io_tech_request_context  = io_tech_request_context  ).

    " Lo muevo a unidades_almacen_getlist_ext
*    zcl_seis_odata_utils=>tratar_entityset( EXPORTING io_tech_request_context  = io_tech_request_context
*                                            CHANGING et_entityset = et_entityset ).

  ENDMETHOD.
  METHOD validar_envio_zona_roja.
    "SAPMZ_WM_RF
    "12497554832703


    DATA tl_rf_func TYPE TABLE OF zwm_rf_func.
    DATA(vl_lgnum) = zcl_wm_nt_generic=>get_instance( )->get_lgnum( iv_werks = vp_werks ).
    DATA(vl_where_rf_func) = |LG{ vl_lgnum } = 'X'|.

    SELECT *
      INTO TABLE tl_rf_func
      FROM zwm_rf_func
      WHERE (vl_where_rf_func).


    SELECT SINGLE lgnum, lgtyp, lgpla, lenum
      INTO @DATA(wl_lein)
      FROM lein
      WHERE lenum = @vp_ua.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'No se ha encontrado la UA' ).
    ENDIF.

    IF vl_lgnum <> wl_lein-lgnum.
      zcl_seis_odata_utils=>lanzar_excepcion( |LA UA no existe en el almacn { vl_lgnum }| ).
    ENDIF.


    SELECT lgnum, matnr, verme, meins, lenum, lgtyp, lgpla, bestq, lqnum,charg
      INTO TABLE @DATA(tl_lqua)
      FROM lqua
      WHERE lgnum = @vl_lgnum AND
            lenum = @vp_ua    AND
            verme > 0.
    IF tl_lqua IS NOT INITIAL.
      SELECT matnr, lgnum, lvsme
        INTO TABLE @DATA(tl_mlgn)
        FROM mlgn
        FOR ALL ENTRIES IN @tl_lqua
        WHERE  matnr = @tl_lqua-matnr AND
               lgnum = @tl_lqua-lgnum.
    ENDIF.

    READ TABLE tl_lqua ASSIGNING FIELD-SYMBOL(<fs_lqua>) INDEX 1.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'No se ha encontrado la UA' ).
    ENDIF.


    READ TABLE tl_mlgn ASSIGNING FIELD-SYMBOL(<fs_mlgn>) WITH KEY matnr = <fs_lqua>-matnr
                                                                  lgnum = <fs_lqua>-lgnum.
    IF sy-subrc = 0 AND <fs_lqua>-meins <> <fs_mlgn>-lvsme.
      CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
        EXPORTING
          i_matnr              = <fs_lqua>-matnr
          i_in_me              = <fs_lqua>-meins
          i_out_me             = <fs_mlgn>-lvsme
          i_menge              = <fs_lqua>-verme
        IMPORTING
          e_menge              = <fs_lqua>-verme
        EXCEPTIONS
          error_in_application = 1
          error                = 2
          OTHERS               = 3.
      IF sy-subrc <> 0.
        zcl_seis_odata_utils=>lanzar_excepcion( ).
      ENDIF.
      <fs_lqua>-meins = <fs_mlgn>-lvsme.
    ENDIF.


    READ TABLE tl_rf_func TRANSPORTING NO FIELDS WITH KEY func = 'NO_MOVER_STOCK_BLOQUEADO'.
    IF sy-subrc = 0 AND <fs_lqua>-bestq IS NOT INITIAL.
      zcl_seis_odata_utils=>lanzar_excepcion( id = 'ZWM_RF' number = '073' ). "La unidad de almacn leda est bloqueada para su uso
    ENDIF.




    wp_ua-werks = vp_werks.
    wp_ua-lenum = wl_lein-lenum.
    wp_ua-lgtyp = wl_lein-lgtyp.
    wp_ua-lgpla = <fs_lqua>-lgpla.
    wp_ua-lgnum = vl_lgnum.
    wp_ua-lqnum = <fs_lqua>-lqnum.
    wp_ua-matnr = <fs_lqua>-matnr.
    wp_ua-verme = <fs_lqua>-verme.
    wp_ua-meins = <fs_lqua>-meins.
    wp_ua-charg = <fs_lqua>-charg.

    SELECT SINGLE maktx
      INTO @wp_ua-maktx
      FROM makt
      WHERE matnr = @<fs_lqua>-matnr AND
            spras = @sy-langu.


  ENDMETHOD.
  METHOD validar_lectura_ua.

    DATA(vl_lgnum) = zcl_wm_nt_generic=>get_lgnum( vp_werks ).

    DATA(wl_maquina) = zcl_wm_nt_generic=>get_instance( )->maquinas_getdetail( vp_nlpla ).


    SELECT SINGLE ltbk~lgnum, ltbk~tbnum, ltbk~benum, ltbp~matnr, ltbk~rsnum
      INTO @DATA(wl_ltbk)
      FROM ltbk INNER JOIN ltbp ON ltbp~lgnum = ltbk~lgnum AND
                                   ltbp~tbnum = ltbk~tbnum
      WHERE ltbk~lgnum =  @vl_lgnum AND
            ltbk~tbnum =  @vp_tbnum AND
            ltbp~matnr <> @space.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'No se ha encontrado la necesidad de transporte' ).
    ENDIF.



    SELECT SINGLE lenum, matnr, lgpla, lgnum, letyp
     INTO @DATA(wl_lqua)
     FROM lqua
     WHERE lgnum = @vl_lgnum AND
           lenum = @vp_lenum.

    IF sy-subrc NE 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'No se ha encontrado la unidad de almacn' ).
      RETURN.
    ENDIF.

    SELECT SINGLE low
      INTO @DATA(vl_low)
      FROM tvarvc
      WHERE name  = 'ZWM_MAQUINAS_GESTION_PALETS' AND
            low   = @vp_nlpla.
    IF sy-subrc = 0 AND wl_lqua-letyp NE 'PL'.
      zcl_seis_odata_utils=>lanzar_excepcion( 'UA leda no se corresponde con un pallet' ).
      RETURN.
    ELSEIF sy-subrc NE 0 AND wl_lqua-letyp NE 'BB'.
      zcl_seis_odata_utils=>lanzar_excepcion( 'UA leda no se corresponde con una bobina' ).
      RETURN.
    ENDIF.


    IF wl_maquina-parte_rebobinado <> 'X'.
      IF wl_lqua-matnr <> wl_ltbk-matnr.
        "Comprobamos si el material es compatible
        zcl_wm_nt_generic=>get_mat_subs_comp(
          EXPORTING
            iv_matnr  = wl_ltbk-matnr
            iv_werks  = vp_werks
          IMPORTING
            et_subst  = DATA(tl_subst)
            et_compat = DATA(tl_compat) ).
        READ TABLE tl_subst TRANSPORTING NO FIELDS WITH KEY matnr = wl_lqua-matnr.
        IF sy-subrc <> 0.
          READ TABLE tl_compat TRANSPORTING NO FIELDS WITH KEY matnr = wl_lqua-matnr.
        ENDIF.
        IF sy-subrc <> 0.
          wp_return-type      = 'W'.
          wp_return-id        = 'SY'.
          wp_return-number    = '002'.
          wp_return-message   = 'Ha introducido una bobina de otro papel Quiere continuar?'.
          RETURN.
        ENDIF.
      ENDIF.
    ENDIF.


    IF wl_maquina-parte_rebobinado = 'X'.
      SELECT SINGLE werks, id_maquina, cod_parte_rebob
        INTO @DATA(wl_zwm_parte_reb_c)
        FROM zwm_parte_reb_c
        WHERE werks       = @vp_werks AND
              id_maquina  = @vp_nlpla AND
              rsnum       = @wl_ltbk-rsnum.
      IF sy-subrc <> 0.
        zcl_seis_odata_utils=>lanzar_excepcion( |No se ha encontrado parte de rebobinado para la reserva { wl_ltbk-rsnum }| ).
      ENDIF.
      DATA(wl_parte_rebob_cab) = parte_rebob_cab_getdetail( vp_cod_parte_rebob = wl_zwm_parte_reb_c-cod_parte_rebob
                                                            vp_id_maquina      = wl_zwm_parte_reb_c-id_maquina
                                                            vp_werks           = wl_zwm_parte_reb_c-werks ).
      IF wl_lqua-matnr <> wl_parte_rebob_cab-matnr.
        zcl_seis_odata_utils=>lanzar_excepcion( 'Ha introducido una bobina de otro papel' ).
      ENDIF.


      IF wl_parte_rebob_cab-bobina_cons <> vp_lenum.
        wp_return-type      = 'W'.
        wp_return-id        = 'SY'.
        wp_return-number    = '002'.
        wp_return-message   = 'Ha introducido una bobina del mismo papel Quiere continuar?'.
        RETURN.
      ENDIF.

    ENDIF.



  ENDMETHOD.
  METHOD validar_parte_rebob_bob_prod.


    DATA(wl_maquina) = zcl_wm_nt_generic=>get_instance( )->maquinas_getdetail( wp_parte_rebob_bob_prod-id_maquina ).
    IF wl_maquina-parte_rebobinado = space.
      zcl_seis_odata_utils=>lanzar_excepcion( 'La mquina no utiliza partes de rebobinado' ).
    ENDIF.


    DATA(wl_parte_cab) = parte_rebob_cab_getdetail( vp_werks            = wp_parte_rebob_bob_prod-werks
                                                    vp_id_maquina       = wp_parte_rebob_bob_prod-id_maquina
                                                    vp_cod_parte_rebob  = wp_parte_rebob_bob_prod-cod_parte_rebob ).
    DATA(wl_material) = materiales_getdetail( vp_werks  = wp_parte_rebob_bob_prod-werks
                                              vp_matnr  = wp_parte_rebob_bob_prod-matnr ).

    DATA(tl_parte_rebob_bob_prod) = parte_rebob_bob_prod_getlist(  vp_werks            = wp_parte_rebob_bob_prod-werks
                                                              vp_id_maquina       = wp_parte_rebob_bob_prod-id_maquina
                                                              vp_cod_parte_rebob  = wp_parte_rebob_bob_prod-cod_parte_rebob ).

    DATA vl_ancho TYPE int4.

    IF wp_parte_rebob_bob_prod-cla_nuevo_consumo = space.
      ADD wl_material-zzancho TO vl_ancho.
      LOOP AT tl_parte_rebob_bob_prod ASSIGNING FIELD-SYMBOL(<fs_parte_rebob_bob_prod>) WHERE cla_nuevo_consumo =  wp_parte_rebob_bob_prod-cla_nuevo_consumo AND
                                                                                              contador          <> wp_parte_rebob_bob_prod-contador.
        ADD <fs_parte_rebob_bob_prod>-zzancho TO vl_ancho.
      ENDLOOP.
    ENDIF.




    IF vl_ancho > wl_parte_cab-ancho.
      zcl_seis_odata_utils=>lanzar_excepcion( 'El ancho de las bobinas a producir es superior a la bobina a consumir' ).
    ENDIF.



  ENDMETHOD.
  METHOD validar_parte_rebob_cab.

    DATA(wl_maquina) = zcl_wm_nt_generic=>get_instance( )->maquinas_getdetail( wp_parte_rebob_cab-id_maquina ).
    IF wl_maquina-parte_rebobinado = space.
      zcl_seis_odata_utils=>lanzar_excepcion( 'La mquina no utiliza partes de rebobinado' ).
    ENDIF.

    IF wp_parte_rebob_cab-cod_parte_rebob IS NOT INITIAL.
      DATA(wl_parte_rebob_cab_bd) = parte_rebob_cab_getdetail(
                                    vp_cod_parte_rebob           = wp_parte_rebob_cab-cod_parte_rebob
                                    vp_id_maquina                = wp_parte_rebob_cab-id_maquina
                                    vp_werks                     = wp_parte_rebob_cab-werks ).

      IF wl_parte_rebob_cab_bd-cla_tratado = 'X'.
        zcl_seis_odata_utils=>lanzar_excepcion( 'El parte ya ha sido tratado' ).
      ENDIF.
    ENDIF.


    IF wp_parte_rebob_cab-fecha_registro IS INITIAL.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Debe indicar fecha de registro' ).
    ENDIF.
    IF wp_parte_rebob_cab-num_orden IS INITIAL.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Debe indicar nmero de orden' ).
    ENDIF.
    IF wp_parte_rebob_cab-bobina_cons IS INITIAL.
      zcl_seis_odata_utils=>lanzar_excepcion( 'Debe indicar bobina a consumir' ).
    ENDIF.


    DATA(wl_ua) = unidades_almacen_getdetail( vp_werks = wp_parte_rebob_cab-werks
                                              vp_lenum = wp_parte_rebob_cab-bobina_cons ).


  ENDMETHOD.
  METHOD validar_regularizar_ua.

    DATA(rl_consumos_imp) = NEW zcl_zui5_wm_consumos_dpc_imp( ).
    DATA(wl_bobina_cons) = rl_consumos_imp->validar_regularizar_ua( vp_werks = vp_werks
                                                                    vp_lgpla = vp_lgpla
                                                                    vp_ua = vp_ua ).
    MOVE-CORRESPONDING wl_bobina_cons TO wp_bobina.
    wp_bobina-length = wl_bobina_cons-verme.


  ENDMETHOD.
