  TYPES: BEGIN OF t_anticipos,
           posn2 TYPE bsid-posn2,
           kunnr TYPE bsid-kunnr,
           bukrs TYPE bsid-bukrs,
           belnr TYPE bsid-belnr,
           gjahr TYPE bsid-gjahr,
           blart TYPE bsid-blart,
           budat TYPE bsid-budat,
           buzei TYPE bsid-buzei,
           dmbtr TYPE dmbtrv,
           MWSTS type dmbtrv,
           total type dmbtrv,
           sgtxt TYPE bsid-sgtxt,
        END OF t_anticipos.
*----------------------------------------------------------------------*
CLASS lcl_alv DEFINITION INHERITING FROM zcl_ap_alv.
  PUBLIC SECTION.
    data i_anticipos type table of t_anticipos.
    METHODS: handle_double_click REDEFINITION.
ENDCLASS. "lcl_alv DEFINITION
*----------------------------------------------------------------------*
*       CLASS lcl_alv IMPLEMENTATION
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
CLASS lcl_alv IMPLEMENTATION.
  METHOD handle_double_click.
    data l_anticipo type t_anticipos.
    READ TABLE i_anticipos INDEX row INTO l_anticipo.
    IF sy-subrc = 0.
      zcl_doc_fi=>fb03( bukrs = l_anticipo-bukrs
                        belnr = l_anticipo-belnr
                        gjahr = l_anticipo-gjahr ).
    ENDIF.
  ENDMETHOD. "handle_double_click
ENDCLASS.                    "lcl_alv IMPLEMENTATION
class ZCL_PED_SD definition
  public
  inheriting from ZCL_AP_PEDIDO_SD
  final
  create public .

public section.

  types:
    begin of ty_estados_pos,
      vbeln type vbeln,
      posnr type posnr,
      zzestado TYPE ZESTADO_PLEN_ENT,
      end of ty_estados_pos .
  types:
    tty_estados_pos type STANDARD TABLE OF ty_estados_pos .

  constants C_MAT_PORTES type MATNR value '000000000000600049' ##NO_TEXT.

  class-methods GET_ANTICIPOS_PEDIDO
    importing
      !VBELN type VBELN
      !POSNR type POSNR optional
      !SHOW_POPUP type ABAP_BOOL default ''
      !BLART type BLART default ''
      !SOLO_CABECERA type ABAP_BOOL default ''
    returning
      value(I_PARTIDAS) type TRTY_BSID .
  class-methods CAMBIAR_STATUS
    importing
      !VBELN type VBELN
      !POSNR type POSNR optional
      !NUEVO_STATUS type J_STATUS
      !STATUS_ANTERIOR type J_STATUS default '' .
  class-methods CAMBIAR_STATUS_P2P
    importing
      !VBELN type VBELN
      !POSNR type POSNR optional
      !NUEVO_STATUS type J_STATUS
      !STATUS_ANTERIOR type J_STATUS default '' .
  class-methods ES_INTERCO
    importing
      !VKORG type VKORG
      !WERKS type WERKS_D
    returning
      value(INTERCO) type ABAP_BOOL .
  class-methods GET_SEL_CAR
    importing
      !VBELN type VBAP-VBELN
      !POSNR type VBAP-POSNR
      !NO_VALOR_POR_DEFECTO type ABAP_BOOL default ''
    returning
      value(I_SELCAR) type TT_BAPI1003_ALLOC_VALUES_CHAR .
  class-methods GET_SEL_CAR_PED
    importing
      !VBELN type VBAP-VBELN
      !NO_VALOR_POR_DEFECTO type ABAP_BOOL default ''
      !UNIF type ABAP_BOOL default ''
    returning
      value(I_SELCAR) type ZT_SEL_CAR_PEDIDO .
  class-methods GET_SEL_CAR_PED_CLIENTE
    importing
      !KUNNR type VBAK-KUNNR
      !NO_VALOR_POR_DEFECTO type ABAP_BOOL default ''
    returning
      value(I_SELCAR) type ZT_SEL_CAR_PEDIDO .
  class-methods GET_VALOR_ANTICIPOS
    importing
      !VBELN type VBELN
      !POSNR type POSNR optional
      !BLART type BLART default ''
      !SOLO_CABECERA type ABAP_BOOL default ''
    returning
      value(VALOR) type VBAK-NETWR .
  class-methods GET_ESTADO_CABECERA
    importing
      !VBELN type VBELN_VA
    exporting
      !OT_ESTADOS_POS type TTY_ESTADOS_POS
      value(ESTADO) type CHAR2 .
  class-methods GET_PEDIDO_PORTES
    importing
      !VBELN type VBELN_VA
      !INTERCO type ABAP_BOOL default ''
      !PED_VACIO type ABAP_BOOL default ''
    returning
      value(PED_PORTES) type VBELN_VA .
  class-methods GET_VALOR_PEND_FACT
    importing
      !VBELN type VBAP-VBELN
      !POSNR type VBAP-POSNR optional
      !FKART type VBRK-FKART
    returning
      value(NETWR) type VBAP-NETWR .
  class-methods CALC_FECHA_PDISMATERIAL
    importing
      !VBELN type VBELN_VA
      !POSNR type POSNR_VA
      !ETDAT type EINDT
    returning
      value(MBDAT) type MBDAT .
  class-methods CALC_FREPARTO_FROM_MBDAT
    importing
      !VBELN type VBELN_VA
      !POSNR type POSNR_VA
      value(MBDAT) type MBDAT
    returning
      value(ETDAT) type EINDT .
  class-methods GET_USUARIOS_PROCESO
    importing
      !PROCESO type ZPROCESO_WF_SD
      !VBAK type VBAK
    returning
      value(I_USNAM) type HRBAS_BAPIUSNAME_TABLE .
  class-methods CALC_FECHA_PCARGA
    importing
      !VBELN type VBELN_VA
      !POSNR type POSNR_VA
      !ETDAT type EINDT
    returning
      value(LDDAT) type LDDAT .
  class-methods CALC_FREPARTO_FROM_LDDAT
    importing
      !VBELN type VBELN_VA
      !POSNR type POSNR_VA
      value(LDDAT) type LDDAT
    returning
      value(ETDAT) type EINDT .
  class-methods GET_MAILS_PROCESO
    importing
      !PROCESO type ZPROCESO_WF_SD
      !VBAK type VBAK
      !AENAM type AENAM default ''
    returning
      value(I_EMAILS) type ZT_US_AVISOS .
  class-methods SET_MAILS_PROCESO
    importing
      !PROCESO type ZPROCESO_WF_SD
      !VBAK type VBAK
      !AENAM type AENAM optional
      !O_MAIL type ref to ZCL_AP_ENVIO_MAIL
      !TEST type ANY default '' .
  class-methods GET_SEL_CAR_UNIF
    importing
      !VBELN type VBAP-VBELN
      !POSNR type VBAP-POSNR
      !NO_VALOR_POR_DEFECTO type ABAP_BOOL default ''
    returning
      value(I_SELCAR) type ZT_SEL_CAR .
protected section.
private section.

  methods GET_INFO .
  methods CALC_FECHA_PLANIFICACION
    importing
      !VBELN type VBELN
      !POSNR type POSNR
      !XVBEP type VA_VBEPVB_T
      !WERKS type WERKS_D
      !VDATU type EDATU_VBAK
    returning
      value(ZZPLD) type ETDAT .
endclass. "ZCL_PED_SD definition
class ZCL_PED_SD implementation.
METHOD CALC_FECHA_PCARGA.
  DATA: l_vbak TYPE vbak,
        l_vbap TYPE vbap,
        l_vbpa TYPE vbpa.

  DATA: l_fecha TYPE d,
        l_kuwev TYPE kuwev,
        l_options TYPE  schedoptions.

  SELECT SINGLE * FROM vbak
    INTO l_vbak
    WHERE vbeln = vbeln.

  SELECT SINGLE * FROM vbap
    INTO l_vbap
    WHERE vbeln = vbeln
      AND posnr = posnr.

  SELECT SINGLE * FROM vbpa
    INTO l_vbpa
    WHERE vbeln = vbeln
     AND parvw = 'WE'.

  SELECT SINGLE * FROM kna1
    INTO CORRESPONDING FIELDS OF l_kuwev
   WHERE kunnr = l_vbpa-kunnr.

*  MOVE-CORRESPONDING vbpa to l_kuwev.

  l_options-forwards_auto = 'X'.
  l_options-transittime   = 'X'.

  CALL FUNCTION 'SD_SCHEDULING'
    EXPORTING
      if_schedule_direction         = '-'
*   IF_SCHEDULE_SHIPPING          = 'X'
*   IF_SCHEDULE_TRANSPORT         = 'X'
      if_shipping_point             = l_vbap-vstel
      if_weight_group               = '9999'
      if_loading_group              = '0001'
      if_transport_route            = l_vbap-route
      is_ship_to_view               = l_kuwev
*   IF_DATE_TODAY                 = SY-DATLO
*   IF_TIME_TODAY                 = SY-TIMLO
      is_options                    = l_options
      if_material_avail_date        = ETDAT
*   IF_MATERIAL_AVAIL_TIME        =
      if_transport_dispo_date       = ETDAT
**   IF_TRANSPORT_DISPO_TIME       =
      if_loading_date               = ETDAT
**   IF_LOADING_TIME               =
      if_goods_issue_date           = ETDAT
**   IF_GOODS_ISSUE_TIME           =
      if_delivery_date              = ETDAT
*   IF_DELIVERY_TIME              =
      if_unloading_date             = ETDAT
*   IF_UNLOADING_TIME             =
      if_shipping_conditions        = '01'
      if_transport_group            = '0001'
*   IF_ROUTE_SCHEDULE             =
*   IF_GET_PARMS_ONLY             =
*   IF_RS_DOCUMENT_SW             =
*   IF_WEBAZ                      =
    IMPORTING
*      ef_material_avail_date        = mbdat
*      EF_MATERIAL_AVAIL_TIME        =
*   EF_TRANSPORT_DISPO_DATE       =
*   EF_TRANSPORT_DISPO_TIME       =
    EF_LOADING_DATE               = lddat
*   EF_LOADING_TIME               =
*   EF_GOODS_ISSUE_DATE           =
*   EF_GOODS_ISSUE_TIME           =
*   EF_DELIVERY_DATE              = l_fecha
*   EF_DELIVERY_TIME              =
*   EF_UNLOADING_DATE             =
*   EF_UNLOADING_TIME             =
*   EF_ROUTE_SCHEDULE             =
* CHANGING
*   CF_GUID                       =
   EXCEPTIONS
     invalid_date                  = 1
     invalid_calendar              = 2
     missing_date                  = 3
     date_after_end                = 4
     date_before_begin             = 5
     invalid_workinghours          = 6
     parameter_error               = 7
     fatal_error                   = 8
     OTHERS                        = 9
            .
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDMETHOD.
METHOD calc_fecha_pdismaterial.
  DATA: l_vbak TYPE vbak,
        l_vbap TYPE vbap,
        l_vbpa TYPE vbpa.

  DATA: l_fecha TYPE d,
        l_kuwev TYPE kuwev,
        l_options TYPE  schedoptions.

  SELECT SINGLE * FROM vbak
    INTO l_vbak
    WHERE vbeln = vbeln.

  SELECT SINGLE * FROM vbap
    INTO l_vbap
    WHERE vbeln = vbeln
      AND posnr = posnr.

  SELECT SINGLE * FROM vbpa
    INTO l_vbpa
    WHERE vbeln = vbeln
     AND parvw = 'WE'.

  SELECT SINGLE * FROM kna1
    INTO CORRESPONDING FIELDS OF l_kuwev
   WHERE kunnr = l_vbpa-kunnr.

*  MOVE-CORRESPONDING vbpa to l_kuwev.

  l_options-forwards_auto = 'X'.
  l_options-transittime   = 'X'.

  CALL FUNCTION 'SD_SCHEDULING'
    EXPORTING
      if_schedule_direction         = '-'
*   IF_SCHEDULE_SHIPPING          = 'X'
*   IF_SCHEDULE_TRANSPORT         = 'X'
      if_shipping_point             = l_vbap-vstel
      if_weight_group               = '9999'
      if_loading_group              = '0001'
      if_transport_route            = l_vbap-route
      is_ship_to_view               = l_kuwev
*   IF_DATE_TODAY                 = SY-DATLO
*   IF_TIME_TODAY                 = SY-TIMLO
      is_options                    = l_options
      if_material_avail_date        = ETDAT
*   IF_MATERIAL_AVAIL_TIME        =
      if_transport_dispo_date       = ETDAT
**   IF_TRANSPORT_DISPO_TIME       =
      if_loading_date               = ETDAT
**   IF_LOADING_TIME               =
      if_goods_issue_date           = ETDAT
**   IF_GOODS_ISSUE_TIME           =
      if_delivery_date              = ETDAT
*   IF_DELIVERY_TIME              =
      if_unloading_date             = ETDAT
*   IF_UNLOADING_TIME             =
      if_shipping_conditions        = '01'
      if_transport_group            = '0001'
*   IF_ROUTE_SCHEDULE             =
*   IF_GET_PARMS_ONLY             =
*   IF_RS_DOCUMENT_SW             =
*   IF_WEBAZ                      =
    IMPORTING
      ef_material_avail_date        = mbdat
*      EF_MATERIAL_AVAIL_TIME        =
*   EF_TRANSPORT_DISPO_DATE       =
*   EF_TRANSPORT_DISPO_TIME       =
*   EF_LOADING_DATE               =
*   EF_LOADING_TIME               =
*   EF_GOODS_ISSUE_DATE           =
*   EF_GOODS_ISSUE_TIME           =
*   EF_DELIVERY_DATE              = l_fecha
*   EF_DELIVERY_TIME              =
*   EF_UNLOADING_DATE             =
*   EF_UNLOADING_TIME             =
*   EF_ROUTE_SCHEDULE             =
* CHANGING
*   CF_GUID                       =
   EXCEPTIONS
     invalid_date                  = 1
     invalid_calendar              = 2
     missing_date                  = 3
     date_after_end                = 4
     date_before_begin             = 5
     invalid_workinghours          = 6
     parameter_error               = 7
     fatal_error                   = 8
     OTHERS                        = 9
            .
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDMETHOD.
METHOD calc_fecha_planificacion.
  DATA i_vbep TYPE TABLE OF vbepvb.
  FIELD-SYMBOLS <vbep> TYPE vbepvb.

  IF xvbep IS INITIAL.
    SELECT * FROM vbep
      INTO CORRESPONDING FIELDS OF TABLE i_vbep
     WHERE vbeln = vbeln
       AND posnr = posnr.
  ELSE.
    i_vbep = xvbep.
  ENDIF.

  LOOP AT i_vbep ASSIGNING <vbep> WHERE posnr = posnr.
    IF <vbep>-mbdat > zzpld.
      zzpld = <vbep>-mbdat.
    ENDIF.
  ENDLOOP.

  IF NOT zzpld IS INITIAL.
    CASE werks.
      WHEN '2010' OR '2012'.
        zzpld = zzpld - 1.
      WHEN '2013'.
        zzpld = zzpld - 3.
    ENDCASE.
  ENDIF.

  IF zzpld IS INITIAL.
    IF NOT vdatu IS INITIAL.
      zzpld = vdatu.
    ELSEIF NOT vbeln IS INITIAL.
      SELECT SINGLE vdatu FROM vbak
        INTO zzpld
       WHERE vbeln = vbeln.
    ENDIF.
  ENDIF.

ENDMETHOD.
METHOD calc_freparto_from_lddat.
  DATA: l_fecha TYPE d,
        l_lddat TYPE d,
        l_index TYPE i.

  CLEAR etdat.

  DO 60 TIMES.
    l_index = sy-index  - 1.

    l_fecha = lddat + l_index.

    l_lddat = calc_fecha_pcarga( vbeln = vbeln posnr = posnr etdat = l_fecha ).

    IF l_lddat = lddat.
      etdat = l_fecha.
      EXIT.
    ENDIF.

    l_fecha = lddat - l_index.

    l_lddat = calc_fecha_pcarga( vbeln = vbeln posnr = posnr etdat = l_fecha ).

    IF l_lddat = lddat.
      etdat = l_fecha.
      EXIT.
    ENDIF.

  ENDDO.

ENDMETHOD.
METHOD calc_freparto_from_mbdat.
  DATA: l_fecha TYPE d,
        l_mbdat TYPE d,
        l_index TYPE i.

  CLEAR etdat.

  DO 60 TIMES.
    l_index = sy-index  - 1.

    l_fecha = mbdat + l_index.

    l_mbdat = calc_fecha_pdismaterial( vbeln = vbeln posnr = posnr etdat = l_fecha ).

    IF l_mbdat = mbdat.
      etdat = l_fecha.
      EXIT.
    ENDIF.

    l_fecha = mbdat - l_index.

    l_mbdat = calc_fecha_pdismaterial( vbeln = vbeln posnr = posnr etdat = l_fecha ).

    IF l_mbdat = mbdat.
      etdat = l_fecha.
      EXIT.
    ENDIF.

  ENDDO.

ENDMETHOD.
METHOD cambiar_status.
  DATA: l_status TYPE j_status,
        l_status_anterior type j_status,
        l_cont(1) TYPE n,
        l_objnr TYPE jsto-objnr,
        l_inact.

  IF status_anterior IS INITIAL.
    l_status_anterior = get_status_activo( vbeln = vbeln posnr = posnr ).
  ELSE.
    l_status_anterior = status_anterior.
  ENDIF.

  CHECK l_status NE nuevo_status.

  CONCATENATE 'VB' vbeln posnr INTO l_objnr.

  DO 4 TIMES.
    IF nuevo_status >= l_status_anterior.
      l_cont = sy-index.
    ELSE.
      l_cont = 5 - sy-index.
    ENDIF.
    CONCATENATE 'E000' l_cont INTO l_status.
    IF nuevo_status = l_status.
      l_inact = ''.
    ELSE.
      l_inact = 'X'.
    ENDIF.

    CALL FUNCTION 'STATUS_CHANGE_EXTERN'
      EXPORTING
        objnr                     = l_objnr
        user_status               = l_status
        set_inact                 = l_inact
*   SET_CHGKZ                 =
        NO_CHECK                  = 'X'
* IMPORTING
*   STONR                     =
     EXCEPTIONS
       object_not_found          = 1
       status_inconsistent       = 2
       status_not_allowed        = 3.
  ENDDO.


ENDMETHOD.                    "handle_double_click
METHOD cambiar_status_p2p.
  DATA: l_status TYPE j_status,
        l_status_activo TYPE j_status,
        l_cont(1) TYPE n,
        l_objnr TYPE jsto-objnr,
        l_dif TYPE i.

  IF status_anterior IS INITIAL.
    l_status_activo = get_status_activo( vbeln = vbeln posnr = posnr ).
  ELSE.
    l_status_activo = status_anterior.
  ENDIF.

  CHECK l_status_activo NE nuevo_status.

  CONCATENATE 'VB' vbeln posnr INTO l_objnr.

  l_dif = nuevo_status+4(1) - l_status_activo+4(1).
  IF l_dif = 1.
    cambiar_status( vbeln = vbeln posnr = posnr nuevo_status = nuevo_status status_anterior = status_anterior ).
  ELSE.
    IF l_dif > 0.
      l_cont = l_status_activo+4(1) + 1.
      WHILE l_cont <= nuevo_status+4(1).
        CONCATENATE 'E000' l_cont INTO l_status.
        cambiar_status( vbeln = vbeln posnr = posnr nuevo_status = l_status status_anterior = status_anterior ).
        ADD 1 TO l_cont.
      ENDWHILE.
    ELSE.
      l_cont = l_status_activo+4(1) - 1.
      WHILE l_cont >= nuevo_status+4(1).
        CONCATENATE 'E000' l_cont INTO l_status.
        cambiar_status( vbeln = vbeln posnr = posnr nuevo_status = l_status status_anterior = status_anterior ).
        SUBTRACT 1 FROM l_cont.
      ENDWHILE.
    ENDIF.
  ENDIF.


ENDMETHOD.                    "handle_double_click
METHOD es_interco.
  DATA: l_soc_orgven TYPE bukrs,
        l_soc_centro TYPE bukrs.

  SELECT SINGLE bukrs FROM tvko
    INTO l_soc_orgven
   WHERE vkorg = vkorg.

  SELECT SINGLE bukrs FROM t001k
    INTO l_soc_centro
   WHERE bwkey = werks.

  IF l_soc_centro NE l_soc_orgven.
    interco = 'X'.
  ENDIF.

ENDMETHOD.
METHOD get_anticipos_pedido.
  DATA: i_anticipos TYPE TABLE OF t_anticipos,
        l_anticipo TYPE t_anticipos,
        l_partida TYPE bsid,
        r_blart TYPE RANGE OF blart,
        lr_blart LIKE LINE OF r_blart.

  CLEAR i_partidas.

  IF NOT blart IS INITIAL.
    CLEAR lr_blart.
    lr_blart-option = 'EQ'.
    lr_blart-sign   = 'I'.
    lr_blart-low    = blart.
    APPEND lr_blart TO r_blart.
  ENDIF.

  SELECT * FROM bsid
    INTO TABLE i_partidas
   WHERE blart IN r_blart
     AND umskz = 'A'
     AND vbel2 = vbeln.

  SELECT * FROM bsad
    APPENDING CORRESPONDING FIELDS OF TABLE i_partidas
   WHERE blart IN r_blart
     AND umskz = 'A'
     AND vbel2 = vbeln.

  IF NOT posnr IS INITIAL.
    DELETE i_partidas WHERE posn2 NE posnr.
  ELSEIF solo_cabecera = 'X'.
    DELETE i_partidas WHERE NOT posn2 IS INITIAL.
  ENDIF.

  IF show_popup = 'X'.
    DATA o_alv TYPE REF TO lcl_alv.
    CREATE OBJECT o_alv
      EXPORTING
        tabla = ''.

    LOOP AT i_partidas INTO l_partida.
      CLEAR l_anticipo.
      MOVE-CORRESPONDING l_partida TO l_anticipo.
      IF l_partida-shkzg = 'H'.
        l_anticipo-dmbtr = - l_partida-dmbtr.
        l_anticipo-mwsts = - l_partida-mwsts.
      ENDIF.
      l_anticipo-total = l_anticipo-dmbtr + l_anticipo-mwsts.
      APPEND l_anticipo TO i_anticipos.
    ENDLOOP.

    o_alv->constructor_tabla( CHANGING t_tabla = i_anticipos ).
    o_alv->i_anticipos = i_anticipos.
    o_alv->set_orden( campo = 'POSN2' subtot = 'X' ).
    o_alv->set_orden( 'BUDAT,BELNR' ).
    o_alv->set_field_text( campo = 'MWSTS' valor = 'Imp.Impuesto' ).
    o_alv->set_field_text( campo = 'Total' valor = 'Total' ).
    o_alv->set_agregacion( 'DMBTR,MWSTS,TOTAL' ).
    o_alv->show_popup( ).
  ENDIF.

ENDMETHOD.                    "handle_double_click
METHOD get_estado_cabecera.
  DATA: i_vbap TYPE TABLE OF vbap,
        l_vbap TYPE vbap,
        BEGIN OF l_estado,
          orden,
          estado(2),
        END OF l_estado,
        l_min_estado(3).

  SELECT * FROM vbap
    INTO TABLE i_vbap
   WHERE vbeln = vbeln
     AND pstyv NE 'TATX'.

  l_min_estado = '9'.
  LOOP AT i_vbap INTO l_vbap.
    l_estado-estado = get_estado_posicion( vbeln = vbeln posnr = l_vbap-posnr ).

* 58775 - 27/04/2021 - CMS - Devolver estados de posicion:
    APPEND INITIAL LINE TO ot_estados_pos ASSIGNING FIELD-SYMBOL(<fs_estados_pos>).
    <fs_estados_pos>-vbeln = vbeln.
    <fs_estados_pos>-posnr = l_vbap-posnr.
    <fs_estados_pos>-zzestado = l_estado-estado.
* FIN - CMS

    CASE l_estado-estado(1).
      WHEN ' '.
        l_estado-orden = 1.
      WHEN 'P'.
        l_estado-orden = 2.
      WHEN 'E'.
        l_estado-orden = 3.
      WHEN 'F'.
        l_estado-orden = 4.
      WHEN 'R'.
        l_estado-orden = 5.
    ENDCASE.

    IF l_estado < l_min_estado.
      l_min_estado = l_estado.
    ENDIF.
  ENDLOOP.

  estado = l_min_estado+1.

ENDMETHOD.
method GET_INFO.

*  FV64A049
*  SD_DP_ORDER_ITEM_GET

  DATA: i_customer TYPE  sddp_customer_t,
        et_bseg_prov TYPE  sddp_bseg_prov_t,
        t_order_item TYPE  sddp_order_item_t.


*  SELECT SINGLE * FROM vbak
*   WHERE vbeln = p_vbeln.


    call function 'SD_DP_ORDER_ITEMS_BUILD'
      exporting
        iv_doc_number    = '0000006242'
        iv_bill_doc_this = '0361000002'
      importing
        et_order_item    = t_order_item
        et_bseg_prov     = et_bseg_prov.
endmethod.
METHOD get_mails_proceso.
  DATA: r_vkorg TYPE RANGE OF vkorg,
        r_vkgrp TYPE RANGE OF vkgrp,
        r_ernam TYPE RANGE OF ernam,
        r_aenam TYPE RANGE OF aenam,
*        r_zzmar TYPE RANGE OF zmarca_mat,
        r_prodh TYPE RANGE OF prodh_d,
*        r_devolucion TYPE RANGE OF z_devolucion,
*        r_funcvis TYPE RANGE OF zfuncional_visual,
        lr_vkorg LIKE LINE OF r_vkorg,
        lr_vkgrp LIKE LINE OF r_vkgrp,
        lr_ernam LIKE LINE OF r_ernam,
        lr_aenam LIKE LINE OF r_aenam,
*        lr_zzmar LIKE LINE OF r_zzmar,
        lr_prodh LIKE LINE OF r_prodh,
*        lr_devolucion LIKE LINE OF r_devolucion,
*        lr_funcvis LIKE LINE OF r_funcvis,
        i_avisos TYPE TABLE OF zsd_us_avisos,
        l_avisos TYPE zsd_us_avisos,
        l_username TYPE bapiusname,
        l_ok,
        i_sel_car TYPE zt_sel_car_pedido,
        l_sel_car TYPE zsel_car_pedido,
        l_car_pos TYPE zest_lotes.

  DEFINE filtro_multiple.
    if not l_avisos-&1 = '*' and not l_avisos-&1 = '' and not r_&1 is initial.
      clear l_ok.
      loop at r_&1 into lr_&1.
        if l_avisos-&1 cs lr_&1-low.
          l_ok = 'X'.
          exit.
        endif.
      endloop.
      if l_ok is initial.
        delete i_avisos.
      endif.
    endif.
  END-OF-DEFINITION.
  CLEAR i_emails.

  IF NOT vbak-vkorg IS INITIAL.
    lr_vkorg-option = 'EQ'.
    lr_vkorg-sign   = 'I'.
    lr_vkorg-low    = vbak-vkorg.
    APPEND lr_vkorg TO r_vkorg.
  ENDIF.

  IF NOT vbak-vkgrp IS INITIAL.
    lr_vkgrp-option = 'EQ'.
    lr_vkgrp-sign   = 'I'.
    lr_vkgrp-low    = vbak-vkgrp.
    APPEND lr_vkgrp TO r_vkgrp.
  ENDIF.

  IF NOT vbak-ernam IS INITIAL.
    lr_ernam-option = 'EQ'.
    lr_ernam-sign   = 'I'.
    lr_ernam-low    = vbak-ernam.
    APPEND lr_ernam TO r_ernam.
  ENDIF.

  IF NOT aenam IS INITIAL.
    lr_aenam-option = 'EQ'.
    lr_aenam-sign   = 'I'.
    lr_aenam-low    = aenam.
    APPEND lr_aenam TO r_aenam.
  ENDIF.

  IF NOT vbak-vbeln IS INITIAL.
*    lr_zzmar-option = 'EQ'.
*    lr_zzmar-sign   = 'I'.

*    SELECT zzmar
*      INTO lr_zzmar-low
*      FROM vbap JOIN mara ON vbap~matnr = mara~matnr
*     WHERE vbeln = vbak-vbeln
*       AND zzmar NE ''
*      .
*      COLLECT lr_zzmar INTO r_zzmar.
*    ENDSELECT.

    lr_prodh-option = 'EQ'.
    lr_prodh-sign   = 'I'.

    SELECT prodh FROM vbap
      INTO lr_prodh-low
     WHERE vbeln = vbak-vbeln
       AND prodh NE ''.
      CLEAR lr_prodh-low+2.
      COLLECT lr_prodh INTO r_prodh.
    ENDSELECT.

    i_sel_car = get_sel_car_ped( vbak-vbeln ).

*    lr_devolucion-option = 'EQ'.
*    lr_devolucion-sign   = 'I'.

*   LOOP AT i_sel_car INTO l_sel_car WHERE charact = 'Z_DEVOLUCION'.
*     lr_devolucion-low = l_sel_car-value_char.
*     COLLECT lr_devolucion INTO r_devolucion.
*   ENDLOOP.

*    lr_funcvis-option = 'EQ'.
*    lr_funcvis-sign   = 'I'.

    SORT i_sel_car.
    LOOP AT i_sel_car INTO l_sel_car.
      AT NEW posnr.
        CLEAR l_car_pos.
      ENDAT.

*      CASE l_sel_car-charact.
*        WHEN 'ZH_ESTANDAR'.
*          l_car_pos-zh_estandar = l_sel_car-value_char.
*        WHEN 'VAR_CAL_POT_SAP'.
*          l_car_pos-var_cal_pot_sap = l_sel_car-value_char.
*        WHEN 'TX_CAL_VIS_SAP'.
*          l_car_pos-tx_cal_vis_sap = l_sel_car-value_char.
*      ENDCASE.
*
*      AT END OF posnr.
*        zcl_clas_lote=>get_func_visual( EXPORTING
*                             estandar = l_car_pos-zh_estandar
*                             calidad_funcional = l_car_pos-var_cal_pot_sap
*                             calidad_visual = l_car_pos-tx_cal_vis_sap
*                         IMPORTING
*                             func_visual = l_car_pos-func_visual ).
*
*        lr_funcvis-low = l_car_pos-func_visual.
*        COLLECT lr_funcvis INTO r_funcvis.
*      ENDAT.
    ENDLOOP.
  ENDIF.

  SELECT * FROM zsd_us_avisos
    INTO TABLE i_avisos
   WHERE proceso = proceso
     AND ( vkorg IN r_vkorg OR vkorg = '*' )
     AND ( vkgrp IN r_vkgrp OR vkgrp = '*' )
     AND ( ernam IN r_ernam OR ernam = '*' )
     AND ( aenam IN r_aenam OR aenam = '*' ).
*     AND ( zzmar IN r_marca OR zzmar = '*' ).

  LOOP AT i_avisos INTO l_avisos.
*    filtro_multiple: zzmar, prodh, devolucion, funcvis.
  ENDLOOP.

* Añado el primero que encuentré válido
  LOOP AT i_avisos INTO l_avisos WHERE prioridad < '90'
                                   AND ( notificar NE ''  OR notificar_email NE '' ).
    IF l_avisos-notificar_email IS INITIAL.
      l_avisos-notificar_email = zcl_ap_usuario=>get_email( l_avisos-notificar ).
    ENDIF.
    IF l_avisos-copia_email IS INITIAL AND NOT l_avisos-copia IS INITIAL.
      l_avisos-copia_email = zcl_ap_usuario=>get_email( l_avisos-copia ).
    ENDIF.
    APPEND l_avisos TO i_emails.
    EXIT.
  ENDLOOP.

* Los de prioridad mayor de 90 los añado todos
  LOOP AT i_avisos INTO l_avisos WHERE prioridad >= '90'
                                   AND ( notificar NE ''  OR notificar_email NE '' ).
    IF l_avisos-notificar_email IS INITIAL.
      l_avisos-notificar_email = zcl_ap_usuario=>get_email( l_avisos-notificar ).
    ENDIF.
    IF l_avisos-copia_email IS INITIAL AND NOT l_avisos-copia IS INITIAL.
      l_avisos-copia_email = zcl_ap_usuario=>get_email( l_avisos-copia ).
    ENDIF.
    APPEND l_avisos TO i_emails.
  ENDLOOP.


ENDMETHOD.
METHOD get_pedido_portes.
  DATA: i_vbfa TYPE TABLE OF vbfa,
        l_vbfa TYPE vbfa,
        l_vbap TYPE vbap,
        l_kunnr TYPE kunnr,
        l_kunnr2 TYPE kunnr.

  SELECT SINGLE kunnr FROM vbak
    INTO l_kunnr
   WHERE vbeln = vbeln.

  CLEAR ped_portes.

  SELECT * FROM vbfa
    INTO TABLE i_vbfa
   WHERE vbelv = vbeln
     AND vbtyp_n = 'L'
     AND vbtyp_v IN ('H','K')
     AND stufe = '00'.

  LOOP AT i_vbfa INTO l_vbfa.
    SELECT SINGLE * FROM vbap
      INTO l_vbap
     WHERE vbeln = l_vbfa-vbeln
       AND matnr = c_mat_portes
       AND abgru = ''.
    IF sy-subrc = 0.
      SELECT SINGLE kunnr FROM vbak
        INTO l_kunnr2
       WHERE vbeln = l_vbap-vbeln.

      IF interco = '' AND l_kunnr = l_kunnr2.
        ped_portes = l_vbap-vbeln.
        EXIT.
      ELSEIF interco = 'X' AND l_kunnr NE l_kunnr2.
        ped_portes = l_vbap-vbeln.
        EXIT.
      ENDIF.
    ENDIF.
  ENDLOOP.

* Buscamos si hubiera alguno creado sin posiciones.
  IF ped_portes IS INITIAL AND ped_vacio = 'X'.
    REFRESH i_vbfa.
    SELECT * FROM vbfa
      INTO TABLE i_vbfa
       WHERE vbelv = vbeln
         AND posnv = '000000'
         AND posnn = '000000'
         AND vbtyp_n = 'L'
         AND vbtyp_v IN ('H','K')
         AND stufe = '00'.

    LOOP AT i_vbfa INTO l_vbfa.
      SELECT SINGLE kunnr FROM vbak
        INTO l_kunnr2
       WHERE vbeln = l_vbfa-vbeln.

      IF interco = '' AND l_kunnr = l_kunnr2.
        ped_portes = l_vbfa-vbeln.
        EXIT.
      ELSEIF interco = 'X' AND l_kunnr NE l_kunnr2.
        ped_portes = l_vbfa-vbeln.
        EXIT.
      ENDIF.
    ENDLOOP.
  ENDIF.

ENDMETHOD.
METHOD get_sel_car.
  DATA: o_lote_ped TYPE REF TO zcl_clas_lote,
        l_selcar TYPE bapi1003_alloc_values_char,
        l_param TYPE zparametros,
        l_vbap TYPE vbap.

  CLEAR i_selcar.

* Sólo buscamos características, si es un pedido de ventas
  SELECT SINGLE * FROM vbap
    INTO l_vbap
   WHERE vbeln = vbeln
     AND posnr = posnr.
  CHECK sy-subrc = 0.

  CREATE OBJECT o_lote_ped.

  o_lote_ped->get_datos_pedido( vbeln = vbeln
                                posnr = posnr
                                opt   = 'X' ).

  IF o_lote_ped->i_car_char[] IS INITIAL.
    IF no_valor_por_defecto IS INITIAL.
      SELECT * FROM zparametros
        INTO l_param
       WHERE clave = 'CAR_DEFECT'.
        CLEAR l_selcar.
        l_selcar-charact = l_param-campo.
        l_selcar-value_char = l_selcar-value_neutral = l_param-atributo1.
        APPEND l_selcar TO i_selcar.
      ENDSELECT.
    ENDIF.
  ELSE.
    i_selcar = o_lote_ped->i_car_char.
  ENDIF.


ENDMETHOD.
METHOD get_sel_car_ped.
  DATA: l_selc TYPE bapi1003_alloc_values_char,
        i_selc TYPE TABLE OF bapi1003_alloc_values_char,
        i_selc_unif TYPE zt_sel_car,
        l_selc_unif type zsel_car,
        l_selcar TYPE zsel_car_pedido,
        i_vbap TYPE TABLE OF vbap,
        l_vbap TYPE vbap.

  SELECT * FROM vbap
    INTO TABLE i_vbap
   WHERE vbeln = vbeln.

  LOOP AT i_vbap INTO l_vbap.
    IF unif = ''.
      i_selc = get_sel_car( vbeln = l_vbap-vbeln
                            posnr = l_vbap-posnr
                            no_valor_por_defecto = no_valor_por_defecto ).
      LOOP AT i_selc INTO l_selc.
        CLEAR l_selcar.
        MOVE-CORRESPONDING l_selc TO l_selcar.
        l_selcar-vbeln = l_vbap-vbeln.
        l_selcar-posnr = l_vbap-posnr.
        l_selcar-matnr = l_vbap-matnr.
        APPEND l_selcar TO i_selcar.
      ENDLOOP.
    ELSE.
      i_selc_unif = get_sel_car_unif( vbeln = l_vbap-vbeln
                                      posnr = l_vbap-posnr
                                      no_valor_por_defecto = no_valor_por_defecto ).
      LOOP AT i_selc_unif INTO l_selc_unif.
        CLEAR l_selcar.
        MOVE-CORRESPONDING l_selc_unif TO l_selcar.
        l_selcar-value_char = l_selc_unif-value.
        l_selcar-vbeln = l_vbap-vbeln.
        l_selcar-posnr = l_vbap-posnr.
        l_selcar-matnr = l_vbap-matnr.
        APPEND l_selcar TO i_selcar.
      ENDLOOP.
    ENDIF.
  ENDLOOP.

ENDMETHOD.
METHOD get_sel_car_ped_cliente.
  DATA: l_selc TYPE bapi1003_alloc_values_char,
        i_selc TYPE TABLE OF bapi1003_alloc_values_char,
        l_selcar TYPE zsel_car_pedido,
        i_vbap TYPE TABLE OF vbap,
        l_vbap TYPE vbap.

  SELECT *
    FROM vbap JOIN vbak ON vbap~vbeln = vbak~vbeln
    INTO CORRESPONDING FIELDS OF TABLE i_vbap
   WHERE KUNNR    = KUNNR
     AND cuobj_ch NE ''.

  LOOP AT i_vbap INTO l_vbap.
    i_selc = get_sel_car( vbeln = l_vbap-vbeln
                          posnr = l_vbap-posnr
                          no_valor_por_defecto = no_valor_por_defecto ).
    LOOP AT i_selc INTO l_selc.
      CLEAR l_selcar.
      MOVE-CORRESPONDING l_selc TO l_selcar.
      l_selcar-vbeln = l_vbap-vbeln.
      l_selcar-posnr = l_vbap-posnr.
      l_selcar-matnr = l_vbap-matnr.
      APPEND l_selcar TO i_selcar.
    ENDLOOP.
  ENDLOOP.

ENDMETHOD.
METHOD get_sel_car_unif.
  DATA: o_lote_ped TYPE REF TO zcl_clas_lote,
        l_selcar TYPE zsel_car,
        l_param TYPE zparametros,
        l_vbap TYPE vbap.

  CLEAR i_selcar.

* Sólo buscamos características, si es un pedido de ventas
  SELECT SINGLE * FROM vbap
    INTO l_vbap
   WHERE vbeln = vbeln
     AND posnr = posnr.
  CHECK sy-subrc = 0.

  CREATE OBJECT o_lote_ped.

  o_lote_ped->get_datos_pedido( vbeln = vbeln
                                posnr = posnr
                                opt   = 'X'
                                unif  = 'X' ).

  IF o_lote_ped->i_car_char[] IS INITIAL.
    IF no_valor_por_defecto IS INITIAL.
      SELECT * FROM zparametros
        INTO l_param
       WHERE clave = 'CAR_DEFECT'.
        CLEAR l_selcar.
        l_selcar-charact = l_param-campo.
        l_selcar-value   = l_param-atributo1.
        APPEND l_selcar TO i_selcar.
      ENDSELECT.
    ENDIF.
  ELSE.
    i_selcar = o_lote_ped->i_car_unif.
  ENDIF.


ENDMETHOD.
METHOD get_usuarios_proceso.
  DATA: r_vkorg TYPE RANGE OF vkorg,
        r_vkgrp TYPE RANGE OF vkgrp,
        r_ernam TYPE RANGE OF ernam,
        r_aenam TYPE RANGE OF aenam,
*        r_marca TYPE RANGE OF zmarca_mat,
        lr_vkorg LIKE LINE OF r_vkorg,
        lr_vkgrp LIKE LINE OF r_vkgrp,
        lr_ernam LIKE LINE OF r_ernam,
        lr_aenam LIKE LINE OF r_aenam,
*        lr_marca LIKE LINE OF r_marca,
        i_avisos TYPE TABLE OF zsd_us_avisos,
        l_avisos TYPE zsd_us_avisos,
        l_username TYPE bapiusname.

  CLEAR i_usnam.

  IF NOT vbak-vkorg IS INITIAL.
    lr_vkorg-option = 'EQ'.
    lr_vkorg-sign   = 'I'.
    lr_vkorg-low    = vbak-vkorg.
    APPEND lr_vkorg TO r_vkorg.
  ENDIF.

  IF NOT vbak-vkgrp IS INITIAL.
    lr_vkgrp-option = 'EQ'.
    lr_vkgrp-sign   = 'I'.
    lr_vkgrp-low    = vbak-vkgrp.
    APPEND lr_vkgrp TO r_vkgrp.
  ENDIF.

  IF NOT vbak-ernam IS INITIAL.
    lr_ernam-option = 'EQ'.
    lr_ernam-sign   = 'I'.
    lr_ernam-low    = vbak-ernam.
    APPEND lr_ernam TO r_ernam.
  ENDIF.

*  IF NOT vbak-aenam IS INITIAL.
*    lr_aenam-option = 'EQ'.
*    lr_aenam-sign   = 'I'.
*    lr_aenam-low    = vbak-aenam.
*    APPEND lr_aenam TO r_aenam.
*  ENDIF.

  SELECT * FROM zsd_us_avisos
    INTO TABLE i_avisos
   WHERE proceso = proceso
     AND ( vkorg IN r_vkorg OR vkorg = '*' )
     AND ( vkgrp IN r_vkgrp OR vkgrp = '*' )
     AND ( ernam IN r_ernam OR ernam = '*' ).

* Añado el primero que encuentré válido
  LOOP AT i_avisos INTO l_avisos WHERE prioridad < '90'.
    IF NOT l_avisos-notificar IS INITIAL.
      l_username-username = l_avisos-notificar.
      APPEND l_username TO i_usnam.
    ENDIF.
    IF NOT l_avisos-notificar_email IS INITIAL.
      l_username-fullname = l_avisos-notificar_email.
      APPEND l_username TO i_usnam.
    ENDIF.
    IF NOT l_avisos-copia IS INITIAL.
      l_username-username = l_avisos-copia.
      l_username-lastname = 'COPIA'.
      APPEND l_username TO i_usnam.
    ENDIF.
    IF NOT l_avisos-copia_email IS INITIAL.
      l_username-fullname = l_avisos-copia_email.
      l_username-lastname = 'COPIA'.
      APPEND l_username TO i_usnam.
    ENDIF.
    EXIT.
  ENDLOOP.

* Los de prioridad mayor de 90 los añado todos
  LOOP AT i_avisos INTO l_avisos WHERE prioridad >= '90'.
    IF NOT l_avisos-notificar IS INITIAL.
      l_username-username = l_avisos-notificar.
      APPEND l_username TO i_usnam.
    ENDIF.
    IF NOT l_avisos-notificar_email IS INITIAL.
      l_username-fullname = l_avisos-notificar_email.
      APPEND l_username TO i_usnam.
    ENDIF.
    IF NOT l_avisos-copia IS INITIAL.
      l_username-username = l_avisos-copia.
      l_username-lastname = 'COPIA'.
      APPEND l_username TO i_usnam.
    ENDIF.
    IF NOT l_avisos-copia_email IS INITIAL.
      l_username-fullname = l_avisos-copia_email.
      l_username-lastname = 'COPIA'.
      APPEND l_username TO i_usnam.
    ENDIF.
  ENDLOOP.


ENDMETHOD.
METHOD get_valor_anticipos.
  DATA: i_anticipos TYPE trty_bsid,
        l_bsid TYPE bsid.

  CLEAR valor.
  i_anticipos = get_anticipos_pedido( vbeln = vbeln
                                      posnr = posnr
                                      blart = blart
                                      solo_cabecera = solo_cabecera ).

  LOOP AT i_anticipos INTO l_bsid.
    IF l_bsid-shkzg = 'H'.
      ADD l_bsid-dmbtr TO valor.
    ELSE.
      SUBTRACT l_bsid-dmbtr FROM  valor.
    ENDIF.
  ENDLOOP.

  IF valor < 0.
    CLEAR valor.
  ENDIF.

ENDMETHOD.                    "handle_double_click
METHOD get_valor_pend_fact.
  DATA: r_posnr TYPE RANGE OF vbap-posnr,
        l_posnr LIKE LINE OF r_posnr,
        i_vbap TYPE TABLE OF vbap,
        i_vbfa TYPE TABLE OF vbfa,
        l_vbtyp TYPE vbtyp,
        l_valfact TYPE netwr,
        r_fktyp TYPE RANGE OF vbrk-fktyp,
        lr_fktyp LIKE LINE OF r_fktyp,
        l_netwr type vbap-netwr.

  FIELD-SYMBOLS: <vbap> TYPE vbap,
                 <vbfa> TYPE vbfa.

  CLEAR netwr.

  IF NOT posnr IS INITIAL.
    l_posnr-option = 'EQ'.
    l_posnr-sign   = 'I'.
    l_posnr-low    = posnr.
    APPEND l_posnr TO r_posnr.
  ENDIF.

  SELECT SINGLE vbtyp FROM vbak
    INTO l_vbtyp
   WHERE vbeln = vbeln.

  SELECT * FROM vbap
    INTO TABLE i_vbap
   WHERE vbeln = vbeln
     AND posnr IN r_posnr
     AND abgru = ''.

  CLEAR lr_fktyp.
  lr_fktyp-option = 'EQ'.
  lr_fktyp-sign   = 'I'.

  IF fkart = 'ZIV1' OR
     fkart = 'ZIG'  OR
     fkart = 'ZZIG'.
    lr_fktyp-low = '5'. APPEND lr_fktyp TO r_fktyp.
    lr_fktyp-low = '6'. APPEND lr_fktyp TO r_fktyp.
  ELSE.
    lr_fktyp-low = 'M'. APPEND lr_fktyp TO r_fktyp.
    lr_fktyp-low = 'N'. APPEND lr_fktyp TO r_fktyp.
    lr_fktyp-low = 'O'. APPEND lr_fktyp TO r_fktyp.
    lr_fktyp-low = 'P'. APPEND lr_fktyp TO r_fktyp.
  ENDIF.

  LOOP AT i_vbap ASSIGNING <vbap>.

    IF fkart = 'ZIV1' OR
       fkart = 'ZIG'  OR
       fkart = 'ZZIG'.
      l_netwr = get_valor_condicion( vbeln = <vbap>-vbeln
                                                         posnr = <vbap>-posnr
                                                         kschl = 'ZETP' ).
      if l_netwr ne 0.
        <vbap>-netwr = l_netwr.
      endif.
    ENDIF.

    SELECT * FROM vbfa
      INTO TABLE i_vbfa
     WHERE vbelv = vbeln
       AND posnv = <vbap>-posnr
       AND vbtyp_n IN r_fktyp
       AND stufe IN ('00')
       AND plmin IN ('+', '-').
    IF sy-subrc NE 0.
      SELECT * FROM vbfa
        INTO TABLE i_vbfa
       WHERE vbelv = vbeln
         AND posnv = <vbap>-posnr
         AND vbtyp_n IN r_fktyp
         AND stufe IN ('01').
      LOOP AT i_vbfa ASSIGNING <vbfa>.
        IF <vbfa>-vbtyp_n = 'M' OR <vbfa>-vbtyp_n = 'O' or <vbfa>-vbtyp_n = '5'.
          <vbfa>-plmin = '+'.
        ELSE.
          <vbfa>-plmin = '-'.
        ENDIF.
      ENDLOOP.
    ENDIF.

    netwr = netwr + <vbap>-netwr.
    LOOP AT i_vbfa ASSIGNING <vbfa>.
      IF <vbfa>-plmin = '-'.
        netwr = netwr + <vbfa>-rfwrt.
      ELSE.
        netwr = netwr - <vbfa>-rfwrt.
      ENDIF.
    ENDLOOP.
  ENDLOOP.
ENDMETHOD.
METHOD set_mails_proceso.
  DATA: i_usnam        TYPE TABLE OF zsd_us_avisos,
        l_usnam        TYPE zsd_us_avisos,
        l_mail_externo.

  i_usnam = zcl_ped_sd=>get_mails_proceso( proceso = proceso vbak = vbak aenam = aenam ).

  IF NOT i_usnam IS INITIAL.
    LOOP AT i_usnam INTO l_usnam.
      SKIP.
      WRITE: / 'Proceso:', l_usnam-proceso,
             / 'Priodidad:', l_usnam-prioridad,
             / 'Org.Ventas:', l_usnam-vkorg,
             / 'Grupo Vend.:', l_usnam-vkgrp,
             / 'Creador:', l_usnam-ernam,
             / 'Modificado por:', l_usnam-aenam,
             / 'Marca:', l_usnam-vkorg,                    "l_usnam-zzmar,
             / 'Jerarquía:', l_usnam-prodh,
             / 'Func/Vis.:', l_usnam-vkorg,                "l_usnam-funcvis,
             / 'Devolución:', l_usnam-vkorg                "l_usnam-devolucion
.
      SKIP.
      IF l_usnam-notificar NE ''.
        IF test = 'X'.
          WRITE: / 'Envio correo a:', l_usnam-notificar.
        ELSE.
          zcl_ap_log=>set_log( proceso = 'MAIL_PEDSD' p1 = 'Mail a ' p2 = l_usnam-notificar msgty = 'S' ).
          o_mail->add_destinatario( destinatario = l_usnam-notificar
                                    forzar_mail_externo = l_mail_externo ).
        ENDIF.
      ENDIF.
      IF l_usnam-copia NE ''.
        IF test = 'X'.
          WRITE: / 'Envio copia a:', l_usnam-copia.
        ELSE.
          zcl_ap_log=>set_log( proceso = 'MAIL_PEDSD' p1 = 'Copia a ' p2 = l_usnam-copia msgty = 'S' ).
          o_mail->add_destinatario( destinatario = l_usnam-copia
                                    forzar_mail_externo = l_mail_externo ).
        ENDIF.
      ENDIF.

      IF l_usnam-notificar_email NE ''.
        IF test = 'X'.
          WRITE: / 'Envio notificación a:', l_usnam-notificar_email.
        ELSE.
          zcl_ap_log=>set_log( proceso = 'MAIL_PEDSD' p1 = 'Se notifica a ' p2 = l_usnam-notificar_email msgty = 'S' ).
          o_mail->add_destinatario( destinatario = l_usnam-notificar_email ).
        ENDIF.
      ENDIF.

      IF l_usnam-copia_email NE ''.
        IF test = 'X'.
          WRITE: / 'Envio copia mail a:', l_usnam-copia_email.
        ELSE.
          zcl_ap_log=>set_log( proceso = 'MAIL_PEDSD' p1 = 'Copia email a ' p2 = l_usnam-copia_email msgty = 'S' ).
          o_mail->add_destinatario( destinatario = l_usnam-copia_email ).
        ENDIF.
      ENDIF.
    ENDLOOP.

    IF test = 'X'.
      o_mail->add_destinatario( destinatario = sy-uname ).
    ENDIF.
  ELSE.
    WRITE: / 'NO SE HAN ENCONTRADO DESTINATARIOS!'.
    zcl_ap_log=>set_log( proceso = 'MAIL_PEDSD' p1 = 'No se han encontrado destinatarios' ).
  ENDIF.

ENDMETHOD.
