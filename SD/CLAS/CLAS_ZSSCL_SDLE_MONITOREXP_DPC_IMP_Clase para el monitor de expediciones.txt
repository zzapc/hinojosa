
class ZSSCL_SDLE_MONITOREXP_DPC_IMP definition
  public
  create public .

public section.

  data GC_ESTADO_LOG_OK type ZED_ESTADO_LOG value 1 ##NO_TEXT.
  data GC_ESTADO_LOG_NOOK type ZED_ESTADO_LOG value 2 ##NO_TEXT.

  methods MONITOR_GETLIST
    importing
      !VP_LIFNR type LIFNR
      !VP_WERKS type WERKS_D
      !VP_LGORT type LGORT_D
      !VP_SEL_ELIKZ type ZED_SEL_ELIKZ
    returning
      value(TP_MONITOR) type ZTT_SDLE_MONITOREXP .
  methods MONITORLOG_GETLIST
    importing
      !LP_R_TKNUM type EFG_TAB_RANGES optional
      !LP_R_NTRA type EFG_TAB_RANGES optional
      !LP_R_MBLNR type EFG_TAB_RANGES optional
      !LP_R_MJAHR type EFG_TAB_RANGES optional
      !LP_R_VBELN type EFG_TAB_RANGES optional
      !LP_R_POSNR type EFG_TAB_RANGES optional
      !LP_R_VBELN2 type EFG_TAB_RANGES optional
      !LP_R_ERDAT type EFG_TAB_RANGES
      !LP_R_RESP type EFG_TAB_RANGES
    returning
      value(TP_MONITORLOG) type ZTT_SDLE_MONITOREXPLOG .
  methods PROCESAR_TRANSPORTE
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods TRANS_CAB_CREATE
    changing
      !WP_TRANS_CAB type ZST_SDLE_TRANSP_CAB
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods TRANS_CAB_GETDETAIL
    importing
      !VP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    returning
      value(WP_TRANS_CAB) type ZST_SDLE_TRANSP_CAB
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods TRANS_CAB_GETLIST
    importing
      !VP_ESTADO type ZED_ESTADO_TRANS_SUBCO optional
      !VP_RESPONSABLE type ZED_RESPONSABLE optional
    returning
      value(TP_TRANS_CAB) type ZTT_SDLE_TRANSP_CAB
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods TRANS_CAB_UPDATE
    importing
      !WP_TRANS_CAB type ZST_SDLE_TRANSP_CAB
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods TRANS_HU_CREATE
    changing
      !WP_TRANS_HU type ZST_SDLE_TRANSP_HU
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods TRANS_HU_DELETE
    importing
      !WP_TRANS_HU type ZST_SDLE_TRANSP_HU
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods CIERRE_VBAP
    importing
      !LP_VBELN type VBELN
      !LP_POSNR type POSNR
    returning
      value(LP_RETURN) type BAPIRET2_T
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods CIERRE_EKPO
    importing
      !LP_EBELN type EBELN
      !LP_EBELP type EBELP
    returning
      value(LP_RETURN) type BAPIRET2_T
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods CHK_LOCK_DLV
    importing
      !LP_VBELN type VBELN_VL .
  methods ANULAR_TRANSPORTE
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods TRANS_HU_GETLIST
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
      !LP_MATNR_FINAL type ZED_MATNR_FINAL
      !LP_CHARG type CHARG_D
    returning
      value(TP_TRANS_HU) type ZTT_SDLE_TRANSP_HU
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods ANULAR_CIERRE_VBAP
    importing
      !LP_VBELN type VBELN
      !LP_POSNR type POSNR
    returning
      value(LP_RETURN) type BAPIRET2_T
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods ANULAR_CIERRE_EKPO
    importing
      !LP_EBELN type EBELN
      !LP_EBELP type EBELP
    returning
      value(LP_RETURN) type BAPIRET2_T
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods TRANS_LOG_CREATE
    changing
      !WP_TRANS_LOG type ZST_SDLE_TRANSP_LOG
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods TRANS_LOG_GETLIST
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
      !LP_PASO type ZED_PASO_LOG optional
      !LP_ESTADO type ZED_ESTADO_LOG optional
      !LP_BUSCAR_PASO_CERO type XFLAG optional
    returning
      value(LP_TRANS_LOG) type ZTT_SDLE_TRANSP_LOG
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods TRANS_LOG_MSG_CREATE
    changing
      !LP_TRANS_LOG_MSG type ZST_SDLE_TRANSP_LOG_MSG
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods TRANS_POS_CREATE
    changing
      !WP_TRANS_POS type ZST_SDLE_TRANSP_POS
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods TRANS_POS_DELETE
    importing
      !WP_TRANS_POS type ZST_SDLE_TRANSP_POS
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods TRANS_POS_GETLIST
    importing
      !VP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO optional
    returning
      value(TP_TRANS_POS) type ZTT_SDLE_TRANSP_POS
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods ULTIMO_DESTINO
    importing
      !LP_MATNR type MATNR_D
      !LP_CHARG type CHARG_D
      !LP_TRANS_CAB type ZST_SDLE_TRANSP_CAB
    returning
      value(LP_ULTIMO_DESTINO) type CHAR1 .
  methods VALIDAR_TRANSPORTE
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods ACTUALIZAR_PICKING
    importing
      !LP_VBELN type VBELN_VL
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
protected section.
private section.

  data GC_PASO_CONVERTIR_STOCK_CLI type ZED_PASO_LOG value 000 ##NO_TEXT.
  data GC_PASO_NOTIFICAR_ENTRADA_PT type ZED_PASO_LOG value 001 ##NO_TEXT.
  data GC_PASO_CREACION_PEDIDOS_VTA type ZED_PASO_LOG value 002 ##NO_TEXT.
  data GC_PASO_MODIFICAR_VSTEL_PV type ZED_PASO_LOG value 003 ##NO_TEXT.
  data GC_PASO_CREACION_ES_CLIENTE type ZED_PASO_LOG value 004 ##NO_TEXT.
  data GC_PASO_CREACION_PEDIDO_TRAS type ZED_PASO_LOG value 005 ##NO_TEXT.
  data GC_PASO_CREACION_ES_TRASLADO type ZED_PASO_LOG value 006 ##NO_TEXT.
  data GC_PASO_CREACION_TRANSPORTE type ZED_PASO_LOG value 007 ##NO_TEXT.
  data GC_PASO_ANULACION_TRANSPORTE type ZED_PASO_LOG value 008 ##NO_TEXT.
  data GC_PASO_ANULACION_ES_TRASLADO type ZED_PASO_LOG value 009 ##NO_TEXT.
  data GC_PASO_ANULACION_PEDIDO_TRAS type ZED_PASO_LOG value 010 ##NO_TEXT.
  data GC_PASO_ANULACION_ES_CLIENTE type ZED_PASO_LOG value 011 ##NO_TEXT.
  data GC_PASO_ANULACION_VSTEL_PV type ZED_PASO_LOG value 012 ##NO_TEXT.
  data GC_PASO_ANULACION_PEDIDOS_VTA type ZED_PASO_LOG value 013 ##NO_TEXT.
  data GC_PASO_ANULACION_NOT_ENT_PT type ZED_PASO_LOG value 014 ##NO_TEXT.
  data GC_PASO_CIERRE_PEDIDO type ZED_PASO_LOG value 015 ##NO_TEXT.
  data GC_PASO_ANULACION_CIERRE_PED type ZED_PASO_LOG value 016 ##NO_TEXT.

  methods NOTIFICAR_ENTRADA_MAT
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods MODIFICAR_VSTEL_PV
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods ENTREGA_FINAL_PEDIDO
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods CREACION_TRANSPORTE
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods CREACION_PEDIDO_TRASLADO
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods CREACION_PEDIDOS_VENTA
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods CREACION_ES_TRASLADO
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods CREACION_ES_CLIENTE
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods CONVERTIR_STOCK_CLIENTE
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods ANULAR_SM_ES
    importing
      !LP_VBELN type VBELN_VL
    returning
      value(LT_RETURN) type BAPIRET2_T
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods ANULACION_TRANSPORTE
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods ANULACION_PEDIDO_TRASLADO
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods ANULACION_PEDIDOS_VENTA
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods ANULACION_MOD_VSTEL_PV
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods ANULACION_ES_TRASLADO
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods ANULACION_ES_CLIENTE
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods ANULACION_ENTREGA_FINAL_PEDIDO
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
  methods ANULACION_ENTRADA_MAT
    importing
      !LP_NUMTRANSPORTE type ZED_NUMTRANS_SUBCO
    raising
      /IWBEP/CX_MGW_BUSI_EXCEPTION .
endclass. "ZSSCL_SDLE_MONITOREXP_DPC_IMP definition
class ZSSCL_SDLE_MONITOREXP_DPC_IMP implementation.
  METHOD actualizar_picking.

    DATA: lt_verko_tab      TYPE TABLE OF  verko,
          lt_verpo_tab      TYPE TABLE OF  verpo,
          ls_headerproposal TYPE  bapihuhdrproposal,
          lv_hukey          TYPE  bapihukey-hu_exid,
          ls_huheader       TYPE  bapihuheader,
          lt_itemsproposal  TYPE TABLE OF  bapihuitmproposal,
          lt_return         TYPE bapiret2_t.

    DATA: vl_vbkok_wa                 TYPE vbkok,
          vl_delivery                 TYPE likp-vbeln,
          tl_it_handling_units        TYPE TABLE OF hum_rehang_hu,
          wl_it_handling_units        LIKE LINE OF tl_it_handling_units,
          vl_error_any_0              TYPE xfeld,
          vl_error_in_item_deletion_0 TYPE xfeld,
          vl_error_in_pod_update_0    TYPE xfeld,
          vl_error_in_interface_0     TYPE xfeld,
          vl_error_in_goods_issue_0   TYPE xfeld,
          vl_error_in_final_check_0   TYPE xfeld,
          vl_error_partner_update     TYPE xfeld,
          vl_error_sernr_update       TYPE xfeld.

    vl_vbkok_wa-vbeln_vl = lp_vbeln.
    vl_delivery = lp_vbeln.
    REFRESH tl_it_handling_units.
    CLEAR wl_it_handling_units.
*
    DATA: it_partner_update TYPE shp_partner_update_t,
          it_sernr_update   TYPE shp_sernr_update_t.

    DATA: tl_vbpok TYPE TABLE OF vbpok,
          tl_prot  TYPE TABLE OF prott.

    CLEAR: lt_verko_tab, lt_verpo_tab.

**** REFRESH HU PACKING
    CALL FUNCTION 'HU_PACKING_REFRESH'.

**** REFRESH DELIVERY BUFFER
    CALL FUNCTION 'LE_DELIVERY_REFRESH_BUFFER'
      EXCEPTIONS
        no_key_specified = 0
        OTHERS           = 0.

    SELECT SINGLE *
      INTO @DATA(ls_likp)
      FROM likp
      WHERE vbeln = @lp_vbeln.

    "Volvemos a ver los lotes asignados a entregas
    SELECT *
      INTO TABLE @DATA(tl_lips_lote)
      FROM lips
      WHERE vbeln = @lp_vbeln      AND
            charg <> ''.
    LOOP AT tl_lips_lote ASSIGNING FIELD-SYMBOL(<fs_lips_lote>).

      DATA(lt_hu) = trans_hu_getlist( lp_numtransporte = lp_numtransporte lp_matnr_final = <fs_lips_lote>-matnr lp_charg = <fs_lips_lote>-charg ).

      APPEND INITIAL LINE TO tl_vbpok ASSIGNING FIELD-SYMBOL(<fs_vbpok>).
      <fs_vbpok>-vbeln_vl = <fs_lips_lote>-vbeln.
      <fs_vbpok>-posnr_vl = <fs_lips_lote>-posnr.
      <fs_vbpok>-vbeln    = <fs_lips_lote>-vbeln.
      <fs_vbpok>-posnn    = <fs_lips_lote>-posnr.
      <fs_vbpok>-lfimg    = <fs_lips_lote>-lfimg.
      <fs_vbpok>-umvkz    = <fs_lips_lote>-umvkz.
      <fs_vbpok>-umvkn    = <fs_lips_lote>-umvkn.

      <fs_vbpok>-pikmg    = <fs_lips_lote>-lfimg. "Cantidad de picking
      <fs_vbpok>-taqui    = 'X'.
      IF lt_hu IS NOT INITIAL.
        "
        " El usuario ha indicado como quiere paletizar la entrega.
        "
        LOOP AT lt_hu ASSIGNING FIELD-SYMBOL(<fs_hu>).
          CLEAR: ls_headerproposal,
                        lv_hukey,
                        ls_huheader,
                        lt_itemsproposal,
                        lt_return.

          ls_headerproposal-hu_status_init = 'B'. "i_hu_st_init.
          ls_headerproposal-hu_exid_type = 'F'.
          ls_headerproposal-pack_mat = <fs_hu>-vhilm.

          CALL FUNCTION 'BAPI_HU_CREATE'
            EXPORTING
              headerproposal = ls_headerproposal
            IMPORTING
              huheader       = ls_huheader
              hukey          = lv_hukey
            TABLES
*             itemsproposal  = itemsproposal
*             ITEMSSERIALNO  =
              return         = lt_return
*             HUITEM         =
            .

          READ TABLE lt_return TRANSPORTING NO FIELDS WITH KEY type = 'E'.
          IF sy-subrc NE 0.
            CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
              EXPORTING
                wait = 'X'.

            CLEAR lt_return.
            WAIT UP TO 1 SECONDS.

            " Set connection to the outbound delivery type (pack_mat_object)
            IF ls_likp-lfart = 'ZLR'.
              ls_huheader-pack_mat_object = '03'. " entrega de devolución
              ls_huheader-item_categ = 'ZHUD'.
            ELSEIF ls_likp-lfart = 'ZNL1' OR ls_likp-lfart = 'ZNL'.
              ls_huheader-pack_mat_object = '01'. " entrega Traslado
              ls_huheader-item_categ = 'ZHUN'.
            ELSE.
              ls_huheader-pack_mat_object = '01'.
              ls_huheader-item_categ = 'ZHUP'.
            ENDIF.

            ls_huheader-pack_mat_obj_key = lp_vbeln.
            ls_huheader-salesorg = ls_likp-vkorg.
            ls_huheader-dc_custom_mat = '10'.
            ls_huheader-plant = <fs_lips_lote>-werks.
            ls_huheader-stge_loc = <fs_lips_lote>-lgort. "'5000'. "Confirmado con Andrea el 15.07.24

            REFRESH lt_return.
            CALL FUNCTION 'BAPI_HU_CHANGE_HEADER'
              EXPORTING
                hukey     = ls_huheader-hu_exid
                huchanged = ls_huheader
              IMPORTING
                huheader  = ls_huheader
              TABLES
                return    = lt_return.

            READ TABLE lt_return TRANSPORTING NO FIELDS WITH KEY type = 'E'.
            IF sy-subrc NE 0.
              CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
                EXPORTING
                  wait = 'X'.

              APPEND INITIAL LINE TO lt_verko_tab ASSIGNING FIELD-SYMBOL(<ls_verko>).
              <ls_verko>-exidv = lv_hukey.
              <ls_verko>-venum = ls_huheader-hu_id.
              <ls_verko>-vhilm = ls_headerproposal-pack_mat.

              "Calculamos la cantidad por embalaje que debe ir.
              APPEND INITIAL LINE TO lt_verpo_tab ASSIGNING FIELD-SYMBOL(<ls_verpo>).
              <ls_verpo>-exidv_ob = lv_hukey.
              <ls_verpo>-exidv = lv_hukey.
              <ls_verpo>-venum = ls_huheader-hu_id.
              <ls_verpo>-velin = '1'.
              <ls_verpo>-vbeln = lp_vbeln.
              <ls_verpo>-posnr = <fs_lips_lote>-posnr.
              <ls_verpo>-tmeng    = <fs_hu>-tmeng.

              <ls_verpo>-matnr    = <fs_lips_lote>-matnr.
              <ls_verpo>-charg    = <fs_lips_lote>-charg.
              <ls_verpo>-werks    = <fs_lips_lote>-werks.
              <ls_verpo>-lgort    = <fs_lips_lote>-lgort.
            ELSE.
              CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.

            ENDIF.
          ELSE.
            CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
          ENDIF.
        ENDLOOP.
      ELSE.
        "
        " Calculamos HUs.
        "

        " OBtener material embalaje.
        DATA lv_vhilm TYPE vhilm.
        CLEAR lv_vhilm.
***      CALL FUNCTION 'ZSWM_UI5_GET_VHILM'
***        EXPORTING
***          matnr = <fs_lips_lote>-matnr
***          werks = <fs_lips_lote>-werks
***          charg = <fs_lips_lote>-charg
***          vbtyp = 'J'
****         TXTGET            =
***        IMPORTING
****         ERROR =
****         TT_LOG            =
***          vhilm = lv_vhilm.
*      DATA lr_zhcl_sd_hu_core type REF TO zhcl_sd_hu_core.
        zhcl_sd_hu_core=>get_vhilm( EXPORTING lp_matnr = <fs_lips_lote>-matnr
                                              lp_werks = <fs_lips_lote>-werks
                                              lp_charg = <fs_lips_lote>-charg
                                              IMPORTING lp_vhilm = lv_vhilm ).

        "
        " Obtener datos del material
        "
        SELECT SINGLE cuobj
          INTO @DATA(vl_cuobj)
          FROM marc
          WHERE matnr EQ @<fs_lips_lote>-matnr AND
                werks EQ @<fs_lips_lote>-werks.

        IF sy-subrc <> 0.
          CLEAR vl_cuobj.
        ENDIF.

        SELECT SINGLE *
          INTO @DATA(wl_yhp_idx_td151)
          FROM yhp_idx_td151
          WHERE cuobj = @vl_cuobj AND
                shuty = 'UNIT'.
        IF sy-subrc <> 0.
          CLEAR wl_yhp_idx_td151.
        ENDIF.

        DATA(lv_cant_pendiente) = <fs_lips_lote>-lfimg.
        DATA(lv_num_palets) = 0.
        IF wl_yhp_idx_td151-tbqty <> 0.
          lv_num_palets = ceil( <fs_lips_lote>-lfimg / wl_yhp_idx_td151-tbqty ).
        ENDIF.

        DO lv_num_palets TIMES.
          CLEAR: ls_headerproposal,
              lv_hukey,
              ls_huheader,
              lt_itemsproposal,
              lt_return.

          ls_headerproposal-hu_status_init = 'B'. "i_hu_st_init.
          ls_headerproposal-hu_exid_type = 'F'.
          ls_headerproposal-pack_mat = lv_vhilm.

          CALL FUNCTION 'BAPI_HU_CREATE'
            EXPORTING
              headerproposal = ls_headerproposal
            IMPORTING
              huheader       = ls_huheader
              hukey          = lv_hukey
            TABLES
*             itemsproposal  = itemsproposal
*             ITEMSSERIALNO  =
              return         = lt_return
*             HUITEM         =
            .

          READ TABLE lt_return TRANSPORTING NO FIELDS WITH KEY type = 'E'.
          IF sy-subrc NE 0.
            CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
              EXPORTING
                wait = 'X'.

            CLEAR lt_return.
            WAIT UP TO 1 SECONDS.

            " Set connection to the outbound delivery type (pack_mat_object)
            IF ls_likp-lfart = 'ZLR'.
              ls_huheader-pack_mat_object = '03'. " entrega de devolución
              ls_huheader-item_categ = 'ZHUD'.
            ELSEIF ls_likp-lfart = 'ZNL1' OR ls_likp-lfart = 'ZNL'.
              ls_huheader-pack_mat_object = '01'. " entrega Traslado
              ls_huheader-item_categ = 'ZHUN'.
            ELSE.
              ls_huheader-pack_mat_object = '01'.
              ls_huheader-item_categ = 'ZHUP'.
            ENDIF.

            ls_huheader-pack_mat_obj_key = lp_vbeln.
            ls_huheader-salesorg = ls_likp-vkorg.
            ls_huheader-dc_custom_mat = '10'.
            ls_huheader-plant = <fs_lips_lote>-werks.
            ls_huheader-stge_loc = <fs_lips_lote>-lgort. "'5000'. "Confirmado con Andrea el 15.07.24


            REFRESH lt_return.
            CALL FUNCTION 'BAPI_HU_CHANGE_HEADER'
              EXPORTING
                hukey     = ls_huheader-hu_exid
                huchanged = ls_huheader
              IMPORTING
                huheader  = ls_huheader
              TABLES
                return    = lt_return.

            READ TABLE lt_return TRANSPORTING NO FIELDS WITH KEY type = 'E'.
            IF sy-subrc NE 0.
              CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
                EXPORTING
                  wait = 'X'.


              "Calculamos la cantidad por embalaje que debe ir.
*          APPEND INITIAL LINE TO itemsproposal ASSIGNING FIELD-SYMBOL(<ls_itemproposal>).
*          <ls_itemproposal>-hu_item_type = '1'.
*          <ls_itemproposal>-pack_qty    = ls_position-cajas_pallets.
*          <ls_itemproposal>-base_unit_qty    = ls_position-meins.
*          <ls_itemproposal>-material    = ls_lips-matnr.
*          <ls_itemproposal>-batch    = ls_lips-charg.
*          <ls_itemproposal>-plant    = ls_lips-werks.
*          <ls_itemproposal>-stge_loc    = ls_lips-lgort.


              APPEND INITIAL LINE TO lt_verko_tab ASSIGNING <ls_verko>.
              <ls_verko>-exidv = lv_hukey.
              <ls_verko>-venum = ls_huheader-hu_id.
              <ls_verko>-vhilm = ls_headerproposal-pack_mat.

              "Calculamos la cantidad por embalaje que debe ir.
              APPEND INITIAL LINE TO lt_verpo_tab ASSIGNING <ls_verpo>.
              <ls_verpo>-exidv_ob = lv_hukey.
              <ls_verpo>-exidv = lv_hukey.
              <ls_verpo>-venum = ls_huheader-hu_id.
              <ls_verpo>-velin = '1'.
              <ls_verpo>-vbeln = lp_vbeln.
              <ls_verpo>-posnr = <fs_lips_lote>-posnr.
              IF lv_cant_pendiente < wl_yhp_idx_td151-tbqty.
                <ls_verpo>-tmeng    = lv_cant_pendiente.
              ELSE.
                <ls_verpo>-tmeng    = wl_yhp_idx_td151-tbqty.
              ENDIF.

              lv_cant_pendiente = lv_cant_pendiente - wl_yhp_idx_td151-tbqty.

              <ls_verpo>-matnr    = <fs_lips_lote>-matnr.
              <ls_verpo>-charg    = <fs_lips_lote>-charg.
              <ls_verpo>-werks    = <fs_lips_lote>-werks.
              <ls_verpo>-lgort    = <fs_lips_lote>-lgort.
            ELSE.
              CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.

            ENDIF.
          ELSE.
            CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.

          ENDIF.

        ENDDO.
      ENDIF.
    ENDLOOP.




    "Actualizar picking
    CALL FUNCTION 'WS_DELIVERY_UPDATE'
      EXPORTING
        vbkok_wa                    = vl_vbkok_wa
        commit                      = 'X'
        delivery                    = vl_delivery
        update_picking              = 'X'
        if_database_update          = '1'
        if_error_messages_send_0    = 'X'
        it_partner_update           = it_partner_update
        it_sernr_update             = it_sernr_update
      IMPORTING
        ef_error_any_0              = vl_error_any_0
        ef_error_in_item_deletion_0 = vl_error_in_item_deletion_0
        ef_error_in_pod_update_0    = vl_error_in_pod_update_0
        ef_error_in_interface_0     = vl_error_in_interface_0
        ef_error_in_goods_issue_0   = vl_error_in_goods_issue_0
        ef_error_in_final_check_0   = vl_error_in_final_check_0
        ef_error_partner_update     = vl_error_partner_update
        ef_error_sernr_update       = vl_error_sernr_update
      TABLES
        vbpok_tab                   = tl_vbpok
        verko_tab                   = lt_verko_tab
        verpo_tab                   = lt_verpo_tab
        prot                        = tl_prot
      EXCEPTIONS
        error_message               = 1
        OTHERS                      = 2.

    IF sy-subrc <> 0 OR
       vl_error_any_0               = 'X' OR
       vl_error_in_item_deletion_0  = 'X' OR
       vl_error_in_pod_update_0     = 'X' OR
       vl_error_in_interface_0      = 'X' OR
       vl_error_in_goods_issue_0    = 'X' OR
       vl_error_in_final_check_0    = 'X' OR
       vl_error_partner_update      = 'X' OR
       vl_error_sernr_update        = 'X'.
      IF tl_prot IS INITIAL.
        zcl_seis_odata_utils=>lanzar_excepcion( 'No se ha podido actualizar picking' ).
      ELSE.
        DATA wl_return TYPE bapiret2.
        READ TABLE tl_prot ASSIGNING FIELD-SYMBOL(<fs_prot>) INDEX 1.
        IF sy-subrc = 0.
          MOVE-CORRESPONDING <fs_prot> TO wl_return.
          wl_return-type = <fs_prot>-msgty.
          wl_return-id = <fs_prot>-msgid.
          wl_return-number = <fs_prot>-msgno.
          wl_return-message_v1 = <fs_prot>-msgv1.
          wl_return-message_v2 = <fs_prot>-msgv2.
          wl_return-message_v3 = <fs_prot>-msgv3.
          wl_return-message_v4 = <fs_prot>-msgv4.
          MESSAGE ID wl_return-id TYPE wl_return-type NUMBER wl_return-number WITH wl_return-message_v1 wl_return-message_v2 wl_return-message_v3 wl_return-message_v4 INTO wl_return-message.
          zcl_seis_odata_utils=>lanzar_excepcion( bapiret2 = wl_return ).
        ELSE.
          zcl_seis_odata_utils=>lanzar_excepcion( 'No se ha podido actualizar picking' ).
        ENDIF.
      ENDIF.
    ELSE.

      WAIT UP TO 1 SECONDS.

      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          wait = 'X'.

      DO 10 TIMES.
        SELECT SINGLE *
          FROM vbup
          INTO @DATA(ls_vbup)
          WHERE vbeln = @lp_vbeln AND
                koqua IN ('A', 'B'). " Confirmación picking pendiente.
        IF sy-subrc <> 0.
          " no hay nada pdte confirmar picking.
          EXIT.
        ELSE.
          WAIT UP TO 1 SECONDS.
        ENDIF.
      ENDDO.

    ENDIF.

  ENDMETHOD.
  METHOD anulacion_entrada_mat.
    DATA: lt_datos_a_not TYPE TABLE OF zst_sdle_notif_entr_mat.

    DATA: lv_datos_log     TYPE zst_sdle_transp_log,
          lv_datos_log_msg TYPE zst_sdle_transp_log_msg.

*    DATA: wl_goodsmvt_header  TYPE bapi2017_gm_head_01,
*          wl_goodsmvt_code    TYPE bapi2017_gm_code,
*          lv_materialdocument TYPE  bapi2017_gm_head_ret-mat_doc,
*          lv_matdocumentyear  TYPE  bapi2017_gm_head_ret-doc_year,
*          lt_goodsmvt_item    TYPE TABLE OF bapi2017_gm_item_create,
*
*          lv_line_id          TYPE bapi2017_gm_item_create-line_id.

    DATA: lv_materialdocument TYPE bapi2017_gm_head_02-mat_doc,
          lv_matdocumentyear  TYPE bapi2017_gm_head_02-doc_year,
          lt_return           TYPE TABLE OF bapiret2,
          ls_goodsmvt_headret TYPE bapi2017_gm_head_ret.

    "
    " Confirmar si el paso ya se ha ejecutado.
    "
    DATA(lt_log) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_anulacion_not_ent_pt  lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log) = lines( lt_log ).
    IF lv_lines_log IS NOT INITIAL.
      RETURN.
    ENDIF.

    DATA(ls_trans_cab) = trans_cab_getdetail( lp_numtransporte ).
    DATA(lt_posiciones) = trans_pos_getlist( lp_numtransporte ).

    "
    " Obtener documentos a anular.
    "
    DATA(lt_log_docmat) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_notificar_entrada_pt lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log_docmat) = lines( lt_log_docmat ).
    IF lv_lines_log_docmat IS INITIAL.
      RETURN.
    ENDIF.

    LOOP AT lt_log_docmat ASSIGNING FIELD-SYMBOL(<fs_log>).
      CHECK <fs_log>-mblnr IS NOT INITIAL.

      lv_materialdocument = <fs_log>-mblnr.
      lv_matdocumentyear = <fs_log>-mjahr.

      CALL FUNCTION 'BAPI_GOODSMVT_CANCEL'
        EXPORTING
          materialdocument = lv_materialdocument
          matdocumentyear  = lv_matdocumentyear
*         GOODSMVT_PSTNG_DATE       =
*         GOODSMVT_PR_UNAME         =
        IMPORTING
          goodsmvt_headret = ls_goodsmvt_headret
        TABLES
          return           = lt_return.

      IF ls_goodsmvt_headret IS INITIAL.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_anulacion_not_ent_pt.
        lv_datos_log-estado = gc_estado_log_nook.
        lv_datos_log-mensaje = 'Ver errores'.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        " Para grabar el log.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

        LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<fs_return>).
          MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
          lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
          lv_datos_log_msg-paso = lv_datos_log-paso.
          lv_datos_log_msg-posicion = lv_datos_log-posicion.
          lv_datos_log_msg-msgno = <fs_return>-number.

          trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
        ENDLOOP.
        " Devolvemos excepción para no continuar.
        RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
      ELSE.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_anulacion_not_ent_pt.
        lv_datos_log-estado = gc_estado_log_ok.
        lv_datos_log-mensaje = 'Anulación notificación entrada'.
        lv_datos_log-mblnr = ls_goodsmvt_headret-mat_doc.
        lv_datos_log-mjahr = ls_goodsmvt_headret-doc_year.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

      ENDIF.
    ENDLOOP.

  ENDMETHOD.
  METHOD anulacion_entrega_final_pedido.
    DATA: lv_datos_log     TYPE zst_sdle_transp_log,
          lv_datos_log_msg TYPE zst_sdle_transp_log_msg.

    DATA: lt_stock_trans_items TYPE TABLE OF bapidlvreftosto,
          ls_stock_trans_items LIKE LINE OF lt_stock_trans_items,
          lt_deliveries        TYPE TABLE OF bapishpdelivnumb,
          lt_return            TYPE TABLE OF bapiret2,
          lv_fecha_reparto     TYPE vbak-vdatu,
          lv_ship_point        TYPE  bapidlvcreateheader-ship_point.

    DATA(ls_trans_cab) = trans_cab_getdetail( lp_numtransporte ).
    "
    " Confirmar si el paso ya se ha ejecutado.
    "
    DATA(lt_log) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_anulacion_cierre_ped  lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log) = lines( lt_log ).
    IF lv_lines_log IS NOT INITIAL.
      RETURN.
    ENDIF.

***    IF ls_trans_cab-elikz IS INITIAL.
***      lv_datos_log-numtransporte = lp_numtransporte.
***      lv_datos_log-paso = gc_paso_anulacion_cierre_ped.
***      lv_datos_log-estado = gc_estado_log_ok.
***      lv_datos_log-mensaje = 'No se ha marcado Entrega final. Paso no necesario. '.
***      trans_log_create( CHANGING wp_trans_log = lv_datos_log ).
***
***      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
***        EXPORTING
***          wait = 'X'.
***      RETURN.
***    ENDIF.

    "
    " Recupero posiciones
    "
    DATA lv_error TYPE xflag.
    DATA lv_ebelp TYPE ekpo-ebelp.
    CLEAR lv_error.

    DATA(lt_log_cierre) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_cierre_pedido  lp_estado = gc_estado_log_ok ).

    LOOP AT lt_log_cierre ASSIGNING FIELD-SYMBOL(<fs_posicion>).
      CHECK <fs_posicion>-posnr IS NOT INITIAL.
      CHECK lv_error IS INITIAL.

      IF <fs_posicion>-ebeln IS NOT INITIAL.

        lv_ebelp = <fs_posicion>-posnr.

        lt_return = anular_cierre_ekpo( lp_ebeln  = <fs_posicion>-ebeln lp_ebelp  = lv_ebelp ).

        LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<fs_return>).
          IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
            lv_error = 'X'.
            EXIT.
          ENDIF.

        ENDLOOP.

        IF lv_error IS NOT INITIAL.
          CLEAR lv_datos_log.
          lv_datos_log-numtransporte = lp_numtransporte.
          lv_datos_log-paso = gc_paso_anulacion_cierre_ped.
          lv_datos_log-estado = gc_estado_log_nook.
          lv_datos_log-mensaje = 'Ver errores'.
          trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

          " Para grabar el log.
          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
            EXPORTING
              wait = 'X'.

          LOOP AT lt_return ASSIGNING <fs_return>.
            CLEAR lv_datos_log.
            MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
            lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
            lv_datos_log_msg-paso = lv_datos_log-paso.
            lv_datos_log_msg-posicion = lv_datos_log-posicion.
            lv_datos_log_msg-msgno = <fs_return>-number.

            trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
          ENDLOOP.

          " Devolvemos excepción para no continuar.
          RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
        ELSE.
          CLEAR lv_datos_log.
          lv_datos_log-numtransporte = lp_numtransporte.
          lv_datos_log-paso = gc_paso_anulacion_cierre_ped .
          lv_datos_log-estado = gc_estado_log_ok.
          lv_datos_log-mensaje = 'Marca Entrega Final anulada.'.
          lv_datos_log-ebeln = <fs_posicion>-ebeln.
          lv_datos_log-posnr = <fs_posicion>-posnr.
          trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
            EXPORTING
              wait = 'X'.

        ENDIF.
      ENDIF.

      CHECK lv_error IS INITIAL.
      IF <fs_posicion>-vbeln IS NOT INITIAL.


        lt_return = anular_cierre_vbap( lp_vbeln  = <fs_posicion>-vbeln lp_posnr  = <fs_posicion>-posnr ).

        LOOP AT lt_return ASSIGNING <fs_return>.
          IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
            lv_error = 'X'.
            EXIT.
          ENDIF.

        ENDLOOP.

        IF lv_error IS NOT INITIAL.
          CLEAR lv_datos_log.
          lv_datos_log-numtransporte = lp_numtransporte.
          lv_datos_log-paso = gc_paso_anulacion_cierre_ped.
          lv_datos_log-estado = gc_estado_log_nook.
          lv_datos_log-mensaje = 'Ver errores'.
          trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

          " Para grabar el log.
          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
            EXPORTING
              wait = 'X'.

          LOOP AT lt_return ASSIGNING <fs_return>.
            CLEAR lv_datos_log.
            MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
            lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
            lv_datos_log_msg-paso = lv_datos_log-paso.
            lv_datos_log_msg-posicion = lv_datos_log-posicion.
            lv_datos_log_msg-msgno = <fs_return>-number.

            trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
          ENDLOOP.

          " Devolvemos excepción para no continuar.
          RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
        ELSE.
          CLEAR lv_datos_log.
          lv_datos_log-numtransporte = lp_numtransporte.
          lv_datos_log-paso = gc_paso_anulacion_cierre_ped .
          lv_datos_log-estado = gc_estado_log_ok.
          lv_datos_log-mensaje = 'Marca Entrega Final anulada.'.
          lv_datos_log-vbeln = <fs_posicion>-vbeln.
          lv_datos_log-posnr = <fs_posicion>-posnr.
          trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
            EXPORTING
              wait = 'X'.

        ENDIF.
      ENDIF.

    ENDLOOP.
  ENDMETHOD.
  METHOD anulacion_es_cliente.

    DATA: lv_datos_log      TYPE zst_sdle_transp_log,
          lv_datos_log_msg  TYPE zst_sdle_transp_log_msg,
          ls_header_data    TYPE bapiobdlvhdrchg,
          ls_header_control TYPE bapiobdlvhdrctrlchg,
          lv_delivery       TYPE bapiobdlvhdrchg-deliv_numb,
          lv_error          TYPE xflag.

    DATA: lt_return        TYPE TABLE OF bapiret2.
    "
    " Confirmar si el paso ya se ha ejecutado.
    "
    DATA(lt_log_anulacion) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_anulacion_es_cliente lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log_anulacion) = lines( lt_log_anulacion ).
    IF lv_lines_log_anulacion IS NOT INITIAL.
      RETURN.
    ENDIF.

    "
    " Obtener entregas a borrar.
    "
    DATA(lt_log) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_creacion_es_cliente lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log) = lines( lt_log ).
    IF lv_lines_log IS INITIAL.
      RETURN.
    ENDIF.

    DATA(ls_trans_cab) = trans_cab_getdetail( lp_numtransporte ).

    IF ls_trans_cab-destino = 2.
      lv_datos_log-numtransporte = lp_numtransporte.
      lv_datos_log-paso = gc_paso_anulacion_es_cliente.
      lv_datos_log-estado = gc_estado_log_ok.
      lv_datos_log-mensaje = 'Destino Xàtiva. Paso no necesario. '.
      trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          wait = 'X'.
      RETURN.
    ENDIF.

    "
    " Anulamos salida de mercancía.
    "
    DATA lv_vbeln TYPE likp-vbeln.
    LOOP AT lt_log ASSIGNING FIELD-SYMBOL(<fs_log>).
      CHECK <fs_log>-vbeln_vl IS NOT INITIAL.
      lv_vbeln = <fs_log>-vbeln_vl.

      DATA(tl_return_anula) = anular_sm_es( lv_vbeln ).

      LOOP AT tl_return_anula ASSIGNING FIELD-SYMBOL(<fs_return>).
        IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
          lv_error = 'X'.
          EXIT.
        ENDIF.
      ENDLOOP.

      IF lv_error IS NOT INITIAL.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_anulacion_es_cliente.
        lv_datos_log-estado = gc_estado_log_nook.
        lv_datos_log-mensaje = 'Ver errores'.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        " Para grabar el log.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

        LOOP AT tl_return_anula ASSIGNING <fs_return>.
          MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
          lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
          lv_datos_log_msg-paso = lv_datos_log-paso.
          lv_datos_log_msg-posicion = lv_datos_log-posicion.
          lv_datos_log_msg-msgno = <fs_return>-number.

          trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
        ENDLOOP.

        " Devolvemos excepción para no continuar.
        RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
      ELSE.
        " No deja llamar a la función de anulación más de una vez sin hacer commit.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.
      ENDIF.

    ENDLOOP.

    " Para grabar el log.
    CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
      EXPORTING
        wait = 'X'.

    CALL FUNCTION 'HU_PACKING_REFRESH'.
    CALL FUNCTION 'SERIAL_INTTAB_REFRESH'.
    CALL FUNCTION 'L_SAPLL03A_INIT_INT'.
    CALL FUNCTION 'V51G_REFRESH'.

    " Borrar entregas
    LOOP AT lt_log ASSIGNING <fs_log>.
      DATA: it_hus    TYPE  hum_exidv_t.

      DATA: lt_prot TYPE TABLE OF prott.
      DATA: ls_vbkok     TYPE vbkok,
            lt_vbpok_tab TYPE TABLE OF vbpok.

*  CLEAR: p_lt_return.
*  WAIT UP TO 3 SECONDS.

      SELECT a~venum, a~exidv, b~vbeln, b~posnr, a~vhilm
        FROM vekp AS a
        INNER JOIN vepo AS b ON b~venum = a~venum
        INTO TABLE @DATA(lt_venum)
        WHERE vbeln = @<fs_log>-vbeln_vl.

      "Eliminamos HU de la entrega

      LOOP AT lt_venum INTO DATA(ls_venum).
        CLEAR:  lt_return.
        CALL FUNCTION 'HU_PACKING_REFRESH'.

**** REFRESH DELIVERY BUFFER
        CALL FUNCTION 'LE_DELIVERY_REFRESH_BUFFER'
          EXCEPTIONS
            no_key_specified = 0
            OTHERS           = 0.

        DATA: lv_vbeln_hu_del TYPE bapideliciousdelivery-delivery_number.
        lv_vbeln_hu_del = <fs_log>-vbeln_vl.
        CALL FUNCTION 'BAPI_HU_DELETE_FROM_DEL'
        DESTINATION 'NONE'
          EXPORTING
            delivery      = lv_vbeln_hu_del
            hukey         = ls_venum-exidv
          TABLES
            return        = lt_return
          EXCEPTIONS
            error_message = 1
            OTHERS        = 2.

        IF sy-subrc = 0.
          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          DESTINATION 'NONE'
            EXPORTING
              wait = 'X'.
        ELSE.
          CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
          APPEND INITIAL LINE TO lt_return ASSIGNING <fs_return>.
          <fs_return>-id = sy-msgid.
          <fs_return>-type = sy-msgty.
          <fs_return>-number = sy-msgno.
          <fs_return>-message_v1 = sy-msgv1.
          <fs_return>-message_v2 = sy-msgv2.
          <fs_return>-message_v3 = sy-msgv3.
          <fs_return>-message_v4 = sy-msgv4.
        ENDIF.


      ENDLOOP.

      LOOP AT lt_return ASSIGNING <fs_return>.
        IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
          lv_error = 'X'.
          EXIT.
        ENDIF.
      ENDLOOP.

      IF lv_error IS INITIAL.

        CALL FUNCTION 'LE_DELIVERY_REFRESH_BUFFER'
          EXCEPTIONS
            no_key_specified = 0
            OTHERS           = 0.

        "
        " Borramos la entrega.
        "
        ls_header_data-deliv_numb = <fs_log>-vbeln_vl.

        ls_header_control-deliv_numb = <fs_log>-vbeln_vl.
        ls_header_control-dlv_del = 'X'.

        lv_delivery = <fs_log>-vbeln_vl.

        CLEAR lt_return.
        CLEAR lv_error.

        CALL FUNCTION 'BAPI_OUTB_DELIVERY_CHANGE'
          EXPORTING
            header_data    = ls_header_data
            header_control = ls_header_control
            delivery       = lv_delivery
          TABLES
            return         = lt_return.

        LOOP AT lt_return ASSIGNING <fs_return>.
          IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
            lv_error = 'X'.
            EXIT.
          ENDIF.
        ENDLOOP.
      ENDIF.

      IF lv_error IS NOT INITIAL.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_anulacion_es_cliente.
        lv_datos_log-estado = gc_estado_log_nook.
        lv_datos_log-mensaje = 'Ver errores'.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        " Para grabar el log.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

        LOOP AT lt_return ASSIGNING <fs_return>.
          MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
          lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
          lv_datos_log_msg-paso = lv_datos_log-paso.
          lv_datos_log_msg-posicion = lv_datos_log-posicion.
          lv_datos_log_msg-msgno = <fs_return>-number.

          trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
        ENDLOOP.

        " Devolvemos excepción para no continuar.
        RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
      ELSE.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_anulacion_es_cliente.
        lv_datos_log-estado = gc_estado_log_ok.
        lv_datos_log-mensaje = 'Entrega anulada'.
        lv_datos_log-vbeln = <fs_log>-vbeln.
        lv_datos_log-posnr = <fs_log>-posnr.
        lv_datos_log-vbeln_vl = <fs_log>-vbeln_vl.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.
      ENDIF.

    ENDLOOP.

  ENDMETHOD.
  METHOD anulacion_es_traslado.

    DATA: lv_datos_log      TYPE zst_sdle_transp_log,
          lv_datos_log_msg  TYPE zst_sdle_transp_log_msg,
          ls_header_data    TYPE bapiobdlvhdrchg,
          ls_header_control TYPE bapiobdlvhdrctrlchg,
          lv_delivery       TYPE bapiobdlvhdrchg-deliv_numb,
          lv_error          TYPE xflag.

    DATA: lt_return        TYPE TABLE OF bapiret2.
    "
    " Confirmar si el paso ya se ha ejecutado.
    "
    DATA(lt_log_anulacion) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_anulacion_es_traslado lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log_anulacion) = lines( lt_log_anulacion ).
    IF lv_lines_log_anulacion IS NOT INITIAL.
      RETURN.
    ENDIF.

    DATA(ls_trans_cab) = trans_cab_getdetail( lp_numtransporte ).

    IF ls_trans_cab-destino = 1.
      lv_datos_log-numtransporte = lp_numtransporte.
      lv_datos_log-paso = gc_paso_anulacion_es_traslado.
      lv_datos_log-estado = gc_estado_log_ok.
      lv_datos_log-mensaje = 'Destino cliente. Paso no necesario. '.
      trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          wait = 'X'.
      RETURN.
    ENDIF.

    "
    " Obtener entregas a borrar.
    "
    DATA(lt_log) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_creacion_es_traslado lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log) = lines( lt_log ).
    IF lv_lines_log IS INITIAL.
      RETURN.
    ENDIF.


    "
    " Anulamos salida de mercancía.
    "
    DATA lv_vbeln TYPE likp-vbeln.
    LOOP AT lt_log ASSIGNING FIELD-SYMBOL(<fs_log>).
      CHECK <fs_log>-vbeln_vl IS NOT INITIAL.
      lv_vbeln = <fs_log>-vbeln_vl.

      DATA(tl_return_anula) = anular_sm_es( lv_vbeln ).

      LOOP AT tl_return_anula ASSIGNING FIELD-SYMBOL(<fs_return>).
        IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
          lv_error = 'X'.
          EXIT.
        ENDIF.
      ENDLOOP.

      IF lv_error IS NOT INITIAL.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_anulacion_es_cliente.
        lv_datos_log-estado = gc_estado_log_nook.
        lv_datos_log-mensaje = 'Ver errores'.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        " Para grabar el log.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

        LOOP AT tl_return_anula ASSIGNING <fs_return>.
          MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
          lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
          lv_datos_log_msg-paso = lv_datos_log-paso.
          lv_datos_log_msg-posicion = lv_datos_log-posicion.
          lv_datos_log_msg-msgno = <fs_return>-number.

          trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
        ENDLOOP.

        " Devolvemos excepción para no continuar.
        RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
      ENDIF.

    ENDLOOP.

    " Para grabar el log.
    CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
      EXPORTING
        wait = 'X'.


    CALL FUNCTION 'HU_PACKING_REFRESH'.
    CALL FUNCTION 'SERIAL_INTTAB_REFRESH'.
    CALL FUNCTION 'L_SAPLL03A_INIT_INT'.
    CALL FUNCTION 'V51G_REFRESH'.

    LOOP AT lt_log ASSIGNING <fs_log>.

      DATA: it_hus    TYPE  hum_exidv_t.

      DATA: lt_prot TYPE TABLE OF prott.
      DATA: ls_vbkok     TYPE vbkok,
            lt_vbpok_tab TYPE TABLE OF vbpok.

*  CLEAR: p_lt_return.
*  WAIT UP TO 3 SECONDS.

      SELECT a~venum, a~exidv, b~vbeln, b~posnr, a~vhilm
        FROM vekp AS a
        INNER JOIN vepo AS b ON b~venum = a~venum
        INTO TABLE @DATA(lt_venum)
        WHERE vbeln = @<fs_log>-vbeln_vl.

      "Eliminamos HU de la entrega

      LOOP AT lt_venum INTO DATA(ls_venum).
        CLEAR:  lt_return.
        CALL FUNCTION 'HU_PACKING_REFRESH'.

**** REFRESH DELIVERY BUFFER
        CALL FUNCTION 'LE_DELIVERY_REFRESH_BUFFER'
          EXCEPTIONS
            no_key_specified = 0
            OTHERS           = 0.

        DATA: lv_vbeln_hu_del TYPE bapideliciousdelivery-delivery_number.
        lv_vbeln_hu_del = <fs_log>-vbeln_vl.

        CALL FUNCTION 'BAPI_HU_DELETE_FROM_DEL'
          DESTINATION 'NONE'
          EXPORTING
            delivery      = lv_vbeln_hu_del
            hukey         = ls_venum-exidv
          TABLES
            return        = lt_return
          EXCEPTIONS
            error_message = 1
            OTHERS        = 2.

        IF sy-subrc = 0.
          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          DESTINATION 'NONE'
            EXPORTING
              wait = 'X'.

        ELSE.
          CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
          APPEND INITIAL LINE TO lt_return ASSIGNING <fs_return>.
          <fs_return>-id = sy-msgid.
          <fs_return>-type = sy-msgty.
          <fs_return>-number = sy-msgno.
          <fs_return>-message_v1 = sy-msgv1.
          <fs_return>-message_v2 = sy-msgv2.
          <fs_return>-message_v3 = sy-msgv3.
          <fs_return>-message_v4 = sy-msgv4.
        ENDIF.


      ENDLOOP.

      LOOP AT lt_return ASSIGNING <fs_return>.
        IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
          lv_error = 'X'.
          EXIT.
        ENDIF.
      ENDLOOP.

      IF lv_error IS INITIAL.

        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.


        CALL FUNCTION 'LE_DELIVERY_REFRESH_BUFFER'
          EXCEPTIONS
            no_key_specified = 0
            OTHERS           = 0.

        ls_header_data-deliv_numb = <fs_log>-vbeln_vl.

        ls_header_control-deliv_numb = <fs_log>-vbeln_vl.
        ls_header_control-dlv_del = 'X'.

        lv_delivery = <fs_log>-vbeln_vl.

        CLEAR lt_return.
        CLEAR lv_error.

        CALL FUNCTION 'BAPI_OUTB_DELIVERY_CHANGE'
          EXPORTING
            header_data    = ls_header_data
            header_control = ls_header_control
            delivery       = lv_delivery
          TABLES
            return         = lt_return.

        LOOP AT lt_return ASSIGNING <fs_return>.
          IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
            lv_error = 'X'.
            EXIT.
          ENDIF.
        ENDLOOP.
      ENDIF.


      IF lv_error IS NOT INITIAL.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_anulacion_es_traslado.
        lv_datos_log-estado = gc_estado_log_nook.
        lv_datos_log-mensaje = 'Ver errores'.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        " Para grabar el log.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

        LOOP AT lt_return ASSIGNING <fs_return>.
          MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
          lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
          lv_datos_log_msg-paso = lv_datos_log-paso.
          lv_datos_log_msg-posicion = lv_datos_log-posicion.
          lv_datos_log_msg-msgno = <fs_return>-number.

          trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
        ENDLOOP.

        " Devolvemos excepción para no continuar.
        RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
      ELSE.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_anulacion_es_traslado.
        lv_datos_log-estado = gc_estado_log_ok.
        lv_datos_log-mensaje = 'Entrega anulada'.
        lv_datos_log-vbeln = <fs_log>-vbeln.
        lv_datos_log-posnr = <fs_log>-posnr.
        lv_datos_log-vbeln_vl = <fs_log>-vbeln_vl.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.
      ENDIF.

    ENDLOOP.

  ENDMETHOD.
  METHOD ANULACION_MOD_VSTEL_PV.
    TYPES: BEGIN OF st_datos,
             vbeln TYPE vbeln_va,
             posnr TYPE posnr_va,
           END OF st_datos.

    DATA: lt_datos TYPE TABLE OF st_datos.

    DATA: lv_datos_log     TYPE zst_sdle_transp_log,
          lv_datos_log_msg TYPE zst_sdle_transp_log_msg.

    "
    " Confirmar si el paso ya se ha ejecutado.
    "
    DATA(lt_log_anulacion) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_anulacion_vstel_pv lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log_anulacion) = lines( lt_log_anulacion ).
    IF lv_lines_log_anulacion IS NOT INITIAL.
      RETURN.
    ENDIF.

    DATA(ls_trans_cab) = trans_cab_getdetail( lp_numtransporte ).
    IF ls_trans_cab-destino = 1.
      lv_datos_log-numtransporte = lp_numtransporte.
      lv_datos_log-paso = gc_paso_anulacion_vstel_pv.
      lv_datos_log-estado = gc_estado_log_ok.
      lv_datos_log-mensaje = 'Destino cliente. Paso no necesario. '.
      trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          wait = 'X'.
      RETURN.
    ENDIF.

    "
    " Buscar datos a anular.
    "
    DATA(lt_log) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_modificar_vstel_pv lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log) = lines( lt_log ).
    IF lv_lines_log IS INITIAL.
      RETURN.
    ENDIF.

    DATA: lv_salesdocument    TYPE bapivbeln-vbeln,
          lt_return           TYPE TABLE OF bapiret2,
          lt_order_item_in    TYPE TABLE OF bapisditm,
          lt_order_item_inx   TYPE TABLE OF bapisditmx,
          ls_order_header_inx TYPE bapisdh1x.

    LOOP AT lt_log ASSIGNING FIELD-SYMBOL(<fs_log>).

        lv_salesdocument = <fs_log>-vbeln.
        ls_order_header_inx-updateflag = 'U'.

        CLEAR: lt_order_item_in,
              lt_order_item_inx.

        APPEND INITIAL LINE TO lt_order_item_in ASSIGNING FIELD-SYMBOL(<fs_item>).
        <fs_item>-itm_number = <fs_log>-posnr.
        <fs_item>-ship_point = 'P001'.

        APPEND INITIAL LINE TO lt_order_item_inx ASSIGNING FIELD-SYMBOL(<fs_itemx>).
        <fs_itemx>-itm_number = <fs_log>-posnr.
        <fs_itemx>-updateflag = 'U'.
        <fs_itemx>-ship_point = 'X'.


        SELECT SINGLE *
          FROM vbap
          INTO @DATA(ls_vbap)
          WHERE vbeln = @<fs_log>-vbeln AND
                posnr = @<fs_log>-posnr.

        IF ls_vbap-vstel <> 'P001'.

          CLEAR lt_return.

          CALL FUNCTION 'BAPI_SALESORDER_CHANGE'
            EXPORTING
              salesdocument    = lv_salesdocument
              order_header_inx = ls_order_header_inx
            TABLES
              return           = lt_return
              order_item_in    = lt_order_item_in
              order_item_inx   = lt_order_item_inx.

          DATA lv_error TYPE xflag.
          CLEAR lv_error.

          LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<fs_return>).
            IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
              lv_error = 'X'.
              EXIT.
            ENDIF.

          ENDLOOP.

          IF lv_error IS NOT INITIAL.
            lv_datos_log-numtransporte = lp_numtransporte.
            lv_datos_log-paso = gc_paso_anulacion_vstel_pv.
            lv_datos_log-estado = gc_estado_log_nook.
            lv_datos_log-mensaje = 'Ver errores'.
            trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

            " Para grabar el log.
            CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
              EXPORTING
                wait = 'X'.

            LOOP AT lt_return ASSIGNING <fs_return>.
              MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
              lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
              lv_datos_log_msg-paso = lv_datos_log-paso.
              lv_datos_log_msg-posicion = lv_datos_log-posicion.
              lv_datos_log_msg-msgno = <fs_return>-number.

              trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
            ENDLOOP.

            " Devolvemos excepción para no continuar.
            RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
          ELSE.
            lv_datos_log-numtransporte = lp_numtransporte.
            lv_datos_log-paso = gc_paso_anulacion_vstel_pv.
            lv_datos_log-estado = gc_estado_log_ok.
            lv_datos_log-mensaje = 'Posición pedido cambiada'.
            lv_datos_log-vbeln = <fs_log>-vbeln.
            lv_datos_log-posnr = <fs_log>-posnr.
            trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

            CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
              EXPORTING
                wait = 'X'.

          ENDIF.
        ELSE.
          lv_datos_log-numtransporte = lp_numtransporte.
          lv_datos_log-paso = gc_paso_anulacion_vstel_pv.
          lv_datos_log-estado = gc_estado_log_ok.
          lv_datos_log-mensaje = 'Posición pedido ya tiene el puesto de expedición correcto.'.
          lv_datos_log-vbeln = <fs_log>-vbeln.
          lv_datos_log-posnr = <fs_log>-posnr.
          trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
            EXPORTING
              wait = 'X'.
        ENDIF.

    ENDLOOP.


  ENDMETHOD.
  METHOD anulacion_pedido_traslado.
    TYPES: BEGIN OF st_datos,
             matnr TYPE matnr_d,
             vbeln TYPE vbeln_va,
             posnr TYPE posnr_va,
             menge TYPE menge_d,
             meins TYPE meins,
           END OF st_datos.

    DATA: lt_datos TYPE TABLE OF st_datos.

    DATA: lt_return        TYPE TABLE OF bapiret2,
          lv_datos_log     TYPE zst_sdle_transp_log,
          lv_datos_log_msg TYPE zst_sdle_transp_log_msg.

    DATA: lv_purchaseorder TYPE bapimepoheader-po_number,
          lt_poitem        TYPE TABLE OF bapimepoitem,
          lt_poitemx       TYPE TABLE OF bapimepoitemx.


    DATA(ls_trans_cab) = trans_cab_getdetail( lp_numtransporte ).

    "
    " Confirmar si el paso ya se ha ejecutado.
    "
    DATA(lt_log) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_anulacion_pedido_tras  lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log) = lines( lt_log ).
    IF lv_lines_log IS NOT INITIAL.
      RETURN.
    ENDIF.

    IF ls_trans_cab-destino = 1.
      lv_datos_log-numtransporte = lp_numtransporte.
      lv_datos_log-paso = gc_paso_anulacion_pedido_tras.
      lv_datos_log-estado = gc_estado_log_ok.
      lv_datos_log-mensaje = 'Destino cliente. Paso no necesario. '.
      trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          wait = 'X'.
      RETURN.
    ENDIF.

    "
    " recupero información de los pedidos de traslado creados.
    "
    DATA(lt_log_ped) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_creacion_pedido_tras  lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_ped) = lines( lt_log_ped ).
    IF lv_lines_ped IS INITIAL.
      RETURN.
    ENDIF.


    LOOP AT lt_log_ped ASSIGNING FIELD-SYMBOL(<fs_log_ped>).
      " solo tendremos uno, pero por si acaso.
      SELECT *
        FROM ekpo
        INTO TABLE @DATA(lt_ekpo)
        WHERE ebeln = @<fs_log_ped>-ebeln.


      CLEAR: lt_poitem, lt_poitemx.

      LOOP AT lt_ekpo ASSIGNING FIELD-SYMBOL(<fs_ekpo>).
        APPEND INITIAL LINE TO lt_poitem ASSIGNING FIELD-SYMBOL(<fs_poitem>).
        <fs_poitem>-po_item = <fs_ekpo>-ebelp.
        <fs_poitem>-delete_ind = 'X'.

        APPEND INITIAL LINE TO lt_poitemx ASSIGNING FIELD-SYMBOL(<fs_poitemx>).
        <fs_poitemx>-po_item = <fs_ekpo>-ebelp.
        <fs_poitemx>-po_itemx = 'X'.
        <fs_poitemx>-delete_ind = 'X'.

      ENDLOOP.

      lv_purchaseorder = <fs_log_ped>-ebeln.

      CALL FUNCTION 'BAPI_PO_CHANGE'
        EXPORTING
          purchaseorder = lv_purchaseorder
        TABLES
          return        = lt_return
          poitem        = lt_poitem
          poitemx       = lt_poitemx.

      DATA lv_error TYPE xflag.
      CLEAR lv_error.

      LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<fs_return>).
        IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
          lv_error = 'X'.
          EXIT.
        ENDIF.

      ENDLOOP.

      IF lv_error IS NOT INITIAL.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_anulacion_pedido_tras.
        lv_datos_log-estado = gc_estado_log_nook.
        lv_datos_log-mensaje = 'Ver errores'.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        " Para grabar el log.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

        LOOP AT lt_return ASSIGNING <fs_return>.
          MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
          lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
          lv_datos_log_msg-paso = lv_datos_log-paso.
          lv_datos_log_msg-posicion = lv_datos_log-posicion.
          lv_datos_log_msg-msgno = <fs_return>-number.

          trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
        ENDLOOP.

        " Devolvemos excepción para no continuar.
        RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
      ELSE.

        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_anulacion_pedido_tras .
        lv_datos_log-estado = gc_estado_log_ok.
        lv_datos_log-mensaje = 'Pedido de traslado anulado.'.
        lv_datos_log-ebeln = <fs_log_ped>-ebeln.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).


        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

      ENDIF.

    ENDLOOP.




  ENDMETHOD.
  METHOD anulacion_pedidos_venta.
    TYPES: BEGIN OF st_datos,
             matnr TYPE matnr_d,
             vbeln TYPE vbeln_va,
             posnr TYPE posnr_va,
             menge TYPE menge_d,
             meins TYPE meins,
           END OF st_datos.

    DATA: lt_datos TYPE TABLE OF st_datos.

    DATA: lt_return        TYPE TABLE OF bapiret2,
          lv_datos_log     TYPE zst_sdle_transp_log,
          lv_datos_log_msg TYPE zst_sdle_transp_log_msg.


    DATA: lv_salesdocument    TYPE bapivbeln-vbeln,
          ls_order_header_inx TYPE bapisdh1x.


    DATA(ls_trans_cab) = trans_cab_getdetail( lp_numtransporte ).

    "
    " Confirmar si el paso ya se ha ejecutado.
    "
    DATA(lt_log) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_anulacion_pedidos_vta  lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log) = lines( lt_log ).
    IF lv_lines_log IS NOT INITIAL.
      RETURN.
    ENDIF.

    IF ls_trans_cab-destino = 2.
      lv_datos_log-numtransporte = lp_numtransporte.
      lv_datos_log-paso = gc_paso_anulacion_pedidos_vta.
      lv_datos_log-estado = gc_estado_log_ok.
      lv_datos_log-mensaje = 'Destino Xátiva. Paso no necesario. '.
      trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          wait = 'X'.
      RETURN.
    ENDIF.

    "
    " recupero información de los pedidos de venta creados.
    "
    DATA(lt_log_ped) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_creacion_pedidos_vta  lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_ped) = lines( lt_log_ped ).
    IF lv_lines_ped IS INITIAL.
      RETURN.
    ENDIF.


    LOOP AT lt_log_ped ASSIGNING FIELD-SYMBOL(<fs_log_ped>).

      lv_salesdocument = <fs_log_ped>-vbeln.
      ls_order_header_inx-updateflag = 'D'.

      CALL FUNCTION 'BAPI_SALESORDER_CHANGE'
        EXPORTING
          salesdocument    = lv_salesdocument
*         ORDER_HEADER_IN  =
          order_header_inx = ls_order_header_inx
*         SIMULATION       =
*         BEHAVE_WHEN_ERROR           = ' '
*         INT_NUMBER_ASSIGNMENT       = ' '
*         LOGIC_SWITCH     =
*         NO_STATUS_BUF_INIT          = ' '
        TABLES
          return           = lt_return
*         ORDER_ITEM_IN    =
*         ORDER_ITEM_INX   =
*         PARTNERS         =
*         PARTNERCHANGES   =
*         PARTNERADDRESSES =
*         ORDER_CFGS_REF   =
*         ORDER_CFGS_INST  =
*         ORDER_CFGS_PART_OF          =
*         ORDER_CFGS_VALUE =
*         ORDER_CFGS_BLOB  =
*         ORDER_CFGS_VK    =
*         ORDER_CFGS_REFINST          =
*         SCHEDULE_LINES   =
*         SCHEDULE_LINESX  =
*         ORDER_TEXT       =
*         ORDER_KEYS       =
*         CONDITIONS_IN    =
*         CONDITIONS_INX   =
*         EXTENSIONIN      =
*         EXTENSIONEX      =
        .


      DATA lv_error TYPE xflag.
      CLEAR lv_error.

      LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<fs_return>).
        IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
          lv_error = 'X'.
          EXIT.
        ENDIF.

      ENDLOOP.

      IF lv_error IS NOT INITIAL.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_anulacion_pedidos_vta.
        lv_datos_log-estado = gc_estado_log_nook.
        lv_datos_log-mensaje = 'Ver errores'.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        " Para grabar el log.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

        LOOP AT lt_return ASSIGNING <fs_return>.
          MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
          lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
          lv_datos_log_msg-paso = lv_datos_log-paso.
          lv_datos_log_msg-posicion = lv_datos_log-posicion.
          lv_datos_log_msg-msgno = <fs_return>-number.

          trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
        ENDLOOP.

        " Devolvemos excepción para no continuar.
        RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
      ELSE.

        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_anulacion_pedidos_vta .
        lv_datos_log-estado = gc_estado_log_ok.
        lv_datos_log-mensaje = 'Pedido de venta anulado.'.
        lv_datos_log-vbeln = <fs_log_ped>-vbeln.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

      ENDIF.

    ENDLOOP.




  ENDMETHOD.
  METHOD anulacion_transporte.
    DATA: lv_datos_log     TYPE zst_sdle_transp_log,
          lv_datos_log_msg TYPE zst_sdle_transp_log_msg.

    DATA: lt_itemdata         TYPE TABLE OF bapishipmentitem,
          ls_itemdata         TYPE bapishipmentitem,
          lt_return           TYPE TABLE OF bapiret2,
          ls_return           TYPE bapiret2,
          ls_headerdata       TYPE bapishipmentheader,
          ls_headerdataaction TYPE bapishipmentheaderaction.

    DATA: lv_error TYPE xflag.

    "
    " Confirmar si el paso ya se ha ejecutado.
    "
    DATA(lt_log_anulacion) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_anulacion_transporte lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log_anulacion) = lines( lt_log_anulacion ).
    IF lv_lines_log_anulacion IS NOT INITIAL.
      RETURN.
    ENDIF.

    "
    " Obtener transporte a anular.
    "
    DATA(lt_log) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_creacion_transporte lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log) = lines( lt_log ).
    IF lv_lines_log IS INITIAL.
      RETURN.
    ENDIF.

    CLEAR lv_error.

    LOOP AT lt_log ASSIGNING FIELD-SYMBOL(<fs_log>).

      CLEAR: ls_headerdata, ls_headerdataaction.
      ls_headerdata-shipment_num = <fs_log>-tknum.
      ls_headerdataaction-shipment_num = 'D'.

      CALL FUNCTION 'BAPI_SHIPMENT_CHANGE'
        EXPORTING
          headerdata       = ls_headerdata
          headerdataaction = ls_headerdataaction
        TABLES
*         itemdata         = tl_itemdata
*         itemdataaction   = tl_itemdataaction
          return           = lt_return.

      LOOP AT lt_return INTO ls_return WHERE type <> 'S' AND type <> 'I'.
        lv_error = 'X'.
      ENDLOOP.

      IF lv_error IS NOT INITIAL.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_anulacion_transporte.
        lv_datos_log-estado = gc_estado_log_nook.
        lv_datos_log-mensaje = 'Ver errores'.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        " Para grabar el log.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

        LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<fs_return>).
          MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
          lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
          lv_datos_log_msg-paso = lv_datos_log-paso.
          lv_datos_log_msg-posicion = lv_datos_log-posicion.
          lv_datos_log_msg-msgno = <fs_return>-number.

          trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
        ENDLOOP.

        " Devolvemos excepción para no continuar.
        RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
      ELSE.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_anulacion_transporte.
        lv_datos_log-estado = gc_estado_log_ok.
        lv_datos_log-mensaje = 'Transporte anulado'.
        lv_datos_log-tknum = <fs_log>-tknum.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

      ENDIF.

    ENDLOOP.




  ENDMETHOD.
  METHOD ANULAR_CIERRE_EKPO.
    DATA: lv_error TYPE text255.

    DATA: lv_purchaseorder TYPE bapimepoheader-po_number,
          lt_poitem        TYPE TABLE OF bapimepoitem,
          lt_poitemx       TYPE TABLE OF bapimepoitemx.

    CLEAR lv_error.
    SELECT SINGLE *
      FROM ekpo
      INTO @DATA(ls_ekpo)
      WHERE ebeln = @lp_ebeln AND
            ebelp = @lp_ebelp.
    IF sy-subrc <> 0.
      lv_error = 'Posición del pedido no existe.'.
    ENDIF.

    IF lv_error IS INITIAL.

      CLEAR: lp_return, lt_poitem, lt_poitemx.

      lv_purchaseorder = lp_ebeln.

      APPEND INITIAL LINE TO lt_poitem ASSIGNING FIELD-SYMBOL(<fs_poitem>).
      APPEND INITIAL LINE TO lt_poitemx ASSIGNING FIELD-SYMBOL(<fs_poitemx>).

      <fs_poitem>-po_item = lp_ebelp.
      <fs_poitem>-no_more_gr = ' '.

      <fs_poitemx>-po_item = <fs_poitem>-po_item.
      <fs_poitemx>-no_more_gr = 'X'.

      CALL FUNCTION 'BAPI_PO_CHANGE'
        EXPORTING
          purchaseorder = lv_purchaseorder
        TABLES
          return        = lp_return
          poitem        = lt_poitem
          poitemx       = lt_poitemx.


    ENDIF.
    "
    " Lanzar error si lo hay
    "
    IF lv_error IS NOT INITIAL.
      zcl_seis_odata_utils=>lanzar_excepcion( message = lv_error ).
    ENDIF.
  ENDMETHOD.
  METHOD ANULAR_CIERRE_VBAP.
    DATA: lv_error TYPE text255.


    CLEAR lv_error.
    SELECT SINGLE *
      FROM vbap
      INTO @DATA(ls_vbap)
      WHERE vbeln = @lp_vbeln AND
            posnr = @lp_posnr.
    IF sy-subrc <> 0.
      lv_error = 'Posición del pedido de venta no existe.'.
    ENDIF.

    IF lv_error IS INITIAL.
      SELECT *
        FROM vbep
        INTO TABLE @DATA(lt_vbep)
        WHERE vbeln = @lp_vbeln AND
              posnr = @lp_posnr.
      IF sy-subrc <> 0.
        lv_error = 'Posición del pedido de venta no existe.'.
      ENDIF.
    ENDIF.


    IF lv_error IS INITIAL.

      CLEAR: lp_return.

      DATA: lv_salesdocument    TYPE bapivbeln-vbeln,
            ls_order_header_inx TYPE bapisdh1x,
            lt_order_item_in    TYPE TABLE OF bapisditm,
            lt_order_item_inx   TYPE TABLE OF bapisditmx,
            lt_schedule_lines	  TYPE TABLE OF	bapischdl,
            lt_schedule_linesx  TYPE TABLE OF bapischdlx.

      lv_salesdocument = lp_vbeln.

      ls_order_header_inx-updateflag = 'U'.

***      APPEND INITIAL LINE TO lt_order_item_in ASSIGNING FIELD-SYMBOL(<fs_item>).
***      <fs_item>-itm_number = lp_posnr.
***      <fs_item>-reason_rej = 'Z8'.
***
***      APPEND INITIAL LINE TO lt_order_item_inx ASSIGNING FIELD-SYMBOL(<fs_itemx>).
***      " Indicadores de cambio para la posición
***      <fs_itemx>-itm_number = lp_posnr.
***      <fs_itemx>-updateflag = 'U'.
***      <fs_itemx>-reason_rej = 'X'.

      LOOP AT lt_vbep ASSIGNING FIELD-SYMBOL(<fs_vbep>).
        APPEND INITIAL LINE TO lt_schedule_lines ASSIGNING FIELD-SYMBOL(<fs_reparto>).
        <fs_reparto>-itm_number = <fs_vbep>-posnr.
        <fs_reparto>-sched_line = <fs_vbep>-etenr.
        <fs_reparto>-req_dlv_bl = ' '.

        APPEND INITIAL LINE TO lt_schedule_linesx ASSIGNING FIELD-SYMBOL(<fs_repartox>).
        <fs_repartox>-itm_number = <fs_vbep>-posnr.
        <fs_repartox>-sched_line = <fs_vbep>-etenr.
        <fs_repartox>-updateflag = 'U'.
        <fs_repartox>-req_dlv_bl = 'X'.
      ENDLOOP.

      CALL FUNCTION 'BAPI_SALESORDER_CHANGE'
        EXPORTING
          salesdocument    = lv_salesdocument
          order_header_inx = ls_order_header_inx
        TABLES
          return           = lp_return
*         order_item_in    = lt_order_item_in
*         order_item_inx   = lt_order_item_inx
          schedule_lines   = lt_schedule_lines
          schedule_linesx  = lt_schedule_linesx.
    ENDIF.
    "
    " Lanzar error si lo hay
    "
    IF lv_error IS NOT INITIAL.
      zcl_seis_odata_utils=>lanzar_excepcion( message = lv_error ).
    ENDIF.
  ENDMETHOD.
  METHOD anular_sm_es.
    DATA: lv_vbeln TYPE  likp-vbeln,
          lv_budat TYPE  sy-datlo,
          lv_vbtyp TYPE  likp-vbtyp,
          lt_mesg  TYPE TABLE OF mesg.

    DATA: lv_mblnr TYPE mkpf-mblnr,
          lv_mjahr TYPE mseg-mjahr.

    SELECT SINGLE *
      FROM vbuk
      INTO @DATA(wl_vbuk)
      WHERE vbeln = @lp_vbeln.
    IF sy-subrc <> 0.
      CLEAR wl_vbuk.
    ENDIF.

    CHECK wl_vbuk-wbstk = 'C'.


**** REFRESH DELIVERY BUFFER
    CALL FUNCTION 'LE_DELIVERY_REFRESH_BUFFER'
      EXCEPTIONS
        no_key_specified = 0
        OTHERS           = 0.

    CLEAR lt_return.

    SELECT SINGLE *
      FROM likp
      INTO @DATA(wl_likp)
      WHERE vbeln = @lp_vbeln.

    SELECT SINGLE *
      FROM vbfa
      INTO @DATA(wl_vbfa)
      WHERE vbelv = @wl_likp-vbeln AND
            bwart <> '' AND
            vbtyp_n = 'R'.

    lv_vbeln  = wl_likp-vbeln.
    lv_budat = wl_likp-wadat_ist.
    lv_vbtyp = wl_likp-vbtyp.
    CLEAR lt_mesg.

    lv_mblnr = wl_vbfa-vbeln.
    lv_mjahr = wl_vbfa-mjahr.

    CALL FUNCTION 'WS_REVERSE_GOODS_ISSUE'
      EXPORTING
        i_vbeln                   = lv_vbeln
        i_budat                   = lv_budat
        i_count                   = '001'
***        i_mblnr                   = lv_mblnr
        i_tcode                   = 'VL09'
        i_vbtyp                   = lv_vbtyp
*       I_MBLPO                   =
***        i_mjahr                   = lv_mjahr
*       I_POSNR                   =
*       I_SIMULATE                = ' '
*       I_SPE_BUDAT_UHR           =
*       I_SPE_BUDAT_ZONE          =
*       I_SPE_MDNUM_EWM           =
*       I_SPE_LOGSYS              =
*       I_SPE_CONFIRM_CENTRAL     = ' '
*       I_SPE_BILLING_REVERSAL    = ' '
* IMPORTING
*       ES_EMKPF                  =
      TABLES
        t_mesg                    = lt_mesg
*       T_VBAPF                   =
*       T_VBFA                    =
      EXCEPTIONS
        error_reverse_goods_issue = 1
        OTHERS                    = 2.
    IF sy-subrc <> 0.
      APPEND INITIAL LINE TO lt_return ASSIGNING FIELD-SYMBOL(<fs_return>).
      <fs_return>-type = 'E'.
      <fs_return>-message = 'Error al anular salida de mercancía'.
    ENDIF.

    LOOP AT lt_mesg ASSIGNING FIELD-SYMBOL(<fs_mesg>).
      APPEND INITIAL LINE TO lt_return ASSIGNING <fs_return>.
      <fs_return>-type = <fs_mesg>-msgty.
*<fs_return>-ID =
      <fs_return>-number = <fs_mesg>-txtnr.
      <fs_return>-message = <fs_mesg>-text.
      <fs_return>-message_v1 = <fs_mesg>-msgv1.
      <fs_return>-message_v2 = <fs_mesg>-msgv2.
      <fs_return>-message_v3 = <fs_mesg>-msgv3.
      <fs_return>-message_v4 = <fs_mesg>-msgv4.
    ENDLOOP.

  ENDMETHOD.
  METHOD anular_transporte.
    DATA: lo_excep TYPE REF TO cx_root,
          lv_error TYPE xflag.

    CLEAR lv_error.

    DATA(ls_ztsdle0001) = trans_cab_getdetail( lp_numtransporte ).



    IF lv_error IS INITIAL.

      TRY.
          anulacion_transporte( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.

    ENDIF.

    IF lv_error IS INITIAL.

      TRY.
          anulacion_es_cliente( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.

    ENDIF.

    IF lv_error IS INITIAL.

      TRY.
          anulacion_mod_vstel_pv( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.

    ENDIF.

    IF lv_error IS INITIAL.

      TRY.
          anulacion_es_traslado( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.

    ENDIF.

    IF lv_error IS INITIAL.

      TRY.
          anulacion_pedido_traslado( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.

    ENDIF.

    IF lv_error IS INITIAL.

      TRY.
          anulacion_pedidos_venta( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.

    ENDIF.


    IF lv_error IS INITIAL.

      TRY.
          anulacion_entrada_mat( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.

    ENDIF.

    IF lv_error IS INITIAL.

      TRY.
          anulacion_entrega_final_pedido( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.

    ENDIF.


    "
    " Actualizar cabecera
    "
    ls_ztsdle0001-estado = 9.
    trans_cab_update( ls_ztsdle0001 ).

    "
    " Lanzar error si lo hay
    "
    IF lv_error IS NOT INITIAL.
      RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
    ENDIF.

  ENDMETHOD.
  METHOD chk_lock_dlv.

    DO 10 TIMES.
      CALL FUNCTION 'ENQUEUE_EVVBLKE'
        EXPORTING
          vbeln          = lp_vbeln
          _wait          = 'X'
        EXCEPTIONS
          foreign_lock   = 1
          system_failure = 2
          OTHERS         = 3.

      IF sy-subrc = 1.
        "Delivery is enqueued
        WAIT UP TO 1 SECONDS.
      ELSE.
        "Unlock the delivery
        CALL FUNCTION 'DEQUEUE_EVVBLKE'
          EXPORTING
            vbeln = lp_vbeln.
        EXIT.
      ENDIF.
    ENDDO.

  ENDMETHOD.
  METHOD cierre_ekpo.
    DATA: lv_error TYPE text255.

    DATA: lv_purchaseorder TYPE bapimepoheader-po_number,
          lt_poitem        TYPE TABLE OF bapimepoitem,
          lt_poitemx       TYPE TABLE OF bapimepoitemx.

    CLEAR lv_error.
    SELECT SINGLE *
      FROM ekpo
      INTO @DATA(ls_ekpo)
      WHERE ebeln = @lp_ebeln AND
            ebelp = @lp_ebelp.
    IF sy-subrc <> 0.
      lv_error = 'Posición del pedido no existe.'.
    ENDIF.

    IF lv_error IS INITIAL.

      CLEAR: lp_return, lt_poitem, lt_poitemx.

      lv_purchaseorder = lp_ebeln.

      APPEND INITIAL LINE TO lt_poitem ASSIGNING FIELD-SYMBOL(<fs_poitem>).
      APPEND INITIAL LINE TO lt_poitemx ASSIGNING FIELD-SYMBOL(<fs_poitemx>).

      <fs_poitem>-po_item = lp_ebelp.
      <fs_poitem>-no_more_gr = 'X'.

      <fs_poitemx>-po_item = <fs_poitem>-po_item.
      <fs_poitemx>-no_more_gr = 'X'.

      CALL FUNCTION 'BAPI_PO_CHANGE'
        EXPORTING
          purchaseorder = lv_purchaseorder
        TABLES
          return        = lp_return
          poitem        = lt_poitem
          poitemx       = lt_poitemx.


    ENDIF.
    "
    " Lanzar error si lo hay
    "
    IF lv_error IS NOT INITIAL.
      zcl_seis_odata_utils=>lanzar_excepcion( message = lv_error ).
    ENDIF.
  ENDMETHOD.
  METHOD cierre_vbap.
    DATA: lv_error TYPE text255.


    CLEAR lv_error.
    SELECT SINGLE *
      FROM vbap
      INTO @DATA(ls_vbap)
      WHERE vbeln = @lp_vbeln AND
            posnr = @lp_posnr.
    IF sy-subrc <> 0.
      lv_error = 'Posición del pedido de venta no existe.'.
    ENDIF.

    IF lv_error IS INITIAL.
      SELECT *
        FROM vbep
        INTO TABLE @DATA(lt_vbep)
        WHERE vbeln = @lp_vbeln AND
              posnr = @lp_posnr.
      IF sy-subrc <> 0.
        lv_error = 'Posición del pedido de venta no existe.'.
      ENDIF.
    ENDIF.


    IF lv_error IS INITIAL.

      CLEAR: lp_return.

      DATA: lv_salesdocument    TYPE bapivbeln-vbeln,
            ls_order_header_inx TYPE bapisdh1x,
            lt_order_item_in    TYPE TABLE OF bapisditm,
            lt_order_item_inx   TYPE TABLE OF bapisditmx,
            lt_schedule_lines	  TYPE TABLE OF	bapischdl,
            lt_schedule_linesx  TYPE TABLE OF bapischdlx.

      lv_salesdocument = lp_vbeln.

      ls_order_header_inx-updateflag = 'U'.

***      APPEND INITIAL LINE TO lt_order_item_in ASSIGNING FIELD-SYMBOL(<fs_item>).
***      <fs_item>-itm_number = lp_posnr.
***      <fs_item>-reason_rej = 'Z8'.
***
***      APPEND INITIAL LINE TO lt_order_item_inx ASSIGNING FIELD-SYMBOL(<fs_itemx>).
***      " Indicadores de cambio para la posición
***      <fs_itemx>-itm_number = lp_posnr.
***      <fs_itemx>-updateflag = 'U'.
***      <fs_itemx>-reason_rej = 'X'.

      LOOP AT lt_vbep ASSIGNING FIELD-SYMBOL(<fs_vbep>).
        APPEND INITIAL LINE TO lt_schedule_lines ASSIGNING FIELD-SYMBOL(<fs_reparto>).
        <fs_reparto>-itm_number = <fs_vbep>-posnr.
        <fs_reparto>-sched_line = <fs_vbep>-etenr.
        <fs_reparto>-req_dlv_bl = 'ZS'.

        APPEND INITIAL LINE TO lt_schedule_linesx ASSIGNING FIELD-SYMBOL(<fs_repartox>).
        <fs_repartox>-itm_number = <fs_vbep>-posnr.
        <fs_repartox>-sched_line = <fs_vbep>-etenr.
        <fs_repartox>-updateflag = 'U'.
        <fs_repartox>-req_dlv_bl = 'X'.
      ENDLOOP.

      CALL FUNCTION 'BAPI_SALESORDER_CHANGE'
        EXPORTING
          salesdocument    = lv_salesdocument
          order_header_inx = ls_order_header_inx
        TABLES
          return           = lp_return
*         order_item_in    = lt_order_item_in
*         order_item_inx   = lt_order_item_inx
          schedule_lines   = lt_schedule_lines
          schedule_linesx  = lt_schedule_linesx.
    ENDIF.
    "
    " Lanzar error si lo hay
    "
    IF lv_error IS NOT INITIAL.
      zcl_seis_odata_utils=>lanzar_excepcion( message = lv_error ).
    ENDIF.
  ENDMETHOD.
  METHOD convertir_stock_cliente.
    DATA: lv_datos_log     TYPE zst_sdle_transp_log,
          lv_datos_log_msg TYPE zst_sdle_transp_log_msg.


    DATA: wl_goodsmvt_header  TYPE bapi2017_gm_head_01,
          wl_goodsmvt_code    TYPE bapi2017_gm_code,
          lv_materialdocument TYPE  bapi2017_gm_head_ret-mat_doc,
          lv_matdocumentyear  TYPE  bapi2017_gm_head_ret-doc_year,
          lt_goodsmvt_item    TYPE TABLE OF bapi2017_gm_item_create,
          lt_return           TYPE TABLE OF bapiret2,
          lv_line_id          TYPE bapi2017_gm_item_create-line_id.


    CLEAR: lt_goodsmvt_item, lv_line_id.

    "
    " Confirmar si el paso ya se ha ejecutado.
    "
    DATA(lt_log) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_convertir_stock_cli  lp_estado = gc_estado_log_ok lp_buscar_paso_cero = 'X').
    DATA(lv_lines_log) = lines( lt_log ).
    IF lv_lines_log IS NOT INITIAL.
      RETURN.
    ENDIF.

    DATA(ls_trans_cab) = trans_cab_getdetail( lp_numtransporte ).

    "
    " Recuperamos las posiciones
    "
    DATA(lt_posiciones) = trans_pos_getlist( lp_numtransporte ).

    LOOP AT lt_posiciones ASSIGNING FIELD-SYMBOL(<fs_posiciones>).
      " Ignorar SC, ya que estos crean el stock y lo crean a cliente y no se deben convertir.
      CHECK <fs_posiciones>-proceso <> 'SC'.
      "
      " Buscar si el material final y lote están en stock cliente.
      "
      SELECT SINGLE *
      FROM mska
      INTO @DATA(ls_mska)
      WHERE matnr = @<fs_posiciones>-matnr_final AND
            charg = @<fs_posiciones>-charg AND
            werks = @ls_trans_cab-werks AND
            lgort = @ls_trans_cab-lgort AND
            mska~kalab <> 0.
      IF sy-subrc = 0.

        ADD 1 TO lv_line_id.
        APPEND INITIAL LINE TO lt_goodsmvt_item ASSIGNING FIELD-SYMBOL(<fs_goodsmvt_item>).
        <fs_goodsmvt_item>-line_id = lv_line_id.
        <fs_goodsmvt_item>-material   = <fs_posiciones>-matnr_final.
        <fs_goodsmvt_item>-batch   = <fs_posiciones>-charg.
        <fs_goodsmvt_item>-plant      = ls_mska-werks.
        <fs_goodsmvt_item>-stge_loc   = ls_mska-lgort.
        <fs_goodsmvt_item>-move_type  = '411'.
        CLEAR <fs_goodsmvt_item>-mvt_ind.
        <fs_goodsmvt_item>-val_type = <fs_posiciones>-charg.

        <fs_goodsmvt_item>-spec_stock = 'E'.
        <fs_goodsmvt_item>-sales_ord = ls_mska-vbeln.
        <fs_goodsmvt_item>-s_ord_item = ls_mska-posnr.
        <fs_goodsmvt_item>-val_sales_ord = ls_mska-vbeln.
        <fs_goodsmvt_item>-val_s_ord_item = ls_mska-posnr.

        IF <fs_posiciones>-kwmeng_real <= ls_mska-kalab.
          <fs_goodsmvt_item>-entry_qnt = <fs_posiciones>-kwmeng_real.
        ELSE.
          <fs_goodsmvt_item>-entry_qnt = ls_mska-kalab.
        ENDIF.
        <fs_goodsmvt_item>-entry_uom = <fs_posiciones>-vrkme.

      ENDIF.

    ENDLOOP.

    IF lt_goodsmvt_item IS NOT INITIAL.
      CLEAR: wl_goodsmvt_header, wl_goodsmvt_code.

      wl_goodsmvt_header-pstng_date = ls_trans_cab-wadat_ist.
      IF wl_goodsmvt_header-pstng_date > sy-datum.
        wl_goodsmvt_header-pstng_date = sy-datum.
      ENDIF.
      wl_goodsmvt_header-doc_date = sy-datum.
      wl_goodsmvt_header-pr_uname = sy-uname.
      wl_goodsmvt_code-gm_code = '04'.

      CLEAR: lv_materialdocument, lv_matdocumentyear.

      CLEAR lt_return.

      CALL FUNCTION 'BAPI_GOODSMVT_CREATE'
        EXPORTING
          goodsmvt_header  = wl_goodsmvt_header
          goodsmvt_code    = wl_goodsmvt_code
        IMPORTING
          materialdocument = lv_materialdocument
          matdocumentyear  = lv_matdocumentyear
        TABLES
          goodsmvt_item    = lt_goodsmvt_item
          return           = lt_return.

      IF lv_materialdocument IS INITIAL.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_convertir_stock_cli.
        lv_datos_log-estado = gc_estado_log_nook.
        lv_datos_log-mensaje = 'Ver errores'.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        " Para grabar el log.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

        LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<fs_return>).
          MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
          lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
          lv_datos_log_msg-paso = lv_datos_log-paso.
          lv_datos_log_msg-posicion = lv_datos_log-posicion.
          lv_datos_log_msg-msgno = <fs_return>-number.

          trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
        ENDLOOP.
        " Devolvemos excepción para no continuar.
        RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
      ELSE.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_convertir_stock_cli.
        lv_datos_log-estado = gc_estado_log_ok.
        lv_datos_log-mensaje = 'Documento material creado.'.
        lv_datos_log-mblnr = lv_materialdocument.
        lv_datos_log-mjahr = lv_matdocumentyear.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

      ENDIF.
    ENDIF.

  ENDMETHOD.
  METHOD creacion_es_cliente.
    TYPES: BEGIN OF st_datos,
             vbeln       TYPE vbeln_va,
             posnr       TYPE posnr_va,
             kwmeng_real TYPE kwmeng,
             vrkme       TYPE vrkme,
           END OF st_datos.

    DATA: lt_datos TYPE TABLE OF st_datos.

    DATA: lv_datos_log     TYPE zst_sdle_transp_log,
          lv_datos_log_msg TYPE zst_sdle_transp_log_msg.

    "
    " Confirmar si el paso ya se ha ejecutado.
    "
    DATA(lt_log) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_creacion_es_cliente  lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log) = lines( lt_log ).
    IF lv_lines_log IS NOT INITIAL.
      RETURN.
    ENDIF.

    DATA(ls_trans_cab) = trans_cab_getdetail( lp_numtransporte ).
    IF ls_trans_cab-destino = 2.
      lv_datos_log-numtransporte = lp_numtransporte.
      lv_datos_log-paso = gc_paso_creacion_es_cliente.
      lv_datos_log-estado = gc_estado_log_ok.
      lv_datos_log-mensaje = 'Destino Xàtiva. Paso no necesario. '.
      trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          wait = 'X'.
      RETURN.
    ENDIF.

    "
    " recupero información de los movimientos de entrada de producto final.
    "
    DATA(lt_log_notificacion) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_notificar_entrada_pt  lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_notificacion) = lines( lt_log_notificacion ).
    IF lv_lines_notificacion IS NOT INITIAL.
*      RETURN.
*    ENDIF.


      DATA: lr_mblnr TYPE RANGE OF mseg-mblnr,
            lv_mjahr TYPE mseg-mjahr.

      LOOP AT lt_log_notificacion ASSIGNING FIELD-SYMBOL(<fs_log_not>).

        lv_mjahr = <fs_log_not>-mjahr. "Entiendo que todo está en el mismo ejercicio

        APPEND INITIAL LINE TO lr_mblnr ASSIGNING FIELD-SYMBOL(<fs_mblnr>).
        <fs_mblnr>-sign = 'I'.
        <fs_mblnr>-option = 'EQ'.
        <fs_mblnr>-low = <fs_log_not>-mblnr.
      ENDLOOP.

      DATA: lv_fecha_reparto TYPE vbak-vdatu,
            lv_delivery      TYPE bapishpdelivnumb-deliv_numb,
            lt_sales_order   TYPE TABLE OF bapidlvreftosalesorder,
            ls_sales_order   LIKE LINE OF lt_sales_order,
            lt_deliveries    TYPE TABLE OF bapishpdelivnumb,
            lt_return        TYPE TABLE OF bapiret2,
            lt_vbpok         TYPE TABLE OF vbpok,
            lt_prott         TYPE TABLE OF prott.


      DATA(lt_posiciones) = trans_pos_getlist( lp_numtransporte ).

      CLEAR lt_datos.
      LOOP AT lt_posiciones ASSIGNING FIELD-SYMBOL(<fs_pos>).
        IF <fs_pos>-posnr IS NOT INITIAL.
          APPEND INITIAL LINE TO lt_datos ASSIGNING FIELD-SYMBOL(<fs_dato>).
          MOVE-CORRESPONDING <fs_pos> TO <fs_dato>.
        ENDIF.
      ENDLOOP.

      SORT lt_datos BY vbeln posnr.

      LOOP AT lt_datos ASSIGNING <fs_dato>.
        AT NEW vbeln.

        ENDAT.

        AT NEW posnr.
          CLEAR: ls_sales_order, lt_sales_order.
          " Añadimos los datos de la posición anterior
          ls_sales_order-ref_doc = <fs_dato>-vbeln.
          ls_sales_order-ref_item = <fs_dato>-posnr.
          ls_sales_order-dlv_qty = <fs_dato>-kwmeng_real.
          ls_sales_order-sales_unit = <fs_dato>-vrkme.
          APPEND ls_sales_order TO lt_sales_order.
        ENDAT.

        AT END OF posnr.

          SELECT SINGLE *
            FROM vbap
            INTO @DATA(ls_vbap)
            WHERE vbeln = @<fs_dato>-vbeln AND
                  posnr = @<fs_dato>-posnr.


          "
          " Creamos entrega.
          "
          CLEAR lt_return.
          CLEAR lv_delivery.
          CLEAR lv_fecha_reparto.
          lv_fecha_reparto = '99991231'. "ls_trans_cab-wadat_ist. " '99991231'.

          CALL FUNCTION 'BAPI_OUTB_DELIVERY_CREATE_SLS'
            EXPORTING
              due_date          = lv_fecha_reparto
            IMPORTING
              delivery          = lv_delivery
            TABLES
              sales_order_items = lt_sales_order
              deliveries        = lt_deliveries
              return            = lt_return.

          DATA lv_error TYPE xflag.
          CLEAR lv_error.

          LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<fs_return>).
            IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
              lv_error = 'X'.
              EXIT.
            ENDIF.

          ENDLOOP.

*****        IF lv_error IS INITIAL.
*****          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
*****            EXPORTING
*****              wait = 'X'.
*****
*****          "
*****          " Actualizamos fecha salida mercancía
*****          "
*****          DATA: ls_vbkok                  TYPE vbkok,
*****                ef_error_any              TYPE  xfeld,
*****                ef_error_in_item_deletion TYPE  xfeld,
*****                ef_error_in_pod_update    TYPE  xfeld,
*****                ef_error_in_interface     TYPE  xfeld,
*****                ef_error_in_goods_issue   TYPE  xfeld,
*****                ef_error_in_final_check   TYPE  xfeld,
*****                ef_error_partner_update   TYPE  xfeld,
*****                ef_error_sernr_update     TYPE  xfeld.
*****
*****
*****          CLEAR: ls_vbkok, lt_vbpok,
*****                ef_error_any,
*****                ef_error_in_item_deletion,
*****                ef_error_in_pod_update,
*****                ef_error_in_interface,
*****                ef_error_in_goods_issue,
*****                ef_error_in_final_check,
*****                ef_error_partner_update,
*****                ef_error_sernr_update.
*****
*****          ls_vbkok-vbeln_vl = lv_delivery.
*****          ls_vbkok-wadat_ist = ls_trans_cab-wadat_ist.
*****          ls_vbkok-wadat = ls_trans_cab-wadat_ist.
*****          ls_vbkok-lfdat = ls_trans_cab-wadat_ist.
*****          ls_vbkok-kzlfd = 'X'.
*****          ls_vbkok-kzkodat   = 'X'.
*****          ls_vbkok-kzbld     = 'X'.
*****
*****          SELECT SINGLE route
*****            INTO @DATA(lv_route)
*****            FROM likp
*****            WHERE vbeln = @lv_delivery.
*****          IF sy-subrc = 0 AND lv_route IS INITIAL.
*****            ls_vbkok-route = 'Z00000'.
*****            ls_vbkok-kzroute = 'X'.
*****          ENDIF.
*****
*****          CLEAR lt_vbpok.
*****          SELECT *
*****            INTO TABLE @DATA(lt_lips)
*****            FROM lips
*****            WHERE vbeln = @lv_delivery.
*****
*****          DATA lv_posnr TYPE posnr_vl.
*****          CLEAR lv_posnr.
*****          LOOP AT lt_lips ASSIGNING FIELD-SYMBOL(<fs_lips>).
*****            IF lv_posnr(1) = 9.
*****              lv_posnr = lv_posnr + 1.
*****            ELSE.
*****              lv_posnr = '900001'.
*****            ENDIF.
*****
*****            APPEND INITIAL LINE TO lt_vbpok ASSIGNING FIELD-SYMBOL(<fs_vbpok>).
*****
*****            <fs_vbpok>-vbeln_vl = <fs_lips>-vbeln.
*****            <fs_vbpok>-posnr_vl = <fs_lips>-posnr.
*****            <fs_vbpok>-vbeln    = <fs_lips>-vgbel.
*****            <fs_vbpok>-posnn    = <fs_lips>-vgpos.
*****            <fs_vbpok>-matnr    = <fs_lips>-matnr.
*****
*****            APPEND INITIAL LINE TO lt_vbpok ASSIGNING <fs_vbpok>.
*****            <fs_vbpok>-vbeln_vl = <fs_lips>-vbeln.
*****            <fs_vbpok>-posnr_vl = <fs_lips>-posnr.
*****            <fs_vbpok>-vbeln    = <fs_lips>-vbeln.
*****            <fs_vbpok>-posnn    = lv_posnr.
*****
*****            <fs_vbpok>-matnr    = <fs_lips>-matnr.
*****            <fs_vbpok>-werks    = <fs_lips>-werks.
*****            <fs_vbpok>-umvkz    = <fs_lips>-umvkz.
*****            <fs_vbpok>-umvkn    = <fs_lips>-umvkn.
*****            <fs_vbpok>-gewei    = <fs_lips>-gewei.
*****            <fs_vbpok>-pikmg    = <fs_lips>-lfimg.
*****
*****
*****
******            <fs_vbpok>-vbeln_vl = <fs_lips>-vbeln.
******            <fs_vbpok>-posnr_vl = <fs_lips>-posnr.
******            <fs_vbpok>-vbeln = <fs_lips>-vbeln.
******            <fs_vbpok>-posnn = lv_posnr.
******            <fs_vbpok>-matnr = <fs_lips>-matnr.
******            <fs_vbpok>-werks = <fs_lips>-werks.
******            <fs_vbpok>-lgort = <fs_lips>-lgort.
*****
******            <fs_vbpok>-pikmg = <fs_lips>-brgew.
******            <fs_vbpok>-lfimg = <fs_lips>-brgew.
******            <fs_vbpok>-vrkme = <fs_lips>-gewei.
*****
*****            SELECT SINGLE *
*****              FROM vbfa
*****              INTO @DATA(ls_vbfa)
*****              WHERE vbeln = @<fs_lips>-vbeln AND
*****                    posnn = @<fs_lips>-posnr AND
*****                    vbtyp_n = 'J' AND
*****                    vbtyp_v = 'C'.
*****            CHECK sy-subrc = 0.
*****
*****            SELECT SINGLE charg
*****              INTO <fs_vbpok>-charg
*****              FROM mseg
*****              WHERE mblnr IN lr_mblnr AND
*****                    mjahr = lv_mjahr AND
*****                    bwart = '101' AND
*****                    kdauf = ls_vbfa-vbelv AND
*****                    kdpos = ls_vbfa-posnv.
*****            IF sy-subrc <> 0.
*****              CLEAR <fs_vbpok>-charg.
*****            ENDIF.
*****
*****          ENDLOOP.
*****
*****          CALL FUNCTION 'WS_DELIVERY_UPDATE_2'
*****            EXPORTING
*****              vbkok_wa                  = ls_vbkok
*****              synchron                  = 'X'
******             NO_MESSAGES_UPDATE_1      = ' '
*****              commit                    = 'X'
*****              delivery                  = lv_delivery
*****              update_picking            = 'X'
******             NICHT_SPERREN_1           = ' '
******             IF_CONFIRM_CENTRAL        = ' '
******             IF_WMPP                   = ' '
******             IF_GET_DELIVERY_BUFFERED  = ' '
******             IF_NO_GENERIC_SYSTEM_SERVICE       = ' '
******             IF_DATABASE_UPDATE_1      = '1'
******             IF_NO_INIT_1              = ' '
******             IF_NO_READ_1              = ' '
******             IF_ERROR_MESSAGES_SEND    = 'X'
******             IF_NO_BUFFER_REFRESH      = ' '
******             IT_PARTNER_UPDATE         =
******             IT_SERNR_UPDATE           =
******             IF_NO_REMOTE_CHG_1        = ' '
******             IF_NO_MES_UPD_PACK        = ' '
******             IF_LATE_DELIVERY_UPD      = ' '
******             IF_TXT_REINITIALIZE       =
******             IF_BOR_INIT               = ' '
******             SPE_MES_NO_SEND_NODIAL    =
******             IT_LECOMP_1               =
******             IF_DPP_CHECK_BLOCKED_PAR  = ' '
*****            IMPORTING
*****              ef_error_any              = ef_error_any
*****              ef_error_in_item_deletion = ef_error_in_item_deletion
*****              ef_error_in_pod_update    = ef_error_in_pod_update
*****              ef_error_in_interface     = ef_error_in_interface
*****              ef_error_in_goods_issue   = ef_error_in_goods_issue
*****              ef_error_in_final_check   = ef_error_in_final_check
*****              ef_error_partner_update   = ef_error_partner_update
*****              ef_error_sernr_update     = ef_error_sernr_update
*****            TABLES
*****              vbpok_tab                 = lt_vbpok
*****              prot                      = lt_prott
******             VERKO_TAB                 =
******             VERPO_TAB                 =
******             VBSUPCON_TAB_1            =
******             IT_VERPO_SERNR            =
******             IT_PACKING                =
******             IT_PACKING_SERNR          =
******             IT_REPACK                 =
******             IT_HANDLING_UNITS_1       =
******             IT_OBJECTS                =
******             ET_CREATED_HUS            =
******             TVPOD_TAB                 =
******             IT_TEXTH                  =
******             IT_TEXTL                  =
******             IT_TMSTMP                 =
******             IT_OBJ_QUAN_CHG           =
******             IT_VBPOK_SPLIT            =
******             IT_BAPIADDR1              =
******             IT_HU_HEADER_EPC          =
******             IT_HU_ITEMS_EPC           =
******             IT_AAC_ITEM_BLOCK         =
*****            .
*****
*****
*****          IF ef_error_any              IS NOT INITIAL OR
*****            ef_error_in_item_deletion IS NOT INITIAL OR
*****            ef_error_in_pod_update    IS NOT INITIAL OR
*****            ef_error_in_interface     IS NOT INITIAL OR
*****            ef_error_in_goods_issue   IS NOT INITIAL OR
*****            ef_error_in_final_check   IS NOT INITIAL OR
*****            ef_error_partner_update   IS NOT INITIAL OR
*****            ef_error_sernr_update     IS NOT INITIAL.
*****            lv_error = 'X'.
*****          ELSE.
*****            " wadat_ist solo se actualiza cuando vbkok_wa-wabuc = 'X'
*****            " Lo hacemos por update a tabla.
*****            UPDATE likp
*****             SET wadat_ist = ls_trans_cab-wadat_ist
*****             WHERE vbeln = lv_delivery.
*****
*****            " Para grabar el log.
*****            CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
*****              EXPORTING
*****                wait = 'X'.
*****
*****          ENDIF.
*****        ENDIF.

          IF lv_error IS INITIAL.
            CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
              EXPORTING
                wait = 'X'.

            DATA: ls_header_data    TYPE bapiobdlvhdrchg,
                  ls_header_control TYPE  bapiobdlvhdrctrlchg,
                  lv_delivery_2     TYPE bapiobdlvhdrchg-deliv_numb,
                  ls_techn_control  TYPE  bapidlvcontrol.

            DATA: lt_item_data    TYPE TABLE OF bapiobdlvitemchg,
                  lt_item_control TYPE TABLE OF bapiobdlvitemctrlchg.

            CLEAR: ls_header_data,
                  ls_header_control,
                  lv_delivery_2,
                  ls_techn_control.

            CLEAR: lt_item_data,
                   lt_item_control.

            lv_delivery_2 = lv_delivery.
            ls_header_data-deliv_numb = lv_delivery_2.
            ls_techn_control-upd_ind = 'U'.
            ls_header_control-deliv_numb = lv_delivery_2.

            SELECT SINGLE route
              INTO @DATA(lv_route)
              FROM likp
              WHERE vbeln = @lv_delivery.
            IF sy-subrc = 0 AND lv_route IS INITIAL.
              ls_header_data-route = 'Z00000'.
              ls_header_control-route_flg = 'X'.
            ENDIF.

            SELECT *
              INTO TABLE @DATA(lt_lips)
              FROM lips
              WHERE vbeln = @lv_delivery.

            DATA lv_posnr TYPE posnr_vl.
            CLEAR lv_posnr.
            LOOP AT lt_lips ASSIGNING FIELD-SYMBOL(<fs_lips>).
              IF lv_posnr(1) = 9.
                lv_posnr = lv_posnr + 1.
              ELSE.
                lv_posnr = '900001'.
              ENDIF.

              APPEND INITIAL LINE TO lt_item_data ASSIGNING FIELD-SYMBOL(<fs_data>).
              <fs_data>-deliv_numb = <fs_lips>-vbeln.
              <fs_data>-deliv_item = <fs_lips>-posnr.
              <fs_data>-material = <fs_lips>-matnr.

              APPEND INITIAL LINE TO lt_item_data ASSIGNING <fs_data>.
              <fs_data>-deliv_numb = <fs_lips>-vbeln.
              <fs_data>-deliv_item = lv_posnr.
              <fs_data>-hieraritem = <fs_lips>-posnr.
              <fs_data>-usehieritm = '1'.
              <fs_data>-material = <fs_lips>-matnr.
              <fs_data>-dlv_qty = <fs_lips>-lfimg.
              <fs_data>-fact_unit_nom = 1.
              <fs_data>-fact_unit_denom = 1.

              SELECT SINGLE *
                FROM vbfa
                INTO @DATA(ls_vbfa)
                WHERE vbeln = @<fs_lips>-vbeln AND
                      posnn = @<fs_lips>-posnr AND
                      vbtyp_n = 'J' AND
                      vbtyp_v = 'C'.
              CHECK sy-subrc = 0.

              SELECT SINGLE charg
                INTO <fs_data>-batch
                FROM mseg
                WHERE mblnr IN lr_mblnr AND
                      mjahr = lv_mjahr AND
                      bwart = '101' AND
                      kdauf = ls_vbfa-vbelv AND
                      kdpos = ls_vbfa-posnv.
              IF sy-subrc <> 0.
                CLEAR <fs_data>-batch.
              ENDIF.

              APPEND INITIAL LINE TO lt_item_control ASSIGNING FIELD-SYMBOL(<fs_control>).
              <fs_control>-deliv_numb = <fs_lips>-vbeln.
              <fs_control>-deliv_item = <fs_lips>-posnr.
              <fs_control>-chg_delqty = 'X'.

              APPEND INITIAL LINE TO lt_item_control ASSIGNING <fs_control>.
              <fs_control>-deliv_numb = <fs_lips>-vbeln.
              <fs_control>-deliv_item = lv_posnr.
              <fs_control>-chg_delqty = 'X'.

            ENDLOOP.

            CLEAR lt_return.
            CALL FUNCTION 'BAPI_OUTB_DELIVERY_CHANGE'
              EXPORTING
                header_data    = ls_header_data
                header_control = ls_header_control
                delivery       = lv_delivery_2
                techn_control  = ls_techn_control
*               HEADER_DATA_SPL               =
*               HEADER_CONTROL_SPL            =
*               SENDER_SYSTEM  =
              TABLES
*               HEADER_PARTNER =
*               HEADER_PARTNER_ADDR           =
*               HEADER_DEADLINES              =
                item_data      = lt_item_data
                item_control   = lt_item_control
*               ITEM_SERIAL_NO =
*               SUPPLIER_CONS_DATA            =
*               EXTENSION1     =
*               EXTENSION2     =
                return         = lt_return.

            CLEAR lv_error.

            LOOP AT lt_return ASSIGNING <fs_return>.
              IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
                lv_error = 'X'.
                EXIT.
              ENDIF.

            ENDLOOP.

            IF lv_error IS INITIAL.

              CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
                EXPORTING
                  wait = 'X'.


              " wadat_ist solo se actualiza cuando vbkok_wa-wabuc = 'X'
              " Lo hacemos por update a tabla.
              UPDATE likp
               SET wadat_ist = ls_trans_cab-wadat_ist
               WHERE vbeln = lv_delivery.

              " Para grabar el log.
              CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
                EXPORTING
                  wait = 'X'.

              TRY.
                  DATA lv_vbeln TYPE likp-vbeln.
                  lv_vbeln = lv_delivery.
                  actualizar_picking( lp_vbeln = lv_vbeln lp_numtransporte = lp_numtransporte ).

                  " Para grabar el log.
                  CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
                    EXPORTING
                      wait = 'X'.

                CATCH /iwbep/cx_mgw_busi_exception .
                  lv_error = 'X'.
                  APPEND INITIAL LINE TO lt_return ASSIGNING <fs_return>.
                  <fs_return>-type = 'E'.
                  <fs_return>-message = 'Error al realizar el picking en la entrega'.
                  <fs_return>-message_v1 = lv_delivery.
              ENDTRY.


            ENDIF.

          ENDIF.

          IF lv_error IS NOT INITIAL.
            lv_datos_log-numtransporte = lp_numtransporte.
            lv_datos_log-paso = gc_paso_creacion_es_cliente.
            lv_datos_log-estado = gc_estado_log_nook.
            lv_datos_log-mensaje = 'Ver errores'.
            trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

            " Para grabar el log.
            CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
              EXPORTING
                wait = 'X'.

            LOOP AT lt_return ASSIGNING <fs_return>.
              MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
              lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
              lv_datos_log_msg-paso = lv_datos_log-paso.
              lv_datos_log_msg-posicion = lv_datos_log-posicion.
              lv_datos_log_msg-msgno = <fs_return>-number.

              trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
            ENDLOOP.

            IF lt_return IS INITIAL.
              CLEAR lv_datos_log_msg.
              lv_datos_log_msg-id = sy-msgid.
              lv_datos_log_msg-msgno = sy-msgno.
              lv_datos_log_msg-message_v1 = sy-msgv1.
              lv_datos_log_msg-message_v2 = sy-msgv2.
              lv_datos_log_msg-message_v3 = sy-msgv3.
              lv_datos_log_msg-message_v4 = sy-msgv4.
              lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
              lv_datos_log_msg-paso = lv_datos_log-paso.
              lv_datos_log_msg-posicion = lv_datos_log-posicion.
              trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).

            ENDIF.

            " Devolvemos excepción para no continuar.
            RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
          ELSE.
            lv_datos_log-numtransporte = lp_numtransporte.
            lv_datos_log-paso = gc_paso_creacion_es_cliente.
            lv_datos_log-estado = gc_estado_log_ok.
            lv_datos_log-mensaje = 'Entrega creada'.
            lv_datos_log-vbeln = <fs_dato>-vbeln.
            lv_datos_log-posnr = <fs_dato>-posnr.
            lv_datos_log-vbeln_vl = lv_delivery.
            trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

            CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
              EXPORTING
                wait = 'X'.
          ENDIF.
        ENDAT.
      ENDLOOP.
    ENDIF.

    "
    " recupero información de los pedidos de venta creados.
    "
    DATA(lt_log_ped) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_creacion_pedidos_vta  lp_estado = gc_estado_log_ok ).
    LOOP AT lt_log_ped ASSIGNING FIELD-SYMBOL(<fs_log_ped>).
      CHECK <fs_log_ped>-vbeln IS NOT INITIAL.

      CLEAR: lt_sales_order, lt_deliveries.

      CLEAR: ls_sales_order.
      ls_sales_order-ref_doc = <fs_log_ped>-vbeln.
      APPEND ls_sales_order TO lt_sales_order.



      "
      " Creamos entrega.
      "
      CLEAR lt_return.
      CLEAR lv_delivery.
      CLEAR lv_fecha_reparto.
      lv_fecha_reparto = '99991231'. "ls_trans_cab-wadat_ist. " '99991231'.

      CALL FUNCTION 'BAPI_OUTB_DELIVERY_CREATE_SLS'
        EXPORTING
          due_date          = lv_fecha_reparto
        IMPORTING
          delivery          = lv_delivery
        TABLES
          sales_order_items = lt_sales_order
          deliveries        = lt_deliveries
          return            = lt_return.

      CLEAR lv_error.

      LOOP AT lt_return ASSIGNING <fs_return>.
        IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
          lv_error = 'X'.
          EXIT.
        ENDIF.

      ENDLOOP.
      IF lv_error IS INITIAL.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

        SELECT SINGLE route
          INTO lv_route
          FROM likp
          WHERE vbeln = lv_delivery.
        IF sy-subrc = 0 AND lv_route IS INITIAL.
          CLEAR: ls_header_data,
                 ls_header_control,
                 lv_delivery_2,
                 ls_techn_control.

          CLEAR: lt_item_data,
                 lt_item_control.

          lv_delivery_2 = lv_delivery.
          ls_header_data-deliv_numb = lv_delivery_2.
          ls_techn_control-upd_ind = 'U'.
          ls_header_control-deliv_numb = lv_delivery_2.

          ls_header_data-route = 'Z00000'.
          ls_header_control-route_flg = 'X'.

          CLEAR lt_return.
          CALL FUNCTION 'BAPI_OUTB_DELIVERY_CHANGE'
            EXPORTING
              header_data    = ls_header_data
              header_control = ls_header_control
              delivery       = lv_delivery_2
              techn_control  = ls_techn_control
*             HEADER_DATA_SPL               =
*             HEADER_CONTROL_SPL            =
*             SENDER_SYSTEM  =
            TABLES
*             HEADER_PARTNER =
*             HEADER_PARTNER_ADDR           =
*             HEADER_DEADLINES              =
*              item_data      = lt_item_data
*              item_control   = lt_item_control
*             ITEM_SERIAL_NO =
*             SUPPLIER_CONS_DATA            =
*             EXTENSION1     =
*             EXTENSION2     =
              return         = lt_return.

          CLEAR lv_error.

          LOOP AT lt_return ASSIGNING <fs_return>.
            IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
              lv_error = 'X'.
              EXIT.
            ENDIF.

          ENDLOOP.
        ENDIF.

      ENDIF.
      IF lv_error IS INITIAL.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.


        LOOP AT lt_deliveries ASSIGNING FIELD-SYMBOL(<fs_deliveries>).

          TRY.
              lv_vbeln = <fs_deliveries>-deliv_numb.
              actualizar_picking( lp_vbeln = lv_vbeln lp_numtransporte = lp_numtransporte ).

              " Para grabar el log.
              CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
                EXPORTING
                  wait = 'X'.

            CATCH /iwbep/cx_mgw_busi_exception .
              lv_error = 'X'.
              APPEND INITIAL LINE TO lt_return ASSIGNING <fs_return>.
              <fs_return>-type = 'E'.
              <fs_return>-message = 'Error al realizar el picking en la entrega'.
              <fs_return>-message_v1 = lv_vbeln.
          ENDTRY.
        ENDLOOP.
      ENDIF.

      IF lv_error IS NOT INITIAL.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_creacion_es_cliente.
        lv_datos_log-estado = gc_estado_log_nook.
        lv_datos_log-mensaje = 'Ver errores'.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        " Para grabar el log.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

        LOOP AT lt_return ASSIGNING <fs_return>.
          MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
          lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
          lv_datos_log_msg-paso = lv_datos_log-paso.
          lv_datos_log_msg-posicion = lv_datos_log-posicion.
          lv_datos_log_msg-msgno = <fs_return>-number.

          trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
        ENDLOOP.

        IF lt_return IS INITIAL.
          CLEAR lv_datos_log_msg.
          lv_datos_log_msg-id = sy-msgid.
          lv_datos_log_msg-msgno = sy-msgno.
          lv_datos_log_msg-message_v1 = sy-msgv1.
          lv_datos_log_msg-message_v2 = sy-msgv2.
          lv_datos_log_msg-message_v3 = sy-msgv3.
          lv_datos_log_msg-message_v4 = sy-msgv4.
          lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
          lv_datos_log_msg-paso = lv_datos_log-paso.
          lv_datos_log_msg-posicion = lv_datos_log-posicion.
          trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).

        ENDIF.

        " Devolvemos excepción para no continuar.
        RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
      ELSE.

        LOOP AT lt_deliveries ASSIGNING <fs_deliveries>.

          CLEAR lv_datos_log.
          lv_datos_log-numtransporte = lp_numtransporte.
          lv_datos_log-paso = gc_paso_creacion_es_cliente.
          lv_datos_log-estado = gc_estado_log_ok.
          lv_datos_log-mensaje = 'Entrega creada'.
          lv_datos_log-vbeln = <fs_log_ped>-vbeln.
          lv_datos_log-vbeln_vl = <fs_deliveries>-deliv_numb.
          trans_log_create( CHANGING wp_trans_log = lv_datos_log ).
        ENDLOOP.

        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.
      ENDIF.
    ENDLOOP.

  ENDMETHOD.
  METHOD creacion_es_traslado.
    TYPES: BEGIN OF st_datos,
             matnr TYPE matnr_d,
             vbeln TYPE vbeln_va,
             posnr TYPE posnr_va,
             menge TYPE menge_d,
             meins TYPE meins,
           END OF st_datos.

    DATA: lt_datos TYPE TABLE OF st_datos.

    DATA: lv_datos_log     TYPE zst_sdle_transp_log,
          lv_datos_log_msg TYPE zst_sdle_transp_log_msg.

    DATA: lt_stock_trans_items TYPE TABLE OF bapidlvreftosto,
          ls_stock_trans_items LIKE LINE OF lt_stock_trans_items,
          lt_deliveries        TYPE TABLE OF bapishpdelivnumb,
          lt_return            TYPE TABLE OF bapiret2,
          lv_fecha_reparto     TYPE vbak-vdatu,
          lv_ship_point        TYPE  bapidlvcreateheader-ship_point.

    DATA(ls_trans_cab) = trans_cab_getdetail( lp_numtransporte ).
    "
    " Confirmar si el paso ya se ha ejecutado.
    "
    DATA(lt_log) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_creacion_es_traslado  lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log) = lines( lt_log ).
    IF lv_lines_log IS NOT INITIAL.
      RETURN.
    ENDIF.

    IF ls_trans_cab-destino = 1.
      lv_datos_log-numtransporte = lp_numtransporte.
      lv_datos_log-paso = gc_paso_creacion_es_traslado.
      lv_datos_log-estado = gc_estado_log_ok.
      lv_datos_log-mensaje = 'Destino cliente. Paso no necesario. '.
      trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          wait = 'X'.
      RETURN.
    ENDIF.

    "
    " recupero información de los pedidos de traslado creados.
    "
    DATA(lt_log_ped) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_creacion_pedido_tras  lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_ped) = lines( lt_log_ped ).
    IF lv_lines_ped IS INITIAL.
      RETURN.
    ENDIF.


    LOOP AT lt_log_ped ASSIGNING FIELD-SYMBOL(<fs_log_ped>).
      " solo tendremos uno, pero por si acaso.
      SELECT *
        FROM ekpo
        INTO TABLE @DATA(lt_ekpo)
        WHERE ebeln = @<fs_log_ped>-ebeln.

      CLEAR lt_stock_trans_items.

      LOOP AT lt_ekpo ASSIGNING FIELD-SYMBOL(<fs_ekpo>).
        APPEND INITIAL LINE TO lt_stock_trans_items ASSIGNING FIELD-SYMBOL(<fs_stock>).
        <fs_stock>-ref_doc = <fs_ekpo>-ebeln.
        <fs_stock>-ref_item = <fs_ekpo>-ebelp.
        <fs_stock>-dlv_qty = <fs_ekpo>-menge.
        <fs_stock>-sales_unit = <fs_ekpo>-meins.
      ENDLOOP.

      CLEAR lv_fecha_reparto.
      lv_fecha_reparto = '99991231'.
      lv_ship_point = 'P001'.

      CLEAR lt_deliveries.
      CALL FUNCTION 'BAPI_OUTB_DELIVERY_CREATE_STO'
        EXPORTING
          ship_point        = lv_ship_point
          due_date          = lv_fecha_reparto
*         DEBUG_FLG         =
*         NO_DEQUEUE        = ' '
*             IMPORTING
*         DELIVERY          =
*         NUM_DELIVERIES    =
        TABLES
          stock_trans_items = lt_stock_trans_items
          deliveries        = lt_deliveries
          return            = lt_return.

      DATA lv_error TYPE xflag.
      CLEAR lv_error.

      LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<fs_return>).
        IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
          lv_error = 'X'.
          EXIT.
        ENDIF.

      ENDLOOP.

      IF lv_error IS INITIAL.
        TRY.
            " Para grabar el log.
            CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
              EXPORTING
                wait = 'X'.

            DATA lv_vbeln TYPE likp-vbeln.
            LOOP AT lt_deliveries ASSIGNING FIELD-SYMBOL(<fs_delivery>).
              lv_vbeln = <fs_delivery>-deliv_numb.
              actualizar_picking( lp_vbeln = lv_vbeln lp_numtransporte = lp_numtransporte ).
            ENDLOOP.

            " Para grabar el log.
            CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
              EXPORTING
                wait = 'X'.

          CATCH /iwbep/cx_mgw_busi_exception .
            lv_error = 'X'.
            APPEND INITIAL LINE TO lt_return ASSIGNING <fs_return>.
            <fs_return>-type = 'E'.
            <fs_return>-message = 'Error al realizar el picking en la entrega'.
            <fs_return>-message_v1 = lv_vbeln.
        ENDTRY.
      ENDIF.

      IF lv_error IS NOT INITIAL.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_creacion_es_traslado.
        lv_datos_log-estado = gc_estado_log_nook.
        lv_datos_log-mensaje = 'Ver errores'.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        " Para grabar el log.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

        LOOP AT lt_return ASSIGNING <fs_return>.
          MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
          lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
          lv_datos_log_msg-paso = lv_datos_log-paso.
          lv_datos_log_msg-posicion = lv_datos_log-posicion.
          lv_datos_log_msg-msgno = <fs_return>-number.

          trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
        ENDLOOP.

        " Devolvemos excepción para no continuar.
        RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
      ELSE.
        LOOP AT lt_deliveries ASSIGNING <fs_delivery>.
          lv_datos_log-numtransporte = lp_numtransporte.
          lv_datos_log-paso = gc_paso_creacion_es_traslado .
          lv_datos_log-estado = gc_estado_log_ok.
          lv_datos_log-mensaje = 'Entrega salida traslado creada.'.
          lv_datos_log-vbeln_vl = <fs_delivery>-deliv_numb.
          trans_log_create( CHANGING wp_trans_log = lv_datos_log ).
        ENDLOOP.

        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

      ENDIF.

    ENDLOOP.




  ENDMETHOD.
  METHOD creacion_pedido_traslado.
    TYPES: BEGIN OF st_datos,
             matnr TYPE matnr_d,
             vbeln TYPE vbeln_va,
             posnr TYPE posnr_va,
             menge TYPE menge_d,
             meins TYPE meins,
             charg TYPE charg_d,
           END OF st_datos.

    DATA: lt_datos TYPE TABLE OF st_datos.

    DATA: lv_datos_log     TYPE zst_sdle_transp_log,
          lv_datos_log_msg TYPE zst_sdle_transp_log_msg.

    DATA: ls_poheader   TYPE bapimepoheader,
          ls_poheaderx  TYPE bapimepoheaderx,
          lt_poitem     TYPE TABLE OF bapimepoitem,
          lt_poitemx    TYPE TABLE OF bapimepoitemx,
          lt_poaccount  TYPE TABLE OF bapimepoaccount,
          lt_poaccountx TYPE TABLE OF bapimepoaccountx,
          lv_po_item    TYPE bapimepoitem-po_item,
          lt_return     TYPE TABLE OF bapiret2,
          lv_ponumber   TYPE bapimepoheader-po_number.

    DATA(ls_trans_cab) = trans_cab_getdetail( lp_numtransporte ).

    "
    " Confirmar si el paso ya se ha ejecutado.
    "
    DATA(lt_log) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_creacion_pedido_tras  lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log) = lines( lt_log ).
    IF lv_lines_log IS NOT INITIAL.
      RETURN.
    ENDIF.

    IF ls_trans_cab-destino = 1.
      lv_datos_log-numtransporte = lp_numtransporte.
      lv_datos_log-paso = gc_paso_creacion_pedido_tras.
      lv_datos_log-estado = gc_estado_log_ok.
      lv_datos_log-mensaje = 'Destino cliente. Paso no necesario. '.
      trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          wait = 'X'.
      RETURN.
    ENDIF.

    "
    " recupero información de los movimientos de entrada de producto final.
    "
    DATA(lt_log_notificacion) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_notificar_entrada_pt  lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_notificacion) = lines( lt_log_notificacion ).
***    IF lv_lines_notificacion IS INITIAL.
***      RETURN.
***    ENDIF.


    DATA: lr_mblnr TYPE RANGE OF mseg-mblnr,
          lv_mjahr TYPE mseg-mjahr.

    LOOP AT lt_log_notificacion ASSIGNING FIELD-SYMBOL(<fs_log_not>).

      lv_mjahr = <fs_log_not>-mjahr. "Entiendo que todo está en el mismo ejercicio

      APPEND INITIAL LINE TO lr_mblnr ASSIGNING FIELD-SYMBOL(<fs_mblnr>).
      <fs_mblnr>-sign = 'I'.
      <fs_mblnr>-option = 'EQ'.
      <fs_mblnr>-low = <fs_log_not>-mblnr.
    ENDLOOP.

    "
    " Recuperamos las posiciones
    "
    DATA(lt_posiciones) = trans_pos_getlist( lp_numtransporte ).

    CLEAR lt_datos.
    LOOP AT lt_posiciones ASSIGNING FIELD-SYMBOL(<fs_pos>).
      APPEND INITIAL LINE TO lt_datos ASSIGNING FIELD-SYMBOL(<fs_dato>).
      <fs_dato>-matnr = <fs_pos>-matnr_final.
      <fs_dato>-menge = <fs_pos>-kwmeng_real.
      <fs_dato>-meins = <fs_pos>-vrkme.
      <fs_dato>-vbeln = <fs_pos>-vbeln.
      <fs_dato>-posnr = <fs_pos>-posnr.
      <fs_dato>-charg = <fs_pos>-charg.
    ENDLOOP.

    SORT lt_datos BY matnr vbeln posnr charg.

    CLEAR: ls_poheader, ls_poheaderx, lv_ponumber.
    CLEAR: lt_return, lt_poitem, lt_poitemx.
    CLEAR: lt_poaccount, lt_poaccountx.

    CLEAR lv_po_item.

    LOOP AT lt_datos ASSIGNING <fs_dato>.
      AT NEW charg.
        ADD 10 TO lv_po_item.
        APPEND INITIAL LINE TO lt_poitem ASSIGNING FIELD-SYMBOL(<fs_poitem>).
        <fs_poitem>-po_item = lv_po_item.
        <fs_poitem>-material = <fs_dato>-matnr.
        <fs_poitem>-plant = '2000'.
        <fs_poitem>-stge_loc = '1400'.
        <fs_poitem>-suppl_stloc = 'P001'.
        <fs_poitem>-quantity = <fs_dato>-menge.
        <fs_poitem>-po_unit = <fs_dato>-meins.
        <fs_poitem>-conf_ctrl = '0004'.

        IF <fs_dato>-posnr IS NOT INITIAL.
          <fs_poitem>-acctasscat = 'M'.

          APPEND INITIAL LINE TO lt_poaccount ASSIGNING FIELD-SYMBOL(<fs_poaccount>).
          <fs_poaccount>-po_item = lv_po_item.
          <fs_poaccount>-serial_no = '01'.

          <fs_poaccount>-sd_doc = <fs_dato>-vbeln.
          <fs_poaccount>-itm_number = <fs_dato>-posnr.
          <fs_poaccount>-gl_account = '0006000100'. "'0003500010'. " La tomo del pedido 45002165 --> 0003500010 antes 0006000000
*          <fs_poaccount>-co_area = '1000'.
*          <fs_poaccount>-bus_area = 'HIXA'.
*          <fs_poaccount>-PROFIT_CTR = '0000020001'.

          APPEND INITIAL LINE TO lt_poaccountx ASSIGNING FIELD-SYMBOL(<fs_poaccountx>).
          <fs_poaccountx>-po_item = lv_po_item.
          <fs_poaccountx>-serial_no = '01'.

          <fs_poaccountx>-sd_doc = 'X'.
          <fs_poaccountx>-itm_number = 'X'.
          <fs_poaccountx>-gl_account = 'X'.
*          <fs_poaccountx>-co_area = 'X'.
*          <fs_poaccountx>-bus_area = 'X'.
*          <fs_poaccountx>-PROFIT_CTR = 'X'.
        ENDIF.

        IF <fs_dato>-charg IS INITIAL.
          SELECT SINGLE charg
            INTO <fs_poitem>-batch
            FROM mseg
            WHERE mblnr IN lr_mblnr AND
                  mjahr = lv_mjahr AND
                  bwart = '101' AND
                  kdauf = <fs_dato>-vbeln AND
                  kdpos = <fs_dato>-posnr.
          IF sy-subrc <> 0.
            CLEAR <fs_poitem>-batch.
          ENDIF.
        ELSE.
          <fs_poitem>-batch = <fs_dato>-charg.
        ENDIF.

        APPEND INITIAL LINE TO lt_poitemx ASSIGNING FIELD-SYMBOL(<fs_poitemx>).
        <fs_poitemx>-po_item = lv_po_item.
        <fs_poitemx>-material = 'X'.
        <fs_poitemx>-plant = 'X'.
        <fs_poitemx>-stge_loc = 'X'.
        <fs_poitemx>-suppl_stloc = 'X'.
        <fs_poitemx>-quantity = 'X'.
        <fs_poitemx>-po_unit = 'X'.
        <fs_poitemx>-conf_ctrl = 'X'.
        <fs_poitemx>-batch = 'X'.
        IF <fs_dato>-posnr IS NOT INITIAL.
          <fs_poitemx>-acctasscat = 'X'.
        ENDIF.

      ENDAT.
    ENDLOOP.

    ls_poheader-doc_type = 'ZPT4'.
    ls_poheader-suppl_plnt = '2000'.
    ls_poheader-doc_date = sy-datum.

    ls_poheader-purch_org = '1000'.
    ls_poheader-pur_group = '205'.
    ls_poheader-comp_code = '2000'.


    ls_poheaderx-doc_type = 'X'.
    ls_poheaderx-doc_date = 'X'.
    ls_poheaderx-suppl_plnt = 'X'.
    ls_poheaderx-pur_group = 'X'.
    ls_poheaderx-purch_org = 'X'.
    ls_poheaderx-comp_code = 'X'.

    CALL FUNCTION 'BAPI_PO_CREATE1'
      EXPORTING
        poheader         = ls_poheader
        poheaderx        = ls_poheaderx
*       POADDRVENDOR     =
*       TESTRUN          =
*       MEMORY_UNCOMPLETE            =
*       MEMORY_COMPLETE  =
*       POEXPIMPHEADER   =
*       POEXPIMPHEADERX  =
*       VERSIONS         =
*       NO_MESSAGING     =
*       NO_MESSAGE_REQ   =
*       NO_AUTHORITY     =
*       NO_PRICE_FROM_PO =
*       PARK_COMPLETE    =
*       PARK_UNCOMPLETE  =
      IMPORTING
        exppurchaseorder = lv_ponumber
*       EXPHEADER        =
*       EXPPOEXPIMPHEADER            =
      TABLES
        return           = lt_return
        poitem           = lt_poitem
        poitemx          = lt_poitemx
*       POADDRDELIVERY   =
*       POSCHEDULE       =
*       POSCHEDULEX      =
        poaccount        = lt_poaccount
*       POACCOUNTPROFITSEGMENT       =
        poaccountx       = lt_poaccountx
*       POCONDHEADER     =
*       POCONDHEADERX    =
*       POCOND           =
*       POCONDX          =
*       POLIMITS         =
*       POCONTRACTLIMITS =
*       POSERVICES       =
*       POSRVACCESSVALUES            =
*       POSERVICESTEXT   =
*       EXTENSIONIN      =
*       EXTENSIONOUT     =
*       POEXPIMPITEM     =
*       POEXPIMPITEMX    =
*       POTEXTHEADER     =
*       POTEXTITEM       =
*       ALLVERSIONS      =
*       POPARTNER        =
*       POCOMPONENTS     =
*       POCOMPONENTSX    =
*       POSHIPPING       =
*       POSHIPPINGX      =
*       POSHIPPINGEXP    =
*       SERIALNUMBER     =
*       SERIALNUMBERX    =
*       INVPLANHEADER    =
*       INVPLANHEADERX   =
*       INVPLANITEM      =
*       INVPLANITEMX     =
      .


    DATA lv_error TYPE xflag.
    CLEAR lv_error.

    LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<fs_return>).
      IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
        lv_error = 'X'.
        EXIT.
      ENDIF.

    ENDLOOP.

    IF lv_error IS NOT INITIAL.
      lv_datos_log-numtransporte = lp_numtransporte.
      lv_datos_log-paso = gc_paso_creacion_pedido_tras.
      lv_datos_log-estado = gc_estado_log_nook.
      lv_datos_log-mensaje = 'Ver errores'.
      trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

      " Para grabar el log.
      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          wait = 'X'.

      LOOP AT lt_return ASSIGNING <fs_return>.
        MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
        lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
        lv_datos_log_msg-paso = lv_datos_log-paso.
        lv_datos_log_msg-posicion = lv_datos_log-posicion.
        lv_datos_log_msg-msgno = <fs_return>-number.

        trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
      ENDLOOP.

      " Devolvemos excepción para no continuar.
      RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
    ELSE.
      lv_datos_log-numtransporte = lp_numtransporte.
      lv_datos_log-paso = gc_paso_creacion_pedido_tras.
      lv_datos_log-estado = gc_estado_log_ok.
      lv_datos_log-mensaje = 'Pedido de traslado creado'.
      lv_datos_log-ebeln = lv_ponumber.
      trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          wait = 'X'.

    ENDIF.

  ENDMETHOD.
  METHOD creacion_pedidos_venta.
    TYPES: BEGIN OF st_datos,
             kunag       TYPE kunag,
             kunwe       TYPE kunwe,
             vdatu       TYPE edatu_vbak,
             bstkd       TYPE bstkd,
             bstdk       TYPE bstdk,
             ebeln       TYPE ebeln,
             ebelp       TYPE ebelp,
             matnr_final TYPE matnr_d,
             charg       TYPE charg_d,
             kwmeng_real TYPE zed_kwmeng_real,
             vrkme       TYPE vrkme,
           END OF st_datos.

    DATA: lt_datos TYPE TABLE OF st_datos.

    DATA: lv_datos_log     TYPE zst_sdle_transp_log,
          lv_datos_log_msg TYPE zst_sdle_transp_log_msg.

    DATA: ls_order_header_in     TYPE bapisdhd1,
          ls_order_header_inx    TYPE bapisdhd1x,
          lv_salesdocument       TYPE bapivbeln-vbeln,
          lt_return              TYPE TABLE OF bapiret2,
          lt_order_items_in      TYPE TABLE OF bapisditm,
          lt_order_items_inx     TYPE TABLE OF bapisditmx,
          lt_order_partners      TYPE TABLE OF bapiparnr,
          lt_order_schedules_in  TYPE TABLE OF bapischdl,
          lt_order_schedules_inx TYPE TABLE OF bapischdlx,
          lv_item_number         TYPE posnr_va.

    DATA(ls_trans_cab) = trans_cab_getdetail( lp_numtransporte ).

    "
    " Confirmar si el paso ya se ha ejecutado.
    "
    DATA(lt_log) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_creacion_pedidos_vta  lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log) = lines( lt_log ).
    IF lv_lines_log IS NOT INITIAL.
      RETURN.
    ENDIF.

    IF ls_trans_cab-destino = 2.
      lv_datos_log-numtransporte = lp_numtransporte.
      lv_datos_log-paso = gc_paso_creacion_pedidos_vta.
      lv_datos_log-estado = gc_estado_log_ok.
      lv_datos_log-mensaje = 'Destino Xàtiva. Paso no necesario. '.
      trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          wait = 'X'.
      RETURN.
    ENDIF.


    "
    " Recuperamos las posiciones
    "
    DATA(lt_posiciones) = trans_pos_getlist( lp_numtransporte ).

    CLEAR lt_datos.
    LOOP AT lt_posiciones ASSIGNING FIELD-SYMBOL(<fs_pos>).
      CHECK <fs_pos>-bstkd IS NOT INITIAL.
      CHECK <fs_pos>-vbeln IS INITIAL.
      APPEND INITIAL LINE TO lt_datos ASSIGNING FIELD-SYMBOL(<fs_dato>).
      MOVE-CORRESPONDING <fs_pos> TO <fs_dato>.
    ENDLOOP.

    SORT lt_datos BY kunag kunwe vdatu bstkd bstdk ebeln ebelp matnr_final charg.


    LOOP AT lt_datos ASSIGNING <fs_dato>.
      AT NEW bstkd.

        CLEAR: ls_order_header_in,
          ls_order_header_inx,
              lv_salesdocument,
              lt_return,
              lt_order_items_in,
              lt_order_items_inx,
              lt_order_partners,
              lt_order_schedules_in,
              lt_order_schedules_inx,
              lv_item_number.

        ls_order_header_in-doc_type = 'ZTA3'.
        ls_order_header_in-sales_org = '2000'.
        ls_order_header_in-distr_chan = '10'.
        ls_order_header_in-division = '10'.
        ls_order_header_in-purch_no_c = <fs_dato>-bstkd.
        ls_order_header_in-doc_date = sy-datum.
        ls_order_header_in-req_date_h = <fs_dato>-vdatu.

        ls_order_header_inx-updateflag = 'I'.
        ls_order_header_inx-doc_type = 'X'.
        ls_order_header_inx-sales_org = 'X'.
        ls_order_header_inx-distr_chan = 'X'.
        ls_order_header_inx-division = 'X'.
        ls_order_header_inx-purch_no_c = 'X'.
        ls_order_header_inx-doc_date = 'X'.
        ls_order_header_inx-req_date_h = 'X'.

        APPEND INITIAL LINE TO lt_order_partners ASSIGNING FIELD-SYMBOL(<fs_partner>).
        <fs_partner>-partn_role = 'AG'. "Solicitante
        <fs_partner>-partn_numb = <fs_dato>-kunag.
        APPEND INITIAL LINE TO lt_order_partners ASSIGNING <fs_partner>.
        <fs_partner>-partn_role = 'WE'. "Destinatario
        <fs_partner>-partn_numb = <fs_dato>-kunwe.
      ENDAT.

      AT NEW charg.
        ADD 10 TO lv_item_number.

        APPEND INITIAL LINE TO lt_order_items_in ASSIGNING FIELD-SYMBOL(<fs_item>).
        <fs_item>-itm_number = lv_item_number.
        <fs_item>-material = <fs_dato>-matnr_final.
        <fs_item>-batch = <fs_dato>-charg.
        <fs_item>-plant = '2000'.
        <fs_item>-store_loc = 'P001'.
        <fs_item>-ship_point = 'P001'.
        <fs_item>-target_qty = <fs_dato>-kwmeng_real.
        <fs_item>-target_qu = <fs_dato>-vrkme.

        APPEND INITIAL LINE TO lt_order_items_inx ASSIGNING FIELD-SYMBOL(<fs_itemx>).
        <fs_itemx>-itm_number = lv_item_number.
        <fs_itemx>-updateflag = 'I'.
        <fs_itemx>-material = 'X'.
        <fs_itemx>-batch = 'X'.
        <fs_itemx>-plant = 'X'.
        <fs_itemx>-store_loc = 'X'.
        <fs_itemx>-ship_point = 'X'.
        <fs_itemx>-target_qty = 'X'.
        <fs_itemx>-target_qu = 'X'.

        APPEND INITIAL LINE TO lt_order_schedules_in ASSIGNING FIELD-SYMBOL(<fs_sched>).
        <fs_sched>-itm_number = lv_item_number.
        <fs_sched>-req_qty = <fs_dato>-kwmeng_real.

        APPEND INITIAL LINE TO lt_order_schedules_inx ASSIGNING FIELD-SYMBOL(<fs_schedx>).
        <fs_schedx>-updateflag = 'I'.
        <fs_schedx>-itm_number = lv_item_number.
        <fs_schedx>-req_qty = <fs_dato>-kwmeng_real.
      ENDAT.

      AT END OF bstkd.

        "
        " Creamos el pedido.
        "
        CALL FUNCTION 'BAPI_SALESORDER_CREATEFROMDAT2'
          EXPORTING
*           SALESDOCUMENTIN     =
            order_header_in     = ls_order_header_in
            order_header_inx    = ls_order_header_inx
*           SENDER              =
*           BINARY_RELATIONSHIPTYPE       =
*           INT_NUMBER_ASSIGNMENT         =
*           BEHAVE_WHEN_ERROR   =
*           LOGIC_SWITCH        =
*           TESTRUN             =
*           CONVERT             = ' '
          IMPORTING
            salesdocument       = lv_salesdocument
          TABLES
            return              = lt_return
            order_items_in      = lt_order_items_in
            order_items_inx     = lt_order_items_inx
            order_partners      = lt_order_partners
            order_schedules_in  = lt_order_schedules_in
            order_schedules_inx = lt_order_schedules_inx.


        DATA lv_error TYPE xflag.
        CLEAR lv_error.

        LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<fs_return>).
          IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
            lv_error = 'X'.
            EXIT.
          ENDIF.

        ENDLOOP.

        IF lv_error IS NOT INITIAL.
          lv_datos_log-numtransporte = lp_numtransporte.
          lv_datos_log-paso = gc_paso_creacion_pedidos_vta.
          lv_datos_log-estado = gc_estado_log_nook.
          lv_datos_log-mensaje = 'Ver errores'.
          trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

          " Para grabar el log.
          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
            EXPORTING
              wait = 'X'.

          LOOP AT lt_return ASSIGNING <fs_return>.
            MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
            lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
            lv_datos_log_msg-paso = lv_datos_log-paso.
            lv_datos_log_msg-posicion = lv_datos_log-posicion.
            lv_datos_log_msg-msgno = <fs_return>-number.

            trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
          ENDLOOP.

          " Devolvemos excepción para no continuar.
          RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
        ELSE.
          lv_datos_log-numtransporte = lp_numtransporte.
          lv_datos_log-paso = gc_paso_creacion_pedidos_vta.
          lv_datos_log-estado = gc_estado_log_ok.
          lv_datos_log-mensaje = 'Pedido de venta creado'.
          lv_datos_log-vbeln = lv_salesdocument.
          trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
            EXPORTING
              wait = 'X'.

        ENDIF.
      ENDAT.
    ENDLOOP.

  ENDMETHOD.
  METHOD creacion_transporte.
    DATA: lv_datos_log     TYPE zst_sdle_transp_log,
          lv_datos_log_msg TYPE zst_sdle_transp_log_msg.

    DATA: lt_itemdata         TYPE TABLE OF bapishipmentitem,
          ls_itemdata         TYPE bapishipmentitem,
          lt_return           TYPE TABLE OF bapiret2,
          ls_return           TYPE bapiret2,
          ls_headerdata       TYPE bapishipmentheader,
          ls_headerdataaction TYPE bapishipmentheaderaction.

    DATA: lv_transport    TYPE bapishipmentids-shipmentnum,
          lv_shipmentguid TYPE bapishipmentids-guid.

    DATA: lv_error TYPE xflag.

    "
    " Confirmar si el paso ya se ha ejecutado.
    "
    DATA(lt_log) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_creacion_transporte  lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log) = lines( lt_log ).
    IF lv_lines_log IS NOT INITIAL.
      RETURN.
    ENDIF.

    DATA(lt_log_entregas) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_creacion_es_cliente lp_estado = gc_estado_log_ok ).
    LOOP AT lt_log_entregas ASSIGNING FIELD-SYMBOL(<fs_entregas>).
      CHECK <fs_entregas>-vbeln_vl IS NOT INITIAL.
      CLEAR ls_itemdata.
      ls_itemdata-delivery = <fs_entregas>-vbeln_vl.
      APPEND ls_itemdata TO lt_itemdata.
    ENDLOOP.

    CLEAR lt_log_entregas.
    lt_log_entregas = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_creacion_es_traslado lp_estado = gc_estado_log_ok ).
    LOOP AT lt_log_entregas ASSIGNING <fs_entregas>.
      CHECK <fs_entregas>-vbeln_vl IS NOT INITIAL.
      CLEAR ls_itemdata.
      ls_itemdata-delivery = <fs_entregas>-vbeln_vl.
      APPEND ls_itemdata TO lt_itemdata.
    ENDLOOP.

    DATA(ls_trans_cab) = trans_cab_getdetail( lp_numtransporte ).

    "
    " Comprobamos bloqueos de las entregas.
    "
    LOOP AT lt_itemdata INTO ls_itemdata.
      chk_lock_dlv( ls_itemdata-delivery ).
    ENDLOOP.
    "
    " Creamos transporte.
    "
    CLEAR: ls_headerdata, lv_transport, lv_shipmentguid.
    FREE  lt_return.
    CLEAR: lv_error.

    ls_headerdata-shipment_type     = 'Z006'.
    ls_headerdata-trans_plan_pt     = 'P001'.
    ls_headerdata-container_id      = ls_trans_cab-zzmatricula.
    ls_headerdata-description       = ls_trans_cab-zzremolque.
*    ls_headerdata-status_plan = 'X'.
*    ls_headerdata-status_checkin = 'X'.
*    ls_headerdata-status_load_start = 'X'.
*    ls_headerdata-status_load_end = 'X'.
*    ls_headerdata-status_compl = 'X'.


    CALL FUNCTION 'BAPI_SHIPMENT_CREATE'
      EXPORTING
        headerdata   = ls_headerdata
      IMPORTING
        transport    = lv_transport
        shipmentguid = lv_shipmentguid
      TABLES
        itemdata     = lt_itemdata
        return       = lt_return.

    LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<fs_return>).
      IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
        lv_error = 'X'.
        EXIT.
      ENDIF.

    ENDLOOP.

    IF lv_error IS NOT INITIAL.
      lv_datos_log-numtransporte = lp_numtransporte.
      lv_datos_log-paso = gc_paso_creacion_transporte.
      lv_datos_log-estado = gc_estado_log_nook.
      lv_datos_log-mensaje = 'Ver errores'.
      trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

      " Para grabar el log.
      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          wait = 'X'.

      LOOP AT lt_return ASSIGNING <fs_return>.
        MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
        lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
        lv_datos_log_msg-paso = lv_datos_log-paso.
        lv_datos_log_msg-posicion = lv_datos_log-posicion.
        lv_datos_log_msg-msgno = <fs_return>-number.

        trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
      ENDLOOP.

      " Devolvemos excepción para no continuar.
      RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
    ELSE.
*      lv_datos_log-numtransporte = lp_numtransporte.
*      lv_datos_log-paso = gc_paso_creacion_transporte.
*      lv_datos_log-estado = gc_estado_log_ok.
*      lv_datos_log-mensaje = 'Transporte creado'.
*      lv_datos_log-tknum = lv_transport.
*      trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          wait = 'X'.

      "
      " BAPI_SHIPMENT_CREATE. No permite actualizar los campos Z.
      "
      UPDATE vttk
      SET zzconductor = ls_trans_cab-zzconductor
          zzdni = ls_trans_cab-zzdni
          zzmatricula = ls_trans_cab-zzmatricula
          zzremolque = ls_trans_cab-zzremolque
          text1 = ls_trans_cab-zztelefono
      WHERE tknum = lv_transport.

      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          wait = 'X'.

      "
      " Lanzamos actualización para finalizar transporte.
      "
      CLEAR lt_return.
      CLEAR: ls_headerdata, ls_headerdataaction.
      ls_headerdata-shipment_num = lv_transport.
      ls_headerdata-status_plan = 'X'.
      ls_headerdata-status_checkin = 'X'.
      ls_headerdata-status_load_start = 'X'.
      ls_headerdata-status_load_end = 'X'.
      ls_headerdata-status_compl = 'X'.

*      ls_headerdataaction-shipment_num = 'C'.
      ls_headerdataaction-status_plan = 'C'.
      ls_headerdataaction-status_checkin = 'C'.
      ls_headerdataaction-status_load_start = 'C'.
      ls_headerdataaction-status_load_end = 'C'.
      ls_headerdataaction-status_compl = 'C'.

      CALL FUNCTION 'BAPI_SHIPMENT_CHANGE'
        EXPORTING
          headerdata       = ls_headerdata
          headerdataaction = ls_headerdataaction
        TABLES
*         itemdata         = tl_itemdata
*         itemdataaction   = tl_itemdataaction
          return           = lt_return.

      LOOP AT lt_return INTO ls_return WHERE type <> 'S' AND type <> 'I' AND type <> 'W'.
        lv_error = 'X'.
      ENDLOOP.

      IF lv_error IS NOT INITIAL.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_creacion_transporte.
        lv_datos_log-estado = gc_estado_log_nook.
        lv_datos_log-mensaje = 'Ver errores'.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

        " Para grabar el log.
        CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
          EXPORTING
            wait = 'X'.

        LOOP AT lt_return ASSIGNING <fs_return>.
          MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
          lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
          lv_datos_log_msg-paso = lv_datos_log-paso.
          lv_datos_log_msg-posicion = lv_datos_log-posicion.
          lv_datos_log_msg-msgno = <fs_return>-number.

          trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
        ENDLOOP.

        " Devolvemos excepción para no continuar.
        RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
      ELSE.
        lv_datos_log-numtransporte = lp_numtransporte.
        lv_datos_log-paso = gc_paso_creacion_transporte.
        lv_datos_log-estado = gc_estado_log_ok.
        lv_datos_log-mensaje = 'Transporte creado'.
        lv_datos_log-tknum = lv_transport.
        trans_log_create( CHANGING wp_trans_log = lv_datos_log ).
      ENDIF.
    ENDIF.






***    DATA: lv_fecha_reparto TYPE vbak-vdatu,
***          lv_delivery      TYPE bapishpdelivnumb-deliv_numb,
***          lt_sales_order   TYPE TABLE OF bapidlvreftosalesorder,
***          ls_sales_order   LIKE LINE OF lt_sales_order,
***          lt_deliveries        TYPE TABLE OF bapishpdelivnumb,
***          lt_return           TYPE TABLE OF bapiret2.
***
***
***    DATA(lt_posiciones) = trans_pos_getlist( lp_numtransporte ).
***
***    CLEAR lt_datos.
***    LOOP AT lt_posiciones ASSIGNING FIELD-SYMBOL(<fs_pos>).
***      IF <fs_pos>-posnr IS NOT INITIAL.
***        APPEND INITIAL LINE TO lt_datos ASSIGNING FIELD-SYMBOL(<fs_dato>).
***        MOVE-CORRESPONDING <fs_pos> TO <fs_dato>.
***      ENDIF.
***    ENDLOOP.
***
***    SORT lt_datos BY vbeln posnr.
***
***    LOOP AT lt_datos ASSIGNING <fs_dato>.
***      AT NEW vbeln.
***
***      ENDAT.
***
***      AT NEW posnr.
***        CLEAR ls_sales_order.
***        " Añadimos los datos de la posición anterior
***        ls_sales_order-ref_doc = <fs_dato>-vbeln.
***        ls_sales_order-ref_item = <fs_dato>-posnr.
***        ls_sales_order-dlv_qty = <fs_dato>-kwmeng.
***        ls_sales_order-sales_unit = <fs_dato>-vrkme.
***        APPEND ls_sales_order TO lt_sales_order.
***      ENDAT.
***
***      AT END OF posnr.
***
***        SELECT SINGLE *
***          FROM vbap
***          INTO @DATA(ls_vbap)
***          WHERE vbeln = @<fs_dato>-vbeln AND
***                posnr = @<fs_dato>-posnr.
***
***
***        "
***        " Creamos entrega.
***        "
***        CLEAR lt_return.
***        CLEAR lv_delivery.
***        CLEAR lv_fecha_reparto.
***        lv_fecha_reparto = '99991231'.
***
***        CALL FUNCTION 'BAPI_OUTB_DELIVERY_CREATE_SLS'
***          EXPORTING
***            due_date          = lv_fecha_reparto
***          IMPORTING
***            delivery          = lv_delivery
***          TABLES
***            sales_order_items = lt_sales_order
***            deliveries        = lt_deliveries
***            return            = lt_return.
***
***        DATA lv_error TYPE xflag.
***        CLEAR lv_error.
***
***        LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<fs_return>).
***          IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
***            lv_error = 'X'.
***            EXIT.
***          ENDIF.
***
***        ENDLOOP.
***
***        IF lv_error IS NOT INITIAL.
***          lv_datos_log-numtransporte = lp_numtransporte.
***          lv_datos_log-paso = gc_paso_creacion_es_cliente.
***          lv_datos_log-estado = gc_estado_log_nook.
***          lv_datos_log-mensaje = 'Ver errores'.
***          trans_log_create( CHANGING wp_trans_log = lv_datos_log ).
***
***          " Para grabar el log.
***          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
***            EXPORTING
***              wait = 'X'.
***
***          LOOP AT lt_return ASSIGNING <fs_return>.
***            MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
***            lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
***            lv_datos_log_msg-paso = lv_datos_log-paso.
***            lv_datos_log_msg-posicion = lv_datos_log-posicion.
***            lv_datos_log_msg-msgno = <fs_return>-number.
***
***            trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
***          ENDLOOP.
***
***          " Devolvemos excepción para no continuar.
***          RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
***        ELSE.
***          lv_datos_log-numtransporte = lp_numtransporte.
***          lv_datos_log-paso = gc_paso_modificar_vstel_pv.
***          lv_datos_log-estado = gc_estado_log_ok.
***          lv_datos_log-mensaje = 'Entrega creada'.
***          lv_datos_log-vbeln = <fs_dato>-vbeln.
***          lv_datos_log-posnr = <fs_dato>-posnr.
***          lv_datos_log-VBELN_VL = lv_delivery.
***          trans_log_create( CHANGING wp_trans_log = lv_datos_log ).
***
***          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
***            EXPORTING
***              wait = 'X'.
***
***        ENDIF.
***      ENDAT.
***    ENDLOOP.


  ENDMETHOD.
  METHOD entrega_final_pedido.
    DATA: lv_datos_log     TYPE zst_sdle_transp_log,
          lv_datos_log_msg TYPE zst_sdle_transp_log_msg.

    DATA: lt_stock_trans_items TYPE TABLE OF bapidlvreftosto,
          ls_stock_trans_items LIKE LINE OF lt_stock_trans_items,
          lt_deliveries        TYPE TABLE OF bapishpdelivnumb,
          lt_return            TYPE TABLE OF bapiret2,
          lv_fecha_reparto     TYPE vbak-vdatu,
          lv_ship_point        TYPE  bapidlvcreateheader-ship_point.

    DATA(ls_trans_cab) = trans_cab_getdetail( lp_numtransporte ).
    "
    " Confirmar si el paso ya se ha ejecutado.
    "
    DATA(lt_log) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_cierre_pedido  lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log) = lines( lt_log ).
    IF lv_lines_log IS NOT INITIAL.
      RETURN.
    ENDIF.

***    IF ls_trans_cab-elikz IS INITIAL.
***      lv_datos_log-numtransporte = lp_numtransporte.
***      lv_datos_log-paso = gc_paso_cierre_pedido.
***      lv_datos_log-estado = gc_estado_log_ok.
***      lv_datos_log-mensaje = 'No se ha marcado Entrega final. Paso no necesario. '.
***      trans_log_create( CHANGING wp_trans_log = lv_datos_log ).
***
***      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
***        EXPORTING
***          wait = 'X'.
***      RETURN.
***    ENDIF.

    "
    " Recupero posiciones
    "
    DATA lv_error TYPE xflag.
    DATA(lt_posiciones) = trans_pos_getlist( lp_numtransporte ).

    CLEAR lv_error.

    LOOP AT lt_posiciones ASSIGNING FIELD-SYMBOL(<fs_posicion>).
      CHECK lv_error IS INITIAL.
      CHECK <fs_posicion>-elikz IS NOT INITIAL.

      IF <fs_posicion>-ebelp IS NOT INITIAL.
        CLEAR lv_error.

        lt_return = cierre_ekpo( lp_ebeln  = <fs_posicion>-ebeln lp_ebelp  = <fs_posicion>-ebelp ).

        LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<fs_return>).
          IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
            lv_error = 'X'.
            EXIT.
          ENDIF.

        ENDLOOP.

        IF lv_error IS NOT INITIAL.
          CLEAR lv_datos_log.
          lv_datos_log-numtransporte = lp_numtransporte.
          lv_datos_log-paso = gc_paso_cierre_pedido.
          lv_datos_log-estado = gc_estado_log_nook.
          lv_datos_log-mensaje = 'Ver errores'.
          trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

          " Para grabar el log.
          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
            EXPORTING
              wait = 'X'.

          LOOP AT lt_return ASSIGNING <fs_return>.
            CLEAR lv_datos_log.
            MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
            lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
            lv_datos_log_msg-paso = lv_datos_log-paso.
            lv_datos_log_msg-posicion = lv_datos_log-posicion.
            lv_datos_log_msg-msgno = <fs_return>-number.

            trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
          ENDLOOP.

          " Devolvemos excepción para no continuar.
          RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
        ELSE.
          CLEAR lv_datos_log.
          lv_datos_log-numtransporte = lp_numtransporte.
          lv_datos_log-paso = gc_paso_cierre_pedido .
          lv_datos_log-estado = gc_estado_log_ok.
          lv_datos_log-mensaje = 'Marca Entrega Final actualizada.'.
          lv_datos_log-ebeln = <fs_posicion>-ebeln.
          lv_datos_log-posnr = <fs_posicion>-ebelp.
          trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
            EXPORTING
              wait = 'X'.

        ENDIF.
      ENDIF.

      CHECK lv_error IS INITIAL.

      IF ls_trans_cab-destino = 1 and <fs_posicion>-posnr IS NOT INITIAL. " Sólo destino cliente y tengo pedido venta.
        CLEAR lv_error.

        SELECT SINGLE *
          FROM vbup
          INTO @DATA(ls_vbup)
          WHERE vbeln = @<fs_posicion>-vbeln AND
                posnr = @<fs_posicion>-posnr.
        IF sy-subrc = 0 AND ls_vbup-gbsta = 'C'.
            CLEAR lv_datos_log.
            lv_datos_log-numtransporte = lp_numtransporte.
            lv_datos_log-paso = gc_paso_cierre_pedido .
            lv_datos_log-estado = gc_estado_log_ok.
            lv_datos_log-mensaje = 'Posición pedido &1 &2 concluida. Paso no necesario.'.
            REPLACE ALL OCCURRENCES OF '&1' IN lv_datos_log-mensaje WITH <fs_posicion>-vbeln.
            REPLACE ALL OCCURRENCES OF '&2' IN lv_datos_log-mensaje WITH <fs_posicion>-posnr.
*            lv_datos_log-vbeln = <fs_posicion>-vbeln.
*            lv_datos_log-posnr = <fs_posicion>-ebelp.
            trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

            CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
              EXPORTING
                wait = 'X'.
        ELSE.

          lt_return = cierre_vbap( lp_vbeln  = <fs_posicion>-vbeln lp_posnr  = <fs_posicion>-posnr ).

          LOOP AT lt_return ASSIGNING <fs_return>.
            IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
              lv_error = 'X'.
              EXIT.
            ENDIF.

          ENDLOOP.

          IF lv_error IS NOT INITIAL.
            CLEAR lv_datos_log.
            lv_datos_log-numtransporte = lp_numtransporte.
            lv_datos_log-paso = gc_paso_cierre_pedido.
            lv_datos_log-estado = gc_estado_log_nook.
            lv_datos_log-mensaje = 'Ver errores'.
            trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

            " Para grabar el log.
            CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
              EXPORTING
                wait = 'X'.

            LOOP AT lt_return ASSIGNING <fs_return>.
              CLEAR lv_datos_log.
              MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
              lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
              lv_datos_log_msg-paso = lv_datos_log-paso.
              lv_datos_log_msg-posicion = lv_datos_log-posicion.
              lv_datos_log_msg-msgno = <fs_return>-number.

              trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
            ENDLOOP.

            " Devolvemos excepción para no continuar.
            RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
          ELSE.
            CLEAR lv_datos_log.
            lv_datos_log-numtransporte = lp_numtransporte.
            lv_datos_log-paso = gc_paso_cierre_pedido .
            lv_datos_log-estado = gc_estado_log_ok.
            lv_datos_log-mensaje = 'Marca Entrega Final actualizada.'.
            lv_datos_log-vbeln = <fs_posicion>-vbeln.
            lv_datos_log-posnr = <fs_posicion>-posnr.
            trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

            CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
              EXPORTING
                wait = 'X'.

          ENDIF.
        ENDIF.
      ENDIF.


    ENDLOOP.
  ENDMETHOD.
  METHOD modificar_vstel_pv.
    TYPES: BEGIN OF st_datos,
             vbeln TYPE vbeln_va,
             posnr TYPE posnr_va,
           END OF st_datos.

    DATA: lt_datos TYPE TABLE OF st_datos.

    DATA: lv_datos_log     TYPE zst_sdle_transp_log,
          lv_datos_log_msg TYPE zst_sdle_transp_log_msg.

    "
    " Confirmar si el paso ya se ha ejecutado.
    "
    DATA(lt_log) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_modificar_vstel_pv  lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log) = lines( lt_log ).
    IF lv_lines_log IS NOT INITIAL.
      RETURN.
    ENDIF.

    DATA(ls_trans_cab) = trans_cab_getdetail( lp_numtransporte ).
    IF ls_trans_cab-destino = 1.
      lv_datos_log-numtransporte = lp_numtransporte.
      lv_datos_log-paso = gc_paso_modificar_vstel_pv.
      lv_datos_log-estado = gc_estado_log_ok.
      lv_datos_log-mensaje = 'Destino cliente. Paso no necesario. '.
      trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
        EXPORTING
          wait = 'X'.
      RETURN.
    ENDIF.

    DATA(lt_posiciones) = trans_pos_getlist( lp_numtransporte ).

    CLEAR lt_datos.
    LOOP AT lt_posiciones ASSIGNING FIELD-SYMBOL(<fs_pos>).
      IF <fs_pos>-posnr IS NOT INITIAL.
        APPEND INITIAL LINE TO lt_datos ASSIGNING FIELD-SYMBOL(<fs_dato>).
        MOVE-CORRESPONDING <fs_pos> TO <fs_dato>.
      ENDIF.
    ENDLOOP.

    SORT lt_datos BY vbeln posnr.

    DATA: lv_salesdocument    TYPE bapivbeln-vbeln,
          lt_return           TYPE TABLE OF bapiret2,
          lt_order_item_in    TYPE TABLE OF bapisditm,
          lt_order_item_inx   TYPE TABLE OF bapisditmx,
          ls_order_header_inx TYPE bapisdh1x.

    LOOP AT lt_datos ASSIGNING <fs_dato>.
      AT NEW vbeln.
        lv_salesdocument = <fs_dato>-vbeln.

        ls_order_header_inx-updateflag = 'U'.
      ENDAT.

      AT NEW posnr.
        CLEAR: lt_order_item_in,
              lt_order_item_inx.

        APPEND INITIAL LINE TO lt_order_item_in ASSIGNING FIELD-SYMBOL(<fs_item>).
        <fs_item>-itm_number = <fs_dato>-posnr.
        <fs_item>-ship_point = '2000'.

        APPEND INITIAL LINE TO lt_order_item_inx ASSIGNING FIELD-SYMBOL(<fs_itemx>).
        <fs_itemx>-itm_number = <fs_dato>-posnr.
        <fs_itemx>-updateflag = 'U'.
        <fs_itemx>-ship_point = 'X'.
      ENDAT.

      AT END OF posnr.

        SELECT SINGLE *
          FROM vbap
          INTO @DATA(ls_vbap)
          WHERE vbeln = @<fs_dato>-vbeln AND
                posnr = @<fs_dato>-posnr.

        IF ls_vbap-vstel <> '2000'.

          CLEAR lt_return.

          CALL FUNCTION 'BAPI_SALESORDER_CHANGE'
            EXPORTING
              salesdocument    = lv_salesdocument
              order_header_inx = ls_order_header_inx
            TABLES
              return           = lt_return
              order_item_in    = lt_order_item_in
              order_item_inx   = lt_order_item_inx.

          DATA lv_error TYPE xflag.
          CLEAR lv_error.

          LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<fs_return>).
            IF <fs_return>-type = 'E' OR <fs_return>-type = 'A'.
              lv_error = 'X'.
              EXIT.
            ENDIF.

          ENDLOOP.

          IF lv_error IS NOT INITIAL.
            lv_datos_log-numtransporte = lp_numtransporte.
            lv_datos_log-paso = gc_paso_modificar_vstel_pv.
            lv_datos_log-estado = gc_estado_log_nook.
            lv_datos_log-mensaje = 'Ver errores'.
            trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

            " Para grabar el log.
            CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
              EXPORTING
                wait = 'X'.

            LOOP AT lt_return ASSIGNING <fs_return>.
              MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
              lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
              lv_datos_log_msg-paso = lv_datos_log-paso.
              lv_datos_log_msg-posicion = lv_datos_log-posicion.
              lv_datos_log_msg-msgno = <fs_return>-number.

              trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
            ENDLOOP.

            " Devolvemos excepción para no continuar.
            RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
          ELSE.
            lv_datos_log-numtransporte = lp_numtransporte.
            lv_datos_log-paso = gc_paso_modificar_vstel_pv.
            lv_datos_log-estado = gc_estado_log_ok.
            lv_datos_log-mensaje = 'Posición pedido cambiada'.
            lv_datos_log-vbeln = <fs_dato>-vbeln.
            lv_datos_log-posnr = <fs_dato>-posnr.
            trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

            CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
              EXPORTING
                wait = 'X'.

          ENDIF.
        ELSE.
          lv_datos_log-numtransporte = lp_numtransporte.
          lv_datos_log-paso = gc_paso_modificar_vstel_pv.
          lv_datos_log-estado = gc_estado_log_ok.
          lv_datos_log-mensaje = 'Posición pedido ya tiene el puesto de expedición correcto.'.
          lv_datos_log-vbeln = <fs_dato>-vbeln.
          lv_datos_log-posnr = <fs_dato>-posnr.
          trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
            EXPORTING
              wait = 'X'.
        ENDIF.
      ENDAT.
    ENDLOOP.


  ENDMETHOD.
  METHOD monitor_getlist.
    DATA:
*          lv_werks  TYPE werks_d VALUE '2000',
*          lv_lifnr  TYPE lifnr VALUE '0000100944',
*          lv_lgort  TYPE lgort_d VALUE 'P001',
      lv_lgort2 TYPE lgort_d VALUE '1400',
      lv_mtart  TYPE mara-mtart VALUE 'ZPSE'.

    SELECT *
      FROM dd07t
      INTO TABLE @DATA(tl_dd07t)
      WHERE domname = 'ZDC_PROCESO_SUBCO' AND
            ddlanguage = 'S'.

    DATA: ls_dato_monitor LIKE LINE OF tp_monitor.

    SELECT SINGLE *
      FROM t001w
      INTO @DATA(ls_t001w)
      WHERE werks = @vp_werks.

    CLEAR tp_monitor.
    "
    " Centro es el 2000. TODO: Ver si lo ponemos en parametros o se le pasa al método.
    "

    " Sacamos el stock del centro 2000 y almacén P001.
    " Esto serian los PT
    " TODO. Ver si lo ponemos en parámetros.
    " Esto serían picos sin estar asignados a pedidos de venta.

    "
    " Sacamos el stock de subcontratista. Tabla MSLB.
    " Para el proveedor 100944.
    " TODO: Ver si lo ponemos en parámetros.
    "
    SELECT *
      FROM mslb
      INNER JOIN mara ON mara~matnr = mslb~matnr
      INTO TABLE @DATA(lt_mslb)
      WHERE mslb~werks = @vp_werks AND
            mslb~lifnr = @vp_lifnr AND
            mslb~lblab <> 0 AND
            mara~mtart = @lv_mtart.
*    LOOP AT lt_mslb ASSIGNING FIELD-SYMBOL(<fs_mslb>).
*
*
**      APPEND INITIAL LINE TO tp_monitor ASSIGNING FIELD-SYMBOL(<fs_dato_monitor>).
*      CLEAR ls_dato_monitor.
*      ls_dato_monitor-proceso = 'SC'.
*      ls_dato_monitor-matnr_se = <fs_mslb>-mara-matnr.
**      ls_dato_monitor-charg = <fs_mslb>-mslb-charg.
*
*      "
*      " Buscamos la entrada de mercancía del material - lote.
*      "
*      SELECT *
*        FROM mseg
*        INTO TABLE @DATA(lt_mseg)
*        WHERE matnr = @<fs_mslb>-mslb-matnr AND
*              werks = @vp_werks AND
*              lgort = @lv_lgort2 AND
*              charg = @<fs_mslb>-mslb-charg AND
*              lifnr = @<fs_mslb>-mslb-lifnr AND
*              bwart = '541'. "AND
**              ebeln <> '0000000000'.
*      " Quito los anulados.
*      LOOP AT lt_mseg ASSIGNING FIELD-SYMBOL(<fs_mseg>).
*        SELECT SINGLE *
*          FROM mseg
*          INTO @DATA(ls_mseg_anulacion)
*          WHERE smbln = @<fs_mseg>-mblnr AND
*                sjahr = @<fs_mseg>-mjahr AND
*                smblp = @<fs_mseg>-zeile.
*        IF sy-subrc = 0.
*          DELETE lt_mseg.
*        ENDIF.
*      ENDLOOP.
*      READ TABLE lt_mseg INTO DATA(ls_mseg) INDEX 1.
*      IF sy-subrc = 0.
*        SELECT SINGLE *
*          FROM resb
*          INTO @DATA(ls_resb)
*          WHERE ebeln = @ls_mseg-ebeln AND
*                ebelp = @ls_mseg-ebelp AND
*                matnr = @ls_dato_monitor-matnr_se.
*      ENDIF.
*      IF sy-subrc = 0.
*        SELECT SINGLE *
*          FROM ekpo
*          INTO @DATA(ls_ekpo)
*          WHERE ebeln = @ls_mseg-ebeln AND
*                ebelp = @ls_mseg-ebelp.
*      ENDIF.
*      IF sy-subrc = 0.
*        SELECT SINGLE *
*          FROM eket
*          INTO @DATA(ls_eket)
*          WHERE ebeln = @ls_mseg-ebeln AND
*                ebelp = @ls_mseg-ebelp.
*
*      ENDIF.
*      IF sy-subrc = 0.
*        ls_dato_monitor-charg = ls_eket-charg.
*      ENDIF.
*
*      SELECT MIN( eindt )
*        FROM eket
*        INTO ls_dato_monitor-fecha_ent_servicio
*        WHERE ebeln = ls_mseg-ebeln AND
*              ebelp = ls_mseg-ebelp.
*
*      "
*      " Compruebo que el pedido no se ha procesado ya por otras vías. Tiene el 101.
*      "
*      " No lo hacemos, se hacen tratamientos parciales. Visto con Andrea.
****      SELECT *
****        FROM mseg
****        INTO TABLE @DATA(lt_mseg_101)
****        WHERE ebeln = @ls_mseg-ebeln AND
****              ebelp = @ls_mseg-ebelp AND
****              bwart = '101'.
****      " Quito los anulados.
****      LOOP AT lt_mseg_101 ASSIGNING <fs_mseg>.
****        SELECT SINGLE *
****          FROM mseg
****          INTO ls_mseg_anulacion
****          WHERE smbln = <fs_mseg>-mblnr AND
****                sjahr = <fs_mseg>-mjahr AND
****                smblp = <fs_mseg>-zeile.
****        IF sy-subrc = 0.
****          DELETE lt_mseg_101.
****        ENDIF.
****      ENDLOOP.
****      READ TABLE lt_mseg_101 INTO DATA(ls_mseg_101) INDEX 1.
****      IF sy-subrc = 0.
****        CONTINUE.
****      ENDIF.
*
*
*      SELECT SINGLE *
*        FROM vbfa
*        INTO @DATA(ls_vbfa)
*        WHERE vbeln = @ls_mseg-ebeln AND
*              posnn = @ls_mseg-ebelp AND
*              vbtyp_n = 'V'.
*      IF sy-subrc <> 0.
*        "
*        " Busco la imputación en el pedido.
*        "
*        SELECT SINGLE *
*          FROM ekkn
*          INTO @DATA(ls_ekkn)
*          WHERE ebeln = @ls_mseg-ebeln AND
*                ebelp = @ls_mseg-ebelp.
*        IF sy-subrc = 0.
*          " Sustituyo
*          ls_vbfa-vbelv = ls_ekkn-vbeln.
*          ls_vbfa-posnv = ls_ekkn-vbelp.
*        ENDIF.
*      ENDIF.
*      IF sy-subrc = 0.
*        SELECT SINGLE *
*          FROM vbak
*          INTO @DATA(ls_vbak)
*          WHERE vbeln = @ls_vbfa-vbelv.
*
*      ENDIF.
*      IF sy-subrc = 0.
*        SELECT SINGLE *
*          FROM vbap
*          INTO @DATA(ls_vbap)
*          WHERE vbeln = @ls_vbfa-vbelv AND
*                posnr = @ls_vbfa-posnv.
*      ENDIF.
*      IF sy-subrc = 0.
*        ls_dato_monitor-vbeln = ls_vbap-vbeln.
*        ls_dato_monitor-posnr = ls_vbap-posnr.
*        ls_dato_monitor-kunag = ls_vbak-kunnr.
*        ls_dato_monitor-vdatu = ls_vbak-vdatu.
*
*        SELECT MIN( edatu )
*          FROM vbep
*          INTO ls_dato_monitor-fecha_ent_cliente
*          WHERE vbeln = ls_vbfa-vbelv AND
*                posnr = ls_vbfa-posnv.
*
*        "
*        " Destinatario
*        "
*        SELECT SINGLE *
*          FROM vbpa
*          INTO @DATA(ls_vbpa_dest)
*          WHERE vbeln = @ls_vbap-vbeln AND
*                posnr = @ls_vbap-posnr AND
*                parvw = 'WE'.
*        IF sy-subrc <> 0.
*          SELECT SINGLE *
*            FROM vbpa
*            INTO ls_vbpa_dest
*            WHERE vbeln = ls_vbap-vbeln AND
*                  posnr = '000000' AND
*                  parvw = 'WE'.
*        ENDIF.
*        IF sy-subrc <> 0.
*          CLEAR ls_vbpa_dest.
*        ENDIF.
*        ls_dato_monitor-kunwe = ls_vbpa_dest-kunnr.
*        ls_dato_monitor-adrnr = ls_vbpa_dest-adrnr.
*
*        SELECT SINGLE name1
*          FROM kna1
*          INTO ls_dato_monitor-kunwe_name1
*          WHERE kunnr = ls_dato_monitor-kunwe.
*        IF sy-subrc <> 0.
*          CLEAR ls_dato_monitor-kunwe_name1.
*        ENDIF.
*        "
*        " Pedido cliente
*        "
*        SELECT SINGLE *
*          FROM vbkd
*          INTO @DATA(ls_vbkd)
*          WHERE vbeln = @ls_vbap-vbeln AND
*                posnr = @ls_vbap-posnr.
*        IF sy-subrc <> 0.
*          SELECT SINGLE *
*            FROM vbkd
*            INTO CORRESPONDING FIELDS OF ls_vbkd
*            WHERE vbeln = ls_vbap-vbeln AND
*                  posnr = '000000'.
*        ENDIF.
*        IF sy-subrc = 0.
*          ls_dato_monitor-bstkd = ls_vbkd-bstkd.
*        ENDIF.
*      ENDIF.
*
*
*      ls_dato_monitor-matnr_final = ls_ekpo-matnr. "ls_vbap-matnr. No se sirve por escenario 3.
*      ls_dato_monitor-kwmeng = ls_ekpo-menge. "ls_vbap-kwmeng. No me sirve por escenario 3.
*      ls_dato_monitor-kwmeng_resto = ls_dato_monitor-kwmeng.
*      ls_dato_monitor-vrkme = ls_ekpo-meins. " ls_vbap-vrkme. no me sirve por escenario 3.
*      ls_dato_monitor-elikz = ls_ekpo-elikz.
*      ls_dato_monitor-menge_teorico = ls_resb-bdmng.
*      ls_dato_monitor-menge_resto = ls_resb-bdmng.
*      ls_dato_monitor-meins_teorico = ls_resb-meins.
*      ls_dato_monitor-ebeln = ls_mseg-ebeln.
*      ls_dato_monitor-ebelp = ls_mseg-ebelp.
*
*      "
*      " Restamos los tratamientos posteriores.
*      "
*      IF ls_mseg-ebeln IS NOT INITIAL.
*        SELECT *
*          FROM mseg
*          INTO TABLE @DATA(lt_mseg_previos)
*          WHERE ebeln = @ls_mseg-ebeln AND
*                ebelp = @ls_mseg-ebelp.
*        " Quito los anulados.
*        LOOP AT lt_mseg_previos ASSIGNING <fs_mseg>.
*          SELECT SINGLE *
*            FROM mseg
*            INTO ls_mseg_anulacion
*            WHERE smbln = <fs_mseg>-mblnr AND
*                  sjahr = <fs_mseg>-mjahr AND
*                  smblp = <fs_mseg>-zeile.
*          IF sy-subrc = 0.
*            DELETE lt_mseg_previos.
*          ENDIF.
*        ENDLOOP.
*        LOOP AT lt_mseg_previos INTO DATA(ls_mseg_previos).
*          IF ls_mseg_previos-bwart = '101'.
*            ls_dato_monitor-kwmeng_resto = ls_dato_monitor-kwmeng_resto - ls_mseg_previos-menge.
*          ENDIF.
*          IF ls_mseg_previos-bwart = '543'.
*            ls_dato_monitor-menge_resto = ls_dato_monitor-menge_resto - ls_mseg_previos-menge.
*          ENDIF.
*
*        ENDLOOP.
*      ENDIF.
*
*
*
*
*
*
*
*
*
*
*      "
*      " Totalizamos el stock
*      "
*      DATA: lv_menge TYPE ekpo-menge.
*      LOOP AT lt_mslb ASSIGNING FIELD-SYMBOL(<fs_mslb_stock>) WHERE mara-matnr = ls_dato_monitor-matnr_se.
*        lv_menge = <fs_mslb_stock>-mslb-lblab.
*        ls_dato_monitor-meins_stock = ls_dato_monitor-meins_teorico.
*        IF ls_dato_monitor-meins_stock IS INITIAL.
*          ls_dato_monitor-meins_stock = <fs_mslb_stock>-mara-meins.
*        ENDIF.
*        CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
*          EXPORTING
*            i_matnr              = ls_dato_monitor-matnr_se
*            i_in_me              = <fs_mslb_stock>-mara-meins
*            i_out_me             = ls_dato_monitor-meins_stock
*            i_menge              = lv_menge
*          IMPORTING
*            e_menge              = lv_menge
*          EXCEPTIONS
*            error_in_application = 1
*            error                = 2
*            OTHERS               = 3.
*        IF sy-subrc <> 0.
*          CLEAR lv_menge.
*        ENDIF.
*
*        ADD lv_menge  TO ls_dato_monitor-stock.
*        ADD 1 TO ls_dato_monitor-numlotes.
*
*      ENDLOOP.
*      " Añadimos a la tabla
*      " Visto con Andréa el 10.07.24 Florece stock en proveedor sin pedido subco.
*      " Por arranque o por inventarios.
*      CHECK ls_mseg-ebeln IS NOT INITIAL.
*      APPEND ls_dato_monitor TO tp_monitor.
*    ENDLOOP.

    "
    " Lista de pedidos subco que hay que tratar.
    "
    DATA: lr_bsart TYPE RANGE OF ekko-bsart,
          lr_elikz TYPE RANGE OF ekpo-elikz.

    CLEAR lr_bsart.
    APPEND INITIAL LINE TO lr_bsart ASSIGNING FIELD-SYMBOL(<fs_bsart>).
    <fs_bsart>-option = 'EQ'.
    <fs_bsart>-sign = 'I'.
    <fs_bsart>-low = 'ZPE1'.

    APPEND INITIAL LINE TO lr_bsart ASSIGNING <fs_bsart>.
    <fs_bsart>-option = 'EQ'.
    <fs_bsart>-sign = 'I'.
    <fs_bsart>-low = 'ZPE2'.

    CLEAR lr_elikz.
    IF vp_sel_elikz = 1.
      APPEND INITIAL LINE TO lr_elikz ASSIGNING FIELD-SYMBOL(<fs_elikz>).
      <fs_elikz>-option = 'EQ'.
      <fs_elikz>-sign = 'I'.
      <fs_elikz>-low = ' '.
    ENDIF.
    IF vp_sel_elikz = 2.
      APPEND INITIAL LINE TO lr_elikz ASSIGNING <fs_elikz>.
      <fs_elikz>-option = 'EQ'.
      <fs_elikz>-sign = 'I'.
      <fs_elikz>-low = 'X'.
    ENDIF.

    SELECT *
      FROM ekpo
      INNER JOIN ekko ON ( ekpo~ebeln = ekko~ebeln )
      INTO TABLE @DATA(lt_pedidos)
      WHERE ekko~lifnr = @vp_lifnr AND
            ekko~bsart IN @lr_bsart AND
            ( ekpo~pstyp = 3 OR ( ekpo~pstyp = '0' AND ekpo~knttp = 'M' ) ) AND
            ekpo~werks = @vp_werks AND
            ekpo~lgort = @vp_lgort AND
            ekpo~elikz IN @lr_elikz AND
            ekpo~loekz = ' '.

    LOOP AT lt_pedidos ASSIGNING FIELD-SYMBOL(<fs_pedido>).

      CLEAR ls_dato_monitor.
      ls_dato_monitor-proceso = 'SC'.
      IF <fs_pedido>-ekpo-pstyp = 0 AND <fs_pedido>-ekpo-knttp = 'M'.
        ls_dato_monitor-proceso = 'ME'.
      ENDIF.
      ls_dato_monitor-matnr_final = <fs_pedido>-ekpo-matnr.
      ls_dato_monitor-ebeln = <fs_pedido>-ekpo-ebeln.
      ls_dato_monitor-ebelp = <fs_pedido>-ekpo-ebelp.
      ls_dato_monitor-kwmeng = <fs_pedido>-ekpo-menge.
      ls_dato_monitor-kwmeng_resto = ls_dato_monitor-kwmeng.
      ls_dato_monitor-vrkme = <fs_pedido>-ekpo-meins.
      ls_dato_monitor-elikz = <fs_pedido>-ekpo-elikz.

      SELECT SINGLE *
        FROM eket
        INTO @DATA(ls_eket)
        WHERE ebeln = @ls_dato_monitor-ebeln AND
              ebelp = @ls_dato_monitor-ebelp.

      IF sy-subrc = 0.
        ls_dato_monitor-charg = ls_eket-charg.
      ENDIF.

      SELECT MIN( eindt )
        FROM eket
        INTO ls_dato_monitor-fecha_ent_servicio
        WHERE ebeln = ls_dato_monitor-ebeln AND
              ebelp = ls_dato_monitor-ebelp.

      SELECT SINGLE *
        FROM vbfa
        INTO @DATA(ls_vbfa)
        WHERE vbeln = @ls_dato_monitor-ebeln AND
              posnn = @ls_dato_monitor-ebelp AND
              vbtyp_n = 'V'.
      IF sy-subrc <> 0.
        "
        " Busco la imputación en el pedido.
        "
        SELECT SINGLE *
          FROM ekkn
          INTO @DATA(ls_ekkn)
          WHERE ebeln = @ls_dato_monitor-ebeln AND
                ebelp = @ls_dato_monitor-ebelp.
        IF sy-subrc = 0.
          " Sustituyo
          ls_vbfa-vbelv = ls_ekkn-vbeln.
          ls_vbfa-posnv = ls_ekkn-vbelp.
        ENDIF.
      ENDIF.
      IF sy-subrc = 0.
        SELECT SINGLE *
          FROM vbak
          INTO @DATA(ls_vbak)
          WHERE vbeln = @ls_vbfa-vbelv.

      ENDIF.
      IF sy-subrc = 0.
        SELECT SINGLE *
          FROM vbap
          INTO @DATA(ls_vbap)
          WHERE vbeln = @ls_vbfa-vbelv AND
                posnr = @ls_vbfa-posnv.
      ENDIF.
      IF sy-subrc = 0.
        ls_dato_monitor-vbeln = ls_vbap-vbeln.
        ls_dato_monitor-posnr = ls_vbap-posnr.
        ls_dato_monitor-kunag = ls_vbak-kunnr.
        ls_dato_monitor-vdatu = ls_vbak-vdatu.
        ls_dato_monitor-zzfconfs = ls_vbap-zzfconfs.

        SELECT MIN( edatu )
          FROM vbep
          INTO ls_dato_monitor-fecha_ent_cliente
          WHERE vbeln = ls_vbfa-vbelv AND
                posnr = ls_vbfa-posnv.

        "
        " Destinatario
        "
        SELECT SINGLE *
          FROM vbpa
          INTO @DATA(ls_vbpa_dest)
          WHERE vbeln = @ls_vbap-vbeln AND
                posnr = @ls_vbap-posnr AND
                parvw = 'WE'.
        IF sy-subrc <> 0.
          SELECT SINGLE *
            FROM vbpa
            INTO ls_vbpa_dest
            WHERE vbeln = ls_vbap-vbeln AND
                  posnr = '000000' AND
                  parvw = 'WE'.
        ENDIF.
        IF sy-subrc <> 0.
          CLEAR ls_vbpa_dest.
        ENDIF.
        ls_dato_monitor-kunwe = ls_vbpa_dest-kunnr.
        ls_dato_monitor-adrnr = ls_vbpa_dest-adrnr.

        SELECT SINGLE name1
          FROM kna1
          INTO ls_dato_monitor-kunwe_name1
          WHERE kunnr = ls_dato_monitor-kunwe.
        IF sy-subrc <> 0.
          CLEAR ls_dato_monitor-kunwe_name1.
        ENDIF.
        "
        " Pedido cliente
        "
        SELECT SINGLE *
          FROM vbkd
          INTO @DATA(ls_vbkd)
          WHERE vbeln = @ls_vbap-vbeln AND
                posnr = @ls_vbap-posnr.
        IF sy-subrc <> 0.
          SELECT SINGLE *
            FROM vbkd
            INTO CORRESPONDING FIELDS OF ls_vbkd
            WHERE vbeln = ls_vbap-vbeln AND
                  posnr = '000000'.
        ENDIF.
        IF sy-subrc = 0.
          ls_dato_monitor-bstkd = ls_vbkd-bstkd.
        ENDIF.

        SELECT SINGLE *
          FROM mvke
          INTO @DATA(ls_mvke)
          WHERE vkorg = @ls_vbak-vkorg AND
                vtweg = @ls_vbak-vtweg AND
                matnr = @ls_dato_monitor-matnr_final.
        IF sy-subrc <> 0.
          CLEAR ls_mvke.
        ENDIF.
      ELSE.
        IF <fs_pedido>-ekpo-zzcliente IS NOT INITIAL.
          ls_dato_monitor-kunag = <fs_pedido>-ekpo-zzcliente.
        ELSE.
          SELECT SINGLE *
            FROM knmt
            INTO @DATA(ls_knmt)
            WHERE vkorg = @<fs_pedido>-ekko-bukrs AND
                  vtweg = '10' AND
                  matnr = @ls_dato_monitor-matnr_final.
          IF sy-subrc = 0.
            ls_dato_monitor-kunag = ls_knmt-kunnr.
          ENDIF.
        ENDIF.

        SELECT SINGLE *
          FROM mvke
          INTO ls_mvke
          WHERE vkorg = <fs_pedido>-ekko-bukrs AND
                vtweg = '10' AND
                matnr = ls_dato_monitor-matnr_final.
        IF sy-subrc <> 0.
          CLEAR ls_mvke.
        ENDIF.
      ENDIF.

      ls_dato_monitor-vmsta = ls_mvke-vmsta.

      "
      " Restamos los tratamientos posteriores.
      "

      SELECT *
        FROM mseg
        INTO TABLE @DATA(lt_mseg_previos)
        WHERE ebeln = @ls_dato_monitor-ebeln AND
              ebelp = @ls_dato_monitor-ebelp.
      " Quito los anulados.
      LOOP AT lt_mseg_previos ASSIGNING FIELD-SYMBOL(<fs_mseg>).
        SELECT SINGLE *
          FROM mseg
          INTO @DATA(ls_mseg_anulacion)
          WHERE smbln = @<fs_mseg>-mblnr AND
                sjahr = @<fs_mseg>-mjahr AND
                smblp = @<fs_mseg>-zeile.
        IF sy-subrc = 0.
          DELETE lt_mseg_previos.
        ENDIF.
      ENDLOOP.
      LOOP AT lt_mseg_previos INTO DATA(ls_mseg_previos).
        IF ls_mseg_previos-bwart = '101' AND ls_mseg_previos-matnr = ls_dato_monitor-matnr_final.
          ls_dato_monitor-kwmeng_resto = ls_dato_monitor-kwmeng_resto - ls_mseg_previos-menge.
        ENDIF.
      ENDLOOP.

      IF ls_dato_monitor-proceso = 'ME'.
        "
        " Lo añadimos directamente.
        "
        APPEND ls_dato_monitor TO tp_monitor.
      ELSE.
        "
        " Añadimos una posición por cada semi
        "
        SELECT *
          FROM resb
          INTO TABLE @DATA(lt_resb)
          WHERE ebeln = @ls_dato_monitor-ebeln AND
                ebelp = @ls_dato_monitor-ebelp AND
                postp = 'L'.
        LOOP AT lt_resb ASSIGNING FIELD-SYMBOL(<fs_resb>).
          ls_dato_monitor-matnr_se = <fs_resb>-matnr.
          ls_dato_monitor-menge_teorico = <fs_resb>-bdmng.
          ls_dato_monitor-menge_resto = <fs_resb>-bdmng.
          ls_dato_monitor-meins_teorico = <fs_resb>-meins.

          CLEAR ls_dato_monitor-stock.
          CLEAR ls_dato_monitor-numlotes.
          "
          " Quitamos tratamientos previos.
          "
          LOOP AT lt_mseg_previos INTO ls_mseg_previos.
            IF ls_mseg_previos-bwart = '543' AND ls_mseg_previos-matnr = ls_dato_monitor-matnr_se.
              ls_dato_monitor-menge_resto = ls_dato_monitor-menge_resto - ls_mseg_previos-menge.
            ENDIF.

          ENDLOOP.

          "
          " Totalizamos el stock
          "
***      DATA: lv_menge TYPE ekpo-menge.
          LOOP AT lt_mslb ASSIGNING FIELD-SYMBOL(<fs_mslb_stock>) WHERE mara-matnr = ls_dato_monitor-matnr_se.
            DATA(lv_menge) = <fs_mslb_stock>-mslb-lblab.
            ls_dato_monitor-meins_stock = ls_dato_monitor-meins_teorico.
            IF ls_dato_monitor-meins_stock IS INITIAL.
              ls_dato_monitor-meins_stock = <fs_mslb_stock>-mara-meins.
            ENDIF.
            CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
              EXPORTING
                i_matnr              = ls_dato_monitor-matnr_se
                i_in_me              = <fs_mslb_stock>-mara-meins
                i_out_me             = ls_dato_monitor-meins_stock
                i_menge              = lv_menge
              IMPORTING
                e_menge              = lv_menge
              EXCEPTIONS
                error_in_application = 1
                error                = 2
                OTHERS               = 3.
            IF sy-subrc <> 0.
              CLEAR lv_menge.
            ENDIF.

            ADD lv_menge  TO ls_dato_monitor-stock.
            ADD 1 TO ls_dato_monitor-numlotes.

          ENDLOOP.

          APPEND ls_dato_monitor TO tp_monitor.
        ENDLOOP.

      ENDIF.

    ENDLOOP.

    LOOP AT tp_monitor ASSIGNING FIELD-SYMBOL(<fs_dato_monitor>).
      "
      " Totalizamos necesidades por otros materiales.
      "
      LOOP AT tp_monitor ASSIGNING FIELD-SYMBOL(<fs_nec>) WHERE matnr_se = <fs_dato_monitor>-matnr_se.
        IF <fs_dato_monitor>-vbeln <> <fs_nec>-vbeln OR
           <fs_dato_monitor>-posnr <> <fs_nec>-posnr.
          ADD <fs_nec>-menge_teorico TO <fs_dato_monitor>-menge_nec_se.
          <fs_dato_monitor>-meins_nec_se = <fs_nec>-meins_teorico.
        ENDIF.
      ENDLOOP.

    ENDLOOP.

    "
    " Stock de PT en el almacén de PERIS
    "
    SELECT *
      FROM mchb
      INNER JOIN mara ON mara~matnr = mchb~matnr
      INTO TABLE @DATA(lt_mchb)
      WHERE mchb~werks = @vp_werks AND
            mchb~lgort = @vp_lgort AND
            mchb~clabs <> 0.
    LOOP AT lt_mchb ASSIGNING FIELD-SYMBOL(<fs_mchb>).
      APPEND INITIAL LINE TO tp_monitor ASSIGNING <fs_dato_monitor>.
      <fs_dato_monitor>-proceso = 'AR'.
      <fs_dato_monitor>-matnr_final = <fs_mchb>-mchb-matnr.
      <fs_dato_monitor>-charg = <fs_mchb>-mchb-charg.
      CLEAR <fs_dato_monitor>-matnr_se.
      CLEAR <fs_dato_monitor>-vbeln.
      CLEAR <fs_dato_monitor>-posnr.
      CLEAR <fs_dato_monitor>-kwmeng.
      CLEAR <fs_dato_monitor>-vrkme.
      CLEAR <fs_dato_monitor>-menge_nec_se.
      CLEAR <fs_dato_monitor>-meins_nec_se.
      <fs_dato_monitor>-stock = <fs_mchb>-mchb-clabs.
      <fs_dato_monitor>-meins_stock = <fs_mchb>-mara-meins.
      CLEAR <fs_dato_monitor>-numlotes.
      CLEAR <fs_dato_monitor>-kunag.
      CLEAR <fs_dato_monitor>-vdatu.

      SELECT SINGLE *
        FROM knmt
        INTO ls_knmt
        WHERE vkorg = ls_t001w-vkorg AND
              vtweg = '10' AND
              matnr = <fs_dato_monitor>-matnr_final.
      IF sy-subrc = 0.
        <fs_dato_monitor>-kunag = ls_knmt-kunnr.
      ENDIF.
    ENDLOOP.

    "
    " Stock de cliente
    "
    SELECT *
      FROM mska
      INNER JOIN mara ON mara~matnr = mska~matnr
      INTO TABLE @DATA(lt_mska)
      WHERE mska~werks = @vp_werks AND
            mska~lgort = @vp_lgort AND
            mska~kalab <> 0.
    LOOP AT lt_mska ASSIGNING FIELD-SYMBOL(<fs_mska>).
      APPEND INITIAL LINE TO tp_monitor ASSIGNING <fs_dato_monitor>.
      <fs_dato_monitor>-proceso = 'AR'.
      <fs_dato_monitor>-matnr_final = <fs_mska>-mska-matnr.
      <fs_dato_monitor>-charg = <fs_mska>-mska-charg.
      CLEAR <fs_dato_monitor>-matnr_se.
*      <fs_dato_monitor>-vbeln = <fs_mska>-mska-vbeln.
*      <fs_dato_monitor>-posnr = <fs_mska>-mska-posnr.
      CLEAR <fs_dato_monitor>-kwmeng.
      CLEAR <fs_dato_monitor>-vrkme.
      CLEAR <fs_dato_monitor>-menge_nec_se.
      CLEAR <fs_dato_monitor>-meins_nec_se.
      <fs_dato_monitor>-stock = <fs_mska>-mska-kalab.
      <fs_dato_monitor>-meins_stock = <fs_mska>-mara-meins.
      CLEAR <fs_dato_monitor>-numlotes.
      CLEAR <fs_dato_monitor>-kunag.
      CLEAR <fs_dato_monitor>-vdatu.

      SELECT SINGLE *
        FROM knmt
        INTO ls_knmt
        WHERE vkorg = ls_t001w-vkorg AND
              vtweg = '10' AND
              matnr = <fs_dato_monitor>-matnr_final.
      IF sy-subrc = 0.
        <fs_dato_monitor>-kunag = ls_knmt-kunnr.
      ENDIF.

    ENDLOOP.

*    APPEND INITIAL LINE TO tp_monitor ASSIGNING <fs_dato_monitor>.
*    <fs_dato_monitor>-matnr_pt = 'COINNI00000669'.
*    <fs_dato_monitor>-matnr_se = 'SEPLNI00000740'.
*    <fs_dato_monitor>-vbeln = 9999.
*    <fs_dato_monitor>-posnr = 10.
*    <fs_dato_monitor>-kwmeng = 1000.
*    <fs_dato_monitor>-vrkme = 'ST'.
*    <fs_dato_monitor>-menge_nec_se = 1000.
*    <fs_dato_monitor>-meins_nec_se = 'ST'.
*    <fs_dato_monitor>-stock = 2500.
*    <fs_dato_monitor>-meins_stock = 'ST'.
*    <fs_dato_monitor>-numlotes = 3.
*    <fs_dato_monitor>-kunag = '0000101067'.
*    <fs_dato_monitor>-vdatu = '20240411'.

    IF tp_monitor IS NOT INITIAL.
      SELECT *
        INTO TABLE @DATA(lt_mara_final)
        FROM mara
        FOR ALL ENTRIES IN @tp_monitor
        WHERE matnr = @tp_monitor-matnr_final.

      SELECT *
        INTO TABLE @DATA(lt_marc_final)
        FROM marc
        FOR ALL ENTRIES IN @tp_monitor
        WHERE matnr = @tp_monitor-matnr_final AND
              werks = @vp_werks.
    ENDIF.

    DATA ls_trans_cab TYPE zst_sdle_transp_cab.
    ls_trans_cab-werks = vp_werks.
    ls_trans_cab-lgort = vp_lgort.

    LOOP AT tp_monitor ASSIGNING <fs_dato_monitor>.

      READ TABLE lt_mara_final INTO DATA(ls_mara_final) WITH KEY matnr = <fs_dato_monitor>-matnr_final.
      IF sy-subrc = 0.
        <fs_dato_monitor>-mstae = ls_mara_final-mstae.
        <fs_dato_monitor>-mstav = ls_mara_final-mstav.
      ENDIF.
      READ TABLE lt_marc_final INTO DATA(ls_marc_final) WITH KEY matnr = <fs_dato_monitor>-matnr_final.
      IF sy-subrc = 0.
        <fs_dato_monitor>-mstae = ls_marc_final-mmsta.
      ENDIF.
      IF <fs_dato_monitor>-mstae = 'Z4'.
        " Este bloqueo lo permitimos, ya que nos deja hacer expediciones.
        CLEAR <fs_dato_monitor>-mstae.
      ENDIF.

      IF <fs_dato_monitor>-mstae IS NOT INITIAL.
        SELECT SINGLE mtstb
          FROM t141t
          INTO <fs_dato_monitor>-desc_status_mat
          WHERE spras = sy-langu AND
                mmsta = <fs_dato_monitor>-mstae.
        IF sy-subrc <> 0.
          CLEAR <fs_dato_monitor>-desc_status_mat.
        ENDIF.
      ENDIF.
      IF <fs_dato_monitor>-desc_status_mat IS INITIAL AND <fs_dato_monitor>-mstav IS NOT INITIAL.
        SELECT SINGLE vmstb
          FROM tvmst
          INTO <fs_dato_monitor>-desc_status_mat
          WHERE spras = sy-langu AND
                vmsta = <fs_dato_monitor>-mstav.
        IF sy-subrc <> 0.
          CLEAR <fs_dato_monitor>-desc_status_mat.
        ENDIF.
      ENDIF.
      IF <fs_dato_monitor>-desc_status_mat IS INITIAL AND <fs_dato_monitor>-vmsta IS NOT INITIAL.
        SELECT SINGLE vmstb
          FROM tvmst
          INTO <fs_dato_monitor>-desc_status_mat
          WHERE spras = sy-langu AND
                vmsta = <fs_dato_monitor>-vmsta.
        IF sy-subrc <> 0.
          CLEAR <fs_dato_monitor>-desc_status_mat.
        ENDIF.
      ENDIF.

      SELECT SINGLE maktx
        INTO <fs_dato_monitor>-maktx_final
        FROM makt
        WHERE spras = sy-langu AND
              matnr = <fs_dato_monitor>-matnr_final.
      IF sy-subrc <> 0.
        CLEAR <fs_dato_monitor>-maktx_final.
      ENDIF.

      SELECT SINGLE maktx
        INTO <fs_dato_monitor>-maktx_se
        FROM makt
        WHERE spras = sy-langu AND
              matnr = <fs_dato_monitor>-matnr_se.
      IF sy-subrc <> 0.
        CLEAR <fs_dato_monitor>-maktx_se.
      ENDIF.

      SELECT SINGLE name1
        INTO <fs_dato_monitor>-name1
        FROM kna1
        WHERE kunnr = <fs_dato_monitor>-kunag.
      IF sy-subrc <> 0.
        CLEAR <fs_dato_monitor>-name1.
      ENDIF.

      SELECT SINGLE *
        FROM ztsdle0002
        INNER JOIN ztsdle0001 ON ( ztsdle0001~numtransporte = ztsdle0002~numtransporte )
        INTO @DATA(ls_trans_pos)
        WHERE ztsdle0002~matnr_final = @<fs_dato_monitor>-matnr_final AND
              ztsdle0002~charg = @<fs_dato_monitor>-charg AND
              ztsdle0002~ebeln = @<fs_dato_monitor>-ebeln AND
              ztsdle0002~ebelp = @<fs_dato_monitor>-ebelp AND
              ztsdle0001~estado <> 9.
      IF sy-subrc = 0.
        <fs_dato_monitor>-tratado = 'X'.
      ELSE.
        CLEAR <fs_dato_monitor>-tratado.
      ENDIF.

      READ TABLE tl_dd07t ASSIGNING FIELD-SYMBOL(<fs_dd07t>) WITH KEY domvalue_l = <fs_dato_monitor>-proceso.
      IF sy-subrc = 0.
        <fs_dato_monitor>-proceso_desc = <fs_dd07t>-ddtext.
      ENDIF.

      IF <fs_dato_monitor>-posnr IS NOT INITIAL.
        SELECT SINGLE *
          FROM vbup
          INTO @DATA(wl_vbup)
          WHERE vbeln = @<fs_dato_monitor>-vbeln AND
                posnr = @<fs_dato_monitor>-posnr.
        IF sy-subrc = 0.
          <fs_dato_monitor>-gbsta = wl_vbup-gbsta.
        ENDIF.
      ENDIF.

      DATA(lv_ultimo_destino) = ultimo_destino( lp_matnr = <fs_dato_monitor>-matnr_final lp_charg = <fs_dato_monitor>-charg lp_trans_cab = ls_trans_cab ).

      CASE lv_ultimo_destino.
        WHEN '1'.
          <fs_dato_monitor>-ultimo_destino = 'Cliente'.
        WHEN '2'.
          <fs_dato_monitor>-ultimo_destino = 'Xàtiva'.
        WHEN OTHERS.
          CLEAR <fs_dato_monitor>-ultimo_destino.
      ENDCASE.
    ENDLOOP.

  ENDMETHOD.
  METHOD monitorlog_getlist.
    DATA: lr_ntra   TYPE RANGE OF ztsdle0003-numtransporte,
          lr_mblnr  TYPE RANGE OF ztsdle0003-mblnr,
          lr_mjahr  TYPE RANGE OF ztsdle0003-mjahr,
          lr_vbeln  TYPE RANGE OF ztsdle0003-vbeln,
          lr_posnr  TYPE RANGE OF ztsdle0003-posnr,
          lr_vbeln2 TYPE RANGE OF ztsdle0003-vbeln_vl,
          lr_tknum  TYPE RANGE OF ztsdle0003-tknum,
          lr_erdat  type RANGE OF ztsdle0003-erdat,
          lr_responsable  type RANGE OF ztsdle0001-responsable.

    lr_ntra = lp_r_ntra.
    lr_mblnr = lp_r_mblnr.
    lr_mjahr = lp_r_mjahr.
    lr_vbeln = lp_r_vbeln.
    lr_posnr = lp_r_posnr.
    lr_vbeln2 = lp_r_vbeln2.
    lr_tknum = lp_r_tknum.
    lr_erdat = lp_r_erdat.
    lr_responsable = lp_r_resp.

    CLEAR tp_monitorlog.

    SELECT ztsdle0003~*
      FROM ztsdle0003
      INNER JOIN ztsdle0001 on ( ztsdle0003~numtransporte = ztsdle0001~numtransporte )
      INTO CORRESPONDING FIELDS OF TABLE @tp_monitorlog
      WHERE ztsdle0003~numtransporte IN @lr_ntra AND
            mblnr IN @lr_mblnr AND
            mjahr IN @lr_mjahr AND
            vbeln IN @lr_vbeln AND
            posnr IN @lr_posnr AND
            vbeln_vl IN @lr_vbeln2 AND
            tknum IN @lr_tknum and
            ztsdle0003~erdat in @lr_erdat and
            ztsdle0001~responsable in @lr_responsable.


    LOOP AT tp_monitorlog ASSIGNING FIELD-SYMBOL(<fs_log>).
      SELECT SINGLE ddtext
        INTO <fs_log>-paso_txt
        FROM dd07t
        WHERE domname = 'ZDN_PASO_LOG' AND
              ddlanguage = sy-langu AND
              domvalue_l = <fs_log>-paso.
      IF sy-subrc <> 0.
        CLEAR <fs_log>-paso_txt.
      ENDIF.

    ENDLOOP.
  ENDMETHOD.
  METHOD notificar_entrada_mat.
    DATA: lt_datos_a_not TYPE TABLE OF zst_sdle_notif_entr_mat.

    DATA: lv_datos_log     TYPE zst_sdle_transp_log,
          lv_datos_log_msg TYPE zst_sdle_transp_log_msg.

    DATA: wl_goodsmvt_header  TYPE bapi2017_gm_head_01,
          wl_goodsmvt_code    TYPE bapi2017_gm_code,
          lv_materialdocument TYPE  bapi2017_gm_head_ret-mat_doc,
          lv_matdocumentyear  TYPE  bapi2017_gm_head_ret-doc_year,
          lt_goodsmvt_item    TYPE TABLE OF bapi2017_gm_item_create,
          lt_return           TYPE TABLE OF bapiret2,
          lv_line_id          TYPE bapi2017_gm_item_create-line_id.

    DATA: lv_cantidad_notificada  TYPE p DECIMALS 3,
          lv_cantidad_a_notificar TYPE p DECIMALS 3,
          lv_cantidad_a_consumir  TYPE p DECIMALS 3.

    "
    " Confirmar si el paso ya se ha ejecutado.
    "
    DATA(lt_log) = trans_log_getlist( lp_numtransporte = lp_numtransporte lp_paso = gc_paso_notificar_entrada_pt  lp_estado = gc_estado_log_ok ).
    DATA(lv_lines_log) = lines( lt_log ).
    IF lv_lines_log IS NOT INITIAL.
      RETURN.
    ENDIF.

    DATA(ls_trans_cab) = trans_cab_getdetail( lp_numtransporte ).
    DATA(lt_posiciones) = trans_pos_getlist( lp_numtransporte ).

    CLEAR lt_datos_a_not.
    LOOP AT lt_posiciones ASSIGNING FIELD-SYMBOL(<fs_pos>).
      IF <fs_pos>-ebeln IS NOT INITIAL.
        APPEND INITIAL LINE TO lt_datos_a_not ASSIGNING FIELD-SYMBOL(<fs_dato_a_not>).
        MOVE-CORRESPONDING <fs_pos> TO <fs_dato_a_not>.
      ENDIF.
    ENDLOOP.

    SORT lt_datos_a_not BY ebeln ebelp matnr_final matnr_se.

    LOOP AT lt_datos_a_not ASSIGNING <fs_dato_a_not>.
      AT NEW ebelp.
        CLEAR lt_goodsmvt_item.

        CLEAR lv_line_id.

        SELECT SINGLE *
          FROM ekko
          INTO @DATA(wl_ekko)
          WHERE ebeln = @<fs_dato_a_not>-ebeln.

        SELECT SINGLE *
          FROM ekpo
          INTO @DATA(wl_ekpo)
          WHERE ebeln = @<fs_dato_a_not>-ebeln AND
                ebelp = @<fs_dato_a_not>-ebelp.
      ENDAT.

      AT NEW matnr_final.
        ADD 1 TO lv_line_id.
        APPEND INITIAL LINE TO lt_goodsmvt_item ASSIGNING FIELD-SYMBOL(<fs_goodsmvt_item>).
        <fs_goodsmvt_item>-line_id = lv_line_id.
        <fs_goodsmvt_item>-material   = <fs_dato_a_not>-matnr_final.
        <fs_goodsmvt_item>-plant      = wl_ekpo-werks.
        <fs_goodsmvt_item>-stge_loc   = wl_ekpo-lgort.
        <fs_goodsmvt_item>-po_number  = <fs_dato_a_not>-ebeln.
        <fs_goodsmvt_item>-po_item    = <fs_dato_a_not>-ebelp.
        <fs_goodsmvt_item>-move_type  = '101'.
        <fs_goodsmvt_item>-mvt_ind = 'B'.
        <fs_goodsmvt_item>-entry_qnt = <fs_dato_a_not>-kwmeng_real.
        <fs_goodsmvt_item>-entry_uom = <fs_dato_a_not>-vrkme.
**        <fs_goodsmvt_item>-sales_ord = <fs_dato_a_not>-vbeln.
**        <fs_goodsmvt_item>-s_ord_item = <fs_dato_a_not>-posnr.
**        <fs_goodsmvt_item>-val_sales_ord = <fs_goodsmvt_item>-sales_ord.
**        <fs_goodsmvt_item>-val_s_ord_item = <fs_goodsmvt_item>-s_ord_item.
      ENDAT.

      AT NEW matnr_se.
        CLEAR lv_cantidad_a_consumir.
      ENDAT.

      ADD <fs_dato_a_not>-menge_real TO lv_cantidad_a_consumir.

      AT END OF matnr_se.
        "
        " Buscamos los lotes disponibles del material semi y consumimos for FIFO,
        "
        SELECT *
          FROM mslb
          INTO TABLE @DATA(lt_mslb)
          WHERE matnr = @<fs_dato_a_not>-matnr_se AND
                werks = '2000' AND
                lblab > 0.
        SORT lt_mslb BY charg ASCENDING.

        CLEAR lv_cantidad_notificada.
        LOOP AT lt_mslb ASSIGNING FIELD-SYMBOL(<fs_mslb>).

          IF lv_cantidad_notificada + <fs_mslb>-lblab <= lv_cantidad_a_consumir.
            lv_cantidad_a_notificar = <fs_mslb>-lblab.
          ELSE.
            lv_cantidad_a_notificar = lv_cantidad_a_consumir - lv_cantidad_notificada.
          ENDIF.

          ADD 1 TO lv_line_id.
          APPEND INITIAL LINE TO lt_goodsmvt_item ASSIGNING <fs_goodsmvt_item>.
          <fs_goodsmvt_item>-parent_id = 1.
          <fs_goodsmvt_item>-line_depth = 1.
          <fs_goodsmvt_item>-line_id = lv_line_id.
          <fs_goodsmvt_item>-material   = <fs_dato_a_not>-matnr_se.
          <fs_goodsmvt_item>-batch = <fs_mslb>-charg. "<fs_dato_a_not>-charg.
          <fs_goodsmvt_item>-plant      = wl_ekpo-werks.
          <fs_goodsmvt_item>-stge_loc   = '1400'. "wl_ekpo-lgort.
          <fs_goodsmvt_item>-po_number  = <fs_dato_a_not>-ebeln.
          <fs_goodsmvt_item>-po_item    = <fs_dato_a_not>-ebelp.
          <fs_goodsmvt_item>-spec_stock = 'K'.
          <fs_goodsmvt_item>-vendor = wl_ekko-lifnr.
          <fs_goodsmvt_item>-move_type  = '543'.
          <fs_goodsmvt_item>-mvt_ind     = 'O'.
          <fs_goodsmvt_item>-entry_qnt = lv_cantidad_a_notificar. " <fs_dato_a_not>-menge_real.
          <fs_goodsmvt_item>-entry_uom = <fs_dato_a_not>-meins_real.
          <fs_goodsmvt_item>-sales_ord = <fs_dato_a_not>-vbeln.
          <fs_goodsmvt_item>-s_ord_item = <fs_dato_a_not>-posnr.
          <fs_goodsmvt_item>-val_sales_ord = <fs_goodsmvt_item>-sales_ord.
          <fs_goodsmvt_item>-val_s_ord_item = <fs_goodsmvt_item>-s_ord_item.

          ADD lv_cantidad_a_notificar TO lv_cantidad_notificada.

          IF lv_cantidad_notificada >= lv_cantidad_a_consumir.
            EXIT.
          ENDIF.
        ENDLOOP.


      ENDAT.

      AT END OF ebelp.

        CLEAR: wl_goodsmvt_header, wl_goodsmvt_code.

        wl_goodsmvt_header-pstng_date = ls_trans_cab-wadat_ist.
        IF wl_goodsmvt_header-pstng_date > sy-datum.
          wl_goodsmvt_header-pstng_date = sy-datum.
        ENDIF.
        wl_goodsmvt_header-doc_date = sy-datum.
        wl_goodsmvt_header-pr_uname = sy-uname.
        wl_goodsmvt_code-gm_code = '01'.

        CLEAR: lv_materialdocument, lv_matdocumentyear.

        CLEAR lt_return.

        CALL FUNCTION 'BAPI_GOODSMVT_CREATE'
          EXPORTING
            goodsmvt_header  = wl_goodsmvt_header
            goodsmvt_code    = wl_goodsmvt_code
          IMPORTING
            materialdocument = lv_materialdocument
            matdocumentyear  = lv_matdocumentyear
          TABLES
            goodsmvt_item    = lt_goodsmvt_item
            return           = lt_return.

        IF lv_materialdocument IS INITIAL.
          lv_datos_log-numtransporte = lp_numtransporte.
          lv_datos_log-paso = gc_paso_notificar_entrada_pt.
          lv_datos_log-estado = gc_estado_log_nook.
          lv_datos_log-mensaje = 'Ver errores'.
          trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

          " Para grabar el log.
          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
            EXPORTING
              wait = 'X'.

          LOOP AT lt_return ASSIGNING FIELD-SYMBOL(<fs_return>).
            MOVE-CORRESPONDING <fs_return> TO lv_datos_log_msg.
            lv_datos_log_msg-numtransporte = lv_datos_log-numtransporte.
            lv_datos_log_msg-paso = lv_datos_log-paso.
            lv_datos_log_msg-posicion = lv_datos_log-posicion.
            lv_datos_log_msg-msgno = <fs_return>-number.

            trans_log_msg_create( CHANGING lp_trans_log_msg = lv_datos_log_msg ).
          ENDLOOP.
          " Devolvemos excepción para no continuar.
          RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
        ELSE.
          lv_datos_log-numtransporte = lp_numtransporte.
          lv_datos_log-paso = gc_paso_notificar_entrada_pt.
          lv_datos_log-estado = gc_estado_log_ok.
          lv_datos_log-mensaje = 'Notificación creada'.
          lv_datos_log-mblnr = lv_materialdocument.
          lv_datos_log-mjahr = lv_matdocumentyear.
          trans_log_create( CHANGING wp_trans_log = lv_datos_log ).

          CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
            EXPORTING
              wait = 'X'.

        ENDIF.
      ENDAT.
    ENDLOOP.


  ENDMETHOD.
  METHOD procesar_transporte.
    DATA: lo_excep TYPE REF TO cx_root,
          lv_error TYPE xflag.

    CLEAR lv_error.

    "
    " Para procesar el transporte hay que realizar diferentes pasos:
    " - Notificar la entrada del PT y consumo del SEMI.
    " - Si Destino es cliente, modificar Pedido de venta original para asignarlo al puesto de expedición de Peris.
    " - Si Destino es Xàtiva, crear pedido de traslado.
    " - Si destino es Xátiva y no hay pedido venta, crearlo con los datos indicados.
    " - Crear entrega de salida contra PV / PT
    " - Crear transporte
    " - Asignar entregas a transporte.
    " - Contabilizar SM entregas.
    DATA(ls_ztsdle0001) = trans_cab_getdetail( lp_numtransporte ).

*    SELECT SINGLE *
*      FROM ztsdle0001
*      INTO @DATA(wl_trans_cab)
*      WHERE numtransporte = @lp_numtransporte.
*    CHECK sy-subrc = 0.

    TRY.
        convertir_stock_cliente( lp_numtransporte ).
      CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
        lv_error = 'X'.
    ENDTRY.

    IF lv_error IS INITIAL.
      TRY.
          notificar_entrada_mat( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.
    ENDIF.

    IF lv_error IS INITIAL.

      TRY.
          creacion_pedidos_venta( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.

    ENDIF.

    IF lv_error IS INITIAL.

      TRY.
          modificar_vstel_pv( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.

    ENDIF.

    IF lv_error IS INITIAL.

      TRY.
          creacion_es_cliente( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.

    ENDIF.


    IF lv_error IS INITIAL.

      TRY.
          creacion_pedido_traslado( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.

    ENDIF.

    IF lv_error IS INITIAL.

      TRY.
          creacion_es_traslado( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.

    ENDIF.

    IF lv_error IS INITIAL.

      TRY.
          creacion_transporte( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.

    ENDIF.

    IF lv_error IS INITIAL.

      TRY.
*          contabilizar_sm_es( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.

    ENDIF.

    IF lv_error IS INITIAL.

      TRY.
*          finalizar_transporte( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.

    ENDIF.

    IF lv_error IS INITIAL.

      TRY.
          entrega_final_pedido( lp_numtransporte ).
        CATCH /iwbep/cx_mgw_busi_exception INTO lo_excep.
          lv_error = 'X'.
      ENDTRY.

    ENDIF.

    "
    " Lanzar error si lo hay
    "
    IF lv_error IS NOT INITIAL.
      RAISE EXCEPTION TYPE /iwbep/cx_mgw_busi_exception.
    ENDIF.

    "
    " Actualizar cabecera
    "
    ls_ztsdle0001-estado = 9.
    trans_cab_update( ls_ztsdle0001 ).

  ENDMETHOD.
  METHOD trans_cab_create.
    DATA wl_trans_cab TYPE ztsdle0001.

    MOVE-CORRESPONDING wp_trans_cab TO wl_trans_cab.

    CALL FUNCTION 'NUMBER_GET_NEXT'
      EXPORTING
        nr_range_nr             = '01'
        object                  = 'Z_NTSUBCO'
      IMPORTING
        number                  = wl_trans_cab-numtransporte
      EXCEPTIONS
        interval_not_found      = 1
        number_range_not_intern = 2
        object_not_found        = 3
        quantity_is_0           = 4
        quantity_is_not_1       = 5
        interval_overflow       = 6
        buffer_overflow         = 7
        OTHERS                  = 8.

    wl_trans_cab-estado = 1.
    wl_trans_cab-usucre  = sy-uname.
    wl_trans_cab-erdat   = sy-datum.
    wl_trans_cab-erzet   = sy-uzeit.

    INSERT ztsdle0001 FROM wl_trans_cab.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'TRANS_CAB_CREATE. Error al crear registro en BD' ).
    ENDIF.

    wp_trans_cab-numtransporte = wl_trans_cab-numtransporte.
    wp_trans_cab-estado = wl_trans_cab-estado.

  ENDMETHOD.
  METHOD trans_cab_getdetail.

    SELECT SINGLE *
      FROM ztsdle0001
      INTO CORRESPONDING FIELDS OF wp_trans_cab
      WHERE numtransporte = vp_numtransporte.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'No existe el transporte buscado' ).
    ENDIF.
  ENDMETHOD.
  METHOD TRANS_CAB_GETLIST.
    DATA: rl_estado TYPE RANGE OF ZTSDLE0001-estado,
          wl_estado LIKE LINE OF rl_estado.

    DATA: lr_responsable type RANGE OF ztsdle0001-responsable,
          ls_responsable like LINE OF lr_responsable.

    CLEAR rl_estado.
    IF vp_estado IS NOT INITIAL.
      CLEAR wl_estado.
      wl_estado-sign = 'I'.
      wl_estado-option = 'EQ'.
      wl_estado-low = vp_estado.
      APPEND wl_estado to rl_estado.
    ENDIF.

    clear lr_responsable.
    IF vp_responsable IS NOT INITIAL.
      CLEAR ls_responsable.
      ls_responsable-sign = 'I'.
      ls_responsable-option = 'EQ'.
      ls_responsable-low = vp_responsable.
      APPEND ls_responsable to lr_responsable.
    ENDIF.

    CLEAR tp_trans_cab.

    SELECT *
      FROM ZTSDLE0001
      INTO CORRESPONDING FIELDS OF TABLE tp_trans_cab
      WHERE estado IN rl_estado and
            responsable in lr_responsable.
  ENDMETHOD.
  METHOD trans_cab_update.
    DATA wl_trans_cab TYPE ztsdle0001.

    SELECT SINGLE *
      INTO @DATA(wl_trans_cab_b)
      FROM ztsdle0001
      WHERE
      numtransporte = @wp_trans_cab-numtransporte.


    MOVE-CORRESPONDING wp_trans_cab TO wl_trans_cab.
    wl_trans_cab-usucre = wl_trans_cab_b-usucre.
    wl_trans_cab-erdat = wl_trans_cab_b-erdat.
    wl_trans_cab-erzet = wl_trans_cab_b-erzet.
    wl_trans_cab-usumod  = sy-uname.
    wl_trans_cab-aedat   = sy-datum.
    wl_trans_cab-aezet   = sy-uzeit.
    UPDATE ztsdle0001 FROM wl_trans_cab.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'TRANS_CAB_UPDATE. Error al actualziar registro en BD' ).
    ENDIF.

  ENDMETHOD.
  METHOD TRANS_HU_CREATE.
    DATA wl_trans_hu TYPE ZTSDLE0005.

    MOVE-CORRESPONDING wp_trans_hu TO wl_trans_hu.

    select max( contador )
      into wl_trans_hu-contador
      from ZTSDLE0005
      where numtransporte = wl_trans_hu-numtransporte and
            matnr_final = wl_trans_hu-matnr_final and
            charg = wl_trans_hu-charg.

    add 1 to wl_trans_hu-contador.
    wl_trans_hu-usucre  = sy-uname.
    wl_trans_hu-erdat   = sy-datum.
    wl_trans_hu-erzet   = sy-uzeit.

    INSERT ZTSDLE0005 FROM wl_trans_hu.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'TRANS_HU_CREATE. Error al crear registro en BD' ).
    ENDIF.

    wp_trans_hu-contador = wl_trans_hu-contador.

  ENDMETHOD.
  METHOD trans_hu_delete.

    DELETE FROM ztsdle0005
      WHERE numtransporte = wp_trans_hu-numtransporte AND
            matnr_final = wp_trans_hu-matnr_final AND
            charg = wp_trans_hu-charg AND
            contador = wp_trans_hu-contador.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'TRANS_HU_DELETE. Error al borrar registro en BD' ).
    ENDIF.

  ENDMETHOD.
  METHOD trans_hu_getlist.

    CLEAR tp_trans_hu.

    SELECT *
      FROM ztsdle0005
      INTO CORRESPONDING FIELDS OF TABLE tp_trans_hu
      WHERE numtransporte = lp_numtransporte AND
            matnr_final = lp_matnr_final AND
            charg = lp_charg.

    LOOP AT tp_trans_hu ASSIGNING FIELD-SYMBOL(<fs_trans_hu>).
      SELECT SINGLE maktx
        INTO <fs_trans_hu>-maktx_final
        FROM makt
        WHERE spras = sy-langu AND
              matnr = <fs_trans_hu>-matnr_final.
      IF sy-subrc <> 0.
        CLEAR <fs_trans_hu>-maktx_final.
      ENDIF.

      SELECT SINGLE maktx
        INTO <fs_trans_hu>-maktx_vhilm
        FROM makt
        WHERE spras = sy-langu AND
              matnr = <fs_trans_hu>-vhilm.
      IF sy-subrc <> 0.
        CLEAR <fs_trans_hu>-maktx_vhilm.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.
  METHOD TRANS_LOG_CREATE.
    DATA wl_trans_log TYPE ZTSDLE0003.

    MOVE-CORRESPONDING wp_trans_log TO wl_trans_log.

    select max( posicion )
      into wl_trans_log-posicion
      from ZTSDLE0003
      where numtransporte = wl_trans_log-numtransporte." and
            "paso = wl_trans_log-paso.

    add 1 to wl_trans_log-posicion.
    wl_trans_log-usucre  = sy-uname.
    wl_trans_log-erdat   = sy-datum.
    wl_trans_log-erzet   = sy-uzeit.

    INSERT ZTSDLE0003 FROM wl_trans_log.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'trans_log_CREATE. Error al crear registro en BD' ).
    ENDIF.

    wp_trans_log-posicion = wl_trans_log-posicion.

  ENDMETHOD.
  METHOD trans_log_getlist.
    DATA: lr_estado TYPE RANGE OF ztsdle0003-estado,
          lr_paso   TYPE RANGE OF ztsdle0003-paso.

    CLEAR lr_estado.
    IF lp_estado IS NOT INITIAL.
      APPEND INITIAL LINE TO lr_estado ASSIGNING FIELD-SYMBOL(<fs_estado>).
      <fs_estado>-option = 'EQ'.
      <fs_estado>-sign = 'I'.
      <fs_estado>-low = lp_estado.
    ENDIF.

    CLEAR lr_paso.
    IF lp_paso IS NOT INITIAL or lp_buscar_paso_cero is NOT INITIAL.
      APPEND INITIAL LINE TO lr_paso ASSIGNING FIELD-SYMBOL(<fs_paso>).
      <fs_paso>-option = 'EQ'.
      <fs_paso>-sign = 'I'.
      <fs_paso>-low = lp_paso.
    ENDIF.

    CLEAR lp_trans_log.

    SELECT *
      FROM ztsdle0003
      INTO CORRESPONDING FIELDS OF TABLE lp_trans_log
      WHERE numtransporte = lp_numtransporte AND
            estado IN lr_estado AND
            paso IN lr_paso.

    LOOP AT lp_trans_log ASSIGNING FIELD-SYMBOL(<fs_log>).
      SELECT SINGLE ddtext
        INTO <fs_log>-paso_txt
        FROM dd07t
        WHERE domname = 'ZDN_PASO_LOG' AND
              ddlanguage = sy-langu AND
              domvalue_l = <fs_log>-paso.
      IF sy-subrc <> 0.
        CLEAR <fs_log>-paso_txt.
      ENDIF.

    ENDLOOP.
  ENDMETHOD.
  METHOD TRANS_LOG_MSG_CREATE.
    DATA ls_trans_log_msg TYPE ZTSDLE0004.

    MOVE-CORRESPONDING lp_trans_log_msg TO ls_trans_log_msg.

    select max( contador )
      into ls_trans_log_msg-contador
      from ZTSDLE0004
      where numtransporte = ls_trans_log_msg-numtransporte and
            paso = ls_trans_log_msg-paso and
            posicion = ls_trans_log_msg-posicion.

    add 1 to ls_trans_log_msg-contador.
    ls_trans_log_msg-usucre  = sy-uname.
    ls_trans_log_msg-erdat   = sy-datum.
    ls_trans_log_msg-erzet   = sy-uzeit.

    INSERT ZTSDLE0004 FROM ls_trans_log_msg.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'trans_log_msg_create. Error al crear registro en BD' ).
    ENDIF.

    lp_trans_log_msg-contador = ls_trans_log_msg-contador.

  ENDMETHOD.
  METHOD trans_pos_create.
    DATA wl_trans_pos TYPE ztsdle0002.

    MOVE-CORRESPONDING wp_trans_pos TO wl_trans_pos.

    SELECT MAX( posicion )
      INTO wl_trans_pos-posicion
      FROM ztsdle0002
      WHERE numtransporte = wl_trans_pos-numtransporte.

    ADD 1 TO wl_trans_pos-posicion.
    wl_trans_pos-usucre  = sy-uname.
    wl_trans_pos-erdat   = sy-datum.
    wl_trans_pos-erzet   = sy-uzeit.

    INSERT ztsdle0002 FROM wl_trans_pos.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'TRANS_POS_CREATE. Error al crear registro en BD' ).
    ENDIF.

    wp_trans_pos-posicion = wl_trans_pos-posicion.

    "
    " Creamos el detalle del embalaje, según estándar.
    "
    DATA(ls_trans_cab) = trans_cab_getdetail( wl_trans_pos-numtransporte ).
    DATA ls_hu TYPE zst_sdle_transp_hu.
    DATA(lt_hu_actuales) = trans_hu_getlist( lp_numtransporte = wp_trans_pos-numtransporte lp_matnr_final = wp_trans_pos-matnr_final lp_charg = wp_trans_pos-charg ).
    LOOP AT lt_hu_actuales INTO DATA(ls_hu_actual).
      MOVE-CORRESPONDING ls_hu_actual TO ls_hu.
      trans_hu_delete( ls_hu ).
    ENDLOOP.

    " OBtener material embalaje.
    DATA lv_vhilm TYPE vhilm.
    CLEAR lv_vhilm.
    zhcl_sd_hu_core=>get_vhilm( EXPORTING lp_matnr = wl_trans_pos-matnr_final
                                          lp_werks = ls_trans_cab-werks
                                          lp_charg = wl_trans_pos-charg
                                          IMPORTING lp_vhilm = lv_vhilm ).

    "
    " Obtener datos del material
    "
    SELECT SINGLE cuobj
      INTO @DATA(vl_cuobj)
      FROM marc
      WHERE matnr EQ @wl_trans_pos-matnr_final AND
            werks EQ @ls_trans_cab-werks.

    IF sy-subrc <> 0.
      CLEAR vl_cuobj.
    ENDIF.

    SELECT SINGLE *
      INTO @DATA(wl_yhp_idx_td151)
      FROM yhp_idx_td151
      WHERE cuobj = @vl_cuobj AND
            shuty = 'UNIT'.
    IF sy-subrc <> 0.
      CLEAR wl_yhp_idx_td151.
    ENDIF.

    IF wl_yhp_idx_td151-tbqty IS INITIAL.

      DATA: lv_matnr  TYPE mara-matnr,
            lv_in_me  type  mara-meins,
            lv_out_me type  mara-meins,
            lv_menge  type  ekpo-menge.

      lv_matnr = wl_trans_pos-matnr_final.
      lv_in_me = 'PAL'.
      lv_out_me = 'ST'.
      lv_menge = 1.

      CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
        EXPORTING
          i_matnr              = lv_matnr
          i_in_me              = lv_in_me
          i_out_me             = lv_out_me
          i_menge              = lv_menge
        IMPORTING
          e_menge              = lv_menge
        EXCEPTIONS
          error_in_application = 1
          error                = 2
          OTHERS               = 3.
      IF sy-subrc <> 0.
        CLEAR lv_menge.
      ENDIF.
      wl_yhp_idx_td151-tbqty = lv_menge.
    ENDIF.

    DATA(lv_cant_pendiente) = wl_trans_pos-kwmeng_real.
    DATA(lv_num_palets) = 0.
    IF wl_yhp_idx_td151-tbqty <> 0.
      lv_num_palets = ceil( wl_trans_pos-kwmeng_real / wl_yhp_idx_td151-tbqty ).
    ENDIF.

    DO lv_num_palets TIMES.
      CLEAR ls_hu.
      ls_hu-numtransporte = wp_trans_pos-numtransporte.
      ls_hu-matnr_final = wl_trans_pos-matnr_final.
      ls_hu-charg = wl_trans_pos-charg.
      ls_hu-vhilm = lv_vhilm.
      CLEAR ls_hu-tmeng.

      IF lv_cant_pendiente < wl_yhp_idx_td151-tbqty.
        ls_hu-tmeng    = lv_cant_pendiente.
      ELSE.
        ls_hu-tmeng    = wl_yhp_idx_td151-tbqty.
      ENDIF.

      lv_cant_pendiente = lv_cant_pendiente - wl_yhp_idx_td151-tbqty.

      trans_hu_create( CHANGING wp_trans_hu = ls_hu ).
    ENDDO.



  ENDMETHOD.
  METHOD trans_pos_delete.

    "
    " Borramos primero el detalle del embalaje
    "
    DATA ls_hu TYPE zst_sdle_transp_hu.
    DATA(lt_hu_actuales) = trans_hu_getlist( lp_numtransporte = wp_trans_pos-numtransporte lp_matnr_final = wp_trans_pos-matnr_final lp_charg = wp_trans_pos-charg ).
    LOOP AT lt_hu_actuales INTO DATA(ls_hu_actual).
      MOVE-CORRESPONDING ls_hu_actual TO ls_hu.
      trans_hu_delete( ls_hu ).
    ENDLOOP.

    DELETE FROM ztsdle0002
      WHERE numtransporte = wp_trans_pos-numtransporte AND
            posicion = wp_trans_pos-posicion.
    IF sy-subrc <> 0.
      zcl_seis_odata_utils=>lanzar_excepcion( 'TRANS_POS_DELETE. Error al borrar registro en BD' ).
    ENDIF.

  ENDMETHOD.
  METHOD trans_pos_getlist.

    CLEAR tp_trans_pos.

    SELECT *
      FROM ztsdle0002
      INTO CORRESPONDING FIELDS OF TABLE tp_trans_pos
      WHERE numtransporte = vp_numtransporte.

    LOOP AT tp_trans_pos ASSIGNING FIELD-SYMBOL(<fs_trans_pos>).
      SELECT SINGLE maktx
        INTO <fs_trans_pos>-maktx_final
        FROM makt
        WHERE spras = sy-langu AND
              matnr = <fs_trans_pos>-matnr_final.
      IF sy-subrc <> 0.
        CLEAR <fs_trans_pos>-maktx_final.
      ENDIF.

      SELECT SINGLE maktx
        INTO <fs_trans_pos>-maktx_se
        FROM makt
        WHERE spras = sy-langu AND
              matnr = <fs_trans_pos>-matnr_se.
      IF sy-subrc <> 0.
        CLEAR <fs_trans_pos>-maktx_se.
      ENDIF.

      SELECT SINGLE name1
        FROM kna1
        INTO <fs_trans_pos>-name1
        WHERE kunnr = <fs_trans_pos>-kunag.
      IF sy-subrc <> 0.
        CLEAR <fs_trans_pos>-name1.
      ENDIF.

      SELECT SINGLE name1
        FROM kna1
        INTO <fs_trans_pos>-kunwe_name1
        WHERE kunnr = <fs_trans_pos>-kunwe.
      IF sy-subrc <> 0.
        CLEAR <fs_trans_pos>-kunwe_name1.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.
  METHOD ultimo_destino.
    DATA: lr_bwart TYPE RANGE OF mseg-bwart.

    CLEAR lp_ultimo_destino.

    APPEND INITIAL LINE TO lr_bwart ASSIGNING FIELD-SYMBOL(<fs_bwart>).
    <fs_bwart>-sign = 'I'.
    <fs_bwart>-option = 'EQ'.
    <fs_bwart>-low = '601'.
    APPEND INITIAL LINE TO lr_bwart ASSIGNING <fs_bwart>.
    <fs_bwart>-sign = 'I'.
    <fs_bwart>-option = 'EQ'.
    <fs_bwart>-low = '641'.

    "
    " Buscamos movimientos.
    "
    SELECT *
      FROM mseg
      INTO TABLE @DATA(tl_mseg)
      WHERE matnr = @lp_matnr AND
            charg = @lp_charg and
            bwart in @lr_bwart and
            werks = @lp_trans_cab-werks and
            lgort = @lp_trans_cab-lgort.

    LOOP AT tl_mseg ASSIGNING FIELD-SYMBOL(<fs_mseg>).
      " Ignoramos anulados.
      SELECT SINGLE *
        FROM mseg
        INTO @DATA(ls_mseg_anulacion)
        WHERE smbln = @<fs_mseg>-mblnr AND
              sjahr = @<fs_mseg>-mjahr AND
              smblp = @<fs_mseg>-zeile.
      CHECK sy-subrc <> 0.

      SELECT SINGLE *
        FROM likp
        INTO @DATA(ls_likp)
        WHERE vbeln = @<fs_mseg>-vbeln_im.
      IF sy-subrc <> 0.
        CLEAR ls_likp.
      ENDIF.

      IF <fs_mseg>-bwart = '601' and ls_likp-LFART = 'ZLF4'.
        lp_ultimo_destino = '1'.
      ENDIF.
      IF <fs_mseg>-bwart = '641' and ls_likp-LFART = 'ZNL'.
        lp_ultimo_destino = '2'.
      ENDIF.
    ENDLOOP.

  ENDMETHOD.
  METHOD validar_transporte.
    DATA: lo_excep       TYPE REF TO cx_root,
          lv_error       TYPE text255,
          lr_mtart_venta TYPE RANGE OF mara-mtart.

    CLEAR lv_error.

    CLEAR lr_mtart_venta.
    APPEND INITIAL LINE TO lr_mtart_venta ASSIGNING FIELD-SYMBOL(<fs_mtart_venta>).
    <fs_mtart_venta>-option = 'EQ'.
    <fs_mtart_venta>-sign = 'I'.
    <fs_mtart_venta>-low = 'ZPTO'.

    DATA(ls_trans_cab) = trans_cab_getdetail( lp_numtransporte ).

    DATA(lt_trans_pos) = trans_pos_getlist( lp_numtransporte ).

    IF lv_error IS INITIAL AND ls_trans_cab-destino IS INITIAL.
      lv_error = 'Debe indicar destino.'.
    ENDIF.

    IF lv_error IS INITIAL AND ls_trans_cab-wadat_ist IS INITIAL.
      lv_error = 'Debe indicar fecha movimiento.'.
    ENDIF.

    IF lv_error IS INITIAL AND ls_trans_cab-zzconductor IS INITIAL.
      lv_error = 'Debe indicar nombre del conductor'.
    ENDIF.
    IF lv_error IS INITIAL AND ls_trans_cab-zzdni IS INITIAL.
      lv_error = 'Debe indicar DNI del conductor'.
    ENDIF.
    IF lv_error IS INITIAL AND ls_trans_cab-zzmatricula IS INITIAL.
      lv_error = 'Debe indicar matrícula'.
    ENDIF.
    IF lv_error IS INITIAL AND ls_trans_cab-zztelefono IS INITIAL.
      lv_error = 'Debe indicar teléfono conductor.'.
    ENDIF.

    IF ls_trans_cab-destino = 1. " Cliente.
      LOOP AT lt_trans_pos ASSIGNING FIELD-SYMBOL(<fs_pos>).
        IF <fs_pos>-vbeln IS INITIAL AND <fs_pos>-kunag IS INITIAL.
          lv_error = 'Destino Cliente y hay posiciones sin datos ventas.'.
        ENDIF.

        SELECT SINGLE matnr
          FROM mara
          INTO @DATA(ls_mara)
          WHERE matnr = @<fs_pos>-matnr_final AND
                mtart NOT IN @lr_mtart_venta.
        IF sy-subrc = 0.
          lv_error = 'Destino Cliente y hay posiciones con materiales que no se pueden vender.'.
        ENDIF.
      ENDLOOP.
    ENDIF.

    LOOP AT lt_trans_pos ASSIGNING <fs_pos>.
      CHECK <fs_pos>-proceso = 'SC'. " Solo para subco.
      DATA(lv_ultimo_destino) = ultimo_destino( lp_matnr = <fs_pos>-matnr_final lp_charg = <fs_pos>-charg lp_trans_cab = ls_trans_cab ).
      IF ls_trans_cab-destino = 1 AND lv_ultimo_destino = '2'. "Traslado.
        lv_error = 'Material &1 y lote &2 ha tenido destino a Xàtiva. No se puede indicar destino cliente.'.
      ENDIF.
      IF ls_trans_cab-destino = 2 AND lv_ultimo_destino = '1'. "Cliente.
        lv_error = 'Material &1 y lote &2 ha tenido destino a Cliente. No se puede indicar destino Xàtiva.'.
      ENDIF.
      REPLACE ALL OCCURRENCES OF '&1' IN lv_error WITH <fs_pos>-matnr_final.
      REPLACE ALL OCCURRENCES OF '&2' IN lv_error WITH <fs_pos>-charg.
    ENDLOOP.

    "
    " Validamos estados del pedido y tolerancias de suministro.
    "
    DATA: lv_cant_ya_procesado TYPE ekbe-menge,
          lv_cant_max          TYPE ekbe-menge,
          lv_cant_lim          TYPE ekbe-menge,
          lv_txt_tmp           TYPE text25.
    LOOP AT lt_trans_pos ASSIGNING <fs_pos>.
      CHECK <fs_pos>-proceso <> 'AE'. " Excluimos almacén regulador.
      CHECK lv_error IS INITIAL.

      CLEAR: lv_cant_ya_procesado, lv_cant_max, lv_cant_lim.

      IF <fs_pos>-ebelp IS NOT INITIAL.
        SELECT SINGLE *
          FROM ekpo
          INTO @DATA(ls_ekpo)
          WHERE ebeln = @<fs_pos>-ebeln AND
                ebelp = @<fs_pos>-ebelp.
        IF sy-subrc <> 0.
          CLEAR ls_ekpo.
        ENDIF.

        IF ls_ekpo-elikz IS NOT INITIAL.
          lv_error = 'Posición del pedido &1 &2 está marcada como "Entrega final". No se puede continuar.'.
          REPLACE ALL OCCURRENCES OF '&1' IN lv_error WITH <fs_pos>-ebeln.
          REPLACE ALL OCCURRENCES OF '&2' IN lv_error WITH <fs_pos>-ebelp.
        ENDIF.
        CHECK lv_error IS INITIAL.

        SELECT *
          FROM ekbe
          INTO TABLE @DATA(lt_ekbe)
          WHERE ebeln = @ls_ekpo-ebeln AND
                ebelp = @ls_ekpo-ebelp AND
                bewtp = 'E'.
        LOOP AT lt_ekbe ASSIGNING FIELD-SYMBOL(<fs_ekbe>).
          IF <fs_ekbe>-bwart = '101'.
            ADD <fs_ekbe>-menge TO lv_cant_ya_procesado.
          ELSE.
            SUBTRACT <fs_ekbe>-menge FROM lv_cant_ya_procesado.
          ENDIF.
        ENDLOOP.

        IF ls_ekpo-uebtk IS INITIAL. " no es ilimitado.
          lv_cant_max = ls_ekpo-menge * ( 1 + ls_ekpo-uebto / 100 ).
          lv_cant_lim = lv_cant_max - lv_cant_ya_procesado.
          IF ( lv_cant_ya_procesado + <fs_pos>-kwmeng_real ) > lv_cant_max.
*            lv_error = 'La cantidad indicada excede el máximo permitido en el pedido.'.
            lv_error = 'La cantidad indicada &1 excede el máximo permitido &2 en el pedido &3 &4.'.
            WRITE <fs_pos>-kwmeng_real TO lv_txt_tmp UNIT <fs_pos>-vrkme.
            CONDENSE lv_txt_tmp.
            REPLACE ALL OCCURRENCES OF '&1' IN lv_error WITH lv_txt_tmp.

            WRITE lv_cant_lim TO lv_txt_tmp UNIT <fs_pos>-vrkme.
            CONDENSE lv_txt_tmp.
            REPLACE ALL OCCURRENCES OF '&2' IN lv_error WITH lv_txt_tmp.

            WRITE <fs_pos>-ebeln TO lv_txt_tmp.
            CONDENSE lv_txt_tmp.
            REPLACE ALL OCCURRENCES OF '&3' IN lv_error WITH lv_txt_tmp.

            WRITE <fs_pos>-ebelp TO lv_txt_tmp.
            CONDENSE lv_txt_tmp.
            REPLACE ALL OCCURRENCES OF '&4' IN lv_error WITH lv_txt_tmp.
          ENDIF.
        ENDIF.

      ENDIF.



***      CHECK lv_error IS INITIAL.
***
***      CLEAR: lv_cant_ya_procesado, lv_cant_max.
***
***      IF <fs_pos>-posnr IS NOT INITIAL.
***        SELECT SINGLE *
***          FROM vbap
***          INTO @DATA(ls_vbap)
***          WHERE vbeln = @<fs_pos>-vbeln AND
***                posnr = @<fs_pos>-posnr.
***        IF sy-subrc <> 0.
***          CLEAR ls_vbap.
***        ENDIF.
***
***        SELECT SINGLE *
***          FROM vbup
***          INTO @DATA(wl_vbup)
***          WHERE vbeln = @<fs_pos>-vbeln AND
***                posnr = @<fs_pos>-posnr.
***        IF sy-subrc <> 0.
***          CLEAR wl_vbup.
***        ENDIF.
***        IF wl_vbup-gbsta = 'C'.
***          lv_error = 'Posición del pedido &1 &2 de venta está concluida. No se puede continuar.'.
***          REPLACE ALL OCCURRENCES OF '&1' IN lv_error WITH <fs_pos>-vbeln.
***          REPLACE ALL OCCURRENCES OF '&2' IN lv_error WITH <fs_pos>-posnr.
***        ENDIF.
***        CHECK lv_error IS INITIAL.
***
***        IF ls_trans_cab-destino = 1.
***          SELECT *
***            FROM vbfa
***            INTO TABLE @DATA(lt_vbfa)
***            WHERE vbelv = @<fs_pos>-vbeln AND
***                  posnv = @<fs_pos>-posnr AND
***                  vbtyp_n = 'J'.
***
***          LOOP AT lt_vbfa ASSIGNING FIELD-SYMBOL(<fs_vbfa>).
***            DATA ls_menge TYPE ekpo-menge.
***            ls_menge = <fs_vbfa>-rfmng.
***            CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
***              EXPORTING
***                i_matnr              = ls_vbap-matnr
***                i_in_me              = <fs_vbfa>-meins
***                i_out_me             = ls_vbap-vrkme
***                i_menge              = ls_menge
***              IMPORTING
***                e_menge              = ls_menge
***              EXCEPTIONS
***                error_in_application = 1
***                error                = 2
***                OTHERS               = 3.
***            IF sy-subrc <> 0.
***              CLEAR ls_menge.
***            ENDIF.
***
***            ADD ls_menge TO lv_cant_ya_procesado.
***
***          ENDLOOP.
***
***
***          IF ls_vbap-uebtk IS INITIAL. " no es ilimitado.
***            lv_cant_max = ls_vbap-klmeng * ( 1 + ls_vbap-uebto / 100 ).
***            lv_cant_lim = lv_cant_max - lv_cant_ya_procesado.
***            IF ( lv_cant_ya_procesado + <fs_pos>-kwmeng_real ) > lv_cant_max.
***              lv_error = 'La cantidad indicada &1 excede el máximo permitido &2 en el documento de venta &3 &4.'.
***              WRITE <fs_pos>-kwmeng_real TO lv_txt_tmp UNIT <fs_pos>-vrkme.
***              CONDENSE lv_txt_tmp.
***              REPLACE ALL OCCURRENCES OF '&1' IN lv_error WITH lv_txt_tmp.
***
***              WRITE lv_cant_lim TO lv_txt_tmp UNIT <fs_pos>-vrkme.
***              CONDENSE lv_txt_tmp.
***              REPLACE ALL OCCURRENCES OF '&2' IN lv_error WITH lv_txt_tmp.
***
***              WRITE <fs_pos>-vbeln TO lv_txt_tmp.
***              CONDENSE lv_txt_tmp.
***              REPLACE ALL OCCURRENCES OF '&3' IN lv_error WITH lv_txt_tmp.
***
***              WRITE <fs_pos>-posnr TO lv_txt_tmp.
***              CONDENSE lv_txt_tmp.
***              REPLACE ALL OCCURRENCES OF '&4' IN lv_error WITH lv_txt_tmp.
***            ENDIF.
***          ENDIF.
***        ENDIF.
***      ENDIF.

    ENDLOOP.


    "
    " Lanzar error si lo hay
    "
    IF lv_error IS NOT INITIAL.
      zcl_seis_odata_utils=>lanzar_excepcion( message = lv_error ).
    ENDIF.

  ENDMETHOD.
