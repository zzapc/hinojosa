<?xml version="1.0" encoding="utf-8"?> <ENHO enhancement_id="ZSSD_ENH_NUMBER_RANGE" shorttext="Determinar rango" tooltype_id="HOOK_IMPL" orig_object="R3TR-V60A-FUGR-SAPLV60A">  <asx:abap xmlns:asx="http://www.sap.com/abapxml" version="1.0">   <asx:values>
    <IMPLS>     <ENH_HOOK_IMPL>      <SPOTNAME/>      <PROGRAMNAME>SAPLV60A</PROGRAMNAME>      <EXTID>1</EXTID>      <ID>1</ID>      <OVERWRITE/>      <METHOD/>      <ENHMODE>D</ENHMODE>      <FULL_NAME>\PR:SAPLV60A\FO:USEREXIT_NUMBER_RANGE\SE:BEGIN\EI</F
ULL_NAME>      <SOURCE>       <item>*</item>       <item>*  DATA: wa_ztsd0005 TYPE ztsd0005.</item>       <item>*</item>       <item>*  IF vbrk-vkorg = &apos;4000&apos;.</item>       <item>*    SELECT SINGLE * FROM ztsd0005</item>       <item>*      INTO
wa_ztsd0005</item>       <item>*      WHERE vkorg = vbrk-vkorg AND</item>       <item>*            fkart = vbrk-fkart AND</item>       <item>*            gjahr = vbrk-fkdat(4).</item>       <item>*</item>       <item>*    IF sy-subrc = 0.</item>       <it
em>*      us_range_intern = wa_ztsd0005-nrnr.</item>       <item>*</item>       <item>**     Si la fecha de la factura que estamos creando (XVBRK-FKDAT) es menor</item>       <item>**     que la fecha recuperada de la tabla de control (campo FKDAT, fecha<
/item>       <item>**     ultima factura), se mostrara un mensaje de error informando de las</item>       <item>**     dos fechas y del rango de números afectado.</item>       <item>*      IF xvbrk-fkdat &lt; wa_ztsd0005-fkdat.</item>       <item>**
 Fecha de factura anterior a la ultima factura generada (rango XX fecha DD.MM.YYYY)</item>       <item>*        MESSAGE i056(zsd) WITH &apos;Fecha de factura anterior a fecha&apos;</item>       <item>*                               xvbrk-fkdat</item>
  <item>*                               &apos;(fecha de la ultima factura) con rango&apos;</item>       <item>*                               us_range_intern.</item>       <item>*      ELSE.</item>       <item>**       En caso contrario, se actualizará la
 tabla de control, con la fecha</item>       <item>**       de la factura que creamos (XVBRK-FKDAT). El código abap sería similar</item>       <item>**       a algo así (copiado de un cliente donde esta implementado este mismo control).</item>       <item
>*        wa_ztsd0005-fkdat = xvbrk-fkdat.</item>       <item>*        UPDATE ztsd0005 FROM wa_ztsd0005.</item>       <item>*      ENDIF.</item>       <item>*    ENDIF.</item>       <item>*  ELSE.</item>       <item/>       <item>CASE tvfk-vbtyp.</item>
     <item>WHEN &apos;O&apos; OR&apos;5&apos; OR &apos;6&apos; OR &apos;U&apos; OR &apos;S&apos; OR &apos;7&apos;.</item>       <item>CASE vbrk-vkorg.</item>       <item>WHEN &apos;2000&apos; OR &apos;2001&apos;OR &apos;2004&apos;.</item>       <item>PERF
ORM determinar_rango(zssd009_factura) USING vbrk vbrp CHANGING us_range_intern.</item>       <item>ENDCASE.</item>       <item>ENDCASE.</item>       <item/>       <item/>       <item>* EBA. 28/08/2016. La facturación de cada una de las org. ventas se debe
</item>       <item>* realizar en rangos diferenciados.</item>       <item>* Se diferencia entre FACTURAS POSITIVAS (Facturas y Cargos) y las</item>       <item>* FACTURAS NEGATIVAS (Abonos y Devoluciones), incluyendo sus</item>       <item>* correspondie
ntes anulaciones.</item>       <item>IF tvfk-vbtyp = &apos;M&apos; OR  &quot;FACTURAS POSITIVAS SD.</item>       <item>tvfk-vbtyp = &apos;N&apos; OR  &quot;ANULACIÓN FACTURAS POSITIVAS SD.</item>       <item>tvfk-vbtyp = &apos;P&apos;  .  &quot;CARGOS SD.
</item>       <item>CASE vbrk-vkorg.</item>       <item>*       WHEN &apos;2000&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>* ASB. 06/03/2023 Ticket 75765. Ampliación rangos para 2004</item>       <item>WHEN &apos;2000&apos; OR &apos;2001&a
pos; OR &apos;2004&apos;.</item>       <item>PERFORM determinar_rango(zssd009_factura) USING vbrk vbrp CHANGING us_range_intern.</item>       <item>*       WHEN &apos;2010&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2020&
apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2030&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2040&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2050&apos;.
 US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2060&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2070&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>WHEN &apos;3000&apos;. us_range_inte
rn = &apos;19&apos;.</item>       <item>WHEN &apos;3020&apos;. us_range_intern = &apos;20&apos;.</item>       <item>WHEN &apos;4000&apos;.</item>       <item>IF tvfk-vbtyp = &apos;M&apos;.</item>       <item>IF tvfk-fkart = &apos;ZF22&apos; OR tvfk-fkart
= &apos;ZF23&apos;.</item>       <item>us_range_intern = &apos;50&apos;.</item>       <item>ELSEIF tvfk-fkart = &apos;ZTAR&apos;. &quot;JISS - SAT 7000029063 - Ajueste rango numeros de factura</item>       <item>us_range_intern = &apos;54&apos;.</item>
    <item>ENDIF.</item>       <item/>       <item>ELSEIF  tvfk-vbtyp = &apos;P&apos;.</item>       <item>us_range_intern = &apos;52&apos;.</item>       <item/>       <item>ELSEIF tvfk-vbtyp = &apos;N&apos;.</item>       <item>IF tvfk-fkart = &apos;ZS1&apo
s;.</item>       <item>us_range_intern = &apos;50&apos;.</item>       <item>ELSEIF tvfk-fkart = &apos;ZS4&apos;. &quot;JISS - SAT 7000029063 - Ajueste rango numeros de factura</item>       <item>us_range_intern = &apos;52&apos;.</item>       <item>ENDIF.<
/item>       <item>ENDIF.</item>       <item>ENDCASE.</item>       <item/>       <item>ELSEIF ( tvfk-vbtyp = &apos;5&apos; OR tvfk-vbtyp = &apos;6&apos; )  &quot;FACTURAS INTERCO.</item>       <item>AND   tvfk-blart = &apos;DR&apos;                   .
&quot;FACTURAS DE CARGO. Ejemplo ZIV y ZIVS</item>       <item>CASE vbrk-vkorg.</item>       <item>*       WHEN &apos;2000&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2001&apos;. US_RANGE_INTERN = &apos; &apos;.</item>
    <item>*       WHEN &apos;2010&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2020&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2030&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <i
tem>*       WHEN &apos;2040&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2050&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2060&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*
      WHEN &apos;2070&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>WHEN &apos;3000&apos;. us_range_intern = &apos;19&apos;.</item>       <item>WHEN &apos;3020&apos;. us_range_intern = &apos;20&apos;.</item>       <item>*       WHEN &apos;400
0&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>ENDCASE.</item>       <item>ELSEIF tvfk-vbtyp = &apos;O&apos; OR  &quot;FACTURAS NEGATIVAS.</item>       <item>tvfk-vbtyp = &apos;S&apos; .   &quot;ANULACIÓN FACTURAS NEGATIVAS.</item>       <it
em>CASE vbrk-vkorg.</item>       <item>*       WHEN &apos;2000&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2001&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2010&apos;. US_RANGE_INTERN = &
apos; &apos;.</item>       <item>*       WHEN &apos;2020&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2030&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2040&apos;. US_RANGE_INTERN = &apos;
&apos;.</item>       <item>*       WHEN &apos;2050&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2060&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2070&apos;. US_RANGE_INTERN = &apos; &apos;
.</item>       <item>WHEN &apos;3000&apos;. us_range_intern = &apos;25&apos;.</item>       <item>WHEN &apos;3020&apos;. us_range_intern = &apos;26&apos;.</item>       <item>WHEN &apos;4000&apos;.</item>       <item>IF tvfk-vbtyp = &apos;O&apos;.</item>
    <item>IF tvfk-fkart = &apos;ZG2&apos;.</item>       <item>us_range_intern = &apos;51&apos;.</item>       <item>ELSEIF tvfk-fkart = &apos;ZRE&apos;.</item>       <item>us_range_intern = &apos;53&apos;.</item>       <item>ELSEIF tvfk-fkart = &apos;ZRE2&
apos;.</item>       <item>us_range_intern = &apos;54&apos;.</item>       <item>ENDIF.</item>       <item>ELSEIF  tvfk-vbtyp = &apos;S&apos;.</item>       <item>IF tvfk-fkart = &apos;ZS2&apos;.</item>       <item>us_range_intern = &apos;51&apos;.</item>
    <item>ELSEIF tvfk-fkart = &apos;ZS3&apos;.</item>       <item>us_range_intern = &apos;53&apos;.</item>       <item>ENDIF.</item>       <item>ENDIF.</item>       <item/>       <item>ENDCASE.</item>       <item>ELSEIF ( tvfk-vbtyp = &apos;5&apos; OR tvf
k-vbtyp = &apos;6&apos; )  &quot;FACTURAS INTERCO.</item>       <item>AND   tvfk-blart = &apos;DG&apos;                   .   &quot;FACTURAS DE ABONOS. Ejemplo ZIG y ZIGS</item>       <item>CASE vbrk-vkorg.</item>       <item>*       WHEN &apos;2000&apos;
. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2001&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2010&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2020&apos;. US_R
ANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2030&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2040&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2050&apos;. US_RANGE_I
NTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2060&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>*       WHEN &apos;2070&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>WHEN &apos;3000&apos;. us_range_intern = &apos;
25&apos;.</item>       <item>WHEN &apos;3020&apos;. us_range_intern = &apos;26&apos;.</item>       <item>*       WHEN &apos;4000&apos;. US_RANGE_INTERN = &apos; &apos;.</item>       <item>ENDCASE.</item>       <item>ENDIF.</item>       <item/>       <item
/>       <item/>       <item>DATA: ls_vbrk    TYPE vbrkvb,</item>       <item>lv_nrlevel TYPE nrlevel,</item>       <item>lv_vbeln   TYPE vbeln_vf,</item>       <item>lv_fkdat   TYPE fkdat,</item>       <item>lv_fkart   TYPE vbrk-fkart,</item>       <item
>lv_vkorg   TYPE vbrk-vkorg,</item>       <item>lv_belnr   TYPE belnr_d,</item>       <item>lv_fi_doc  TYPE belnr_d,</item>       <item>lv_gjahr   TYPE gjahr.</item>       <item/>       <item>DATA: zzvbrk    TYPE TABLE OF vbrkvb,</item>       <item>ls_zzv
brk TYPE vbrkvb.</item>       <item/>       <item>* Control de fechas para la factura</item>       <item/>       <item>&quot;JCB 86127 - Bloqueo de facturacion en clase de entrega ZLR</item>       <item>IF sy-tcode EQ &apos;VF11&apos; OR</item>       <ite
m>sy-tcode EQ &apos;VF01&apos; OR</item>       <item>sy-tcode EQ &apos;VF04&apos; OR</item>       <item>sy-tcode EQ &apos;VF06&apos;.</item>       <item/>       <item>*   Fecha no posterior al día en curso</item>       <item>IF vbrk-fkdat GT sy-datum.</it
em>       <item>&quot; Añadimos el error al log</item>       <item>PERFORM vbfs_hinzufuegen_allg USING  vbap-vbeln</item>       <item>vbap-posnr</item>       <item>&apos;ZSD&apos;</item>       <item>&apos;E&apos;</item>       <item>&apos;222&apos;</item>
      <item>space</item>       <item>space</item>       <item>space</item>       <item>space.</item>       <item>MESSAGE e222(zsd).     &quot; La fecha de factura no debe ser posterior al día en curso</item>       <item>ELSE.</item>       <item/>       <i
tem/>       <item>IF zcl_ap_exits=&gt;exit_activa( &apos;SD_CONTROL_FECHA_ULT_FAC&apos; ) = &apos;X&apos;.</item>       <item/>       <item>&quot;Verificamos la fecha de la ultima factura generada para este rango</item>       <item>SELECT SINGLE nrlevel F
ROM nriv</item>       <item>INTO lv_nrlevel</item>       <item>WHERE object    EQ &apos;RV_BELEG&apos; AND</item>       <item>nrrangenr EQ us_range_intern. &quot;LV_NUMKI.</item>       <item/>       <item>IF sy-subrc EQ 0.</item>       <item>lv_vbeln = lv
_nrlevel+10.</item>       <item/>       <item>SELECT SINGLE fkdat vkorg fkart</item>       <item>FROM vbrk</item>       <item>INTO (lv_fkdat, lv_vkorg, lv_fkart)</item>       <item>WHERE vbeln EQ lv_vbeln.</item>       <item>IF sy-subrc = 0.</item>
<item>IF vbrk-vkorg &lt;&gt; lv_vkorg OR vbrk-fkart &lt;&gt; lv_fkart.</item>       <item>CLEAR lv_fkdat.</item>       <item>ENDIF.</item>       <item>ELSE.</item>       <item>&quot;Ojo!! Puede que la última factura no sea una de la base de datos, sino un
a que acabamos de generar en el tratamiento del pool de facturación!!!</item>       <item>CLEAR zzvbrk.</item>       <item>REFRESH zzvbrk[].</item>       <item>zzvbrk[] = xvbrk[].</item>       <item>CLEAR ls_zzvbrk.</item>       <item>READ TABLE zzvbrk IN
TO ls_zzvbrk WITH KEY vbeln = lv_vbeln .</item>       <item>IF sy-subrc = 0 AND ls_zzvbrk-vkorg = vbrk-vkorg AND vbrk-fkart = lv_fkart.</item>       <item>lv_fkdat = ls_zzvbrk-fkdat.</item>       <item>ENDIF.</item>       <item>ENDIF.</item>       <item>*
  ** &lt;--</item>       <item/>       <item>&quot;Si no se ha encontrado, tendremos que buscar la última factura (por numerador) generada para esta org. ventas</item>       <item>IF lv_fkdat IS INITIAL.</item>       <item>SELECT SINGLE MAX( vbeln )</item
>       <item>INTO lv_vbeln</item>       <item>FROM vbrk</item>       <item>WHERE vkorg = vbrk-vkorg AND</item>       <item>fkart = vbrk-fkart.</item>       <item>IF sy-subrc = 0.</item>       <item>SELECT SINGLE fkdat</item>       <item>FROM vbrk</item>
      <item>INTO lv_fkdat</item>       <item>WHERE vbeln EQ lv_vbeln.</item>       <item>ENDIF.</item>       <item>ENDIF.</item>       <item/>       <item>&quot;Fecha de factura no anterior a la de la última factura generada</item>       <item>*        IF
 vbrk-vkorg &lt;&gt; &apos;2000&apos;. &quot;TODO JCB: Ñapa por ahora.</item>       <item>IF vbrk-fkdat LT lv_fkdat.</item>       <item>&quot; Añadimos el error al log</item>       <item>PERFORM vbfs_hinzufuegen_allg USING  vbap-vbeln</item>       <item>v
bap-posnr</item>       <item>&apos;ZSD&apos;</item>       <item>&apos;E&apos;</item>       <item>&apos;223&apos;</item>       <item>lv_fkdat</item>       <item>space</item>       <item>space</item>       <item>space.</item>       <item/>       <item>MESSA
GE e223(zsd) WITH lv_fkdat.  &quot; La fecha de factura debe ser posterior o igual a la fecha &amp;</item>       <item>ENDIF.</item>       <item>*      ENDIF.</item>       <item>ENDIF.</item>       <item>ENDIF.</item>       <item>ENDIF.</item>       <item
>ENDIF.</item>       <item/>       <item>* Control de fechas para la anulación de factura</item>       <item>IF sy-tcode EQ &apos;VF11&apos;.</item>       <item>*   Buscamos los datos de la factura que esta siendo anulada</item>       <item>READ TABLE xvb
rk INTO ls_vbrk WITH KEY vbeln = xvbrk-sfakn.</item>       <item>IF sy-subrc EQ 0 .</item>       <item>IF  ls_vbrk-rfbsk NE &apos;C&apos;.</item>       <item>*        Añadimos el error al log</item>       <item>PERFORM vbfs_hinzufuegen_allg USING   xvbrp-
vbeln</item>       <item>xvbrp-posnr</item>       <item>&apos;ZSD&apos;</item>       <item>&apos;E&apos;</item>       <item>&apos;224&apos;</item>       <item>space</item>       <item>space</item>       <item>space</item>       <item>space.</item>       <
item>MESSAGE e224(zsd).  &quot;No es posible anular, factura no contabilizada</item>       <item>ENDIF.</item>       <item>SELECT SINGLE belnr gjahr</item>       <item>INTO (lv_belnr, lv_gjahr)</item>       <item>FROM bkpf</item>       <item>WHERE bukrs E
Q ls_vbrk-bukrs</item>       <item>AND awtyp EQ &apos;VBRK&apos;</item>       <item>AND awkey EQ ls_vbrk-vbeln.</item>       <item>IF sy-subrc = 0.</item>       <item>SELECT SINGLE belnr</item>       <item>INTO lv_fi_doc</item>       <item>FROM bsad</item
>       <item>WHERE bukrs EQ ls_vbrk-bukrs</item>       <item>AND belnr EQ lv_belnr</item>       <item>AND gjahr EQ lv_gjahr</item>       <item>AND kunnr EQ ls_vbrk-kunrg.</item>       <item>IF sy-subrc = 0.</item>       <item>&quot; Añadimos el error al
log</item>       <item>PERFORM vbfs_hinzufuegen_allg USING   xvbrp-vbeln</item>       <item>xvbrp-posnr</item>       <item>&apos;ZSD&apos;</item>       <item>&apos;E&apos;</item>       <item>&apos;225&apos;</item>       <item>space</item>       <item>spac
e</item>       <item>space</item>       <item>space.</item>       <item>MESSAGE e225(zsd).   &quot; No es posible anular, factura compensada en contabilidad</item>       <item>ENDIF.</item>       <item>ENDIF.</item>       <item>ENDIF.</item>       <item>E
NDIF.</item>       <item/>       <item>&quot;ASC 06.02.24 &gt;&gt;&gt; GAPSD041 Facturación de pallets.</item>       <item>***  SELECT SINGLE kunnr, vkorg, vtweg, spart, zzpallet_cobro</item>       <item>***    FROM knvv</item>       <item>***    INTO @DA
TA(ls_knvv)</item>       <item>***    WHERE kunnr = @vbrk-kunag</item>       <item>***      AND vkorg = @vbrk-vkorg</item>       <item>***      AND vtweg = @vbrk-vtweg</item>       <item>***      AND spart = @vbrk-spart.</item>       <item>***  IF sy-subr
c = 0 AND ls_knvv-zzpallet_cobro EQ abap_true. &quot;Es un cliente de Facturación de pallets</item>       <item>***    LOOP AT xvbrp[] INTO DATA(ls_vbrp).</item>       <item>***      SELECT SINGLE matnr, mtart</item>       <item>***        FROM mara</item
>       <item>***        INTO @DATA(ls_mara)</item>       <item>***        WHERE matnr = @ls_vbrp-matnr.</item>       <item>***      IF sy-subrc = 0 AND ls_mara-mtart EQ &apos;ZPAL&apos;. &quot;El material es un palet</item>       <item>***        READ TA
BLE xkomv[] INTO DATA(ls_komv) WITH KEY kposn = ls_vbrp-posnr</item>       <item>***                                                       kschl = &apos;ZPAL&apos;.</item>       <item>***        IF sy-subrc &lt;&gt; 0 OR ls_komv-kbetr IS INITIAL.</item>
     <item>***          MESSAGE e040(zsd) WITH vbrk-fkart. &quot;Sin importe en posición de palet. Cliente relevante para su facturación</item>       <item>***        ENDIF.</item>       <item>****        SELECT SINGLE KNUMV, KPOSN, STUNR, ZAEHK, kwert</i
tem>       <item>****          FROM konv</item>       <item>****          INTO @DATA(ls_konv)</item>       <item>****          WHERE kschl = &apos;ZPAL&apos;</item>       <item>****            AND knumv = @vbak-knumv.</item>       <item>****        IF sy-
subrc &lt;&gt; 0 or ls_konv-kwert IS INITIAL.</item>       <item>****          MESSAGE e040(zsd) WITH vbrk-fkart. &quot;Sin importe en posición de palet. Cliente relevante para su facturación</item>       <item>****        ENDIF.</item>       <item>***
   ENDIF.</item>       <item>***    ENDLOOP.</item>       <item>***  ENDIF.</item>       <item/>       <item>&quot;Recorremos los destinatarios de mercancía</item>       <item>LOOP AT xvbpa[] INTO DATA(ls_vbpa) WHERE parvw = &apos;WE&apos;.</item>       <
item>&quot;Revisamos si es un cliente de Facturación de pallets</item>       <item>SELECT SINGLE kunnr, vkorg, vtweg, spart, zzpallet_cobro</item>       <item>FROM knvv</item>       <item>INTO @DATA(ls_knvv)</item>       <item>WHERE kunnr = @ls_vbpa-kunnr
</item>       <item>AND vkorg = @vbrk-vkorg</item>       <item>AND vtweg = @vbrk-vtweg</item>       <item>AND spart = @vbrk-spart.</item>       <item>IF sy-subrc = 0 AND ls_knvv-zzpallet_cobro EQ abap_true.</item>       <item>&quot;Obtenemos su posición d
e facturación</item>       <item>read table xvbrp[] into data(ls_vbrp) with key posnr = ls_vbpa-posnr.</item>       <item>if sy-subrc = 0.</item>       <item>&quot;Buscamos su posición relacionada atraves de la HU</item>       <item>select SINGLE * from v
epo into @data(ls_vepo) where vbeln = @ls_vbrp-vgbel</item>       <item>and posnr = @ls_vbrp-vgpos.</item>       <item>if sy-subrc = 0.</item>       <item>select SINGLE * from vekp into @data(ls_vekp) where venum =  @ls_vepo-venum.</item>       <item>if s
y-subrc = 0.</item>       <item>&quot;Con la posición vinculada que hemos encontrado, obtenemos la de la factura correspondiente.</item>       <item>read table xvbrp[] into data(ls_vbrp_zpal) with key vgpos = LS_VEKP-POSNR_GEN.</item>       <item>if sy-su
brc = 0.</item>       <item>&quot;Si la encontramos, revisamos si su posición tiene ZPAL.</item>       <item>READ TABLE xkomv[] INTO DATA(ls_komv) WITH KEY kposn = ls_vbrp_zpal-posnr &quot;LS_VEKP-POSNR_GEN</item>       <item>kschl = &apos;ZPAL&apos;.</it
em>       <item>IF sy-subrc &lt;&gt; 0 OR ls_komv-kbetr IS INITIAL.</item>       <item>MESSAGE e040(zsd) WITH vbrk-fkart. &quot;Sin importe en posición de palet. Cliente relevante para su facturación</item>       <item>RETURN.</item>       <item>ENDIF.</i
tem>       <item>ENDIF.</item>       <item>ENDIF.</item>       <item>ENDIF.</item>       <item>ENDIF.</item>       <item>ENDIF.</item>       <item>ENDLOOP.</item>       <item>&quot;ASC 06.02.24 &lt;&lt;&lt; GAPSD041 Facturación de pallets.</item>       <i
tem/>       <item>&quot;ASC &gt;&gt;&gt; 25.03.24 Nuevo chequeo facturar precio 0</item>       <item>DATA: lv_netwr type	netwr_fp.</item>       <item>CLEAR: lv_netwr.</item>       <item>LOOP AT xvbrp[] INTO DATA(ls_xvbrp) WHERE pstyv = &apos;ZTCS&apos;.</
item>       <item>IF ls_xvbrp-netwr IS INITIAL OR ls_xvbrp-netwr = lv_netwr.</item>       <item>PERFORM vbfs_hinzufuegen_allg USING ls_xvbrp-vgbel</item>       <item>ls_xvbrp-vgpos</item>       <item>&apos;ZSD&apos;</item>       <item>&apos;E&apos;</item>
       <item>&apos;310&apos;</item>       <item>&apos;ZTCS&apos;</item>       <item>space</item>       <item>space</item>       <item>space.</item>       <item>MESSAGE e310(zsd) WITH ls_xvbrp-vgbel ls_xvbrp-vgpos &apos;ZTCS&apos;. &quot; &amp;1 /&amp;2 Po
sición &amp;3 con precio 0.</item>       <item>RETURN.</item>       <item>ENDIF.</item>       <item>ENDLOOP.</item>       <item>&quot;ASC &lt;&lt;&lt; 25.03.24 Nuevo chequeo facturar precio 0</item>       <item/>       <item/>       <item/>       <item/>
     </SOURCE>      <PARENT_FULL_NAME/>     </ENH_HOOK_IMPL>    </IMPLS>   </asx:values>  </asx:abap> </ENHO>
