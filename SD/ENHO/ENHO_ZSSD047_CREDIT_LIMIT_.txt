<?xml version="1.0" encoding="utf-8"?> <ENHO enhancement_id="ZSSD047_CREDIT_LIMIT" shorttext="Aplicar porcentaje al limite de credito" tooltype_id="HOOK_IMPL" orig_object="R3TR-SAPMF02C-PROG-SAPMF02C">  <asx:abap xmlns:asx="http://www.sap.com/abapxml" ver
sion="1.0">   <asx:values>    <IMPLS>     <ENH_HOOK_IMPL>      <SPOTNAME/>      <PROGRAMNAME>SAPMF02C</PROGRAMNAME>      <EXTID>1</EXTID>      <ID>1</ID>      <OVERWRITE/>      <METHOD/>      <ENHMODE>D</ENHMODE>      <FULL_NAME>\PR:SAPMF02C\FO:KNKK_LESEN
\SE:END\EI</FULL_NAME>      <SOURCE>       <item>**** FPR - 03.03.2022 09:46:55</item>       <item>**** HEDK919092</item>       <item>*  DATA: x_porcentaje TYPE zssdt047_por_ext.</item>       <item>*</item>       <item>*  IF knkk-dbpay = &apos;ZCO&apos;.<
/item>       <item>*    &quot;Obtenemos el porcentaje a aplicar desde la tabla ZSSDT047_POR_EXT</item>       <item>*    SELECT SINGLE *</item>       <item>*      INTO x_porcentaje</item>       <item>*      FROM zssdt047_por_ext</item>       <item>*      W
HERE ctlpc = knkk-ctlpc</item>       <item>*        AND kkber = knkk-kkber.</item>       <item>*</item>       <item>*    IF sy-subrc = 0.</item>       <item>*      knkk-klimk = knka-klime = knkk-dbekr + ( knkk-dbekr * ( 1 + ( x_porcentaje-porcentaje / 100
 ) ) ) / 100.</item>       <item>*      knka-klimg = &apos;999999999.99&apos;. &quot;Aplicamos este valor por el funcionamiento de HINOJOSA. (mail --&gt; Gestión de crédito)</item>       <item>*      knkk-dbwae = t014-waers.</item>       <item>*    ENDIF.
</item>       <item>*</item>       <item>*    &quot;Recalculamos porcentaje de agotamiento</item>       <item>*    PERFORM ausschoepfungsgrad_berechnen USING knkk-klimk</item>       <item>*                                               rf02l-oblig</item>
      <item>*                                               rf02l-klprz.</item>       <item>*  ENDIF.</item>       <item>**** FIN FPR</item>      </SOURCE>      <PARENT_FULL_NAME/>     </ENH_HOOK_IMPL>     <ENH_HOOK_IMPL>      <SPOTNAME/>      <PROGRAMNAM
E>SAPMF02C</PROGRAMNAME>      <EXTID>2</EXTID>      <ID>2</ID>      <OVERWRITE/>      <METHOD/>      <ENHMODE>D</ENHMODE>      <FULL_NAME>\PR:SAPMF02C\FO:KNKK_KONSISTENZCHECK\SE:BEGIN\EI</FULL_NAME>      <SOURCE>       <item>**** fpr - 03.03.2022 13:01:04
</item>       <item>**** HEDK919092</item>       <item/>       <item>DATA: lv_dif       TYPE klimk,</item>       <item>lv_new       TYPE dbekr_cm,</item>       <item>lv_came_from TYPE char1.</item>       <item/>       <item>DATA vl_tipo TYPE zssdedtipocyc
.</item>       <item/>       <item>SELECT SINGLE tipo FROM zssdt_cyc_custo</item>       <item>INTO vl_tipo</item>       <item>WHERE kkber = knkk-kkber.</item>       <item>&quot;Limitamos que se ejecute el codigo para que cuando se navegue entre ventanas s
in haber guardado en BBDD,</item>       <item>&quot;no recalcule los importes del limite de credito. Lo hacemos con el sy-ucomm</item>       <item>IF vl_tipo = &apos;001&apos;.</item>       <item/>       <item>IF knkk-dbpay = &apos;ZCO&apos; AND ( sy-ucom
m IS INITIAL OR sy-ucomm  = &apos;&amp;ONT&apos;</item>       <item>OR sy-ucomm = &apos;UPDA&apos; OR sy-ucomm = &apos;S+&apos;).</item>       <item/>       <item>&quot;MTS: 04.01.2024 No se usa el ZZRIESGO en 2001</item>       <item>*        &quot; Inici
o BG 08.11.2023 - GAPSD048 - Nuevo campo Riesgo Interno</item>       <item>*        IF knkk-zzriesgo &lt;&gt; *knkk-zzriesgo.</item>       <item>*          knkk-klimk = knkk-zzriesgo + knkk-dbekr.</item>       <item>*          knkk-zzfechariesgo = sy-datu
m.</item>       <item>*          DATA(lv_change) = abap_true. &quot; Si ha cambiado el riesgo o el Riesgo CYC en pantalla, entonces calcula klimk</item>       <item>*        ELSEIF knkk-dbekr &lt;&gt; *knkk-dbekr.</item>       <item>*          knkk-klimk
= knkk-zzriesgo + knkk-dbekr.</item>       <item>*          lv_change = abap_true.</item>       <item>*        ENDIF.</item>       <item>*        &quot; Fin BG 08.11.2023 - GAPSD048 - Nuevo campo Riesgo Interno</item>       <item/>       <item/>       <it
em>*        IF lv_change EQ abap_true. &quot; Inicio BG 08.11.2023 - GAPSD048 - Se agrega la validación si ha cambiado el valor</item>       <item>&quot;FIN MTS: 04.01.2024 No se usa el ZZRIESGO en 2001</item>       <item/>       <item>&quot;Calculamos el
 zzriesgo.</item>       <item>if knkk-dbpay = &apos;ZCO&apos; and *knkk-dbpay = &apos;ZCO&apos; AND knkk-klimk &lt;&gt; *knkk-klimk.</item>       <item>lv_dif = knkk-klimk - knkk-dbekr .</item>       <item>endif.</item>       <item>IF lv_dif &gt;= 0.</ite
m>       <item/>       <item>*            &quot;Calculo la diferencia entre el limite de credito y el riesgo para saber el credito interno</item>       <item>*            IF knkk-dbekr &lt;&gt; *knkk-dbekr.</item>       <item>*              lv_came_from =
 &apos;D&apos;.</item>       <item>*              lv_dif = *knkk-klimk - *knkk-dbekr.</item>       <item>*            ELSE.</item>       <item>*              lv_came_from = &apos;K&apos;.</item>       <item>*              lv_dif = knkk-klimk - *knkk-klimk
.</item>       <item>*            ENDIF.</item>       <item>*</item>       <item>*            lv_new = knkk-dbekr + knkk-zzriesgo_2.&quot;lv_dif.</item>       <item>*</item>       <item>*            CASE lv_came_from.</item>       <item>*              WHE
N &apos;K&apos;.</item>       <item>*                knka-klime = *knkk-klimk = knkk-klimk.</item>       <item>*              WHEN &apos;D&apos;.</item>       <item>*                IF lv_new &gt;= *knkk-klimk.</item>       <item>*                  knka-k
lime = knkk-klimk = *knkk-dbekr = knkk-dbekr + knkk-zzriesgo_2.&quot;lv_dif.</item>       <item>*                ELSE.</item>       <item>*                  knka-klime = knkk-klimk = *knkk-dbekr = knkk-dbekr + knkk-zzriesgo_2.&quot; lv_dif.</item>       <
item>*                ENDIF.</item>       <item>*            ENDCASE.</item>       <item>IF knkk-dbekr &lt;&gt; *knkk-dbekr.</item>       <item>knka-klime = knkk-klimk = *knkk-dbekr = knkk-dbekr + knkk-zzriesgo_2.</item>       <item>knkk-zzriesgo_2 = knkk
-klimk - knkk-dbekr .</item>       <item>elseif  knkk-klimk &lt;&gt; *knkk-klimk.</item>       <item>knkk-zzriesgo_2 = knkk-klimk - knkk-dbekr .</item>       <item>endif.</item>       <item>*        ENDIF. &quot;FIN MTS: 04.01.2024 No se usa el ZZRIESGO e
n 2001</item>       <item>ELSE.</item>       <item>knkk-klimk = *knkk-klimk.</item>       <item>MESSAGE i398(00) with &apos;Riesgo no puede ser menor&apos;.</item>       <item>ENDIF.</item>       <item>else.</item>       <item>knkk-zzriesgo_2 = knkk-zzrie
sgo_2 + ( knkk-klimk - *knkk-klimk ).</item>       <item>if knkk-zzriesgo_2 &lt; 0.</item>       <item>knkk-zzriesgo_2 = 0.</item>       <item>endif.</item>       <item>ENDIF.</item>       <item/>       <item>ELSEIF vl_tipo = &apos;002&apos;.</item>
 <item>*</item>       <item>*      IF knkk-dbpay = &apos;ZCO&apos; AND ( sy-ucomm IS INITIAL OR sy-ucomm  = &apos;&amp;ONT&apos;</item>       <item>*                                  OR sy-ucomm = &apos;UPDA&apos; or sy-ucomm = &apos;S+&apos;).</item>
   <item>&quot; Si ha cambiado el Riesgo interno, independientemente si tiene riesgo CYC - BG 23/04/2024</item>       <item>IF sy-ucomm IS INITIAL OR sy-ucomm  = &apos;&amp;ONT&apos; OR sy-ucomm = &apos;UPDA&apos; or sy-ucomm = &apos;S+&apos;.</item>
  <item>&quot;Calculo la diferencia entre el limite de credito y el riesgo para saber el credito internoç</item>       <item>IF knkk-zzriesgo &lt;&gt; *knkk-zzriesgo.</item>       <item>knkk-klimk = knkk-zzriesgo + knkk-dbekr.</item>       <item>knkk-zzfe
chariesgo = sy-datum.</item>       <item>ELSEIF knkk-dbekr &lt;&gt; *knkk-dbekr.</item>       <item>knkk-klimk = knkk-zzriesgo + knkk-dbekr.</item>       <item>ENDIF.</item>       <item>*  IF knkk-dbekr &lt;&gt; *knkk-dbekr.</item>       <item>*    lv_cam
e_from = &apos;D&apos;.</item>       <item>*    lv_dif = *knkk-klimk - *knkk-dbekr.</item>       <item>*  ELSE.</item>       <item>*    lv_came_from = &apos;K&apos;.</item>       <item>*    lv_dif = knkk-klimk - *knkk-klimk.</item>       <item>*  ENDIF.</
item>       <item>*</item>       <item>*  lv_new = knkk-dbekr + lv_dif.</item>       <item>*</item>       <item>*  CASE lv_came_from.</item>       <item>*    WHEN &apos;K&apos;.</item>       <item>*      knka-klime = *knkk-klimk = knkk-klimk.</item>
 <item>*    WHEN &apos;D&apos;.</item>       <item>*      IF lv_new &gt;= *knkk-klimk.</item>       <item>*        knka-klime = knkk-klimk = *knkk-dbekr = knkk-dbekr.</item>       <item>*      ELSE.</item>       <item>*        knka-klime = knkk-klimk = *k
nkk-dbekr = knkk-dbekr + lv_dif.</item>       <item>*      ENDIF.</item>       <item>*  ENDCASE.</item>       <item>ENDIF.</item>       <item>ENDIF.</item>       <item>**** FIN FPR</item>      </SOURCE>      <PARENT_FULL_NAME/>     </ENH_HOOK_IMPL>    </I
MPLS>   </asx:values>  </asx:abap> </ENHO>
