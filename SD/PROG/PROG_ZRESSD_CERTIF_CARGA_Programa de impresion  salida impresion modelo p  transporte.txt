REPORT zressd_certif_carga.

SET EXTENDED CHECK OFF.
TABLES: vbpla, thead, ttxern, ttxit, t005, vbddl, stxh, sadr.   "SADR40A

CONSTANTS:
  gc_pr_kappl  TYPE char1 VALUE 'V',
  gc_true      TYPE char1 VALUE 'X',
  gc_false     TYPE char1 VALUE space,
  gc_english   TYPE char1 VALUE 'E',
  gc_pdf       TYPE char1 VALUE '2',
  gc_equal     TYPE char2 VALUE 'EQ',
  gc_include   TYPE char1 VALUE 'I',
  gc_cash_sale TYPE char1 VALUE 'C',
  gc_max_brtwr TYPE brtwr VALUE '999999999.99',
  BEGIN OF gc_nacha,
    printer       TYPE na_nacha VALUE 1,
    fax           TYPE na_nacha VALUE 2,
    external_send TYPE na_nacha VALUE 5,
  END OF gc_nacha,
  BEGIN OF gc_device,
    printer    TYPE output_device VALUE 'P',
    fax        TYPE output_device VALUE 'F',
    email      TYPE output_device VALUE 'E',
    web_dynpro TYPE output_device VALUE 'W',
  END OF gc_device.

DATA: gv_device TYPE output_device,
      gv_email  TYPE ad_smtpadr.

INCLUDE vttkdata.                      "Shipment Header
INCLUDE vttsdata.                      "Shipment Segment
INCLUDE vttpdata.                      "Shipment Items
INCLUDE vbpadata.                      "Partner
INCLUDE vtfadata.                      "Flow
INCLUDE sadrdata.                      "Address
INCLUDE vtlfdata.                      "Delivery Selection
INCLUDE rvadtabl.                      "Messages
INCLUDE vsedata.                       "shipping units
INCLUDE rv56acom.                      "I/O-Structure
SET EXTENDED CHECK ON.

DATA: s_form          TYPE fpname,
      fp_outputparams TYPE sfpoutputparams,
      gv_error        TYPE c,
      fm_name         TYPE rs38l_fnam,
      fp_docparams    TYPE sfpdocparams,
      lvf_device(30)  TYPE c,
      lvs_recipient   LIKE swotobjid,
      lvs_sender      LIKE swotobjid.
DATA:
  gt_pallet_header_t TYPE /vso/p_loadlist_t,
  gt_pallet_item_t   TYPE /vso/p_loadlist_ti,
  gt_vtrlk           TYPE /vso/p_vtrlk_t,
  wa_vtrlk           TYPE vtrlk,
  wa_vtrlp           TYPE vtrlp,
  wa_vttkvb          TYPE vttkvb,
  wa_vttsvb          TYPE vttsvb,
  gt_vtrlp           TYPE /vso/p_vtrlp_t,
  gt_vttsvb          TYPE /vso/p_vttsvb_t,
  gt_vttkvb_t        TYPE /vso/p_vttkvb_t,
  gt_cert_carga      TYPE zstsd_cert_carga.

DATA:
  xscreen(1)              TYPE c,
  retcode                 LIKE sy-subrc VALUE 0,
  there_was_output(1)     TYPE c        VALUE space,
  new_page_was_ordered(1) TYPE c        VALUE space.

DATA:  bundling TYPE char1.

CONSTANTS:
  no(1)  VALUE space,
  yes(1) VALUE 'X'.

TABLES : tpar .                                             "n_742056.

* >>>>> BUNDLING <<<<< *************************************************
INCLUDE check_bundling_print.
* >>>>> BUNDLING <<<<< *************************************************

***********************************************************************
*       FORM ENTRY                                                    *
***********************************************************************
*       Called from the Output Controll program                       *
***********************************************************************
*  -->  RETURN_CODE Status                                            *
*  -->  US_SCREEN                                                     *
***********************************************************************
FORM entry USING return_code LIKE sy-subrc                  "#EC CALLED
                 us_screen   TYPE c.                        "#EC CALLED

  return_code = 1.

  PERFORM data_init USING us_screen.

  PERFORM get_data.
  CHECK retcode EQ 0.

  PERFORM open_form USING us_screen.
  CHECK retcode EQ 0.

  PERFORM print_document.
  CHECK retcode EQ 0.

  PERFORM close_form.
  CHECK retcode EQ 0.

  return_code = 0.
ENDFORM.

***********************************************************************
*       FORM data_init                                               *
***********************************************************************
FORM data_init USING VALUE(us_screen) TYPE c.
  xscreen = us_screen.
  CLEAR:
    retcode,
    there_was_output,
    new_page_was_ordered.
ENDFORM.

***********************************************************************
*       FORM GET_DATA                                                 *
***********************************************************************
FORM get_data.
  DATA language LIKE nast-spras.
  DATA shipment_number LIKE vttk-tknum.

  language = nast-spras.
  shipment_number = nast-objky.
  CALL FUNCTION 'RV_SHIPMENT_PRINT_VIEW'
    EXPORTING
      shipment_number     = shipment_number
      option_tvtk         = 'X'  "Shipmenttype J/N
      option_ttds         = 'X'  "Disposition J/N
      language            = language
      option_items        = 'X'  "Transport Items J/N
      option_segments     = 'X'  "Transport Segments J/N
      option_partners     = 'X'  "Partners J/N
      option_sales_orders = 'X'  "Sales orders J/N
      option_export_data  = 'X'  "Export data J/N
      option_packages     = 'X'  "Packages J/N
      option_flow         = ' '  "Flow J/N
      option_no_refresh   = ' '  "Refresh Tables J/N
    IMPORTING
      f_vttkvb            = vttkvb  "Shipment Header
      f_tvtk              = tvtk "Shipmenttype
      f_tvtkt             = tvtkt "Description Shipmenttype
      f_ttds              = ttds "Disposition
      f_ttdst             = ttdst "Description Disposition
      f_vbpla             = vbpla "Packages
    TABLES
      f_vttp              = xvttp "Shipment Items
      f_trlk              = slk  "Delivery
      f_trlp              = slp  "Delivery Item
      f_vtts              = xvtts "Shipment Segments
      f_vtsp              = xvtsp "Segments/Items
      f_vbpa              = xvbpa "Partner
      f_vbadr             = xvbadr  "Address
      f_vtfa              = xvtfa "Flow
      f_vbplk             = xvbplk  "Shipment Unit Header
      f_vbplp             = xvbplp  "Shipment Unit
      f_vbpls             = xvbpls  "Shipment Unit Sum
    EXCEPTIONS
      not_found           = 1.

  IF sy-subrc NE 0.
    syst-msgid = 'VW'.
    syst-msgno = '010'.
    syst-msgty = 'E'.
    syst-msgv1 = dbvttk-tknum.
    syst-msgv2 = sy-subrc.
    retcode    = 1.
    PERFORM protocol_update.
  ENDIF.

  CHECK retcode EQ 0.

* Sort shipment items by itenary (i.e. TPRFO)                 "n_902657
  SORT xvttp BY tprfo.                                      "n_902657
* SORT SEGMENTS BY CORRECT ORDER (I.E. TSRFO)
  SORT xvtts BY tsrfo.

* CONVERT UNITS IN DELIVERIES AND DELIVERY-ITEMS
* TO BE CONFORM TO VTTK-UNITS:

  LOOP AT slk.
* start of insertion HP_364727
    CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
      EXPORTING
        input    = slk-brgew
        unit_in  = slk-gewei
        unit_out = vttkvb-dtmeg
      IMPORTING
        output   = slk-brgew.

* end of insertion HP_364727
    CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
      EXPORTING
        input    = slk-btgew
        unit_in  = slk-gewei
        unit_out = vttkvb-dtmeg
      IMPORTING
        output   = slk-btgew.

    CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
      EXPORTING
        input    = slk-ntgew
        unit_in  = slk-gewei
        unit_out = vttkvb-dtmeg
      IMPORTING
        output   = slk-ntgew.

    CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
      EXPORTING
        input    = slk-volum
        unit_in  = slk-voleh
        unit_out = vttkvb-dtmev
      IMPORTING
        output   = slk-volum.

    slk-gewei = vttkvb-dtmeg.
    slk-voleh = vttkvb-dtmev.
    MODIFY slk.
  ENDLOOP.

  LOOP AT slp.
    CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
      EXPORTING
        input    = slp-brgew
        unit_in  = slp-gewei
        unit_out = vttkvb-dtmeg
      IMPORTING
        output   = slp-brgew.

    CALL FUNCTION 'UNIT_CONVERSION_SIMPLE'
      EXPORTING
        input    = slp-ntgew
        unit_in  = slp-gewei
        unit_out = vttkvb-dtmeg
      IMPORTING
        output   = slp-ntgew.

    slp-gewei = vttkvb-dtmeg.
    MODIFY slp.
  ENDLOOP.
* Transfer address number for mail
*  IF nast-nacha = '5'.                "e-mail                "v_n_742056.
** Determine the type of the partner number
*    SELECT SINGLE * FROM tpar
*                  WHERE parvw = nast-parvw.
*    IF sy-subrc NE 0.
*      EXIT.
*    ENDIF.
** Search the address number
*    LOOP AT xvbpa
*     WHERE parvw = nast-parvw.
*      CASE tpar-nrart.             "type of the partner number
*        WHEN 'KU'.                 "- customer
*          CHECK xvbpa-kunnr = nast-parnr.
*        WHEN 'LI'.                 "- vendor
*          CHECK xvbpa-lifnr = nast-parnr.
*        WHEN 'AP'.                 "- contact person
*          CHECK xvbpa-parnr = nast-parnr.
*        WHEN 'PE'.                 "- personell number
*          CHECK xvbpa-pernr = nast-parnr.
*      ENDCASE.
*      "^_n_742056.
** deleted line of n_656692
*      addr_key-addrnumber = xvbpa-adrnr.
*      addr_key-persnumber = xvbpa-adrnp.
*      EXIT.
*    ENDLOOP.
*  ENDIF.                                                    "n_742056.

* Transfer address number for mail
  LOOP AT xvbpa
          WHERE parvw = nast-parvw.
    CHECK xvbpa-lifnr = nast-parnr.
    CHECK xvbpa-posnr = 0.
    addr_key-addrnumber = xvbpa-adrnr.
    addr_key-persnumber = xvbpa-adrnp.
    EXIT.
  ENDLOOP.

ENDFORM.

***********************************************************************
*       FORM PRINT_DOCUMENT                                           *
***********************************************************************
FORM print_document.

  s_form = tnapr-sform.

*1.--- Get the name of the generated function module
  TRY.
      CALL FUNCTION 'FP_FUNCTION_MODULE_NAME'
        EXPORTING
          i_name     = s_form
        IMPORTING
          e_funcname = fm_name.
    CATCH cx_fp_api_repository cx_fp_api_usage cx_fp_api_internal.
      sy-subrc = 1.
      gv_error = '1'.
*      MESSAGE e012 WITH s_form.  "No active form available.
  ENDTRY.

  CHECK gv_error IS INITIAL.

* 2.--- Open the spool job
  CLEAR: bundling.
  IMPORT bundling FROM MEMORY ID 'BUNDLING'.
  IF sy-subrc NE 0 OR bundling NE 'X' OR
     nast-nacha NE '1'.
    CLEAR: bundling.
    CALL FUNCTION 'FP_JOB_OPEN'
      CHANGING
*     Ausgabeparameter festlegen
        ie_outputparams = fp_outputparams
      EXCEPTIONS
        cancel          = 1
        usage_error     = 2
        system_error    = 3
        internal_error  = 4
        OTHERS          = 5.
    IF sy-subrc <> 0.
      gv_error = '1'.
*    MESSAGE e010. "die Formverarbeitung konnte nicht begonnen werden.
    ENDIF.
  ENDIF.

  CHECK gv_error = ''.

*3.--- Call the generated function module

**print deliveries in shipment
  DATA sum_weight LIKE vtrlk-btgew.
  DATA sum_volume LIKE vtrlk-volum.
  CHECK NOT slk[] IS INITIAL.
  CLEAR: sum_weight, sum_volume, vtrlk.
  LOOP AT slk.                         "DELIVERY HEADER
    sum_weight = sum_weight + slk-btgew.
    sum_volume = sum_volume + slk-volum.
  ENDLOOP.
  vtrlk-btgew = sum_weight.
  vtrlk-volum = sum_volume.

**transport_sum
  LOOP AT vttk.
    MOVE vttk TO wa_vttkvb.
    APPEND wa_vttkvb TO gt_vttkvb_t.
  ENDLOOP.

**deliveries / deliveries details
  LOOP AT slk.
    MOVE slk TO wa_vtrlk.
    APPEND wa_vtrlk TO gt_vtrlk.
    LOOP AT slp WHERE vbeln EQ slk-vbeln.  "DELIVERY-ITEMS
      MOVE slp TO wa_vtrlp.
      APPEND wa_vtrlp TO gt_vtrlp.
    ENDLOOP.
  ENDLOOP.

  CLEAR: gt_cert_carga.

  PERFORM cargar_cert_carga.

  CALL FUNCTION fm_name
    EXPORTING
      /1bcdwb/docparams = fp_docparams
      cert_carga        = gt_cert_carga
      archive_index     = toa_dara
      archive_params    = arc_params
      device            = lvf_device
      dialog            = ' '
*     FORM              = TNAPR-FONAM   "SCRIPT
*     sform             = tnapr-sform
*     LANGUAGE          = NAST-SPRAS
*     OPTIONS           = LVS_ITCPO
      mail_sender       = lvs_sender
      mail_recipient    = lvs_recipient
*     gs_vbddl          = vbddl
*     gs_vttkvb         = vttkvb
*     gt_vttkvb         = gt_vttkvb_t
*     gs_vtrlk_s        = vtrlk
*     gs_vtrlk          = gt_vtrlk
*     gs_vtrlp          = gt_vtrlp
*     gs_vttsvb         = gt_vttsvb
*     gs_vbplk          = vbplk
*     gs_vbplp          = vbplp
*     gs_rv56a          = rv56a
*     gt_sadr           = sadr
*     gt_ttdst          = ttdst
*     gt_tvtkt          = tvtkt
**     gt_rslt_vhcl      = gt_vehicl_data
**     gt_loadlist_plth  = gt_pallet_header_t
**     gt_loadlist_plti  = gt_pallet_item_t
*     sum_volume        = vtrlk-volum
*     sum_weight        = vtrlk-btgew
*     e_interface_type  = interfacetype
*      IMPORTING
*     /1bcdwb/formoutput =
*    TABLES
    EXCEPTIONS
      usage_error       = 1
      system_error      = 2
      internal_error    = 3
      OTHERS            = 4.
  IF sy-subrc <> 0.
*      MESSAGE e726 WITH fm_name sy-subrc.
  ENDIF.

ENDFORM.

***********************************************************************
*      Form  PACKING_TREE                                             *
***********************************************************************
FORM packing_tree USING VALUE(shenr) LIKE vekp-venum.
  MOVE space TO xvbplk.
  xvbplk-venum = shenr.
  READ TABLE xvbplk.
  vbplk = xvbplk.
  PERFORM print USING 'SHIPPING_UNIT'.

  LOOP AT xvbplp WHERE venum = shenr.
    IF xvbplp-posnr IS INITIAL.
      PERFORM packing_tree USING xvbplp-unvel.
    ELSE.
      vbplp = xvbplp.
      PERFORM print USING 'SHIPPING_UNIT_DELIVERY_ITEM'.
    ENDIF.
  ENDLOOP.
ENDFORM.

***********************************************************************
********                                                      *********
********                 T E C H N I C A L                    *********
********                                                      *********
***********************************************************************

***********************************************************************
*      Form  PRINT                                                    *
***********************************************************************
FORM print USING textelement TYPE c.
  IF new_page_was_ordered EQ yes.
    CALL FUNCTION 'CONTROL_FORM'
      EXPORTING
        command = 'ENDPROTECT'.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'NEW_PAGE'
      EXCEPTIONS
        OTHERS  = 1.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
    new_page_was_ordered = no.
  ENDIF.
  IF there_was_output EQ no.
    CALL FUNCTION 'CONTROL_FORM'
      EXPORTING
        command = 'PROTECT'.
    there_was_output = yes.
  ENDIF.
  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = textelement
    EXCEPTIONS
      OTHERS  = 1.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.
ENDFORM.

***********************************************************************
*       FORM OPEN_FORM                                                *
***********************************************************************
*  -->  VALUE(US_SCREEN)  Output on screen                            *
*                         ' ' = printer                               *
*                         'X' = screen                                *
***********************************************************************
FORM open_form USING VALUE(us_screen) TYPE c.
  DATA us_country LIKE t005-land1.

  PERFORM get_sender_country USING us_country.
  CHECK retcode EQ 0.
*  INCLUDE rvadopfo.
  INCLUDE zrvadopfo_print_opt.
ENDFORM.

***********************************************************************
*       FORM Get_Sender_Country
*                                                                     *
***********************************************************************
*       Determines the country of the transport-disposition-unit      *
***********************************************************************
FORM get_sender_country USING sender_country LIKE t005-land1.
* data:
*   l_addr1_sel like addr1_sel.

* l_addr1_sel-addrnumber = ttds-adrnr.                    "SADR40A
* call function 'ADDR_GET'
*      exporting
*        address_selection = l_addr1_sel
*        address_group     = 'CA01'        "it's a Customizing-Address
*      importing
*        sadr              = sadr                            "SADR40A
*      exceptions
*           others  = 1.
* if sy-subrc eq 0.
*   sender_country = sadr-land1.                             "SADR40A
* else.
*   syst-msgid = 'VW'.
*   syst-msgno = '087'.
*   syst-msgty = 'E'.
*   syst-msgv1 = dbvttk-tknum.
*   syst-msgv2 = sy-subrc.
*   perform protocol_update.
* endif.
  DATA: l_vbadr LIKE vbadr.
  DATA: l_vbpa LIKE vbpa.

  LOOP AT xvbpa WHERE vbeln = nast-objky AND
                      parvw = nast-parvw.
    sender_country = xvbpa-land1.
    EXIT.
  ENDLOOP.
  IF sy-subrc IS INITIAL  AND  sender_country IS INITIAL.
    l_vbpa = xvbpa.
    CALL FUNCTION 'VIEW_VBADR'
      EXPORTING
        input         = l_vbpa
        partnernummer = nast-parnr
      IMPORTING
        adresse       = l_vbadr.
    sender_country = l_vbadr-land1.
  ENDIF.

ENDFORM.

***********************************************************************
*       FORM CLOSE_FORM                                               *
***********************************************************************
FORM close_form.

* 4. Formularverarbeitung beenden
  IF bundling NE 'X'.
    CALL FUNCTION 'FP_JOB_CLOSE'
      EXCEPTIONS
        usage_error    = 1
        system_error   = 2
        internal_error = 3
        OTHERS         = 4.
    IF sy-subrc NE 0.
*    MESSAGE i713.
    ENDIF.
  ENDIF.
*
*  CALL FUNCTION 'CLOSE_FORM'
*    EXCEPTIONS
*      OTHERS = 1.
*  IF sy-subrc NE 0.
*    retcode = sy-subrc.
*    PERFORM protocol_update.
*  ENDIF.
*  SET COUNTRY space.
ENDFORM.

***********************************************************************
*       FORM PROTOCOL_UPDATE                                          *
***********************************************************************
*       The messages are collected for the processing protocol.       *
***********************************************************************
FORM protocol_update.

  IF xscreen = space.
    CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
      EXPORTING
        msg_arbgb = syst-msgid
        msg_nr    = syst-msgno
        msg_ty    = syst-msgty
        msg_v1    = syst-msgv1
        msg_v2    = syst-msgv2
        msg_v3    = syst-msgv3
        msg_v4    = syst-msgv4.
  ELSE.
    MESSAGE ID syst-msgid TYPE 'I' NUMBER syst-msgno
            WITH syst-msgv1 syst-msgv2 syst-msgv3 syst-msgv4.
  ENDIF.
ENDFORM.
**&---------------------------------------------------------------------*
**&      Form  CARGAR_HORA_PICKING
**&---------------------------------------------------------------------*
**       text
**----------------------------------------------------------------------*
**  -->  p1        text
**  <--  p2        text
**----------------------------------------------------------------------*
*FORM cargar_hoja_picking .
*
*  DATA: lv_bezei TYPE vttk_add01_t,
*        ls_xvttp TYPE vttpvb.
*
*  " Datos de cabecera del transporte:
*  MOVE-CORRESPONDING vttkvb TO lt_hoja_pick-cabecera.
*
*  " Secuencia Carga (Textos):
*  CONDENSE: lt_hoja_pick-cabecera-dplbg, lt_hoja_pick-cabecera-uplbg.
*  CONCATENATE lt_hoja_pick-cabecera-dplbg+6(2) lt_hoja_pick-cabecera-dplbg+4(2)
*              lt_hoja_pick-cabecera-dplbg+0(4)
*              INTO lt_hoja_pick-cabecera-dplbg_txt SEPARATED BY '.'.
*  CONCATENATE lt_hoja_pick-cabecera-uplbg+0(2) lt_hoja_pick-cabecera-uplbg+2(2) lt_hoja_pick-cabecera-uplbg+4(2)
*              INTO lt_hoja_pick-cabecera-uplbg_txt SEPARATED BY ':'.
*
*  " Datos transporte (Agencia/Datos camión/Transportista):
*  lt_hoja_pick-cabecera-dat_transporte-tdlnr = vttkvb-tdlnr.
*  IF lt_hoja_pick-cabecera-dat_transporte-tdlnr IS NOT INITIAL.
*    SELECT SINGLE name1 INTO lt_hoja_pick-cabecera-dat_transporte-name1
*    FROM lfa1
*    WHERE lifnr = lt_hoja_pick-cabecera-dat_transporte-tdlnr.
*  ENDIF.
*  lt_hoja_pick-cabecera-dat_transporte-signi = vttkvb-signi.
*  lt_hoja_pick-cabecera-dat_transporte-tpbez = vttkvb-tpbez.
*  IF vttkvb-text1 IS NOT INITIAL.
*    lt_hoja_pick-cabecera-dat_transporte-text1 = vttkvb-text1.
*  ELSEIF vttkvb-add01 IS NOT INITIAL.
*    CLEAR lv_bezei.
*    SELECT SINGLE bezei INTO lv_bezei
*      FROM vtadd01t
*      WHERE spras = nast-spras
*      AND add_info = vttkvb-add01.
*    CONCATENATE vttkvb-add01 lv_bezei INTO lt_hoja_pick-cabecera-dat_transporte-text1
*         SEPARATED BY '/'.
*  ENDIF.
*
*  " Peso permitido (Texto):
*  WRITE lt_hoja_pick-cabecera-allowed_twgt TO lt_hoja_pick-cabecera-allowed_twgt_txt.
*  CONDENSE lt_hoja_pick-cabecera-allowed_twgt_txt.
**  CONCATENATE lt_hoja_pick-cabecera-allowed_twgt_txt lt_hoja_pick-cabecera-dtmeg
**              INTO lt_hoja_pick-cabecera-allowed_twgt_txt SEPARATED BY space.
*
*  " Fecha y Hora prevista de entrega (Texto):
*  CONDENSE: lt_hoja_pick-cabecera-dpten, lt_hoja_pick-cabecera-upten.
*  CONCATENATE lt_hoja_pick-cabecera-dpten+6(2) lt_hoja_pick-cabecera-dpten+4(2)
*              lt_hoja_pick-cabecera-dpten+0(4)
*              INTO lt_hoja_pick-cabecera-dpten_txt SEPARATED BY '.'.
*  CONCATENATE lt_hoja_pick-cabecera-upten+0(2) lt_hoja_pick-cabecera-upten+2(2)
*              lt_hoja_pick-cabecera-upten+4(2)
*              INTO lt_hoja_pick-cabecera-upten_txt SEPARATED BY ':'.
*
*  " Texto picking:
*  lt_hoja_pick-cabecera-texto_picking-tdname = lt_hoja_pick-cabecera-tknum.
*  lt_hoja_pick-cabecera-texto_picking-tdobject = 'VTTK'.
*  lt_hoja_pick-cabecera-texto_picking-tdid = '0002'.
*  lt_hoja_pick-cabecera-texto_picking-tdspras = nast-spras.
*
*  PERFORM cargar_posiciones.
*
*ENDFORM.                    " CARGAR_HORA_PICKING
**&---------------------------------------------------------------------*
**&      Form  CARGAR_DEST_MERC
**&---------------------------------------------------------------------*
**       text
**----------------------------------------------------------------------*
**      -->P_LS_XVTTP_KUNWE  text
**      <--P_LT_HOJA_PICK_CABECERA_DEST_MER  text
**----------------------------------------------------------------------*
*FORM cargar_dest_merc  USING    p_kunwe
*                       CHANGING ps_dest_merc TYPE zstsd_hoja_pick_dir.
*
*  DATA: lv_adrnr TYPE adrnr,
*        lv_stceg TYPE stceg,
*        ls_adrc  TYPE adrc.
*
*
*  CLEAR: lv_adrnr, lv_stceg.
*
*  SELECT SINGLE adrnr stceg INTO (lv_adrnr, lv_stceg)
*    FROM kna1
*    WHERE kunnr = p_kunwe.
*
*  ps_dest_merc-adrnr = lv_adrnr.
*  ps_dest_merc-stceg = lv_stceg.
*
*
*  IF ps_dest_merc-adrnr IS NOT INITIAL.
*    CLEAR ls_adrc.
*    SELECT SINGLE * INTO ls_adrc
*      FROM adrc
*      WHERE addrnumber = ps_dest_merc-adrnr.
*
*    IF ls_adrc IS NOT INITIAL.
*
*      MOVE-CORRESPONDING ls_adrc TO ps_dest_merc.
*      TRANSLATE ps_dest_merc-name1 TO UPPER CASE.
*      " Dirección 1:
*      CONDENSE: ps_dest_merc-street, ps_dest_merc-house_num1.
*      IF ps_dest_merc-house_num1 IS NOT INITIAL.
*        CONCATENATE ps_dest_merc-street ps_dest_merc-house_num1
*                    INTO ps_dest_merc-direc_1 SEPARATED BY ', '.
*      ELSE.
*        WRITE ps_dest_merc-street TO ps_dest_merc-direc_1.
*      ENDIF.
*      TRANSLATE ps_dest_merc-direc_1 TO UPPER CASE.
*      " Dirección 2:
*      CONDENSE: ps_dest_merc-post_code1, ps_dest_merc-city1.
*      CONCATENATE ps_dest_merc-post_code1 ps_dest_merc-city1
*                INTO ps_dest_merc-direc_2 SEPARATED BY space.
*      TRANSLATE ps_dest_merc-direc_2 TO UPPER CASE.
*      IF ps_dest_merc-region IS NOT INITIAL.
*        TRANSLATE ps_dest_merc-city1 TO UPPER CASE.
*        SELECT SINGLE bezei INTO ps_dest_merc-bezei
*          FROM t005u
*          WHERE bland = ls_adrc-region
*          AND spras = ls_adrc-langu
*          AND land1 = ls_adrc-country.
*        TRANSLATE ps_dest_merc-bezei TO UPPER CASE.
*        IF ps_dest_merc-bezei IS NOT INITIAL AND ps_dest_merc-bezei NE ps_dest_merc-city1.
*          CONCATENATE ps_dest_merc-direc_2 ps_dest_merc-bezei
*                      INTO ps_dest_merc-direc_2 SEPARATED BY ' - '.
*        ENDIF.
*      ENDIF.
*    ENDIF.
*    " FAX:
*    SELECT SINGLE fax_number INTO ps_dest_merc-fax_number
*      FROM adr3
*      WHERE addrnumber = ps_dest_merc-adrnr.
*  ENDIF.
*
*ENDFORM.                    " CARGAR_DEST_MERC
**&---------------------------------------------------------------------*
**&      Form  CARGAR_POSICIONES
**&---------------------------------------------------------------------*
**       text
**----------------------------------------------------------------------*
**  -->  p1        text
**  <--  p2        text
**----------------------------------------------------------------------*
*FORM cargar_posiciones .
*
*  " Tablas internas:
*  DATA: BEGIN OF lt_agrup OCCURS 0,
*          kunwe TYPE kunwe,
*          name1 TYPE ad_name1,
*          city1 TYPE ad_city1,
*          lprio TYPE lprio,
*          bezei TYPE bezei20,
*        END OF lt_agrup.
*
*  DATA: BEGIN OF lt_agrup_ent OCCURS 0,
*          kunwe TYPE kunwe,
*          lprio TYPE lprio,
*          vbeln TYPE vbeln_vl,
*        END OF lt_agrup_ent.
*
*  " Estructuras:
*  DATA: ls_xvttp          TYPE         vttpvb,
*        ls_agrup          LIKE LINE OF lt_agrup,
*        ls_agrup_ent      LIKE LINE OF lt_agrup_ent,
*        ls_hoja_pick_lin  TYPE         zstsd_hoja_pick_pos_lin,
*        ls_hoja_pick_pos  TYPE         zstsd_hoja_pick_pos_ent_lin,
*        ls_hoja_pick_part TYPE         zstsd_hoja_pick_part_ent_lin,
*        ls_slp            TYPE         vtrlp,
*        ls_slp_part       TYPE         vtrlp.
*
*  " Datos:
*  DATA: lv_index      LIKE sy-tabix,
*        lv_name1      TYPE ad_name1,
*        lv_city1      TYPE ad_city1,
*        lv_bezei      TYPE bezei20,
*        lv_prio       TYPE lprio,
*        lv_cant_e(17),
*        lv_cant_d(3),
*        lv_string     TYPE string,
*        lv_canti      TYPE lfimg.
*
*  CLEAR: lt_agrup, lt_agrup_ent.
*  REFRESH: lt_agrup, lt_agrup_ent.
*
*  " 1) Identificamos combinaciones dest.merc. y prioridad:
*
*  LOOP AT xvttp INTO ls_xvttp.
*    CLEAR: ls_agrup, ls_agrup_ent, lv_name1, lv_city1, lv_bezei, lv_prio.
*
*    SELECT SINGLE name1 ort01 INTO (lv_name1, lv_city1)
*      FROM kna1
*      WHERE kunnr = ls_xvttp-kunwe.
*    SELECT SINGLE lprio INTO lv_prio
*      FROM likp
*      WHERE vbeln = ls_xvttp-vbeln.
*
**    IF lv_prio IS NOT INITIAL OR lv_prio = '00'.
*    SELECT SINGLE bezei INTO lv_bezei
*      FROM tprit
*      WHERE spras = nast-spras
*      AND lprio = lv_prio.
**    ENDIF.
*
*    READ TABLE lt_agrup INTO ls_agrup WITH KEY kunwe = ls_xvttp-kunwe
*                                               lprio = lv_prio.
*
*    IF ls_agrup IS INITIAL.
*
*      ls_agrup-kunwe = ls_xvttp-kunwe.
*      ls_agrup-name1 = lv_name1.
*      ls_agrup-city1 = lv_city1.
*      ls_agrup-lprio = lv_prio.
*      ls_agrup-bezei = lv_bezei.
*      APPEND ls_agrup TO lt_agrup.
*
*      ls_agrup_ent-kunwe = ls_xvttp-kunwe.
*      ls_agrup_ent-lprio = lv_prio.
*      ls_agrup_ent-vbeln = ls_xvttp-vbeln.
*      APPEND ls_agrup_ent TO lt_agrup_ent.
*
*    ELSE.
*      ls_agrup_ent-kunwe = ls_xvttp-kunwe.
*      ls_agrup_ent-lprio = lv_prio.
*      ls_agrup_ent-vbeln = ls_xvttp-vbeln.
*      APPEND ls_agrup_ent TO lt_agrup_ent.
*
*    ENDIF.
*
*  ENDLOOP.
*
*  " 2) Posiciones y particiones de entrega:
*  LOOP AT lt_agrup INTO ls_agrup.
*    CLEAR ls_hoja_pick_lin.
*    ls_hoja_pick_lin-kunwe = ls_agrup-kunwe.
*    ls_hoja_pick_lin-name1 = ls_agrup-name1.
*    ls_hoja_pick_lin-city1 = ls_agrup-city1.
*    ls_hoja_pick_lin-lprio = ls_agrup-lprio.
*    ls_hoja_pick_lin-bezei = ls_agrup-bezei.
*    LOOP AT lt_agrup_ent INTO ls_agrup_ent WHERE kunwe = ls_agrup-kunwe
*                                           AND lprio = ls_agrup-lprio.
*      LOOP AT slp INTO ls_slp WHERE uecha IS INITIAL
*                              AND vbeln = ls_agrup_ent-vbeln.
*
*        CLEAR ls_hoja_pick_pos.
*        MOVE-CORRESPONDING ls_slp TO ls_hoja_pick_pos.
*        IF ls_slp-lfimg IS NOT INITIAL.
*          ls_hoja_pick_pos-tot_entrega = ls_slp-lfimg.
*          IF ls_slp-vrkme <> 'KG'.
*            CLEAR lv_canti.
*            CALL FUNCTION 'ZCONVERTIR_CANTIDAD'
*              EXPORTING
*                i_matnr    = ls_slp-matnr
*                i_canti    = ls_slp-lfimg
*                i_meins_or = ls_slp-vrkme
*                i_meins_fi = 'KG'
*              IMPORTING
*                e_canti    = lv_canti.
*            lt_hoja_pick-cabecera-total_kg = lt_hoja_pick-cabecera-total_kg + lv_canti.
*            ls_hoja_pick_pos-tot_entrega = lv_canti.
*          ELSE.
*            lt_hoja_pick-cabecera-total_kg = lt_hoja_pick-cabecera-total_kg + ls_slp-lfimg.
*          ENDIF.
*        ELSEIF ls_slp-kcmeng IS NOT INITIAL.
*          ls_hoja_pick_pos-tot_entrega = ls_slp-kcmeng.
*          IF ls_slp-meins <> 'KG'.
*            CLEAR lv_canti.
*            CALL FUNCTION 'ZCONVERTIR_CANTIDAD'
*              EXPORTING
*                i_matnr    = ls_slp-matnr
*                i_canti    = ls_slp-kcmeng
*                i_meins_or = ls_slp-meins
*                i_meins_fi = 'KG'
*              IMPORTING
*                e_canti    = lv_canti.
*            lt_hoja_pick-cabecera-total_kg = lt_hoja_pick-cabecera-total_kg + lv_canti.
*            ls_hoja_pick_pos-tot_entrega = lv_canti.
*          ELSE.
*            lt_hoja_pick-cabecera-total_kg = lt_hoja_pick-cabecera-total_kg + ls_slp-kcmeng.
*          ENDIF.
*        ENDIF.
*
*        CLEAR: lv_cant_e, lv_cant_d.
*        WRITE ls_hoja_pick_pos-tot_entrega TO ls_hoja_pick_pos-tot_entrega_txt.
*        CONDENSE ls_hoja_pick_pos-tot_entrega_txt.
*
*        SPLIT ls_hoja_pick_pos-tot_entrega_txt AT ',' INTO lv_cant_e lv_cant_d.
*        CONDENSE: lv_cant_e, lv_cant_d.
*        IF lv_cant_d <> '000'.
*          WRITE ls_hoja_pick_pos-tot_entrega TO ls_hoja_pick_pos-tot_entrega_txt.
*          CONDENSE ls_hoja_pick_pos-tot_entrega_txt.
*        ELSE.
*          CLEAR lv_string.
*          CONDENSE lv_cant_e.
*          CONCATENATE lv_cant_e '       ' INTO lv_string.
*          WRITE lv_string TO ls_hoja_pick_pos-tot_entrega_txt.
*          CONDENSE ls_hoja_pick_pos-tot_entrega_txt.
*        ENDIF.
*
*        " Particiones de cada entrega:
*
*        LOOP AT slp INTO ls_slp_part WHERE uecha = ls_slp-posnr
*                                     AND vbeln = ls_slp-vbeln.
*
*          CLEAR: ls_hoja_pick_part, lv_cant_e, lv_cant_d.
*          MOVE-CORRESPONDING ls_slp_part TO ls_hoja_pick_part.
*          IF ls_hoja_pick_part-vrkme <> 'KG'.
*            CLEAR lv_canti.
*            CALL FUNCTION 'ZCONVERTIR_CANTIDAD'
*              EXPORTING
*                i_matnr    = ls_hoja_pick_part-matnr
*                i_canti    = ls_hoja_pick_part-lfimg
*                i_meins_or = ls_hoja_pick_part-vrkme
*                i_meins_fi = 'KG'
*              IMPORTING
*                e_canti    = lv_canti.
*
*            ls_hoja_pick_part-lfimg = lv_canti.
*          ENDIF.
*          WRITE ls_hoja_pick_part-lfimg TO ls_hoja_pick_part-lfimg_txt.
*          CONDENSE ls_hoja_pick_part-lfimg_txt.
*          SPLIT ls_hoja_pick_part-lfimg_txt AT ',' INTO lv_cant_e lv_cant_d.
*          CONDENSE: lv_cant_e, lv_cant_d.
*          IF lv_cant_d <> '000'.
*            WRITE ls_hoja_pick_part-lfimg TO ls_hoja_pick_part-lfimg_txt.
*            CONDENSE ls_hoja_pick_part-lfimg_txt.
*          ELSE.
*            CLEAR lv_string.
*            CONDENSE lv_cant_e.
*            CONCATENATE lv_cant_e '       ' INTO lv_string.
*            WRITE lv_string TO ls_hoja_pick_part-lfimg_txt.
*            CONDENSE ls_hoja_pick_part-lfimg_txt.
*          ENDIF.
*
*          APPEND ls_hoja_pick_part TO ls_hoja_pick_pos-part_entrega.
*
*        ENDLOOP.
*
*        APPEND ls_hoja_pick_pos TO ls_hoja_pick_lin-pos_entrega.
*      ENDLOOP.
*    ENDLOOP.
*
*    APPEND ls_hoja_pick_lin TO lt_hoja_pick-posiciones.
*  ENDLOOP.
*
*  " Total Peso Kilos:
*  WRITE lt_hoja_pick-cabecera-total_kg TO lt_hoja_pick-cabecera-total_kg_txt.
*  CONDENSE lt_hoja_pick-cabecera-total_kg_txt.
*  SPLIT lt_hoja_pick-cabecera-total_kg_txt AT ',' INTO lv_cant_e lv_cant_d.
*  CONDENSE: lv_cant_e, lv_cant_d.
*  IF lv_cant_d <> '000'.
*    WRITE lt_hoja_pick-cabecera-total_kg TO lt_hoja_pick-cabecera-total_kg_txt.
*    CONDENSE lt_hoja_pick-cabecera-total_kg_txt.
*  ELSE.
*    CLEAR lv_string.
*    CONDENSE lv_cant_e.
*    CONCATENATE lv_cant_e '       ' INTO lv_string.
*    WRITE lv_string TO lt_hoja_pick-cabecera-total_kg_txt.
*    CONDENSE lt_hoja_pick-cabecera-total_kg_txt.
*  ENDIF.
*
*  lt_hoja_pick-cabecera-gewei = 'KG'.
*
*

*ENDFORM.                    " CARGAR_POSICIONES
*&---------------------------------------------------------------------*
*&      Form  CARGAR_CERT_CARGA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM cargar_cert_carga .

  DATA: lv_bezei TYPE         vttk_add01_t,
        lv_bukrs TYPE         bukrs,
        ls_slk   LIKE LINE OF slk.

  " Nº Transporte:
  gt_cert_carga-tknum = vttkvb-tknum.

  " Logo URL:
  PERFORM cargar_logo_url USING vttkvb-tplst
                          CHANGING gt_cert_carga-logo_url.

  " Datos de sociedad:
  PERFORM cargar_dat_soc USING vttkvb-tplst
                         CHANGING gt_cert_carga-sociedad.

  " Datos transporte:

  " Agencia:
  gt_cert_carga-transporte-tdlnr = vttkvb-tdlnr.
  SELECT SINGLE name1 INTO gt_cert_carga-transporte-name1
  FROM lfa1
  WHERE lifnr = gt_cert_carga-transporte-tdlnr.

  " NIF/Transportista:
  IF vttkvb-text1 IS NOT INITIAL.
    gt_cert_carga-transporte-text1 = vttkvb-text1.
  ELSEIF vttkvb-add01 IS NOT INITIAL.
    CLEAR lv_bezei.
    SELECT SINGLE bezei INTO lv_bezei
      FROM vtadd01t
      WHERE spras = nast-spras
      AND add_info = vttkvb-add01.
    CONCATENATE vttkvb-add01 lv_bezei INTO gt_cert_carga-transporte-text1
         SEPARATED BY '/'.
  ENDIF.

  " Matrículas:
  gt_cert_carga-transporte-signi = vttkvb-signi.
  gt_cert_carga-transporte-tpbez = vttkvb-tpbez.

  " Fecha y hora de inicio del transporte:
  gt_cert_carga-transporte-datbg = vttkvb-datbg.
  CONCATENATE gt_cert_carga-transporte-datbg+6(2) gt_cert_carga-transporte-datbg+4(2)
   gt_cert_carga-transporte-datbg+0(4)
   INTO gt_cert_carga-transporte-datbg_txt SEPARATED BY '.'.

  gt_cert_carga-transporte-uatbg = vttkvb-uatbg.
  CONCATENATE gt_cert_carga-transporte-uatbg+0(2) gt_cert_carga-transporte-uatbg+2(2)
   gt_cert_carga-transporte-uatbg+4(2)
   INTO gt_cert_carga-transporte-uatbg_txt SEPARATED BY ':'.

* SKUZMYCHOV Roll-out papeleria Sarrià 05.08.2016 ->
* En función de la sociedad, se mostrará una localidad u otra
  CASE vttkvb-tplst.
    WHEN '3000'.
      gt_cert_carga-localidad = 'L’Alqueria d’Asnar'.
    WHEN '3020'.
      gt_cert_carga-localidad = 'Sarrià de Ter'.
  ENDCASE.
* SKUZMYCHOV Roll-out papeleria Sarrià 05.08.2016 <-

  " Día:
  IF sy-datum+6(1) = '0'.
    gt_cert_carga-dia = sy-datum+7(1).
  ELSE.
    gt_cert_carga-dia = sy-datum+6(2).
  ENDIF.

  " Mes:
  PERFORM mes_txt USING sy-datum+4(2)
                        nast-spras
                  CHANGING gt_cert_carga-mes.
  " Año:
  gt_cert_carga-anyo = sy-datum+0(4).

  " Destinatario de Mercancías:
  PERFORM dest_merc_txt CHANGING gt_cert_carga-dest_merc.

  " Texto LOPD:
  CLEAR lv_bukrs.
  SELECT SINGLE bukrs INTO lv_bukrs
    FROM ttds
    WHERE tplst = vttkvb-tplst.
  CONCATENATE 'ZLOPD_' lv_bukrs INTO gt_cert_carga-lopd-tdname.
  gt_cert_carga-lopd-tdobject = 'TEXT'.
  gt_cert_carga-lopd-tdid = 'ST'.
  gt_cert_carga-lopd-tdspras = nast-spras.

  " Texto registro mercantil:
  CONCATENATE 'ZREG_MERC_' lv_bukrs INTO gt_cert_carga-reg_mercantil-tdname.
  gt_cert_carga-reg_mercantil-tdobject = 'TEXT'.
  gt_cert_carga-reg_mercantil-tdid = 'ST'.
  gt_cert_carga-reg_mercantil-tdspras = nast-spras.

* GST - 16/03/2015 ->
* Añadir entregas a certificado de carga:
  CLEAR ls_slk.
  LOOP AT slk INTO ls_slk WHERE btgew IS NOT INITIAL.
    IF gt_cert_carga-zentrega1 IS INITIAL.
      gt_cert_carga-zentrega1 = ls_slk-vbeln.
    ELSEIF gt_cert_carga-zentrega2 IS INITIAL.
      gt_cert_carga-zentrega2 = ls_slk-vbeln.
    ELSEIF gt_cert_carga-zentrega3 IS INITIAL.
      gt_cert_carga-zentrega3 = ls_slk-vbeln.
    ELSEIF gt_cert_carga-zentrega4 IS INITIAL.
      gt_cert_carga-zentrega4 = ls_slk-vbeln.
    ELSEIF gt_cert_carga-zentrega5 IS INITIAL.
      gt_cert_carga-zentrega5 = ls_slk-vbeln.
    ENDIF.
  ENDLOOP.

* GST - 16/03/2015 <-

ENDFORM.                    " CARGAR_CERT_CARGA
*&---------------------------------------------------------------------*
*&      Form  CARGAR_LOGO_URL
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_VTTKVB_TPLST  text
*      <--P_GT_CERT_CARGA_LOGO_URL  text
*----------------------------------------------------------------------*
FORM cargar_logo_url  USING    p_tplst
                      CHANGING p_logo_url.

*  " Obtenemos la ruta del logo
*  CONCATENATE 'E:\logos\' p_tplst '.jpg' INTO p_logo_url.
*  CONDENSE p_logo_url.

  CALL FUNCTION 'ZRECUPERA_LOGOS_SOCIEDAD'
    EXPORTING
      iv_bukrs = p_tplst
    IMPORTING
      ev_path  = p_logo_url.



ENDFORM.                    " CARGAR_LOGO_URL
*&---------------------------------------------------------------------*
*&      Form  CARGAR_DAT_SOC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_VTTKVB_TPLST  text
*      <--P_GT_CERT_CARGA_SOCIEDAD  text
*----------------------------------------------------------------------*
FORM cargar_dat_soc  USING    p_bukrs
                     CHANGING ps_sociedad TYPE zstsd_cert_carga_dir.

  DATA: lv_adrnr TYPE adrnr,
        ls_adrc  TYPE adrc.

  CLEAR: ps_sociedad, ls_adrc, lv_adrnr.

  ps_sociedad-tplst = p_bukrs.

  SELECT SINGLE adrnr stceg INTO (ps_sociedad-adrnr, ps_sociedad-stceg)
    FROM t001
    WHERE bukrs = p_bukrs.

  IF ps_sociedad-adrnr IS NOT INITIAL.

    SELECT SINGLE * INTO ls_adrc
      FROM adrc
      WHERE addrnumber = ps_sociedad-adrnr.

    IF ls_adrc IS NOT INITIAL.

      MOVE-CORRESPONDING ls_adrc TO ps_sociedad.
      TRANSLATE ps_sociedad-name1 TO UPPER CASE.
      " Dirección 1:
      CONDENSE: ps_sociedad-street, ps_sociedad-house_num1.
      IF ps_sociedad-house_num1 IS NOT INITIAL.
        CONCATENATE ps_sociedad-street ps_sociedad-house_num1
                    INTO ps_sociedad-direc_1 SEPARATED BY ', '.
      ELSE.
        WRITE ps_sociedad-street TO ps_sociedad-direc_1.
      ENDIF.
      TRANSLATE ps_sociedad-direc_1 TO UPPER CASE.
      " Dirección 2:
      CONDENSE: ps_sociedad-post_code1, ps_sociedad-city1.
      CONCATENATE ps_sociedad-post_code1 ps_sociedad-city1
                INTO ps_sociedad-direc_2 SEPARATED BY space.
      TRANSLATE ps_sociedad-direc_2 TO UPPER CASE.
      IF ps_sociedad-region IS NOT INITIAL.
        TRANSLATE ps_sociedad-city1 TO UPPER CASE.
        SELECT SINGLE bezei INTO ps_sociedad-bezei
          FROM t005u
          WHERE bland = ls_adrc-region
          AND spras = ls_adrc-langu
          AND land1 = ls_adrc-country.
        TRANSLATE ps_sociedad-bezei TO UPPER CASE.
        IF ps_sociedad-bezei IS NOT INITIAL AND ps_sociedad-bezei NE ps_sociedad-city1.
          CONCATENATE ps_sociedad-direc_2 ps_sociedad-bezei
                      INTO ps_sociedad-direc_2 SEPARATED BY ' - '.
        ENDIF.
      ENDIF.
    ENDIF.
    " FAX:
    SELECT SINGLE fax_number INTO ps_sociedad-fax_number
      FROM adr3
      WHERE addrnumber = ps_sociedad-adrnr.
  ENDIF.

ENDFORM.                    " CARGAR_DAT_SOC
*&---------------------------------------------------------------------*
*&      Form  MES_TXT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_SY_DATUM+4(2)  text
*      -->P_NAST_SPRAS  text
*      <--P_GT_CERT_CARGA_MES  text
*----------------------------------------------------------------------*
FORM mes_txt  USING    p_mes
                       p_spras
              CHANGING p_mes_txt.

  IF p_spras = 'S'.
    CASE p_mes.
      WHEN '01'.
        p_mes_txt = 'Enero'.
      WHEN '02'.
        p_mes_txt = 'Febrero'.
      WHEN '03'.
        p_mes_txt = 'Marzo'.
      WHEN '04'.
        p_mes_txt = 'Abril'.
      WHEN '05'.
        p_mes_txt = 'Mayo'.
      WHEN '06'.
        p_mes_txt = 'Junio'.
      WHEN '07'.
        p_mes_txt = 'Julio'.
      WHEN '08'.
        p_mes_txt = 'Agosto'.
      WHEN '09'.
        p_mes_txt = 'Septiembre'.
      WHEN '10'.
        p_mes_txt = 'Octubre'.
      WHEN '11'.
        p_mes_txt = 'Noviembre'.
      WHEN '12'.
        p_mes_txt = 'Diciembre'.
    ENDCASE.

  ELSE.

    CASE p_mes.
      WHEN '01'.
        p_mes_txt = 'January'.
      WHEN '02'.
        p_mes_txt = 'February'.
      WHEN '03'.
        p_mes_txt = 'March'.
      WHEN '04'.
        p_mes_txt = 'April'.
      WHEN '05'.
        p_mes_txt = 'May'.
      WHEN '06'.
        p_mes_txt = 'June'.
      WHEN '07'.
        p_mes_txt = 'July'.
      WHEN '08'.
        p_mes_txt = 'August'.
      WHEN '09'.
        p_mes_txt = 'September'.
      WHEN '10'.
        p_mes_txt = 'October'.
      WHEN '11'.
        p_mes_txt = 'November'.
      WHEN '12'.
        p_mes_txt = 'December'.
    ENDCASE.

  ENDIF.

ENDFORM.                    " MES_TXT
*&---------------------------------------------------------------------*
*&      Form  DEST_MERC_TXT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_GT_CERT_CARGA_DEST_MERC  text
*----------------------------------------------------------------------*
FORM dest_merc_txt  CHANGING p_dest_merc.

  DATA: BEGIN OF lt_dest_merc OCCURS 0,
          kunwe TYPE kunwe,
          name1 TYPE ad_name1,
        END OF lt_dest_merc.

  DATA: ls_dest_merc LIKE LINE OF lt_dest_merc,
        ls_xvttp     TYPE         vttpvb,
        lv_adrnr     TYPE         adrnr.

  CLEAR: lt_dest_merc, ls_dest_merc, ls_xvttp.
  REFRESH: lt_dest_merc.

  LOOP AT xvttp INTO ls_xvttp.
    CLEAR ls_dest_merc.
    READ TABLE lt_dest_merc INTO ls_dest_merc WITH KEY kunwe = ls_xvttp-kunwe.
    IF ls_dest_merc IS INITIAL.
      ls_dest_merc-kunwe = ls_xvttp-kunwe.
      CLEAR lv_adrnr.
      SELECT SINGLE adrnr INTO lv_adrnr
        FROM kna1
        WHERE kunnr = ls_xvttp-kunwe.
      IF lv_adrnr IS NOT INITIAL.
        SELECT SINGLE name1 INTO ls_dest_merc-name1
          FROM adrc
          WHERE addrnumber = lv_adrnr.
      ENDIF.
      APPEND ls_dest_merc TO lt_dest_merc.
    ENDIF.
  ENDLOOP.

  " Obtenemos el nombre de los destinatarios de mercancías concatenados:
  LOOP AT lt_dest_merc INTO ls_dest_merc.
    CONDENSE ls_dest_merc-name1.
    IF p_dest_merc IS INITIAL.
      p_dest_merc = ls_dest_merc-name1.
    ELSE.
      CONCATENATE p_dest_merc ls_dest_merc-name1 INTO p_dest_merc SEPARATED BY ' - '.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " DEST_MERC_TXT
