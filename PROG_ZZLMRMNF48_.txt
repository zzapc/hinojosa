*&---------------------------------------------------------------------*
*&  Include           LMRMNF48
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  CREATE_PRINTOUT_KONS_PDF
*&---------------------------------------------------------------------*
*       druckausgabe: konsignationsabrechnung
*----------------------------------------------------------------------*
FORM create_printout_kons_pdf  USING  s_objky  TYPE  typ_objky
                                  i_rkwa   TYPE  typ_tab_rkwa
                                  i_bset   TYPE  typ_tab_bset
                                  i_mseg   TYPE  typ_tab_mseg
                                  i_t001w  TYPE  typ_tab_t001w
                                  i_mara   TYPE  typ_tab_mara
                                  i_makt   TYPE  typ_tab_makt
                                  i_marm   TYPE  typ_tab_marm
                                  i_eina   TYPE  typ_tab_eina.
  gt_rkwa = i_rkwa.

  DATA: difme(1)     TYPE   c,        "Flag: Versch. ME
        f_plant_new  TYPE   boole-boole,
        mat_count    LIKE   sy-tabix,
        lf_bstme_old LIKE   rkwa-bstme,
        s_t052       LIKE   t052.
* Check if the subroutine is called in update task.
  CALL METHOD cl_system_transaction_state=>get_in_update_task
    RECEIVING
      in_update_task = gf_inupd.
*ENHANCEMENT-POINT LMRMNF44_0 SPOTS ES_SAPLMRMN.

  PERFORM prepare_print.

*---Job open for PDF
  PERFORM job_open_pdf CHANGING gs_itcpo.

*---moving value for address window
  PERFORM addr_texts_pdf.

*---Moving value for Info window
  PERFORM print_info_kons_pdf.


* Positionsverarbeitung ***********************************************
  SORT i_rkwa BY werks matnr bldat.
  CLEAR: rkwa.

*ENHANCEMENT-POINT LMRMNF44_1 SPOTS ES_SAPLMRMN.

  LOOP AT i_rkwa INTO rkwa.

    IF ( mat_count GT 2 AND t001w-werks NE rkwa-werks ) OR
       ( mat_count GT 2 AND  mara-matnr NE rkwa-matnr ).


      MOVE : mat_count   TO gs_material_subtotals-mat_count,
             t001w-werks TO gs_material_subtotals-werks,
             rkwa-werks  TO gs_material_subtotals-rkwa_werks,
             mara-matnr  TO gs_material_subtotals-matnr,
             rkwa-matnr  TO gs_material_subtotals-rkwa_matnr.

*ENHANCEMENT-SECTION     LMRMNF44_2 SPOTS ES_SAPLMRMN.
      PERFORM ko_mat_sum_pdf USING difme lf_bstme_old.
*END-ENHANCEMENT-SECTION.

    ENDIF.

    IF t001w-werks NE rkwa-werks.
      f_plant_new = c_x.
      PERFORM read_t001w          USING   i_t001w
                                          rkwa-werks.

      MOVE-CORRESPONDING t001w TO gs_plants_t001w.
      APPEND gs_plants_t001w TO gt_plants_t001w.
      CLEAR  gs_plants_t001w.

    ENDIF.

    IF f_plant_new = c_x OR mara-matnr NE rkwa-matnr.
      CLEAR: f_plant_new.
      mat_count = 1.
      CLEAR: print_mrm-matsumq_oldiv, print_mrm-matsumv_oldiv, difme.

*ENHANCEMENT-POINT LMRMNF44_3 SPOTS ES_SAPLMRMN.

      PERFORM read_matnr         USING    i_mara
                                          i_makt
                                          i_marm
                                          i_eina
                                          rkwa-matnr
                                          rkwa-bstme
                                          bseg-lifnr
                                          bseg-filkd.

      MOVE :  makt-matnr  TO gs_material_header-matnr,
              makt-maktx  TO gs_material_header-maktx,
              marm-ean11  TO gs_material_header-ean11,
              eina-idnlf  TO gs_material_header-idnlf,
              t001w-werks TO gs_material_header-werks.
      APPEND gs_material_header TO gt_material_header.
      CLEAR  gs_material_header.

    ENDIF.

    IF mat_count NE 1 AND lf_bstme_old NE rkwa-bstme.
      difme = 'X'.
    ENDIF.
    lf_bstme_old  =  rkwa-bstme.
    mat_count     =  mat_count + 1.

*ENHANCEMENT-POINT LMRMNF44_4 SPOTS ES_SAPLMRMN.

    IF rkwa-shkzg EQ 'S'.
      rkwa-bstmg = 0 - rkwa-bstmg.
      rkwa-wrbtr = 0 - rkwa-wrbtr.
      g_sign_bstmg = '-'.
      g_sign_wrbtr = '-'.

*ENHANCEMENT-POINT LMRMNF44_5 SPOTS ES_SAPLMRMN.

    ELSE.
      CLEAR: g_sign_bstmg, g_sign_wrbtr.

*ENHANCEMENT-POINT LMRMNF44_6 SPOTS ES_SAPLMRMN.

    ENDIF.

* Materialbeleg lesen
    IF ( gs_options-bwart EQ 'X' ).
      PERFORM read_mseg           USING   i_mseg
                                          rkwa-mblnr
                                          rkwa-mjahr
                                          rkwa-zeile.
    ENDIF.


    PERFORM print_mat_pos_pdf.

* output: sum of last material: KO_MAT_SUM_UNIME / KO_MAT_SUM_DIFME
    print_mrm-totsumv_oldiv  =  print_mrm-totsumv_oldiv + rkwa-wrbtr.

    AT LAST.
      IF mat_count GT 2.

        READ TABLE i_rkwa INTO rkwa INDEX sy-tabix.
        MOVE : mat_count   TO gs_material_totals-mat_count,
               t001w-werks TO gs_material_subtotals-werks,
               rkwa-werks  TO gs_material_subtotals-rkwa_werks,
               mara-matnr  TO gs_material_subtotals-matnr,
               rkwa-matnr  TO gs_material_subtotals-rkwa_matnr.

*ENHANCEMENT-SECTION     LMRMNF44_7 SPOTS ES_SAPLMRMN.
        PERFORM ko_mat_sum_pdf USING difme
                                 lf_bstme_old.
*END-ENHANCEMENT-SECTION.
      ENDIF.
    ENDAT.

  ENDLOOP.
  PERFORM print_netto_pdf USING bseg-shkzg.

  IF NOT ( i_bset[] IS INITIAL ).
    PERFORM print_tax_pdf USING  i_bset.
  ENDIF.
  PERFORM print_brutto_3_pdf.
* output payment conditions
  IF gs_options-payme EQ 'X'.
    s_t052-ztag1 = bseg-zbd1t.
    s_t052-zprz1 = bseg-zbd1p.
    s_t052-ztag2 = bseg-zbd2t.
    s_t052-zprz2 = bseg-zbd2p.
    s_t052-ztag3 = bseg-zbd3t.

    MOVE gs_options-payme TO gs_netto_brutto-payme.

    PERFORM print_payment_pdf USING    s_t052              "      --->
                                   s_objky             "      --->
                                   bseg-zterm          "      --->
                                   bseg-zfbdt.         "      --->
  ENDIF.

  PERFORM print_final_pdf.
  PERFORM call_function_kons_pdf.

ENDFORM.                               " create_printout_kons

*&---------------------------------------------------------------------*
*&      Form  PRINT_INFO_KONS_PDF
* using structure GS_MATERIAL_SUBTOTALS
*       Table type GT_MATERIAL_SUBTOTALS
*&---------------------------------------------------------------------*

FORM print_info_kons_pdf .

  MOVE-CORRESPONDING: gs_options TO gs_options_info,
                      rbkp       TO gs_rbkp_info,
                      bkpf       TO gs_bkpf_info,
                      lfa1       TO gs_lfa1_info,
                      lfb1       TO gs_lfb1_info,
                      t001       TO gs_t001_info,
                      tsad3t     TO gs_tsad3t_info,
                      addr3_val  TO gs_addr3_val_info,
                      t005       TO gs_t005_info,
                      adsmtp     TO gs_adsmtp_info.

  MOVE g_sobkz                   TO gs_options_con-sobkz.

ENDFORM.                    " PRINT_INFO_PDF
*&---------------------------------------------------------------------*
*&      Form  KO_MAT_SUM_PDF
* using structure GS_MATERIAL_SUBTOTALS
*       Table type GT_MATERIAL_SUBTOTALS
*&---------------------------------------------------------------------*
FORM ko_mat_sum_pdf USING difme TYPE  c
                        if_bstme  LIKE rkwa-bstme .

  DATA: lf_bstme LIKE rkwa-bstme.

  IF print_mrm-matsumq_oldiv LT 0.
    g_sign_bstmg = '-'.
  ELSE.
    CLEAR g_sign_bstmg.
  ENDIF.
  IF print_mrm-matsumv_oldiv LT 0.
    g_sign_wrbtr = '-'.
  ELSE.
    CLEAR g_sign_wrbtr.
  ENDIF.

  MOVE : difme TO gs_material_subtotals-difme.

  IF difme IS INITIAL.
    lf_bstme  = rkwa-bstme.
    rkwa-bstme = if_bstme.


    MOVE : print_mrm-matsumq_oldiv TO gs_material_subtotals-matsumq_oldiv,
           g_sign_bstmg            TO gs_material_subtotals-sign_bstmg,
           rkwa-bstme              TO gs_material_subtotals-bstme,
           print_mrm-matsumv_oldiv TO gs_material_subtotals-matsumv_oldiv,
           g_sign_wrbtr            TO gs_material_subtotals-sign_wrbtr.

*ENHANCEMENT-POINT LMRMNF44_8 SPOTS ES_SAPLMRMN.

    rkwa-bstme = lf_bstme.

  ELSE.
    MOVE : print_mrm-matsumv_oldiv TO gs_material_subtotals-matsumv_oldiv,
           g_sign_wrbtr            TO gs_material_subtotals-sign_wrbtr.

  ENDIF.
  APPEND gs_material_subtotals TO gt_material_subtotals.
  CLEAR gs_material_subtotals.


ENDFORM.                    " KO_MAT_SUM_PDF

*&---------------------------------------------------------------------*
*&      Form  PRINT_MAT_POS_PDF
* using Structure GS_MATERIAL_ITEM
*       table type GT_MATERIAL_ITEM
*&---------------------------------------------------------------------*

FORM print_mat_pos_pdf.

  IF NOT rkwa-bstmg IS INITIAL.
    g_stkpr = rkwa-wrbtr / rkwa-bstmg.
  ELSE.
    PERFORM protocol USING c_msgid_m8
                           c_msgty_warning
                           '883'
                           rkwa-matnr rkwa-mblnr '' ''.
  ENDIF.

  MOVE : rkwa-bldat    TO gs_material_item-bldat,
         mseg-bwart    TO gs_material_item-bwart,
         rkwa-bstmg    TO gs_material_item-bstmg,
         g_sign_bstmg  TO gs_material_item-sign_bstmg,
         rkwa-bstme    TO gs_material_item-bstme,
         rkwa-mwskz    TO gs_material_item-mwskz,
         rkwa-wrbtr    TO gs_material_item-wrbtr,
         g_sign_wrbtr  TO gs_material_item-sign_wrbtr,
         makt-matnr    TO gs_material_item-matnr.

*ENHANCEMENT-POINT LMRMNF44_9 SPOTS ES_SAPLMRMN.

  APPEND gs_material_item TO gt_material_item.
  CLEAR  gs_material_item.

  print_mrm-matsumq_oldiv  =  print_mrm-matsumq_oldiv + rkwa-bstmg.
  print_mrm-matsumv_oldiv  =  print_mrm-matsumv_oldiv + rkwa-wrbtr.

ENDFORM.                    "PRINT_MAT_POS_PDF

*&---------------------------------------------------------------------*
*&      Form  PRINT_BRUTTO_3_PDF
* using structure GS_NETTO_BRUTTO
*&---------------------------------------------------------------------*
FORM print_brutto_3_pdf.

  IF bseg-shkzg EQ 'S'.
    g_sign_wrbtr = '-'.
  ELSE.
    CLEAR: g_sign_wrbtr.
  ENDIF.

  MOVE : bseg-wrbtr   TO gs_netto_brutto-wrbtr,
         g_sign_wrbtr TO gs_netto_brutto-er_brutto_sign.

ENDFORM.                               " PRINT_BRUTTO_3_PDF

*&---------------------------------------------------------------------*
*&      Form  CALL_FUNCTION_KONS_PDF
*---calling pdf function module
*&---------------------------------------------------------------------*
FORM call_function_kons_pdf .
* Setting for sending document vai E-mail.
  DATA: lv_emailaddr TYPE adr6-smtp_addr,
        os_formout   TYPE fpformoutput.

* Setting for sending FAX
  DATA : lv_cam_address      TYPE REF TO cl_cam_address_bcs,
         lv_outputparams_fax TYPE sfpoutpar,
         lv_vend_cntry       TYPE lfa1-land1.

* BCS data
  DATA:
    send_request   TYPE REF TO cl_bcs,
    document       TYPE REF TO cl_document_bcs,
    recipient      TYPE REF TO if_recipient_bcs,
    bcs_exception  TYPE REF TO cx_bcs,
    lv_sent_to_all TYPE os_boolean,
    lp_pdf_size    TYPE so_obj_len,
    lv_subject     TYPE so_obj_des,
    ls_tnati       TYPE tnati,                              "1524684
    lv_add_nr      TYPE adr6-addrnumber.

* Archiving specific data declaration "1489677
  DATA: lv_pdf_size      TYPE i,
        lv_archiveformat LIKE toadd-doc_type,  "PDF or OTF
        lv_documentclass LIKE toadv-doc_type.

  gs_fm_docparams-langu = nast-spras.
  gs_fm_docparams-country = lfa1-land1.

  CALL FUNCTION gv_fm_name
    EXPORTING
      /1bcdwb/docparams     = gs_fm_docparams
      address               = gs_address
      gs_options_info       = gs_options_info
      rbkp_info             = gs_rbkp_info
      bkpf_info             = gs_bkpf_info
      lfa1_info             = gs_lfa1_info
      lfb1_info             = gs_lfb1_info
      t001_info             = gs_t001_info
      tsad3t_info           = gs_tsad3t_info
      addr3_val_info        = gs_addr3_val_info
      t005_info             = gs_t005_info
      adsmtp_info           = gs_adsmtp_info
      rp_head               = gs_rp_head
      rp_pos                = gt_rp_pos
      netto_brutto          = gs_netto_brutto
      plant_head            = gt_plants_t001w
      item_details          = gt_rm08nast_item_details
      tax_details           = gt_rm08nast_tax_details
      tax_details_rap       = gt_tax_details_rap
      payment_terms         = gt_payment_terms
      x_auto                = auto_x
      x_txjcd               = txjcd_x
      gf_cp_peinhprint      = gf_cp_peinhprint
      address_text          = gt_dynamic_text
      repeat                = repeat_x
      material_subtotals    = gt_material_subtotals
      material_header       = gt_material_header
      material_item         = gt_material_item
      material_totals       = gs_material_totals
      gt_purch_doc_item     = gt_purch_doc_item
      gt_commu_str_bapiesll = gt_commu_str_bapiesll
      gt_shipment_det       = gt_shipment_det
      gt_shipcostdet_header = gt_shipcostdet_header
      gt_shipcostdet_itetm  = gt_shipcostdet_itetm
      gt_billplan_date      = gt_billplan_date
      gt_return_del         = gt_return_del
      gs_options            = gs_options_con
      rbkp                  = rbkp
      rseg                  = gt_rseg
      gt_price_det_komvd    = gt_price_det
      komk                  = komk
      ekpo                  = ekpo
      vttsf                 = vttsf
    IMPORTING
      /1bcdwb/formoutput    = os_formout
    EXCEPTIONS
      usage_error           = 1
      system_error          = 2
      internal_error        = 3
      OTHERS                = 4.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

  IF g_xscreen IS INITIAL AND
     ( nast-nacha EQ 5 OR nast-nacha EQ 2 ) AND os_formout IS NOT INITIAL.

* get default Email id from address no
* When there is only one mail id then that will have default flag set
    SELECT SINGLE smtp_addr FROM adr6 INTO lv_emailaddr WHERE addrnumber =  gs_address-adrnr
                                                          AND flgdefault = abap_true.
* Set FAX specific setting
    IF nast-nacha EQ 5.
      lv_outputparams_fax-telenum = gs_itcpo-tdtelenum.
      lv_outputparams_fax-teleland = gs_itcpo-tdteleland.
    ELSE.
      IF nast-telfx NE space.
        lv_outputparams_fax-telenum  = nast-telfx.
        IF nast-tland IS INITIAL.
          lv_outputparams_fax-teleland = gs_address-land1.
        ELSE.
          lv_outputparams_fax-teleland = nast-tland.
        ENDIF.
      ENDIF.
    ENDIF.


    IF gf_comm_type EQ 'FAX' OR gf_comm_type EQ 'INT' OR nast-nacha EQ 2..
* ------------ Call BCS interface ----------------------------------
      TRY.
*   ---------- create persistent send request ----------------------
          send_request = cl_bcs=>create_persistent( ).

*   ---------- add document ----------------------------------------
*   get PDF xstring and convert it to BCS format
          lp_pdf_size = xstrlen( os_formout-pdf ).
          PERFORM xstring_to_solix
                     USING
                        os_formout-pdf.
*Cover title                                                "1524684
          IF nast-tdcovtitle IS NOT INITIAL.                "1524684
            lv_subject = nast-tdcovtitle.                   "1524684
          ELSE.                                             "1524684
            SELECT SINGLE * FROM tnati INTO ls_tnati        "1524684
                           WHERE spras EQ nast-spras        "1524684
                                 AND kappl EQ nast-kappl    "1524684
                                 AND kschl EQ nast-kschl.   "1524684
            IF sy-subrc EQ 0.                               "1524684
              lv_subject = ls_tnati-objdes.                 "1524684
            ELSE.                                           "1524684
              lv_subject = nast-objky+4(14).                "1524684
            ENDIF.                                          "1524684
          ENDIF.


          document = cl_document_bcs=>create_document(
                i_type    = 'PDF' " cf. RAW, DOC
                i_hex     = pdf_content
                i_length  = lp_pdf_size
                i_subject = lv_subject ).                   "#EC NOTEXT

*   add document to send request
          send_request->set_document( document ).
*     --------- set sender -------------------------------------------
*     note: this is necessary only if you want to set the sender
*           different from actual user (SY-UNAME). Otherwise sender is
*           set automatically with actual user.
*
*      sender = cl_sapuser_bcs=>create( sy-uname ).

*          DATA: lv_sender     TYPE adr6-smtp_addr,
*                lo_sender     TYPE REF TO cl_cam_address_bcs.
*          "centro emisor de la factura
*          lv_sender = 'carla.gijon@sothis.tech'.
*
*          lo_sender = cl_cam_address_bcs=>create_internet_address( lv_sender  ).
*
*
*          CALL METHOD send_request->set_sender
*            EXPORTING
*              i_sender = lo_sender.





*   ---------- add recipient (e-mail address) ----------------------

          CASE nast-nacha.
            WHEN 5.
              IF gf_comm_type EQ 'INT'.
*           add recipient (e-mail address)
                recipient = recipient = cl_cam_address_bcs=>create_internet_address(
                i_address_string = lv_emailaddr ).
              ELSE.
*           add recipient (fax address)
                recipient = cl_cam_address_bcs=>create_fax_address(
                                 i_country = lv_outputparams_fax-teleland
                                 i_number  = lv_outputparams_fax-telenum ).
              ENDIF.
            WHEN 2.
*           add recipient (fax address)
              recipient = cl_cam_address_bcs=>create_fax_address(
                               i_country = lv_outputparams_fax-teleland
                               i_number  = lv_outputparams_fax-telenum ).
          ENDCASE.

*   add recipient to send request
          send_request->add_recipient( i_recipient = recipient ).

*   ---------- send document ---------------------------------------
          lv_sent_to_all = send_request->send(
              i_with_error_screen = 'X' ).
* Issue message and COMMINT only if the subroutine is not called in update task
          IF gf_inupd = 0.
            IF lv_sent_to_all = 'X'.
              MESSAGE i022(so).
            ENDIF.

*   ---------- explicit 'commit work' is mandatory! ----------------
            COMMIT WORK.
          ENDIF.
* ------------------------------------------------------------------
* *            exception handling
* ------------------------------------------------------------------
* * replace this very rudimentary exception handling
* * with your own one !!!
* ------------------------------------------------------------------
        CATCH cx_bcs INTO bcs_exception.
          MESSAGE e019 WITH bcs_exception->error_type.
*     Sending fax/mail failed
          EXIT.
      ENDTRY.
    ENDIF.
  ENDIF.
***********Start of Note chnages1489677*****************
* Arching for adobe forms
  IF nast-tdarmod = 2 OR  nast-tdarmod = 3.

* Get the PDF length
    lv_pdf_size = xstrlen( os_formout-pdf ).

* defaults for archive
    IF toa_dara-function = space.
      toa_dara-function = 'DARA'.
    ENDIF.
*     which format to be used for archiving: OTF or PDF?
    CALL FUNCTION 'ARCHIV_GET_PRINTFORMAT'
      EXPORTING
        application = 'PDF'
      IMPORTING
        printformat = lv_archiveformat.

    IF lv_archiveformat EQ 'PDF'.
      lv_documentclass = 'PDF'.

      CALL FUNCTION 'ARCHIV_CREATE_OUTGOINGDOCUMENT'
        EXPORTING
          arc_p                    = arc_params
          arc_i                    = toa_dara
          pdflen                   = lv_pdf_size
          documentclass            = lv_documentclass                "Since the output is in PDF document class is also PDF
          document                 = os_formout-pdf
        EXCEPTIONS
          error_archiv             = 1
          error_communicationtable = 2
          error_connectiontable    = 3
          error_kernel             = 4
          error_parameter          = 5
          OTHERS                   = 6.
      CASE sy-subrc.
        WHEN 0. " o.k.
        WHEN 1. RAISE error_archiv.
        WHEN 2. RAISE error_communicationtable.
        WHEN 3. RAISE error_connectiontable.
        WHEN 4. RAISE error_kernel.
        WHEN 5. RAISE error_parameter.
        WHEN 6. RAISE error_archiv. "?
      ENDCASE.

    ELSE.
      " Other than PDF format raise error.
      MESSAGE e789(po) WITH lv_archiveformat.
    ENDIF.
  ENDIF.
************End of note chnages 1489677***************
  CLEAR:gs_fm_docparams,
        gs_address,
        gs_netto_brutto,
        gs_plants_t001w,
        gs_tax_details_rap,
        gs_payment_terms,
        gs_material_subtotals,
        gs_material_header,
        gs_material_item,
        gs_material_totals.

  REFRESH : gt_plants_t001w,
            gt_tax_details_rap,
            gt_payment_terms,
            gt_material_subtotals,
            gt_material_header,
            gt_material_item.

  CALL FUNCTION 'FP_JOB_CLOSE'
    EXCEPTIONS
      usage_error    = 1
      system_error   = 2
      internal_error = 3
      OTHERS         = 4.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

ENDFORM.                    " CALL_FUNCTION_KONS_PDF

*&---------------------------------------------------------------------*
*&      Form  CREATE_PRINTOUT_ERS_PDF
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_I_RSEG_X  text
*      -->P_I_EKBE1  text
*      -->P_I_EKBE2_X  text
*      -->P_I_EKKO  text
*      -->P_I_EKPO  text
*      -->P_I_BSET  text
*      -->P_I_T001W  text
*      -->P_I_MARA  text
*      -->P_I_MAKT  text
*      -->P_I_MARM  text
*      -->P_I_EINA  text
*      -->P_I_ESSR  text
*      -->P_S_OBJKY  text
*      -->P_I_PRITAB_SCD  text
*      -->P_I_SCD_TAB  text
*      -->P_I_SHP_TAB  text
*----------------------------------------------------------------------*
FORM create_printout_ers_pdf USING
                            i_rseg_x     TYPE  typ_tab_rseg
                            i_ekbe1      TYPE  typ_tab_ekbe
                            i_ekbe2_x    TYPE  typ_tab_ekbe
                            i_ekko       TYPE  typ_tab_ekko
                            i_ekpo       TYPE  typ_tab_ekpo
                            i_bset       TYPE  typ_tab_bset
                            i_t001w      TYPE  typ_tab_t001w
                            i_mara       TYPE  typ_tab_mara
                            i_makt       TYPE  typ_tab_makt
                            i_marm       TYPE  typ_tab_marm
                            i_eina       TYPE  typ_tab_eina
                            i_essr       TYPE  typ_tab_essr
                            s_objky      TYPE  typ_objky
                            i_pritab_scd TYPE v54a0_ers_pritab_scd_tab
                            i_scd_tab    TYPE v54a0_scdd_tab
                            i_shp_tab    TYPE v54a0_refobj_tab.

  DATA: lt_bapiesll LIKE  bapiesll OCCURS 0,
        ls_bapiessr LIKE  bapiessr,                         "#EC NEEDED
        ls_t052     LIKE  t052,
        lf_fracht   TYPE  c,
        lt_qmel     TYPE  typ_tqmel,
        ls_bset     TYPE  bset,                             "757086
        ls_servekbe TYPE  ekbe,                             "807380
        lt_fpla     LIKE  fplavb OCCURS 0 WITH HEADER LINE, "899043
        lt_fplt     LIKE  fpltvb OCCURS 0 WITH HEADER LINE,
        lf_date     LIKE  ekbe-budat,
        ls_ekpo     TYPE  ekpo,
        ls_rseg_tm  TYPE  mrmrseg_tm.

  DATA:  h_xekbz  LIKE rseg-xekbz.

  CLEAR h_xekbz.


* Check if the subroutine is called in update task.
  CALL METHOD cl_system_transaction_state=>get_in_update_task
    RECEIVING
      in_update_task = gf_inupd.
*ENHANCEMENT-POINT lmrmnf2c_01 SPOTS es_saplmrmn STATIC.
* *********************************************************************
* Mark1: preparations
* *********************************************************************
  PERFORM prepare_print.

* *********************************************************************
* Mark2:  output
* *********************************************************************
  PERFORM job_open_pdf CHANGING gs_itcpo.
*------ print address window
  PERFORM addr_texts_pdf.

*------moving value for info window
  MOVE-CORRESPONDING: gs_options TO gs_options_info,
                      rbkp       TO gs_rbkp_info,
                      lfa1       TO gs_lfa1_info,
                      lfb1       TO gs_lfb1_info,
                      t001       TO gs_t001_info,
                      tsad3t     TO gs_tsad3t_info,
                      addr3_val  TO gs_addr3_val_info,
                      t005       TO gs_t005_info,
                      adsmtp     TO gs_adsmtp_info.
* print header
  MOVE: gs_options-lsdat TO gs_options_con-lsdat,
        gs_options-sheet TO gs_options_con-sheet,
        rbkp-waers       TO gs_options_con-waers_rbkp,
        bkpf-waers       TO gs_options_con-waers_bkpf,
        rbkp-xrech       TO gs_options_con-shkzg.

****  Positionsverarbeitung  ******************************************
  SORT i_rseg_x BY werks xekbz xblnr lfgja lfbnr lfpos.

  SELECT * FROM rseg_tm INTO TABLE gt_rseg_tm FOR ALL ENTRIES IN i_rseg_x "Ehp5e TM
  WHERE belnr EQ i_rseg_x-belnr AND gjahr EQ i_rseg_x-gjahr
  AND buzei = i_rseg_x-buzei.
  IF sy-subrc EQ 0.
* Set flag as true if select is successful
    gf_tm_data = abap_true.
  ENDIF.
  gt_ekpo[] = i_ekpo[].

  LOOP AT i_rseg_x INTO rseg.

    g_posnr    = sy-tabix * 10 .

* Soll- oder Habenbuchung?
    IF rseg-shkzg EQ 'H'.
      MOVE '-' TO  g_sign_bstmg.
      MOVE '-' TO  g_sign_wrbtr.
    ELSE.
      CLEAR: g_sign_bstmg, g_sign_wrbtr.
    ENDIF.

**** output of plant header: PLANT_HEAD
    IF rseg-werks NE t001w-werks.
      PERFORM read_t001w          USING   i_t001w
                                          rseg-werks.

*---moving value for plant heading
      MOVE-CORRESPONDING t001w TO gs_plants_t001w.
      APPEND gs_plants_t001w TO gt_plants_t001w.
      CLEAR  gs_plants_t001w.

    ENDIF.

*************** Nachlesen der erforderlichen Daten *******************
* Bestellkopf
    IF rseg-ebeln NE ekko-ebeln.
      PERFORM read_ekko           USING   i_ekko
                                          rseg-ebeln.
    ENDIF.

* Bestellposition
    IF rseg-ebeln NE ekpo-ebeln OR rseg-ebelp NE ekpo-ebelp.
      PERFORM read_ekpo           USING   i_ekpo
                                          rseg-ebeln
                                          rseg-ebelp.
    ENDIF.

* Materialbezeichnung
    IF rseg-matnr NE mara-matnr.
      PERFORM read_matnr          USING   i_mara
                                          i_makt
                                          i_marm
                                          i_eina
                                          rseg-matnr
                                          rseg-bstme
                                          rbkp-lifnr
                                          rbkp-filkd.
    ENDIF.

* Für Retourenbestellungen erfolgt keine Ausgabe von Nullbelegen
    IF ekpo-retpo EQ c_signx AND rseg-wrbtr IS INITIAL.
      CONTINUE.
    ENDIF.

    CASE rseg-pstyp.
***********  Beginn positionstypspezifische Ausgabe    ****************

***********  Dienstleistung    ****************************************
      WHEN c_pstyp_9.
* Bestellentwicklung Wareneingang (wegen KNUMV für Konditionen,
* BLDAT = Lieferscheindatum und Rücklieferungsinformationen)
        IF ( gs_options-kondr EQ 'X' ) OR
           ( gs_options-rinfo EQ 'X' ) OR
           ( gs_options-lsdat EQ 'X' ).
          READ TABLE i_ekbe1  WITH KEY ebeln = rseg-ebeln
                                       ebelp = rseg-ebelp
                                       vgabe = c_vgabe_we "Goods receipt
                                       lfgja = rseg-lfgja
                                       lfbnr = rseg-lfbnr
                                       lfpos = rseg-lfpos INTO ekbe.
          IF sy-subrc NE 0.
            CLEAR: ekbe.
          ENDIF.
        ENDIF.

* Lesen Leistungerfassungsblatt Kopfdaten
        IF rseg-lfbnr NE essr-lblni.
          PERFORM read_essr           USING   i_essr
                                              rseg-lfbnr.
        ENDIF.

**** output of material header: ER_MAT_MATNR_9 (Dienstleistung)
        IF NOT ( essr-fknum IS INITIAL ) AND gs_options-fracht EQ 'X'.
          essr-txz01 = text-006.
          lf_fracht  = 'X'.
        ENDIF.
* wenn keine Referenz-Belegnummer erfaßt wurde => MatBelNr ausgeben
        IF essr-xblnr IS INITIAL.
          essr-xblnr = ekbe-belnr.
        ENDIF.

        MOVE: g_posnr       TO gs_material_item-g_posnr,
              rseg-buzei    TO gs_material_item-buzei,
              essr-txz01    TO gs_material_item-txz01_essr,
              essr-bktxt    TO gs_material_item-bktxt,
              essr-lblne    TO gs_material_item-lblne,
              essr-xblnr    TO gs_material_item-xblnr_essr,
              essr-bldat    TO gs_material_item-bldat_essr,
              essr-lblni    TO gs_material_item-lblni,
              ekpo-ebeln    TO gs_material_item-ebeln,
              ekpo-ebelp    TO gs_material_item-ebelp,
              ekpo-konnr    TO gs_material_item-konnr,
              ekpo-ktpnr    TO gs_material_item-ktpnr.
**** output of entry sheet details
        IF gs_options-sheet EQ c_signx.
          CLEAR: bapiessr, ls_bapiessr,
                 esll, bapiesll, lt_bapiesll, lt_bapiesll[].

          CALL FUNCTION 'BAPI_ENTRYSHEET_GETDETAIL'
            EXPORTING
              entrysheet          = essr-lblni
*             LONG_TEXTS          = c_signx
            IMPORTING
              entrysheet_header   = ls_bapiessr
            TABLES
*             ENTRYSHEET_ACCOUNT_ASSIGNMENT =
              entrysheet_services = lt_bapiesll.
*                 ENTRYSHEET_SRV_ACCASS_VALUES  =
*                 RETURN                        =
*                 ENTRYSHEET_HEADER_TEXT        =
*                 ENTRYSHEET_SERVICES_TEXTS     =

*         Find item info of service entry sheet to invoice item in
*         case of service based invoice verification: note 807380
          IF ekpo-lebre = 'X'.
            SELECT SINGLE * FROM ekbe INTO ls_servekbe
                            WHERE ebeln = rseg-ebeln
                            AND   ebelp = rseg-ebelp
                            AND   gjahr = rseg-gjahr
                            AND   belnr = rseg-belnr
                            AND   buzei = rseg-buzei.
            IF sy-subrc <> 0.
              CLEAR ls_servekbe.
            ENDIF.
          ENDIF.

          LOOP AT lt_bapiesll INTO bapiesll WHERE outl_ind NE c_signx.
*           Find matching item of service entry sheet to invoice item in
*           case of service based invoice verification: note 807380
            IF ekpo-lebre = 'X'.
              IF ls_servekbe-packno <> bapiesll-pckg_no
              OR ls_servekbe-introw <> bapiesll-line_no.
                CONTINUE.
              ENDIF.
            ENDIF.
            print_mrm-essl_netwr = bapiesll-net_value.
            IF print_mrm-essl_netwr < 0.                    "746114
              g_sign_esll = '-'.
            ELSE.
              CLEAR g_sign_esll.
            ENDIF.

            MOVE: bapiesll-ext_line    TO gs_commu_str_bapiesll-ext_line,
                  bapiesll-short_text  TO gs_commu_str_bapiesll-short_text,
                  bapiesll-service     TO gs_commu_str_bapiesll-service,
                  bapiesll-ext_serv    TO gs_commu_str_bapiesll-ext_serv,
                  bapiesll-quantity    TO gs_commu_str_bapiesll-quantity,
                  bapiesll-base_uom    TO gs_commu_str_bapiesll-base_uom,
                  print_mrm-essl_netwr TO gs_commu_str_bapiesll-essl_netwr,
                  rseg-pstyp           TO gs_commu_str_bapiesll-pstyp,
                  rseg-buzei           TO gs_commu_str_bapiesll-buzei.
            APPEND gs_commu_str_bapiesll TO gt_commu_str_bapiesll.
            CLEAR gs_commu_str_bapiesll.
*           Check whether all existing tax rates are existing, 757086
            IF NOT bapiesll-tax_code IS INITIAL.
              READ TABLE i_bset WITH KEY mwskz = bapiesll-tax_code
                         TRANSPORTING NO FIELDS.
              IF sy-subrc <> 0.
                CLEAR ls_bset.
                ls_bset-mandt = rbkp-mandt.
                ls_bset-bukrs = rbkp-bukrs.
                ls_bset-belnr = rbkp-belnr.
                ls_bset-gjahr = rbkp-gjahr.
                ls_bset-buzei = '001'.
                ls_bset-mwskz = bapiesll-tax_code.
                ls_bset-fwste = 0.
                APPEND ls_bset TO i_bset.
              ENDIF.
            ENDIF.
          ENDLOOP.
        ENDIF.
**** output of value: ER_PRICE
        MOVE: rseg-menge  TO gs_material_item-menge,
              rseg-bstme  TO gs_material_item-bstme,
              rseg-mwskz  TO gs_material_item-mwskz1,
              rseg-wrbtr  TO gs_material_item-wrbtr1.
***********  Sonstige Postionstypen    ********************************

      WHEN OTHERS.
* Bestellentwicklung Wareneingang (wegen KNUMV für Konditionen,
* BLDAT = Lieferscheindatum und Rücklieferungsinformationen)
        IF ( ( gs_options-kondr EQ 'X' ) OR
             ( gs_options-rinfo EQ 'X' ) OR
             ( gs_options-lsdat EQ 'X' ) ) AND
               rbkp-ivtyp       NE c_ivtyp_is.
          IF rseg-xekbz IS INITIAL.

            READ TABLE i_ekbe1  WITH KEY  ebeln = rseg-ebeln
                                          ebelp = rseg-ebelp
                                    vgabe = c_vgabe_we     "Wareneingang
                                          gjahr = rseg-lfgja
                                          belnr = rseg-lfbnr
                                          buzei = rseg-lfpos INTO ekbe.
            IF sy-subrc NE 0.
              CLEAR: ekbe.
            ENDIF.
          ELSE.
            IF rseg-kschl NE t685t-kschl.
              CALL FUNCTION 'MRM_DBTAB_T685T_READ'
                EXPORTING
                  i_spras         = nast-spras
                  i_kvewe         = 'A'
                  i_kappl         = 'M'
                  i_kschl         = rseg-kschl
*                 I_BUFFER_ON     = 'X'
                IMPORTING
                  e_t685t         = t685t
                EXCEPTIONS
                  entry_not_found = 1
                  OTHERS          = 2.
            ENDIF.
            IF NOT t685t-vtext IS INITIAL.
              MOVE t685t-vtext TO ekpo-txz01.
            ENDIF.
          ENDIF.
        ENDIF.

        IF rseg-xekbz IS INITIAL.
          CLEAR h_xekbz.

***** output of material header
          PERFORM print_matnr_head_pdf.

        ELSE.
          h_xekbz = 'X'.
          MOVE: g_posnr     TO gs_purch_doc_item-g_posnr,
                ekpo-matnr  TO gs_purch_doc_item-matnr,
                ekpo-txz01  TO gs_purch_doc_item-txz01_ekpo.
        ENDIF.

**** output of material position: ER_MAT_POS
* wenn keine Lieferscheinnummer erfaßt wurde => MatBelNr ausgeben
        IF rseg-xblnr IS INITIAL.
          rseg-xblnr = ekbe-belnr.
        ENDIF.
        IF rseg-xekbz IS INITIAL.
          MOVE: rseg-xblnr  TO gs_purch_doc_item-xblnr_rseg,
                ekbe-bldat  TO gs_purch_doc_item-bldat_ekbe,
                rseg-lfbnr  TO gs_purch_doc_item-lfbnr,
                rseg-lfpos  TO gs_purch_doc_item-lfpos,
                ekpo-ebeln  TO gs_purch_doc_item-ebeln,
                ekpo-ebelp  TO gs_purch_doc_item-ebelp,
                ekpo-konnr  TO gs_purch_doc_item-konnr,
                ekpo-ktpnr  TO gs_purch_doc_item-ktpnr.
        ELSE.

          MOVE: rseg-frbnr  TO gs_purch_doc_item-frbnr,
                ekpo-ebeln  TO gs_purch_doc_item-ebeln,
                ekpo-ebelp  TO gs_purch_doc_item-ebelp,
                ekpo-konnr  TO gs_purch_doc_item-konnr,
                ekpo-ktpnr  TO gs_purch_doc_item-ktpnr.
        ENDIF.

**** output of quantities and prices
* Ausgabe Konditionen
*ENHANCEMENT-SECTION     lmrmnf2c_02 SPOTS es_saplmrmn.
        IF ( gs_options-kondr EQ 'X' )  AND   " Konditionendruck aktiv?
           ( ekbe-knumv NE space OR    ".       WE-Kondition oder
             ekko-knumv NE space      ) AND ".  Einkaufsbelegkondition?
           ( rbkp-ivtyp NE c_ivtyp_is ). ".     nicht für Rech.Plan
          PERFORM select_cond USING  ekbe.
        ELSE.
          CLEAR: tkomvd, tkomvd[], tkomv, tkomv[].
        ENDIF.
*END-ENHANCEMENT-SECTION.
        IF NOT ( tkomvd[] IS INITIAL ).
          IF NOT ( rseg-menge IS INITIAL ) OR ( gs_options-kond0 EQ 'X' ).

            PERFORM print_cond_pdf.

          ENDIF.
        ENDIF.

* Ausgabe abgerechnete Menge
        IF ( ekpo-meins NE ekpo-bprme ).

          MOVE: rseg-bpmng    TO gs_purch_doc_item-bpmng,
                rseg-bprme    TO gs_purch_doc_item-bprme,
                g_sign_bstmg  TO gs_purch_doc_item-g_sign_bstmg.
        ENDIF.
        MOVE: rseg-menge     TO gs_purch_doc_item-menge,
              rseg-bstme     TO gs_purch_doc_item-bstme,
              rseg-mwskz     TO gs_purch_doc_item-mwskz,
              rseg-wrbtr     TO gs_purch_doc_item-wrbtr,
              g_sign_bstmg   TO gs_purch_doc_item-g_sign_bstmg,
              g_sign_wrbtr   TO gs_purch_doc_item-g_sign_wrbtr,
              rseg-buzei     TO gs_purch_doc_item-buzei,
              rseg-werks     TO gs_purch_doc_item-werks.

    ENDCASE.
***********  Ende positionstypspezifische Ausgabe    ******************

*ENHANCEMENT-POINT lmrmnf2c_04 SPOTS es_saplmrmn.
* Ausgabe Rücklieferungen
*ENHANCEMENT-SECTION     lmrmnf2c_03 SPOTS es_saplmrmn.
    IF  ( gs_options-rinfo EQ 'X' ) AND rbkp-ivtyp NE c_ivtyp_is
*     nicht bei WE-Sperrbestand
      AND NOT ( ekbe-menge = 0 AND ekbe-wesbs > 0 ).

      PERFORM print_back_pdf TABLES lt_qmel
                             USING  c_signx" Aufruf der Druckelemente
                                    i_ekbe1
                                    i_ekbe2_x
                                    ekbe.

    ENDIF.
*END-ENHANCEMENT-SECTION.
*   Output of accounting period for invoicing plan: note 822453
    IF rbkp-ivtyp = c_ivtyp_is AND NOT ekpo-fplnr IS INITIAL.
      CLEAR: lf_date, lt_fplt.
      SELECT MAX( budat ) FROM ekbe INTO lf_date
                          WHERE ebeln = ekpo-ebeln
                          AND   ebelp = ekpo-ebelp
                          AND   vgabe = '2'
                          AND   budat < rbkp-budat.
      CALL FUNCTION 'BILLING_SCHEDULE_READ'                 "899043
        EXPORTING
          fplnr = ekpo-fplnr
        TABLES
          zfpla = lt_fpla
          zfplt = lt_fplt.
      READ TABLE lt_fpla INTO fpla WITH KEY fplnr = ekpo-fplnr.
      LOOP AT lt_fplt INTO fplt WHERE fplnr = ekpo-fplnr    "840826
                                AND   fkdat > lf_date
                                AND   fkdat <= rbkp-budat.

        MOVE-CORRESPONDING fplt TO gs_billplan_date.
        APPEND gs_billplan_date TO gt_billplan_date.
        CLEAR gs_billplan_date.
      ENDLOOP.
    ENDIF.

* Berechnung Nettobetrag
    print_mrm-totsumv_logiv  =  print_mrm-totsumv_logiv + rseg-wrbtr.

*ENHANCEMENT-POINT lmrmnf2c_05 SPOTS es_saplmrmn.

    MOVE-CORRESPONDING rseg TO gs_rseg.
    APPEND gs_rseg TO gt_rseg.
    CLEAR  gs_rseg.

    APPEND gs_purch_doc_item TO gt_purch_doc_item.
    CLEAR  gs_purch_doc_item.

    APPEND gs_material_item TO gt_material_item.
    CLEAR  gs_material_item.

  ENDLOOP.
***** Ende Positionsverarbeitung **************************************

* Spaltenüberschriften auf eventueller Folgeseite löschen

  PERFORM print_netto_pdf USING rbkp-xrech.

* output tax lines:  TAX
  IF NOT ( i_bset[] IS INITIAL ).
    bkpf-waers = rbkp-waers.

    PERFORM print_tax_pdf USING i_bset.

  ENDIF.

  PERFORM print_brutto_pdf.

* output payment conditions
  IF gs_options-payme EQ 'X'.
    ls_t052-ztag1 = rbkp-zbd1t.
    ls_t052-zprz1 = rbkp-zbd1p.
    ls_t052-ztag2 = rbkp-zbd2t.
    ls_t052-zprz2 = rbkp-zbd2p.
    ls_t052-ztag3 = rbkp-zbd3t.

    PERFORM print_payment_pdf USING    ls_t052             "      --->
                                       s_objky             "      --->
                                       rbkp-zterm          "      --->
                                       rbkp-zfbdt.         "      --->
  ENDIF.

* output final text
  PERFORM print_final_pdf.
* Ausgabe der Frachtkosten

  IF ( gs_options-fracht EQ 'X' ) AND ( lf_fracht EQ 'X' ).

    MOVE: gs_options-fracht  TO gs_options_con-fracht,
          lf_fracht          TO gs_options_con-lf_fracht.

    PERFORM print_fracht_pdf USING  i_pritab_scd    "       --->
                                    i_essr              "       --->
                                    i_scd_tab           "       --->
                                    i_shp_tab.          "       --->

  ENDIF.
  gs_fm_docparams-langu = nast-spras.
  gs_fm_docparams-country = lfa1-land1.
* Pass ESLL also to print ESLL text if any
  APPEND LINES OF lt_bapiesll TO gt_esll.
  DELETE gt_esll WHERE outl_ind EQ 'X'. "Remove outlines
  APPEND LINES OF i_essr TO gt_essr.
  LOOP AT gt_ekpo INTO ls_ekpo.
    IF ls_ekpo-lebre EQ abap_true.
      DELETE gt_essr WHERE ebeln EQ ls_ekpo-ebeln AND ebelp EQ ls_ekpo-ebelp .
    ELSE.
      DELETE gt_esll WHERE pckg_no EQ ls_ekpo-packno.
    ENDIF.
  ENDLOOP.

*Get the details of short text to print only for TM data.
  IF gf_tm_data EQ abap_true.

    LOOP AT gt_rseg_tm INTO ls_rseg_tm.
      READ TABLE gt_ekpo INTO ls_ekpo WITH KEY ebeln = ls_rseg_tm-po_id ebelp = ls_rseg_tm-po_item.
      IF sy-subrc EQ 0.
        IF ls_ekpo-pstyp EQ '9'.
          IF ls_ekpo-lebre EQ abap_true.
            "Print from ESSR
            DELETE gt_material_item WHERE buzei EQ ls_rseg_tm-buzei.
          ELSE.
            "print from ESLL
            DELETE gt_material_item WHERE buzei EQ ls_rseg_tm-buzei.
            DELETE gt_commu_str_bapiesll WHERE buzei EQ ls_rseg_tm-buzei.
          ENDIF.
        ELSE.
          "Print from EKPO
          DELETE gt_commu_str_bapiesll WHERE buzei EQ ls_rseg_tm-buzei.
        ENDIF.
      ENDIF.
    ENDLOOP.

  ENDIF.

  PERFORM print_mr_pdf.

* Formular schließen
  CALL FUNCTION 'FP_JOB_CLOSE'
    EXCEPTIONS
      usage_error    = 1
      system_error   = 2
      internal_error = 3
      OTHERS         = 4.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.
ENDFORM.                    " CREATE_PRINTOUT_ERS_PDF
*&---------------------------------------------------------------------*
*&      Form  print_cond_pdf
*&---------------------------------------------------------------------*
FORM print_cond_pdf .
  LOOP AT tkomvd.
    komvd = tkomvd.
    IF komvd-kpein IS INITIAL.
      MOVE-CORRESPONDING komvd TO gs_price_det.
      APPEND gs_price_det TO gt_price_det.
      CLEAR gs_price_det.
    ELSE.
      MOVE-CORRESPONDING komvd TO gs_price_det.
      APPEND gs_price_det TO gt_price_det.
      CLEAR gs_price_det.

    ENDIF.
  ENDLOOP.

ENDFORM.                    " print_cond_pdf
*&---------------------------------------------------------------------*
*&      Form  print_matnr_head_PDF
*&---------------------------------------------------------------------*
FORM print_matnr_head_pdf .

  MOVE: g_posnr     TO gs_purch_doc_item-g_posnr,
        ekpo-matnr  TO gs_purch_doc_item-matnr,
        ekpo-txz01  TO gs_purch_doc_item-txz01_ekpo.
  IF ekpo-idnlf NE ' '.
    MOVE: marm-ean11  TO gs_purch_doc_item-ean11,
          ekpo-idnlf  TO gs_purch_doc_item-idnlf_ekpo.
  ELSEIF eina-idnlf NE ' ' OR marm-ean11 NE ' '.
    MOVE: marm-ean11  TO gs_purch_doc_item-ean11,
          eina-idnlf  TO gs_purch_doc_item-idnlf_eina.
  ENDIF.

ENDFORM.                    " print_matnr_head_PDF

*&---------------------------------------------------------------------*
*&      Form  PRINT_BACK_PDF
*&---------------------------------------------------------------------*
FORM print_back_pdf TABLES it_qmel     TYPE  typ_tqmel
                USING  if_druck    TYPE  keyflag
                       it_ekbe1    TYPE  typ_tab_ekbe
                       it_ekbe2_x  TYPE  typ_tab_ekbe
                 VALUE(is_ekbe1)   LIKE  ekbe. " EKBE Satz Org-WE

  DATA: lt_t157e TYPE  typ_tab_t157e.

  IF gs_options-grund EQ c_signx.
    SELECT * INTO TABLE lt_t157e FROM t157e
             FOR ALL ENTRIES IN it_ekbe1
                 WHERE   spras  = nast-spras
                   AND   bwart  =  it_ekbe1-bwart.
  ENDIF.

*ENHANCEMENT-POINT LMRMNF2J_01_PDF SPOTS ES_SAPLMRMN_PDF.
* Rücklieferung zum EK-Beleg (keine Retourenbestellung)
*ENHANCEMENT-SECTION     LMRMNF2J_02_PDF SPOTS ES_SAPLMRMN_PDF.

  MOVE: ekpo-retpo    TO gs_purch_doc_item-retpo,
        ekpo-retpo    TO gs_material_item-retpo.
  IF ekpo-retpo EQ space.

    PERFORM del_with_ref_pdf  TABLES it_qmel
                                 lt_t157e
                          USING  if_druck
                                 it_ekbe1
                                 it_ekbe2_x
                                 is_ekbe1.

* Retourenbestellung!
  ELSE.
    PERFORM del_without_ref_pdf  TABLES it_qmel
                                     lt_t157e
                              USING  if_druck
                                     is_ekbe1.
  ENDIF.

*END-ENHANCEMENT-SECTION.
ENDFORM.                               " PRINT_BACK

*&---------------------------------------------------------------------*
*&      Form  DEL_WITH_REF_PDF
*&---------------------------------------------------------------------*
FORM del_with_ref_pdf TABLES it_qmel     TYPE  typ_tqmel
                         it_t157e    TYPE  typ_tab_t157e
                  USING  if_druck    TYPE  keyflag
                         it_ekbe1    TYPE  typ_tab_ekbe
                         it_ekbe2_x  TYPE  typ_tab_ekbe
                 VALUE(is_ekbe1)   LIKE  ekbe. " EKBE Satz Org-WE

  DATA: lt_ekbe1*          LIKE  ekbe OCCURS 0 WITH HEADER LINE,
        ls_ekbe            LIKE  ekbe,
        ls_qmel            TYPE  typ_qmel,
        ls_rbkpv           TYPE  mrm_rbkpv,
        lf_cpudt           LIKE  ekbe-cpudt,
        lf_cputm           LIKE  ekbe-cputm,
        lf_objkey          LIKE  borident-objkey,
        lf_delivery_number LIKE  ekbe-xblnr.

  CLEAR: lt_ekbe1*, lt_ekbe1*[], lf_cpudt, lf_cputm,
         it_qmel,   it_qmel[],   g_qmnum,  g_qmdat,
         ls_ekbe,   ls_qmel, lf_delivery_number.
* I_ekbe1 wurde bereits gelesen:
  print_mrm-menge_ur   = is_ekbe1-menge.
  print_mrm-menge_back = 0 - is_ekbe1-menge.
* Ermittlung der rückgelieferten Menge
  LOOP AT it_ekbe1 INTO ls_ekbe  WHERE   ebeln    =  is_ekbe1-ebeln
                                   AND   ebelp    =  is_ekbe1-ebelp
                                   AND   vgabe    =  c_vgabe_we
                                   AND   lfgja    =  is_ekbe1-lfgja
                                   AND   lfbnr    =  is_ekbe1-lfbnr
                                   AND   lfpos    =  is_ekbe1-lfpos
                                   AND   zekkn    =  is_ekbe1-zekkn.
    IF ls_ekbe-shkzg EQ 'H'.
      ls_ekbe-menge = 0 - ls_ekbe-menge.
    ENDIF.
    print_mrm-menge_back  =  print_mrm-menge_back  +  ls_ekbe-menge.
  ENDLOOP.
* Rücklieferungen vorhanden?
  IF print_mrm-menge_back NE 0.
* Einlesen Original-Rechnung
    READ TABLE it_ekbe2_x  INTO ekbe WITH KEY lfbnr = ls_ekbe-lfbnr
                                              lfgja = ls_ekbe-lfgja.
    IF sy-subrc NE 0.                  " Komplett-Storno/Rücklieferung:
      ekbe-belnr = rbkp-belnr.         " WE und WA werden im
      ekbe-bldat = rbkp-bldat.         " aktuellen Rechnungsbeleg
      CLEAR: print_mrm-xblnr_ur.
    ELSE. " get external invoice number of the orginal inv.
      CALL FUNCTION 'MRM_DBTAB_RBKPV_READ'
        EXPORTING
          i_belnr = ekbe-belnr
          i_gjahr = ekbe-gjahr
        IMPORTING
          e_rbkpv = ls_rbkpv
        EXCEPTIONS
          OTHERS  = 1.
      IF ( sy-subrc EQ 0 ) AND
         ( ls_rbkpv-xblnr NE ls_rbkpv-belnr ).
        print_mrm-xblnr_ur = ls_rbkpv-xblnr.
      ELSE.
        CLEAR: print_mrm-xblnr_ur.
      ENDIF.
    ENDIF.                             " abgerechnet (Nullposition)
* Druck Rücklieferungskopf
    IF if_druck EQ c_signx.
      ekbe-xblnr = is_ekbe1-xblnr.     " Bezug zum urspr. Liefers
      ekbe-lfbnr = is_ekbe1-belnr.     " bzw. zum urspr. Materialb

      MOVE: ekbe-xblnr          TO  gs_purch_doc_item-xblnr_ekbe,
            print_mrm-menge_ur  TO  gs_purch_doc_item-menge_ur,
            ekpo-meins          TO  gs_purch_doc_item-meins,
            ekbe-lfbnr          TO  gs_purch_doc_item-lfbnr_ekbe,
            ekbe-belnr          TO  gs_purch_doc_item-belnr,
            ekbe-bldat          TO  gs_purch_doc_item-bldat,
            ekbe-xblnr          TO  gs_material_item-xblnr_ekbe,
            print_mrm-menge_ur  TO  gs_material_item-menge_ur,
            ekpo-meins          TO  gs_material_item-meins,
            ekbe-lfbnr          TO  gs_material_item-lfbnr_ekbe,
            ekbe-belnr          TO  gs_material_item-belnr,
            ekbe-bldat          TO  gs_material_item-bldat.

    ENDIF.
* Vorbereitung Positionsausgabe

* Zeitpunkt der vorletzten Rechnung ermitteln damit nur die in der
* aktuellen Rechnung abgerechneten Rücklieferungen angedruckt werden
    IF ( gs_options-rinfa EQ 'X' ).
      SELECT * INTO TABLE lt_ekbe1* FROM ekbe
               WHERE  ebeln    =  is_ekbe1-ebeln
               AND    ebelp    =  is_ekbe1-ebelp
               AND    vgabe    =  c_vgabe_re             "Rechnung
               AND    lfgja    =  is_ekbe1-lfgja
               AND    lfbnr    =  is_ekbe1-lfbnr
               AND    lfpos    =  is_ekbe1-lfpos
               AND   ( ( cpudt    LT   rbkp-cpudt ) OR
                     ( ( cpudt    EQ   rbkp-cpudt ) AND
                       ( cputm    LT   rbkp-cputm ) ) ).

      SORT lt_ekbe1* DESCENDING BY cpudt cputm.
      LOOP AT lt_ekbe1*.
        CHECK lt_ekbe1*-belnr NE rbkp-belnr.
        lf_cpudt = lt_ekbe1*-cpudt.
        lf_cputm = lt_ekbe1*-cputm.
        EXIT.
      ENDLOOP.
    ENDIF.

* Andruck der rückgelieferten Positionen
    LOOP AT it_ekbe1 INTO ekbe  WHERE   ebeln    =  is_ekbe1-ebeln
                                  AND   ebelp    =  is_ekbe1-ebelp
                                  AND   vgabe    =  c_vgabe_we
                                  AND   lfgja    =  is_ekbe1-lfgja
                                  AND   lfbnr    =  is_ekbe1-lfbnr
                                  AND   lfpos    =  is_ekbe1-lfpos.
      CHECK ekbe-belnr NE ekbe-lfbnr.  " Org-WE nicht andrucken
      CLEAR: g_qmnum, g_qmdat.
* Nur die tatsächlich rückgelieferten WEs andrucken?
      IF ( gs_options-rinfa EQ 'X' ).
        CHECK ( ( lf_cpudt    LT   ekbe-cpudt ) OR
              ( ( lf_cpudt    EQ   ekbe-cpudt ) AND
                ( lf_cputm    LT   ekbe-cputm ) ) ).
      ENDIF.
* Text des Rücklieferungsgrunds ermitteln
      IF NOT ekbe-grund IS INITIAL.
        READ TABLE it_t157e INTO t157e WITH KEY spras = nast-spras
                                                bwart = ekbe-bwart
                                                grund = ekbe-grund.
        IF sy-subrc NE 0.
          CLEAR: t157e.
        ENDIF.
      ELSE.
        CLEAR: t157e.
      ENDIF.
* Rücklieferung mit SD?
      PERFORM get_delivery_number USING    ekbe-belnr
                                           ekbe-gjahr
                                  CHANGING lf_delivery_number.
* Bezug zum Materialbeleg (Rücklieferung ohne SD)
      IF lf_delivery_number IS INITIAL.
        IF if_druck EQ c_signx.

          MOVE: ekbe-ebelp    TO  gs_return_del-ebelp,
                ekbe-belnr    TO  gs_return_del-belnr,
                ekbe-bwart    TO  gs_return_del-bwart,
                ekbe-menge    TO  gs_return_del-menge,
                ekbe-shkzg    TO  gs_return_del-shkzg,
                ekpo-meins    TO  gs_return_del-meins,
                t157e-grtxt   TO  gs_return_del-grtxt.

        ENDIF.                         " Druck
* Bezug zum Lieferschein (Rücklieferung mit SD)
      ELSE.
        ekbe-xblnr = lf_delivery_number. " Druckausgabe über ekbe-xblnr!
        lf_objkey  = lf_delivery_number.
        CALL FUNCTION 'QM11_GET_QNUMBER'
          EXPORTING
            if_objtype     = c_objtyp_deliv
            if_objkey      = lf_objkey
            if_own_log_sys = gf_own_log_sys
          IMPORTING
            ef_qmnum       = g_qmnum
            ef_qmdat       = g_qmdat.

        IF if_druck EQ c_signx.

          MOVE: ekbe-ebelp  TO  gs_return_del-ebelp,
                ekbe-xblnr  TO  gs_return_del-xblnr,
                ekbe-bwart  TO  gs_return_del-bwart,
                g_qmnum     TO  gs_return_del-g_qmnum,
                g_qmdat     TO  gs_return_del-g_qmdat,
                ekbe-menge  TO  gs_return_del-menge,
                ekbe-shkzg  TO  gs_return_del-shkzg,
                ekpo-meins  TO  gs_return_del-meins,
                t157e-grtxt TO  gs_return_del-grtxt.

        ELSE.
          IF NOT g_qmnum IS INITIAL.   " Tab für EDI-Ausgabe aufbauen
            ls_qmel-qmnum = g_qmnum.
            ls_qmel-qmdat = g_qmdat.
            APPEND ls_qmel TO it_qmel.
          ENDIF.
        ENDIF.                         " Druck
      ENDIF.                           " mit / ohne SD

      APPEND gs_return_del TO gt_return_del.
      CLEAR gs_return_del.
    ENDLOOP.
* Summe Rücklieferungen
    IF if_druck EQ c_signx.
      IF print_mrm-menge_back < 0.
        g_sign_ers = '-'.
      ELSE.
        CLEAR g_sign_ers.
      ENDIF.

      MOVE: print_mrm-menge_back TO gs_purch_doc_item-menge_back,
            g_sign_ers           TO gs_purch_doc_item-g_sign_ers,
            ekpo-meins           TO gs_purch_doc_item-mein_ekpo,
            print_mrm-menge_back TO gs_material_item-menge_back,
            g_sign_ers           TO gs_material_item-g_sign_ers,
            ekpo-meins           TO gs_material_item-mein_ekpo.

    ENDIF.                             " Druck
  ENDIF.

ENDFORM.                               " DEL_WITH_REF

*ENHANCEMENT-POINT LMRMNF2I_01_PDF SPOTS ES_SAPLMRMN_PDF STATIC.

*&---------------------------------------------------------------------*
*&      Form  DEL_WITHOUT_REF_PDF
*&---------------------------------------------------------------------*
FORM del_without_ref_pdf TABLES   it_qmel     TYPE  typ_tqmel
                              it_t157e    TYPE  typ_tab_t157e
                     USING    if_druck    TYPE  keyflag
                     VALUE(is_ekbe1)   LIKE  ekbe. " EKBE Satz Org-WE

  DATA: ls_qmel            TYPE  typ_qmel,
        lf_objkey          LIKE  borident-objkey,
        lf_delivery_number LIKE  ekbe-xblnr.

  CLEAR: it_qmel, it_qmel[], g_qmnum, g_qmdat, ls_qmel.

* Lieferscheinnummer ermitteln
  PERFORM get_delivery_number USING    is_ekbe1-belnr
                                       is_ekbe1-gjahr
                              CHANGING lf_delivery_number.
  ekbe-xblnr = lf_delivery_number.     " Druckausgabe über ekbe-xblnr!
* Bezug zur Q-Meldung ermitteln
  lf_objkey = is_ekbe1-ebeln.
  CALL FUNCTION 'QM11_GET_QNUMBER'
    EXPORTING
      if_objtype     = c_objtyp_order
      if_objkey      = lf_objkey
      if_own_log_sys = gf_own_log_sys
    IMPORTING
      ef_qmnum       = g_qmnum
      ef_qmdat       = g_qmdat.

* Text des Rücklieferungsgrunds ermitteln
  IF NOT is_ekbe1-grund IS INITIAL.
    READ TABLE it_t157e INTO t157e WITH KEY spras = nast-spras
                                            bwart = is_ekbe1-bwart
                                            grund = is_ekbe1-grund.
    IF sy-subrc NE 0.
      CLEAR: t157e.
    ENDIF.
  ELSE.
    CLEAR: t157e.
  ENDIF.
* Druckausgabe
  IF if_druck EQ c_signx.

    MOVE: ekbe-xblnr   TO gs_return_del-xblnr,
          g_qmnum      TO gs_return_del-g_qmnum,
          g_qmdat      TO gs_return_del-g_qmdat ,
          t157e-grtxt  TO gs_return_del-grtxt,
          ekbe-xblnr   TO gs_return_del-xblnr,
          g_qmnum      TO gs_return_del-g_qmnum,
          g_qmdat      TO gs_return_del-g_qmdat ,
          t157e-grtxt  TO gs_return_del-grtxt.
    APPEND gs_return_del TO gt_return_del.
    CLEAR gs_return_del.

  ELSE.
    IF NOT g_qmnum IS INITIAL.         " Tab für EDI-Ausgabe aufbauen
      ls_qmel-qmnum = g_qmnum.
      ls_qmel-qmdat = g_qmdat.
      APPEND ls_qmel TO it_qmel.
    ENDIF.
  ENDIF.                               " Druck

ENDFORM.                               " DEL_WITHOUT_REF

*&---------------------------------------------------------------------*
*&      Form  PRINT_FRACHT_PDF
*&---------------------------------------------------------------------*
FORM print_fracht_pdf USING  i_pritab_scd TYPE v54a0_ers_pritab_scd_tab
                         i_essr       TYPE typ_tab_essr
                         i_scd_tab    TYPE v54a0_scdd_tab
                         i_shp_tab    TYPE v54a0_refobj_tab.

* Lokale Daten für Frachtkostenanlage
  DATA: l_pritab_scd_wa TYPE v54a0_ers_pritab_scd,
        l_scd_wa        TYPE v54a0_scdd,
        l_scd_item_wa   TYPE v54a0_scd_item,
        l_shp_wa        TYPE v54a0_refobj,
        l_vttsf_wa      TYPE v54a0_vttsf,
        l_essr          TYPE typ_tab_essr,
        l_mwskz(1)      TYPE c,
        l_fknum         TYPE fknum.                         "916314

  l_essr[] = i_essr[].
  SORT l_essr BY fknum fkpos.

* Ausgabe pro Frachtkostenposition (d.h. in der Regel
* pro Transportabschnitt)
  LOOP AT i_pritab_scd INTO l_pritab_scd_wa
*                      WHERE TKNUM <> SPACE.
                       WHERE scd_deleted <> 'X'.

    PERFORM scd_item_get USING l_pritab_scd_wa-fknum
                               l_pritab_scd_wa-fkpos
                               i_scd_tab
                               l_scd_wa
                               l_scd_item_wa.

    READ TABLE i_essr INTO essr WITH KEY
                                lblni = l_pritab_scd_wa-lfbnr
                                BINARY SEARCH.
    IF sy-subrc <> 0.
      PERFORM protocol USING c_msgid_vy
                             c_msgty_error            '002'
                             'READ TABLE I_ESSR'      ''
                             l_pritab_scd_wa-fknum
                             l_pritab_scd_wa-fkpos.
    ENDIF.

*   Neuer Transport: Transportnummer und Datum
    AT NEW tknum.                                       "#EC AT_LOOP_WH
      PERFORM shipment_get USING l_pritab_scd_wa-tknum
                                 i_shp_tab
                                 l_shp_wa.
      MOVE-CORRESPONDING l_shp_wa-vttkf TO vttkf.

      MOVE: vttkf-tknum    TO gs_shipment_det-tknum,
            vttkf-dtabf    TO gs_shipment_det-dtabf.

      CLEAR g_shp_netwr.
      CLEAR g_shp_mwsbp.
    ENDAT.

*   Neuer Transportabschnitt: Beschreibung
    AT NEW tsnum.                                       "#EC AT_LOOP_WH
      IF l_pritab_scd_wa-tsnum IS INITIAL.

        MOVE: vttkf-exti1    TO gs_shipment_det-exti1.

      ELSE.
        READ TABLE l_shp_wa-vttsf INTO l_vttsf_wa WITH KEY
                                  tknum = l_pritab_scd_wa-tknum
                                  tsnum = l_pritab_scd_wa-tsnum.

        IF sy-subrc IS INITIAL.
          MOVE-CORRESPONDING l_vttsf_wa TO vttsf.

          SELECT SINGLE * FROM t005 WHERE land1 = l_vttsf_wa-land1a.
          CONCATENATE t005-landk l_vttsf_wa-pstlza INTO g_pstlza_s
                      SEPARATED BY space.

          IF NOT ( l_vttsf_wa-land1z IS INITIAL ).
            SELECT SINGLE * FROM t005 WHERE land1 = l_vttsf_wa-land1z.
            CONCATENATE t005-landk l_vttsf_wa-pstlzz INTO g_pstlzz_s
                        SEPARATED BY space.
          ELSE.
            CLEAR g_pstlzz_s.
          ENDIF.

          IF l_vttsf_wa-tstyp = tstyp-1.

            MOVE: g_pstlza_s    TO gs_shipment_det-g_pstlza_s,
                  vttsf-tort2a  TO gs_shipment_det-tort2a,
                  g_pstlzz_s    TO gs_shipment_det-g_pstlzz_s,
                  vttsf-tort2z  TO gs_shipment_det-tort2z,
                  vttsf-medst   TO gs_shipment_det-medst,
                  vttsf-distz   TO gs_shipment_det-distz,
                  vttsf-medst   TO gs_shipment_det-medst.
          ELSE.
            MOVE: g_pstlza_s    TO gs_shipment_det-g_pstlza_s,
                  vttsf-tort2a  TO gs_shipment_det-tort2a,
                  g_pstlzz_s    TO gs_shipment_det-g_pstlzz_s,
                  vttsf-tort2z  TO gs_shipment_det-tort2z.

          ENDIF.
        ENDIF.
      ENDIF.
    ENDAT.

*   New freight cost item: Freight cost items may only be printed once
*   Table i_pritab_scd might contain the same freight cost item several
*   times in case one freight cost item is splitted into several service
*   entry sheets. The duplicate entries are not deleted in subroutine
*   FILL_PRITAB_SCD.
    AT NEW fkpos.                                 "New freight cost item    "#EC AT_LOOP_WH
      MOVE-CORRESPONDING l_scd_item_wa-vfkp TO vfkpvb.
      MOVE: vfkpvb-fknum   TO gs_shipment_det-fknum,
            vfkpvb-fkpos   TO gs_shipment_det-fkpos.

*     Check if price conditions matches to the mat. doc. from RSEG
      IF l_pritab_scd_wa-not_last_document <> 'X'.

        PERFORM shipment_values_sumup USING    l_scd_item_wa
                                               rbkp-waers
                                      CHANGING g_shp_netwr
                                               g_shp_mwsbp.
*       Preiskonditionen
        PERFORM scd_item_conditions_get TABLES   tkomvd
                                                 l_scd_item_wa-komv
                                        USING    l_scd_item_wa
                                        CHANGING l_mwskz.
        IF NOT ( tkomvd[] IS INITIAL ).
          LOOP AT tkomvd INTO komvd.
            IF komvd-krech IS INITIAL.

              MOVE: komvd-vtext  TO  gs_price_det-vtext,
                    komvd-kwert  TO  gs_price_det-kwert,
                    komvd-krech  TO  gs_price_det-krech,
                    komvd-koei1  TO  gs_price_det-koei1.
            ELSE.
*             Kontollieren ob Kondition mit Matrixpflege vorliegt
              IF NOT ( komvd-mdflg IS INITIAL ).
                MOVE: komvd-vtext  TO  gs_price_det-vtext,
                      komvd-kwert  TO  gs_price_det-kwert,
                      komvd-mdflg  TO  gs_price_det-mdflg,
                      komvd-koei1  TO  gs_price_det-koei1.
              ELSE.
                MOVE: komvd-kmein  TO  gs_price_det-kmein,
                      komvd-vtext  TO  gs_price_det-vtext,
                      komvd-kawrt  TO  gs_price_det-kawrt,
                      komvd-awein  TO  gs_price_det-awein,
                      komvd-kbetr  TO  gs_price_det-kbetr,
                      komvd-koein  TO  gs_price_det-koein,
                      komvd-kwert  TO  gs_price_det-kwert,
                      komvd-kpein  TO  gs_price_det-kpein,
                      komvd-kmein  TO  gs_price_det-kmein,
                      komvd-koei1  TO  gs_price_det-koei1.
              ENDIF.
              MOVE:  vfkpvb-fkpos TO gs_price_det-kposn.
              APPEND gs_price_det TO gt_price_det.
              CLEAR  gs_price_det.

            ENDIF.
          ENDLOOP.
        ENDIF.

        g_scditem_brtwr = l_scd_item_wa-vfkp-netwr +
                          l_scd_item_wa-vfkp-mwsbp.

        MOVE: g_scditem_brtwr  TO gs_shipment_det-g_scditem_brtwr.
      ELSE.
        IF l_pritab_scd_wa-shkzg = 'S'.
          MOVE: l_pritab_scd_wa-shkzg  TO gs_shipment_det-shkzg.
        ENDIF.
      ENDIF.
    ENDAT.                                    "END New freight cost item

*   Last entry of current transport: sum up freight costs
*   The gross value of the transport is stored in the last entry of
*   global table gt_shipment_det
    AT END OF tknum.                                    "#EC AT_LOOP_WH
      g_shp_brtwr = g_shp_netwr + g_shp_mwsbp.
*     The new freight cost item is appended to the global table
*     gt_shipment_det hence the gross value can be moved to structure#
*     gs_shipment_det
      IF NOT gs_shipment_det-fknum IS INITIAL
        AND NOT gs_shipment_det-fkpos IS INITIAL.
        MOVE: g_shp_brtwr  TO  gs_shipment_det-g_shp_brtwr.
      ELSE.
*       No new freight cost item so the gross value of the transport is
*       stored in the last entry of global table gt_shipment_det
        LOOP AT gt_shipment_det INTO gs_shipment_det.
          AT LAST.
            MOVE: g_shp_brtwr  TO  gs_shipment_det-g_shp_brtwr.
            MODIFY gt_shipment_det INDEX sy-tabix
              FROM gs_shipment_det TRANSPORTING g_shp_brtwr.
            CLEAR: gs_shipment_det.
          ENDAT.
        ENDLOOP.
      ENDIF.
    ENDAT.

*   New freight cost item:
    AT NEW fkpos.                                       "#EC AT_LOOP_WH
      APPEND gs_shipment_det  TO gt_shipment_det.
      CLEAR  gs_shipment_det.
    ENDAT.
  ENDLOOP.

* Check if there are item refrencing to deleted SCD's
  READ TABLE i_pritab_scd INTO l_pritab_scd_wa
*                         WITH KEY TKNUM = SPACE.
                          WITH KEY scd_deleted = 'X'.

  MOVE: sy-subrc   TO gs_options_con-subrc.
  CHECK sy-subrc = 0.

* Print out of deleted SCD's
  SORT i_pritab_scd BY fknum fkpos.
  CLEAR l_fknum.                                            "916314
  LOOP AT i_pritab_scd INTO l_pritab_scd_wa
*                      WHERE TKNUM = SPACE.
                       WHERE scd_deleted = 'X'.
*   New SCD: SCD number
    IF l_pritab_scd_wa-fknum <> l_fknum.                    "916314
      MOVE: l_pritab_scd_wa-fknum TO vfkpvb-fknum,
            l_pritab_scd_wa-fknum TO l_fknum.

      MOVE: l_pritab_scd_wa-fknum  TO gs_shipcostdet_header-fknum_vfkk,
            l_fknum                TO gs_shipcostdet_header-l_fknum,
            vfkpvb-fknum           TO gs_shipcostdet_header-fknum_vfkpvb,
            l_pritab_scd_wa-fkpos  TO gs_shipcostdet_header-fkpos.

    ENDIF.                                                  "916314
    LOOP AT l_essr INTO essr
                   WHERE fknum = l_pritab_scd_wa-fknum      "916314
                   AND   fkpos = l_pritab_scd_wa-fkpos.
*     Print SES number and references
      MOVE-CORRESPONDING essr     TO gs_shipcostdet_itetm.
      APPEND gs_shipcostdet_itetm TO gt_shipcostdet_itetm.
      CLEAR  gs_shipcostdet_itetm.
    ENDLOOP.

    APPEND gs_shipcostdet_header  TO gt_shipcostdet_header.
    CLEAR  gs_shipcostdet_header.
  ENDLOOP.

ENDFORM.                    "PRINT_FRACHT_PDF
" PRINT_FRACHT
*&---------------------------------------------------------------------*
*&      Form  PRINT_MR_PDF
*&---------------------------------------------------------------------*
FORM print_mr_pdf.

* Setting for sending document vai E-mail.
  DATA: lv_emailaddr TYPE adr6-smtp_addr,
        os_formout   TYPE fpformoutput.

* Setting for sending FAX
  DATA : lv_cam_address      TYPE REF TO cl_cam_address_bcs,
         lv_outputparams_fax TYPE sfpoutpar,
         lv_vend_cntry       TYPE lfa1-land1.

* BCS data
  DATA:
    send_request   TYPE REF TO cl_bcs,
    document       TYPE REF TO cl_document_bcs,
    recipient      TYPE REF TO if_recipient_bcs,
    bcs_exception  TYPE REF TO cx_bcs,
    lv_sent_to_all TYPE os_boolean,
    lp_pdf_size    TYPE so_obj_len,
    lv_subject     TYPE so_obj_des,
    ls_tnati       TYPE tnati,                              "1524684
    lv_add_nr      TYPE adr6-addrnumber.

* Archiving specific data declaration "1489677
  DATA: lv_pdf_size      TYPE i,
        lv_archiveformat LIKE toadd-doc_type,  "PDF or OTF
        lv_documentclass LIKE toadv-doc_type.

*---calling PDF FM
  CALL FUNCTION gv_fm_name
    EXPORTING
      /1bcdwb/docparams     = gs_fm_docparams
      address               = gs_address
      gs_options_info       = gs_options_info
      rbkp_info             = gs_rbkp_info
      bkpf_info             = gs_bkpf_info
      lfa1_info             = gs_lfa1_info
      lfb1_info             = gs_lfb1_info
      t001_info             = gs_t001_info
      tsad3t_info           = gs_tsad3t_info
      addr3_val_info        = gs_addr3_val_info
      t005_info             = gs_t005_info
      adsmtp_info           = gs_adsmtp_info
      rp_head               = gs_rp_head
      rp_pos                = gt_rp_pos
      netto_brutto          = gs_netto_brutto
      plant_head            = gt_plants_t001w
      item_details          = gt_rm08nast_item_details
      tax_details           = gt_rm08nast_tax_details
      tax_details_rap       = gt_tax_details_rap
      payment_terms         = gt_payment_terms
      x_auto                = auto_x
      x_txjcd               = txjcd_x
      gf_cp_peinhprint      = gf_cp_peinhprint
      address_text          = gt_dynamic_text
      repeat                = repeat_x
      material_subtotals    = gt_material_subtotals
      material_header       = gt_material_header
      material_item         = gt_material_item
      material_totals       = gs_material_totals
      gt_purch_doc_item     = gt_purch_doc_item
      gt_commu_str_bapiesll = gt_commu_str_bapiesll
      gt_shipment_det       = gt_shipment_det
      gt_shipcostdet_header = gt_shipcostdet_header
      gt_shipcostdet_itetm  = gt_shipcostdet_itetm
      gt_billplan_date      = gt_billplan_date
      gt_return_del         = gt_return_del
      gs_options            = gs_options_con
      rbkp                  = rbkp
      rseg                  = gt_rseg
      gt_price_det_komvd    = gt_price_det
      komk                  = komk
      ekpo                  = ekpo
      vttsf                 = vttsf
      it_rseg_tm            = gt_rseg_tm
      if_tm_data            = gf_tm_data
      is_ekko               = ekko
      it_ekpo               = gt_ekpo
      it_esll               = gt_esll
      it_essr               = gt_essr
    IMPORTING
      /1bcdwb/formoutput    = os_formout
    EXCEPTIONS
      usage_error           = 1
      system_error          = 2
      internal_error        = 3
      OTHERS                = 4.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

* INI CGIJON - descargamos PDF a local para poder adjuntarlo a la factura
  IF sy-ucomm <> 'VIEW'.
    DATA: lt_binary_tab TYPE STANDARD TABLE OF soli.
    CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
      EXPORTING
        buffer     = os_formout-pdf
      TABLES
        binary_tab = lt_binary_tab.

    DATA: filename1 TYPE string.
    CONCATENATE 'C:\temp\Factura quincenal_' rbkp-belnr rbkp-gjahr '.pdf' INTO filename1.

    CALL METHOD cl_gui_frontend_services=>gui_download
      EXPORTING
        filename                = filename1
        filetype                = 'BIN'
      CHANGING
        data_tab                = lt_binary_tab
      EXCEPTIONS
        file_write_error        = 1
        no_batch                = 2
        gui_refuse_filetransfer = 3
        invalid_type            = 4
        no_authority            = 5
        unknown_error           = 6
        header_not_allowed      = 7
        separator_not_allowed   = 8
        filesize_not_allowed    = 9
        header_too_long         = 10
        dp_error_create         = 11
        dp_error_send           = 12
        dp_error_write          = 13
        unknown_dp_error        = 14
        access_denied           = 15
        dp_out_of_memory        = 16
        disk_full               = 17
        dp_timeout              = 18
        file_not_found          = 19
        dataprovider_exception  = 20
        control_flush_error     = 21
        not_supported_by_gui    = 22
        error_no_gui            = 23
        OTHERS                  = 24.
    IF sy-subrc <> 0.
    ENDIF.
* FIN CGIJON - descargamos PDF a local para poder adjuntarlo a la factura



    IF g_xscreen IS INITIAL AND
    ( nast-nacha EQ 5 OR nast-nacha EQ 2 ) AND os_formout IS NOT INITIAL.

* get default Email id from address no
* When there is only one mail id then that will have default flag set
      SELECT SINGLE smtp_addr FROM adr6 INTO lv_emailaddr WHERE addrnumber =  gs_address-adrnr
                                                            AND flgdefault = abap_true.
* Set FAX specific setting
      IF nast-nacha EQ 5.
        lv_outputparams_fax-telenum = gs_itcpo-tdtelenum.
        lv_outputparams_fax-teleland = gs_itcpo-tdteleland.
      ELSE.
        IF nast-telfx NE space.
          lv_outputparams_fax-telenum  = nast-telfx.
          IF nast-tland IS INITIAL.
            lv_outputparams_fax-teleland = gs_address-land1.
          ELSE.
            lv_outputparams_fax-teleland = nast-tland.
          ENDIF.
        ENDIF.
      ENDIF.



      IF ( nast-kschl = 'ZERS' AND nast-nacha = '5' ) OR  "cgijon
         gf_comm_type EQ 'FAX' OR gf_comm_type EQ 'INT' OR nast-nacha EQ 2.
* ------------ Call BCS interface ----------------------------------
        TRY.
*   ---------- create persistent send request ----------------------
            send_request = cl_bcs=>create_persistent( ).

*   ---------- add document ----------------------------------------
*   get PDF xstring and convert it to BCS format
            lp_pdf_size = xstrlen( os_formout-pdf ).
            PERFORM xstring_to_solix
                       USING
                          os_formout-pdf.
*Cover title                                                "1524684
*          IF nast-tdcovtitle IS NOT INITIAL.                "1524684
*            lv_subject = nast-tdcovtitle.                   "1524684
*          ELSE.                                             "1524684
*            SELECT SINGLE * FROM tnati INTO ls_tnati        "1524684
*                           WHERE spras EQ nast-spras        "1524684
*                                 AND kappl EQ nast-kappl    "1524684
*                                 AND kschl EQ nast-kschl.   "1524684
*            IF sy-subrc EQ 0.                               "1524684
*              lv_subject = ls_tnati-objdes.                 "1524684
*            ELSE.                                           "1524684
*              lv_subject = nast-objky+4(14).                "1524684
*            ENDIF.                                          "1524684
*          ENDIF.

            CONCATENATE 'Factura quincenal' rbkp-belnr rbkp-gjahr INTO lv_subject
            SEPARATED BY space.                             "1524684


            DATA: lt_mail_text TYPE bcsy_text.
            PERFORM get_mail_body USING nast
                                  CHANGING lt_mail_text.


            document = cl_document_bcs=>create_document(
                  i_type    = 'RAW'
                  i_subject = lv_subject
                  i_text =  lt_mail_text ).


*   Adjuntamos el PDF
            CALL METHOD document->add_attachment(
                i_attachment_type    = 'PDF'                        "#EC NOTEXT
                i_attachment_subject = lv_subject         "#EC NOTEXT
                i_attachment_size    = lp_pdf_size
                i_att_content_hex    = pdf_content ).



*   add document to send request
            send_request->set_document( document ).

*     --------- set sender -------------------------------------------
*     note: this is necessary only if you want to set the sender
*           different from actual user (SY-UNAME). Otherwise sender is
*           set automatically with actual user.



*      sender = cl_sapuser_bcs=>create( lv_mail ).
*      CALL METHOD send_request->set_sender
*        EXPORTING i_sender = sender.

            DATA: lo_sender     TYPE REF TO cl_cam_address_bcs,
                  lv_sender     TYPE adr6-smtp_addr,
                  lo_send_email TYPE REF TO cl_bcs.




*         email del centro emisor de la factura
            SELECT SINGLE smtp_addr FROM adr6
              INTO lv_sender
              WHERE addrnumber = gs_t001_info-adrnr.

            lo_sender = cl_cam_address_bcs=>create_internet_address( lv_sender  ).
            send_request->set_sender( i_sender = lo_sender ).





*   ---------- add recipient (e-mail address) ----------------------

            CASE nast-nacha.
              WHEN 5.
                IF gf_comm_type EQ 'INT'.
*           add recipient (e-mail address)
                  recipient = recipient = cl_cam_address_bcs=>create_internet_address(
                  i_address_string = lv_emailaddr ).
                ELSE.
*           add recipient (fax address)
                  recipient = cl_cam_address_bcs=>create_fax_address(
                                   i_country = lv_outputparams_fax-teleland
                                   i_number  = lv_outputparams_fax-telenum ).
                ENDIF.
              WHEN 2.
*           add recipient (fax address)
                recipient = cl_cam_address_bcs=>create_fax_address(
                                 i_country = lv_outputparams_fax-teleland
                                 i_number  = lv_outputparams_fax-telenum ).
            ENDCASE.

*   add recipient to send request
            send_request->add_recipient( i_recipient = recipient ).

*   ---------- send document ---------------------------------------
            lv_sent_to_all = send_request->send(
                i_with_error_screen = 'X' ).
* Issue message and COMMINT only if the subroutine is not called in update task
            IF gf_inupd = 0.
              IF lv_sent_to_all = 'X'.
                MESSAGE i022(so).
              ENDIF.

*   ---------- explicit 'commit work' is mandatory! ----------------
              COMMIT WORK.
            ENDIF.
* ------------------------------------------------------------------
* *            exception handling
* ------------------------------------------------------------------
* * replace this very rudimentary exception handling
* * with your own one !!!
* ------------------------------------------------------------------
          CATCH cx_bcs INTO bcs_exception.
            MESSAGE e019 WITH bcs_exception->error_type.
*     Sending fax/mail failed
            EXIT.
        ENDTRY.
      ENDIF.
    ENDIF.

***********Start of Note chnages1489677*****************
* Arching for adobe forms
    IF ( nast-kschl = 'ZERS' AND nast-nacha = '5' ) OR  "cgijon: archivamos ZERS con generación de mail
      ( nast-tdarmod = 2 OR  nast-tdarmod = 3 ) .

* Get the PDF length
      lv_pdf_size = xstrlen( os_formout-pdf ).

* defaults for archive
      IF toa_dara-function = space.
        toa_dara-function = 'DARA'.
      ENDIF.
*     which format to be used for archiving: OTF or PDF?
      CALL FUNCTION 'ARCHIV_GET_PRINTFORMAT'
        EXPORTING
          application = 'PDF'
        IMPORTING
          printformat = lv_archiveformat.

      IF lv_archiveformat EQ 'PDF'.
        lv_documentclass = 'PDF'.

        CALL FUNCTION 'ARCHIV_CREATE_OUTGOINGDOCUMENT'
          EXPORTING
            arc_p                    = arc_params
            arc_i                    = toa_dara
            pdflen                   = lv_pdf_size
            documentclass            = lv_documentclass                "Since the output is in PDF document class is also PDF
            document                 = os_formout-pdf
          EXCEPTIONS
            error_archiv             = 1
            error_communicationtable = 2
            error_connectiontable    = 3
            error_kernel             = 4
            error_parameter          = 5
            OTHERS                   = 6.
        CASE sy-subrc.
          WHEN 0. " o.k.
          WHEN 1. RAISE error_archiv.
          WHEN 2. RAISE error_communicationtable.
          WHEN 3. RAISE error_connectiontable.
          WHEN 4. RAISE error_kernel.
          WHEN 5. RAISE error_parameter.
          WHEN 6. RAISE error_archiv. "?
        ENDCASE.

      ELSE.
        " Other than PDF format raise error.
        MESSAGE e789(po) WITH lv_archiveformat.
      ENDIF.
    ENDIF.
***********End of Note chnages 1489677*****************

*------------------------------------------------------------------------
* INI CGIJON - CARGAR PDF
*------------------------------------------------------------------------
* Coding  To link the attachment
*------------------------------------------------------------------------
    DATA: lv_objecttype TYPE  toav0-sap_object,
          lv_object_id  TYPE  toav0-object_id,
          lv_archiv_id  TYPE toav0-archiv_id,
          lv_count      LIKE  sy-index,
          t_connections TYPE TABLE OF toav0.

    DATA: ls_objtype TYPE toav0-sap_object,
          ls_objkey  TYPE toav0-object_id.

    DATA ls_borident TYPE borident.

    lv_objecttype = 'BUS2081'.
    CONCATENATE rbkp-belnr rbkp-gjahr INTO lv_object_id.
    lv_archiv_id = 'ZD'.

    ls_borident-objtype = lv_objecttype.
    ls_borident-objkey  = lv_object_id.

    ls_objtype = lv_objecttype.
    ls_objkey  = cl_gos_utilities=>id_for_archive_get( ls_borident ).


    CALL FUNCTION 'ARCHIV_GET_CONNECTIONS'
      EXPORTING
        objecttype    = lv_objecttype
        object_id     = lv_object_id
        archiv_id     = lv_archiv_id
      IMPORTING
        count         = lv_count
      TABLES
        connections   = t_connections
      EXCEPTIONS
        nothing_found = 1
        OTHERS        = 2.
    IF sy-subrc <> 0.
*   Implement suitable error handling here
    ENDIF.

** prueba carla
*    DATA: folder_id   LIKE  soodk,
*          wa_obj_data TYPE sood1,
*          wa_obj_id   TYPE  soodk,
*          it_objhead  TYPE TABLE OF soli,
*          it_content  TYPE TABLE OF soli.
*
*    DATA: wa_target_bo   TYPE borident,                "Bussiness Object
*          lv_object_type TYPE  soodk-objtp.
*
*    DATA: wa_folmem_k TYPE sofmk,
*          wa_note     TYPE borident,
*          ep_note     TYPE borident-objkey.
*
*
*    CALL FUNCTION 'SO_CONVERT_CONTENTS_BIN'
*      EXPORTING
*        it_contents_bin = lt_binary_tab
*      IMPORTING
*        et_contents_bin = lt_binary_tab.
*
*
*    CALL FUNCTION 'SO_FOLDER_ROOT_ID_GET'
*      EXPORTING
*        region    = 'B'
*      IMPORTING
*        folder_id = folder_id
*      EXCEPTIONS
*        OTHERS    = 0.
*
*
*
*    wa_target_bo-objtype = 'BUS2081'.
*    wa_target_bo-objkey = ls_objkey.
*
*    lv_object_type = folder_id-objtp.
*
*    CALL FUNCTION 'SO_OBJECT_INSERT'
*      EXPORTING
*        folder_id                  = folder_id
*        object_type                = lv_object_type
*        object_hd_change           = wa_obj_data
*      IMPORTING
*        object_id                  = wa_obj_id
*      TABLES
*        objhead                    = it_objhead
*        objcont                    = lt_binary_tab "it_content
*      EXCEPTIONS
*        active_user_not_exist      = 1
*        communication_failure      = 2
*        component_not_available    = 3
*        dl_name_exist              = 4
*        folder_not_exist           = 5
*        folder_no_authorization    = 6
*        object_type_not_exist      = 7
*        operation_no_authorization = 8
*        owner_not_exist            = 9
*        parameter_error            = 10
*        substitute_not_active      = 11
*        substitute_not_defined     = 12
*        system_failure             = 13
*        x_error                    = 14
*        OTHERS                     = 15.
*
*    IF sy-subrc = 0 AND wa_target_bo-objkey IS NOT INITIAL.
*
**      Creamos el fichero como BO para que pueda adjuntarse.
*      wa_folmem_k-foltp = folder_id-objtp.
*      wa_folmem_k-folyr = folder_id-objyr.
*      wa_folmem_k-folno = folder_id-objno.
*      wa_folmem_k-doctp = folder_id-objtp.
*      wa_folmem_k-docyr = folder_id-objyr.
*      wa_folmem_k-docno = folder_id-objno.
*      ep_note = wa_folmem_k.
*      wa_note-objtype = 'MESSAGE'.
*      wa_note-objkey = ep_note.
*
**      3- Adjuntar documento al BO deseado(Material en nuestro caso)
*      CALL FUNCTION 'BINARY_RELATION_CREATE_COMMIT'
*        EXPORTING
*          obj_rolea      = wa_target_bo
*          obj_roleb      = wa_note
*          relationtype   = 'ATTA'
*        EXCEPTIONS
*          no_model       = 1
*          internal_error = 2
*          unknown        = 3
*          OTHERS         = 4.
*    ENDIF.

    CALL FUNCTION 'ALINK_APPL_STORE_BY_DND'
      EXPORTING
        objecttype                  = lv_objecttype
        objectid                    = lv_object_id
        scenario                    = 6
      EXCEPTIONS
        no_active_doctypes          = 1
        no_documenttype_description = 2
        no_sapobject_given          = 5
        no_object_id_given          = 6
        OTHERS                      = 7.
* fin prueba carla

    IF sy-subrc = 0.
      CALL FUNCTION 'ARCHIV_GET_CONNECTIONS'
        EXPORTING
          objecttype  = lv_objecttype
          object_id   = lv_object_id
        TABLES
          connections = t_connections
        EXCEPTIONS
          OTHERS      = 1.
    ENDIF.
* FIN CGIJON - CARGAR PDF





*----Clearing Structure and table type
    CLEAR: gs_address, gs_options_info, gs_rbkp_info, gs_lfa1_info, gs_lfb1_info,
           gs_t001_info, gs_tsad3t_info, gs_addr3_val_info, gs_adsmtp_info, gs_t005_info,
           gs_netto_brutto, rbkp, komk, gs_options_con, ekpo, vttsf , gt_dynamic_text.
    REFRESH: gt_plants_t001w, gt_tax_details_rap, gt_payment_terms, gt_material_item,
             gt_purch_doc_item, gt_commu_str_bapiesll, gt_shipment_det, gt_shipcostdet_header,
             gt_shipcostdet_itetm, gt_return_del, gt_billplan_date, gt_price_det, gt_rseg,
             gt_rseg_tm, gt_esll, gt_essr.
  ENDIF.

ENDFORM.                    " PRINT_MR_PDF
