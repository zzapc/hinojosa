*----------------------------------------------------------------------*
*              Print of a delivery note by SAPscript                   *
*----------------------------------------------------------------------*
REPORT zrvaddn01 LINE-COUNT 100.

TABLES: vbco3,                         "Communicationarea for view
        vbdkl,                         "Headerview
        vbdpl,                         "Itemview
        komser,                        "Communicationarea Serialnumbers
        conf_out,                      "Configuration data
        tvko,                          "Sales organization
        tvst,                          "Shipping points
        t001g,                         "Company codes dependend texts
        rdgprint,                      "Dangerous goods All of Data
        rdgtxtprt,                     "undepend. Texts
        komk,                          "Communicationarea for conditions
        komp,                          "Communicationarea for conditions
        komvd.                         "Communicationarea for conditions
INCLUDE rvadtabl.

* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

DATA: retcode LIKE sy-subrc.         "Returncode
DATA: xscreen(1) TYPE c.               "Output on printer or screen

DATA: BEGIN OF tvbdpl OCCURS 0.        "Internal table for items
        INCLUDE STRUCTURE vbdpl.
      DATA: END OF tvbdpl.

DATA: BEGIN OF tkomv OCCURS 50.
        INCLUDE STRUCTURE komv.
      DATA: END OF tkomv.

DATA: BEGIN OF tkomvd OCCURS 50.
        INCLUDE STRUCTURE komvd.
      DATA: END OF tkomvd.

DATA: BEGIN OF tkomcon OCCURS 50.      "...  for configuration data
        INCLUDE STRUCTURE conf_out.
      DATA: END OF tkomcon.

DATA: BEGIN OF tkomser OCCURS 5.
        INCLUDE STRUCTURE riserls.
      DATA: END   OF tkomser.

DATA: BEGIN OF tkomser_print OCCURS 5.
        INCLUDE STRUCTURE komser.
      DATA: END   OF tkomser_print.

DATA: BEGIN OF tkombat OCCURS 50.      " configuration data for batches
        INCLUDE STRUCTURE conf_out.
      DATA: END   OF tkombat.

DATA:  address_selection LIKE addr1_sel.                    "MOS

DATA: pr_kappl(01) TYPE c VALUE 'V'. "Application for pricing
DATA: print_mwskz.

DATA: price(1) TYPE c.                 "price switch

DATA: BEGIN OF rdgprint_tab OCCURS 0.
        INCLUDE STRUCTURE rdgprint.
      DATA: END   OF rdgprint_tab.

DATA: i_undep_txt   LIKE rdgtxtprt OCCURS 0 WITH HEADER LINE, "undepend Tex
      l_spras_txt   LIKE rdgtxtprt OCCURS 0 WITH HEADER LINE, "undepend Tex
      i_idname_text LIKE rdgtxtprt OCCURS 0 WITH HEADER LINE.


DATA: "gv_fp_outputparams  type  sfpoutputparams, " Output parameters
  gv_fp_docparams   TYPE        sfpdocparams,
  gv_w_cx_root      TYPE REF TO cx_root,  " Form Output
  gv_fm_name        TYPE        rs38l_fnam,      " Function Name
  gv_interface_type TYPE        fpinterfacetype, " interface name
  gv_form           TYPE        fpwbformname,    " Form name
  gv_fpformoutput   TYPE        fpformoutput,    " Form Output
  gv_mesg           TYPE        string,
  print_opts        TYPE        itcpo.

DATA : gt_vbdpl TYPE STANDARD TABLE OF vbdpl,
       gs_vbdpl TYPE                   vbdpl.

DATA : gt_komser TYPE STANDARD TABLE OF leshp_pdf_komser_pdf,
       gs_komser TYPE                   leshp_pdf_komser_pdf.

DATA : gt_rdgtxtprt TYPE STANDARD TABLE OF rdgtxtprt,
       gs_rdgtxtprt TYPE                   rdgtxtprt.

DATA : gt_conf_out TYPE STANDARD TABLE OF leshp_pdf_conf_out_pdf,
       gs_conf_out TYPE                   leshp_pdf_conf_out_pdf.

DATA : gs_shipment  TYPE vbdkl,
       gs_addr_info TYPE vbdkl,
       gs_inc_text  TYPE tvko,
       g_bob_lote   TYPE char6, " cabecera columna Bobina/Lote
       gv_repeat    TYPE char2.

DATA : gt_dg TYPE STANDARD TABLE OF rdgtxtprt,
       gs_dg TYPE                   rdgtxtprt.

CONSTANTS: gc_english TYPE char1 VALUE 'E'.

* GST - 12/11/2014 ->
DATA: lt_albaran TYPE zstsd_albaran.
DATA: g_nrart TYPE nrart.
* GST - 12/11/2014 <-

**************************Start of Note changes 1503297*********************************
*
*  DATA:  gv_inupd           TYPE i.
*
**External Send
*  DATA:  gv_comm_type     TYPE ad_comm,
*         gv_comm_values   TYPE szadr_comm_values,
*         gs_recipient     TYPE swotobjid,
*         gs_sender        TYPE swotobjid,
*         gs_intnast       TYPE snast,
*         gv_xdevice(10),
*         gv_xprogramm     TYPE tdprogram,
*         gv_xdialog.
*
** sending output vai mail
*DATA:  gv_pdf_content        TYPE solix_tab.
*
**************************End of Note changes 1503297*********************************


* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
*-----------------------------------------------------------------------
*
*-----------------------------------------------------------------------

FORM entry USING return_code us_screen.

  CLEAR retcode.
  CLEAR price.
  xscreen = us_screen.
  PERFORM processing USING us_screen.
  IF retcode NE 0.
    return_code = 1.
  ELSE.
    return_code = 0.
  ENDIF.

ENDFORM.                    "ENTRY


*&---------------------------------------------------------------------*
*&      Form  ENTRY_PDF
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->RETURN_CODE  text
*      -->US_SCREEN    text
*----------------------------------------------------------------------*
FORM entry_pdf USING return_code us_screen.
  CLEAR retcode.
  CLEAR price.
  CLEAR gv_fp_outputparams.                                 "n_1782166
  CLEAR gv_comm_type.                                       "n_1787700
  CLEAR gv_comm_values.                                     "n_1787700
  xscreen = us_screen.
  PERFORM processing_pdf USING us_screen.
  IF retcode NE 0.
    return_code = 1.
  ELSE.
    return_code = 0.
  ENDIF.

ENDFORM.                    "ENTRY_PDF

FORM entry_pdf_hoja_picking USING return_code us_screen.

* DTM - Si la entrega no es ZLR, imprime hoja de picking

  DATA: lv_vbeln TYPE vbeln_vl,
        lv_lfart TYPE lfart.

  CLEAR: lv_vbeln, lv_lfart.
  lv_vbeln = nast-objky.

  SELECT SINGLE lfart FROM likp
    INTO lv_lfart
    WHERE vbeln = lv_vbeln.

  IF lv_lfart NE 'ZLR' AND lv_lfart NE 'ZNCR'.

* DTM

*Imprimir Formulario
    CALL METHOD zclpp_app_logistica=>imprimir_form_hoja_de_picking
      EXPORTING
        i_vbeln = CONV #( nast-objky )
      IMPORTING
        o_rc    = DATA(l_rc).

*Control de errores
    IF l_rc <> '00'.
* DTM - Cambio de mensaje de error por warning
      MESSAGE |Hoja de picking no disponible.| TYPE 'I' DISPLAY LIKE 'W'.
**    MESSAGE |Error al imprimir hoja de picking.| TYPE 'I' DISPLAY LIKE 'E'.
* DTM
      return_code = 1.
    ELSE.
      return_code = 0.
    ENDIF.

  ENDIF. "DTM

ENDFORM.                    "ENTRY_PDF


*&---------------------------------------------------------------------*
*&      Form  ENTRY_PRICE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->RETURN_CODE  text
*      -->US_SCREEN    text
*----------------------------------------------------------------------*
FORM entry_price USING return_code us_screen.

  CLEAR retcode.
  price = 'X'.
  xscreen = us_screen.
  PERFORM processing USING us_screen.
  IF retcode NE 0.
    return_code = 1.
  ELSE.
    return_code = 0.
  ENDIF.

ENDFORM.                    "ENTRY_PRICE

*---------------------------------------------------------------------*
*       FORM PROCESSING                                               *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  PROC_SCREEN                                                   *
*---------------------------------------------------------------------*
FORM processing USING proc_screen.

  PERFORM get_data.
  CHECK retcode = 0.
  PERFORM form_open USING proc_screen vbdkl-land1.
  CHECK retcode = 0.
  PERFORM check_repeat.
  PERFORM header_data_print.
  CHECK retcode = 0.
  PERFORM header_text_print.
  CHECK retcode = 0.
  PERFORM item_print.
  CHECK retcode = 0.
  PERFORM end_print.
  CHECK retcode = 0.
  PERFORM form_close.
  CHECK retcode = 0.

ENDFORM.                    "PROCESSING


*&---------------------------------------------------------------------*
*&      Form  PROCESSING_PDF
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->PROC_SCREEN  text
*----------------------------------------------------------------------*
FORM processing_pdf USING proc_screen.
  PERFORM get_data_pdf.
  CHECK retcode = 0.
  PERFORM form_open_pdf USING proc_screen vbdkl-land1.
  CHECK retcode = 0.
  PERFORM check_repeat_pdf.
  CHECK retcode = 0.
  PERFORM item_print_pdf.
  PERFORM dg_print_undep_text_pdf.
  PERFORM write_pdf.
  PERFORM form_close_pdf.
  CHECK retcode = 0.

ENDFORM.                    "PROCESSING_PDF
***********************************************************************
*       S U B R O U T I N E S                                         *
***********************************************************************

*---------------------------------------------------------------------*
*       FORM CHECK_REPEAT                                             *
*---------------------------------------------------------------------*
*       A text is printed, if it is a repeat print for the document.  *
*---------------------------------------------------------------------*

FORM check_repeat.

  SELECT * INTO *nast FROM nast WHERE kappl = nast-kappl
                                AND   objky = nast-objky
                                AND   kschl = nast-kschl
                                AND   spras = nast-spras
                                AND   parnr = nast-parnr
                                AND   parvw = nast-parvw
                                AND   nacha BETWEEN '1' AND '4'
                                AND   vstat = '1'.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'REPEAT'
        window  = 'REPEAT'
      EXCEPTIONS
        element = 1
        window  = 2.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
    EXIT.
  ENDSELECT.

ENDFORM.                    "CHECK_REPEAT

*---------------------------------------------------------------------*
*       FORM END_PRINT                                                *
*---------------------------------------------------------------------*
*                                                                     *
*---------------------------------------------------------------------*

FORM check_repeat_pdf.

  SELECT * INTO *nast FROM nast WHERE kappl = nast-kappl
                                AND   objky = nast-objky
                                AND   kschl = nast-kschl
                                AND   spras = nast-spras
                                AND   parnr = nast-parnr
                                AND   parvw = nast-parvw
                                AND   nacha BETWEEN '1' AND '4'
                                AND   vstat = '1'.
    gv_repeat = 1.

    EXIT.
  ENDSELECT.

ENDFORM.                    "CHECK_REPEAT_PDF


*&---------------------------------------------------------------------*
*&      Form  END_PRINT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM end_print.

  IF price = 'X'.
    PERFORM get_header_prices.
    CALL FUNCTION 'CONTROL_FORM'
      EXPORTING
        command = 'PROTECT'.
    PERFORM header_price_print.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'END_VALUES'
      EXCEPTIONS
        OTHERS  = 1.
    CALL FUNCTION 'CONTROL_FORM'
      EXPORTING
        command = 'ENDPROTECT'.
  ENDIF.

  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'SUPPLEMENT_TEXT'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

* print standard texts for dangerous goods
  PERFORM dg_print_undep_text.

ENDFORM.                    "END_PRINT

*---------------------------------------------------------------------*
*       FORM FORM_CLOSE                                               *
*---------------------------------------------------------------------*
*       End of printing the form                                      *
*---------------------------------------------------------------------*

FORM form_close.

  DATA:
    lt_otfdata TYPE TABLE OF itcoo.

  IF cl_ops_switch_check=>sd_sfws_sc3( ) EQ abap_true AND
     xscreen                             EQ 'W'.
    CALL FUNCTION 'CLOSE_FORM'
      TABLES
        otfdata = lt_otfdata
      EXCEPTIONS
        OTHERS  = 1.
    IF sy-subrc IS INITIAL.
      PERFORM convert_otf_to_pdf
              TABLES lt_otfdata.
    ENDIF.
  ELSE.
    CALL FUNCTION 'CLOSE_FORM'           "...Ende Formulardruck
      EXCEPTIONS
        OTHERS = 1.
  ENDIF.
  IF sy-subrc NE 0.
    retcode = 1.
    PERFORM protocol_update.
  ENDIF.
  SET COUNTRY space.

ENDFORM.                    "FORM_CLOSE


*---------------------------------------------------------------------*
*       FORM FORM_OPEN                                                *
*---------------------------------------------------------------------*
*       Start of printing the form                                    *
*---------------------------------------------------------------------*
*  -->  US_SCREEN  Output on screen                                   *
*                  ' ' = printer                                      *
*                  'X' = screen                                       *
*  -->  US_COUNTRY County for telecommunication and SET COUNTRY       *
*---------------------------------------------------------------------*

FORM form_open USING us_screen us_country.

  INCLUDE rvadopfo.

ENDFORM.                    "FORM_OPEN

*---------------------------------------------------------------------*
*       FORM GET_DATA                                                 *
*---------------------------------------------------------------------*
*       General provision of data for the form                        *
*---------------------------------------------------------------------*

FORM get_data.

  CALL FUNCTION 'RV_PRICE_PRINT_REFRESH'
    TABLES
      tkomv = tkomv.
  CLEAR komk.
  CLEAR komp.


  vbco3-spras = nast-spras.
  vbco3-vbeln = nast-objky.
  vbco3-kunde = nast-parnr.
  vbco3-parvw = nast-parvw.

  CALL FUNCTION 'RV_DELIVERY_PRINT_VIEW'
    EXPORTING
      comwa = vbco3
    IMPORTING
      kopf  = vbdkl
    TABLES
      pos   = tvbdpl.

* Inicio mod. 19.04.17 JJR
*  IF nast-parvw = '§§'.  " DEL - cvivo - 57924 Cambiamos lectura para ver directamente en tabla si es tipo usuario
  SELECT SINGLE nrart FROM tpar
    INTO g_nrart
    WHERE parvw EQ nast-parvw.

  IF g_nrart EQ 'US'. " es tipo usuario
    SELECT SINGLE adr6~addrnumber adr6~persnumber
       INTO (addr_key-addrnumber, addr_key-persnumber)
     FROM usr21 JOIN adr6 ON usr21~persnumber = adr6~persnumber
                         AND usr21~addrnumber = adr6~addrnumber
     WHERE usr21~bname = nast-parnr.

    addr_key-addr_type  = 2.
  ELSE.
* Fin modificacion 19.04.17
* fill address key --> necessary for emails
    addr_key-addrnumber = vbdkl-adrnr.
    addr_key-persnumber = vbdkl-adrnp.
    addr_key-addr_type  = vbdkl-address_type.
  ENDIF.

* Data selection for dangerous goods
  PERFORM dg_data_select USING vbdkl.
  PERFORM sender.

ENDFORM.                    "GET_DATA




*&---------------------------------------------------------------------*
*&      Form  GET_DATA_PDF
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM get_data_pdf.

  CALL FUNCTION 'RV_PRICE_PRINT_REFRESH'
    TABLES
      tkomv = tkomv.
  CLEAR komk.
  CLEAR komp.

  vbco3-spras = nast-spras.
  vbco3-vbeln = nast-objky.
  vbco3-kunde = nast-parnr.
  vbco3-parvw = nast-parvw.

  CALL FUNCTION 'RV_DELIVERY_PRINT_VIEW'
    EXPORTING
      comwa = vbco3
    IMPORTING
      kopf  = vbdkl
    TABLES
      pos   = tvbdpl.


  MOVE-CORRESPONDING vbdkl TO gs_shipment.


  LOOP AT tvbdpl.
    MOVE-CORRESPONDING tvbdpl TO gs_vbdpl.
    CALL FUNCTION 'CONVERSION_EXIT_MATN1_OUTPUT'
      EXPORTING
        input  = gs_vbdpl-matnr
      IMPORTING
        output = gs_vbdpl-matnr.

    APPEND gs_vbdpl TO gt_vbdpl.
    CLEAR gs_vbdpl.
  ENDLOOP.

* Inicio mod. 19.04.17 JJR
*  IF nast-parvw = '§§'.  " DEL - cvivo - 57924 Cambiamos lectura para ver directamente en tabla si es tipo usuario
  SELECT SINGLE nrart FROM tpar
    INTO g_nrart
    WHERE parvw EQ nast-parvw.

*  IF nast-parvw = '§§'. " cvivo - 57924 - Lógica directamente si es tipo usuario
  IF g_nrart EQ 'US'. " es tipo usuario

    SELECT SINGLE adr6~addrnumber adr6~persnumber
       INTO (addr_key-addrnumber, addr_key-persnumber)
     FROM usr21 JOIN adr6 ON usr21~persnumber = adr6~persnumber
                         AND usr21~addrnumber = adr6~addrnumber
     WHERE usr21~bname = nast-parnr.

    addr_key-addr_type  = 2.
  ELSE.
* Fin modificacion 19.04.17
* fill address key --> necessary for emails
    addr_key-addrnumber = vbdkl-adrnr.
    addr_key-persnumber = vbdkl-adrnp.
    addr_key-addr_type  = vbdkl-address_type.
  ENDIF.

* Data selection for dangerous goods
  PERFORM dg_data_select USING vbdkl.
  PERFORM sender.

  MOVE-CORRESPONDING tvko TO gs_inc_text.                   "n_1632626

ENDFORM.                    "GET_DATA_PDF


*---------------------------------------------------------------------*
*       FORM GET_HEADER_PRICES                                        *
*---------------------------------------------------------------------*
*       In this routine the price data for the header is fetched from *
*       the database.                                                 *
*---------------------------------------------------------------------*

FORM get_header_prices.

  CALL FUNCTION 'RV_PRICE_PRINT_HEAD'
    EXPORTING
      comm_head_i = komk
      language    = nast-spras
    IMPORTING
      comm_head_e = komk
      comm_mwskz  = print_mwskz
    TABLES
      tkomv       = tkomv
      tkomvd      = tkomvd.

ENDFORM.                    "GET_HEADER_PRICES

*---------------------------------------------------------------------*
*       FORM GET_ITEM_CHARACTERISTICS                                 *
*---------------------------------------------------------------------*
*       In this routine the configuration data item is fetched from   *
*       the database.                                                 *
*---------------------------------------------------------------------*

FORM get_item_characteristics.

  DATA da_t_cabn LIKE cabn OCCURS 10 WITH HEADER LINE.
  DATA: BEGIN OF da_key,
          mandt LIKE cabn-mandt,
          atinn LIKE cabn-atinn,
        END   OF da_key.

  REFRESH tkomcon.
  CHECK NOT vbdpl-cuobj IS INITIAL.

  CALL FUNCTION 'VC_I_GET_CONFIGURATION'
    EXPORTING
      instance      = vbdpl-cuobj
      language      = nast-spras
      print_sales   = 'X'
    TABLES
      configuration = tkomcon
    EXCEPTIONS
      OTHERS        = 4.

  RANGES : da_in_cabn FOR da_t_cabn-atinn.
  CLEAR da_in_cabn. REFRESH da_in_cabn.
  LOOP AT tkomcon.
    da_in_cabn-option = 'EQ'.
    da_in_cabn-sign   = 'I'.
    da_in_cabn-low    = tkomcon-atinn.
    APPEND da_in_cabn.
  ENDLOOP.

  CLEAR da_t_cabn. REFRESH da_t_cabn.
  CALL FUNCTION 'CLSE_SELECT_CABN'
    TABLES
      in_cabn        = da_in_cabn
      t_cabn         = da_t_cabn
    EXCEPTIONS
      no_entry_found = 1
      OTHERS         = 2.

* Preisfindungsmerkmale / Merkmale auf VCSD_UPDATE herausnehmen
  SORT da_t_cabn.
  LOOP AT tkomcon.
    da_key-mandt = sy-mandt.
    da_key-atinn = tkomcon-atinn.
    READ TABLE da_t_cabn WITH KEY da_key BINARY SEARCH.
    IF sy-subrc <> 0 OR
         ( ( da_t_cabn-attab = 'SDCOM' AND
            da_t_cabn-atfel = 'VKOND'       ) OR
          ( da_t_cabn-attab = 'VCSD_UPDATE' ) ) .
      DELETE tkomcon.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "GET_ITEM_CHARACTERISTICS

*---------------------------------------------------------------------*
*       FORM GET_ITEM_CHARACTERISTICS_BATCH                           *
*---------------------------------------------------------------------*
*       In this routine the configuration data for batches is fetched *
*       from the database                                             *
*---------------------------------------------------------------------*

FORM get_item_characteristics_batch.

  REFRESH tkombat.
  CHECK NOT vbdpl-charg IS INITIAL.

  CALL FUNCTION 'VB_BATCH_VALUES_FOR_OUTPUT'
    EXPORTING
      material       = vbdpl-matnr
      plant          = vbdpl-werks
      batch          = vbdpl-charg
      language       = nast-spras
    TABLES
      classification = tkombat
    EXCEPTIONS
      OTHERS         = 4.

  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "GET_ITEM_CHARACTERISTICS_BATCH

*---------------------------------------------------------------------*
*       FORM GET_ITEM_PRICES                                          *
*---------------------------------------------------------------------*
*       In this routine the price data for the item is fetched from   *
*       the database.                                                 *
*---------------------------------------------------------------------*

FORM get_item_prices.

  CLEAR: komp,
         tkomv.

  IF komk-knumv NE vbdkl-knump.
    CLEAR komk.
    komk-mandt = sy-mandt.
    komk-kalsm = vbdkl-kalsp.
    komk-kappl = pr_kappl.
    komk-waerk = vbdkl-waerk.
    komk-knumv = vbdkl-knump.
    komk-vbtyp = vbdkl-vbtyp.
  ENDIF.
  komp-kposn = vbdpl-posnr.

  CALL FUNCTION 'RV_PRICE_PRINT_ITEM'
    EXPORTING
      comm_head_i = komk
      comm_item_i = komp
      language    = nast-spras
    IMPORTING
      comm_head_e = komk
      comm_item_e = komp
    TABLES
      tkomv       = tkomv
      tkomvd      = tkomvd.

ENDFORM.                    "GET_ITEM_PRICES

*---------------------------------------------------------------------*
*       FORM GET_SERIAL_NO                                            *
*---------------------------------------------------------------------*
*       In this routine the serialnumbers are fetched from the        *
*       database.                                                     *
*---------------------------------------------------------------------*

FORM get_serial_no.

  REFRESH tkomser.
  REFRESH tkomser_print.
  CHECK vbdpl-anzsn > 0.
* Read the Serialnumbers of a Position.
  CALL FUNCTION 'SERIAL_LS_PRINT'
    EXPORTING
      vbeln  = vbdkl-vbeln
      posnr  = vbdpl-posnr
    TABLES
      iserls = tkomser.

* Process the stringtable for Printing.
  CALL FUNCTION 'PROCESS_SERIALS_FOR_PRINT'
    EXPORTING
      i_boundary_left             = '(_'
      i_boundary_right            = '_)'
      i_sep_char_strings          = ',_'
      i_sep_char_interval         = '_-_'
      i_use_interval              = 'X'
      i_boundary_method           = 'C'
      i_line_length               = 50
      i_no_zero                   = 'X'
      i_alphabet                  = sy-abcde
      i_digits                    = '0123456789'
      i_special_chars             = '-'
      i_with_second_digit         = ' '
    TABLES
      serials                     = tkomser
      serials_print               = tkomser_print
    EXCEPTIONS
      boundary_missing            = 01
      interval_separation_missing = 02
      length_to_small             = 03
      internal_error              = 04
      wrong_method                = 05
      wrong_serial                = 06
      two_equal_serials           = 07
      serial_with_wrong_char      = 08
      serial_separation_missing   = 09.

  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "GET_SERIAL_NO

*&---------------------------------------------------------------------*
*&      Form  HEADER_DATA_PRINT
*&---------------------------------------------------------------------*
*       Printing of the header data like terms, weights                *
*----------------------------------------------------------------------*

FORM header_data_print.

  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'HEADER_DATA'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                               " HEADER_DATA_PRINT

*---------------------------------------------------------------------*
*       FORM HEADER_PRICE_PRINT                                       *
*---------------------------------------------------------------------*
*       Printout of the header prices                                 *
*---------------------------------------------------------------------*

FORM header_price_print.

  LOOP AT tkomvd.

    AT FIRST.
      IF komk-supos NE 0.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'ITEM_SUM'
          EXCEPTIONS
            element = 1
            window  = 2.
      ELSE.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'UNDER_LINE'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ENDIF.
    ENDAT.

    komvd = tkomvd.
    IF print_mwskz = space.
      CLEAR komvd-mwskz.
    ENDIF.

    IF komvd-koaid = 'D'.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'TAX_LINE'
        EXCEPTIONS
          element = 1
          window  = 2.
    ELSE.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'SUM_LINE'
        EXCEPTIONS
          element = 1
          window  = 2.
    ENDIF.
  ENDLOOP.
  DESCRIBE TABLE tkomvd LINES sy-tfill.
  IF sy-tfill = 0.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'UNDER_LINE'
      EXCEPTIONS
        element = 1
        window  = 2.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
  ENDIF.

ENDFORM.                    "HEADER_PRICE_PRINT

*---------------------------------------------------------------------*
*       FORM HEADER_TEXT_PRINT                                        *
*---------------------------------------------------------------------*
*       Printout of the headertexts                                   *
*---------------------------------------------------------------------*

FORM header_text_print.

  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'HEADER_TEXT'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "HEADER_TEXT_PRINT

*---------------------------------------------------------------------*
*       FORM ITEM_PRINT                                               *
*---------------------------------------------------------------------*
*       Printout of the items                                         *
*---------------------------------------------------------------------*

FORM item_print.

* <<< START_OF_INSERTION_HP_327026 >>>
  DATA: lf_init_characteristics_done TYPE xfeld.
* <<< END_OF_INSERTION_HP_327026 >>>
  CALL FUNCTION 'WRITE_FORM'           "First header
    EXPORTING
      element = 'ITEM_HEADER'
    EXCEPTIONS
      OTHERS  = 1.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.
  CALL FUNCTION 'WRITE_FORM'          "Activate header
    EXPORTING
      element = 'ITEM_HEADER'
      type    = 'TOP'
    EXCEPTIONS
      OTHERS  = 1.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

  LOOP AT tvbdpl.
    vbdpl = tvbdpl.
* <<< START_OF_INSERTION_HP_327026 >>>
    IF ( lf_init_characteristics_done IS INITIAL ) AND
       ( ( NOT vbdpl-charg IS INITIAL ) OR
         ( NOT vbdpl-cuobj IS INITIAL ) ).
      CALL FUNCTION 'CTMS_DDB_INIT'.
      lf_init_characteristics_done = 'X'.
    ENDIF.
* <<< END_OF_INSERTION_HP_327026 >>>
    IF vbdpl-uecha IS INITIAL.
* <<< START_OF_INSERTION_HP_377469 >>>
      PERFORM item_print_oi.
* <<< END_OF_INSERTION_HP_377469 >>>
      CALL FUNCTION 'CONTROL_FORM'
        EXPORTING
          command = 'PROTECT'.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE'.
      CALL FUNCTION 'CONTROL_FORM'
        EXPORTING
          command = 'ENDPROTECT'.
* Seitenumbruch, wenn Positionstexte nicht auf eine Seite passen.
      CALL FUNCTION 'CONTROL_FORM'
        EXPORTING
          command = 'PROTECT'.
      PERFORM item_text_print.
      PERFORM dg_print_data_get.
      PERFORM dg_data_print.
      IF price = 'X'.
        PERFORM get_item_prices.
        PERFORM item_price_print.
      ENDIF.
      PERFORM get_serial_no.
      PERFORM item_serial_no_print.
      PERFORM get_item_characteristics.
      PERFORM item_characteristics_print.
      PERFORM get_item_characteristics_batch.
      PERFORM item_characteristics_batch.
      IF vbdpl-vbeln_vauf NE space AND
         vbdpl-vbeln_vauf NE vbdkl-vbeln_vauf.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'ITEM_REFERENCE'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ENDIF.
      IF vbdpl-qmnum NE space AND
         vbdpl-qmnum NE vbdkl-qmnum.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'ITEM_QNUMBER'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ENDIF.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_PURCHASE_DATA'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
      CALL FUNCTION 'CONTROL_FORM'
        EXPORTING
          command = 'ENDPROTECT'.
    ELSE.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_BATCH'
        EXCEPTIONS                                          "v_n_709399
          element = 1
          window  = 2.                                      "^_n_709399

      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
      IF price = 'X'.                                       "v_n_577292
        PERFORM get_item_prices.
        PERFORM item_price_print.
      ENDIF.                                                "^_n_577292
      PERFORM get_serial_no.
      PERFORM item_serial_no_print.
      PERFORM get_item_characteristics_batch.
      PERFORM item_characteristics_batch.
    ENDIF.
  ENDLOOP.

  CALL FUNCTION 'WRITE_FORM'          "Deactivate Header
    EXPORTING
      element  = 'ITEM_HEADER'
      function = 'DELETE'
      type     = 'TOP'
    EXCEPTIONS
      OTHERS   = 1.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "ITEM_PRINT


*&---------------------------------------------------------------------*
*&      Form  ITEM_PRINT_PDF
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM item_print_pdf.

* <<< START_OF_INSERTION_HP_327026 >>>
  DATA: lf_init_characteristics_done TYPE xfeld.
* <<< END_OF_INSERTION_HP_327026 >>>

*  Move Data
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

  LOOP AT tvbdpl.
    vbdpl = tvbdpl.
* <<< START_OF_INSERTION_HP_327026 >>>
    IF ( lf_init_characteristics_done IS INITIAL ) AND
       ( ( NOT vbdpl-charg IS INITIAL ) OR
         ( NOT vbdpl-cuobj IS INITIAL ) ).
      CALL FUNCTION 'CTMS_DDB_INIT'.
      lf_init_characteristics_done = 'X'.
    ENDIF.
* <<< END_OF_INSERTION_HP_327026 >>>
    IF vbdpl-uecha IS INITIAL.

* <<< START_OF_INSERTION_HP_377469 >>>
      PERFORM item_print_oi.
* <<< END_OF_INSERTION_HP_377469 >>>

* Seitenumbruch, wenn Positionstexte nicht auf eine Seite passen.


      PERFORM dg_print_data_get_pdf.
      PERFORM dg_data_print_pdf.
      PERFORM get_serial_no.
      PERFORM item_serial_no_print_pdf.
      PERFORM get_item_characteristics.
      PERFORM item_characteristics_print_pdf.
      PERFORM get_item_characteristics_batch.
      PERFORM item_characteristics_batch_pdf.
    ELSE.
      PERFORM get_serial_no.
      PERFORM item_serial_no_print_pdf.
      PERFORM get_item_characteristics_batch.
      PERFORM item_characteristics_batch_pdf.

    ENDIF.
  ENDLOOP.
ENDFORM.                    "ITEM_PRINT_PDF


*---------------------------------------------------------------------*
*       FORM ITEM_CHARACERISTICS_BATCH                                *
*---------------------------------------------------------------------*
*       Printout of the item characteristics for batches              *
*---------------------------------------------------------------------*

FORM item_characteristics_batch.

  LOOP AT tkombat.
    conf_out = tkombat.
    IF sy-tabix = 1.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_CONFIGURATION_BATCH_HEADER'
        EXCEPTIONS
          OTHERS  = 1.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ELSE.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_CONFIGURATION_BATCH'
        EXCEPTIONS
          OTHERS  = 1.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "ITEM_CHARACTERISTICS_BATCH

*---------------------------------------------------------------------*
*       FORM ITEM_CHARACERISTICS_PRINT                                *
*---------------------------------------------------------------------*
*       Printout of the item characteristics -> configuration         *
*---------------------------------------------------------------------*

FORM item_characteristics_batch_pdf.

  LOOP AT tkombat.
    conf_out = tkombat.
    MOVE-CORRESPONDING conf_out TO gs_conf_out.
    MOVE-CORRESPONDING tvbdpl   TO gs_conf_out.
    gs_conf_out-flag = 'B'.
    APPEND gs_conf_out          TO gt_conf_out.
    CLEAR gs_conf_out.
  ENDLOOP.

ENDFORM.                    "ITEM_CHARACTERISTICS_


*&---------------------------------------------------------------------*
*&      Form  ITEM_CHARACTERISTICS_PRINT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM item_characteristics_print.

  LOOP AT tkomcon.
    conf_out = tkomcon.
    IF sy-tabix = 1.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_CONFIGURATION_HEADER'
        EXCEPTIONS
          OTHERS  = 1.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ELSE.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_CONFIGURATION'
        EXCEPTIONS
          OTHERS  = 1.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "ITEM_CHARACTERISTICS_PRINT


*&---------------------------------------------------------------------*
*&      Form  ITEM_CHARACTERISTICS_PRINT_PDF
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM item_characteristics_print_pdf.

  LOOP AT tkomcon.
    conf_out = tkomcon.
    MOVE: conf_out-atbez TO gs_conf_out-atbez,
          conf_out-atwtb TO gs_conf_out-atwtb,
          tvbdpl-vbeln   TO gs_conf_out-vbeln,
          tvbdpl-posnr   TO gs_conf_out-posnr.
    gs_conf_out-flag = 'C'.

    APPEND gs_conf_out TO gt_conf_out.
    CLEAR gs_conf_out.
  ENDLOOP.

ENDFORM.                    "ITEM_CHARACTERISTICS_PRINT_PDF


*---------------------------------------------------------------------*
*       FORM ITEM_PRICE_PRINT                                         *
*---------------------------------------------------------------------*
*       Printout of the item prices                                   *
*---------------------------------------------------------------------*

FORM item_price_print.

  LOOP AT tkomvd.
    komvd = tkomvd.
    IF print_mwskz = space.
      CLEAR komvd-mwskz.
    ENDIF.
    IF sy-tabix = 1.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_PRICE_QUANTITY'
        EXCEPTIONS
          element = 1
          window  = 2.
    ELSE.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_PRICE_TEXT'
        EXCEPTIONS
          element = 1
          window  = 2.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "ITEM_PRICE_PRINT

*---------------------------------------------------------------------*
*       FORM ITEM_SERIAL_NO_PRINT                                     *
*---------------------------------------------------------------------*
*       Printout of the item serialnumbers                            *
*---------------------------------------------------------------------*

FORM item_serial_no_print.

  LOOP AT tkomser_print.
    komser = tkomser_print.
    IF sy-tabix = 1.
*     Output of the Headerline
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_SERIAL_NO_HEADER'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ELSE.
*     Output of the following printlines
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_SERIAL_NO'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ENDIF.
    AT LAST.
      CALL FUNCTION 'CONTROL_FORM'
        EXPORTING
          command = 'NEW-LINE'.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ENDAT.
  ENDLOOP.

ENDFORM.                    "ITEM_SERIAL_NO_PRINT


*&---------------------------------------------------------------------*
*&      Form  ITEM_SERIAL_NO_PRINT_PDF
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM item_serial_no_print_pdf.

  LOOP AT tkomser_print.
    komser = tkomser_print.
    MOVE-CORRESPONDING komser TO gs_komser.
    MOVE-CORRESPONDING tvbdpl TO gs_komser.
    APPEND gs_komser TO gt_komser.
    CLEAR gs_komser.
  ENDLOOP.

ENDFORM.                    "ITEM_SERIAL_NO_PRINT_PDF


*---------------------------------------------------------------------*
*       FORM PROTOCOL_UPDATE                                          *
*---------------------------------------------------------------------*
*       The messages are collected for the processing protocol.       *
*---------------------------------------------------------------------*

FORM protocol_update.

  CHECK xscreen = space.
  CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
    EXPORTING
      msg_arbgb = syst-msgid
      msg_nr    = syst-msgno
      msg_ty    = syst-msgty
      msg_v1    = syst-msgv1
      msg_v2    = syst-msgv2
      msg_v3    = syst-msgv3
      msg_v4    = syst-msgv4
    EXCEPTIONS
      OTHERS    = 1.

ENDFORM.                    "PROTOCOL_UPDATE

*---------------------------------------------------------------------*
*       FORM SENDER                                                   *
*---------------------------------------------------------------------*
*       This routine determines the address of the sender             *
*---------------------------------------------------------------------*

FORM sender.

  SELECT SINGLE * FROM tvko  WHERE vkorg = vbdkl-vkorg.
  IF sy-subrc NE 0.
    syst-msgid = 'VN'.
    syst-msgno = '203'.
    syst-msgty = 'W'.
    syst-msgv1 = 'TVKO'.
    syst-msgv2 = syst-subrc.
    PERFORM protocol_update.
  ENDIF.
  SELECT SINGLE * FROM tvst  WHERE vstel = vbdkl-vstel.
  IF sy-subrc NE 0.
    syst-msgid = 'VN'.
    syst-msgno = '203'.
    syst-msgty = 'W'.
    syst-msgv1 = 'TVST'.
    syst-msgv2 = syst-subrc.
    PERFORM protocol_update.
  ENDIF.
  SELECT SINGLE * FROM t001g WHERE bukrs    = vbdkl-bukrs
                             AND   programm = 'RVADDN01'
                             AND   txtid    = space.
  IF sy-subrc NE 0.
    syst-msgid = 'VN'.
    syst-msgno = '203'.
    syst-msgty = 'W'.
    syst-msgv1 = 'T001G'.
    syst-msgv2 = syst-subrc.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "SENDER
*&---------------------------------------------------------------------*
*&      Form  ITEM_TEXT_PRINT
*&---------------------------------------------------------------------*
FORM item_text_print.

  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'ITEM_TEXT'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    " ITEM_TEXT_PRINT

* <<< START_OF_INSERTION_HP_377469 >>>
INCLUDE rvaddn01_dg.

INCLUDE rvaddn01_oi.
* <<< END_OF_INSERTION_HP_377469 >>>

INCLUDE rvaddn01_dg_pdf.                                    "#EC
***** End of PDF Changes by C5065471 *****

* <<< END_OF_INSERTION_HP_377469 >>>


FORM write_pdf .
  DATA: st_formular_pdf TYPE fpname.
*************************Start of Note changes 1503297*********************************
  DATA: ls_pdf_file  TYPE fpformoutput,
        lv_emailaddr TYPE adr6-smtp_addr.

* Setting for sending FAX
  DATA : lv_cam_address      TYPE REF TO cl_cam_address_bcs,
         lv_outputparams_fax TYPE        sfpoutpar,
         lv_vend_cntry       TYPE        lfa1-land1.

* BCS data
  DATA:
    send_request   TYPE REF TO cl_bcs,
    document       TYPE REF TO cl_document_bcs,
    recipient      TYPE REF TO if_recipient_bcs,
    bcs_exception  TYPE REF TO cx_bcs,
    lv_sent_to_all TYPE        os_boolean,
    lp_pdf_size    TYPE        so_obj_len,
    lv_subject     TYPE        so_obj_des,
    lv_add_nr      TYPE        adr6-addrnumber.

* Archiving specific data declaration
  DATA: lv_pdf_size      TYPE i,
        lv_archiveformat LIKE toadd-doc_type,  "PDF or OTF
        lv_documentclass LIKE toadv-doc_type.
*************************End of Note changes 1503297*********************************

*--> 13.03.2023 FCARDONA - 75869 - Lista de distribución Entrega de Salida

  DATA: lv_objname    TYPE soobjinfi1-obj_name,
        lt_sodlienti1 TYPE TABLE OF sodlienti1,
        ls_sodlienti1 TYPE sodlienti1.

  DATA: lv_werks      TYPE werks_d.


*<-- 13.03.2023 FCARDONA - 75869 - Lista de distribución Entrega de Salida



  gv_form = tnapr-sform.

  IF tnapr-formtype = 2.

    TRY.
* Function to find the FM name.
        CALL FUNCTION 'FP_FUNCTION_MODULE_NAME'
          EXPORTING
            i_name           = gv_form
          IMPORTING
            e_funcname       = gv_fm_name
            e_interface_type = gv_interface_type.

      CATCH cx_root INTO gv_w_cx_root.
        gv_mesg = gv_w_cx_root->get_text( ).
        MESSAGE gv_mesg TYPE 'E'.

    ENDTRY.
*    gv_fp_docparams-langu  = vbdkl-spras.                  "v_n_1676779
    gv_fp_docparams-langu     = nast-spras.
    gv_fp_docparams-replangu1 = vbdkl-spras_vko.     "sales org language
    gv_fp_docparams-replangu2 = gc_english.                 "^_n_1676779
    gv_fp_docparams-country   = vbdkl-land1.

    " Cargar estructura Albarán de entrega:
* GST - 18/02/2015 ->
    SET COUNTRY 'ES'.
* GST - 18/02/2015 <-
    PERFORM f_cargar_albaran.
* GST - 18/02/2015 ->
    SET COUNTRY vbdkl-land1.
* GST - 18/02/2015 <-

    CALL FUNCTION gv_fm_name
      EXPORTING
        /1bcdwb/docparams  = gv_fp_docparams
* GST - 12/11/2014 ->
        albaran            = lt_albaran
* GST - 12/11/2014 <-
        vbdpl              = gt_vbdpl
        deliveryheader     = gs_shipment
        conf_out           = gt_conf_out
        rdgtxtprt          = gt_rdgtxtprt
        komser             = gt_komser
        include_text       = gs_inc_text
        dg_text            = gt_dg
        repeat             = gv_repeat
        bob_lote           = g_bob_lote
      IMPORTING                                             "EHP5
        /1bcdwb/formoutput = ls_pdf_file                    "EHP5
      EXCEPTIONS
        usage_error        = 1
        system_error       = 2
        internal_error     = 3
        OTHERS             = 4.
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.
*   Enhancements for web dynpro pdf output  ****EHP5

    .
    IF xscreen = 'W'.
      EXPORT lv_pdf_file = ls_pdf_file-pdf TO MEMORY ID 'PDF_FILE'.
    ELSE.
*****************************Start of Note 1503297************************************************************

*sending Document out via mail or FAX
      IF xscreen IS INITIAL  "In case of preview message should be displayed only
          AND ( nast-nacha EQ 5 OR nast-nacha EQ 2 ) AND ls_pdf_file IS NOT INITIAL.

* get Email id from address no
* Inicio mod 19.04-17 JJR

** Inicio mod 02.07-2020 - CMS - 60348 - Añadir destinatarios de ZTPP0047
** Dato centro----> ls_vbdpl-werks   LT_ALBARAN-POSICIONES[1]-POS_ENTREGA-WERKS
*        CALL METHOD zcl_utils_hpap_pp=>obtener_dest_entrega_salida
*          EXPORTING
*            i_werks           = lt_albaran-posiciones[ 1 ]-pos_entrega-werks
*            i_dest_mercancias = lt_albaran-cabecera-cabecera-kunwe
*          IMPORTING
*            ot_destinatarios  = DATA(lt_destinatarios).
*
*
*        IF lt_destinatarios IS INITIAL.

*        IF nast-parvw = '§§'. " DEL - cvivo - 57924 Lógica directamente si es tipo usuario
        IF g_nrart EQ 'US'. " es tipo usuario
          SELECT SINGLE smtp_addr FROM adr6 INTO lv_emailaddr WHERE addrnumber = addr_key-addrnumber
                                                      AND flgdefault = abap_true
                                                      AND persnumber = addr_key-persnumber.
        ELSE.
* FIN mod 19.04-17 JJR
          SELECT SINGLE smtp_addr FROM adr6 INTO lv_emailaddr WHERE addrnumber = addr_key-addrnumber AND flgdefault = abap_true.
        ENDIF.

**        ENDIF.
* FIN CMS 02.07-2020

        " When more than one address is maintained default address should be selected.
        " When there is only one mail id then that will have default flag set
* Set FAX specific setting
        IF nast-telfx NE space.
          lv_outputparams_fax-telenum  = nast-telfx.
          IF nast-tland IS INITIAL.
            lv_outputparams_fax-teleland = vbdkl-land1.
          ELSE.
            lv_outputparams_fax-teleland = nast-tland.
          ENDIF.
        ENDIF.
        IF gv_comm_type EQ 'FAX' OR gv_comm_type EQ 'INT' OR nast-nacha EQ 2.
* ------------ Call BCS interface ----------------------------------
          TRY.
*   ---------- create persistent send request ----------------------
              send_request = cl_bcs=>create_persistent( ).

*   ---------- add document ----------------------------------------
*   get PDF xstring and convert it to BCS format
              lp_pdf_size = xstrlen( ls_pdf_file-pdf ).

              PERFORM xstring_to_solix
                          USING
                             ls_pdf_file-pdf.
              lv_subject = gv_fp_outputparams-covtitle.
              document = cl_document_bcs=>create_document(
                    i_type    = 'PDF' " cf. RAW, DOC
                    i_hex     = gv_pdf_content
                    i_length  = lp_pdf_size
                    i_subject = lv_subject ).               "#EC NOTEXT

*   add document to send request
              send_request->set_document( document ).

*     --------- set sender -------------------------------------------
*     note: this is necessary only if you want to set the sender
*           different from actual user (SY-UNAME). Otherwise sender is
*           set automatically with actual user.

              " cvivo - 57924 Emisor es dirección genérica, para evitar errores de envío
*              DATA(sender) = cl_sapuser_bcs=>create( sy-uname ).
              DATA(sender) = cl_cam_address_bcs=>create_internet_address(
                                        'sap@hinojosa.es' ).

              CALL METHOD send_request->set_sender
                EXPORTING
                  i_sender = sender.
*
*   ---------- add recipient (e-mail address) ----------------------

              CASE nast-nacha.
                WHEN 5.
                  IF gv_comm_type EQ 'INT'.
*           add recipient (e-mail address)

                    recipient = cl_cam_address_bcs=>create_internet_address(
                    i_address_string = lv_emailaddr ).

                  ELSE.
*           add recipient (fax address)
                    recipient = cl_cam_address_bcs=>create_fax_address(
                                     i_country = lv_outputparams_fax-teleland
                                     i_number  = lv_outputparams_fax-telenum ).
                  ENDIF.

                WHEN 2.
*           add recipient (fax address)
                  recipient = cl_cam_address_bcs=>create_fax_address(
                                   i_country = lv_outputparams_fax-teleland
                                   i_number  = lv_outputparams_fax-telenum ).
              ENDCASE.

*   add recipient to send request

*--> 13.03.2023 FCARDONA - 75869 - Lista de distribución Entrega de Salida

              "Obtenemos nombre de lista de distribución
              CLEAR: lv_objname.

              lv_werks = ( lt_albaran-posiciones[ 1 ]-pos_entrega-werks ).

              IF ( lv_werks IS NOT INITIAL ).

                "Monto nombre de lista de distribución
                CONCATENATE 'EN_SAL__' lv_werks INTO lv_objname.

                lt_sodlienti1 = zcl_utils_mail=>get_distribution_list( i_dlistname = lv_objname ).

                "Añado los destinatarios
                LOOP AT lt_sodlienti1 INTO ls_sodlienti1.

                  CASE nast-nacha.

                    WHEN 5.

                      IF gv_comm_type EQ 'INT'.

                        CLEAR: recipient, lv_emailaddr.

                        MOVE ls_sodlienti1-member_adr TO lv_emailaddr.

                        recipient = cl_cam_address_bcs=>create_internet_address( i_address_string = lv_emailaddr ).
                        send_request->add_recipient( i_recipient = recipient ).

                      ENDIF.

                  ENDCASE.

                ENDLOOP.

              ENDIF.







*<-- 13.03.2023 FCARDONA - 75869 - Lista de distribución Entrega de Salida

**** Inicio mod 02.07.2020 - CMS - 60348 - Añadir destinatarios de ZTPP0047
*    Si es envio de correo y centro 3000/3020, buscamos @ en ZTPP0047.
              IF gv_comm_type       EQ 'INT'       AND
                ( lt_albaran-posiciones[ 1 ]-pos_entrega-werks = '3000' OR
                  lt_albaran-posiciones[ 1 ]-pos_entrega-werks = '3020' ).

                CALL METHOD zcl_utils_hpap_pp=>obtener_dest_entrega_salida
                  EXPORTING
                    i_werks           = lt_albaran-posiciones[ 1 ]-pos_entrega-werks
                    i_dest_mercancias = lt_albaran-cabecera-cabecera-kunwe
                  IMPORTING
                    ot_destinatarios  = DATA(lt_destinatarios).

                IF lt_destinatarios   IS NOT INITIAL.
*               Añadimos los destinatarios encontrados en ZTPP0047 (4 como máximo)
                  LOOP AT lt_destinatarios INTO DATA(ls_destinatario).
                    recipient = cl_cam_address_bcs=>create_internet_address( i_address_string = ls_destinatario ).
                    send_request->add_recipient( i_recipient = recipient ).
                  ENDLOOP.

                ELSE.

                  send_request->add_recipient( i_recipient = recipient ).

                ENDIF.

              ELSE.

                send_request->add_recipient( i_recipient = recipient ).

              ENDIF.
**** FIN CMS 02.07.2020


*   ---------- send document ---------------------------------------
              lv_sent_to_all = send_request->send(
                  i_with_error_screen = 'X' ).
* Issue message and COMMINT only if the subroutine is not called in update task
              IF gv_inupd = 0.
                IF lv_sent_to_all = 'X'.
                  MESSAGE i022(so).
                ENDIF.

*   ---------- explicit 'commit work' is mandatory! ----------------
                COMMIT WORK.
              ENDIF.
* ------------------------------------------------------------------
* *            exception handling
* ------------------------------------------------------------------
            CATCH cx_bcs INTO bcs_exception.
              MESSAGE e451(so) WITH lv_outputparams_fax-telenum.
              retcode = 1.
              EXIT.
          ENDTRY.
        ENDIF.
      ENDIF.

* Arching for adobe forms
      IF nast-tdarmod = 2 OR  nast-tdarmod = 3.

* Get the PDF length
        lp_pdf_size = xstrlen( ls_pdf_file-pdf ).

* defaults for archive
        IF toa_dara-function = space.
          toa_dara-function = 'DARA'.
        ENDIF.
*     which format to be used for archiving: OTF or PDF?
        CALL FUNCTION 'ARCHIV_GET_PRINTFORMAT'
          EXPORTING
            application = 'PDF'
          IMPORTING
            printformat = lv_archiveformat.

        IF lv_archiveformat EQ 'PDF'.
          lv_documentclass = 'PDF'.

          CALL FUNCTION 'ARCHIV_CREATE_OUTGOINGDOCUMENT'
            EXPORTING
              arc_p                    = arc_params
              arc_i                    = toa_dara
              pdflen                   = lv_pdf_size
              documentclass            = lv_documentclass                "Since the output is in PDF document class is also PDF
              document                 = ls_pdf_file-pdf
            EXCEPTIONS
              error_archiv             = 1
              error_communicationtable = 2
              error_connectiontable    = 3
              error_kernel             = 4
              error_parameter          = 5
              OTHERS                   = 6.
          CASE sy-subrc.
            WHEN 0. " o.k.
            WHEN 1. RAISE error_archiv.
            WHEN 2. RAISE error_communicationtable.
            WHEN 3. RAISE error_connectiontable.
            WHEN 4. RAISE error_kernel.
            WHEN 5. RAISE error_parameter.
            WHEN 6. RAISE error_archiv. "?
          ENDCASE.

        ELSE.
          " Other than PDF format raise error.
          MESSAGE e789(po) WITH lv_archiveformat.
          retcode = 1.
        ENDIF.
      ENDIF.
    ENDIF.
*****************************End of Note 1503297**************************************************************
*--------------------------------------------------------EHP5

    REFRESH: gt_vbdpl,gt_conf_out,gt_rdgtxtprt,gt_komser.
    CLEAR : gv_repeat, gt_dg, gs_dg.
  ELSE.
    MESSAGE 'PDF form not available' TYPE 'I'.              "#EC NOTEXT
    CALL TRANSACTION 'VL71'.
  ENDIF.

ENDFORM.                    " WRITE_PDF

*&---------------------------------------------------------------------*
*&      Form  FORM_OPEN_PDF
*&---------------------------------------------------------------------*
FORM form_open_pdf USING    us_screen us_country .
*  INCLUDE rvadopfo_pdf.
  INCLUDE zrvadopfo_pdf.
ENDFORM.                    " FORM_OPEN_PDF
*&---------------------------------------------------------------------*
*&      Form  FORM_CLOSE_PDF
*&---------------------------------------------------------------------*
FORM form_close_pdf .
  CALL FUNCTION 'FP_JOB_CLOSE'
    EXCEPTIONS
      usage_error    = 1
      system_error   = 2
      internal_error = 3
      OTHERS         = 4.
  IF sy-subrc NE 0.
    retcode = 1.
    PERFORM protocol_update.
  ENDIF.
  SET COUNTRY space.
ENDFORM.                    " FORM_CLOSE_PDF
*************************Start of Note changes 1503297*********************************
*&---------------------------------------------------------------------*
*&      Form  xstring_to_solix
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->IP_XSTRING text
*----------------------------------------------------------------------*
FORM  xstring_to_solix
  USING ip_xstring TYPE xstring.

  DATA:
    lp_offset          TYPE i,
    lt_solix           TYPE solix_tab,
    ls_solix_line      TYPE solix,
    lp_pdf_string_len  TYPE i,
    lp_solix_rows      TYPE i,
    lp_last_row_length TYPE i,
    lp_row_length      TYPE i.

  CLEAR gv_pdf_content.

* transform xstring to SOLIX
  DESCRIBE TABLE lt_solix.
  lp_row_length = sy-tleng.
  lp_offset = 0.

  lp_pdf_string_len = xstrlen( ip_xstring ).

  lp_solix_rows = lp_pdf_string_len DIV lp_row_length.
  lp_last_row_length = lp_pdf_string_len MOD lp_row_length.
  DO lp_solix_rows TIMES.
    ls_solix_line-line =
           ip_xstring+lp_offset(lp_row_length).
    APPEND ls_solix_line TO gv_pdf_content.
    ADD lp_row_length TO lp_offset.
  ENDDO.
  IF lp_last_row_length > 0.
    CLEAR ls_solix_line-line.
    ls_solix_line-line = ip_xstring+lp_offset(lp_last_row_length).
    APPEND ls_solix_line TO gv_pdf_content.
  ENDIF.

ENDFORM.                    "XSTRING_TO_SOLIX
*************************End of Note changes 1503297*********************************
INCLUDE dor01_f01.

*&---------------------------------------------------------------------*
*&      Form  F_CARGAR_ALBARAN
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM f_cargar_albaran.

  DATA: ls_vttk       TYPE vttk,
        lv_cant_e(15),
        lv_cant_d(3),
        lv_string     TYPE string,
        lv_bezei      TYPE vttk_add01_t,
        l_vbfa        TYPE vbfa.

  DATA:  lv_werks      TYPE lips-werks.

  CLEAR: lt_albaran, ls_vttk, l_vbfa.

  " Cargar cabecera:
  MOVE-CORRESPONDING gs_shipment TO lt_albaran-cabecera-cabecera.
  IF lt_albaran-cabecera-cabecera-vbeln IS NOT INITIAL.

    SELECT SINGLE werks FROM lips
      INTO lv_werks
      WHERE vbeln = lt_albaran-cabecera-cabecera-vbeln.

    " URL del logo
    PERFORM cargar_logo_url USING lt_albaran-cabecera-cabecera-bukrs
                                  lt_albaran-cabecera-cabecera-vkorg
                            CHANGING lt_albaran-cabecera-logo_url.

* GST - 24/02/2015 ->
* Título de formulario:
*** SCT 18/07/2016 para traslados lo hacemos por clase entrega
    PERFORM cargar_titulo USING lt_albaran-cabecera-cabecera-vbtyp
                                lt_albaran-cabecera-cabecera-spras
                                lt_albaran-cabecera-cabecera-zzsegcal
                                lt_albaran-cabecera-cabecera-lfart
                          CHANGING lt_albaran-cabecera-titulo.
*                                   lt_albaran-cabecera-titulo_doc_sm.
* GST - 24/02/2014 <-


    " Doc. Salida Mercancía:
* SCT 18/07/2016 Recuperamos el doc. SM solo para Entr. Traslado
* entre almacenes mismo centro. Asteriscamos temporalmente para que
* se puedan transportar otros cambios en formulario
*    IF lt_albaran-cabecera-cabecera-lfart = 'ZUL'.
*      SELECT * FROM vbfa INTO l_vbfa
*        WHERE vbelv = lt_albaran-cabecera-cabecera-vbeln
*          AND vbtyp_n = 'R'       "Doc.mov.mercancia
*          AND bwart NE ' '.       "Con movimiento
*      ENDSELECT.
*      IF sy-subrc = 0.
*        lt_albaran-cabecera-doc_salida = l_vbfa-vbeln.
*      ENDIF.
*    ENDIF.

    " Datos de sociedad:
*    PERFORM cargar_dat_soc USING lt_albaran-cabecera-cabecera-bukrs
*                           CHANGING lt_albaran-cabecera-sociedad.

    PERFORM cargar_dat_centro USING    lt_albaran-cabecera-cabecera-bukrs
                                       lt_albaran-cabecera-cabecera-vstel
                                       lt_albaran-cabecera-cabecera-vkorg
                                       lv_werks
                              CHANGING lt_albaran-cabecera-sociedad
                                       lt_albaran-cabecera-prov.

    " Datos Destino Mercancía:
    PERFORM cargar_dat_dmerc USING lt_albaran-cabecera-cabecera
                             CHANGING lt_albaran-cabecera-dest_mercancia.

    " Transporte:
    SELECT SINGLE vbeln INTO lt_albaran-cabecera-tknum
      FROM vbfa
      WHERE vbelv = lt_albaran-cabecera-cabecera-vbeln
      AND vbtyp_n = '8'. " Transporte

    " Fecha Albarán (Texto):
    CONCATENATE lt_albaran-cabecera-cabecera-wadat+6(2) lt_albaran-cabecera-cabecera-wadat+4(2)
                lt_albaran-cabecera-cabecera-wadat+0(4)
                INTO lt_albaran-cabecera-wadat_txt SEPARATED BY '.'.

    " Prioridad (Texto):
    SELECT SINGLE bezei INTO lt_albaran-cabecera-lprio_txt
      FROM tprit
      WHERE spras = lt_albaran-cabecera-cabecera-spras
      AND lprio = lt_albaran-cabecera-cabecera-lprio.

    " Peso total (Texto):
    IF lt_albaran-cabecera-cabecera-btgew IS NOT INITIAL.
      WRITE lt_albaran-cabecera-cabecera-btgew TO lt_albaran-cabecera-peso_txt.
      CONDENSE lt_albaran-cabecera-peso_txt.
      SPLIT lt_albaran-cabecera-peso_txt AT ',' INTO lv_cant_e lv_cant_d.
      CONDENSE: lv_cant_e, lv_cant_d.
      IF lv_cant_d <> '000'.
        CONCATENATE lt_albaran-cabecera-peso_txt lt_albaran-cabecera-cabecera-gewei
                    INTO lt_albaran-cabecera-peso_txt SEPARATED BY space.
      ELSE.
        CLEAR lv_string.
        CONDENSE lv_cant_e.
        CONCATENATE lv_cant_e lt_albaran-cabecera-cabecera-gewei
                INTO lt_albaran-cabecera-peso_txt SEPARATED BY space.
      ENDIF.
    ENDIF.

    " Horas de descarga:
    IF lt_albaran-cabecera-cabecera-lfdat IS NOT INITIAL AND lt_albaran-cabecera-cabecera-kunwe IS NOT INITIAL.
      PERFORM horas_descarga USING lt_albaran-cabecera-cabecera-lfdat
                                   lt_albaran-cabecera-cabecera-kunwe
                                   lt_albaran-cabecera-cabecera-ablad
                             CHANGING lt_albaran-cabecera-hora_desc_1_ini
                                      lt_albaran-cabecera-hora_desc_1_fin
                                      lt_albaran-cabecera-hora_desc_2_ini
                                      lt_albaran-cabecera-hora_desc_2_fin.

      " Horario mañana:
      IF lt_albaran-cabecera-hora_desc_1_ini IS NOT INITIAL AND lt_albaran-cabecera-hora_desc_1_fin IS NOT INITIAL.
        CONCATENATE lt_albaran-cabecera-hora_desc_1_ini lt_albaran-cabecera-hora_desc_1_fin
                    INTO lt_albaran-cabecera-hora_desc_man SEPARATED BY ' - '.
      ELSEIF lt_albaran-cabecera-hora_desc_1_ini IS NOT INITIAL AND lt_albaran-cabecera-hora_desc_1_fin IS INITIAL.
        lt_albaran-cabecera-hora_desc_man = lt_albaran-cabecera-hora_desc_1_ini.
      ELSEIF lt_albaran-cabecera-hora_desc_1_ini IS INITIAL AND lt_albaran-cabecera-hora_desc_1_fin IS NOT INITIAL.
        lt_albaran-cabecera-hora_desc_man = lt_albaran-cabecera-hora_desc_1_fin.
      ENDIF.

      " Horario tarde:
      IF lt_albaran-cabecera-hora_desc_2_ini IS NOT INITIAL AND lt_albaran-cabecera-hora_desc_2_fin IS NOT INITIAL.
        CONCATENATE lt_albaran-cabecera-hora_desc_2_ini lt_albaran-cabecera-hora_desc_2_fin
                    INTO lt_albaran-cabecera-hora_desc_tar SEPARATED BY ' - '.
      ELSEIF lt_albaran-cabecera-hora_desc_2_ini IS NOT INITIAL AND lt_albaran-cabecera-hora_desc_2_fin IS INITIAL.
        lt_albaran-cabecera-hora_desc_tar = lt_albaran-cabecera-hora_desc_2_ini.
      ELSEIF lt_albaran-cabecera-hora_desc_2_ini IS INITIAL AND lt_albaran-cabecera-hora_desc_2_fin IS NOT INITIAL.
        lt_albaran-cabecera-hora_desc_tar = lt_albaran-cabecera-hora_desc_2_fin.
      ENDIF.
    ENDIF.

    " Datos del transporte:
    IF lt_albaran-cabecera-tknum IS NOT INITIAL.
      SELECT SINGLE * INTO ls_vttk
        FROM vttk
        WHERE tknum = lt_albaran-cabecera-tknum.

      IF ls_vttk IS NOT INITIAL.
        lt_albaran-cabecera-transporte-tdlnr = ls_vttk-tdlnr.
        SELECT SINGLE name1 stceg INTO (lt_albaran-cabecera-transporte-name1, lt_albaran-cabecera-transporte-stceg)
          FROM lfa1
          WHERE lifnr = lt_albaran-cabecera-transporte-tdlnr.
        lt_albaran-cabecera-transporte-signi = ls_vttk-signi.
        lt_albaran-cabecera-transporte-tpbez = ls_vttk-tpbez.
        IF ls_vttk-text1 IS NOT INITIAL.
          lt_albaran-cabecera-transporte-text1 = ls_vttk-text1.
        ELSEIF ls_vttk-add01 IS NOT INITIAL.
          CLEAR lv_bezei.
          SELECT SINGLE bezei INTO lv_bezei
            FROM vtadd01t
            WHERE spras = lt_albaran-cabecera-cabecera-spras
            AND add_info = ls_vttk-add01.
          CONCATENATE ls_vttk-add01 lv_bezei INTO lt_albaran-cabecera-transporte-text1
               SEPARATED BY '/'.
        ENDIF.
      ENDIF.
    ENDIF.

    " Texto Albarán:
    lt_albaran-cabecera-texto_albaran-tdname = lt_albaran-cabecera-cabecera-vbeln.
    lt_albaran-cabecera-texto_albaran-tdobject = 'VBBK'.
    lt_albaran-cabecera-texto_albaran-tdid = '0001'.
    lt_albaran-cabecera-texto_albaran-tdspras = lt_albaran-cabecera-cabecera-spras.

    " Texto LOPD:
    CONCATENATE 'ZLOPD_' gs_shipment-bukrs INTO lt_albaran-cabecera-texto_lopd-tdname.
*    lt_albaran-cabecera-texto_lopd-tdname = 'ZFACTURA_LOPD'.
    lt_albaran-cabecera-texto_lopd-tdobject = 'TEXT'.
    lt_albaran-cabecera-texto_lopd-tdid = 'ST'.
    lt_albaran-cabecera-texto_lopd-tdspras = lt_albaran-cabecera-cabecera-spras.

* NAC -> Reg. Mercantil para sociedad distinto de
* 2040 (Cartonajes Bernabéu).
    IF  lt_albaran-cabecera-cabecera-bukrs NE '2040'.
      " Texto registro mercantil:
      CONCATENATE 'ZREG_MERC_' gs_shipment-bukrs INTO lt_albaran-reg_mercantil-tdname.
      lt_albaran-reg_mercantil-tdobject = 'TEXT'.
      lt_albaran-reg_mercantil-tdid = 'ST'.
      lt_albaran-reg_mercantil-tdspras = lt_albaran-cabecera-cabecera-spras.
    ENDIF.
    lt_albaran-texto_residuos-tdid     = 'ST'.
    lt_albaran-texto_residuos-tdobject = 'TEXT'.
    lt_albaran-texto_residuos-tdspras  = lt_albaran-cabecera-cabecera-spras.
    lt_albaran-texto_residuos-tdname   = 'ZTEXTO_RESIDUOS'.

    " Texto SEGUNDA CALIDAD: (cgijon: 02/03/16)
    IF lt_albaran-cabecera-cabecera-zzsegcal IS NOT INITIAL.
**** AFCS - SAT 7000014668: Ticket ## 40563 ## de: cborreda@palqueri  -->
      CASE lt_albaran-cabecera-cabecera-zzsegcal.
        WHEN '1'.
          lt_albaran-cabecera-texto_segcal-tdname = 'ZSDV2002'.
          lt_albaran-cabecera-texto_segcal-tdobject = 'TEXT'.
          lt_albaran-cabecera-texto_segcal-tdid = 'ST'.
          lt_albaran-cabecera-texto_segcal-tdspras = lt_albaran-cabecera-cabecera-spras.
        WHEN '2'.
          lt_albaran-cabecera-texto_segcal-tdname = 'ZSDV2003'.
          lt_albaran-cabecera-texto_segcal-tdobject = 'TEXT'.
          lt_albaran-cabecera-texto_segcal-tdid = 'ST'.
          lt_albaran-cabecera-texto_segcal-tdspras = lt_albaran-cabecera-cabecera-spras.
      ENDCASE.
**** AFCS - SAT 7000014668: Ticket ## 40563 ## de: cborreda@palqueri  <--

    ELSE.
      CLEAR lt_albaran-cabecera-texto_segcal.
    ENDIF.

    " Código barras Albarán:
    lt_albaran-cabecera-bar_albaran = lt_albaran-cabecera-cabecera-vbeln.

    " Cargar posiciones:
    PERFORM cargar_posiciones.

  ENDIF.

ENDFORM.                    " F_CARGAR_ALBARAN
*&---------------------------------------------------------------------*
*&      Form  CARGAR_LOGO_URL
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LT_ALBARAN_CABECERA_CABECERA_B  text
*      <--P_LT_ALBARAN_CABECERA_LOGO_URL  text
*----------------------------------------------------------------------*
FORM cargar_logo_url  USING    p_bukrs
                               p_vkorg
                      CHANGING p_logo_url.

*  " Obtenemos la ruta del logo
*  CONCATENATE 'E:\logos\' p_bukrs '.jpg' INTO p_logo_url.
*  CONDENSE p_logo_url.

  CALL FUNCTION 'ZRECUPERA_LOGOS_SOCIEDAD'
    EXPORTING
      iv_bukrs = p_bukrs
*     iv_vkorg = p_vkorg
    IMPORTING
      ev_path  = p_logo_url.


ENDFORM.                    " CARGAR_LOGO_URL
*&---------------------------------------------------------------------*
*&      Form  CARGAR_DAT_SOC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LT_ALBARAN_CABECERA_CABECERA_B  text
*      <--P_LT_ALBARAN_CABECERA_SOCIEDAD  text
*----------------------------------------------------------------------*
FORM cargar_dat_soc  USING    p_bukrs
                     CHANGING ps_sociedad TYPE zstsd_albaran_dir.


  DATA: lv_adrnr TYPE adrnr,
        ls_adrc  TYPE adrc.

  CLEAR: ps_sociedad, ls_adrc, lv_adrnr.

  SELECT SINGLE adrnr stceg INTO (ps_sociedad-adrnr, ps_sociedad-stceg)
    FROM t001
    WHERE bukrs = p_bukrs.

  IF ps_sociedad-adrnr IS NOT INITIAL.

    SELECT SINGLE * INTO ls_adrc
      FROM adrc
      WHERE addrnumber = ps_sociedad-adrnr.

    IF ls_adrc IS NOT INITIAL.

      MOVE-CORRESPONDING ls_adrc TO ps_sociedad.
      TRANSLATE ps_sociedad-name1 TO UPPER CASE.
      " Dirección 1:
      CONDENSE: ps_sociedad-street, ps_sociedad-house_num1.
      IF ps_sociedad-house_num1 IS NOT INITIAL.
        CONCATENATE ps_sociedad-street ps_sociedad-house_num1
                    INTO ps_sociedad-direc_1 SEPARATED BY ', '.
      ELSE.
        WRITE ps_sociedad-street TO ps_sociedad-direc_1.
      ENDIF.
      TRANSLATE ps_sociedad-direc_1 TO UPPER CASE.
      " Dirección 2:
      CONDENSE: ps_sociedad-post_code1, ps_sociedad-city1.
      CONCATENATE ps_sociedad-post_code1 ps_sociedad-city1
                INTO ps_sociedad-direc_2 SEPARATED BY space.
      TRANSLATE ps_sociedad-direc_2 TO UPPER CASE.
      IF ps_sociedad-region IS NOT INITIAL.
        TRANSLATE ps_sociedad-city1 TO UPPER CASE.
        SELECT SINGLE bezei INTO ps_sociedad-bezei
          FROM t005u
          WHERE bland = ls_adrc-region
          AND spras = ls_adrc-langu
          AND land1 = ls_adrc-country.
        TRANSLATE ps_sociedad-bezei TO UPPER CASE.
        IF ps_sociedad-bezei IS NOT INITIAL AND ps_sociedad-bezei NE ps_sociedad-city1.
          CONCATENATE ps_sociedad-direc_2 ps_sociedad-bezei
                      INTO ps_sociedad-direc_2 SEPARATED BY ' - '.
        ENDIF.
      ENDIF.
    ENDIF.
    " FAX:
    SELECT SINGLE fax_number INTO ps_sociedad-fax_number
      FROM adr3
      WHERE addrnumber = ps_sociedad-adrnr.
  ENDIF.

ENDFORM.                    " CARGAR_DAT_SOC
*&---------------------------------------------------------------------*
*&      Form  CARGAR_DAT_DMERC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LT_ALBARAN_CABECERA_CABECERA  text
*      <--P_LT_ALBARAN_CACEBERA_DEST_MERCA  text
*----------------------------------------------------------------------*
FORM cargar_dat_dmerc  USING    ps_cabecera TYPE vbdkl
                       CHANGING ps_dest_merc TYPE zstsd_albaran_dir.


  DATA: lv_adrnr TYPE adrnr,
        ls_adrc  TYPE adrc.

  CLEAR: ps_dest_merc, ls_adrc, lv_adrnr.

  ps_dest_merc-adrnr = ps_cabecera-adrnr_we.
  ps_dest_merc-stceg = ps_cabecera-stcd1_we.

  IF ps_dest_merc-adrnr IS NOT INITIAL.

    SELECT SINGLE * INTO ls_adrc
      FROM adrc
      WHERE addrnumber = ps_dest_merc-adrnr.

    IF ls_adrc IS NOT INITIAL.

      MOVE-CORRESPONDING ls_adrc TO ps_dest_merc.
      TRANSLATE ps_dest_merc-name1 TO UPPER CASE.
      " Dirección 1:
      CONDENSE: ps_dest_merc-street, ps_dest_merc-house_num1.
      IF ps_dest_merc-house_num1 IS NOT INITIAL.
        CONCATENATE ps_dest_merc-street ps_dest_merc-house_num1
                    INTO ps_dest_merc-direc_1 SEPARATED BY ', '.
      ELSE.
        WRITE ps_dest_merc-street TO ps_dest_merc-direc_1.
      ENDIF.
      TRANSLATE ps_dest_merc-direc_1 TO UPPER CASE.
      " Dirección 2:
      CONDENSE: ps_dest_merc-post_code1, ps_dest_merc-city1.
      CONCATENATE ps_dest_merc-post_code1 ps_dest_merc-city1
                INTO ps_dest_merc-direc_2 SEPARATED BY space.
      TRANSLATE ps_dest_merc-direc_2 TO UPPER CASE.
      IF ps_dest_merc-region IS NOT INITIAL.
        TRANSLATE ps_dest_merc-city1 TO UPPER CASE.
        SELECT SINGLE bezei INTO ps_dest_merc-bezei
          FROM t005u
          WHERE bland = ls_adrc-region
          AND spras = ls_adrc-langu
          AND land1 = ls_adrc-country.
        TRANSLATE ps_dest_merc-bezei TO UPPER CASE.
        IF ps_dest_merc-bezei IS NOT INITIAL AND ps_dest_merc-bezei NE ps_dest_merc-city1.
          CONCATENATE ps_dest_merc-direc_2 ps_dest_merc-bezei
                      INTO ps_dest_merc-direc_2 SEPARATED BY ' - '.
        ENDIF.
      ENDIF.
    ENDIF.
    " FAX:
    SELECT SINGLE fax_number INTO ps_dest_merc-fax_number
      FROM adr3
      WHERE addrnumber = ps_dest_merc-adrnr.
  ENDIF.

ENDFORM.                    " CARGAR_DAT_DMERC
*&---------------------------------------------------------------------*
*&      Form  HORAS_DESCARGA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LT_ALBARAN_CABECERA_CABECERA_L  text
*      <--P_LT_ALBARAN_CABECERA_HORA_DESC_  text
*      <--P_LT_ALBARAN_CABECERA_HORA_DESC_  text
*      <--P_LT_ALBARAN_CABECERA_HORA_DESC_  text
*      <--P_LT_ALBARAN_CABECERA_HORA_DESC_  text
*----------------------------------------------------------------------*
FORM horas_descarga  USING    p_lfdat
                              p_kunnr
                              p_ablad
                     CHANGING p_mh_ini
                              p_mh_fin
                              p_th_ini
                              p_th_fin.

*  CONSTANTS: lv_horario TYPE ablad VALUE 'Materias Primas'.

  DATA: lv_dia_sem TYPE p,
        ls_knva    TYPE knva.

  CLEAR: p_mh_ini, p_mh_ini, p_th_ini, p_th_fin, lv_dia_sem, ls_knva.

  CALL FUNCTION 'DAY_IN_WEEK'
    EXPORTING
      datum = p_lfdat
    IMPORTING
      wotnr = lv_dia_sem.

  SELECT SINGLE * INTO ls_knva
    FROM knva
    WHERE kunnr = p_kunnr
    AND ablad = p_ablad.

  IF ls_knva IS NOT INITIAL AND lv_dia_sem IS NOT INITIAL.

    CASE lv_dia_sem.

      WHEN '1'.  " Lunes

        IF ls_knva-moab1 <> '000000' OR ls_knva-mobi1 <> '000000'.
          CONCATENATE ls_knva-moab1+0(2) ls_knva-moab1+2(2)
                      INTO  p_mh_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-mobi1+0(2) ls_knva-mobi1+2(2)
                      INTO p_mh_fin SEPARATED BY ':'.
        ENDIF.

        IF ls_knva-moab2 <> '000000' OR ls_knva-mobi2 <> '000000'.
          CONCATENATE ls_knva-moab2+0(2) ls_knva-moab2+2(2)
                      INTO  p_th_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-mobi2+0(2) ls_knva-mobi2+2(2)
                      INTO p_th_fin SEPARATED BY ':'.
        ENDIF.

      WHEN '2'.  " Martes

        IF ls_knva-diab1 <> '000000' OR ls_knva-dibi1 <> '000000'.
          CONCATENATE ls_knva-diab1+0(2) ls_knva-diab1+2(2)
                      INTO  p_mh_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-dibi1+0(2) ls_knva-dibi1+2(2)
                      INTO p_mh_fin SEPARATED BY ':'.
        ENDIF.

        IF ls_knva-diab2 <> '000000' OR ls_knva-dibi2 <> '000000'.
          CONCATENATE ls_knva-diab2+0(2) ls_knva-diab2+2(2)
                      INTO  p_th_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-dibi2+0(2) ls_knva-dibi2+2(2)
                      INTO p_th_fin SEPARATED BY ':'.
        ENDIF.

      WHEN '3'.  " Miércoles

        IF ls_knva-miab1 <> '000000' OR ls_knva-mibi1 <> '000000'.
          CONCATENATE ls_knva-miab1+0(2) ls_knva-miab1+2(2)
                      INTO  p_mh_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-mibi1+0(2) ls_knva-mibi1+2(2)
                      INTO p_mh_fin SEPARATED BY ':'.
        ENDIF.

        IF ls_knva-miab2 <> '000000' OR ls_knva-mibi2 <> '000000'.
          CONCATENATE ls_knva-miab2+0(2) ls_knva-miab2+2(2)
                      INTO  p_th_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-mibi2+0(2) ls_knva-mibi2+2(2)
                      INTO p_th_fin SEPARATED BY ':'.
        ENDIF.

      WHEN '4'.  " Jueves

        IF ls_knva-doab1 <> '000000' OR ls_knva-dobi1 <> '000000'.
          CONCATENATE ls_knva-doab1+0(2) ls_knva-doab1+2(2)
                      INTO  p_mh_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-dobi1+0(2) ls_knva-dobi1+2(2)
                      INTO p_mh_fin SEPARATED BY ':'.
        ENDIF.

        IF ls_knva-doab2 <> '000000' OR ls_knva-dobi2 <> '000000'.
          CONCATENATE ls_knva-doab2+0(2) ls_knva-doab2+2(2)
                      INTO  p_th_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-dobi2+0(2) ls_knva-dobi2+2(2)
                      INTO p_th_fin SEPARATED BY ':'.
        ENDIF.

      WHEN '5'.  " Viernes

        IF ls_knva-frab1 <> '000000' OR ls_knva-frbi1 <> '000000'.
          CONCATENATE ls_knva-frab1+0(2) ls_knva-frab1+2(2)
                      INTO  p_mh_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-frbi1+0(2) ls_knva-frbi1+2(2)
                      INTO p_mh_fin SEPARATED BY ':'.
        ENDIF.

        IF ls_knva-frab2 <> '000000' OR ls_knva-frbi2 <> '000000'.
          CONCATENATE ls_knva-frab2+0(2) ls_knva-frab2+2(2)
                      INTO  p_th_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-frbi2+0(2) ls_knva-frbi2+2(2)
                      INTO p_th_fin SEPARATED BY ':'.
        ENDIF.

      WHEN '6'.  " Sábado

        IF ls_knva-saab1 <> '000000' OR ls_knva-sabi1 <> '000000'.
          CONCATENATE ls_knva-saab1+0(2) ls_knva-saab1+2(2)
                      INTO  p_mh_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-sabi1+0(2) ls_knva-sabi1+2(2)
                      INTO p_mh_fin SEPARATED BY ':'.
        ENDIF.

        IF ls_knva-saab2 <> '000000' OR ls_knva-sabi2 <> '000000'.
          CONCATENATE ls_knva-saab2+0(2) ls_knva-saab2+2(2)
                      INTO  p_th_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-sabi2+0(2) ls_knva-sabi2+2(2)
                      INTO p_th_fin SEPARATED BY ':'.
        ENDIF.

      WHEN '7'.  " Domingo

        IF ls_knva-soab1 <> '000000' OR ls_knva-sobi1 <> '000000'.
          CONCATENATE ls_knva-soab1+0(2) ls_knva-soab1+2(2)
                      INTO  p_mh_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-sobi1+0(2) ls_knva-sobi1+2(2)
                      INTO p_mh_fin SEPARATED BY ':'.
        ENDIF.

        IF ls_knva-soab2 <> '000000' OR ls_knva-sobi2 <> '000000'.
          CONCATENATE ls_knva-soab2+0(2) ls_knva-soab2+2(2)
                      INTO  p_th_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-sobi2+0(2) ls_knva-sobi2+2(2)
                      INTO p_th_fin SEPARATED BY ':'.
        ENDIF.

    ENDCASE.

  ENDIF.

ENDFORM.                    " HORAS_DESCARGA
*&---------------------------------------------------------------------*
*&      Form  CARGAR_POSICIONES
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM cargar_posiciones .


  DATA: ls_vbdpl       TYPE vbdpl,
        ls_pos         TYPE zstsd_albaran_posicion,
        ls_texto       TYPE zstbc_textolargo,
        lv_index       LIKE sy-tabix,
        ls_part        TYPE zstsd_albaran_part_entrega_lin,
        lv_vgbel       TYPE vgbel,
        lv_vgpos       TYPE vgpos,
        lv_bstkd       TYPE bstkd,
        lv_adrnr       TYPE adrnr,
        lv_sort2       TYPE ad_sort2,
        lv_lfimg_e(17),
        lv_lfimg_d(3),
        lv_string      TYPE string,
        lv_matnr       TYPE matnr,
        lv_long        TYPE i.

  CONSTANTS: c_ceros(16)      VALUE '0000000000000000'.

  DATA: lt_lines TYPE tline_tab.

  CLEAR: ls_vbdpl, ls_pos, lv_index.
  " Cargar datos posiciones de entrega:
  LOOP AT gt_vbdpl INTO ls_vbdpl WHERE uecha IS INITIAL. " cvivo - 56215
    ls_pos-pos_entrega = ls_vbdpl.
    APPEND ls_pos TO lt_albaran-posiciones.
  ENDLOOP.
  CLEAR: ls_pos, ls_part.

  " Cargar datos particiones de lote:
  LOOP AT lt_albaran-posiciones INTO ls_pos.
    lv_index = sy-tabix.
    CLEAR: ls_vbdpl.
    LOOP AT gt_vbdpl INTO ls_vbdpl WHERE uecha = ls_pos-pos_entrega-posnr
* INI HPAP-PP  CMS 03.07.2020 - 61836 - Revisión de datos para Posiciones sin reparto (un único lote informado en la posición)
*                                      OR ( uecha EQ space AND posnr EQ ls_pos-pos_entrega-posnr AND werks CP '2*' ). " cvivo 12.07.2019 -> si no, no salen las posiciones sin partición
                                      OR ( uecha EQ space AND posnr EQ ls_pos-pos_entrega-posnr ). " AND werks CP '2*' ). " cvivo 12.07.2019 -> si no, no salen las posiciones sin partición

*      IF ls_vbdpl-werks CP '2*'. " cvivo - 56215
      IF ls_vbdpl-lfimg LE 0. " nos saltamos las posiciones sin kilogramos
        CONTINUE.
      ENDIF.
*      ENDIF.
* FIN CMS 03.07.2020

      MOVE-CORRESPONDING ls_vbdpl TO ls_part-vbdpl.

*--> INI FCARDONA 26.07.2024 - 84442 Certificado FSC en expediciones a Pacarpe

*""""""" Comento por cambio a nueva lógica
*
** 69669 - 01/12/2021 - CMS Mostrar código de material externo para papeleras(DS Smith).
** Obtener codigo de material extereno, si procede.
*      IF ls_vbdpl-werks = '3000' OR ls_vbdpl-werks = '3020' .
*
*        CALL METHOD zcl_utils_hpap_pp=>get_material_cliente_externo
*          EXPORTING
*            i_werks = ls_vbdpl-werks
*            i_matnr = ls_vbdpl-matnr
*            i_kunnr = gs_shipment-kunnr
*          IMPORTING
*            o_matnr = DATA(l_matnr_ext).
*        ls_part-vbdpl-matnr = l_matnr_ext.
*
*      ENDIF.
*
*      " Certificado FSC:
** GST - 19/01/2016 ->
**      PERFORM certif_fsc USING ls_part-vbdpl-matwa
**                               ls_part-vbdpl-charg
**                         CHANGING ls_part-certif_fsc.
*
*      PERFORM certif_fsc_2 USING lt_albaran-cabecera-cabecera-bukrs
*                                 lt_albaran-cabecera-cabecera-wadat
*                           CHANGING ls_part-certif_fsc.
** GST - 19/01/2016 <-



* 69669 - 01/12/2021 - CMS Mostrar código de material externo para papeleras(DS Smith).
* Obtener codigo de material extereno, si procede.
      IF ls_vbdpl-werks = '3000' OR ls_vbdpl-werks = '3020' .

        CALL METHOD zcl_utils_hpap_pp=>get_material_cliente_externo
          EXPORTING
            i_werks = ls_vbdpl-werks
            i_matnr = ls_vbdpl-matnr
            i_kunnr = gs_shipment-kunnr
          IMPORTING
            o_matnr = DATA(l_matnr_ext).
        ls_part-vbdpl-matnr = l_matnr_ext.

      " Certificado FSC:
* GST - 19/01/2016 ->
*      PERFORM certif_fsc USING ls_part-vbdpl-matwa
*                               ls_part-vbdpl-charg
*                         CHANGING ls_part-certif_fsc.

        PERFORM certif_fsc_2 USING lt_albaran-cabecera-cabecera-bukrs
                                   lt_albaran-cabecera-cabecera-wadat
                             CHANGING ls_part-certif_fsc.
* GST - 19/01/2016 <-

      ELSE.

        PERFORM get_fsc_folding_4_vbeln_posnr    USING ls_vbdpl-vbeln ls_vbdpl-posnr
                                              CHANGING ls_part-certif_fsc.

      ENDIF.

*--> FIN FCARDONA 26.07.2024 - 84442 Certificado FSC en expediciones a Pacarpe

* Para el tipo de material "ZREC" no mostrar certificado FSC    CMS 12/02/2020
      DATA: l_mtart TYPE mtart,
            l_matnr TYPE matnr.

      CLEAR: l_mtart , l_matnr.
      l_matnr = |{ ls_vbdpl-matnr ALPHA = IN }|.

      SELECT SINGLE mtart INTO l_mtart
        FROM mara
        WHERE matnr = l_matnr.

      IF sy-subrc = 0 AND l_mtart = 'ZREC' AND
         lt_albaran-cabecera-cabecera-bukrs CP '3*'.
        CLEAR ls_part-certif_fsc.
        g_bob_lote = 'LOTE'.
      ELSE.
        g_bob_lote = 'BOBINA'.
      ENDIF.

      " Cantidad (kg):
      IF ls_part-vbdpl-vrkme <> 'KG'.
        CALL FUNCTION 'ZCONVERTIR_CANTIDAD'
          EXPORTING
            i_matnr    = ls_part-vbdpl-matnr
            i_canti    = ls_part-vbdpl-lfimg
            i_meins_or = ls_part-vbdpl-vrkme
            i_meins_fi = 'KG'
          IMPORTING
            e_canti    = ls_part-lfimg_kg.
      ELSE.
        ls_part-lfimg_kg = ls_part-vbdpl-lfimg.
      ENDIF.

      CLEAR: lv_lfimg_e, lv_lfimg_d.
      IF ls_part-lfimg_kg IS NOT INITIAL.
        WRITE ls_part-lfimg_kg TO ls_part-lfimg_kg_txt.
        CONDENSE ls_part-lfimg_kg_txt.
        SPLIT ls_part-lfimg_kg_txt AT ',' INTO lv_lfimg_e lv_lfimg_d.
        CONDENSE: lv_lfimg_e, lv_lfimg_d.
        IF lv_lfimg_d <> '000'.
          WRITE ls_part-lfimg_kg TO ls_part-lfimg_kg_txt.
          CONDENSE ls_part-lfimg_kg_txt.
        ELSE.
          CLEAR lv_string.
          CONDENSE lv_lfimg_e.
          WRITE lv_lfimg_e TO ls_part-lfimg_kg_txt.
        ENDIF.
      ENDIF.

      " Suma total (kg):

      ls_pos-pos_total-lfimg = ls_pos-pos_total-lfimg + ls_part-lfimg_kg.

      " Pedido cliente:
      IF ls_vbdpl-vgbel IS NOT INITIAL AND ls_vbdpl-vgpos IS NOT INITIAL.
        CLEAR: lv_vgbel, lv_vgpos.
        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
          EXPORTING
            input  = ls_vbdpl-vgbel
          IMPORTING
            output = lv_vgbel.

        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
          EXPORTING
            input  = ls_vbdpl-vgpos
          IMPORTING
            output = lv_vgpos.

        IF lt_albaran-cabecera-cabecera-lfart = 'ZLF'. " Ventas
          CLEAR lv_bstkd.
          SELECT SINGLE bstkd INTO lv_bstkd
            FROM vbkd
            WHERE vbeln = ls_vbdpl-vgbel
            AND posnr = ls_vbdpl-vgpos.
          IF lv_bstkd IS NOT INITIAL.
            CONDENSE lv_bstkd.
            ls_part-ped_cliente = lv_bstkd.
            CONCATENATE lv_vgbel lv_vgpos INTO ls_part-ped_pos SEPARATED BY '/'.
*            CONCATENATE ls_vbdpl-vgbel ls_vbdpl-vgpos INTO ls_part-bar_pedido.
            CLEAR lv_long.
            ls_part-bar_pedido = ls_part-ped_cliente.
            lv_long = strlen( ls_part-bar_pedido ).
            OVERLAY ls_part-bar_pedido WITH c_ceros.
            SHIFT ls_part-bar_pedido BY lv_long PLACES LEFT CIRCULAR.
          ELSE.
            SELECT SINGLE bstkd INTO lv_bstkd
              FROM vbkd
              WHERE vbeln = ls_vbdpl-vgbel
              AND posnr = '000000'.
            IF lv_bstkd IS NOT INITIAL.
              CONDENSE lv_bstkd.
              ls_part-ped_cliente = lv_bstkd.
              CONCATENATE lv_vgbel lv_vgpos INTO ls_part-ped_pos SEPARATED BY '/'.
*              CONCATENATE ls_vbdpl-vgbel ls_vbdpl-vgpos INTO ls_part-bar_pedido.
              CLEAR lv_long.
              ls_part-bar_pedido = ls_part-ped_cliente.
              lv_long = strlen( ls_part-bar_pedido ).
              OVERLAY ls_part-bar_pedido WITH c_ceros.
              SHIFT ls_part-bar_pedido BY lv_long PLACES LEFT CIRCULAR.
            ELSE.
              CONCATENATE lv_vgbel lv_vgpos INTO ls_part-ped_cliente SEPARATED BY '/'.
              CONCATENATE lv_vgbel lv_vgpos INTO ls_part-ped_pos SEPARATED BY '/'.
*              CONCATENATE ls_vbdpl-vgbel ls_vbdpl-vgpos INTO ls_part-bar_pedido.
              CONDENSE lv_bstkd.
              CLEAR lv_long.
              ls_part-bar_pedido = lv_bstkd.
              lv_long = strlen( ls_part-bar_pedido ).
              OVERLAY ls_part-bar_pedido WITH c_ceros.
              SHIFT ls_part-bar_pedido BY lv_long PLACES LEFT CIRCULAR.
            ENDIF.
          ENDIF.
*        ELSEIF lt_albaran-cabecera-cabecera-lfart = 'ZNLC'. " Compras
        ELSE.
          CONCATENATE lv_vgbel lv_vgpos INTO ls_part-ped_cliente SEPARATED BY '/'.
          CONCATENATE lv_vgbel lv_vgpos INTO ls_part-ped_pos SEPARATED BY '/'.
          CONCATENATE ls_vbdpl-vgbel ls_vbdpl-vgpos INTO ls_part-bar_pedido.
        ENDIF.
      ENDIF.
      " Calidad, gramaje y ancho:

      CLEAR lv_matnr.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = ls_vbdpl-matnr
        IMPORTING
          output = lv_matnr.


      SELECT SINGLE zzcalidad zzgramaje zzancho
        INTO (ls_part-zzcalidad, ls_part-zzgramaje, ls_part-zzancho)
        FROM mara
        WHERE matnr = lv_matnr.
      CONDENSE: ls_part-zzcalidad, ls_part-zzgramaje, ls_part-zzancho.

      " Kilos, metros y diámetro de sistema de clasificación:
      PERFORM cargar_carac USING ls_vbdpl-vbeln
                                 ls_vbdpl-posnr
                           CHANGING ls_part-kilos
                                    ls_part-kilos_bar
                                    ls_part-metros
                                    ls_part-metros_bar
                                    ls_part-metros_txt
                                    ls_part-diametro
                                    ls_part-diametro_txt.

*** --> INI FCC 11.12.2023 - Albarán interco cartoneras

      PERFORM cargar_valores_folding USING ls_vbdpl
                                     CHANGING ls_part-kilos
                                              ls_part-kilos_bar
                                              ls_part-metros
                                              ls_part-metros_bar
                                              ls_part-metros_txt
                                              ls_part-diametro
                                              ls_part-diametro_txt.

*** <-- FIN FCC 11.12.2023 - Albarán interco cartoneras

      " Producto y bobina (código de barras):
      IF ls_part-zzcalidad IS NOT INITIAL.
        CONCATENATE ls_part-zzcalidad+0(2) ls_part-zzgramaje+1(3) ls_part-zzancho+0(4)
                    ls_part-kilos_bar ls_part-metros_bar
                    INTO ls_part-bar_producto.
      ELSE.
        CONCATENATE '00'  ls_part-zzgramaje+1(3) ls_part-zzancho+0(4)
                    ls_part-kilos_bar ls_part-metros_bar
                    INTO ls_part-bar_producto.
      ENDIF.





      " Productor:
      CLEAR: lv_adrnr, lv_sort2.
      SELECT SINGLE adrnr INTO lv_adrnr
        FROM t001w
        WHERE werks = ls_vbdpl-werks.
      IF lv_adrnr IS NOT INITIAL.
        SELECT SINGLE sort2 INTO lv_sort2
          FROM adrc
          WHERE addrnumber = lv_adrnr.
        CONDENSE lv_sort2.
      ENDIF.
      CONCATENATE ls_vbdpl-charg lv_sort2+0(4) INTO ls_part-bar_bobina.

      APPEND ls_part TO ls_pos-part_entrega.
    ENDLOOP.

    " Textos posición:
    CLEAR ls_texto.
    CONCATENATE ls_pos-pos_entrega-vbeln ls_pos-pos_entrega-posnr
                INTO ls_texto-tdname.
    ls_texto-tdobject = 'VBBP'.
    ls_texto-tdid = '0001'.
    ls_texto-tdspras = lt_albaran-cabecera-cabecera-spras.

    CLEAR: lt_lines.
    REFRESH: lt_lines.
    CALL FUNCTION 'READ_TEXT'
      EXPORTING
*       CLIENT                  = SY-MANDT
        id                      = ls_texto-tdid
        language                = ls_texto-tdspras
        name                    = ls_texto-tdname
        object                  = ls_texto-tdobject
*       ARCHIVE_HANDLE          = 0
*       LOCAL_CAT               = ' '
*    IMPORTING
*       HEADER                  =
*       OLD_LINE_COUNTER        =
      TABLES
        lines                   = lt_lines
      EXCEPTIONS
        id                      = 1
        language                = 2
        name                    = 3
        not_found               = 4
        object                  = 5
        reference_check         = 6
        wrong_access_to_archive = 7
        OTHERS                  = 8.

    IF lt_lines[] IS NOT INITIAL.
      APPEND ls_texto TO ls_pos-pos_textos.
    ENDIF.

    CLEAR: lv_lfimg_e, lv_lfimg_d, lv_string.
    IF ls_pos-pos_total-lfimg IS NOT INITIAL.
      WRITE ls_pos-pos_total-lfimg TO ls_pos-pos_total-lfimg_txt.
      CONDENSE ls_pos-pos_total-lfimg_txt.
      SPLIT ls_pos-pos_total-lfimg_txt AT ',' INTO lv_lfimg_e lv_lfimg_d.
      CONDENSE: lv_lfimg_e, lv_lfimg_d.
      IF lv_lfimg_d <> '000'.
        WRITE ls_pos-pos_total-lfimg TO ls_pos-pos_total-lfimg_txt.
        CONDENSE ls_pos-pos_total-lfimg_txt.
      ELSE.
        CLEAR lv_string.
        CONDENSE lv_lfimg_e.
        WRITE lv_lfimg_e TO ls_pos-pos_total-lfimg_txt.
      ENDIF.
    ENDIF.

    ls_pos-pos_total-vrkme = 'KG'.

    CONCATENATE ls_pos-pos_total-lfimg_txt ls_pos-pos_total-vrkme
                INTO ls_pos-pos_total-lfimg_txt SEPARATED BY space.

    IF ls_pos IS NOT INITIAL.
      MODIFY lt_albaran-posiciones FROM ls_pos INDEX lv_index.
    ENDIF.
  ENDLOOP.

ENDFORM.                    " CARGAR_POSICIONES
*&---------------------------------------------------------------------*
*&      Form  CARGAR_CARAC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LS_VBDLP_VBELN  text
*      -->P_LS_VBDPL_POSNR  text
*      <--P_LS_PART_KILOS  text
*      <--P_LS_PART_METROS  text
*      <--P_LS_PART_DIAMETRO  text
*----------------------------------------------------------------------*
FORM cargar_carac  USING    p_vbeln
                            p_posnr
                   CHANGING p_kilos
                            p_kilos_n
                            p_metros
                            p_metros_n
                            p_metros_i
                            p_diametro
                            p_diametro_i.

  DATA: lv_medida       TYPE p DECIMALS 2,
        lv_string       TYPE string,
        lv_peso_n       TYPE n LENGTH 4,
        lv_long_n       TYPE n LENGTH 5,
        lv_medida_e(20),
        lv_medida_d(10).

  DATA: ls_conf_out TYPE leshp_pdf_conf_out_pdf.

  " Kilos:
  CLEAR ls_conf_out.
  READ TABLE gt_conf_out INTO ls_conf_out WITH KEY vbeln = p_vbeln
                                                   posnr = p_posnr
                                                   atnam = 'Z_PESO'.

  CLEAR: lv_medida_e, lv_medida_d, lv_peso_n.
  p_kilos = ls_conf_out-atwrt.
  CONDENSE p_kilos.
  SPLIT p_kilos AT ',' INTO lv_medida_e lv_medida_d.
  REPLACE '.' IN lv_medida_e WITH space.
  CONDENSE lv_medida_e.
  lv_peso_n = lv_medida_e+0(4).
  p_kilos_n = lv_peso_n.

  " Metros:
  CLEAR ls_conf_out.
  READ TABLE gt_conf_out INTO ls_conf_out WITH KEY vbeln = p_vbeln
                                                   posnr = p_posnr
                                                   atnam = 'Z_LONGITUD_B'.

  CLEAR: lv_medida_e, lv_medida_d, lv_long_n.
  p_metros = ls_conf_out-atwrt.
  CONDENSE p_metros.
  SPLIT p_metros AT ',' INTO lv_medida_e lv_medida_d.
  p_metros_i = lv_medida_e.
  REPLACE '.' IN lv_medida_e WITH space.
  CONDENSE lv_medida_e.
  lv_long_n = lv_medida_e+0(5).
  p_metros_n = lv_long_n.

  " Diámetro:
  CLEAR ls_conf_out.
  READ TABLE gt_conf_out INTO ls_conf_out WITH KEY vbeln = p_vbeln
                                                   posnr = p_posnr
                                                   atnam = 'Z_DIAMETRO'.
  CLEAR: lv_medida_e, lv_medida_d, lv_medida, lv_string.
  p_diametro = ls_conf_out-atwrt.
  CONDENSE p_diametro.
  SPLIT p_diametro AT space INTO lv_medida_e lv_medida_d.
*  IF lv_medida_d = 'cm' OR lv_medida_d = 'CM'.
*    lv_string = lv_medida_e.
*    REPLACE '.' IN lv_string WITH space.
*    REPLACE ',' IN lv_string WITH '.'.
*    lv_medida = lv_string.
*    lv_medida = lv_medida * 10.
*    WRITE lv_medida TO lv_medida_e.
*    CONDENSE lv_medida_e.
*    SPLIT lv_medida_e AT ',' INTO lv_medida_e lv_medida_d.
*    p_diametro_i = lv_medida_e.
*  ELSE.
  SPLIT lv_medida_e AT ',' INTO lv_medida_e lv_medida_d.
  p_diametro_i = lv_medida_e.
*  ENDIF.

ENDFORM.                    " CARGAR_CARAC
*&---------------------------------------------------------------------*
*&      Form  CARGAR_DAT_CENTRO
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LT_ALBARAN_CABECERA_CABECERA_V  text
*      <--P_LT_ALBARAN_CABECERA_SOCIEDAD  text
*----------------------------------------------------------------------*
FORM cargar_dat_centro  USING    p_bukrs
                                 p_vstel
                                 p_vkorg
                                 p_werks TYPE werks_d
                        CHANGING ps_sociedad TYPE zstsd_albaran_dir
                                 p_lifnr.

  DATA: lv_adrnr     TYPE adrnr,
        lv_adrnr_aux TYPE adrnr,
        ls_adrc      TYPE adrc,
        ls_adrc_aux  TYPE adrc,
        lv_kunnr     TYPE kunnr_wk,
        lv_stceg_aux TYPE stceg.

  CLEAR: ps_sociedad, ls_adrc, lv_adrnr, p_lifnr, lv_kunnr.


*  "si el albaran es de HINOJOSA-FOODSERVICE, los datos a mostrar son del centro
*  "sino, los datos a mostrar son de la sociedad
*  IF p_vkorg = '2004'. "ini cgijon - 02.02.22
*    DATA: wa_centro TYPE t001w.
*
*    SELECT SINGLE adrnr lifnr kunnr FROM t001w
*      INTO (ps_sociedad-adrnr, p_lifnr, lv_kunnr)
*      WHERE werks = p_werks.
*
*  ELSE. "fin cgijon - 02.02.22
*   GST - 17/03/2015 ->
  IF p_bukrs IS NOT INITIAL.
    SELECT SINGLE adrnr stceg INTO (ps_sociedad-adrnr, ps_sociedad-stceg)
      FROM t001
      WHERE bukrs = p_bukrs.
  ENDIF.
*   GST - 17/03/2015 <-

*   GST - 17/03/2015 ->
  IF ps_sociedad-adrnr IS INITIAL.
*     GST - 17/03/2015 <-
    SELECT SINGLE adrnr lifnr kunnr INTO (ps_sociedad-adrnr, p_lifnr, lv_kunnr)
      FROM t001w
      WHERE werks = p_vstel.
*     GST - 17/03/2015 ->
  ELSE.
    SELECT SINGLE lifnr kunnr INTO (p_lifnr, lv_kunnr)
      FROM t001w
      WHERE werks = p_vstel.
  ENDIF.
*   GST - 17/03/2015 <-
*  ENDIF. "cgijon - 02.02.22

  IF ps_sociedad-adrnr IS NOT INITIAL.

    SELECT SINGLE * INTO ls_adrc
      FROM adrc
      WHERE addrnumber = ps_sociedad-adrnr.

    IF ls_adrc IS NOT INITIAL.

      MOVE-CORRESPONDING ls_adrc TO ps_sociedad.
      TRANSLATE ps_sociedad-name1 TO UPPER CASE.
      " Dirección 1:
      CONDENSE: ps_sociedad-street, ps_sociedad-house_num1.
      IF ps_sociedad-house_num1 IS NOT INITIAL.
        CONCATENATE ps_sociedad-street ps_sociedad-house_num1
                    INTO ps_sociedad-direc_1 SEPARATED BY ', '.
      ELSE.
        WRITE ps_sociedad-street TO ps_sociedad-direc_1.
      ENDIF.
      TRANSLATE ps_sociedad-direc_1 TO UPPER CASE.
      " Dirección 2:
      CONDENSE: ps_sociedad-post_code1, ps_sociedad-city1.
      CONCATENATE ps_sociedad-post_code1 ps_sociedad-city1
                INTO ps_sociedad-direc_2 SEPARATED BY space.
      TRANSLATE ps_sociedad-direc_2 TO UPPER CASE.
      IF ps_sociedad-region IS NOT INITIAL.
        TRANSLATE ps_sociedad-city1 TO UPPER CASE.
        SELECT SINGLE bezei INTO ps_sociedad-bezei
          FROM t005u
          WHERE bland = ls_adrc-region
          AND spras = ls_adrc-langu
          AND land1 = ls_adrc-country.
        TRANSLATE ps_sociedad-bezei TO UPPER CASE.
        IF ps_sociedad-bezei IS NOT INITIAL AND ps_sociedad-bezei NE ps_sociedad-city1.
          CONCATENATE ps_sociedad-direc_2 ps_sociedad-bezei
                      INTO ps_sociedad-direc_2 SEPARATED BY ' - '.
        ENDIF.
      ENDIF.
    ENDIF.

    CLEAR: lv_adrnr_aux, ls_adrc_aux, lv_stceg_aux.
    SELECT SINGLE adrnr stceg INTO (lv_adrnr_aux, lv_stceg_aux)
      FROM kna1
      WHERE kunnr = lv_kunnr.

    IF lv_adrnr_aux IS NOT INITIAL.
      SELECT SINGLE * INTO ls_adrc_aux
        FROM adrc
        WHERE addrnumber = lv_adrnr_aux.
    ENDIF.


    " Teléfono:
    IF ps_sociedad-tel_number IS INITIAL.
      ps_sociedad-tel_number = ls_adrc_aux-tel_number.
      CONDENSE ps_sociedad-tel_number.
    ENDIF.

    " FAX:
    SELECT SINGLE fax_number INTO ps_sociedad-fax_number
      FROM adr3
      WHERE addrnumber = ps_sociedad-adrnr.

    IF ps_sociedad-fax_number IS INITIAL.
      ps_sociedad-fax_number = ls_adrc_aux-fax_number.
      CONDENSE ps_sociedad-fax_number.
    ENDIF.

    " NIF:
    IF ps_sociedad-stceg IS INITIAL.
      ps_sociedad-stceg = lv_stceg_aux.
      CONDENSE ps_sociedad-stceg.
    ENDIF.

  ENDIF.


ENDFORM.                    " CARGAR_DAT_CENTRO
*&---------------------------------------------------------------------*
*&      Form  CERTIF_FSC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LS_PART_MATWA  text
*      -->P_LS_PART_CHARG  text
*      <--P_LS_PART_CERTIF_FSC  text
*----------------------------------------------------------------------*
FORM certif_fsc  USING    p_matwa
                          p_charg
                 CHANGING p_certif_fsc.

  DATA: lt_class      TYPE /isdfps/lm_accident_sclass_t,
        lt_objectdata TYPE rihclobjdat_tab.

  DATA: lv_object     TYPE objnum,
        ls_objectdata TYPE clobjdat,
        lv_fsc        TYPE atwrt.

  CLEAR: lv_object, lt_class, lt_objectdata, ls_objectdata, lv_fsc.
  REFRESH: lt_class, lt_objectdata.

  CONCATENATE p_matwa p_charg INTO lv_object.

  " 1) Intentamos recuperar el pocentaje FSC de bobina:

  CALL FUNCTION 'CLAF_CLASSIFICATION_OF_OBJECTS'
    EXPORTING
      class              = 'Z_BOBINA'
*     CLASSTEXT          = 'X'
      classtype          = '023'
*     CLINT              = 0
*     FEATURES           = 'X'
*     LANGUAGE           = SY-LANGU
      object             = lv_object
      objecttable        = 'MCH1'
*     KEY_DATE           = SY-DATUM
*     INITIAL_CHARACT    = 'X'
*     NO_VALUE_DESCRIPT  =
*     CHANGE_SERVICE_CLF = 'X'
*     INHERITED_CHAR     = ' '
*     CHANGE_NUMBER      = ' '
    TABLES
      t_class            = lt_class
      t_objectdata       = lt_objectdata
*     I_SEL_CHARACTERISTIC       =
*     T_NO_AUTH_CHARACT  =
    EXCEPTIONS
      no_classification  = 1
      no_classtypes      = 2
      invalid_class_type = 3
      OTHERS             = 4.
*  IF sy-subrc <> 0.
** Implement suitable error handling here
*  ENDIF.

  IF lt_objectdata[] IS NOT INITIAL.
    READ TABLE lt_objectdata INTO ls_objectdata WITH KEY atnam = 'Z_FSC_PORCENTAJE'.
    IF ls_objectdata IS NOT INITIAL AND ( ls_objectdata-ausp1 IS NOT INITIAL AND ls_objectdata-ausp1 NE '?' ).
      lv_fsc = ls_objectdata-ausp1.
      CONDENSE lv_fsc.
    ENDIF.
  ENDIF.

  " 2) Intentamos recuperar el material FSC del material:
  IF lv_fsc IS INITIAL.

    CLEAR: lv_object, lt_class, lt_objectdata, ls_objectdata, lv_fsc.
    REFRESH: lt_class, lt_objectdata.

    lv_object = p_matwa.
    CONDENSE lv_object.

    CALL FUNCTION 'CLAF_CLASSIFICATION_OF_OBJECTS'
      EXPORTING
        class              = 'Z_BOBINA_FSC'
*       CLASSTEXT          = 'X'
        classtype          = '001'
*       CLINT              = 0
*       FEATURES           = 'X'
*       LANGUAGE           = SY-LANGU
        object             = lv_object
*       objecttable        = 'MCH1'
*       KEY_DATE           = SY-DATUM
*       INITIAL_CHARACT    = 'X'
*       NO_VALUE_DESCRIPT  =
*       CHANGE_SERVICE_CLF = 'X'
*       INHERITED_CHAR     = ' '
*       CHANGE_NUMBER      = ' '
      TABLES
        t_class            = lt_class
        t_objectdata       = lt_objectdata
*       I_SEL_CHARACTERISTIC       =
*       T_NO_AUTH_CHARACT  =
      EXCEPTIONS
        no_classification  = 1
        no_classtypes      = 2
        invalid_class_type = 3
        OTHERS             = 4.
*  IF sy-subrc <> 0.
** Implement suitable error handling here
*  ENDIF.

    IF lt_objectdata[] IS NOT INITIAL.
      READ TABLE lt_objectdata INTO ls_objectdata WITH KEY atnam = 'Z_FSC_TEORICO_BOBINA'.
      IF ls_objectdata IS NOT INITIAL AND ( ls_objectdata-ausp1 IS NOT INITIAL AND ls_objectdata-ausp1 NE '?' ).
        lv_fsc = ls_objectdata-ausp1.
        CONDENSE lv_fsc.
      ENDIF.
    ENDIF.

  ENDIF.

  " Creamos el texto:
* if lv_fsc is not initial.
  CONCATENATE 'Certificado SGSCH-COC-060051  FSC Recycled' lv_fsc '%'
              INTO p_certif_fsc SEPARATED BY space.
* else.
*   clear p_certif_fsc.
* endif.

ENDFORM.                    " CERTIF_FSC
*&---------------------------------------------------------------------*
*&      Form  CARGAR_TITULO
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LT_ALBARAN_CABECERA_CABECERA_V  text
*      -->P_LT_ALBARAN_CABECERA_CABECERA_S  text
*      <--P_LT_ALBARAN_CABECERA_TITULO  text
*----------------------------------------------------------------------*
FORM cargar_titulo USING p_vbtyp
                         p_spras
                         p_zzsegcal
                         p_lfart
                CHANGING p_titulo.
*                         p_titulo_doc_sm.

  CLEAR p_titulo.

  IF p_vbtyp = 'T'. " Devolución
    IF p_zzsegcal IS INITIAL.
      p_titulo = text-t01.
    ELSE.
      p_titulo = text-t03.
    ENDIF.
  ELSE. " Albarán
* SCT 18/07/2016 Para entr.traslado otro titulo.Asteriscamos para que puedan transportar
*    IF p_lfart = 'ZUL'.
*      p_titulo = text-t05.       "Albaran traslado
*      p_titulo_doc_sm = text-t06. "Doc. Salida Merc.
*    ELSE.
    IF p_zzsegcal IS INITIAL.
      p_titulo = text-t02.
    ELSE.
      p_titulo = text-t04.
    ENDIF.
*    ENDIF.
  ENDIF.

ENDFORM.                    " CARGAR_TITULO
*&---------------------------------------------------------------------*
*&      Form  CERTIF_FSC_2
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LT_ALBARAN_CABECERA_CABECERA_B  text
*      -->P_LT_ALBARAN_CABECERA_CABECERA_W  text
*      <--P_LS_PART_CERTIF_FSC  text
*----------------------------------------------------------------------*
FORM certif_fsc_2  USING    p_bukrs
                            p_wadat
                   CHANGING p_certif_fsc.

  DATA: lv_fsc         TYPE zesd_fsc,
        lv_cod_cert    TYPE zesd_cod_cert,
        lv_fsc_int     TYPE i,
        lv_fsc_char(3).

  CLEAR: p_certif_fsc, lv_fsc.
  CLEAR: lv_fsc_int, lv_fsc_char.

  CALL FUNCTION 'ZSD_PORCENTAJE_FSC'
    EXPORTING
      i_datum            = p_wadat
      i_bukrs            = p_bukrs
    IMPORTING
      o_fsc              = lv_fsc
      o_cod_cert         = lv_cod_cert "CGIJON: 15.03.17 - Ticket ## 25719
    EXCEPTIONS
      error_no_exist_fsc = 1
      OTHERS             = 2.
  IF sy-subrc <> 0.
* Implement suitable error handling here
  ELSE.
    lv_fsc_int = lv_fsc.
    IF lv_fsc_int <> 0.
      WRITE lv_fsc_int TO lv_fsc_char.
      CONDENSE lv_fsc_char.
*     INI CGIJON: 15.03.17 - Ticket ## 25719
*      CONCATENATE 'Certificado SGSCH-COC-060051  FSC Recycled'
*                  lv_fsc_char '%'
*                  INTO p_certif_fsc SEPARATED BY space.

      CONCATENATE lv_cod_cert  ' FSC Recycled'
                  lv_fsc_char '%' INTO p_certif_fsc SEPARATED BY space.
*     FIN CGIJON: 15.03.17 - Ticket ## 25719
    ELSE.
      CLEAR p_certif_fsc.
    ENDIF.

  ENDIF.

ENDFORM.                    " CERTIF_FSC_2
*&---------------------------------------------------------------------*
*&      Form  CARGAR_VALORES_FOLDING
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LS_VBDPL  text
*      <--P_LS_PART_KILOS  text
*      <--P_LS_PART_KILOS_BAR  text
*      <--P_LS_PART_METROS  text
*      <--P_LS_PART_METROS_BAR  text
*      <--P_LS_PART_METROS_TXT  text
*      <--P_LS_PART_DIAMETRO  text
*      <--P_LS_PART_DIAMETRO_TXT  text
*----------------------------------------------------------------------*
FORM cargar_valores_folding  USING    is_vbdpl TYPE vbdpl
                             CHANGING cv_kilos
                                      cv_kilos_bar
                                      cv_metros
                                      cv_metros_bar
                                      cv_metros_txt
                                      cv_diametro
                                      cv_diametro_txt.

**********************************************************************
* Parámetros locales
**********************************************************************

****** VARIABLES

  DATA: lv_medida_e(20),
        lv_medida_d(10),
        lv_bstmg TYPE bstmg,
        lv_menge TYPE menge_d,
        lv_matnr TYPE matnr.

**********************************************************************
* Validaciones
**********************************************************************

****** WERKS --> FOLDING

  CHECK is_vbdpl-werks(1) EQ '2'.

**********************************************************************
* Lógica
**********************************************************************

****** PREPARE DATA

  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
    EXPORTING
      input         = is_vbdpl-matnr
    IMPORTING
      OUTPUT        = lv_matnr.

****** FILL DATA

***** PESO

  MOVE is_vbdpl-lfimg TO cv_kilos.
  CONDENSE cv_kilos.
  SPLIT cv_kilos AT ',' INTO lv_medida_e lv_medida_d.
  REPLACE '.' IN lv_medida_e WITH space.
  CONDENSE lv_medida_e.
  cv_kilos_bar = lv_medida_e+0(4).

** METROS

  CLEAR: lv_medida_e, lv_medida_d.

  CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
    EXPORTING
      i_matnr              = lv_matnr
      i_in_me              = is_vbdpl-gewei
      i_out_me             = 'M'
      i_menge              = is_vbdpl-lfimg
    IMPORTING
      e_menge              = lv_menge
    EXCEPTIONS
      error_in_application = 1
      error                = 2
      OTHERS               = 3.

  IF ( sy-subrc EQ 0 ).

    MOVE lv_menge TO cv_metros.
    CONDENSE cv_metros.
    SPLIT cv_metros AT ',' INTO lv_medida_e lv_medida_d.
    REPLACE '.' IN lv_medida_e WITH space.
    CONDENSE lv_medida_e.
    cv_metros_bar = lv_medida_e+0(4).
    MOVE cv_metros_bar TO cv_metros_txt.


  ENDIF.

** DIAMETRO

  CLEAR: lv_medida_e, lv_medida_d.

  zcl_wm_nt_generic=>calc_diam_con_kg(
    EXPORTING
      iv_matnr          = lv_matnr          " Número de material
      iv_werks          = is_vbdpl-werks    " Centro
      iv_kg             = is_vbdpl-lfimg    " Cantidad en kilogramos
    IMPORTING
      ev_dia            = lv_bstmg    " Cantidad en diámetro (cm)
    EXCEPTIONS
      um_no_valid       = 1
      missing_constants = 2
      missing_matnr     = 3
      others            = 4
  ).
  IF ( sy-subrc EQ 0 ).

    lv_bstmg = lv_bstmg * 10. "Paso a mm
    MOVE lv_bstmg TO cv_diametro.
    CONDENSE cv_diametro.
    SPLIT cv_diametro AT '.' INTO lv_medida_e lv_medida_d.
    CONDENSE lv_medida_e.
    cv_diametro_txt = lv_medida_e.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CERTIF_FSC_FOLDING
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LS_VBDPL_VBELN  text
*      -->P_LS_VBDPL_POSNR  text
*      <--P_LS_PART_CERTIF_FSC  text
*----------------------------------------------------------------------*
FORM get_fsc_folding_4_vbeln_posnr  USING i_v_vbdpl_vbeln
                                          i_v_vbdpl_posnr
                                 CHANGING c_s_part_certif_fsc.

**********************************************************************
* Parámetros locales
**********************************************************************


  DATA: lv_object TYPE objnum,
        lv_matnr  TYPE matnr,
        lv_charg  TYPE charg_d,
        lv_lifnr  TYPE lifnr.

  DATA: lt_alloc_values_num  TYPE tt_bapi1003_alloc_values_num WITH HEADER LINE,
        lt_alloc_values_char TYPE tt_bapi1003_alloc_values_char WITH HEADER LINE,
        lt_alloc_values_curr TYPE tt_bapi1003_alloc_values_curr WITH HEADER LINE,
        lt_return            TYPE bapiret2_tab WITH HEADER LINE.

**********************************************************************
* Validaciones
**********************************************************************

  CHECK i_v_vbdpl_vbeln IS NOT INITIAL AND i_v_vbdpl_posnr IS NOT INITIAL.

**********************************************************************
* Lógica
**********************************************************************

****** PREPARE DATA

***** CLEAN IMPORT DATA

  CLEAR c_s_part_certif_fsc.

***** GET LIFNR

  SELECT SINGLE matnr charg
    FROM lips
    INTO (lv_matnr, lv_charg)
   WHERE vbeln = i_v_vbdpl_vbeln
     AND posnr = i_v_vbdpl_posnr.

  CHECK sy-subrc = 0 AND lv_matnr IS NOT INITIAL AND lv_charg IS NOT INITIAL.

  SELECT SINGLE lifnr
    FROM mch1
    INTO lv_lifnr
   WHERE matnr = lv_matnr
     AND charg = lv_charg.

  CHECK sy-subrc = 0 AND lv_lifnr IS NOT INITIAL.

****** GET FSC FOR LIFNR CHARACTERISTICS

  lv_object = lv_lifnr.

  CALL FUNCTION 'BAPI_OBJCL_GETDETAIL'
    EXPORTING
      objectkey       = lv_object
      objecttable     = 'LFA1'
      classnum        = 'CERTIFICACION_FSC'
      classtype       = '010'
    TABLES
      allocvaluesnum  = lt_alloc_values_num[]
      allocvalueschar = lt_alloc_values_char[]
      allocvaluescurr = lt_alloc_values_curr[]
      return          = lt_return.

  IF lt_alloc_values_num[] IS NOT INITIAL OR lt_alloc_values_char[] IS NOT INITIAL. " tiene certificación

    READ TABLE lt_alloc_values_char WITH KEY charact = 'CODIGO_CERTIFICADO'.
    IF sy-subrc EQ 0.
      c_s_part_certif_fsc = lt_alloc_values_char-value_char.
    ENDIF.

    READ TABLE lt_alloc_values_char WITH KEY charact = 'DECLARACION_FSC'.
    IF sy-subrc EQ 0.
      c_s_part_certif_fsc = |{ c_s_part_certif_fsc }{ lt_alloc_values_char-value_char }|.
    ENDIF.

    READ TABLE lt_alloc_values_num WITH KEY charact = 'PORCENTAJE_FSC'.
    IF sy-subrc EQ 0.
      c_s_part_certif_fsc = |{ c_s_part_certif_fsc } { lt_alloc_values_num-value_from } { '%' }|.
    ENDIF.
  ENDIF.

ENDFORM.
