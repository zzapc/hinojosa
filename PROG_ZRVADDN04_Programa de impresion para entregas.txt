*----------------------------------------------------------------------*
*              Print of a delivery note by SAPscript                   *
*----------------------------------------------------------------------*
REPORT zrvaddn04 LINE-COUNT 100.

TABLES: vbco3,                         "Communicationarea for view
        vbdkl,                         "Headerview
        vbdpl,                         "Itemview
        komser,                        "Communicationarea Serialnumbers
        conf_out,                      "Configuration data
        tvko,                          "Sales organization
        tvst,                          "Shipping points
        t001g,                         "Company codes dependend texts
        rdgprint,                      "Dangerous goods All of Data
        rdgtxtprt,                     "undepend. Texts
        komk,                          "Communicationarea for conditions
        komp,                          "Communicationarea for conditions
        komvd.                         "Communicationarea for conditions
INCLUDE rvadtabl.

* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

DATA: retcode LIKE sy-subrc.         "Returncode
DATA: xscreen(1) TYPE c.               "Output on printer or screen

DATA: BEGIN OF tvbdpl OCCURS 0.        "Internal table for items
        INCLUDE STRUCTURE vbdpl.
      DATA: END OF tvbdpl.

DATA: BEGIN OF tkomv OCCURS 50.
        INCLUDE STRUCTURE komv.
      DATA: END OF tkomv.

DATA: BEGIN OF tkomvd OCCURS 50.
        INCLUDE STRUCTURE komvd.
      DATA: END OF tkomvd.

DATA: BEGIN OF tkomcon OCCURS 50.      "...  for configuration data
        INCLUDE STRUCTURE conf_out.
      DATA: END OF tkomcon.

DATA: BEGIN OF tkomser OCCURS 5.
        INCLUDE STRUCTURE riserls.
      DATA: END   OF tkomser.

DATA: BEGIN OF tkomser_print OCCURS 5.
        INCLUDE STRUCTURE komser.
      DATA: END   OF tkomser_print.

DATA: BEGIN OF tkombat OCCURS 50.      " configuration data for batches
        INCLUDE STRUCTURE conf_out.
      DATA: END   OF tkombat.

DATA:  address_selection LIKE addr1_sel.                    "MOS

DATA: pr_kappl(01) TYPE c VALUE 'V'. "Application for pricing
DATA: print_mwskz.

DATA: price(1) TYPE c.                 "price switch

DATA: BEGIN OF rdgprint_tab OCCURS 0.
        INCLUDE STRUCTURE rdgprint.
      DATA: END   OF rdgprint_tab.

DATA: i_undep_txt   LIKE rdgtxtprt OCCURS 0 WITH HEADER LINE, "undepend Tex
      l_spras_txt   LIKE rdgtxtprt OCCURS 0 WITH HEADER LINE, "undepend Tex
      i_idname_text LIKE rdgtxtprt OCCURS 0 WITH HEADER LINE.


DATA: "gv_fp_outputparams  type  sfpoutputparams, " Output parameters
  gv_fp_docparams   TYPE        sfpdocparams,
  gv_w_cx_root      TYPE REF TO cx_root,  " Form Output
  gv_fm_name        TYPE        rs38l_fnam,      " Function Name
  gv_interface_type TYPE        fpinterfacetype, " interface name
  gv_form           TYPE        fpwbformname,    " Form name
  gv_fpformoutput   TYPE        fpformoutput,    " Form Output
  gv_mesg           TYPE        string,
  print_opts        TYPE        itcpo.

DATA : gt_vbdpl TYPE STANDARD TABLE OF vbdpl,
       gs_vbdpl TYPE                   vbdpl.

DATA : gt_komser TYPE STANDARD TABLE OF leshp_pdf_komser_pdf,
       gs_komser TYPE                   leshp_pdf_komser_pdf.

DATA : gt_rdgtxtprt TYPE STANDARD TABLE OF rdgtxtprt,
       gs_rdgtxtprt TYPE                   rdgtxtprt.

DATA : gt_conf_out TYPE STANDARD TABLE OF leshp_pdf_conf_out_pdf,
       gs_conf_out TYPE                   leshp_pdf_conf_out_pdf.

DATA : gs_shipment  TYPE vbdkl,
       gs_addr_info TYPE vbdkl,
       gs_inc_text  TYPE tvko,
       gv_repeat    TYPE char2.

DATA : gt_dg TYPE STANDARD TABLE OF rdgtxtprt,
       gs_dg TYPE                   rdgtxtprt.

CONSTANTS: gc_english TYPE char1 VALUE 'E'.

* GST - 12/11/2014 ->
DATA: lt_albaran TYPE zstsd_albaran.
* GST - 12/11/2014 <-
DATA: gv_kvgr1 TYPE vbak-kvgr1.
**************************Start of Note changes 1503297*********************************
*
*  DATA:  gv_inupd           TYPE i.
*
**External Send
*  DATA:  gv_comm_type     TYPE ad_comm,
*         gv_comm_values   TYPE szadr_comm_values,
*         gs_recipient     TYPE swotobjid,
*         gs_sender        TYPE swotobjid,
*         gs_intnast       TYPE snast,
*         gv_xdevice(10),
*         gv_xprogramm     TYPE tdprogram,
*         gv_xdialog.
*
** sending output vai mail
*DATA:  gv_pdf_content        TYPE solix_tab.
*
**************************End of Note changes 1503297*********************************


* - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
*-----------------------------------------------------------------------
*
*-----------------------------------------------------------------------

FORM entry USING return_code us_screen.

  CLEAR retcode.
  CLEAR price.
  xscreen = us_screen.
  PERFORM processing USING us_screen.
  IF retcode NE 0.
    return_code = 1.
  ELSE.
    return_code = 0.
  ENDIF.

ENDFORM.                    "ENTRY


*&---------------------------------------------------------------------*
*&      Form  get_pdf_ofertas
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->RETURN_CODE  text
*      -->US_SCREEN    text
*----------------------------------------------------------------------*
FORM get_pdf_ofertas USING tp_vbeln TYPE wtysc_vbeln_tab
                           vp_return_code
                     CHANGING vp_pdf TYPE xstring.

*  CLEAR: nast, tnapr.
  CLEAR retcode.
  CLEAR price.
  CLEAR gv_fp_outputparams.
  CLEAR gv_comm_type.
  CLEAR gv_comm_values.
  CLEAR xscreen.

  nast-kappl  = 'V1'.
  nast-kschl  = 'ZAN1'.
  nast-spras  = sy-langu.
  nast-nacha  = '1'.
  nast-ldest  = 'PDF'.

  SELECT SINGLE *
    INTO CORRESPONDING FIELDS OF tnapr
    FROM tnapr
    WHERE kschl = nast-kschl AND
          nacha = nast-nacha AND
          kappl = nast-kappl.

  CALL FUNCTION 'NAST_PROTOCOL_INITIALIZE'.

  PERFORM processing_pdf_ofertas USING tp_vbeln CHANGING vp_pdf.

  IF retcode NE 0.
    vp_return_code = 1.
  ELSE.
    vp_return_code = 0.
  ENDIF.

ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  ENTRY_PDF
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->RETURN_CODE  text
*      -->US_SCREEN    text
*----------------------------------------------------------------------*
FORM entry_pdf USING return_code us_screen.
  CLEAR retcode.
  CLEAR price.
  CLEAR gv_fp_outputparams.                                 "n_1782166
  CLEAR gv_comm_type.                                       "n_1787700
  CLEAR gv_comm_values.                                     "n_1787700
  xscreen = us_screen.
  PERFORM processing_pdf USING us_screen.
  IF retcode NE 0.
    return_code = 1.
  ELSE.
    return_code = 0.
  ENDIF.

ENDFORM.                    "ENTRY_PDF


*&---------------------------------------------------------------------*
*&      Form  ENTRY_PRICE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->RETURN_CODE  text
*      -->US_SCREEN    text
*----------------------------------------------------------------------*
FORM entry_price USING return_code us_screen.

  CLEAR retcode.
  price = 'X'.
  xscreen = us_screen.
  PERFORM processing USING us_screen.
  IF retcode NE 0.
    return_code = 1.
  ELSE.
    return_code = 0.
  ENDIF.

ENDFORM.                    "ENTRY_PRICE

*---------------------------------------------------------------------*
*       FORM PROCESSING                                               *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
*  -->  PROC_SCREEN                                                   *
*---------------------------------------------------------------------*
FORM processing USING proc_screen.

  PERFORM get_data.
  CHECK retcode = 0.
  PERFORM form_open USING proc_screen vbdkl-land1.
  CHECK retcode = 0.
  PERFORM check_repeat.
  PERFORM header_data_print.
  CHECK retcode = 0.
  PERFORM header_text_print.
  CHECK retcode = 0.
  PERFORM item_print.
  CHECK retcode = 0.
  PERFORM end_print.
  CHECK retcode = 0.
  PERFORM form_close.
  CHECK retcode = 0.

ENDFORM.                    "PROCESSING


*&---------------------------------------------------------------------*
*&      Form  PROCESSING_PDF
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->PROC_SCREEN  text
*----------------------------------------------------------------------*
FORM processing_pdf USING proc_screen.
  PERFORM get_data_pdf.
  CHECK retcode = 0.
  PERFORM form_open_pdf USING proc_screen vbdkl-land1.
  CHECK retcode = 0.
  PERFORM check_repeat_pdf.
  CHECK retcode = 0.
  PERFORM item_print_pdf.
  PERFORM dg_print_undep_text_pdf.
  PERFORM write_pdf.
  PERFORM form_close_pdf.
  CHECK retcode = 0.
ENDFORM.                    "PROCESSING_PDF



*&---------------------------------------------------------------------*
*&      Form  PROCESSING_PDF_OFERTAS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->PROC_SCREEN  text
*----------------------------------------------------------------------*
FORM processing_pdf_ofertas USING tp_vbeln TYPE wtysc_vbeln_tab
                            CHANGING vp_pdf TYPE xstring.


  PERFORM form_open_pdf_ofertas USING vbdkl-land1.
  CHECK retcode = 0.
*  PERFORM check_repeat_pdf.
*  CHECK retcode = 0.

  LOOP AT tp_vbeln ASSIGNING FIELD-SYMBOL(<fs_vbeln>).
    nast-objky = <fs_vbeln>.

    PERFORM get_data_pdf.
    CHECK retcode = 0.

    PERFORM item_print_pdf.
    PERFORM dg_print_undep_text_pdf.


    PERFORM write_pdf.
  ENDLOOP.

  PERFORM form_close_pdf.
  CHECK retcode = 0.

  "Recogemos los documentos y los unimos
  DATA: tl_pdf_table TYPE tfpcontent,
        vl_rc        TYPE i VALUE 0.

  DATA(rl_pdf_merger) = NEW cl_rspo_pdf_merge( ).


  CALL FUNCTION 'FP_GET_PDF_TABLE'
    IMPORTING
      e_pdf_table = tl_pdf_table.

  LOOP AT tl_pdf_table ASSIGNING FIELD-SYMBOL(<fs_form>).
    rl_pdf_merger->add_document( <fs_form> ).
  ENDLOOP.

  rl_pdf_merger->merge_documents( IMPORTING merged_document = vp_pdf
                                            rc              = vl_rc ).


ENDFORM.                    "PROCESSING_PDF

***********************************************************************
*       S U B R O U T I N E S                                         *
***********************************************************************

*---------------------------------------------------------------------*
*       FORM CHECK_REPEAT                                             *
*---------------------------------------------------------------------*
*       A text is printed, if it is a repeat print for the document.  *
*---------------------------------------------------------------------*

FORM check_repeat.

  SELECT * INTO *nast FROM nast WHERE kappl = nast-kappl
                                AND   objky = nast-objky
                                AND   kschl = nast-kschl
                                AND   spras = nast-spras
                                AND   parnr = nast-parnr
                                AND   parvw = nast-parvw
                                AND   nacha BETWEEN '1' AND '4'
                                AND   vstat = '1'.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'REPEAT'
        window  = 'REPEAT'
      EXCEPTIONS
        element = 1
        window  = 2.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
    EXIT.
  ENDSELECT.

ENDFORM.                    "CHECK_REPEAT

*---------------------------------------------------------------------*
*       FORM END_PRINT                                                *
*---------------------------------------------------------------------*
*                                                                     *
*---------------------------------------------------------------------*

FORM check_repeat_pdf.

  SELECT * INTO *nast FROM nast WHERE kappl = nast-kappl
                                AND   objky = nast-objky
                                AND   kschl = nast-kschl
                                AND   spras = nast-spras
                                AND   parnr = nast-parnr
                                AND   parvw = nast-parvw
                                AND   nacha BETWEEN '1' AND '4'
                                AND   vstat = '1'.
    gv_repeat = 1.

    EXIT.
  ENDSELECT.

ENDFORM.                    "CHECK_REPEAT_PDF


*&---------------------------------------------------------------------*
*&      Form  END_PRINT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM end_print.

  IF price = 'X'.
    PERFORM get_header_prices.
    CALL FUNCTION 'CONTROL_FORM'
      EXPORTING
        command = 'PROTECT'.
    PERFORM header_price_print.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'END_VALUES'
      EXCEPTIONS
        OTHERS  = 1.
    CALL FUNCTION 'CONTROL_FORM'
      EXPORTING
        command = 'ENDPROTECT'.
  ENDIF.

  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'SUPPLEMENT_TEXT'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

* print standard texts for dangerous goods
  PERFORM dg_print_undep_text.

ENDFORM.                    "END_PRINT

*---------------------------------------------------------------------*
*       FORM FORM_CLOSE                                               *
*---------------------------------------------------------------------*
*       End of printing the form                                      *
*---------------------------------------------------------------------*

FORM form_close.

  DATA:
    lt_otfdata TYPE TABLE OF itcoo.

  IF cl_ops_switch_check=>sd_sfws_sc3( ) EQ abap_true AND
     xscreen                             EQ 'W'.
    CALL FUNCTION 'CLOSE_FORM'
      TABLES
        otfdata = lt_otfdata
      EXCEPTIONS
        OTHERS  = 1.
    IF sy-subrc IS INITIAL.
      PERFORM convert_otf_to_pdf
              TABLES lt_otfdata.
    ENDIF.
  ELSE.
    CALL FUNCTION 'CLOSE_FORM'           "...Ende Formulardruck
      EXCEPTIONS
        OTHERS = 1.
  ENDIF.
  IF sy-subrc NE 0.
    retcode = 1.
    PERFORM protocol_update.
  ENDIF.
  SET COUNTRY space.

ENDFORM.                    "FORM_CLOSE


*---------------------------------------------------------------------*
*       FORM FORM_OPEN                                                *
*---------------------------------------------------------------------*
*       Start of printing the form                                    *
*---------------------------------------------------------------------*
*  -->  US_SCREEN  Output on screen                                   *
*                  ' ' = printer                                      *
*                  'X' = screen                                       *
*  -->  US_COUNTRY County for telecommunication and SET COUNTRY       *
*---------------------------------------------------------------------*

FORM form_open USING us_screen us_country.

  INCLUDE rvadopfo.

ENDFORM.                    "FORM_OPEN

*---------------------------------------------------------------------*
*       FORM GET_DATA                                                 *
*---------------------------------------------------------------------*
*       General provision of data for the form                        *
*---------------------------------------------------------------------*

FORM get_data.

  CALL FUNCTION 'RV_PRICE_PRINT_REFRESH'
    TABLES
      tkomv = tkomv.
  CLEAR komk.
  CLEAR komp.


  vbco3-spras = nast-spras.
  vbco3-vbeln = nast-objky.
  vbco3-kunde = nast-parnr.
  vbco3-parvw = nast-parvw.

  CALL FUNCTION 'RV_DELIVERY_PRINT_VIEW'
    EXPORTING
      comwa = vbco3
    IMPORTING
      kopf  = vbdkl
    TABLES
      pos   = tvbdpl.

* Inicio mod. 19.04.17 JJR
  IF nast-parvw = '§§'.
    SELECT SINGLE adr6~addrnumber adr6~persnumber
       INTO (addr_key-addrnumber, addr_key-persnumber)
     FROM usr21 JOIN adr6 ON usr21~persnumber = adr6~persnumber
                         AND usr21~addrnumber = adr6~addrnumber
     WHERE usr21~bname = nast-parnr.

    addr_key-addr_type  = 2.
  ELSE.
* Fin modificacion 19.04.17
* fill address key --> necessary for emails
    addr_key-addrnumber = vbdkl-adrnr.
    addr_key-persnumber = vbdkl-adrnp.
    addr_key-addr_type  = vbdkl-address_type.
  ENDIF.

* Data selection for dangerous goods
  PERFORM dg_data_select USING vbdkl.
  PERFORM sender.

ENDFORM.                    "GET_DATA




*&---------------------------------------------------------------------*
*&      Form  GET_DATA_PDF
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM get_data_pdf.

  CALL FUNCTION 'RV_PRICE_PRINT_REFRESH'
    TABLES
      tkomv = tkomv.
  CLEAR komk.
  CLEAR komp.

  vbco3-spras = nast-spras.
  vbco3-vbeln = nast-objky.
  vbco3-kunde = nast-parnr.
  vbco3-parvw = nast-parvw.

  CALL FUNCTION 'RV_DELIVERY_PRINT_VIEW'
    EXPORTING
      comwa = vbco3
    IMPORTING
      kopf  = vbdkl
    TABLES
      pos   = tvbdpl.


  MOVE-CORRESPONDING vbdkl TO gs_shipment.

  LOOP AT tvbdpl.
    MOVE tvbdpl TO gs_vbdpl.
    CALL FUNCTION 'CONVERSION_EXIT_MATN1_OUTPUT'
      EXPORTING
        input  = gs_vbdpl-matnr
      IMPORTING
        output = gs_vbdpl-matnr.

    APPEND gs_vbdpl TO gt_vbdpl.
*    SORT gt_vbdpl by posnr uepos.
    CLEAR gs_vbdpl.
  ENDLOOP.

* Inicio mod. 19.04.17 JJR
  IF nast-parvw = '§§'.

    SELECT SINGLE adr6~addrnumber adr6~persnumber
       INTO (addr_key-addrnumber, addr_key-persnumber)
     FROM usr21 JOIN adr6 ON usr21~persnumber = adr6~persnumber
                         AND usr21~addrnumber = adr6~addrnumber
     WHERE usr21~bname = nast-parnr.

    addr_key-addr_type  = 2.
  ELSE.
* Fin modificacion 19.04.17
* fill address key --> necessary for emails
    addr_key-addrnumber = vbdkl-adrnr.
    addr_key-persnumber = vbdkl-adrnp.
    addr_key-addr_type  = vbdkl-address_type.
  ENDIF.

* Data selection for dangerous goods
  PERFORM dg_data_select USING vbdkl.
  PERFORM sender.

  MOVE-CORRESPONDING tvko TO gs_inc_text.                   "n_1632626

ENDFORM.                    "GET_DATA_PDF


*---------------------------------------------------------------------*
*       FORM GET_HEADER_PRICES                                        *
*---------------------------------------------------------------------*
*       In this routine the price data for the header is fetched from *
*       the database.                                                 *
*---------------------------------------------------------------------*

FORM get_header_prices.

  CALL FUNCTION 'RV_PRICE_PRINT_HEAD'
    EXPORTING
      comm_head_i = komk
      language    = nast-spras
    IMPORTING
      comm_head_e = komk
      comm_mwskz  = print_mwskz
    TABLES
      tkomv       = tkomv
      tkomvd      = tkomvd.

ENDFORM.                    "GET_HEADER_PRICES

*---------------------------------------------------------------------*
*       FORM GET_ITEM_CHARACTERISTICS                                 *
*---------------------------------------------------------------------*
*       In this routine the configuration data item is fetched from   *
*       the database.                                                 *
*---------------------------------------------------------------------*

FORM get_item_characteristics.

  DATA da_t_cabn LIKE cabn OCCURS 10 WITH HEADER LINE.
  DATA: BEGIN OF da_key,
          mandt LIKE cabn-mandt,
          atinn LIKE cabn-atinn,
        END   OF da_key.

  REFRESH tkomcon.
  CHECK NOT vbdpl-cuobj IS INITIAL.

  CALL FUNCTION 'VC_I_GET_CONFIGURATION'
    EXPORTING
      instance      = vbdpl-cuobj
      language      = nast-spras
      print_sales   = 'X'
    TABLES
      configuration = tkomcon
    EXCEPTIONS
      OTHERS        = 4.

  RANGES : da_in_cabn FOR da_t_cabn-atinn.
  CLEAR da_in_cabn. REFRESH da_in_cabn.
  LOOP AT tkomcon.
    da_in_cabn-option = 'EQ'.
    da_in_cabn-sign   = 'I'.
    da_in_cabn-low    = tkomcon-atinn.
    APPEND da_in_cabn.
  ENDLOOP.

  CLEAR da_t_cabn. REFRESH da_t_cabn.
  CALL FUNCTION 'CLSE_SELECT_CABN'
    TABLES
      in_cabn        = da_in_cabn
      t_cabn         = da_t_cabn
    EXCEPTIONS
      no_entry_found = 1
      OTHERS         = 2.

* Preisfindungsmerkmale / Merkmale auf VCSD_UPDATE herausnehmen
  SORT da_t_cabn.
  LOOP AT tkomcon.
    da_key-mandt = sy-mandt.
    da_key-atinn = tkomcon-atinn.
    READ TABLE da_t_cabn WITH KEY da_key BINARY SEARCH.
    IF sy-subrc <> 0 OR
         ( ( da_t_cabn-attab = 'SDCOM' AND
            da_t_cabn-atfel = 'VKOND'       ) OR
          ( da_t_cabn-attab = 'VCSD_UPDATE' ) ) .
      DELETE tkomcon.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "GET_ITEM_CHARACTERISTICS

*---------------------------------------------------------------------*
*       FORM GET_ITEM_CHARACTERISTICS_BATCH                           *
*---------------------------------------------------------------------*
*       In this routine the configuration data for batches is fetched *
*       from the database                                             *
*---------------------------------------------------------------------*

FORM get_item_characteristics_batch.

  REFRESH tkombat.
  CHECK NOT vbdpl-charg IS INITIAL.

  CALL FUNCTION 'VB_BATCH_VALUES_FOR_OUTPUT'
    EXPORTING
      material       = vbdpl-matnr
      plant          = vbdpl-werks
      batch          = vbdpl-charg
      language       = nast-spras
    TABLES
      classification = tkombat
    EXCEPTIONS
      OTHERS         = 4.

  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "GET_ITEM_CHARACTERISTICS_BATCH

*---------------------------------------------------------------------*
*       FORM GET_ITEM_PRICES                                          *
*---------------------------------------------------------------------*
*       In this routine the price data for the item is fetched from   *
*       the database.                                                 *
*---------------------------------------------------------------------*

FORM get_item_prices.

  CLEAR: komp,
         tkomv.

  IF komk-knumv NE vbdkl-knump.
    CLEAR komk.
    komk-mandt = sy-mandt.
    komk-kalsm = vbdkl-kalsp.
    komk-kappl = pr_kappl.
    komk-waerk = vbdkl-waerk.
    komk-knumv = vbdkl-knump.
    komk-vbtyp = vbdkl-vbtyp.
  ENDIF.
  komp-kposn = vbdpl-posnr.

  CALL FUNCTION 'RV_PRICE_PRINT_ITEM'
    EXPORTING
      comm_head_i = komk
      comm_item_i = komp
      language    = nast-spras
    IMPORTING
      comm_head_e = komk
      comm_item_e = komp
    TABLES
      tkomv       = tkomv
      tkomvd      = tkomvd.

ENDFORM.                    "GET_ITEM_PRICES

*---------------------------------------------------------------------*
*       FORM GET_SERIAL_NO                                            *
*---------------------------------------------------------------------*
*       In this routine the serialnumbers are fetched from the        *
*       database.                                                     *
*---------------------------------------------------------------------*

FORM get_serial_no.

  REFRESH tkomser.
  REFRESH tkomser_print.
  CHECK vbdpl-anzsn > 0.
* Read the Serialnumbers of a Position.
  CALL FUNCTION 'SERIAL_LS_PRINT'
    EXPORTING
      vbeln  = vbdkl-vbeln
      posnr  = vbdpl-posnr
    TABLES
      iserls = tkomser.

* Process the stringtable for Printing.
  CALL FUNCTION 'PROCESS_SERIALS_FOR_PRINT'
    EXPORTING
      i_boundary_left             = '(_'
      i_boundary_right            = '_)'
      i_sep_char_strings          = ',_'
      i_sep_char_interval         = '_-_'
      i_use_interval              = 'X'
      i_boundary_method           = 'C'
      i_line_length               = 50
      i_no_zero                   = 'X'
      i_alphabet                  = sy-abcde
      i_digits                    = '0123456789'
      i_special_chars             = '-'
      i_with_second_digit         = ' '
    TABLES
      serials                     = tkomser
      serials_print               = tkomser_print
    EXCEPTIONS
      boundary_missing            = 01
      interval_separation_missing = 02
      length_to_small             = 03
      internal_error              = 04
      wrong_method                = 05
      wrong_serial                = 06
      two_equal_serials           = 07
      serial_with_wrong_char      = 08
      serial_separation_missing   = 09.

  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "GET_SERIAL_NO

*&---------------------------------------------------------------------*
*&      Form  HEADER_DATA_PRINT
*&---------------------------------------------------------------------*
*       Printing of the header data like terms, weights                *
*----------------------------------------------------------------------*

FORM header_data_print.

  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'HEADER_DATA'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                               " HEADER_DATA_PRINT

*---------------------------------------------------------------------*
*       FORM HEADER_PRICE_PRINT                                       *
*---------------------------------------------------------------------*
*       Printout of the header prices                                 *
*---------------------------------------------------------------------*

FORM header_price_print.

  LOOP AT tkomvd.

    AT FIRST.
      IF komk-supos NE 0.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'ITEM_SUM'
          EXCEPTIONS
            element = 1
            window  = 2.
      ELSE.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'UNDER_LINE'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ENDIF.
    ENDAT.

    komvd = tkomvd.
    IF print_mwskz = space.
      CLEAR komvd-mwskz.
    ENDIF.

    IF komvd-koaid = 'D'.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'TAX_LINE'
        EXCEPTIONS
          element = 1
          window  = 2.
    ELSE.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'SUM_LINE'
        EXCEPTIONS
          element = 1
          window  = 2.
    ENDIF.
  ENDLOOP.
  DESCRIBE TABLE tkomvd LINES sy-tfill.
  IF sy-tfill = 0.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        element = 'UNDER_LINE'
      EXCEPTIONS
        element = 1
        window  = 2.
    IF sy-subrc NE 0.
      PERFORM protocol_update.
    ENDIF.
  ENDIF.

ENDFORM.                    "HEADER_PRICE_PRINT

*---------------------------------------------------------------------*
*       FORM HEADER_TEXT_PRINT                                        *
*---------------------------------------------------------------------*
*       Printout of the headertexts                                   *
*---------------------------------------------------------------------*

FORM header_text_print.

  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'HEADER_TEXT'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "HEADER_TEXT_PRINT

*---------------------------------------------------------------------*
*       FORM ITEM_PRINT                                               *
*---------------------------------------------------------------------*
*       Printout of the items                                         *
*---------------------------------------------------------------------*

FORM item_print.

* <<< START_OF_INSERTION_HP_327026 >>>
  DATA: lf_init_characteristics_done TYPE xfeld.
* <<< END_OF_INSERTION_HP_327026 >>>
  CALL FUNCTION 'WRITE_FORM'           "First header
    EXPORTING
      element = 'ITEM_HEADER'
    EXCEPTIONS
      OTHERS  = 1.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.
  CALL FUNCTION 'WRITE_FORM'          "Activate header
    EXPORTING
      element = 'ITEM_HEADER'
      type    = 'TOP'
    EXCEPTIONS
      OTHERS  = 1.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

  LOOP AT tvbdpl.
    vbdpl = tvbdpl.
* <<< START_OF_INSERTION_HP_327026 >>>
    IF ( lf_init_characteristics_done IS INITIAL ) AND
       ( ( NOT vbdpl-charg IS INITIAL ) OR
         ( NOT vbdpl-cuobj IS INITIAL ) ).
      CALL FUNCTION 'CTMS_DDB_INIT'.
      lf_init_characteristics_done = 'X'.
    ENDIF.
* <<< END_OF_INSERTION_HP_327026 >>>
    IF vbdpl-uecha IS INITIAL.
* <<< START_OF_INSERTION_HP_377469 >>>
      PERFORM item_print_oi.
* <<< END_OF_INSERTION_HP_377469 >>>
      CALL FUNCTION 'CONTROL_FORM'
        EXPORTING
          command = 'PROTECT'.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE'.
      CALL FUNCTION 'CONTROL_FORM'
        EXPORTING
          command = 'ENDPROTECT'.
* Seitenumbruch, wenn Positionstexte nicht auf eine Seite passen.
      CALL FUNCTION 'CONTROL_FORM'
        EXPORTING
          command = 'PROTECT'.
      PERFORM item_text_print.
      PERFORM dg_print_data_get.
      PERFORM dg_data_print.
      IF price = 'X'.
        PERFORM get_item_prices.
        PERFORM item_price_print.
      ENDIF.
      PERFORM get_serial_no.
      PERFORM item_serial_no_print.
      PERFORM get_item_characteristics.
      PERFORM item_characteristics_print.
      PERFORM get_item_characteristics_batch.
      PERFORM item_characteristics_batch.
      IF vbdpl-vbeln_vauf NE space AND
         vbdpl-vbeln_vauf NE vbdkl-vbeln_vauf.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'ITEM_REFERENCE'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ENDIF.
      IF vbdpl-qmnum NE space AND
         vbdpl-qmnum NE vbdkl-qmnum.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            element = 'ITEM_QNUMBER'
          EXCEPTIONS
            element = 1
            window  = 2.
        IF sy-subrc NE 0.
          PERFORM protocol_update.
        ENDIF.
      ENDIF.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_PURCHASE_DATA'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
      CALL FUNCTION 'CONTROL_FORM'
        EXPORTING
          command = 'ENDPROTECT'.
    ELSE.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_BATCH'
        EXCEPTIONS                                          "v_n_709399
          element = 1
          window  = 2.                                      "^_n_709399

      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
      IF price = 'X'.                                       "v_n_577292
        PERFORM get_item_prices.
        PERFORM item_price_print.
      ENDIF.                                                "^_n_577292
      PERFORM get_serial_no.
      PERFORM item_serial_no_print.
      PERFORM get_item_characteristics_batch.
      PERFORM item_characteristics_batch.
    ENDIF.
  ENDLOOP.

  CALL FUNCTION 'WRITE_FORM'          "Deactivate Header
    EXPORTING
      element  = 'ITEM_HEADER'
      function = 'DELETE'
      type     = 'TOP'
    EXCEPTIONS
      OTHERS   = 1.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "ITEM_PRINT


*&---------------------------------------------------------------------*
*&      Form  ITEM_PRINT_PDF
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM item_print_pdf.

* <<< START_OF_INSERTION_HP_327026 >>>
  DATA: lf_init_characteristics_done TYPE xfeld.
* <<< END_OF_INSERTION_HP_327026 >>>

*  Move Data
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

  LOOP AT tvbdpl.
    vbdpl = tvbdpl.
* <<< START_OF_INSERTION_HP_327026 >>>
    IF ( lf_init_characteristics_done IS INITIAL ) AND
       ( ( NOT vbdpl-charg IS INITIAL ) OR
         ( NOT vbdpl-cuobj IS INITIAL ) ).
      CALL FUNCTION 'CTMS_DDB_INIT'.
      lf_init_characteristics_done = 'X'.
    ENDIF.
* <<< END_OF_INSERTION_HP_327026 >>>
    IF vbdpl-uecha IS INITIAL.
* <<< START_OF_INSERTION_HP_377469 >>>
      PERFORM item_print_oi.
* <<< END_OF_INSERTION_HP_377469 >>>

* Seitenumbruch, wenn Positionstexte nicht auf eine Seite passen.


      PERFORM dg_print_data_get_pdf.
      PERFORM dg_data_print_pdf.
      PERFORM get_serial_no.
      PERFORM item_serial_no_print_pdf.
      PERFORM get_item_characteristics.
      PERFORM item_characteristics_print_pdf.
      PERFORM get_item_characteristics_batch.
      PERFORM item_characteristics_batch_pdf.
    ELSE.
      PERFORM get_serial_no.
      PERFORM item_serial_no_print_pdf.
      PERFORM get_item_characteristics_batch.
      PERFORM item_characteristics_batch_pdf.

    ENDIF.
  ENDLOOP.
ENDFORM.                    "ITEM_PRINT_PDF


*---------------------------------------------------------------------*
*       FORM ITEM_CHARACERISTICS_BATCH                                *
*---------------------------------------------------------------------*
*       Printout of the item characteristics for batches              *
*---------------------------------------------------------------------*

FORM item_characteristics_batch.

  LOOP AT tkombat.
    conf_out = tkombat.
    IF sy-tabix = 1.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_CONFIGURATION_BATCH_HEADER'
        EXCEPTIONS
          OTHERS  = 1.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ELSE.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_CONFIGURATION_BATCH'
        EXCEPTIONS
          OTHERS  = 1.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "ITEM_CHARACTERISTICS_BATCH

*---------------------------------------------------------------------*
*       FORM ITEM_CHARACERISTICS_PRINT                                *
*---------------------------------------------------------------------*
*       Printout of the item characteristics -> configuration         *
*---------------------------------------------------------------------*

FORM item_characteristics_batch_pdf.

  LOOP AT tkombat.
    conf_out = tkombat.
    MOVE-CORRESPONDING conf_out TO gs_conf_out.
    MOVE-CORRESPONDING tvbdpl   TO gs_conf_out.
    gs_conf_out-flag = 'B'.
    APPEND gs_conf_out          TO gt_conf_out.
    CLEAR gs_conf_out.
  ENDLOOP.

ENDFORM.                    "ITEM_CHARACTERISTICS_


*&---------------------------------------------------------------------*
*&      Form  ITEM_CHARACTERISTICS_PRINT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM item_characteristics_print.

  LOOP AT tkomcon.
    conf_out = tkomcon.
    IF sy-tabix = 1.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_CONFIGURATION_HEADER'
        EXCEPTIONS
          OTHERS  = 1.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ELSE.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_CONFIGURATION'
        EXCEPTIONS
          OTHERS  = 1.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "ITEM_CHARACTERISTICS_PRINT


*&---------------------------------------------------------------------*
*&      Form  ITEM_CHARACTERISTICS_PRINT_PDF
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM item_characteristics_print_pdf.

  LOOP AT tkomcon.
    conf_out = tkomcon.
    MOVE: conf_out-atbez TO gs_conf_out-atbez,
          conf_out-atwtb TO gs_conf_out-atwtb,
          tvbdpl-vbeln   TO gs_conf_out-vbeln,
          tvbdpl-posnr   TO gs_conf_out-posnr.
    gs_conf_out-flag = 'C'.

    APPEND gs_conf_out TO gt_conf_out.
    CLEAR gs_conf_out.
  ENDLOOP.

ENDFORM.                    "ITEM_CHARACTERISTICS_PRINT_PDF


*---------------------------------------------------------------------*
*       FORM ITEM_PRICE_PRINT                                         *
*---------------------------------------------------------------------*
*       Printout of the item prices                                   *
*---------------------------------------------------------------------*

FORM item_price_print.

  LOOP AT tkomvd.
    komvd = tkomvd.
    IF print_mwskz = space.
      CLEAR komvd-mwskz.
    ENDIF.
    IF sy-tabix = 1.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_PRICE_QUANTITY'
        EXCEPTIONS
          element = 1
          window  = 2.
    ELSE.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_PRICE_TEXT'
        EXCEPTIONS
          element = 1
          window  = 2.
    ENDIF.
  ENDLOOP.

ENDFORM.                    "ITEM_PRICE_PRINT

*---------------------------------------------------------------------*
*       FORM ITEM_SERIAL_NO_PRINT                                     *
*---------------------------------------------------------------------*
*       Printout of the item serialnumbers                            *
*---------------------------------------------------------------------*

FORM item_serial_no_print.

  LOOP AT tkomser_print.
    komser = tkomser_print.
    IF sy-tabix = 1.
*     Output of the Headerline
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_SERIAL_NO_HEADER'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ELSE.
*     Output of the following printlines
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          element = 'ITEM_LINE_SERIAL_NO'
        EXCEPTIONS
          element = 1
          window  = 2.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ENDIF.
    AT LAST.
      CALL FUNCTION 'CONTROL_FORM'
        EXPORTING
          command = 'NEW-LINE'.
      IF sy-subrc NE 0.
        PERFORM protocol_update.
      ENDIF.
    ENDAT.
  ENDLOOP.

ENDFORM.                    "ITEM_SERIAL_NO_PRINT


*&---------------------------------------------------------------------*
*&      Form  ITEM_SERIAL_NO_PRINT_PDF
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM item_serial_no_print_pdf.

  LOOP AT tkomser_print.
    komser = tkomser_print.
    MOVE-CORRESPONDING komser TO gs_komser.
    MOVE-CORRESPONDING tvbdpl TO gs_komser.
    APPEND gs_komser TO gt_komser.
    CLEAR gs_komser.
  ENDLOOP.

ENDFORM.                    "ITEM_SERIAL_NO_PRINT_PDF


*---------------------------------------------------------------------*
*       FORM PROTOCOL_UPDATE                                          *
*---------------------------------------------------------------------*
*       The messages are collected for the processing protocol.       *
*---------------------------------------------------------------------*

FORM protocol_update.

  CHECK xscreen = space.
  CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
    EXPORTING
      msg_arbgb = syst-msgid
      msg_nr    = syst-msgno
      msg_ty    = syst-msgty
      msg_v1    = syst-msgv1
      msg_v2    = syst-msgv2
      msg_v3    = syst-msgv3
      msg_v4    = syst-msgv4
    EXCEPTIONS
      OTHERS    = 1.

ENDFORM.                    "PROTOCOL_UPDATE

*---------------------------------------------------------------------*
*       FORM SENDER                                                   *
*---------------------------------------------------------------------*
*       This routine determines the address of the sender             *
*---------------------------------------------------------------------*

FORM sender.

  SELECT SINGLE * FROM tvko  WHERE vkorg = vbdkl-vkorg.
  IF sy-subrc NE 0.
    syst-msgid = 'VN'.
    syst-msgno = '203'.
    syst-msgty = 'W'.
    syst-msgv1 = 'TVKO'.
    syst-msgv2 = syst-subrc.
    PERFORM protocol_update.
  ENDIF.
  SELECT SINGLE * FROM tvst  WHERE vstel = vbdkl-vstel.
  IF sy-subrc NE 0.
    syst-msgid = 'VN'.
    syst-msgno = '203'.
    syst-msgty = 'W'.
    syst-msgv1 = 'TVST'.
    syst-msgv2 = syst-subrc.
    PERFORM protocol_update.
  ENDIF.
  SELECT SINGLE * FROM t001g WHERE bukrs    = vbdkl-bukrs
                             AND   programm = 'RVADDN01'
                             AND   txtid    = space.
  IF sy-subrc NE 0.
    syst-msgid = 'VN'.
    syst-msgno = '203'.
    syst-msgty = 'W'.
    syst-msgv1 = 'T001G'.
    syst-msgv2 = syst-subrc.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    "SENDER
*&---------------------------------------------------------------------*
*&      Form  ITEM_TEXT_PRINT
*&---------------------------------------------------------------------*
FORM item_text_print.

  CALL FUNCTION 'WRITE_FORM'
    EXPORTING
      element = 'ITEM_TEXT'
    EXCEPTIONS
      element = 1
      window  = 2.
  IF sy-subrc NE 0.
    PERFORM protocol_update.
  ENDIF.

ENDFORM.                    " ITEM_TEXT_PRINT

* <<< START_OF_INSERTION_HP_377469 >>>
INCLUDE rvaddn01_dg.

INCLUDE rvaddn01_oi.
* <<< END_OF_INSERTION_HP_377469 >>>

INCLUDE rvaddn01_dg_pdf.                                    "#EC
***** End of PDF Changes by C5065471 *****

* <<< END_OF_INSERTION_HP_377469 >>>


FORM write_pdf .
  DATA: st_formular_pdf TYPE fpname.
*************************Start of Note changes 1503297*********************************
  DATA: ls_pdf_file  TYPE fpformoutput,
        lv_emailaddr TYPE adr6-smtp_addr.

* Setting for sending FAX
  DATA : lv_cam_address      TYPE REF TO cl_cam_address_bcs,
         lv_outputparams_fax TYPE        sfpoutpar,
         lv_vend_cntry       TYPE        lfa1-land1.

* BCS data
  DATA:
    send_request   TYPE REF TO cl_bcs,
    document       TYPE REF TO cl_document_bcs,
    recipient      TYPE REF TO if_recipient_bcs,
    bcs_exception  TYPE REF TO cx_bcs,
    lv_sent_to_all TYPE        os_boolean,
    lp_pdf_size    TYPE        so_obj_len,
    lv_subject     TYPE        so_obj_des,
    lv_add_nr      TYPE        adr6-addrnumber.

* Archiving specific data declaration
  DATA: lv_pdf_size      TYPE i,
        lv_archiveformat LIKE toadd-doc_type,  "PDF or OTF
        lv_documentclass LIKE toadv-doc_type.
*************************End of Note changes 1503297*********************************
  gv_form = tnapr-sform.

  IF tnapr-formtype = 2.

    TRY.
* Function to find the FM name.
        CALL FUNCTION 'FP_FUNCTION_MODULE_NAME'
          EXPORTING
            i_name           = gv_form
          IMPORTING
            e_funcname       = gv_fm_name
            e_interface_type = gv_interface_type.

      CATCH cx_root INTO gv_w_cx_root.
        gv_mesg = gv_w_cx_root->get_text( ).
        MESSAGE gv_mesg TYPE 'E'.

    ENDTRY.
*    gv_fp_docparams-langu  = vbdkl-spras.                  "v_n_1676779
    gv_fp_docparams-langu     = nast-spras.
    gv_fp_docparams-replangu1 = vbdkl-spras_vko.     "sales org language
    gv_fp_docparams-replangu2 = gc_english.                 "^_n_1676779
    gv_fp_docparams-country   = vbdkl-land1.

    " Cargar estructura Albarán de entrega:
* GST - 18/02/2015 ->
    SET COUNTRY 'ES'.
* GST - 18/02/2015 <-
    PERFORM f_cargar_albaran.
* GST - 18/02/2015 ->
    SET COUNTRY vbdkl-land1.
* GST - 18/02/2015 <-

    CALL FUNCTION gv_fm_name
      EXPORTING
        /1bcdwb/docparams  = gv_fp_docparams
* GST - 12/11/2014 ->
        albaran            = lt_albaran
* GST - 12/11/2014 <-
        vbdpl              = gt_vbdpl
        deliveryheader     = gs_shipment
        conf_out           = gt_conf_out
        rdgtxtprt          = gt_rdgtxtprt
        komser             = gt_komser
        include_text       = gs_inc_text
        dg_text            = gt_dg
        repeat             = gv_repeat
        vbeln              = vbco3-vbeln
      IMPORTING                                             "EHP5
        /1bcdwb/formoutput = ls_pdf_file                    "EHP5
      EXCEPTIONS
        usage_error        = 1
        system_error       = 2
        internal_error     = 3
        OTHERS             = 4.
    IF sy-subrc <> 0.
      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
    ENDIF.
*   Enhancements for web dynpro pdf output  ****EHP5
    IF xscreen = 'W'.
      EXPORT lv_pdf_file = ls_pdf_file-pdf TO MEMORY ID 'PDF_FILE'.
    ELSE.
*****************************Start of Note 1503297************************************************************

*sending Document out via mail or FAX
      IF xscreen IS INITIAL  "In case of preview message should be displayed only
          AND ( nast-nacha EQ 5 OR nast-nacha EQ 2 ) AND ls_pdf_file IS NOT INITIAL.

* get Email id from address no
* Inicio mod 19.04-17 JJR
        IF nast-parvw = '§§'.
          SELECT SINGLE smtp_addr FROM adr6 INTO lv_emailaddr WHERE addrnumber = addr_key-addrnumber
                                                      AND flgdefault = abap_true
                                                      AND persnumber = addr_key-persnumber.
        ELSE.
* FIN mod 19.04-17 JJR
          SELECT SINGLE smtp_addr FROM adr6 INTO lv_emailaddr WHERE addrnumber = addr_key-addrnumber AND flgdefault = abap_true.
        ENDIF.

        " When more than one address is maintained default address should be selected.
        " When there is only one mail id then that will have default flag set
* Set FAX specific setting
        IF nast-telfx NE space.
          lv_outputparams_fax-telenum  = nast-telfx.
          IF nast-tland IS INITIAL.
            lv_outputparams_fax-teleland = vbdkl-land1.
          ELSE.
            lv_outputparams_fax-teleland = nast-tland.
          ENDIF.
        ENDIF.
        IF gv_comm_type EQ 'FAX' OR gv_comm_type EQ 'INT' OR nast-nacha EQ 2.
* ------------ Call BCS interface ----------------------------------
          TRY.
*   ---------- create persistent send request ----------------------
              send_request = cl_bcs=>create_persistent( ).

*   ---------- add document ----------------------------------------
*   get PDF xstring and convert it to BCS format
              lp_pdf_size = xstrlen( ls_pdf_file-pdf ).

              PERFORM xstring_to_solix
                          USING
                             ls_pdf_file-pdf.
              lv_subject = gv_fp_outputparams-covtitle.
              document = cl_document_bcs=>create_document(
                    i_type    = 'PDF' " cf. RAW, DOC
                    i_hex     = gv_pdf_content
                    i_length  = lp_pdf_size
                    i_subject = lv_subject ).               "#EC NOTEXT

*   add document to send request
              send_request->set_document( document ).

*     --------- set sender -------------------------------------------
*     note: this is necessary only if you want to set the sender
*           different from actual user (SY-UNAME). Otherwise sender is
*           set automatically with actual user.
*
*   ---------- add recipient (e-mail address) ----------------------

              CASE nast-nacha.
                WHEN 5.
                  IF gv_comm_type EQ 'INT'.
*           add recipient (e-mail address)
                    recipient = cl_cam_address_bcs=>create_internet_address(
                    i_address_string = lv_emailaddr ).
                  ELSE.
*           add recipient (fax address)
                    recipient = cl_cam_address_bcs=>create_fax_address(
                                     i_country = lv_outputparams_fax-teleland
                                     i_number  = lv_outputparams_fax-telenum ).
                  ENDIF.

                WHEN 2.
*           add recipient (fax address)
                  recipient = cl_cam_address_bcs=>create_fax_address(
                                   i_country = lv_outputparams_fax-teleland
                                   i_number  = lv_outputparams_fax-telenum ).
              ENDCASE.

*   add recipient to send request
              send_request->add_recipient( i_recipient = recipient ).

*   ---------- send document ---------------------------------------
              lv_sent_to_all = send_request->send(
                  i_with_error_screen = 'X' ).
* Issue message and COMMINT only if the subroutine is not called in update task
              IF gv_inupd = 0.
                IF lv_sent_to_all = 'X'.
                  MESSAGE i022(so).
                ENDIF.

*   ---------- explicit 'commit work' is mandatory! ----------------
                COMMIT WORK.
              ENDIF.
* ------------------------------------------------------------------
* *            exception handling
* ------------------------------------------------------------------
            CATCH cx_bcs INTO bcs_exception.
              MESSAGE e451(so) WITH lv_outputparams_fax-telenum.
              retcode = 1.
              EXIT.
          ENDTRY.
        ENDIF.
      ENDIF.

      IF nast-sort1 = 'ZPDF'.
        EXPORT form_output FROM ls_pdf_file TO MEMORY ID 'ZMENSAJE_OTFDATA'.
      ENDIF.

* Arching for adobe forms
      IF nast-tdarmod = 2 OR  nast-tdarmod = 3.

* Get the PDF length
        lp_pdf_size = xstrlen( ls_pdf_file-pdf ).

* defaults for archive
        IF toa_dara-function = space.
          toa_dara-function = 'DARA'.
        ENDIF.
*     which format to be used for archiving: OTF or PDF?
        CALL FUNCTION 'ARCHIV_GET_PRINTFORMAT'
          EXPORTING
            application = 'PDF'
          IMPORTING
            printformat = lv_archiveformat.

        IF lv_archiveformat EQ 'PDF'.
          lv_documentclass = 'PDF'.

          CALL FUNCTION 'ARCHIV_CREATE_OUTGOINGDOCUMENT'
            EXPORTING
              arc_p                    = arc_params
              arc_i                    = toa_dara
              pdflen                   = lv_pdf_size
              documentclass            = lv_documentclass                "Since the output is in PDF document class is also PDF
              document                 = ls_pdf_file-pdf
            EXCEPTIONS
              error_archiv             = 1
              error_communicationtable = 2
              error_connectiontable    = 3
              error_kernel             = 4
              error_parameter          = 5
              OTHERS                   = 6.
          CASE sy-subrc.
            WHEN 0. " o.k.
            WHEN 1. RAISE error_archiv.
            WHEN 2. RAISE error_communicationtable.
            WHEN 3. RAISE error_connectiontable.
            WHEN 4. RAISE error_kernel.
            WHEN 5. RAISE error_parameter.
            WHEN 6. RAISE error_archiv. "?
          ENDCASE.

        ELSE.
          " Other than PDF format raise error.
          MESSAGE e789(po) WITH lv_archiveformat.
          retcode = 1.
        ENDIF.
      ENDIF.
    ENDIF.
*****************************End of Note 1503297**************************************************************
*--------------------------------------------------------EHP5

    REFRESH: gt_vbdpl,gt_conf_out,gt_rdgtxtprt,gt_komser.
    CLEAR : gv_repeat, gt_dg, gs_dg.
  ELSE.
    MESSAGE 'PDF form not available' TYPE 'I'.              "#EC NOTEXT
    CALL TRANSACTION 'VL71'.
  ENDIF.

ENDFORM.                    " WRITE_PDF

*&---------------------------------------------------------------------*
*&      Form  FORM_OPEN_PDF
*&---------------------------------------------------------------------*
FORM form_open_pdf USING    us_screen us_country .
*  INCLUDE rvadopfo_pdf.
  INCLUDE zrvadopfo2_pdf.
*  INCLUDE zrvadopfo_pdf.
ENDFORM.                    " FORM_OPEN_PDF




*&---------------------------------------------------------------------*
*&      Form  FORM_OPEN_PDF
*&---------------------------------------------------------------------*
FORM form_open_pdf_ofertas USING  us_country.
  "Copia de ZRVADOPFO2_PDF, pero adaptando los output_params

*  DATA: ls_itcpo       TYPE   itcpo,
*        lvf_device(30) TYPE   c,
*        lvf_dialog(1)  TYPE   c   VALUE ' ',
*        lvf_program    LIKE   sy-repid.
*
** reset return code
*  retcode = 0.
**************************Start of Note changes 1503297*********************************
** Check if the subroutine is called in update task.
*  CALL METHOD cl_system_transaction_state=>get_in_update_task
*    RECEIVING
*      in_update_task = gv_inupd.
** Check for external send
*  IF nast-nacha EQ 5.
**   ... use stratagy to get communication type
*    CALL FUNCTION 'ADDR_GET_NEXT_COMM_TYPE'
*      EXPORTING
*        strategy           = nast-tcode
*        address_number     = addr_key-addrnumber
*        person_number      = addr_key-persnumber
*      IMPORTING
*        comm_type          = gv_comm_type
*        comm_values        = gv_comm_values
*      EXCEPTIONS
*        address_not_exist  = 1
*        person_not_exist   = 2
*        no_comm_type_found = 3
*        internal_error     = 4
*        parameter_error    = 5
*        OTHERS             = 6.
*    IF sy-subrc <> 0.
*      CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
*        EXPORTING
*          msg_arbgb = sy-msgid
*          msg_nr    = sy-msgno
*          msg_ty    = sy-msgty
*          msg_v1    = sy-msgv1
*          msg_v2    = sy-msgv2
*          msg_v3    = sy-msgv3
*          msg_v4    = sy-msgv4
*        EXCEPTIONS
*          OTHERS    = 1.
*      retcode = 1.
*      EXIT.
*    ENDIF.
*  ENDIF.
** convert communication data
*  MOVE-CORRESPONDING nast TO gs_intnast.
*  MOVE sy-repid           TO gv_xprogramm.
*  CALL FUNCTION 'CONVERT_COMM_TYPE_DATA'
*    EXPORTING
*      pi_comm_type              = gv_comm_type
*      pi_comm_values            = gv_comm_values
*      pi_country                = us_country
*      pi_screen                 = us_screen
*      pi_repid                  = gv_xprogramm
*      pi_snast                  = gs_intnast
*    IMPORTING
*      pe_itcpo                  = ls_itcpo
*      pe_device                 = gv_fp_outputparams-device
*      pe_mail_recipient         = gs_recipient
*      pe_mail_sender            = gs_sender
*    EXCEPTIONS
*      comm_type_not_supported   = 1
*      recipient_creation_failed = 2
*      sender_creation_failed    = 3
*      OTHERS                    = 4.
*  IF sy-subrc <> 0.
*    CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
*      EXPORTING
*        msg_arbgb = sy-msgid
*        msg_nr    = sy-msgno
*        msg_ty    = sy-msgty
*        msg_v1    = sy-msgv1
*        msg_v2    = sy-msgv2
*        msg_v3    = sy-msgv3
*        msg_v4    = sy-msgv4
*      EXCEPTIONS
*        OTHERS    = 1.
*    retcode = 1.
*    EXIT.
*  ENDIF.
*
*  IF gv_fp_outputparams-device = 'MAIL'.
*    CALL FUNCTION 'SX_ADDRESS_TO_DEVTYPE'
*      EXPORTING
*        recipient_id      = gs_recipient
*        sender_id         = gs_sender
*      EXCEPTIONS
*        err_invalid_route = 1
*        err_system        = 2
*        OTHERS            = 3.
*    IF sy-subrc <> 0.
*      CALL FUNCTION 'NAST_PROTOCOL_UPDATE'
*        EXPORTING
*          msg_arbgb = sy-msgid
*          msg_nr    = sy-msgno
*          msg_ty    = sy-msgty
*          msg_v1    = sy-msgv1
*          msg_v2    = sy-msgv2
*          msg_v3    = sy-msgv3
*          msg_v4    = sy-msgv4
*        EXCEPTIONS
*          OTHERS    = 1.
*      retcode = 1.
*      EXIT.
*    ENDIF.
*  ENDIF.
*
*  CHECK retcode EQ 0.
*
** if there is no communication type
*  IF  gv_comm_type IS INITIAL.
**   set device
*    CASE nast-nacha.
*      WHEN '1'.
*        gv_fp_outputparams-device = 'PRINTER'.
*        IF ls_itcpo-tdpreview EQ  'X'.                        "v_n_1639666
*          gv_fp_outputparams-nodialog =  'X'.
*        ENDIF.                                                "^_n_1639666
*      WHEN '2'.
*        gv_fp_outputparams-device = 'TELEFAX'.
*        ls_itcpo-tdtelenum = nast-telfx.
*        IF nast-tland IS INITIAL.
*          ls_itcpo-tdteleland = us_country.
*        ELSE.
*          ls_itcpo-tdteleland = nast-tland.
*        ENDIF.
*        ls_itcpo-tdsenddate = nast-vsdat.
*        ls_itcpo-tdsendtime = nast-vsura.
*        ls_itcpo-tdfaxuser  = nast-usnam.
*      WHEN '3'.
*        gv_fp_outputparams-device = 'TELETEX'.
*        ls_itcpo-tdtelenum = nast-teltx.
*        IF nast-tland IS INITIAL.
*          ls_itcpo-tdteleland = us_country.
*        ELSE.
*          ls_itcpo-tdteleland = nast-tland.
*        ENDIF.
*        ls_itcpo-tdsenddate = nast-vsdat.
*        ls_itcpo-tdsendtime = nast-vsura.
*      WHEN '4'.
*        gv_fp_outputparams-device = 'TELEX'.
*        ls_itcpo-tdtelenum = nast-telx1.
*        IF nast-tland IS INITIAL.
*          ls_itcpo-tdteleland = us_country.
*        ELSE.
*          ls_itcpo-tdteleland = nast-tland.
*        ENDIF.
*        ls_itcpo-tdsenddate = nast-vsdat.
*        ls_itcpo-tdsendtime = nast-vsura.
*      WHEN OTHERS.
*        gv_fp_outputparams-device = 'PRINTER'.
*    ENDCASE.
*  ENDIF.
** Setting to get the PDF string..
*  IF us_screen IS INITIAL "In case of preview message should be displayed only
*    AND ( nast-nacha EQ 5 OR nast-tdarmod = 2 OR  nast-nacha EQ 2 ).
** Setting output parameters only if communication type is fax or email.
*    IF nast-nacha EQ 5.
*      IF ( gv_comm_type EQ 'FAX' OR gv_comm_type EQ 'INT' ).
*        gv_fp_outputparams-getpdf = 'X'.
*      ENDIF.
*    ELSE.
*      gv_fp_outputparams-getpdf = 'X'.
*    ENDIF.
** Specific setting for FAX
*    IF nast-nacha EQ 2.
** Setting output parameters
*      IF nast-telfx EQ space.
*        gv_fp_outputparams-nodialog = ' '.
*      ELSE.
*        gv_fp_outputparams-nodialog = 'X'.
*      ENDIF.
*    ENDIF.
*  ENDIF.
*
*************************End of note changes 1503297**********************************
*
**&--------------------------------------------------------------------*
** fill all the print parameters for the form
**---------------------------------------------------------------------*
*  gv_fp_outputparams-preview    = ls_itcpo-tdpreview.
*  gv_fp_outputparams-dest       = ls_itcpo-tddest.
*  gv_fp_outputparams-reqnew     = ls_itcpo-tdnewid.
*  gv_fp_outputparams-reqimm     = ls_itcpo-tdimmed.
*  gv_fp_outputparams-reqdel     = ls_itcpo-tddelete.
*  gv_fp_outputparams-reqfinal   = ls_itcpo-tdfinal.
*  gv_fp_outputparams-senddate   = ls_itcpo-tdsenddate.
*  gv_fp_outputparams-sendtime   = ls_itcpo-tdsendtime.
*  gv_fp_outputparams-schedule   = ls_itcpo-tdschedule.
*  gv_fp_outputparams-copies     = ls_itcpo-tdcopies.
*  gv_fp_outputparams-dataset    = ls_itcpo-tddataset.
*  gv_fp_outputparams-suffix1    = ls_itcpo-tdsuffix1.
*  gv_fp_outputparams-suffix2    = ls_itcpo-tdsuffix2.
*  gv_fp_outputparams-covtitle   = ls_itcpo-tdcovtitle.
*  gv_fp_outputparams-cover      = ls_itcpo-tdcover.
*  gv_fp_outputparams-receiver   = ls_itcpo-tdreceiver.
*  gv_fp_outputparams-division   = ls_itcpo-tddivision.
*  gv_fp_outputparams-lifetime   = ls_itcpo-tdlifetime.
*  gv_fp_outputparams-authority  = ls_itcpo-tdautority.
*  gv_fp_outputparams-rqposname  = ls_itcpo-rqposname.
*  gv_fp_outputparams-arcmode    = ls_itcpo-tdarmod.
*  gv_fp_outputparams-noarmch    = ls_itcpo-tdnoarmch.
*  gv_fp_outputparams-title      = ls_itcpo-tdtitle.
*  gv_fp_outputparams-nopreview  = ls_itcpo-tdnoprev.
** GST - 20/03/2015 ->
** Impresión no bloqueada:
**gv_fp_outputparams-noprint    = ls_itcpo-tdnoprint.
*  gv_fp_outputparams-noprint    = ' '.
** GST - 20/03/2015 <-
*
** Enhancements for web dynpro pdf output
*  IF us_screen = 'W'.
*    gv_fp_outputparams-device   = ''.
*    gv_fp_outputparams-getpdf   = 'X'.
*  ENDIF.

  "TODO JCB 27.12.22
* open form
  CLEAR gv_fp_outputparams.
  gv_fp_outputparams-dest     = 'PDF'. "Depends on user settings
  gv_fp_outputparams-nodialog = abap_true.
  gv_fp_outputparams-preview  = abap_false.
  gv_fp_outputparams-getpdf   = 'M'."(Default value = 'X')
  gv_fp_outputparams-assemble = 'S'."bigger data
  gv_fp_outputparams-bumode   = 'M'."This is Bundle Mode
  gv_fp_outputparams-reqnew   = abap_true.
  "FIN TODO JCB 27.12.22


  CALL FUNCTION 'FP_JOB_OPEN'
    CHANGING
      ie_outputparams = gv_fp_outputparams
    EXCEPTIONS
      cancel          = 1
      usage_error     = 2
      system_error    = 3
      internal_error  = 4
      OTHERS          = 5.
  IF sy-subrc <> 0.
    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ENDIF.

  SET COUNTRY us_country.

ENDFORM.                    " FORM_OPEN_PDF





*&---------------------------------------------------------------------*
*&      Form  FORM_CLOSE_PDF
*&---------------------------------------------------------------------*
FORM form_close_pdf .
  CALL FUNCTION 'FP_JOB_CLOSE'
    EXCEPTIONS
      usage_error    = 1
      system_error   = 2
      internal_error = 3
      OTHERS         = 4.
  IF sy-subrc NE 0.
    retcode = 1.
    PERFORM protocol_update.
  ENDIF.
  SET COUNTRY space.








*  CALL FUNCTION 'SCMS_XSTRING_TO_BINARY'
*    EXPORTING
*      buffer        = lv_merged_document
*    IMPORTING
*      output_length = lv_len
*    TABLES
*      binary_tab    = lt_data.
*
*  CALL METHOD cl_gui_frontend_services=>file_save_dialog
*    EXPORTING
*      window_title              = 'Save Form'
*      default_extension         = '.pdf'
*      default_file_name         = 'Invoice.pdf'
*      prompt_on_overwrite       = 'X'
*    CHANGING
*      filename                  = lv_file_name
*      path                      = lv_path
*      fullpath                  = lv_file
*    EXCEPTIONS
*      cntl_error                = 1
*      error_no_gui              = 2
*      not_supported_by_gui      = 3
*      invalid_default_file_name = 4
*      OTHERS                    = 5.
*  IF sy-subrc <> 0.
** Implement suitable error handling here
*  ENDIF.
*
*  CALL METHOD cl_gui_frontend_services=>gui_download
*    EXPORTING
*      bin_filesize            = lv_len
*      filename                = lv_file
*      filetype                = 'BIN'
*    CHANGING
*      data_tab                = lt_data
*    EXCEPTIONS
*      file_write_error        = 1
*      no_batch                = 2
*      gui_refuse_filetransfer = 3
*      invalid_type            = 4
*      no_authority            = 5
*      unknown_error           = 6
*      header_not_allowed      = 7
*      separator_not_allowed   = 8
*      filesize_not_allowed    = 9
*      header_too_long         = 10
*      dp_error_create         = 11
*      dp_error_send           = 12
*      dp_error_write          = 13
*      unknown_dp_error        = 14
*      access_denied           = 15
*      dp_out_of_memory        = 16
*      disk_full               = 17
*      dp_timeout              = 18
*      file_not_found          = 19
*      dataprovider_exception  = 20
*      control_flush_error     = 21
*      not_supported_by_gui    = 22
*      error_no_gui            = 23
*      OTHERS                  = 24.
*  IF sy-subrc IS NOT INITIAL.
*  ENDIF.
*  CALL METHOD cl_gui_frontend_services=>execute
*    EXPORTING
*      document               = lv_file
*      synchronous            = 'X'
*    EXCEPTIONS
*      cntl_error             = 1
*      error_no_gui           = 2
*      bad_parameter          = 3
*      file_not_found         = 4
*      path_not_found         = 5
*      file_extension_unknown = 6
*      error_execute_failed   = 7
*      synchronous_failed     = 8
*      not_supported_by_gui   = 9
*      OTHERS                 = 10.
*  IF sy-subrc IS NOT INITIAL.
*  ENDIF.
*
*






ENDFORM.                    " FORM_CLOSE_PDF
*************************Start of Note changes 1503297*********************************
*&---------------------------------------------------------------------*
*&      Form  xstring_to_solix
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->IP_XSTRING text
*----------------------------------------------------------------------*
FORM  xstring_to_solix
  USING ip_xstring TYPE xstring.

  DATA:
    lp_offset          TYPE i,
    lt_solix           TYPE solix_tab,
    ls_solix_line      TYPE solix,
    lp_pdf_string_len  TYPE i,
    lp_solix_rows      TYPE i,
    lp_last_row_length TYPE i,
    lp_row_length      TYPE i.

  CLEAR gv_pdf_content.

* transform xstring to SOLIX
  DESCRIBE TABLE lt_solix.
  lp_row_length = sy-tleng.
  lp_offset = 0.

  lp_pdf_string_len = xstrlen( ip_xstring ).

  lp_solix_rows = lp_pdf_string_len DIV lp_row_length.
  lp_last_row_length = lp_pdf_string_len MOD lp_row_length.
  DO lp_solix_rows TIMES.
    ls_solix_line-line =
           ip_xstring+lp_offset(lp_row_length).
    APPEND ls_solix_line TO gv_pdf_content.
    ADD lp_row_length TO lp_offset.
  ENDDO.
  IF lp_last_row_length > 0.
    CLEAR ls_solix_line-line.
    ls_solix_line-line = ip_xstring+lp_offset(lp_last_row_length).
    APPEND ls_solix_line TO gv_pdf_content.
  ENDIF.

ENDFORM.                    "XSTRING_TO_SOLIX
*************************End of Note changes 1503297*********************************
INCLUDE dor01_f01.

*&---------------------------------------------------------------------*
*&      Form  F_CARGAR_ALBARAN
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM f_cargar_albaran.

  DATA: ls_vttk       TYPE vttk,
        lv_cant_e(15),
        lv_cant_d(3),
        lv_string     TYPE string,
        lv_bezei      TYPE vttk_add01_t,
        l_vbfa        TYPE vbfa,
        lv_kunag      TYPE likp-kunag,
        lv_vkorg      TYPE likp-vkorg,
        lv_vgbel      TYPE lips-vgbel,
        ls_vbak       TYPE vbak,
        lt_vbap       TYPE TABLE OF vbap,
        ls_vbap       TYPE vbap.

  CLEAR: lt_albaran, ls_vttk, l_vbfa.


  " Cargar cabecera:
  MOVE-CORRESPONDING gs_shipment TO lt_albaran-cabecera-cabecera.
  lt_albaran-cabecera-cabecera-vbeln = vbco3-vbeln.

*  SELECT SINGLE vgbel FROM lips INTO lv_vgbel
*                WHERE vbeln = lt_albaran-cabecera-cabecera-vbeln.
*                AND matnr = lv_matnr1.
  lv_vgbel = vbco3-vbeln.

  IF lt_albaran-cabecera-cabecera-vbeln IS NOT INITIAL.

    " Accedemos a la tabla VBAK con el campo VBELN para recuperar KNUMV
    SELECT SINGLE * FROM vbak INTO ls_vbak
      WHERE vbeln = lv_vgbel.

    SELECT * FROM vbap INTO TABLE lt_vbap
      WHERE vbeln = lv_vgbel.

    READ TABLE lt_vbap INTO ls_vbap INDEX 1.

    MOVE-CORRESPONDING ls_vbak TO lt_albaran-cabecera-cabecera.
    lt_albaran-cabecera-cabecera-bukrs = ls_vbak-bukrs_vf.
    lt_albaran-cabecera-cabecera-vstel = ls_vbap-vstel.
    lt_albaran-cabecera-cabecera-wadat = ls_vbak-bnddt.
    lt_albaran-cabecera-cabecera-lfdat = ls_vbak-vdatu.

    gv_kvgr1 = ls_vbak-kvgr1.
    " URL del logo
    IF gv_kvgr1 NE 'C01'.
      PERFORM cargar_logo_url USING lt_albaran-cabecera-cabecera-bukrs lt_albaran-cabecera-cabecera-vkorg
                              CHANGING lt_albaran-cabecera-logo_url.
    ENDIF.
* GST - 24/02/2015 ->
* Título de formulario:
*** SCT 18/07/2016 para traslados lo hacemos por clase entrega
    PERFORM cargar_titulo USING lt_albaran-cabecera-cabecera-vbtyp
                                lt_albaran-cabecera-cabecera-spras
                                lt_albaran-cabecera-cabecera-zzsegcal
                                lt_albaran-cabecera-cabecera-lfart
                          CHANGING lt_albaran-cabecera-titulo.
*                                   lt_albaran-cabecera-titulo_doc_sm.
* GST - 24/02/2014 <-
    IF gv_kvgr1 NE 'C01'.
      PERFORM cargar_dat_centro USING    lt_albaran-cabecera-cabecera-bukrs
                                         lt_albaran-cabecera-cabecera-vstel
                                CHANGING lt_albaran-cabecera-sociedad
                                         lt_albaran-cabecera-prov.
    ENDIF.
    " Datos Destino Mercancía:
    PERFORM cargar_dat_dmerc USING lt_albaran-cabecera-cabecera
                             CHANGING lt_albaran-cabecera-dest_mercancia.

    " Datos cliete:
    PERFORM cargar_dat_cliente USING lt_albaran-cabecera-cabecera-bukrs
                                     lt_albaran-cabecera-cabecera-vstel
                                     lt_albaran-cabecera-cabecera-vbeln
                                     lt_albaran-cabecera-dest_mercancia
                              CHANGING lt_albaran-cabecera-cliente.

*    " Transporte:
*    SELECT SINGLE vbeln INTO lt_albaran-cabecera-tknum
*      FROM vbfa
*      WHERE vbelv = lt_albaran-cabecera-cabecera-vbeln
*      AND vbtyp_n = '8'. " Transporte

    " Fecha Validez (Texto):
    CONCATENATE lt_albaran-cabecera-cabecera-wadat+6(2) lt_albaran-cabecera-cabecera-wadat+4(2)
                lt_albaran-cabecera-cabecera-wadat+0(4)
                INTO lt_albaran-cabecera-wadat_txt SEPARATED BY '.'.

    " Fecha Entrega (Texto):
    CONCATENATE lt_albaran-cabecera-cabecera-lfdat+6(2) lt_albaran-cabecera-cabecera-lfdat+4(2)
                lt_albaran-cabecera-cabecera-lfdat+0(4)
                INTO lt_albaran-cabecera-tknum SEPARATED BY '.'.

    " Prioridad (Texto):
    SELECT SINGLE bezei INTO lt_albaran-cabecera-lprio_txt
      FROM tprit
      WHERE spras = lt_albaran-cabecera-cabecera-spras
      AND lprio = lt_albaran-cabecera-cabecera-lprio.

    " Peso total (Texto):
    CLEAR lt_albaran-cabecera-cabecera-btgew.
    LOOP AT lt_vbap INTO ls_vbap.
      lt_albaran-cabecera-cabecera-btgew = lt_albaran-cabecera-cabecera-btgew + ls_vbap-ntgew.
    ENDLOOP.
    IF lt_albaran-cabecera-cabecera-btgew IS NOT INITIAL.
      WRITE lt_albaran-cabecera-cabecera-btgew TO lt_albaran-cabecera-peso_txt.
      CONDENSE lt_albaran-cabecera-peso_txt.
      SPLIT lt_albaran-cabecera-peso_txt AT ',' INTO lv_cant_e lv_cant_d.
      CONDENSE: lv_cant_e, lv_cant_d.
      IF lv_cant_d <> '000'.
        CONCATENATE lt_albaran-cabecera-peso_txt lt_albaran-cabecera-cabecera-gewei
                    INTO lt_albaran-cabecera-peso_txt SEPARATED BY space.
      ELSE.
        CLEAR lv_string.
        CONDENSE lv_cant_e.
        CONCATENATE lv_cant_e lt_albaran-cabecera-cabecera-gewei
                INTO lt_albaran-cabecera-peso_txt SEPARATED BY space.
      ENDIF.
    ENDIF.

    CONCATENATE lt_albaran-cabecera-peso_txt ls_vbap-gewei INTO lt_albaran-cabecera-peso_txt SEPARATED BY space.

* INI SS GAPSD009
** se recupera el campo PORTES VSBED de LIKP
*    SELECT SINGLE kunag vkorg vsbed anzpk INTO ( lv_kunag, lv_vkorg, lt_albaran-cabecera-portes, lt_albaran-cabecera-bulto )
*      FROM likp
*      WHERE vbeln = lt_albaran-cabecera-cabecera-vbeln.
** se recupera la decripcion de portes
*    SELECT SINGLE vtext INTO lt_albaran-cabecera-portes_desc
*      FROM tvsbt
*      WHERE spras = lt_albaran-cabecera-cabecera-spras
*      AND  vsbed = lt_albaran-cabecera-portes.

* se recupera el campo del proveedor.
    SELECT SINGLE eikto FROM knvv
        INTO lt_albaran-cabecera-proveedor
        WHERE kunnr = ls_vbak-kunnr "lv_kunag
          AND vkorg = ls_vbak-vkorg. "lv_vkorg.

*    " Horas de descarga:
*    IF lt_albaran-cabecera-cabecera-lfdat IS NOT INITIAL AND lt_albaran-cabecera-cabecera-kunwe IS NOT INITIAL.
*      PERFORM horas_descarga USING lt_albaran-cabecera-cabecera-lfdat
*                                   lt_albaran-cabecera-cabecera-kunwe
*                                   lt_albaran-cabecera-cabecera-ablad
*                             CHANGING lt_albaran-cabecera-hora_desc_1_ini
*                                      lt_albaran-cabecera-hora_desc_1_fin
*                                      lt_albaran-cabecera-hora_desc_2_ini
*                                      lt_albaran-cabecera-hora_desc_2_fin.
*
*      " Horario mañana:
*      IF lt_albaran-cabecera-hora_desc_1_ini IS NOT INITIAL AND lt_albaran-cabecera-hora_desc_1_fin IS NOT INITIAL.
*        CONCATENATE lt_albaran-cabecera-hora_desc_1_ini lt_albaran-cabecera-hora_desc_1_fin
*                    INTO lt_albaran-cabecera-hora_desc_man SEPARATED BY ' - '.
*      ELSEIF lt_albaran-cabecera-hora_desc_1_ini IS NOT INITIAL AND lt_albaran-cabecera-hora_desc_1_fin IS INITIAL.
*        lt_albaran-cabecera-hora_desc_man = lt_albaran-cabecera-hora_desc_1_ini.
*      ELSEIF lt_albaran-cabecera-hora_desc_1_ini IS INITIAL AND lt_albaran-cabecera-hora_desc_1_fin IS NOT INITIAL.
*        lt_albaran-cabecera-hora_desc_man = lt_albaran-cabecera-hora_desc_1_fin.
*      ENDIF.
*
*      " Horario tarde:
*      IF lt_albaran-cabecera-hora_desc_2_ini IS NOT INITIAL AND lt_albaran-cabecera-hora_desc_2_fin IS NOT INITIAL.
*        CONCATENATE lt_albaran-cabecera-hora_desc_2_ini lt_albaran-cabecera-hora_desc_2_fin
*                    INTO lt_albaran-cabecera-hora_desc_tar SEPARATED BY ' - '.
*      ELSEIF lt_albaran-cabecera-hora_desc_2_ini IS NOT INITIAL AND lt_albaran-cabecera-hora_desc_2_fin IS INITIAL.
*        lt_albaran-cabecera-hora_desc_tar = lt_albaran-cabecera-hora_desc_2_ini.
*      ELSEIF lt_albaran-cabecera-hora_desc_2_ini IS INITIAL AND lt_albaran-cabecera-hora_desc_2_fin IS NOT INITIAL.
*        lt_albaran-cabecera-hora_desc_tar = lt_albaran-cabecera-hora_desc_2_fin.
*      ENDIF.
*    ENDIF.

*    " Datos del transporte:
*    IF lt_albaran-cabecera-tknum IS NOT INITIAL.
*      SELECT SINGLE * INTO ls_vttk
*        FROM vttk
*        WHERE tknum = lt_albaran-cabecera-tknum.
*
*      IF ls_vttk IS NOT INITIAL.
*        lt_albaran-cabecera-transporte-tdlnr = ls_vttk-tdlnr.
*        SELECT SINGLE name1 stceg INTO (lt_albaran-cabecera-transporte-name1, lt_albaran-cabecera-transporte-stceg)
*          FROM lfa1
*          WHERE lifnr = lt_albaran-cabecera-transporte-tdlnr.
*        lt_albaran-cabecera-transporte-signi = ls_vttk-signi.
*        lt_albaran-cabecera-transporte-tpbez = ls_vttk-tpbez.
*        IF ls_vttk-text1 IS NOT INITIAL.
*          lt_albaran-cabecera-transporte-text1 = ls_vttk-text1.
*        ELSEIF ls_vttk-add01 IS NOT INITIAL.
*          CLEAR lv_bezei.
*          SELECT SINGLE bezei INTO lv_bezei
*            FROM vtadd01t
*            WHERE spras = lt_albaran-cabecera-cabecera-spras
*            AND add_info = ls_vttk-add01.
*          CONCATENATE ls_vttk-add01 lv_bezei INTO lt_albaran-cabecera-transporte-text1
*               SEPARATED BY '/'.
*        ENDIF.
*      ENDIF.
*    ENDIF.

    " Texto Albarán:
    lt_albaran-cabecera-texto_albaran-tdname = lt_albaran-cabecera-cabecera-vbeln.
    lt_albaran-cabecera-texto_albaran-tdobject = 'VBBK'.
    lt_albaran-cabecera-texto_albaran-tdid = '0001'.
    lt_albaran-cabecera-texto_albaran-tdspras = lt_albaran-cabecera-cabecera-spras.

    " Texto LOPD:
    CONCATENATE 'ZLOPD_' ls_vbak-bukrs_vf INTO lt_albaran-cabecera-texto_lopd-tdname.
*    lt_albaran-cabecera-texto_lopd-tdname = 'ZFACTURA_LOPD'.
    lt_albaran-cabecera-texto_lopd-tdobject = 'TEXT'.
    lt_albaran-cabecera-texto_lopd-tdid = 'ST'.
    lt_albaran-cabecera-texto_lopd-tdspras = lt_albaran-cabecera-cabecera-spras.


    "TEXTO_ENVASES "CGV - 03.05.18 - TICKET 47592
    lt_albaran-cabecera-texto_envases-tdname = 'ZTEXTO_ENVASES'.
    lt_albaran-cabecera-texto_envases-tdobject = 'TEXT'.
    lt_albaran-cabecera-texto_envases-tdid = 'ST'.
    lt_albaran-cabecera-texto_envases-tdspras = lt_albaran-cabecera-cabecera-spras.


* NAC -> Cambio por línea siguiente para añadir el eliminado del texto
* Reg. Mercantil para sociedad 2040 (Cartonajes Bernabéu).
*   IF gv_kvgr1 NE 'C01'.
    IF gv_kvgr1 NE 'C01' AND lt_albaran-cabecera-cabecera-bukrs NE '2040'.

      " Texto registro mercantil:
      CONCATENATE 'ZREG_MERC_' ls_vbak-bukrs_vf INTO lt_albaran-reg_mercantil-tdname.
      lt_albaran-reg_mercantil-tdobject = 'TEXT'.
      lt_albaran-reg_mercantil-tdid = 'ST'.
      lt_albaran-reg_mercantil-tdspras = lt_albaran-cabecera-cabecera-spras.
    ENDIF.
    " Texto SEGUNDA CALIDAD: (cgijon: 02/03/16)
    IF lt_albaran-cabecera-cabecera-zzsegcal IS NOT INITIAL.
**** AFCS - SAT 7000014668: Ticket ## 40563 ## de: cborreda@palqueri  -->
      CASE lt_albaran-cabecera-cabecera-zzsegcal.
        WHEN '1'.
          lt_albaran-cabecera-texto_segcal-tdname = 'ZSDV2002'.
          lt_albaran-cabecera-texto_segcal-tdobject = 'TEXT'.
          lt_albaran-cabecera-texto_segcal-tdid = 'ST'.
          lt_albaran-cabecera-texto_segcal-tdspras = lt_albaran-cabecera-cabecera-spras.
        WHEN '2'.
          lt_albaran-cabecera-texto_segcal-tdname = 'ZSDV2003'.
          lt_albaran-cabecera-texto_segcal-tdobject = 'TEXT'.
          lt_albaran-cabecera-texto_segcal-tdid = 'ST'.
          lt_albaran-cabecera-texto_segcal-tdspras = lt_albaran-cabecera-cabecera-spras.
      ENDCASE.
**** AFCS - SAT 7000014668: Ticket ## 40563 ## de: cborreda@palqueri  <--

    ELSE.
      CLEAR lt_albaran-cabecera-texto_segcal.
    ENDIF.

    " Código barras Albarán:
    lt_albaran-cabecera-bar_albaran = lt_albaran-cabecera-cabecera-vbeln.

    " Cargar posiciones:
    PERFORM cargar_posiciones USING ls_vbak-kunnr ls_vbak-vkorg. "lv_kunag lv_vkorg.

  ENDIF.

ENDFORM.                    " F_CARGAR_ALBARAN
*&---------------------------------------------------------------------*
*&      Form  CARGAR_LOGO_URL
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LT_ALBARAN_CABECERA_CABECERA_B  text
*      <--P_LT_ALBARAN_CABECERA_LOGO_URL  text
*----------------------------------------------------------------------*

FORM cargar_logo_url  USING    p_bukrs p_vkorg
                      CHANGING p_logo_url.

*  " Obtenemos la ruta del logo
*  CONCATENATE 'E:\logos\' p_bukrs '.jpg' INTO p_logo_url.
*  CONDENSE p_logo_url.

  CALL FUNCTION 'ZRECUPERA_LOGOS_SOCIEDAD'
    EXPORTING
      iv_bukrs = p_bukrs
      iv_vkorg = p_vkorg
    IMPORTING
      ev_path  = p_logo_url.


ENDFORM.                    " CARGAR_LOGO_URL
*&---------------------------------------------------------------------*
*&      Form  CARGAR_DAT_SOC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LT_ALBARAN_CABECERA_CABECERA_B  text
*      <--P_LT_ALBARAN_CABECERA_SOCIEDAD  text
*----------------------------------------------------------------------*
FORM cargar_dat_soc  USING    p_bukrs
                     CHANGING ps_sociedad TYPE zstsd_albaran_dir.


  DATA: lv_adrnr TYPE adrnr,
        ls_adrc  TYPE adrc.

  CLEAR: ps_sociedad, ls_adrc, lv_adrnr.

  SELECT SINGLE adrnr stceg INTO (ps_sociedad-adrnr, ps_sociedad-stceg)
    FROM t001
    WHERE bukrs = p_bukrs.

  IF ps_sociedad-adrnr IS NOT INITIAL.

    SELECT SINGLE * INTO ls_adrc
      FROM adrc
      WHERE addrnumber = ps_sociedad-adrnr.

    IF ls_adrc IS NOT INITIAL.

      MOVE-CORRESPONDING ls_adrc TO ps_sociedad.
      TRANSLATE ps_sociedad-name1 TO UPPER CASE.
      " Dirección 1:
      CONDENSE: ps_sociedad-street, ps_sociedad-house_num1.
      IF ps_sociedad-house_num1 IS NOT INITIAL.
        CONCATENATE ps_sociedad-street ps_sociedad-house_num1
                    INTO ps_sociedad-direc_1 SEPARATED BY ', '.
      ELSE.
        WRITE ps_sociedad-street TO ps_sociedad-direc_1.
      ENDIF.
      TRANSLATE ps_sociedad-direc_1 TO UPPER CASE.
      " Dirección 2:
      CONDENSE: ps_sociedad-post_code1, ps_sociedad-city1.
      CONCATENATE ps_sociedad-post_code1 ps_sociedad-city1
                INTO ps_sociedad-direc_2 SEPARATED BY space.
      TRANSLATE ps_sociedad-direc_2 TO UPPER CASE.
      IF ps_sociedad-region IS NOT INITIAL.
        TRANSLATE ps_sociedad-city1 TO UPPER CASE.
        SELECT SINGLE bezei INTO ps_sociedad-bezei
          FROM t005u
          WHERE bland = ls_adrc-region
          AND spras = ls_adrc-langu
          AND land1 = ls_adrc-country.
        TRANSLATE ps_sociedad-bezei TO UPPER CASE.
        IF ps_sociedad-bezei IS NOT INITIAL AND ps_sociedad-bezei NE ps_sociedad-city1.
          CONCATENATE ps_sociedad-direc_2 ps_sociedad-bezei
                      INTO ps_sociedad-direc_2 SEPARATED BY ' - '.
        ENDIF.
      ENDIF.
    ENDIF.
    " FAX:
    SELECT SINGLE fax_number INTO ps_sociedad-fax_number
      FROM adr3
      WHERE addrnumber = ps_sociedad-adrnr.
  ENDIF.

ENDFORM.                    " CARGAR_DAT_SOC
*&---------------------------------------------------------------------*
*&      Form  CARGAR_DAT_DMERC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LT_ALBARAN_CABECERA_CABECERA  text
*      <--P_LT_ALBARAN_CACEBERA_DEST_MERCA  text
*----------------------------------------------------------------------*
FORM cargar_dat_dmerc  USING    ps_cabecera TYPE vbdkl
                       CHANGING ps_dest_merc TYPE zstsd_albaran_dir.


  DATA: lv_adrnr TYPE adrnr,
        ls_adrc  TYPE adrc.

  CLEAR: ps_dest_merc, ls_adrc, lv_adrnr.

  ps_dest_merc-adrnr = ps_cabecera-adrnr_we.
  ps_dest_merc-stceg = ps_cabecera-stcd1_we.

  IF ps_dest_merc-adrnr IS NOT INITIAL.

    SELECT SINGLE * INTO ls_adrc
      FROM adrc
      WHERE addrnumber = ps_dest_merc-adrnr.

    IF ls_adrc IS NOT INITIAL.

      MOVE-CORRESPONDING ls_adrc TO ps_dest_merc.
      TRANSLATE ps_dest_merc-name1 TO UPPER CASE.
      " Dirección 1:
      CONDENSE: ps_dest_merc-street, ps_dest_merc-house_num1.
      IF ps_dest_merc-house_num1 IS NOT INITIAL.
        CONCATENATE ps_dest_merc-street ps_dest_merc-house_num1
                    INTO ps_dest_merc-direc_1 SEPARATED BY ', '.
      ELSE.
        WRITE ps_dest_merc-street TO ps_dest_merc-direc_1.
      ENDIF.
      TRANSLATE ps_dest_merc-direc_1 TO UPPER CASE.
      " Dirección 2:
      CONDENSE: ps_dest_merc-post_code1, ps_dest_merc-city1.
      CONCATENATE ps_dest_merc-post_code1 ps_dest_merc-city1
                INTO ps_dest_merc-direc_2 SEPARATED BY space.
      TRANSLATE ps_dest_merc-direc_2 TO UPPER CASE.
      IF ps_dest_merc-region IS NOT INITIAL.
        TRANSLATE ps_dest_merc-city1 TO UPPER CASE.
        SELECT SINGLE bezei INTO ps_dest_merc-bezei
          FROM t005u
          WHERE bland = ls_adrc-region
          AND spras = ls_adrc-langu
          AND land1 = ls_adrc-country.
        TRANSLATE ps_dest_merc-bezei TO UPPER CASE.
        IF ps_dest_merc-bezei IS NOT INITIAL AND ps_dest_merc-bezei NE ps_dest_merc-city1.
          CONCATENATE ps_dest_merc-direc_2 ps_dest_merc-bezei
                      INTO ps_dest_merc-direc_2 SEPARATED BY ' - '.
        ENDIF.
      ENDIF.
    ENDIF.
    " FAX:
    SELECT SINGLE fax_number INTO ps_dest_merc-fax_number
      FROM adr3
      WHERE addrnumber = ps_dest_merc-adrnr.
  ENDIF.

ENDFORM.                    " CARGAR_DAT_DMERC
*&---------------------------------------------------------------------*
*&      Form  HORAS_DESCARGA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LT_ALBARAN_CABECERA_CABECERA_L  text
*      <--P_LT_ALBARAN_CABECERA_HORA_DESC_  text
*      <--P_LT_ALBARAN_CABECERA_HORA_DESC_  text
*      <--P_LT_ALBARAN_CABECERA_HORA_DESC_  text
*      <--P_LT_ALBARAN_CABECERA_HORA_DESC_  text
*----------------------------------------------------------------------*
FORM horas_descarga  USING    p_lfdat
                              p_kunnr
                              p_ablad
                     CHANGING p_mh_ini
                              p_mh_fin
                              p_th_ini
                              p_th_fin.

*  CONSTANTS: lv_horario TYPE ablad VALUE 'Materias Primas'.

  DATA: lv_dia_sem TYPE p,
        ls_knva    TYPE knva.

  CLEAR: p_mh_ini, p_mh_ini, p_th_ini, p_th_fin, lv_dia_sem, ls_knva.

  CALL FUNCTION 'DAY_IN_WEEK'
    EXPORTING
      datum = p_lfdat
    IMPORTING
      wotnr = lv_dia_sem.

  SELECT SINGLE * INTO ls_knva
    FROM knva
    WHERE kunnr = p_kunnr
    AND ablad = p_ablad.

  IF ls_knva IS NOT INITIAL AND lv_dia_sem IS NOT INITIAL.

    CASE lv_dia_sem.

      WHEN '1'.  " Lunes

        IF ls_knva-moab1 <> '000000' OR ls_knva-mobi1 <> '000000'.
          CONCATENATE ls_knva-moab1+0(2) ls_knva-moab1+2(2)
                      INTO  p_mh_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-mobi1+0(2) ls_knva-mobi1+2(2)
                      INTO p_mh_fin SEPARATED BY ':'.
        ENDIF.

        IF ls_knva-moab2 <> '000000' OR ls_knva-mobi2 <> '000000'.
          CONCATENATE ls_knva-moab2+0(2) ls_knva-moab2+2(2)
                      INTO  p_th_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-mobi2+0(2) ls_knva-mobi2+2(2)
                      INTO p_th_fin SEPARATED BY ':'.
        ENDIF.

      WHEN '2'.  " Martes

        IF ls_knva-diab1 <> '000000' OR ls_knva-dibi1 <> '000000'.
          CONCATENATE ls_knva-diab1+0(2) ls_knva-diab1+2(2)
                      INTO  p_mh_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-dibi1+0(2) ls_knva-dibi1+2(2)
                      INTO p_mh_fin SEPARATED BY ':'.
        ENDIF.

        IF ls_knva-diab2 <> '000000' OR ls_knva-dibi2 <> '000000'.
          CONCATENATE ls_knva-diab2+0(2) ls_knva-diab2+2(2)
                      INTO  p_th_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-dibi2+0(2) ls_knva-dibi2+2(2)
                      INTO p_th_fin SEPARATED BY ':'.
        ENDIF.

      WHEN '3'.  " Miércoles

        IF ls_knva-miab1 <> '000000' OR ls_knva-mibi1 <> '000000'.
          CONCATENATE ls_knva-miab1+0(2) ls_knva-miab1+2(2)
                      INTO  p_mh_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-mibi1+0(2) ls_knva-mibi1+2(2)
                      INTO p_mh_fin SEPARATED BY ':'.
        ENDIF.

        IF ls_knva-miab2 <> '000000' OR ls_knva-mibi2 <> '000000'.
          CONCATENATE ls_knva-miab2+0(2) ls_knva-miab2+2(2)
                      INTO  p_th_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-mibi2+0(2) ls_knva-mibi2+2(2)
                      INTO p_th_fin SEPARATED BY ':'.
        ENDIF.

      WHEN '4'.  " Jueves

        IF ls_knva-doab1 <> '000000' OR ls_knva-dobi1 <> '000000'.
          CONCATENATE ls_knva-doab1+0(2) ls_knva-doab1+2(2)
                      INTO  p_mh_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-dobi1+0(2) ls_knva-dobi1+2(2)
                      INTO p_mh_fin SEPARATED BY ':'.
        ENDIF.

        IF ls_knva-doab2 <> '000000' OR ls_knva-dobi2 <> '000000'.
          CONCATENATE ls_knva-doab2+0(2) ls_knva-doab2+2(2)
                      INTO  p_th_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-dobi2+0(2) ls_knva-dobi2+2(2)
                      INTO p_th_fin SEPARATED BY ':'.
        ENDIF.

      WHEN '5'.  " Viernes

        IF ls_knva-frab1 <> '000000' OR ls_knva-frbi1 <> '000000'.
          CONCATENATE ls_knva-frab1+0(2) ls_knva-frab1+2(2)
                      INTO  p_mh_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-frbi1+0(2) ls_knva-frbi1+2(2)
                      INTO p_mh_fin SEPARATED BY ':'.
        ENDIF.

        IF ls_knva-frab2 <> '000000' OR ls_knva-frbi2 <> '000000'.
          CONCATENATE ls_knva-frab2+0(2) ls_knva-frab2+2(2)
                      INTO  p_th_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-frbi2+0(2) ls_knva-frbi2+2(2)
                      INTO p_th_fin SEPARATED BY ':'.
        ENDIF.

      WHEN '6'.  " Sábado

        IF ls_knva-saab1 <> '000000' OR ls_knva-sabi1 <> '000000'.
          CONCATENATE ls_knva-saab1+0(2) ls_knva-saab1+2(2)
                      INTO  p_mh_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-sabi1+0(2) ls_knva-sabi1+2(2)
                      INTO p_mh_fin SEPARATED BY ':'.
        ENDIF.

        IF ls_knva-saab2 <> '000000' OR ls_knva-sabi2 <> '000000'.
          CONCATENATE ls_knva-saab2+0(2) ls_knva-saab2+2(2)
                      INTO  p_th_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-sabi2+0(2) ls_knva-sabi2+2(2)
                      INTO p_th_fin SEPARATED BY ':'.
        ENDIF.

      WHEN '7'.  " Domingo

        IF ls_knva-soab1 <> '000000' OR ls_knva-sobi1 <> '000000'.
          CONCATENATE ls_knva-soab1+0(2) ls_knva-soab1+2(2)
                      INTO  p_mh_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-sobi1+0(2) ls_knva-sobi1+2(2)
                      INTO p_mh_fin SEPARATED BY ':'.
        ENDIF.

        IF ls_knva-soab2 <> '000000' OR ls_knva-sobi2 <> '000000'.
          CONCATENATE ls_knva-soab2+0(2) ls_knva-soab2+2(2)
                      INTO  p_th_ini SEPARATED BY ':'.
          CONCATENATE ls_knva-sobi2+0(2) ls_knva-sobi2+2(2)
                      INTO p_th_fin SEPARATED BY ':'.
        ENDIF.

    ENDCASE.

  ENDIF.

ENDFORM.                    " HORAS_DESCARGA
*&---------------------------------------------------------------------*
*&      Form  CARGAR_POSICIONES
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM cargar_posiciones USING  lv_kunag lv_vkorg.


  DATA: ls_vbdpl       TYPE vbdpl,
        ls_pos         TYPE zstsd_albaran_posicion,
        ls_texto       TYPE zstbc_textolargo,
        lv_index       LIKE sy-tabix,
        ls_part        TYPE zstsd_albaran_part_entrega_lin,
        lv_bstkd       TYPE bstkd,
        lv_adrnr       TYPE adrnr,
        lv_sort2       TYPE ad_sort2,
        lv_lfimg_e(17),
        lv_lfimg_d(3),
        lv_string      TYPE string,
        lv_matnr       TYPE matnr,
        lv_long        TYPE i,
        lv_lfimg       TYPE lips-lfimg.

  DATA: lv_knumv     TYPE vbak-knumv,
        lv_kpein     TYPE konv-kpein,
        lv_kbetr     TYPE konv-kbetr,
        lv_kvgr5     TYPE knvv-kvgr5,

        lv_preciof   TYPE f,
        lv_cantidadf TYPE f,

        lv_cantidad  TYPE p DECIMALS 5,
        lv_kawrt     TYPE p DECIMALS 2,
        lv_precio    TYPE p DECIMALS 5,
        lv_importe   TYPE f,
        lv_kawrt1    TYPE p DECIMALS 2,
        lv_iva       TYPE konv-kpein,
        lv_vgbel     TYPE lips-vgbel,
        lv_vgpos     TYPE lips-vgpos.

  DATA: ls_vbak TYPE vbak,
        lt_vbap TYPE TABLE OF vbap,
        ls_vbap TYPE vbap.



  CONSTANTS: c_ceros(16)      VALUE '0000000000000000'.

  DATA: lt_lines TYPE tline_tab.

  CLEAR: ls_vbdpl, ls_pos, lv_index.

  " Cargar datos posiciones de entrega:
*  LOOP AT gt_vbdpl INTO ls_vbdpl WHERE uecha IS INITIAL." AND lfimg IS NOT INITIAL.
*    ls_pos-pos_entrega = ls_vbdpl.
*    APPEND ls_pos TO lt_albaran-posiciones .
*  ENDLOOP.
  SELECT SINGLE * FROM vbak INTO ls_vbak
    WHERE vbeln = lt_albaran-cabecera-cabecera-vbeln.
  SELECT * FROM vbap INTO TABLE lt_vbap
    WHERE vbeln = lt_albaran-cabecera-cabecera-vbeln.
  LOOP AT lt_vbap INTO ls_vbap
                   WHERE abgru IS INITIAL. "*APC20240625 A petición de Andre no mostrar rechazadas
    MOVE-CORRESPONDING ls_vbap TO ls_pos-pos_entrega.
    APPEND ls_pos TO lt_albaran-posiciones.
  ENDLOOP.

*  CLEAR: ls_pos, ls_vbdpl, ls_part.
*  " Cargar datos particiones de lote:
*  LOOP AT lt_albaran-posiciones INTO ls_pos.
*    lv_index = sy-tabix.
*    CLEAR: lv_iva, lv_precio, lv_importe, lv_kawrt, lv_kawrt1, lv_knumv, lv_vgbel, lv_vgpos, lv_cantidad.
*
**    LOOP AT gt_vbdpl INTO ls_vbdpl WHERE  matnr = ls_pos-pos_entrega-matnr AND lfimg IS NOT INITIAL." AND posnr = ls_pos-pos_entrega-posnr.
*
**      MOVE-CORRESPONDING ls_vbdpl TO ls_part-vbdpl.
**      PERFORM certif_fsc_2 USING lt_albaran-cabecera-cabecera-bukrs
**                                 lt_albaran-cabecera-cabecera-wadat
**                           CHANGING ls_part-certif_fsc.
** GST - 19/01/2016 <-
*      " Cantidad (kg):
**      IF ls_part-vbdpl-vrkme <> 'KG'. " OR ls_part-vbdpl-vrkme <> 'ST'.
**
**        CALL FUNCTION 'ZCONVERTIR_CANTIDAD'
**          EXPORTING
**            i_matnr    = ls_part-vbdpl-matnr
**            i_canti    = ls_part-vbdpl-lfimg
**            i_meins_or = ls_part-vbdpl-vrkme
**            i_meins_fi = 'KG'
**          IMPORTING
**            e_canti    = ls_part-lfimg_kg.
**      ELSE.
*
*      ls_part-lfimg_kg = ls_part-vbdpl-lfimg.
**      ENDIF.
*
*      CLEAR: lv_lfimg_e, lv_lfimg_d.
*      IF ls_part-lfimg_kg IS NOT INITIAL.
*        WRITE ls_part-lfimg_kg TO ls_part-lfimg_kg_txt.
*        CONDENSE ls_part-lfimg_kg_txt.
*        SPLIT ls_part-lfimg_kg_txt AT ',' INTO lv_lfimg_e lv_lfimg_d.
*        CONDENSE: lv_lfimg_e, lv_lfimg_d.
*        IF lv_lfimg_d <> '000'.
*          WRITE ls_part-lfimg_kg TO ls_part-lfimg_kg_txt.
*          CONDENSE ls_part-lfimg_kg_txt.
*        ELSE.
*          CLEAR lv_string.
*          CONDENSE lv_lfimg_e.
*          WRITE lv_lfimg_e TO ls_part-lfimg_kg_txt.
*        ENDIF.
*      ENDIF.
*
*      " Suma total (kg):
*      ls_pos-pos_total-lfimg = ls_pos-pos_total-lfimg + ls_part-lfimg_kg.
*
*      DATA: lv_matnr1 TYPE matnr.
** las entregas no tienen informacion de precios, para recuperar el importe, se obtienen el número de
** pedido y posición relacionada con los campos VGBEL y VGPOS de LIPS
*      CALL FUNCTION 'CONVERSION_EXIT_MATN1_INPUT'
*        EXPORTING
*          input  = ls_pos-pos_entrega-matnr
*        IMPORTING
*          output = lv_matnr1.
*      IF sy-subrc <> 0.
** Implement suitable error handling here
*      ENDIF.
*
*
*      SELECT SINGLE vgbel vgpos kdmat FROM lips INTO ( lv_vgbel, lv_vgpos, ls_part-kdmat )
*              WHERE vbeln = ls_pos-pos_entrega-vbeln
**                AND matnr = lv_matnr1.
*                AND posnr = ls_pos-pos_entrega-posnr.
*
*      " Accedemos a la tabla VBAK con el campo VBELN para recuperar KNUMV
*      SELECT SINGLE knumv kvgr1 FROM vbak INTO ( lv_knumv, gv_kvgr1 )
*        WHERE vbeln = lv_vgbel.
*      " Accedemos a la tabla KONV con el campo KNUMV = vbak-KNUMV y kposn = lips-vgpos
*      SELECT SINGLE kawrt FROM konv INTO lv_kawrt1
*        WHERE knumv = lv_knumv
*          AND kposn = lv_vgpos
*          AND   kschl = 'ZPR0'.
*
*      " se obtiene la cantidad base a partir de la condicion ZPR0 dividido por 10.
*      lv_cantidadf = ( lv_kawrt1 / 10 ).
**      CALL FUNCTION 'MURC_ROUND_FLOAT_TO_PACKED'
**           EXPORTING
**             if_float                    = lv_cantidadf
**          IMPORTING
**            EF_PACKED                   = lv_cantidad.
*
*      SELECT SINGLE kbetr kawrt FROM konv INTO ( lv_kbetr, lv_kawrt )
*        WHERE knumv = lv_knumv
*         AND kposn = lv_vgpos
*         AND  kschl = 'ZWST'.
*
*      SELECT SINGLE kvgr5 FROM knvv INTO lv_kvgr5
*        WHERE kunnr = lv_kunag
*          AND vkorg = lv_vkorg.
*
*      IF lv_kvgr5 = 'C01'.
*        " se obtiene el iva a parotr de la condicion ZWST dividido por 10.
*        ls_part-iva  = lv_kbetr / 10.
*        " se obtiene el precio unitario neto dividiendo el importe neto de la cond ZWST con la cant.base ZPR0.
*        lv_preciof = ( lv_kawrt / lv_cantidadf ).
*        " se obtiene el importe de la posicion: cantidad * precio unitario
*        lv_importe = ( ls_part-lfimg_kg * lv_preciof ) / 1000 .
*
*        CALL FUNCTION 'MURC_ROUND_FLOAT_TO_PACKED'
*          EXPORTING
*            if_float  = lv_preciof
*          IMPORTING
*            ef_packed = ls_part-precio.
*
*        CALL FUNCTION 'MURC_ROUND_FLOAT_TO_PACKED'
*          EXPORTING
*            if_float  = lv_importe
*          IMPORTING
*            ef_packed = ls_part-importe.
*
*
*        WRITE ls_part-precio TO ls_part-precio_txt.
*        CONDENSE ls_part-precio_txt.
*
*        WRITE ls_part-importe TO ls_part-importe_txt.
*        CONDENSE ls_part-importe_txt.
*
*        WRITE ls_part-iva TO ls_part-iva_txt.
*        CONDENSE ls_part-iva_txt.
*      ENDIF.
*
*      IF ls_part-importe NE 0.
*        SELECT SINGLE waerk FROM likp INTO ls_part-moneda
*          WHERE vbeln = ls_pos-pos_entrega-vbeln.
*      ENDIF.
*
**     Numero de pedido del cliente (cgijon - 30.10.17)
*      CLEAR: ls_part-ped_cliente.
*
*      SELECT SINGLE bstkd FROM vbkd
*        INTO ls_part-ped_cliente
*        WHERE vbeln = ls_vbdpl-vgbel AND
*              posnr = ls_vbdpl-vgpos.
*      IF sy-subrc <> 0.
*        SELECT SINGLE bstkd FROM vbkd
*         INTO ls_part-ped_cliente
*         WHERE vbeln = ls_vbdpl-vgbel AND
*               posnr = ''.
*      ENDIF.
*
**      IF ls_pos-pos_entrega-posnr EQ ls_part-vbdpl-posnr_vauf.
**        APPEND ls_part TO ls_pos-part_entrega.
**      ENDIF.
*
*
**      IF ls_pos-pos_entrega-posnr EQ ls_part-vbdpl-uecha OR ls_pos-pos_entrega-posnr EQ ls_part-vbdpl-posnr.
**        APPEND ls_part TO ls_pos-part_entrega.
**      ENDIF.
*
*
*
*
**    ENDLOOP.
*    " Textos posición:
*    CLEAR ls_texto.
*    CONCATENATE ls_pos-pos_entrega-vbeln ls_pos-pos_entrega-posnr
*                INTO ls_texto-tdname.
*    ls_texto-tdobject = 'VBBP'.
*    ls_texto-tdid = '0001'.
*    ls_texto-tdspras = lt_albaran-cabecera-cabecera-spras.
*
*    CLEAR: lt_lines.
*    REFRESH: lt_lines.
*    CALL FUNCTION 'READ_TEXT'
*      EXPORTING
**       CLIENT                  = SY-MANDT
*        id                      = ls_texto-tdid
*        language                = ls_texto-tdspras
*        name                    = ls_texto-tdname
*        object                  = ls_texto-tdobject
**       ARCHIVE_HANDLE          = 0
**       LOCAL_CAT               = ' '
**    IMPORTING
**       HEADER                  =
**       OLD_LINE_COUNTER        =
*      TABLES
*        lines                   = lt_lines
*      EXCEPTIONS
*        id                      = 1
*        language                = 2
*        name                    = 3
*        not_found               = 4
*        object                  = 5
*        reference_check         = 6
*        wrong_access_to_archive = 7
*        OTHERS                  = 8.
*
*    IF lt_lines[] IS NOT INITIAL.
*      APPEND ls_texto TO ls_pos-pos_textos.
*    ENDIF.
*
*    CLEAR: lv_lfimg_e, lv_lfimg_d, lv_string.
*    IF ls_pos-pos_total-lfimg IS NOT INITIAL.
*      WRITE ls_pos-pos_total-lfimg TO ls_pos-pos_total-lfimg_txt.
*      CONDENSE ls_pos-pos_total-lfimg_txt.
*      SPLIT ls_pos-pos_total-lfimg_txt AT ',' INTO lv_lfimg_e lv_lfimg_d.
*      CONDENSE: lv_lfimg_e, lv_lfimg_d.
*      IF lv_lfimg_d <> '000'.
*        WRITE ls_pos-pos_total-lfimg TO ls_pos-pos_total-lfimg_txt.
*        CONDENSE ls_pos-pos_total-lfimg_txt.
*      ELSE.
*        CLEAR lv_string.
*        CONDENSE lv_lfimg_e.
*        WRITE lv_lfimg_e TO ls_pos-pos_total-lfimg_txt.
*      ENDIF.
*    ENDIF.
*
*    ls_pos-pos_total-vrkme = 'KG'.
*
*    CONCATENATE ls_pos-pos_total-lfimg_txt ls_pos-pos_total-vrkme
*                INTO ls_pos-pos_total-lfimg_txt SEPARATED BY space.
*
*    IF ls_pos IS NOT INITIAL.
*      MODIFY lt_albaran-posiciones FROM ls_pos INDEX lv_index.
*    ENDIF.
*  ENDLOOP.

ENDFORM.                    " CARGAR_POSICIONES

*&---------------------------------------------------------------------*
*&      Form  CARGAR_DAT_CENTRO
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LT_ALBARAN_CABECERA_CABECERA_V  text
*      <--P_LT_ALBARAN_CABECERA_SOCIEDAD  text
*----------------------------------------------------------------------*
FORM cargar_dat_centro  USING    p_bukrs
                                 p_vstel
                        CHANGING ps_sociedad TYPE zstsd_albaran_dir
                                 p_lifnr.

  DATA: lv_adrnr     TYPE adrnr,
        lv_adrnr_aux TYPE adrnr,
        ls_adrc      TYPE adrc,
        ls_adrc_aux  TYPE adrc,
        lv_kunnr     TYPE kunnr_wk,
        lv_stceg_aux TYPE stceg.

  CLEAR: ps_sociedad, ls_adrc, lv_adrnr, p_lifnr, lv_kunnr.

* GST - 17/03/2015 ->
  IF p_bukrs IS NOT INITIAL.
    SELECT SINGLE adrnr stceg INTO (ps_sociedad-adrnr, ps_sociedad-stceg)
      FROM t001
      WHERE bukrs = p_bukrs.
  ENDIF.
* GST - 17/03/2015 <-

* GST - 17/03/2015 ->
  IF ps_sociedad-adrnr IS INITIAL.
* GST - 17/03/2015 <-
    SELECT SINGLE adrnr lifnr kunnr INTO (ps_sociedad-adrnr, p_lifnr, lv_kunnr)
      FROM t001w
      WHERE werks = p_vstel.
* GST - 17/03/2015 ->
  ELSE.
    SELECT SINGLE lifnr kunnr INTO (p_lifnr, lv_kunnr)
      FROM t001w
      WHERE werks = p_vstel.
  ENDIF.
* GST - 17/03/2015 <-

  IF ps_sociedad-adrnr IS NOT INITIAL.

    SELECT SINGLE * INTO ls_adrc
      FROM adrc
      WHERE addrnumber = ps_sociedad-adrnr.

    IF ls_adrc IS NOT INITIAL.

      MOVE-CORRESPONDING ls_adrc TO ps_sociedad.
      TRANSLATE ps_sociedad-name1 TO UPPER CASE.
      " Dirección 1:
      CONDENSE: ps_sociedad-street, ps_sociedad-house_num1.
      IF ps_sociedad-house_num1 IS NOT INITIAL.
        CONCATENATE ps_sociedad-street ps_sociedad-house_num1
                    INTO ps_sociedad-direc_1 SEPARATED BY ', '.
      ELSE.
        WRITE ps_sociedad-street TO ps_sociedad-direc_1.
      ENDIF.
      TRANSLATE ps_sociedad-direc_1 TO UPPER CASE.
      " Dirección 2:
      CONDENSE: ps_sociedad-post_code1, ps_sociedad-city1.
      CONCATENATE ps_sociedad-post_code1 ps_sociedad-city1
                INTO ps_sociedad-direc_2 SEPARATED BY space.
      TRANSLATE ps_sociedad-direc_2 TO UPPER CASE.
      IF ps_sociedad-region IS NOT INITIAL.
        TRANSLATE ps_sociedad-city1 TO UPPER CASE.
        SELECT SINGLE bezei INTO ps_sociedad-bezei
          FROM t005u
          WHERE bland = ls_adrc-region
          AND spras = ls_adrc-langu
          AND land1 = ls_adrc-country.
        TRANSLATE ps_sociedad-bezei TO UPPER CASE.
        IF ps_sociedad-bezei IS NOT INITIAL AND ps_sociedad-bezei NE ps_sociedad-city1.
          CONCATENATE ps_sociedad-direc_2 ps_sociedad-bezei
                      INTO ps_sociedad-direc_2 SEPARATED BY ' - '.
        ENDIF.
      ENDIF.
    ENDIF.

    CLEAR: lv_adrnr_aux, ls_adrc_aux, lv_stceg_aux.
    SELECT SINGLE adrnr stceg INTO (lv_adrnr_aux, lv_stceg_aux)
      FROM kna1
      WHERE kunnr = lv_kunnr.

    IF lv_adrnr_aux IS NOT INITIAL.
      SELECT SINGLE * INTO ls_adrc_aux
        FROM adrc
        WHERE addrnumber = lv_adrnr_aux.
    ENDIF.


    " Teléfono:
    IF ps_sociedad-tel_number IS INITIAL.
      ps_sociedad-tel_number = ls_adrc_aux-tel_number.
      CONDENSE ps_sociedad-tel_number.
      CONCATENATE 'Telf.:' ps_sociedad-tel_number INTO ps_sociedad-telf SEPARATED BY space.
    ENDIF.

    " FAX:
    SELECT SINGLE fax_number INTO ps_sociedad-fax_number
      FROM adr3
      WHERE addrnumber = ps_sociedad-adrnr.

    IF ps_sociedad-fax_number IS INITIAL.
      ps_sociedad-fax_number = ls_adrc_aux-fax_number.
      CONDENSE ps_sociedad-fax_number.
    ENDIF.

    " NIF:
    IF ps_sociedad-stceg IS INITIAL.
      ps_sociedad-stceg = lv_stceg_aux.
      CONDENSE ps_sociedad-stceg.
    ENDIF.

  ENDIF.


ENDFORM.                    " CARGAR_DAT_CENTRO
*&---------------------------------------------------------------------*
*&      Form  CERTIF_FSC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LS_PART_MATWA  text
*      -->P_LS_PART_CHARG  text
*      <--P_LS_PART_CERTIF_FSC  text
*----------------------------------------------------------------------*
FORM certif_fsc  USING    p_matwa
                          p_charg
                 CHANGING p_certif_fsc.

  DATA: lt_class      TYPE /isdfps/lm_accident_sclass_t,
        lt_objectdata TYPE rihclobjdat_tab.

  DATA: lv_object     TYPE objnum,
        ls_objectdata TYPE clobjdat,
        lv_fsc        TYPE atwrt.

  CLEAR: lv_object, lt_class, lt_objectdata, ls_objectdata, lv_fsc.
  REFRESH: lt_class, lt_objectdata.

  CONCATENATE p_matwa p_charg INTO lv_object.

  " 1) Intentamos recuperar el pocentaje FSC de bobina:

  CALL FUNCTION 'CLAF_CLASSIFICATION_OF_OBJECTS'
    EXPORTING
      class              = 'Z_BOBINA'
*     CLASSTEXT          = 'X'
      classtype          = '023'
*     CLINT              = 0
*     FEATURES           = 'X'
*     LANGUAGE           = SY-LANGU
      object             = lv_object
      objecttable        = 'MCH1'
*     KEY_DATE           = SY-DATUM
*     INITIAL_CHARACT    = 'X'
*     NO_VALUE_DESCRIPT  =
*     CHANGE_SERVICE_CLF = 'X'
*     INHERITED_CHAR     = ' '
*     CHANGE_NUMBER      = ' '
    TABLES
      t_class            = lt_class
      t_objectdata       = lt_objectdata
*     I_SEL_CHARACTERISTIC       =
*     T_NO_AUTH_CHARACT  =
    EXCEPTIONS
      no_classification  = 1
      no_classtypes      = 2
      invalid_class_type = 3
      OTHERS             = 4.
*  IF sy-subrc <> 0.
** Implement suitable error handling here
*  ENDIF.

  IF lt_objectdata[] IS NOT INITIAL.
    READ TABLE lt_objectdata INTO ls_objectdata WITH KEY atnam = 'Z_FSC_PORCENTAJE'.
    IF ls_objectdata IS NOT INITIAL AND ( ls_objectdata-ausp1 IS NOT INITIAL AND ls_objectdata-ausp1 NE '?' ).
      lv_fsc = ls_objectdata-ausp1.
      CONDENSE lv_fsc.
    ENDIF.
  ENDIF.

  " 2) Intentamos recuperar el material FSC del material:
  IF lv_fsc IS INITIAL.

    CLEAR: lv_object, lt_class, lt_objectdata, ls_objectdata, lv_fsc.
    REFRESH: lt_class, lt_objectdata.

    lv_object = p_matwa.
    CONDENSE lv_object.

    CALL FUNCTION 'CLAF_CLASSIFICATION_OF_OBJECTS'
      EXPORTING
        class              = 'Z_BOBINA_FSC'
*       CLASSTEXT          = 'X'
        classtype          = '001'
*       CLINT              = 0
*       FEATURES           = 'X'
*       LANGUAGE           = SY-LANGU
        object             = lv_object
*       objecttable        = 'MCH1'
*       KEY_DATE           = SY-DATUM
*       INITIAL_CHARACT    = 'X'
*       NO_VALUE_DESCRIPT  =
*       CHANGE_SERVICE_CLF = 'X'
*       INHERITED_CHAR     = ' '
*       CHANGE_NUMBER      = ' '
      TABLES
        t_class            = lt_class
        t_objectdata       = lt_objectdata
*       I_SEL_CHARACTERISTIC       =
*       T_NO_AUTH_CHARACT  =
      EXCEPTIONS
        no_classification  = 1
        no_classtypes      = 2
        invalid_class_type = 3
        OTHERS             = 4.
*  IF sy-subrc <> 0.
** Implement suitable error handling here
*  ENDIF.

    IF lt_objectdata[] IS NOT INITIAL.
      READ TABLE lt_objectdata INTO ls_objectdata WITH KEY atnam = 'Z_FSC_TEORICO_BOBINA'.
      IF ls_objectdata IS NOT INITIAL AND ( ls_objectdata-ausp1 IS NOT INITIAL AND ls_objectdata-ausp1 NE '?' ).
        lv_fsc = ls_objectdata-ausp1.
        CONDENSE lv_fsc.
      ENDIF.
    ENDIF.

  ENDIF.

  " Creamos el texto:
* if lv_fsc is not initial.
  CONCATENATE 'Certificado SGSCH-COC-060051  FSC Recycled' lv_fsc '%'
              INTO p_certif_fsc SEPARATED BY space.
* else.
*   clear p_certif_fsc.
* endif.

ENDFORM.                    " CERTIF_FSC
*&---------------------------------------------------------------------*
*&      Form  CARGAR_TITULO
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LT_ALBARAN_CABECERA_CABECERA_V  text
*      -->P_LT_ALBARAN_CABECERA_CABECERA_S  text
*      <--P_LT_ALBARAN_CABECERA_TITULO  text
*----------------------------------------------------------------------*
FORM cargar_titulo USING p_vbtyp
                         p_spras
                         p_zzsegcal
                         p_lfart
                CHANGING p_titulo.
*                         p_titulo_doc_sm.

  CLEAR p_titulo.

*  IF p_vbtyp = 'T'. " Devolución
*    IF p_zzsegcal IS INITIAL.
  p_titulo = text-t07.
*    ELSE.
*      p_titulo = text-t03.
*    ENDIF.
*  ELSE. " Albarán
** SCT 18/07/2016 Para entr.traslado otro titulo.Asteriscamos para que puedan transportar
**    IF p_lfart = 'ZUL'.
**      p_titulo = text-t05.       "Albaran traslado
**      p_titulo_doc_sm = text-t06. "Doc. Salida Merc.
**    ELSE.
*    IF p_zzsegcal IS INITIAL.
*      p_titulo = text-t02.
*    ELSE.
*      p_titulo = text-t04.
*    ENDIF.
**    ENDIF.
*  ENDIF.

ENDFORM.                    " CARGAR_TITULO
*&---------------------------------------------------------------------*
*&      Form  CERTIF_FSC_2
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LT_ALBARAN_CABECERA_CABECERA_B  text
*      -->P_LT_ALBARAN_CABECERA_CABECERA_W  text
*      <--P_LS_PART_CERTIF_FSC  text
*----------------------------------------------------------------------*
*FORM certif_fsc_2  USING    p_bukrs
*                            p_wadat
*                   CHANGING p_certif_fsc.
*
*  DATA: lv_fsc         TYPE zesd_fsc,
*        lv_cod_cert    TYPE zesd_cod_cert,
*        lv_fsc_int     TYPE i,
*        lv_fsc_char(3).
*
*  CLEAR: p_certif_fsc, lv_fsc.
*  CLEAR: lv_fsc_int, lv_fsc_char.
*
*  CALL FUNCTION 'ZSD_PORCENTAJE_FSC'
*    EXPORTING
*      i_datum            = p_wadat
*      i_bukrs            = p_bukrs
*    IMPORTING
*      o_fsc              = lv_fsc
*      o_cod_cert         = lv_cod_cert "CGIJON: 15.03.17 - Ticket ## 25719
*    EXCEPTIONS
*      error_no_exist_fsc = 1
*      OTHERS             = 2.
*  IF sy-subrc <> 0.
** Implement suitable error handling here
*  ELSE.
*    lv_fsc_int = lv_fsc.
*    IF lv_fsc_int <> 0.
*      WRITE lv_fsc_int TO lv_fsc_char.
*      CONDENSE lv_fsc_char.
**     INI CGIJON: 15.03.17 - Ticket ## 25719
**      CONCATENATE 'Certificado SGSCH-COC-060051  FSC Recycled'
**                  lv_fsc_char '%'
**                  INTO p_certif_fsc SEPARATED BY space.
*
*      CONCATENATE lv_cod_cert  ' FSC Recycled'
*                  lv_fsc_char '%' INTO p_certif_fsc SEPARATED BY space.
**     FIN CGIJON: 15.03.17 - Ticket ## 25719
*    ELSE.
*      CLEAR p_certif_fsc.
*    ENDIF.
*
*  ENDIF.

*ENDFORM.                    " CERTIF_FSC_2
*&---------------------------------------------------------------------*
*&      Form  CARGAR_DAT_CLIENTE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_LT_ALBARAN_CABECERA_CABECERA  text
*      <--P_LT_ALBARAN_CABECERA_CLIENTE  text
*----------------------------------------------------------------------*
FORM cargar_dat_cliente  USING    p_bukrs
                                  p_vstel
                                  p_vbeln
                                  ps_dest_mercancia TYPE zstsd_albaran_dir
                         CHANGING ps_cliente TYPE zstsd_albaran_dir.

  DATA: lv_adrnr     TYPE adrnr,
        lv_adrnr_aux TYPE adrnr,
        ls_adrc      TYPE adrc,
        ls_adrc_aux  TYPE adrc,
        lv_kunag     TYPE kunag,
        lv_stceg_aux TYPE stceg.

  CLEAR: ps_cliente, ls_adrc, lv_adrnr, lv_kunag.

* GST - 17/03/2015 ->
*  IF p_bukrs IS NOT INITIAL.
*    SELECT SINGLE adrnr stceg INTO (ps_sociedad-adrnr, ps_sociedad-stceg)
*      FROM t001
*      WHERE bukrs = p_bukrs.
*  ENDIF.
* GST - 17/03/2015 <-

* GST - 17/03/2015 ->
*  IF ps_cliente-adrnr IS INITIAL.
* GST - 17/03/2015 <-
  SELECT SINGLE kunnr INTO lv_kunag
    FROM vbak
*      WHERE vkorg = p_vstel.
    WHERE vbeln = p_vbeln.
* GST - 17/03/2015 ->
*  ELSE.
*    SELECT SINGLE lifnr kunnr INTO (p_lifnr, lv_kunnr)
*      FROM t001w
*      WHERE werks = p_vstel.
*  ENDIF.
* GST - 17/03/2015 <-
  SELECT SINGLE adrnr INTO ps_cliente-adrnr
    FROM kna1
    WHERE kunnr = lv_kunag.

  IF ps_cliente-adrnr IS NOT INITIAL.
    IF ps_cliente-adrnr NE ps_dest_mercancia-adrnr.
      SELECT SINGLE * INTO ls_adrc
        FROM adrc
        WHERE addrnumber = ps_cliente-adrnr.

      IF ls_adrc IS NOT INITIAL.

        MOVE-CORRESPONDING ls_adrc TO ps_cliente.
        TRANSLATE ps_cliente-name1 TO UPPER CASE.
        " Dirección 1:
        CONDENSE: ps_cliente-street, ps_cliente-house_num1.
        IF ps_cliente-house_num1 IS NOT INITIAL.
          CONCATENATE ps_cliente-street ps_cliente-house_num1
                      INTO ps_cliente-direc_1 SEPARATED BY ', '.
        ELSE.
          WRITE ps_cliente-street TO ps_cliente-direc_1.
        ENDIF.
        TRANSLATE ps_cliente-direc_1 TO UPPER CASE.
        " Dirección 2:
        CONDENSE: ps_cliente-post_code1, ps_cliente-city1.
        CONCATENATE ps_cliente-post_code1 ps_cliente-city1
                  INTO ps_cliente-direc_2 SEPARATED BY space.
        TRANSLATE ps_cliente-direc_2 TO UPPER CASE.
        IF ps_cliente-region IS NOT INITIAL.
          TRANSLATE ps_cliente-city1 TO UPPER CASE.
          SELECT SINGLE bezei INTO ps_cliente-bezei
            FROM t005u
            WHERE bland = ls_adrc-region
            AND spras = ls_adrc-langu
            AND land1 = ls_adrc-country.
          TRANSLATE ps_cliente-bezei TO UPPER CASE.
          IF ps_cliente-bezei IS NOT INITIAL AND ps_cliente-bezei NE ps_cliente-city1.
            CONCATENATE ps_cliente-direc_2 ps_cliente-bezei
                        INTO ps_cliente-direc_2 SEPARATED BY ' - '.
          ENDIF.
        ENDIF.
      ENDIF.

      CLEAR: lv_adrnr_aux, ls_adrc_aux, lv_stceg_aux.
      SELECT SINGLE adrnr stceg INTO (lv_adrnr_aux, lv_stceg_aux)
        FROM kna1
        WHERE kunnr = lv_kunag.

      IF lv_adrnr_aux IS NOT INITIAL.
        SELECT SINGLE * INTO ls_adrc_aux
          FROM adrc
          WHERE addrnumber = lv_adrnr_aux.
      ENDIF.


      " Teléfono:
      IF ps_cliente-tel_number IS INITIAL.
        ps_cliente-tel_number = ls_adrc_aux-tel_number.
        CONDENSE ps_cliente-tel_number.
        CONCATENATE 'Telf.:' ps_cliente-tel_number INTO ps_cliente-telf SEPARATED BY space.
      ENDIF.

      " FAX:
      SELECT SINGLE fax_number INTO ps_cliente-fax_number
        FROM adr3
        WHERE addrnumber = ps_cliente-adrnr.

      IF ps_cliente-fax_number IS INITIAL.
        ps_cliente-fax_number = ls_adrc_aux-fax_number.
        CONDENSE ps_cliente-fax_number.
      ENDIF.

      " NIF:
      IF ps_cliente-stceg IS INITIAL.
        ps_cliente-stceg = lv_stceg_aux.
        CONDENSE ps_cliente-stceg.
      ENDIF.
    ENDIF.
  ENDIF.
ENDFORM.                    " CARGAR_DAT_CLIENTE
