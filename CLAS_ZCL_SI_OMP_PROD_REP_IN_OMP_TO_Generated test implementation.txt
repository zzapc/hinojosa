
class ZCL_SI_OMP_PROD_REP_IN_OMP_TO definition
  public
  create public .

public section.

  interfaces ZII_SI_OMP_PROD_REP_IN_OMP_TO .

  data GA_WERKS type WERKS_D value 2001 ##NO_TEXT.

  class-methods DAME_MATERIAL
    importing
      !IV_STR type STRING
      !IV_WERKS type WERKS_D
    changing
      !CV_MATNR type MATNR
    exceptions
      NO_MATERIAL_FOUND
      E_CALIDAD_VACIA
      E_VALOR_EXTERNO
      E_VALOR_SAP
      E_SIN_VALOR
      E_MAT_ZPIM_NOT_FOUND .
  PROTECTED SECTION.
private section.

  types:
    gtyp_ltbk TYPE STANDARD TABLE OF ltbk WITH DEFAULT KEY .
  types:
    gtyp_ltbp TYPE STANDARD TABLE OF ltbp .
  types:
    BEGIN OF treg_log,
        cinumber TYPE lvs_benum,
*
        matnr_1  TYPE string,
        menge_1  TYPE ltbp_menge,
        ok_1     TYPE tbnum,
        ko_1     TYPE bapi_msg,

        matnr_2  TYPE string,
        menge_2  TYPE ltbp_menge,
        ok_2     TYPE tbnum,
        ko_2     TYPE bapi_msg,

        matnr_3  TYPE string,
        menge_3  TYPE ltbp_menge,
        ok_3     TYPE tbnum,
        ko_3     TYPE bapi_msg,

        matnr_4  TYPE string,
        menge_4  TYPE ltbp_menge,
        ok_4     TYPE tbnum,
        ko_4     TYPE bapi_msg,

        matnr_5  TYPE string,
        menge_5  TYPE ltbp_menge,
        ok_5     TYPE tbnum,
        ko_5     TYPE bapi_msg,

        matnr_6  TYPE string,
        menge_6  TYPE ltbp_menge,
        ok_6     TYPE tbnum,
        ko_6     TYPE bapi_msg,

      END OF treg_log .
  types:
    gtyp_log TYPE STANDARD TABLE OF treg_log .

  data GAT_BDCDATA type BDCDATA_TAB .
  constants GAC_NODATA type BDC_FVAL value '/' ##NO_TEXT.
  data GAT_BORRADAS type GTYP_LTBK .
  data GAT_CREADAS type GTYP_LTBK .
  data GAT_MODIFICADAS type GTYP_LTBK .
  data GAT_RETURN type BAPIRET2_T .
  data GA_LGORT type LGORT_D value 1000 ##NO_TEXT.
  data GA_BWART type BWART value 919 ##NO_TEXT.
  data GA_AUFNR type AUFNR .
  data GA_NLPLA01 type LTAP_NLPLA .
  data GA_NLPLA02 type LTAP_NLPLA .
  data GA_NLPLA03 type LTAP_NLPLA .
  data GA_NLPLA04 type LTAP_NLPLA .
  data GA_NLPLA05 type LTAP_NLPLA .
  data GA_LGNUM type LGNUM .
  data GAT_LOG type GTYP_LOG .
  data:
    gac_th(4) value '<th>' ##NO_TEXT.
  data:
    gac_thf(5) value '</th>' ##NO_TEXT.
  data:
    gac_tr(4) value '<tr>' ##NO_TEXT.
  data:
    gac_trf(5) value '</tr>' ##NO_TEXT.
  data:
    gac_td(4) value '<td>' ##NO_TEXT.
  data:
    gac_tdf(5) value '</td>' ##NO_TEXT.
  data GAV_HAY_ERROR type ABAP_BOOL .
  data GT_LTBA type ZCL_WM_CONSTANTS=>GTTY_LTBA_IDX .
  data GT_NT_DAT_UPDATE type GTYP_LTBK .
  data GA_HOURS_RSNUM type UZEIT .

  methods ADJUST_NT_DATE .
  methods ADD_NT_DAT_UPD
    importing
      !IS_LTBK type LTBK .
  methods GET_NT_DAT_UPD
    importing
      !IV_IDX type INT4 optional
      !IV_REMOVE type BOOLEAN default ABAP_FALSE
    returning
      value(RT_LTBK) type GTYP_LTBK .
  methods INIT_NT_DAT_UPD .
  methods BORRA_NECESIDAD
    importing
      !PI_LGNUM type LGNUM
      !PI_TBNUM type TBNUM
    returning
      value(PR_BORRADA) type ABAP_BOOL .
  methods F_BDC_DYNPRO
    importing
      !PE_DYN type BDC_DYNR
      !PE_PROG type BDC_PROG .
  methods F_BDC_FIELD
    importing
      !PE_FNAM type FNAM_____4
      !PE_FVAL type BDC_FVAL .
  methods DAME_TABLA_CREADAS
    changing
      !PT_MESS type SOLI_TAB .
  methods DAME_TABLE_ERROES
    changing
      !PT_MESS type SOLI_TAB .
  methods ERROR_MATERIAL_LOG
    importing
      !PI_SUBRC type SYST_SUBRC
    returning
      value(PC_KO) type BAPI_MSG .
  methods BORRA_NT_ABIERTAS .
  methods CARGA_NT_MODIFICADAS .
  methods CREAR_NTS
    importing
      !PI_INDEX type SY-INDEX
      !IV_STORE_ONLY type BOOLEAN default ABAP_TRUE
      !IT_LTBA type ZCL_WM_CONSTANTS=>GTTY_LTBA optional
    changing
      !PT_LTBK type GTYP_LTBK optional
      !PT_LTBP type GTYP_LTBP optional
      !PC_OK type TBNUM
      !PC_KO type BAPI_MSG .
  methods DAME_HARDCODES .
  methods ENVIA_MAIL_NOTIFICACION .
  methods NOTIFICA_BORRADA
    importing
      !PI_LGNUM type LGNUM
      !PI_TBNUM type TBNUM .
  methods NOTIFICA_MODIFICADA
    importing
      !PI_LTBK type LTBK .
  methods STORE_LTBA
    importing
      !IT_LTBA type ZCL_WM_CONSTANTS=>GTTY_LTBA
      !IV_IDX type SY-TABIX .
  methods RUN_LTBA .
  methods REMOVE_IDX_LTBA
    importing
      !IV_IDX type I .
  methods GET_LTBA
    returning
      value(RT_LTBA) type ZCL_WM_CONSTANTS=>GTTY_LTBA_IDX .
  methods CREATE_RESERVATION
    returning
      value(RV_RSNUM) type BAPI2093_RES_KEY-RESERV_NO .
  methods CHECK_RESERVATION
    importing
      !IT_LTBK type GTYP_LTBK
      !IV_RSNUM type BAPI2093_RES_KEY-RESERV_NO
    returning
      value(RV_CONF) type BOOLEAN .
  methods DELETE_RESERVATION
    importing
      !IV_RSNUM type BAPI2093_RES_KEY-RESERV_NO .
  methods CLOSE_RESERVATION .
endclass. "ZCL_SI_OMP_PROD_REP_IN_OMP_TO definition
class ZCL_SI_OMP_PROD_REP_IN_OMP_TO implementation.
  METHOD add_nt_dat_upd.

    CHECK NOT line_exists( me->gt_nt_dat_update[ lgnum = is_ltbk-lgnum tbnum = is_ltbk-tbnum ] ).
    APPEND is_ltbk TO me->gt_nt_dat_update.
  ENDMETHOD.
  METHOD adjust_nt_date.
    DATA: lt_ltbk TYPE TABLE OF ltbk,
          lt_ltbp TYPE TABLE OF ltbp.
    DATA(lt_ltba) = me->get_ltba( ).
    DATA(lt_nt_dat) = me->get_nt_dat_upd(
*                      iv_idx    =
                      iv_remove = abap_true
                  ).
    CHECK lines( lt_ltba ) > 0 AND lines( lt_nt_dat ) > 0.
    LOOP AT lt_ltba INTO DATA(ls_ltba).
      DATA(lv_idx) = sy-tabix.
      LOOP AT ls_ltba-it_ltba INTO DATA(ls_ltba_lin).
        TRY.
            DATA(ls_ltbk) = lt_nt_dat[ benum = ls_ltba_lin-benum nlpla = ls_ltba_lin-nlpla ] .

            CLEAR lt_ltbk.
            SELECT * FROM ltbk
              INTO CORRESPONDING FIELDS OF TABLE lt_ltbk
              WHERE lgnum = ls_ltbk-lgnum
              AND tbnum = ls_ltbk-tbnum.

            CHECK sy-subrc = 0 AND sy-dbcnt = 1.

            lt_ltbk[ 1 ]-pdatu = ls_ltba_lin-pdatu.
            lt_ltbk[ 1 ]-pzeit = ls_ltba_lin-pzeit.

            " remove from lt_ltba
            me->remove_idx_ltba( iv_idx = lv_idx ).
            DELETE lt_ltba.
            " now change for new date
            CALL FUNCTION 'L_TR_CHANGE_INTERN'
              TABLES
                iltbk = lt_ltbk     " Transfer requirement headers
                iltbp = lt_ltbp.    " Transfer requirement items
          CATCH cx_root.
        ENDTRY.
      ENDLOOP.
    ENDLOOP.
  ENDMETHOD.
  METHOD borra_necesidad.
    DATA: ls_opt TYPE ctu_params,
          lt_msg TYPE TABLE OF bdcmsgcoll,
          lv_aux TYPE bdc_fval.

    REFRESH gat_bdcdata.
    CLEAR pr_borrada.

    ls_opt-nobinpt = abap_true.
    ls_opt-dismode = 'N'.

    f_bdc_dynpro( EXPORTING pe_prog = 'SAPML02B' pe_dyn = '0100').
    f_bdc_field( EXPORTING pe_fnam = 'BDC_CURSOR' pe_fval = 'LTBK-TBNUM' ).
    f_bdc_field( EXPORTING pe_fnam = 'BDC_OKCODE' pe_fval ='/00' ).
    MOVE pi_lgnum TO lv_aux.
    f_bdc_field( EXPORTING pe_fnam = 'LTBK-LGNUM' pe_fval = lv_aux ).
    MOVE pi_tbnum TO lv_aux.
    f_bdc_field( EXPORTING pe_fnam = 'LTBK-TBNUM' pe_fval = lv_aux ).

    f_bdc_dynpro( EXPORTING pe_prog = 'SAPML02B' pe_dyn = '1103').
    f_bdc_field( EXPORTING pe_fnam = 'BDC_OKCODE' pe_fval = '=DLK' ).

    f_bdc_dynpro( EXPORTING pe_prog = 'SAPLSPO1' pe_dyn = '0400').
    f_bdc_field( EXPORTING pe_fnam = 'BDC_OKCODE' pe_fval = '=YES' ).

    CALL TRANSACTION 'LB02' USING gat_bdcdata OPTIONS FROM ls_opt MESSAGES INTO lt_msg .

    LOOP AT lt_msg INTO DATA(ls_msg) WHERE msgtyp = 'E'.

      CLEAR pr_borrada.

    ENDLOOP.
    IF sy-subrc NE 0.
      pr_borrada = abap_true.
    ENDIF.
  ENDMETHOD.
  METHOD borra_nt_abiertas.

    DATA lt_rsnum TYPE TABLE OF rsnum.
    DATA lt_rsnum_cls TYPE TABLE OF rsnum.
    DATA: lt_ltbk  TYPE gtyp_ltbk,
          lt_ltbp  TYPE gtyp_ltbp,
          ls_ltbc  TYPE ltbc,
          lv_canc  TYPE abap_bool,
          lt_ltbc  TYPE STANDARD TABLE OF ltbc,
          ls_ltbk  TYPE ltbk,
          ls_modif TYPE ltbk,
          lv_ok    TYPE abap_bool.
    DATA: ls_ecm_bobine TYPE zwm_ecm_bobine,
          zid_bob_ecm   TYPE zwm_ecm_bobine-id_bob_ecm.
    IF lv_canc IS NOT INITIAL.

      SELECT * FROM ltbp
        INTO CORRESPONDING FIELDS OF TABLE lt_ltbp
        WHERE lgnum = ga_lgnum AND
              elikz = space AND
              werks = ga_werks . "AND
* ESTABA PUESTO CHARG /    LGORT = GA_LGORT .

      IF lt_ltbp IS NOT INITIAL.
        SELECT *
          FROM ltbk
          INTO CORRESPONDING FIELDS OF TABLE lt_ltbk
          FOR ALL ENTRIES IN lt_ltbp
          WHERE lgnum EQ lt_ltbp-lgnum AND
                tbnum EQ lt_ltbp-tbnum .

      ENDIF.

    ELSE.
* seleccionamos las NT abiertas y no modificadas!!!
      SELECT *
        FROM ltbk
        INTO CORRESPONDING FIELDS OF TABLE lt_ltbk
        WHERE lgnum = ga_lgnum AND
              statu = space AND
              betyp = 'O' AND
              tbpri EQ ' '.
* HLB 05/12/2019* NO SELECCIONAMOS A TRATAR AQUELLAS RESERVAS QUE ESTAN SIENDO TRATADAS EN PANTALLA

      LOOP AT lt_ltbk INTO ls_ltbk.
        CLEAR zid_bob_ecm.
        zid_bob_ecm(10) = ls_ltbk-rsnum.
        SELECT SINGLE * FROM zwm_ecm_bobine
          INTO  ls_ecm_bobine
           WHERE id_bob_ecm = zid_bob_ecm.
        IF sy-subrc = 0.
*          SELECT DISTINCT sgtxt FROM resb
*            INTO TABLE @DATA(lt_resb) WHERE rsnum = @ls_ltbk-rsnum.
*          LOOP AT lt_resb INTO DATA(ls_resb).
*            ls_ltbk-benum = ls_resb-sgtxt.
*            DELETE lt_ltbk WHERE benum = ls_ltbk-benum.
*          ENDLOOP.
          LOOP AT lt_ltbk INTO DATA(ls_ltbk_aux) WHERE
            rsnum = ls_ltbk-rsnum.
            me->add_nt_dat_upd( is_ltbk = CORRESPONDING #( ls_ltbk_aux ) ).
            DELETE lt_ltbk.
          ENDLOOP.
        ENDIF.
      ENDLOOP.
* END HLB 05/12/2019

* miramos que las necesidades no sean del mismo ID de trabajo que las modificadas
      LOOP AT gat_modificadas INTO ls_modif.
        "LOOP AT lt_ltbk INTO ls_ltbk WHERE benum = ls_modif-benum. " - KYV - 20191218 - RDM
        LOOP AT lt_ltbk INTO ls_ltbk WHERE rsnum = ls_modif-rsnum. " + KYV - 20191218 - RDM
          DELETE lt_ltbk INDEX sy-tabix.
        ENDLOOP.
      ENDLOOP.

    ENDIF.

    LOOP AT lt_ltbk INTO ls_modif.

      " only delete if reservation is not confirmed
      IF ls_modif-rsnum IS NOT INITIAL.

        IF me->check_reservation( it_ltbk = lt_ltbk iv_rsnum = ls_modif-rsnum ) = abap_false.
          APPEND ls_modif-rsnum TO lt_rsnum.
        ELSE.
          "KYV / RDM - 20200214
          IF zcl_wm_nt_generic=>is_reserv_closable( iv_rsnum = ls_modif-rsnum iv_hours_to_check = ga_hours_rsnum ) = abap_true.
            APPEND ls_modif-rsnum TO lt_rsnum_cls.
          ENDIF.
          "KYV / RDM - 20200214
          CONTINUE.
        ENDIF.

      ENDIF.


      lv_ok =  borra_necesidad( EXPORTING pi_lgnum = ls_modif-lgnum
                                          pi_tbnum = ls_modif-tbnum ).

      IF lv_ok IS NOT INITIAL.
        REFRESH lt_ltbc.

        SELECT *
          FROM ltbp
          INTO CORRESPONDING FIELDS OF TABLE lt_ltbp
          WHERE lgnum = ls_modif-lgnum AND
                tbnum = ls_modif-tbnum.

        LOOP AT lt_ltbp ASSIGNING FIELD-SYMBOL(<ls>).

          MOVE-CORRESPONDING <ls> TO ls_ltbc.

          APPEND ls_ltbc TO lt_ltbc.

        ENDLOOP.

        IF lt_ltbc IS NOT INITIAL.

          CALL FUNCTION 'L_TR_CANCEL'
            EXPORTING
              i_save_only_all      = 'X'
*             i_update_task        =
              i_commit_work        = 'X'
            TABLES
              t_ltbc               = lt_ltbc
            EXCEPTIONS
              item_error           = 1
              no_update_item_error = 2
              no_update_no_entry   = 3
              tr_locked            = 4
              OTHERS               = 5.
          IF sy-subrc <> 0.
* Implement suitable error handling here
          ELSE.
            LOOP AT lt_ltbc INTO ls_ltbc.

              notifica_borrada( EXPORTING pi_lgnum = ls_ltbc-lgnum
                                          pi_tbnum = ls_ltbc-tbnum ).
            ENDLOOP.
          ENDIF.


        ENDIF.
      ELSE.
        notifica_borrada( EXPORTING pi_lgnum = ls_modif-lgnum
                            pi_tbnum = ls_modif-tbnum ).
      ENDIF.

    ENDLOOP.


    " now must delete the reservation
    SORT lt_rsnum.
    DELETE ADJACENT DUPLICATES FROM lt_rsnum COMPARING ALL FIELDS.
    LOOP AT lt_rsnum INTO DATA(lv_rsnum).
      me->delete_reservation( iv_rsnum = lv_rsnum ).
    ENDLOOP.

    " KYV - 20200214 - close rsnum
    SORT lt_rsnum_cls.
    DELETE ADJACENT DUPLICATES FROM lt_rsnum_cls COMPARING ALL FIELDS.
    LOOP AT lt_rsnum_cls INTO lv_rsnum.
      zcl_wm_nt_generic=>change_reserv_4_cons(
        EXPORTING
*          iv_bobine =
*          is_ltbk   =
*          iv_qty    =
*          iv_meins  =
          iv_rsnum  = lv_rsnum
          iv_close  = abap_true
      ).
    ENDLOOP.
" KYV - 20200214 - close rsnum
  ENDMETHOD.
  METHOD carga_nt_modificadas.

    DATA: lt_ltbk  TYPE gtyp_ltbk,
          ls_ltbk  TYPE ltbk,
          lv_rsnum TYPE resb-rsnum.

* seleccionamos las NT abiertas y no modificadas!!!
    SELECT *
      FROM ltbk
      INTO CORRESPONDING FIELDS OF TABLE lt_ltbk
      WHERE lgnum = ga_lgnum AND
            statu NE space AND
            betyp = 'O'
            AND rsnum <> lv_rsnum." + KYV - 20191218 - RDM
* HAY QUE AÑADIR UNA FRANJA TEMPORAL EN ESTA SELECCIÓN PARA EVITAR GRANDES VOLÚMENES EN EL FUTURO.
* HLB 09/12/2019 NO SELECCIONABA MODIFICADAS POR STATUS CONTRADICTORIO
*            betyp = 'O' AND
*            ( statu NE ' ' OR  " SI SE HA TRATADO LA NT 919
*            tbpri NE ' ' ). " SI SE HA AJUSTADO CON MATERIAL DIFERENTE
* FIN HLB 09/12/2019 NO SELECCIONABA MODIFICADAS POR STATUS CONTRADICTORIO

    IF lt_ltbk[] IS NOT INITIAL.
      SELECT *
      FROM ltbk
      APPENDING TABLE lt_ltbk
      FOR ALL ENTRIES IN lt_ltbk
      WHERE lgnum = lt_ltbk-lgnum AND
            "benum = lt_ltbk-benum. " - KYV - 20191218 - RDM
            rsnum = lt_ltbk-rsnum. " + KYV - 20191218 - RDM
    ENDIF.

    LOOP AT lt_ltbk INTO ls_ltbk.

      " RDM - 20191211 - store for date update BEG
      IF ls_ltbk-statu = 'T'.
        me->add_nt_dat_upd( is_ltbk = CORRESPONDING #( ls_ltbk ) ).
        notifica_modificada( EXPORTING pi_ltbk = ls_ltbk ). " RDM - 20200522
      ENDIF.
      " RDM - 20191211 - END
      "notifica_modificada( EXPORTING pi_ltbk = ls_ltbk ).  " RDM - 20200522


    ENDLOOP.

  ENDMETHOD.
  METHOD check_reservation.
    rv_conf = abap_false.

    DATA(ls_ltbk) = it_ltbk[ 1 ].
    SELECT lgnum, tbnum
    FROM ltbk
    INTO TABLE @DATA(lt_ltbk)
    WHERE lgnum = @ls_ltbk-lgnum
    AND rsnum = @iv_rsnum.

    LOOP AT lt_ltbk INTO DATA(ls_ltbk_key).
      CHECK NOT line_exists( it_ltbk[ lgnum = ls_ltbk_key-lgnum tbnum = ls_ltbk_key-tbnum ] ).
      rv_conf = abap_true.
      EXIT.
    ENDLOOP.


  ENDMETHOD.
  METHOD close_reservation.
    DATA lv_end_date TYPE datum.
    DATA lv_end_time TYPE uzeit.

    DATA(lv_init_time) = ga_hours_rsnum.

    CHECK lv_init_time IS NOT INITIAL.

    SELECT a~rsnum, MAX( b~bdatu ) AS last_date, MAX( b~bzeit ) AS last_time
      FROM resb AS a
      INNER JOIN ltbk AS b
      ON a~rsnum = b~rsnum
      INTO TABLE @DATA(lt_resb)
      WHERE b~statu = 'E'
      AND a~kzear = @abap_false
      AND a~werks = @ga_werks
      AND b~lgnum = @ga_lgnum
      AND NOT EXISTS ( SELECT tbnum FROM ltbk WHERE rsnum = a~rsnum AND statu <> 'E' AND lgnum = @ga_lgnum )
      GROUP BY a~rsnum, a~rspos.

    CHECK sy-subrc = 0.

    LOOP AT lt_resb INTO DATA(ls_resb).
      DO.
        DATA(lv_uzeit) = COND t( WHEN lv_init_time > '240000' THEN '240000' ELSE lv_init_time ).
        lv_init_time = lv_init_time - lv_uzeit.
        ls_resb-last_time = COND #( WHEN lv_end_time IS INITIAL THEN ls_resb-last_time ELSE lv_end_time ).
        ls_resb-last_date = COND #( WHEN lv_end_date IS INITIAL THEN ls_resb-last_date ELSE lv_end_date ).

        CALL FUNCTION 'C14B_ADD_TIME'
          EXPORTING
            i_starttime = ls_resb-last_time
            i_startdate = ls_resb-last_date
            i_addtime   = lv_uzeit
          IMPORTING
            e_endtime   = lv_end_time
            e_enddate   = lv_end_date.

        IF lv_init_time IS INITIAL.
          EXIT.
        ENDIF.

      ENDDO.

      CHECK: lv_end_date < sy-datum OR ( lv_end_date = sy-datum AND lv_end_time <= sy-uzeit ).

      zcl_wm_nt_generic=>change_reserv_4_cons(
        EXPORTING
*          iv_bobine =
*          is_ltbk   =
*          iv_qty    =
*          iv_meins  =
          iv_rsnum  = ls_resb-rsnum
          iv_close  = abap_true
      ).


    ENDLOOP.


  ENDMETHOD.
  METHOD crear_nts.
    DATA: lt_ltba TYPE STANDARD TABLE OF ltba,
          ls_ltba TYPE ltba,
          ls_ltbk TYPE ltbk,
          ls_ltbp TYPE ltbp,
          lv_mess TYPE bapi_msg,
          ls_ret  TYPE bapiret2.

    IF it_ltba IS NOT SUPPLIED.
      READ TABLE pt_ltbk INTO ls_ltbk INDEX 1.
      IF sy-subrc EQ 0.
        MOVE-CORRESPONDING ls_ltbk TO ls_ltba.

        LOOP AT pt_ltbp INTO ls_ltbp.
          MOVE-CORRESPONDING ls_ltbp TO ls_ltba.
          ls_ltba-menga = ls_ltbp-menge.
          ls_ltba-altme = ls_ltbp-meins.
          ls_ltba-lgort = ga_lgort.
          ls_ltba-bwlvs = ga_bwart.
          ls_ltba-nlpla = ls_ltbk-nlpla.
          ls_ltba-betyp = 'O'.
          APPEND ls_ltba TO lt_ltba.
        ENDLOOP.

      ENDIF.
    ELSE.
      lt_ltba = it_ltba.
    ENDIF.

    IF iv_store_only = abap_true.

      me->store_ltba( it_ltba = lt_ltba iv_idx = pi_index ).
      sy-subrc = 0.
      RETURN.
    ENDIF.

    CALL FUNCTION 'L_TR_CREATE'
      EXPORTING
        i_single_item         = 'X'
        i_save_only_all       = 'X'
*       I_UPDATE_TASK         =
        i_commit_work         = 'X'
      TABLES
        t_ltba                = lt_ltba
      EXCEPTIONS
        item_error            = 1
        no_entry_in_int_table = 2
        item_without_number   = 3
        no_update_item_error  = 4
        OTHERS                = 5.

    IF sy-subrc <> 0.

      LOOP AT lt_ltba INTO ls_ltba.
        CALL FUNCTION 'BAPI_MESSAGE_GETDETAIL'
          EXPORTING
            id         = ls_ltba-msgid
            number     = ls_ltba-msgno
            language   = sy-langu
            textformat = 'RTF'
            message_v1 = ls_ltba-msgv1
            message_v2 = ls_ltba-msgv2
            message_v3 = ls_ltba-msgv3
            message_v4 = ls_ltba-msgv4
          IMPORTING
            message    = lv_mess.

        CONCATENATE pc_ko lv_mess INTO pc_ko SEPARATED BY space.
        gav_hay_error = abap_true.
      ENDLOOP.

    ELSE.
      LOOP AT lt_ltba INTO ls_ltba WHERE tbnum IS NOT INITIAL.

        pc_ok = ls_ltba-tbnum.

      ENDLOOP.

    ENDIF.

  ENDMETHOD.
  METHOD create_reservation.
    DATA ls_log      TYPE treg_log.
    DATA lt_item TYPE zcl_wm_constants=>gtty_res_item.

    DATA ls_ltba_kg TYPE ltba.
    DATA lt_ret TYPE bapiret2_tab.

    " 1st just change the dates for the nt's not deleted
    me->adjust_nt_date( ).
    DATA(lt_ltba) = me->get_ltba( ).

    CLEAR rv_rsnum.
    " must group ltba values
    DATA(lt_ltba_grp) = zcl_wm_nt_generic=>get_instance(
*        iv_langu = SY-LANGU
    )->group_ltba( it_ltba = lt_ltba  ).

    CHECK lines( lt_ltba_grp ) > 0.

    " for each line, create a reservation
    LOOP AT lt_ltba_grp INTO DATA(ls_grp).
      CLEAR lt_item.
      LOOP AT ls_grp-it_ltba_idx INTO DATA(ls_ltba_idx).
        LOOP AT ls_ltba_idx-it_ltba INTO DATA(ls_ltba).
          ls_ltba_kg = ls_ltba.
          ls_ltba_kg-altme = 'KG'.

          " must convert to KG
          CALL FUNCTION 'MATERIAL_CONVERT_QUANTITY'
            EXPORTING
              pi_material_src    = ls_ltba_kg-matnr   " Source Material
              pi_meinh_src       = 'M'
*             pi_meins_src       =
              pi_quantity_src    = ls_ltba-menga
              pi_material_dst    = ls_ltba_kg-matnr   " Target Material
              pi_meinh_dst       = ls_ltba_kg-altme
*             pi_meins_dst       =
            IMPORTING
              pe_quantity_dst    = ls_ltba_kg-menga
*             pe_meinh_dst       =
*             pe_meins_dst       =
            EXCEPTIONS
              wrong_call         = 1
              material_not_found = 2
              no_conversion      = 3
              OTHERS             = 4.
          APPEND VALUE #(
          material = ls_ltba-matnr
          plant = ls_ltba-werks
          stge_loc = ls_ltba-lgort
          entry_qnt = ls_ltba_kg-menga
          entry_uom = ls_ltba_kg-altme
          movement = abap_true
          item_text = ls_ltba-benum
          ) TO lt_item.
        ENDLOOP.
      ENDLOOP.
      zcl_wm_nt_generic=>create_reserv(
        EXPORTING
          is_header = VALUE #( move_type = zcl_wm_constants=>gc_bwart_291 orderid = ga_aufnr res_date = sy-datum )
          it_item   = lt_item
*            iv_commit = ABAP_TRUE
        IMPORTING
          es_rsnum  = ls_grp-rsnum
          et_ret    = lt_ret
      ).
      " KYV - RDM - 20200220 - LOG BEG
      CLEAR ls_log.
      DATA(lv_nlpla_idx) = ls_grp-nlpla+3. " KYV - 20200210
      DATA(lv_ok) = 'OK_' && lv_nlpla_idx.
      DATA(lv_nok) = 'KO_' && lv_nlpla_idx.
      DATA(lv_menge) = 'MENGE_' && lv_nlpla_idx.
      DATA(lv_matnr) = 'MATNR_' && lv_nlpla_idx.
      ASSIGN COMPONENT lv_ok OF STRUCTURE ls_log TO FIELD-SYMBOL(<fs_ok>).
      ASSIGN COMPONENT lv_nok OF STRUCTURE ls_log TO FIELD-SYMBOL(<fs_nok>).
      ASSIGN COMPONENT lv_matnr OF STRUCTURE ls_log TO FIELD-SYMBOL(<fs_matnr>).
      ASSIGN COMPONENT lv_menge OF STRUCTURE ls_log TO FIELD-SYMBOL(<fs_menge>).
      <fs_matnr> = ls_grp-matnr.
      <fs_menge> = lt_item[ 1 ]-entry_qnt.
      ls_log-cinumber = lt_item[ 1 ]-item_text.
      IF ls_grp-rsnum IS INITIAL.
        <fs_nok> = |{ text-020 } { ls_grp-nlpla } { ls_grp-matnr }|.
        APPEND ls_log TO gat_log.
        LOOP AT lt_ret INTO DATA(ls_ret) WHERE type CA 'XAE'.
          <fs_nok> = ls_ret-message.
          APPEND ls_log TO gat_log.
        ENDLOOP.

        CONTINUE.
      ELSE.
        <fs_ok> = ls_grp-rsnum . "|{ text-021 } { ls_grp-rsnum } { ls_grp-nlpla } { ls_grp-matnr }|.
        APPEND ls_log TO gat_log.
      ENDIF.

*      IF ls_grp-rsnum IS INITIAL.
*        CONTINUE.
*      ENDIF.
      " KYV - RDM - 20200220 - LOG END

      MODIFY lt_ltba_grp FROM ls_grp
      TRANSPORTING rsnum.

      " now create nt's
      LOOP AT ls_grp-it_ltba_idx INTO ls_ltba_idx.
        DATA(lv_idx) = sy-tabix.
        CLEAR ls_log.
        ls_ltba-rsnum = ls_grp-rsnum.
        MODIFY ls_ltba_idx-it_ltba
        FROM ls_ltba
        TRANSPORTING rsnum
        WHERE nlpla IS NOT INITIAL.

        " set rspos
        LOOP AT ls_ltba_idx-it_ltba ASSIGNING FIELD-SYMBOL(<fs_ltba_idx>).
          <fs_ltba_idx>-rspos = lv_idx.
        ENDLOOP.


        " KYV - RDM - 20200220 - LOG BEG
        CHECK sy-subrc = 0.
        CLEAR ls_log.
        lv_nlpla_idx = ls_ltba_idx-it_ltba[ 1 ]-nlpla+3.
        lv_ok = 'OK_' && lv_nlpla_idx.
        lv_nok = 'KO_' && lv_nlpla_idx.
        lv_menge = 'MENGE_' && lv_nlpla_idx.
        lv_matnr = 'MATNR_' && lv_nlpla_idx.
        ASSIGN COMPONENT lv_ok OF STRUCTURE ls_log TO <fs_ok>.
        ASSIGN COMPONENT lv_nok OF STRUCTURE ls_log TO <fs_nok>.
        ASSIGN COMPONENT lv_matnr OF STRUCTURE ls_log TO <fs_matnr>.
        ASSIGN COMPONENT lv_menge OF STRUCTURE ls_log TO <fs_menge>.
        <fs_matnr> = ls_ltba_idx-it_ltba[ 1 ]-matnr.
        <fs_menge> = ls_ltba_idx-it_ltba[ 1 ]-menga.
        ls_log-cinumber = ls_ltba_idx-it_ltba[ 1 ]-benum. "KYV/RDM - 20200526
        " KYV - RDM - 20200220 - LOG END
        me->crear_nts(
          EXPORTING
            pi_index      =  ls_ltba_idx-idx   " ABAP System Field: Loop Index
            iv_store_only = abap_false
            it_ltba       = ls_ltba_idx-it_ltba
        CHANGING
*            pc_ok = ls_log-ok_1
*            pc_ko = ls_log-ko_1   " Message Text
            pc_ok = <fs_ok>
            pc_ko = <fs_nok>   " Message Text
        ).
        " KYV - RDM - 20200220 - LOG - BEG
        IF <fs_nok> IS NOT INITIAL.
          gav_hay_error = abap_true.
        ENDIF.
        APPEND ls_log TO gat_log.
        " KYV - RDM - 20200220 - LOG - BEG
      ENDLOOP.
    ENDLOOP.





  ENDMETHOD.
  METHOD dame_hardcodes.
    CONSTANTS: lc_int TYPE repid VALUE 'INTF_OMP_PACS'.
    DATA: lt_hard TYPE STANDARD TABLE OF ztwm001.


    SELECT *
      FROM ztwm001
      INTO CORRESPONDING FIELDS OF TABLE lt_hard
      WHERE cprog = lc_int.
*       AND
*            param2 = '01'.

    LOOP AT lt_hard ASSIGNING FIELD-SYMBOL(<h>).
      IF <h>-param1 = 'BWART' AND <h>-param2 = '01'.
        ga_bwart = <h>-valor1.
      ELSEIF <h>-param1 = 'LGORT' AND <h>-param2 = '01'.
        ga_lgort = <h>-valor1.
      ELSEIF <h>-param1 = 'WERKS'  AND <h>-param2 = '01'.
        ga_werks = <h>-valor1 .
      ELSEIF <h>-param1 = 'LGNUM'  AND <h>-param2 = '01'.
        ga_lgnum = <h>-valor1.
      ELSEIF <h>-param1 = 'NLPLA'.
        DATA(lv_field) = 'GA_NLPLA' && <h>-param2.
        ASSIGN (lv_field) TO FIELD-SYMBOL(<fs_nlpla>).
        CHECK sy-subrc = 0.
        <fs_nlpla> = <h>-valor1.
      ELSEIF <h>-param1 = 'AUFNR'  AND <h>-param2 = '01'.
        ga_aufnr = <h>-valor1.
      ELSEIF <h>-param1 =  'HOURS_FOR_RSNUM_CLOSE'  AND <h>-param2 = '01'.
        ga_hours_rsnum(2) = <h>-valor1.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.
  METHOD dame_material.
    DATA: lt_str           TYPE TABLE OF string,
          lv_str           TYPE string,
          lv_matnr         TYPE matnr,
          lv_cal(3),
          lv_grama         TYPE zgramaje,
          lv_ancho         TYPE zancho,
          lv_val_ext       TYPE zedpi0005,
          lv_valor_sap     TYPE zedpi0004,
          lv_matkl         TYPE matkl,
          lv_mtart         TYPE mtart,
          lt_mara          TYPE STANDARD TABLE OF mara,
          number           TYPE tbtcjob-jobcount,
          name             TYPE tbtcjob-jobname VALUE 'CREAR_MATERIAL_OMP_REPLENISHMENT',
          print_parameters TYPE pri_params.

    IF iv_str IS NOT INITIAL.

      SPLIT iv_str AT '/' INTO TABLE lt_str.

      LOOP AT lt_str ASSIGNING FIELD-SYMBOL(<l>).
        CASE sy-tabix.
          WHEN '1'.
            IF <l> EQ 'PAP'.
              lv_mtart = 'ZPAP'.
            ENDIF.
          WHEN '2'.
            SPLIT <l> AT space INTO lv_cal lv_grama.
            IF lv_grama NE space.
              CONDENSE: lv_cal.
              CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
                EXPORTING
                  input  = lv_grama
                IMPORTING
                  output = lv_grama.

            ELSE.
*             sera preimpreso?
              CLEAR: lv_cal, lv_grama.
              lv_mtart = 'ZPIM'.
              CONCATENATE 'P0' <l> '%' INTO lv_matnr.
            ENDIF.
          WHEN '3'.
            MOVE <l> TO lv_ancho. CONDENSE lv_ancho.
          WHEN OTHERS .
        ENDCASE.

      ENDLOOP.

      IF lv_cal IS NOT INITIAL.
        SELECT SINGLE valor_externo
          FROM ztpi0013
          INTO lv_val_ext
          WHERE calidad = lv_cal.

        IF sy-subrc EQ 0.
          SELECT SINGLE zvalor_sap
            FROM ztpi0003
            INTO lv_valor_sap
            WHERE zcodigo = '5' AND
                  werks = iv_werks AND
                  zvalor_externo = lv_val_ext.

          IF sy-subrc EQ 0.
            MOVE lv_valor_sap TO lv_matkl.

            SELECT SINGLE mara~matnr FROM mara
              INNER JOIN marc
              ON mara~matnr = marc~matnr
              INNER JOIN mard
              ON mara~matnr = mard~matnr
              AND marc~werks = mard~werks
              INTO lv_matnr
              WHERE matkl = lv_matkl AND
                    zzgramaje = lv_grama AND
                    zzancho = lv_ancho
                    AND marc~werks = iv_werks
                    AND mard~lgort = '1000' .

            IF sy-subrc EQ 0.
              cv_matnr = lv_matnr.
            ELSE. " cvivo - 61212 creación auto
              CALL FUNCTION 'JOB_OPEN'
                EXPORTING
                  jobname          = name
                IMPORTING
                  jobcount         = number
                EXCEPTIONS
                  cant_create_job  = 1
                  invalid_job_data = 2
                  jobname_missing  = 3
                  OTHERS           = 4.
              IF sy-subrc = 0.
                SUBMIT zrmm0022 WITH p_matnr EQ space " creación sin código material
                    WITH p_werks EQ iv_werks
                    WITH p_matkl EQ lv_matkl
                    WITH s_grama EQ lv_grama
                    WITH s_ancho EQ lv_ancho
                    WITH p_fondo EQ 'X'
                    TO SAP-SPOOL
                    SPOOL PARAMETERS print_parameters
                    WITHOUT SPOOL DYNPRO
                    VIA JOB name NUMBER number
                    AND RETURN.
                IF sy-subrc = 0.
                  CALL FUNCTION 'JOB_CLOSE'
                    EXPORTING
                      jobcount             = number
                      jobname              = name
                      strtimmed            = 'X'
                    EXCEPTIONS
                      cant_start_immediate = 1
                      invalid_startdate    = 2
                      jobname_missing      = 3
                      job_close_failed     = 4
                      job_nosteps          = 5
                      job_notex            = 6
                      lock_failed          = 7
                      OTHERS               = 8.

                  WAIT UP TO 3 SECONDS.
                ENDIF.
              ENDIF.

              SELECT SINGLE mara~matnr FROM mara " volvemos a intentarlo
                INNER JOIN marc
                ON mara~matnr = marc~matnr
                INNER JOIN mard
                ON mara~matnr = mard~matnr
                AND marc~werks = mard~werks
                INTO lv_matnr
                WHERE matkl = lv_matkl AND
                zzgramaje = lv_grama AND
                zzancho = lv_ancho
                AND marc~werks = iv_werks
                AND mard~lgort = '1000' .

              IF sy-subrc NE 0.
                RAISE no_material_found.
              ELSE.
                cv_matnr = lv_matnr.
              ENDIF.
            ENDIF.
          ELSE.
            RAISE e_valor_sap.
          ENDIF.
        ELSE.
          RAISE e_valor_externo.
        ENDIF.
      ELSE.
        IF lv_matnr IS NOT INITIAL.
          SELECT mara~*
            FROM mara INNER JOIN marc
            ON mara~matnr = marc~matnr
            INTO CORRESPONDING FIELDS OF TABLE @lt_mara
            WHERE mara~matnr LIKE @lv_matnr
            AND marc~werks = @iv_werks.

          " KYV/RDM - 20200521
          IF sy-subrc EQ 0.
            CLEAR lv_matnr.

            LOOP AT lt_mara ASSIGNING FIELD-SYMBOL(<ls>).
              MOVE <ls>-matnr+6(4) TO lv_grama.
              MOVE <ls>-matnr+10(4) TO lv_ancho.
              IF lv_grama EQ <ls>-zzgramaje AND lv_ancho EQ <ls>-zzancho.
                lv_matnr = <ls>-matnr.
                EXIT.
              ENDIF.
            ENDLOOP.
            IF lv_matnr IS INITIAL.
              RAISE e_mat_zpim_not_found.
            ELSE.
              cv_matnr = lv_matnr.
            ENDIF.
          ENDIF.
        ELSE.
          RAISE e_calidad_vacia.
        ENDIF.
      ENDIF.
    ELSE.
      RAISE e_sin_valor.
    ENDIF.
  ENDMETHOD.
  METHOD dame_tabla_creadas.
    DATA: lv_aux     TYPE string,
          lt_message TYPE soli_tab,
          ls_log     TYPE treg_log,
          ls_message TYPE soli.

    ls_message-line = '<b> <u>Â·<p> Resumen de NTs creadas por cinumber </b> </u/> </p>'.
    APPEND ls_message TO lt_message.

    CONCATENATE '<table style="width:100%">' gac_tr
                gac_th 'CInumber' gac_thf
                gac_th 'PaperStation' gac_thf
                gac_th 'NT' gac_thf
                gac_th 'Material' gac_thf
                gac_th 'Cantidad' gac_thf gac_trf
                INTO ls_message-line.
    APPEND ls_message TO lt_message.

    "KYV/RDM - 20200526
    SORT gat_log BY cinumber ok_1 DESCENDING ok_2 DESCENDING ok_3 DESCENDING ok_4 DESCENDING
    ok_5 DESCENDING.

    LOOP AT gat_log INTO ls_log.
      CLEAR ls_message.
      IF ls_log-ok_1 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation1' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ok_1 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_1 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_1 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ok_2 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation2' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ok_2 gac_tdf    INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_2 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_2 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ok_3 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation3' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ok_3 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_3 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_3 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ok_4 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation4' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ok_4 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_4 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_4 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ok_5 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation5' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ok_5 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_5 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_5 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ok_6 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation6' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ok_6 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_6 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_6 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.

    ENDLOOP.
    ls_message-line = '</table>'.
    APPEND ls_message TO lt_message.

    APPEND LINES OF lt_message TO pt_mess.

  ENDMETHOD.
  METHOD dame_table_erroes.
    DATA: ls_message TYPE soli,
          lt_message TYPE soli_tab,
          ls_log     TYPE treg_log,
          lv_aux     TYPE string.

    ls_message-line = '<b> <u>Â·<p> Resumen de errores por cinumber </b> </u/> </p>'.
    APPEND ls_message TO lt_message.

    CONCATENATE '<table style="width:100%">' gac_tr
                gac_th 'CInumber' gac_thf
                gac_th 'PaperStation' gac_thf
                gac_th 'Error' gac_thf
                gac_th 'Material' gac_thf
                gac_th 'Cantidad' gac_thf gac_trf
                INTO ls_message-line.
    APPEND ls_message TO lt_message.

    LOOP AT gat_log INTO ls_log.
      CLEAR ls_message.
      IF ls_log-ko_1 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation1' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ko_1 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_1 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_1 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ko_2 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation2' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ko_2 gac_tdf    INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_2 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_2 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ko_3 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation3' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ko_3 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_3 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_3 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ko_4 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation4' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ko_4 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_4 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_4 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ko_5 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation5' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ko_5 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_5 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_5 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.
      IF ls_log-ko_6 IS NOT INITIAL.
        CONCATENATE gac_tr gac_td ls_log-cinumber gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td 'PaperStation6' gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-ko_6 gac_tdf INTO ls_message-line.
        CONCATENATE ls_message-line gac_td ls_log-matnr_6 gac_tdf INTO ls_message-line.
        MOVE ls_log-menge_6 TO lv_aux. CONDENSE lv_aux.
        CONCATENATE ls_message-line gac_td lv_aux gac_tdf gac_trf INTO ls_message-line.
        APPEND ls_message TO lt_message.
      ENDIF.

    ENDLOOP.
    ls_message-line = '</table>'.
    APPEND ls_message TO lt_message.

    APPEND LINES OF lt_message TO pt_mess.
  ENDMETHOD.
  METHOD delete_reservation.
    DATA ls_log      TYPE treg_log.

    DATA(lt_ret) = zcl_wm_nt_generic=>delete_reserv(
      EXPORTING
        iv_rsnum  = iv_rsnum
        iv_commit = abap_true
    ).

    ls_log-ko_1 = |{ text-022 } { iv_rsnum }|.

    LOOP AT lt_ret INTO DATA(ls_ret) WHERE type CA 'XAE'.
      IF ls_log IS NOT INITIAL.
        APPEND ls_log TO gat_log.
      ENDIF.
      ls_log-ko_1 = ls_ret-message.
      APPEND ls_log TO gat_log.
      CLEAR ls_log.
      gav_hay_error = abap_true.
    ENDLOOP.
    "check sy-subrc = 0. "KYV/RDM - 20200710
    CHECK sy-subrc NE 0. "KYV/RDM - 20200710

    CLEAR ls_log.
    ls_log-ok_1 = |{ text-023 } { iv_rsnum }|.
    APPEND ls_log TO gat_log.
  ENDMETHOD.
  METHOD envia_mail_notificacion.
    CONSTANTS: lc_th(4)  VALUE '<th>',
               lc_thf(5) VALUE '</th>',
               lc_tr(4)  VALUE '<tr>',
               lc_trf(5) VALUE '</tr>',
               lc_td(4)  VALUE '<td>',
               lc_tdf(5) VALUE '</td>'.

    DATA: ls_mails       TYPE ztmm0025,
          lt_addr        TYPE bcsy_smtpa,
          lo_send_email  TYPE REF TO cl_bcs,
          lo_document    TYPE REF TO cl_document_bcs,
          lo_recipient   TYPE REF TO if_recipient_bcs,
          lv_sent_to_all TYPE os_boolean,
          lo_sender      TYPE REF TO cl_cam_address_bcs,
          lv_sender      TYPE adr6-smtp_addr,
          lv_subject     TYPE so_obj_des,
          lt_message     TYPE soli_tab,
          ls_message     TYPE soli,
          ls_ltbk        TYPE ltbk,
          lv_lin         TYPE i,
          ls_ret         TYPE bapiret2,
          lv_message     TYPE bapi_msg,
          lv_aux         TYPE string,
          ls_log         TYPE treg_log.

    SELECT SINGLE * FROM ztmm0025
      INTO ls_mails
      WHERE werks EQ ga_werks AND
            proceso = '3'.

    IF sy-subrc EQ 0 AND ls_mails IS NOT INITIAL.

      IF ls_mails-email1 NE space.
        APPEND ls_mails-email1 TO lt_addr.
      ENDIF.
      IF ls_mails-email2 NE space.
        APPEND ls_mails-email2 TO lt_addr.
      ENDIF.
      IF ls_mails-email3 NE space.
        APPEND ls_mails-email3 TO lt_addr.
      ENDIF.
      IF ls_mails-email4 NE space.
        APPEND ls_mails-email4 TO lt_addr.
      ENDIF.

* InicializaciÃ³n de la clase
      lo_send_email = cl_bcs=>create_persistent( ).

* Cuerpo del email

* Necesidades borradas
      LOOP AT gat_borradas INTO ls_ltbk.
        IF sy-tabix EQ 1.
          DESCRIBE TABLE gat_borradas LINES lv_lin.
          MOVE lv_lin TO lv_aux.
          CONDENSE lv_aux.
          CONCATENATE '<font size="+3"> <b> <u> <p> Necesidades borradas. Total ' lv_aux '</b> </u/> </p> </font>' INTO lv_aux SEPARATED BY space.
          ls_message-line = lv_aux.
          APPEND ls_message TO lt_message.
          CLEAR ls_message.
        ENDIF.
        CONCATENATE '<p> Nº necesidad' ls_ltbk-tbnum 'Texto' ls_ltbk-tbktx INTO lv_aux SEPARATED BY space.
        ls_message-line = lv_aux.
        APPEND ls_message TO lt_message.
        CLEAR ls_message.
      ENDLOOP.

* Necesidades Modificadas
      LOOP AT gat_modificadas INTO ls_ltbk.
        IF sy-tabix EQ 1.
          DESCRIBE TABLE gat_modificadas LINES lv_lin.
          MOVE lv_lin TO lv_aux.
          CONDENSE lv_aux.
          CONCATENATE '<font size="+3"> <b> <u> <p>  Necesidades modificadas. Total ' lv_aux '</b> </u/> </p> </font>' INTO lv_aux SEPARATED BY space.
          ls_message-line = lv_aux.
          APPEND ls_message TO lt_message.
          CLEAR ls_message.
        ENDIF.
        CONCATENATE '<p>Nº necesidad' ls_ltbk-tbnum '. Texto' ls_ltbk-tbktx '</p>' INTO lv_aux SEPARATED BY space.
        ls_message-line = lv_aux.
        APPEND ls_message TO lt_message.
        CLEAR ls_message.
      ENDLOOP.

      ls_message-line = '<font size="+3"> <b> <u> <p> Resumen del resultado del fichero </p></font>'.
      APPEND ls_message TO lt_message.
      ls_message-line = text-sty.
      APPEND ls_message TO lt_message.

* tabla resumen de NTs creadas
      dame_tabla_creadas( CHANGING pt_mess = lt_message ).

* tabla resumen de errores
      dame_table_erroes( CHANGING pt_mess = lt_message ).


* Crear documento
      CONCATENATE 'Log de Interface OMP a SAP, centro' ga_werks INTO lv_subject SEPARATED BY space. " 61212 - cvivo

      lo_document =  cl_document_bcs=>create_document( i_type    =  'HTM'
                                                        i_subject =  lv_subject
                                                        i_text    =  lt_message ).
* Enviar documento al email
      lo_send_email->set_document( lo_document ).

* AÃ±adir remitente
      lv_sender = 'sap@hinojosa.es'.
      lo_sender = cl_cam_address_bcs=>create_internet_address( lv_sender  ).
      lo_send_email->set_sender( i_sender = lo_sender ).

* AÃ±adir destinatarios al email
      LOOP AT lt_addr ASSIGNING FIELD-SYMBOL(<fs_addr>).
        lo_recipient = cl_cam_address_bcs=>create_internet_address( <fs_addr> ).
        lo_send_email->add_recipient( i_recipient = lo_recipient ).
      ENDLOOP.
      IF ls_mails-lista NE space. " 58445 - Envío a listas de distribución
        lo_recipient = cl_distributionlist_bcs=>getu_persistent( i_dliname = ls_mails-lista i_private = space ).
        lo_send_email->add_recipient( i_recipient = lo_recipient i_express = 'X' ).
      ENDIF.

* Enviar email
      TRY.
          lv_sent_to_all = lo_send_email->send( i_with_error_screen = 'X' ).
        CATCH cx_send_req_bcs .

      ENDTRY.

*  COMMIT WORK. " no se puede porque estamos en UPDATE!

      IF lv_sent_to_all EQ 'X'.
*   Enviado Correctamente
      ELSE.
*   Error al enviar
      ENDIF.

    ENDIF.

  ENDMETHOD.
  METHOD error_material_log.
    CASE pi_subrc.
      WHEN 1.
        MOVE text-e01 TO pc_ko.
      WHEN 2.
        MOVE text-e02 TO pc_ko.
      WHEN 3.
        MOVE text-e03 TO pc_ko.
      WHEN 4.
        MOVE text-e04 TO pc_ko.
      WHEN 5.
      WHEN 6.
        MOVE text-e06 TO pc_ko.
    ENDCASE.

  ENDMETHOD.
  METHOD f_bdc_dynpro.
    DATA: ls_bdc TYPE bdcdata.

    ls_bdc-program  = pe_prog.
    ls_bdc-dynpro   = pe_dyn.
    ls_bdc-dynbegin = abap_true.
    APPEND ls_bdc TO gat_bdcdata.

  ENDMETHOD.
  METHOD f_bdc_field.
    DATA: ls_bdc TYPE bdcdata.

    IF pe_fval  <> gac_nodata.
      ls_bdc-fnam  = pe_fnam.
      ls_bdc-fval   = pe_fval.
      APPEND ls_bdc TO gat_bdcdata.
    ENDIF.
  ENDMETHOD.
  METHOD get_ltba.
    rt_ltba = me->gt_ltba.
  ENDMETHOD.
  METHOD get_nt_dat_upd.
    CLEAR rt_ltbk.
    IF iv_idx IS NOT INITIAL.
      TRY.
          DATA(ls_ltbk) = me->gt_nt_dat_update[ iv_idx ].
          APPEND ls_ltbk TO rt_ltbk.
          IF iv_remove = abap_true.
            DELETE me->gt_nt_dat_update INDEX iv_idx.
          ENDIF.
        CATCH cx_root.
      ENDTRY.
      RETURN.
    ENDIF.

    rt_ltbk = me->gt_nt_dat_update.
    CHECK iv_remove = abap_true.
    me->init_nt_dat_upd( ).
  ENDMETHOD.
  METHOD init_nt_dat_upd.
    CLEAR me->gt_nt_dat_update.
  ENDMETHOD.
  METHOD notifica_borrada.
    DATA: ls_ltbk TYPE ltbk.

    SELECT SINGLE *
      FROM ltbk
      INTO CORRESPONDING FIELDS OF ls_ltbk
      WHERE lgnum = pi_lgnum AND
            tbnum = pi_tbnum.

    IF sy-subrc EQ 0.
      APPEND ls_ltbk TO gat_borradas.
    ENDIF.
  ENDMETHOD.
  METHOD notifica_modificada.

    IF pi_ltbk IS NOT INITIAL.
      APPEND pi_ltbk TO gat_modificadas.
    ENDIF.
  ENDMETHOD.
  METHOD remove_idx_ltba.
    CHECK iv_idx > 0 AND lines( me->gt_ltba ) >= iv_idx.
    DELETE me->gt_ltba INDEX iv_idx.
  ENDMETHOD.
  METHOD run_ltba.
    DATA ls_log      TYPE treg_log.
    CHECK me->gt_ltba IS NOT INITIAL.

    DO lines( me->gt_ltba ) TIMES.
      me->crear_nts(
        EXPORTING
          pi_index      =  me->gt_ltba[ sy-index ]-idx   " ABAP System Field: Loop Index
            iv_store_only = abap_false
            it_ltba       = me->gt_ltba[ sy-index ]-it_ltba
        CHANGING
            pc_ok = ls_log-ok_1
            pc_ko = ls_log-ko_1   " Message Text
      ).
    ENDDO.

  ENDMETHOD.
  METHOD store_ltba.
    " must check that it is not confirmed yet...
    CHECK lines( it_ltba ) > 0.

    DATA(lt_nt_dat) = me->get_nt_dat_upd(
*                      iv_idx    =
                  iv_remove = abap_false
              ).

    DATA(ls_ltba) = it_ltba[ 1 ].
    SELECT SINGLE @abap_true
    FROM ltbk
    INTO @DATA(lv_dumm)
    WHERE lgnum = @ls_ltba-lgnum
    AND benum = @ls_ltba-benum
    AND nlpla = @ls_ltba-nlpla.

    IF sy-subrc NE 0 OR line_exists( lt_nt_dat[ lgnum = ls_ltba-lgnum benum = ls_ltba-benum nlpla = ls_ltba-nlpla ] ).
      APPEND VALUE #( idx  = iv_idx it_ltba = it_ltba nlpla = ls_ltba-nlpla pdatu = ls_ltba-pdatu pzeit = ls_ltba-pzeit ) TO me->gt_ltba.
    ENDIF.
  ENDMETHOD.
  METHOD zii_si_omp_prod_rep_in_omp_to~si_omp_prod_rep_in_omp_to_sap.


    DATA: ls_data     TYPE zdt_omp_prod_replenishment_in,
          lv_name     TYPE string,
          lv_str      TYPE string,
          ls_ltbk     TYPE ltbk,
          ls_ltbp     TYPE ltbp,
          lt_ltbk     TYPE gtyp_ltbk,
          lt_ltbp     TYPE gtyp_ltbp,
          lv_lgnum    TYPE lgnum,
          lv_tbnum    TYPE tbnum,
          ls_log      TYPE treg_log,
          lv_aux_trim TYPE lqua_gesme,
          lv_aux2     TYPE string.

    CLEAR gav_hay_error.
* 0.- cargamos hardcodes
    dame_hardcodes( ).

* 1.- las otras NTs, modificadas van al log
    carga_nt_modificadas( ).

* 2.- borrado de NTs abiertas sin modificacion
    borra_nt_abiertas( ).

"KYV/RDM - 20200804 - BEG
    " 3 - close Reservations
    close_reservation( ).
"KYV/RDM - 20200804 - END

* 4.- Generamos las NTs en SAP
*     Recorremos los datos de entrada para procesarlos
    MOVE input-mt_omp_prod_replenishment_in_o-message-name TO lv_name.

    LOOP AT input-mt_omp_prod_replenishment_in_o-message-ompci ASSIGNING FIELD-SYMBOL(<ls>).
      CLEAR ls_log.
      CLEAR ls_ltbk.

      DATA(ls_adit) = CORRESPONDING zwm_ltbk_adit_inc( <ls>
          MAPPING benum = cinumber ) .



      MOVE <ls>-cinumber TO: ls_ltbk-benum,
                             ls_log-cinumber.

*      MOVE <ls>-start_date TO ls_ltbk-pdatu.
      CONCATENATE <ls>-start_date+6(4) <ls>-start_date+3(2) <ls>-start_date+0(2) INTO ls_ltbk-bdatu.
      CONCATENATE <ls>-start_date+11(2) <ls>-start_date+14(2) <ls>-start_date+17(2) INTO ls_ltbk-bzeit.

*      MOVE <ls>-end_date TO ls_ltbk-pzeit.
      CONCATENATE <ls>-end_date+6(4) <ls>-end_date+3(2) <ls>-end_date+0(2) INTO ls_ltbk-pdatu.
      CONCATENATE <ls>-end_date+11(2) <ls>-end_date+14(2) <ls>-end_date+17(2) INTO ls_ltbk-pzeit.

* <ls>-CISTATUS
      MOVE <ls>-quality TO lv_str.
      REPLACE ALL OCCURRENCES OF <ls>-flute_type IN lv_str WITH space.
      CONDENSE lv_str.
      lv_aux_trim = <ls>-planned_trim.
      IF lv_aux_trim IS NOT INITIAL.
        lv_aux_trim = lv_aux_trim * 1000.
        lv_aux2 = lv_aux_trim.
      ENDIF.

      CONCATENATE <ls>-reel_width
                  lv_str
                  <ls>-flute_type
                  lv_aux2
                  INTO ls_ltbk-lznum "ls_ltbk-tbktx
                  SEPARATED BY '/'.
* <ls>-PLANNED_LINEAL
      REFRESH: lt_ltbp, lt_ltbk.

      MOVE <ls>-paper_station1 TO lv_str.
      dame_material( EXPORTING iv_str = lv_str iv_werks = ga_werks
        CHANGING cv_matnr = ls_ltbp-matnr
                     EXCEPTIONS
                       no_material_found = 1
                       e_calidad_vacia   = 2
                       e_valor_externo   = 3
                       e_valor_sap       = 4
                       e_sin_valor       = 5
                       e_mat_zpim_not_found = 6
                       OTHERS            = 7 ).
      IF sy-subrc EQ 0.
        MOVE <ls>-paper1length_m TO ls_ltbp-menge.
        MOVE 'M' TO ls_ltbp-meins.
* <ls>-PAPER1WEIGHT_KG
        MOVE ga_werks TO ls_ltbp-werks.
        ls_ltbk-nlpla = ga_nlpla01.

        ls_adit-nlpla = ls_ltbk-nlpla.
        ls_adit-menge = ls_ltbp-menge.
        zcl_wm_zwm_ltbk_adit_dao=>store_data_for_entry( is_data = ls_adit ). " Kyvor - RDM - 20190925


        MOVE <ls>-comment TO ls_ltbk-tbktx. "ls_ltbk-lznum.

        SELECT SINGLE lgnum lgtyp
          FROM lagp
          INTO ( ls_ltbk-lgnum, ls_ltbk-nltyp )
          WHERE lgpla = ls_ltbk-nlpla
          AND lgnum = ga_lgnum.

        ls_ltbp-lgnum = ls_ltbk-lgnum.

        APPEND ls_ltbp TO lt_ltbp.
        APPEND ls_ltbk TO lt_ltbk.

        crear_nts( EXPORTING pi_index = sy-tabix
                             iv_store_only = abap_true
                   CHANGING pt_ltbk = lt_ltbk
                            pt_ltbp = lt_ltbp
                            pc_ok = ls_log-ok_1
                            pc_ko = ls_log-ko_1 ).
*       movemos al log el material y la cantidad
        MOVE ls_ltbp-menge TO ls_log-menge_1.
        MOVE ls_ltbp-matnr TO ls_log-matnr_1.
      ELSE.
        IF sy-subrc <> 5. " si no hay material informado, no es un error
          MOVE <ls>-paper1length_m TO ls_log-menge_1.
          MOVE lv_str TO ls_log-matnr_1.
          ls_log-ko_1 = error_material_log( EXPORTING pi_subrc = sy-subrc ).
          gav_hay_error = abap_true.
        ENDIF.
      ENDIF.

      REFRESH: lt_ltbp, lt_ltbk.
      MOVE <ls>-paper_station2 TO lv_str.
      dame_material( EXPORTING iv_str = lv_str iv_werks = ga_werks CHANGING cv_matnr = ls_ltbp-matnr
                     EXCEPTIONS
                       no_material_found = 1
                       e_calidad_vacia   = 2
                       e_valor_externo   = 3
                       e_valor_sap       = 4
                       e_sin_valor       = 5
                       e_mat_zpim_not_found = 6
                       OTHERS            = 7 ).
      IF sy-subrc EQ 0.
        MOVE <ls>-paper2length_m TO ls_ltbp-menge.
        MOVE 'M' TO ls_ltbp-meins.
* <ls>-PAPER2WEIGHT_KG
        MOVE ga_werks TO ls_ltbp-werks.
        "ls_ltbk-nlpla = 'BHS2'.
        ls_ltbk-nlpla = ga_nlpla02.

        ls_adit-nlpla = ls_ltbk-nlpla.
        ls_adit-menge = ls_ltbp-menge.
        zcl_wm_zwm_ltbk_adit_dao=>store_data_for_entry( is_data = ls_adit ). " Kyvor - RDM - 20190925

        MOVE <ls>-comment TO ls_ltbk-tbktx. "ls_ltbk-lznum.

        SELECT SINGLE lgnum lgtyp
          FROM lagp
          INTO ( ls_ltbk-lgnum, ls_ltbk-nltyp )
          WHERE lgpla = ls_ltbk-nlpla
          AND lgnum = ga_lgnum. "Kyvor - 20191009 - RDM

        ls_ltbp-lgnum = ls_ltbk-lgnum.

        APPEND ls_ltbp TO lt_ltbp.
        APPEND ls_ltbk TO lt_ltbk.

        crear_nts( EXPORTING pi_index = sy-tabix
        iv_store_only = abap_true
                   CHANGING pt_ltbk = lt_ltbk
                            pt_ltbp = lt_ltbp
                            pc_ok = ls_log-ok_2
                            pc_ko = ls_log-ko_2 ).
*       movemos al log el material y la cantidad
        MOVE ls_ltbp-menge TO ls_log-menge_2.
        MOVE ls_ltbp-matnr TO ls_log-matnr_2.
      ELSE.
        IF sy-subrc <> 5. " si no hay material informado, no es un error
          MOVE <ls>-paper2length_m TO ls_log-menge_2.
          MOVE lv_str TO ls_log-matnr_2.
          ls_log-ko_2 = error_material_log( EXPORTING pi_subrc = sy-subrc ).
          gav_hay_error = abap_true.
        ENDIF.
      ENDIF.

      REFRESH: lt_ltbp, lt_ltbk.
      MOVE <ls>-paper_station3 TO lv_str.
      dame_material( EXPORTING iv_str = lv_str iv_werks = ga_werks CHANGING cv_matnr = ls_ltbp-matnr
                     EXCEPTIONS
                       no_material_found = 1
                       e_calidad_vacia   = 2
                       e_valor_externo   = 3
                       e_valor_sap       = 4
                       e_sin_valor       = 5
                       e_mat_zpim_not_found = 6
                       OTHERS            = 7 ).
      IF sy-subrc EQ 0.
        MOVE <ls>-paper3length_m TO ls_ltbp-menge.
        MOVE 'M' TO ls_ltbp-meins.
* <ls>-PAPER3WEIGHT_KG
        MOVE ga_werks TO ls_ltbp-werks.
        ls_ltbk-nlpla = ga_nlpla03.

        ls_adit-nlpla = ls_ltbk-nlpla.
        ls_adit-menge = ls_ltbp-menge.
        zcl_wm_zwm_ltbk_adit_dao=>store_data_for_entry( is_data = ls_adit ). " Kyvor - RDM - 20190925

        MOVE <ls>-comment TO ls_ltbk-tbktx. "ls_ltbk-lznum.

        SELECT SINGLE lgnum lgtyp
          FROM lagp
          INTO ( ls_ltbk-lgnum, ls_ltbk-nltyp )
          WHERE lgpla = ls_ltbk-nlpla
          AND lgnum = ga_lgnum. "Kyvor - 20191009 - RDM.

        ls_ltbp-lgnum = ls_ltbk-lgnum.

        APPEND ls_ltbp TO lt_ltbp.
        APPEND ls_ltbk TO lt_ltbk.

        crear_nts( EXPORTING pi_index = sy-tabix
        iv_store_only = abap_true
                   CHANGING pt_ltbk = lt_ltbk
                            pt_ltbp = lt_ltbp
                            pc_ok = ls_log-ok_3
                            pc_ko = ls_log-ko_3 ).
*       movemos al log el material y la cantidad
        MOVE ls_ltbp-menge TO ls_log-menge_3.
        MOVE ls_ltbp-matnr TO ls_log-matnr_3.
      ELSE.
        IF sy-subrc <> 5. " si no hay material informado, no es un error
          MOVE <ls>-paper3length_m TO ls_log-menge_3.
          MOVE lv_str TO ls_log-matnr_3.
          ls_log-ko_3 = error_material_log( EXPORTING pi_subrc = sy-subrc ).
          gav_hay_error = abap_true.
        ENDIF.
      ENDIF.

      REFRESH: lt_ltbp, lt_ltbk.
      MOVE <ls>-paper_station4 TO lv_str.
      dame_material( EXPORTING iv_str = lv_str iv_werks = ga_werks CHANGING cv_matnr = ls_ltbp-matnr
                     EXCEPTIONS
                       no_material_found = 1
                       e_calidad_vacia   = 2
                       e_valor_externo   = 3
                       e_valor_sap       = 4
                       e_sin_valor       = 5
                       e_mat_zpim_not_found = 6
                       OTHERS            = 7 ).
      IF sy-subrc EQ 0.
        MOVE <ls>-paper4length_m TO ls_ltbp-menge.
        MOVE 'M' TO ls_ltbp-meins.
* <ls>-PAPER4WEIGHT_KG
        MOVE ga_werks TO ls_ltbp-werks.
        ls_ltbk-nlpla = ga_nlpla04.

        ls_adit-nlpla = ls_ltbk-nlpla.
        ls_adit-menge = ls_ltbp-menge.
        zcl_wm_zwm_ltbk_adit_dao=>store_data_for_entry( is_data = ls_adit ). " Kyvor - RDM - 20190925

        MOVE <ls>-comment TO ls_ltbk-tbktx. "ls_ltbk-lznum.

        SELECT SINGLE lgnum lgtyp
          FROM lagp
          INTO ( ls_ltbk-lgnum, ls_ltbk-nltyp )
          WHERE lgpla = ls_ltbk-nlpla
          AND lgnum = ga_lgnum. "Kyvor - 20191009 - RDM.

        ls_ltbp-lgnum = ls_ltbk-lgnum.

        APPEND ls_ltbp TO lt_ltbp.
        APPEND ls_ltbk TO lt_ltbk.

        crear_nts( EXPORTING pi_index = sy-tabix
        iv_store_only = abap_true
                   CHANGING pt_ltbk = lt_ltbk
                            pt_ltbp = lt_ltbp
                            pc_ok = ls_log-ok_4
                            pc_ko = ls_log-ko_4 ).
*       movemos al log el material y la cantidad
        MOVE ls_ltbp-menge TO ls_log-menge_4.
        MOVE ls_ltbp-matnr TO ls_log-matnr_4.
      ELSE.
        IF sy-subrc <> 5. " si no hay material informado, no es un error
          MOVE <ls>-paper4length_m TO ls_log-menge_4.
          MOVE lv_str TO ls_log-matnr_4.
          ls_log-ko_4 = error_material_log( EXPORTING pi_subrc = sy-subrc ).
          gav_hay_error = abap_true.
        ENDIF.
      ENDIF.

      REFRESH: lt_ltbp, lt_ltbk.
      MOVE <ls>-paper_station5 TO lv_str.
      dame_material( EXPORTING iv_str = lv_str iv_werks = ga_werks CHANGING cv_matnr = ls_ltbp-matnr
                     EXCEPTIONS
                       no_material_found = 1
                       e_calidad_vacia   = 2
                       e_valor_externo   = 3
                       e_valor_sap       = 4
                       e_sin_valor       = 5
                       e_mat_zpim_not_found = 6
                       OTHERS            = 7 ).
      IF sy-subrc EQ 0.
        MOVE <ls>-paper5length_m TO ls_ltbp-menge.
        MOVE 'M' TO ls_ltbp-meins.
* <ls>-PAPER5WEIGHT_KG
        MOVE ga_werks TO ls_ltbp-werks.
        "ls_ltbk-nlpla = 'BHS5'.
        ls_ltbk-nlpla = ga_nlpla05.

        ls_adit-nlpla = ls_ltbk-nlpla.
        ls_adit-menge = ls_ltbp-menge.
        zcl_wm_zwm_ltbk_adit_dao=>store_data_for_entry( is_data = ls_adit ). " Kyvor - RDM - 20190925

        MOVE <ls>-comment TO ls_ltbk-tbktx. "ls_ltbk-lznum.

        SELECT SINGLE lgnum lgtyp
          FROM lagp
          INTO ( ls_ltbk-lgnum, ls_ltbk-nltyp )
          WHERE lgpla = ls_ltbk-nlpla
          AND lgnum = ga_lgnum. "Kyvor - 20191009 - RDM.

        ls_ltbp-lgnum = ls_ltbk-lgnum.

        APPEND ls_ltbp TO lt_ltbp.
        APPEND ls_ltbk TO lt_ltbk.

        crear_nts( EXPORTING pi_index = sy-tabix
        iv_store_only = abap_true
                   CHANGING pt_ltbk = lt_ltbk
                            pt_ltbp = lt_ltbp
                            pc_ok = ls_log-ok_5
                            pc_ko = ls_log-ko_5 ).
*       movemos al log el material y la cantidad
        MOVE ls_ltbp-menge TO ls_log-menge_5.
        MOVE ls_ltbp-matnr TO ls_log-matnr_5.
      ELSE.
        IF sy-subrc <> 5. " si no hay material informado, no es un error
          MOVE <ls>-paper5length_m TO ls_log-menge_5.
          MOVE lv_str TO ls_log-matnr_5.
          ls_log-ko_5 = error_material_log( EXPORTING pi_subrc = sy-subrc ).
          gav_hay_error = abap_true.
        ENDIF.
      ENDIF.

      REFRESH: lt_ltbp, lt_ltbk.
      MOVE <ls>-paper_station6 TO lv_str.
      dame_material( EXPORTING iv_str = lv_str iv_werks = ga_werks CHANGING cv_matnr = ls_ltbp-matnr
                     EXCEPTIONS
                       no_material_found = 1
                       e_calidad_vacia   = 2
                       e_valor_externo   = 3
                       e_valor_sap       = 4
                       e_sin_valor       = 5
                       e_mat_zpim_not_found = 6
                       OTHERS            = 7 ).

      IF sy-subrc EQ 0.
        MOVE <ls>-paper6length_m TO ls_ltbp-menge.
        MOVE 'M' TO ls_ltbp-meins.
        MOVE ga_werks TO ls_ltbp-werks.
        "ls_ltbk-nlpla = 'BHS6'.
        ls_ltbk-nlpla = 'EST6'.
        ls_adit-nlpla = ls_ltbk-nlpla.
        ls_adit-menge = ls_ltbp-menge.
        zcl_wm_zwm_ltbk_adit_dao=>store_data_for_entry( is_data = ls_adit ). " Kyvor - RDM - 20190925

        MOVE <ls>-comment TO ls_ltbk-tbktx. "ls_ltbk-lznum.

        SELECT SINGLE lgnum lgtyp
          FROM lagp
          INTO ( ls_ltbk-lgnum, ls_ltbk-nltyp )
          WHERE lgpla = ls_ltbk-nlpla
          AND lgnum = ga_lgnum. "Kyvor - 20191009 - RDM.

        ls_ltbp-lgnum = ls_ltbk-lgnum.

        APPEND ls_ltbp TO lt_ltbp.
        APPEND ls_ltbk TO lt_ltbk.

        crear_nts( EXPORTING pi_index = sy-tabix
                   CHANGING pt_ltbk = lt_ltbk
                            pt_ltbp = lt_ltbp
                            pc_ok = ls_log-ok_6
                            pc_ko = ls_log-ko_6 ).
*       movemos al log el material y la cantidad
        MOVE ls_ltbp-menge TO ls_log-menge_6.
        MOVE ls_ltbp-matnr TO ls_log-matnr_6.
      ELSE.
        IF sy-subrc <> 5. " si no hay material informado, no es un error
          MOVE <ls>-paper6length_m TO ls_log-menge_6.
          MOVE lv_str TO ls_log-matnr_6.
          ls_log-ko_6 = error_material_log( EXPORTING pi_subrc = sy-subrc ).
          gav_hay_error = abap_true.
        ENDIF.
      ENDIF.

      APPEND ls_log TO gat_log.

    ENDLOOP.

    " create reservation and nt's
    "CLEAR gat_log.
    me->create_reservation( ).



* 3.- se envia notificacion necesidades creadas/borradas/modificadas

*   Solo enviamos el mail si hay algun error
    IF gav_hay_error IS NOT INITIAL.
      envia_mail_notificacion( ).
    ENDIF.

  ENDMETHOD.
