<?xml version="1.0" encoding="utf-8"?> <ENHO enhancement_id="ZRM07MLBS_DATA_SELECTION_NEW" shorttext="Ampliación MB52. Selección datos" tooltype_id="HOOK_IMPL" orig_object="R3TR-RM07MLBS-PROG-RM07MLBS">  <asx:abap xmlns:asx="http://www.sap.com/abapxml" ve
rsion="1.0">   <asx:values>    <IMPLS>     <ENH_HOOK_IMPL>      <SPOTNAME/>      <PROGRAMNAME>RM07MLBS</PROGRAMNAME>      <EXTID>1</EXTID>      <ID>1</ID>      <OVERWRITE/>      <METHOD/>      <ENHMODE>S</ENHMODE>      <FULL_NAME>\PR:RM07MLBS\FO:DATA_SELE
CTION_NEW\SE:END\EI</FULL_NAME>      <SOURCE>       <item/>       <item/>       <item/>       <item>&quot;JCB SD - 74025 - Añadir campos Z transacción MB52</item>       <item>IF bestand[] IS NOT INITIAL.</item>       <item>SELECT vbeln, kunnr</item>
 <item>INTO TABLE @DATA(tl_vbak)</item>       <item>FROM vbak</item>       <item>FOR ALL ENTRIES IN @bestand[]</item>       <item>WHERE vbeln = @bestand-vbeln.</item>       <item/>       <item/>       <item>SELECT afpo~matnr, afpo~charg, aufk~werks, aufk~
aufnr, vbak~kunnr, vbak~vbeln, aufk~kdpos</item>       <item>INTO TABLE @DATA(tl_vbak_sin_pedido)</item>       <item>FROM afpo INNER JOIN ( aufk left OUTER JOIN vbak ON vbak~vbeln = aufk~kdauf )</item>       <item>ON aufk~aufnr = afpo~aufnr</item>       <
item>FOR ALL ENTRIES IN @bestand[]</item>       <item>WHERE afpo~MATNR = @bestand-matnr AND</item>       <item>afpo~charg = @bestand-charg and</item>       <item>aufk~WERKS = @bestand-WERKS.</item>       <item>ENDIF.</item>       <item/>       <item/>
   <item>IF tl_vbak IS NOT INITIAL.</item>       <item>SELECT kunnr, name1</item>       <item>INTO TABLE @DATA(tl_kna1_cliente)</item>       <item>FROM kna1</item>       <item>FOR ALL ENTRIES IN @tl_vbak</item>       <item>WHERE kunnr = @tl_vbak-kunnr.</i
tem>       <item>ENDIF.</item>       <item/>       <item>IF tl_vbak_sin_pedido IS NOT INITIAL.</item>       <item>SELECT kunnr, name1</item>       <item>APPENDING TABLE @tl_kna1_cliente</item>       <item>FROM kna1</item>       <item>FOR ALL ENTRIES IN @t
l_vbak_sin_pedido</item>       <item>WHERE kunnr = @tl_vbak_sin_pedido-kunnr.</item>       <item>ENDIF.</item>       <item/>       <item/>       <item/>       <item/>       <item>LOOP AT bestand ASSIGNING FIELD-SYMBOL(&lt;fs_bestand&gt;).</item>       <it
em>*   add jtm 15.11.2022</item>       <item>if &lt;fs_bestand&gt;-werks eq &apos;2001&apos;</item>       <item>or &lt;fs_bestand&gt;-werks eq &apos;2003&apos;.</item>       <item>&lt;fs_bestand&gt;-zzvkorg = &apos;2001&apos;.</item>       <item>else.</it
em>       <item>&lt;fs_bestand&gt;-zzvkorg = &lt;fs_bestand&gt;-werks.</item>       <item>endif.</item>       <item>*   fin de add jtm 15.11.2022</item>       <item>IF &lt;fs_bestand&gt;-vbeln is not INITIAL.</item>       <item>&lt;fs_bestand&gt;-zzvbeln
= &lt;fs_bestand&gt;-vbeln.</item>       <item>&lt;fs_bestand&gt;-zzposnr = &lt;fs_bestand&gt;-posnr.</item>       <item>READ TABLE tl_vbak ASSIGNING FIELD-SYMBOL(&lt;fs_vbak&gt;) with key vbeln = &lt;fs_bestand&gt;-zzvbeln.</item>       <item>IF sy-subrc
 = 0.</item>       <item>&lt;fs_bestand&gt;-zzkunnr_cliente = &lt;fs_vbak&gt;-kunnr.</item>       <item>ENDIF.</item>       <item/>       <item>ELSE.</item>       <item>ENDIF.</item>       <item/>       <item>READ TABLE tl_vbak_sin_pedido ASSIGNING FIELD-
SYMBOL(&lt;fs_vbak_sp&gt;) with key werks = &lt;fs_bestand&gt;-werks</item>       <item>matnr = &lt;fs_bestand&gt;-matnr</item>       <item>charg = &lt;fs_bestand&gt;-charg.</item>       <item>IF sy-subrc = 0.</item>       <item>&lt;fs_bestand&gt;-zzaufnr
         = &lt;fs_vbak_sp&gt;-aufnr.</item>       <item>if &lt;fs_bestand&gt;-zzvbeln is INITIAL.</item>       <item>&lt;fs_bestand&gt;-zzvbeln         = &lt;fs_vbak_sp&gt;-vbeln.</item>       <item>&lt;fs_bestand&gt;-zzposnr         = &lt;fs_vbak_sp&gt;-
kdpos.</item>       <item>&lt;fs_bestand&gt;-zzkunnr_cliente = &lt;fs_vbak_sp&gt;-kunnr.</item>       <item>ENDIF.</item>       <item>ENDIF.</item>       <item>ENDLOOP.</item>       <item/>       <item>IF bestand[] is not INITIAL.</item>       <item>SELEC
T vbpa~vbeln, vbpa~posnr, vbpa~parvw, vbpa~kunnr, vbpa~lifnr, kna1~name1 as name1_kna1, lfa1~name1 as name1_lfa1</item>       <item>INTO TABLE @DATA(tl_zzvbpa)</item>       <item>FROM vbpa LEFT OUTER JOIN kna1 on kna1~kunnr = vbpa~kunnr</item>       <item
>LEFT OUTER JOIN lfa1 on lfa1~lifnr = vbpa~lifnr</item>       <item>FOR ALL ENTRIES IN @bestand[]</item>       <item>WHERE vbeln = @bestand-zzvbeln and</item>       <item>parvw in (&apos;WE&apos;, &apos;Y0&apos;).</item>       <item/>       <item>SELECT v
korg, vtweg, kunnr, matnr, kdmat, postx</item>       <item>INTO TABLE @data(tl_knmt)</item>       <item>FROM knmt</item>       <item>FOR ALL ENTRIES IN @bestand[]</item>       <item>*      cambjar jtm 15.11.2022</item>       <item>*      where  vkorg = @b
estand-werks</item>       <item>where  vkorg = @bestand-zzvkorg</item>       <item>*      fin de cambiar jtm 15.11.2022</item>       <item>and  vtweg = &apos;10&apos;</item>       <item>and  kunnr = @bestand-zzkunnr_cliente</item>       <item>and  matnr =
 @bestand-matnr.</item>       <item>ENDIF.</item>       <item/>       <item/>       <item/>       <item>LOOP AT bestand ASSIGNING &lt;fs_bestand&gt;.</item>       <item>IF &lt;fs_bestand&gt;-zzkunnr_cliente IS NOT INITIAL.</item>       <item>READ TABLE tl
_kna1_cliente ASSIGNING FIELD-SYMBOL(&lt;fs_kna1_cliente&gt;) with key kunnr = &lt;fs_bestand&gt;-zzkunnr_cliente.</item>       <item>IF sy-subrc = 0.</item>       <item>&lt;fs_bestand&gt;-zzname1_cliente = &lt;fs_kna1_cliente&gt;-name1.</item>       <ite
m>ENDIF.</item>       <item>READ TABLE tl_knmt ASSIGNING FIELD-SYMBOL(&lt;fs_knmt&gt;) with key vkorg = &lt;fs_bestand&gt;-zzvkorg</item>       <item>kunnr = &lt;fs_bestand&gt;-zzkunnr_cliente</item>       <item>matnr = &lt;fs_bestand&gt;-matnr.</item>
    <item>*                                                                    vtweg = &apos;10&apos;.</item>       <item>IF sy-subrc = 0.</item>       <item>&lt;fs_bestand&gt;-zzkdmat = &lt;fs_knmt&gt;-kdmat.</item>       <item>&lt;fs_bestand&gt;-zzpostx
 = &lt;fs_knmt&gt;-postx.</item>       <item>ENDIF.</item>       <item>else.</item>       <item>*     add jtm 15.11.2022</item>       <item>select * into TABLE @data(tt_knmt) from knmt where vkorg eq @&lt;fs_bestand&gt;-zzvkorg</item>       <item>and vtwe
g eq &apos;10&apos;</item>       <item>and matnr eq @&lt;fs_bestand&gt;-matnr.</item>       <item>if sy-subrc eq 0 and sy-dbcnt eq 1.</item>       <item>read TABLE tt_knmt into data(rT_knmt) index 1.</item>       <item>&lt;fs_bestand&gt;-zzkdmat         =
 rt_knmt-kdmat.</item>       <item>&lt;fs_bestand&gt;-zzpostx         = rt_knmt-postx.</item>       <item>&lt;fs_bestand&gt;-zzkunnr_cliente = rT_knmt-kunnr.</item>       <item>select SINGLE name1 into &lt;fs_bestand&gt;-zzname1_cliente from kna1 where ku
nnr eq &lt;fs_bestand&gt;-zzkunnr_cliente.</item>       <item>endif.</item>       <item>*     fin de add jtm 15.11.2022</item>       <item/>       <item>ENDIF.</item>       <item>ENDLOOP.</item>       <item/>       <item/>       <item>&quot;JCB 18.01.24.
80902. Comerciales del cliente</item>       <item>IF bestand[] is not INITIAL.</item>       <item>SELECT knvp~vkorg, knvp~vtweg, knvp~kunnr, knvp~PARVW, knvp~lifnr, lfa1~name1</item>       <item>INTO TABLE @data(tl_knvp_comer)</item>       <item>FROM knvp
 INNER JOIN lfa1 on lfa1~lifnr = knvp~lifnr</item>       <item>FOR ALL ENTRIES IN @bestand[]</item>       <item>WHERE knvp~vkorg = @bestand-zzvkorg         AND</item>       <item>knvp~vtweg = &apos;10&apos;                     AND</item>       <item>knvp~
kunnr = @bestand-zzkunnr_cliente AND</item>       <item>knvp~parvw = &apos;Y0&apos;.</item>       <item>ENDIF.</item>       <item/>       <item/>       <item>LOOP AT bestand ASSIGNING &lt;fs_bestand&gt;.</item>       <item>IF &lt;fs_bestand&gt;-zzvbeln IS
 NOT INITIAL.</item>       <item>READ TABLE tl_zzvbpa ASSIGNING FIELD-SYMBOL(&lt;fs_zzvbpa&gt;) with key vbeln = &lt;fs_bestand&gt;-zzvbeln</item>       <item>posnr = &lt;fs_bestand&gt;-zzposnr</item>       <item>parvw = &apos;WE&apos;.</item>       <item
>IF sy-subrc &lt;&gt; 0.</item>       <item>READ TABLE tl_zzvbpa ASSIGNING &lt;fs_zzvbpa&gt; with key vbeln = &lt;fs_bestand&gt;-zzvbeln</item>       <item>posnr = &apos;000000&apos;</item>       <item>parvw = &apos;WE&apos;.</item>       <item>ENDIF.</it
em>       <item>IF sy-subrc = 0.</item>       <item>&lt;fs_bestand&gt;-zzkunnr_dest  = &lt;fs_zzvbpa&gt;-kunnr.</item>       <item>&lt;fs_bestand&gt;-zzname1_dest  = &lt;fs_zzvbpa&gt;-name1_kna1.</item>       <item>ENDIF.</item>       <item/>       <item>
*      READ TABLE tl_zzvbpa ASSIGNING &lt;fs_zzvbpa&gt; with key vbeln = &lt;fs_bestand&gt;-zzvbeln</item>       <item>*                                                          posnr = &lt;fs_bestand&gt;-zzposnr</item>       <item>*
                                    parvw = &apos;Y0&apos;.</item>       <item>*      IF sy-subrc &lt;&gt; 0.</item>       <item>*        READ TABLE tl_zzvbpa ASSIGNING &lt;fs_zzvbpa&gt; with key vbeln = &lt;fs_bestand&gt;-zzvbeln</item>       <item>*
                                                        posnr = &apos;000000&apos;</item>       <item>*                                                            parvw = &apos;Y0&apos;.</item>       <item>*      ENDIF.</item>       <item>*      IF sy-sub
rc = 0.</item>       <item>*        &lt;fs_bestand&gt;-zzlifnr_comer = &lt;fs_zzvbpa&gt;-lifnr.</item>       <item>*        &lt;fs_bestand&gt;-zzname1_comer = &lt;fs_zzvbpa&gt;-name1_lfa1.</item>       <item>*      ENDIF.</item>       <item/>       <item/
>       <item>ENDIF.</item>       <item/>       <item>READ TABLE tl_knvp_comer ASSIGNING FIELD-SYMBOL(&lt;fs_knvp_comer&gt;) WITH KEY vkorg = &lt;fs_bestand&gt;-zzvkorg</item>       <item>vtweg = &apos;10&apos;</item>       <item>kunnr = &lt;fs_bestand&gt
;-zzkunnr_cliente</item>       <item>parvw = &apos;Y0&apos;.</item>       <item>IF sy-subrc = 0.</item>       <item>&lt;fs_bestand&gt;-zzlifnr_comer = &lt;fs_knvp_comer&gt;-lifnr.</item>       <item>&lt;fs_bestand&gt;-zzname1_comer = &lt;fs_knvp_comer&gt;
-name1.</item>       <item>ENDIF.</item>       <item/>       <item/>       <item>SELECT COUNT(*)</item>       <item>INTO &lt;fs_bestand&gt;-zznum_palets</item>       <item>FROM lqua</item>       <item>WHERE matnr = &lt;fs_bestand&gt;-matnr AND</item>
  <item>werks = &lt;fs_bestand&gt;-werks and</item>       <item>charg = &lt;fs_bestand&gt;-charg.</item>       <item/>       <item/>       <item/>       <item>call FUNCTION &apos;MD_CONVERT_MATERIAL_UNIT&apos;</item>       <item>EXPORTING</item>       <it
em>i_matnr              = &lt;fs_bestand&gt;-matnr</item>       <item>i_in_me              = &lt;fs_bestand&gt;-meins</item>       <item>i_out_me             = &apos;M2&apos;</item>       <item>i_menge              = &lt;fs_bestand&gt;-labst</item>
<item>IMPORTING</item>       <item>e_menge              = &lt;fs_bestand&gt;-zzlabst_m2</item>       <item>EXCEPTIONS</item>       <item>error_in_application = 1</item>       <item>error                = 2</item>       <item>others               = 3</item
>       <item>.</item>       <item>&lt;fs_bestand&gt;-zzm2 = &apos;M2&apos;.</item>       <item>ENDLOOP.</item>       <item/>       <item>&quot;FIN JCB SD - 74025 - Añadir campos Z transacción MB52</item>       <item/>       <item/>       <item/>      </S
OURCE>      <PARENT_FULL_NAME/>     </ENH_HOOK_IMPL>    </IMPLS>   </asx:values>  </asx:abap> </ENHO>
