
class ZWHS definition
  public
  create public .

public section.

  constants CLAVE_PARAM type ZCLAVE_PARAM value 'ZWHS' ##NO_TEXT.
  constants CENTRO type WERKS_D value '0026' ##NO_TEXT.

  class-methods GENERA_MSG
    importing
      !IDMSG type ZIDMSG
      !OBJKEY type ANY
      !TCODE type SY-TCODE default SY-TCODE
      !ENVIO_EN_FONDO type ABAP_BOOL default ''
      !RETRASO_JOB type I default 5
      !COMMIT type ABAP_BOOL default 'X'
      !COLA type ZWHS_COLA optional
      !COLA_REF type ZWHS_COLA optional
      !VAR1 type ANY optional
      !VAR2 type ANY optional
      !MODO_CT type BDCMODE default ''
      !UNAME type SY-UNAME default SY-UNAME
    exporting
      value(IDCOLA) type ZIDCOLA
      !MENSAJE type BAPI_MSG .
  class-methods GENERA_LINEA
    importing
      !IDMSG type ZIDMSG
      !IDESTRUCTURA type TABNAME optional
      !ESTRUCTURA type ANY
      !TRANSFORMACION type ANY default ''
    exporting
      !TAMANYO_LINEA type INT4
      value(LINEA) type STRING
      !MENSAJE type BAPI_MSG .
  class-methods MODIFICA_MSG
    importing
      !IDMSG type ZIDMSG
      !IDESTRUCTURA type TABNAME
      value(LINEA) type STRING
    returning
      value(I_VALORES) type ZWHS_VALORES_T .
  class-methods MUESTRA_MSG
    importing
      !IDCOLA type ZIDCOLA
      !EDITAR type ABAP_BOOL default ''
    returning
      value(MENSAJE) type BAPI_MSG .
  class-methods UPDATE_CAMPOS_ESTRUCTURA
    importing
      !IDMSG type ZIDMSG
      !IDESTRUCTURA type TABNAME
    returning
      value(MENSAJE) type BAPI_MSG .
  class-methods ACTUALIZA_MSG
    importing
      !IDMSG type ZIDMSG
      !IDESTRUCTURA type TABNAME
      value(I_VALORES) type ZWHS_VALORES_T
    returning
      value(LINEA) type STRING .
  class-methods COLA_2_FICHERO
    importing
      !PREGUNTAR_RUTA_LOCAL type ABAP_BOOL default ''
      !IDCOLA type ZIDCOLA
      !RUTA_FORZADA type ANY default ''
      !VERIFICAR_ESTADO type ABAP_BOOL default 'X'
      !REGENERAR type ABAP_BOOL default ''
      !NO_INFO_REPROCESO type ABAP_BOOL default ''
    exporting
      !MENSAJE type BAPI_MSG
      !RUTA type ZFICHERO132 .
*      !R_OTROS type FIP_T_MAKTX_RANGE optional  "Eliminar FIP_T_MAKTX_RANGE prerequisitos SUM
  class-methods SELECT_COLA
    importing
      !R_IDCOLA type LXHME_RANGE_N10_T optional
      !R_IDMSG type ZCL_AP_RANGO=>TAB_RANGE_C3 optional
      !R_ESTADO type LXHME_RANGE_C1_T optional
      !R_OBJKEY type ZRANGE_OBJKEY_T optional
      !R_FECHAC type TPMY_R_DATE optional
      !R_HORAC type EMMA_TIME_RANGE_TAB optional
      !R_USUARIO type ZCL_AP_RANGO=>TAB_RANGE_C12 optional
      !R_E_S type LXHME_RANGE_C1_T optional
      !IDCLIENTE type ZIDCLIENTE_WHS optional
      !R_PENDIENTE type LXHME_RANGE_C1_T optional
      !R_ENTREGA type ZCL_AP_RANGO=>TAB_RANGE_C10 optional
      !R_MATNR type RANGE_T_MATNR optional
      !R_CHARG type ZCL_AP_RANGO=>TAB_RANGE_C10 optional
      !R_EXIDV type LXHME_RANGE_C20_T optional
      !R_FECHA type TPMY_R_DATE optional
      !R_AUFNR type RANGE_T_AUFNR optional
      !R_AUART type TMS_T_AUART_RANGE optional
      !INCLUIR_ARCHIVADOS type ABAP_BOOL default ''
      !R_LGORT type RANGE_T_LGORT_D optional
      !R_LOG type ZRANGE_T_MSG optional
      !R_OTROS type ZWHT_OTROS_RANGE optional
      !MAX_ENTRIES type I default 99999
      !R_BUKRS type TPMY_RANGE_BUKRS optional
      !R_BELNR type ZCL_AP_RANGO=>TAB_RANGE_C10 optional
      !R_GJAHR type MRMRBBW_RANGE_GJAHR_T optional
      !R_CPUDT type TPMY_R_DATE optional
      !R_CPUTM type EMMA_TIME_RANGE_TAB optional
      !R_EQUIPO type ZCL_AP_RANGO=>TAB_RANGE_C10 optional
      !R_FEXPE type TPMY_R_DATE optional
      !R_CAMION type ZCL_AP_RANGO=>TAB_RANGE_C10 optional
      !R_MUELLE type RANGE_T_LGORT_D optional
      !R_WERKS type ZCL_AP_RANGO=>TAB_RANGE_C4 optional
      !R_LIFNR type ZCL_AP_RANGO=>TAB_RANGE_C10 optional
      !R_TANUM type LXHME_RANGE_N10_T optional
      !R_PEDIDO type ZCL_AP_RANGO=>TAB_RANGE_C10 optional
      !R_EBELN type ZCL_AP_RANGO=>TAB_RANGE_C10 optional
      !R_AUFNR2 type RANGE_T_AUFNR optional
    returning
      value(I_COLA) type ZWHS_MONITOR_T .
  class-methods UPDATE_COLA_MEM
    changing
      !MONITOR type ZWHS_MONITOR .
  class-methods FICHERO_2_COLA
    importing
      !RUTA type ANY
      !TCODE type SY-TCODE default SY-TCODE
      !CONTENIDO type ANY optional
      !BACKUP type ABAP_BOOL default 'X'
      !IDMSG type ZIDMSG default ''
      !SIMULACION type ABAP_BOOL default ''
      !FECHA_FICHERO type SY-DATUM default SY-DATUM
      !HORA_FICHERO type SY-UZEIT default SY-UZEIT
      !FICHERO_FICTICIO type ABAP_BOOL default ''
    exporting
      !IDCOLA type ZIDCOLA
      !MENSAJE type BAPI_MSG
      !COLA type ZWHS_COLA .
  class-methods PROCESA_MSG
    importing
      value(IDCOLA) type ZIDCOLA
      !TCODE type TCODE default SY-TCODE
      !MODO_CT type CHAR1 default 'N'
      !FORZAR_REPROCESO type ABAP_BOOL default ''
      !SIMULAR type CHAR1 default ''
    exporting
      !MENSAJE type BAPI_MSG .
  class-methods GET_LINEA
    importing
      !IDMSG type ZIDMSG
      !IDESTRUCTURA type TABNAME optional
      value(LINEA) type STRING
    exporting
      !ESTRUCTURA type ANY
      !MENSAJE type BAPI_MSG .
  class-methods BORRA_MSG
    importing
      !IDCOLA type ZIDCOLA
    returning
      value(MENSAJE) type BAPI_MSG .
  class-methods FORMATEA_CAMPO
    importing
      !IDMSG type ZIDMSG
      !IDESTRUCTURA type TABNAME
      !IDCAMPO type FIELDNAME
      !ENTRADA type ANY
      !CONVERTIR type ABAP_BOOL default 'X'
    exporting
      !SALIDA type STRING
      !MENSAJE type BAPI_MSG .
  class-methods VALOR_EASY2SAP
    importing
      !IDMSG type ZIDMSG
      !IDESTRUCTURA type TABNAME
      !IDCAMPO type FIELDNAME
      !ENTRADA type ANY
      !CONVERTIR type ABAP_BOOL default 'X'
    exporting
      !SALIDA type STRING
      !MENSAJE type BAPI_MSG .
  class-methods INSERTA_LOG
    importing
      value(IDCOLA) type ZIDCOLA
      !TCODE type TCODE default SY-TCODE
      !TIPO type MSGTY default 'E'
      !MENSAJE type ANY optional
      !ARCHIVADO type ABAP_BOOL default ''
      !P1 type ANY optional
      !P2 type ANY optional
      !P3 type ANY optional
      !P4 type ANY optional
      !P5 type ANY optional
      !P6 type ANY optional
      !P7 type ANY optional
      !P8 type ANY optional
      !P9 type ANY optional
      !P10 type ANY optional .
  class-methods CAMBIA_ESTADO_COLA
    importing
      !IDCOLA type ZIDCOLA
      !TCODE type TCODE default SY-TCODE
      !MENSAJE type ANY optional
      !ESTADO type ZESTADO_COLA optional
      !PENDIENTE type ZPENDIENTE optional .
  class-methods GENERA_LINEA_XML
    importing
      !IDMSG type ZIDMSG
      !ESTRUCTURA type ANY
      !TRANSFORMACION type ANY
    exporting
      !TAMANYO_LINEA type INT4
      value(LINEA) type STRING
      !MENSAJE type BAPI_MSG .
  class-methods GENERA_LINEA_TEXTO
    importing
      !IDMSG type ZIDMSG
      !IDESTRUCTURA type TABNAME
      !ESTRUCTURA type ANY
    exporting
      !TAMANYO_LINEA type INT4
      value(LINEA) type STRING
      !MENSAJE type BAPI_MSG .
protected section.
private section.

  class-methods MAPEA_CAMPO_SAP2EASY
    importing
      !IDMSG type ZIDMSG
      !IDESTRUCTURA type TABNAME
      !IDCAMPO type FIELDNAME
      !ENTRADA type ANY
    exporting
      !SALIDA type STRING
      !MENSAJE type BAPI_MSG .
  class-methods MAPEA_CAMPO_EASY2SAP
    importing
      !IDMSG type ZIDMSG
      !IDESTRUCTURA type TABNAME
      !IDCAMPO type FIELDNAME
      !ENTRADA type ANY
    exporting
      !SALIDA type STRING
      !MENSAJE type BAPI_MSG .
endclass. "ZWHS definition
class ZWHS implementation.
method ACTUALIZA_MSG.
  DATA: i_campos TYPE TABLE OF zwhs_campos,
        l_linea(2048),
        l_campo(80),
        l_long TYPE i,
        l_valor TYPE zwhs_valores.

  FIELD-SYMBOLS: <campo> TYPE zwhs_campos.

  CLEAR: linea, l_long.

  SELECT * FROM  zwhs_campos
    INTO TABLE i_campos
   WHERE idmsg         = idmsg
     AND idestructura  = idestructura
   ORDER BY posicion.
  IF sy-subrc = 0.
    LOOP AT i_campos ASSIGNING <campo>.
      READ TABLE i_valores INTO l_valor WITH KEY posicion = <campo>-posicion.
      IF sy-subrc = 0.
        IF <campo>-var = 'X'. "Campo variable
          CONCATENATE '[' l_valor-valor ']' INTO l_valor-valor.
          <campo>-long1 = STRLEN( l_valor-valor ).
        ENDIF.
        l_linea+l_long(<campo>-long1) = l_valor-valor.
      ENDIF.
      ADD <campo>-long1 TO l_long.
    ENDLOOP.
  ENDIF.
  linea = l_linea.

endmethod.
method BORRA_MSG.
  DATA: l_cola TYPE zwhs_cola,
        l_mensaje TYPE zwhs_mensaje,
        i_where TYPE TABLE OF afx_str_where_clause,
        l_where TYPE afx_str_where_clause.

  FIELD-SYMBOLS <valor_cola> TYPE ANY.

* Si el mensaje estaba borrado, busco si tiene definido tabla de la que borrar registros relacionados.
  SELECT SINGLE * FROM zwhs_cola
    INTO l_cola
   WHERE idcola = idcola.
  IF sy-subrc = 0 AND l_cola-estado = 'E'.
    SELECT SINGLE * FROM zwhs_mensaje
      INTO l_mensaje
     WHERE idmsg = l_cola-idmsg.
    IF sy-subrc = 0 AND l_mensaje-tabla_rel NE ''.
      ASSIGN COMPONENT l_mensaje-campo_origen OF STRUCTURE l_cola TO <valor_cola>.
      IF sy-subrc = 0.
        WRITE <valor_cola> TO l_where.
        CONCATENATE '''' l_where '''' INTO l_where.
        CONCATENATE l_mensaje-campo_clave '=' l_where INTO l_where SEPARATED BY space.
        APPEND l_where TO i_where.
        DELETE FROM (l_mensaje-tabla_rel)
         WHERE (i_where).
      ENDIF.
    ENDIF.
  ENDIF.

  DELETE FROM zwhs_cola
   WHERE idcola = idcola.

  DELETE FROM zwhs_log
   WHERE idcola = idcola.

endmethod.
method CAMBIA_ESTADO_COLA.
  DATA l_msg TYPE bapi_msg.

  IF estado IS SUPPLIED.
    UPDATE zwhs_cola
       SET estado = estado
     WHERE idcola = idcola.
    IF sy-subrc = 0.
      CONCATENATE 'Cambio a estado:' estado mensaje INTO l_msg SEPARATED BY space.
      inserta_log( idcola = idcola tcode = tcode tipo = 'I' mensaje = l_msg ).
    ELSE.
      CONCATENATE 'Error cambiando a estado:' estado mensaje INTO l_msg SEPARATED BY space.
      inserta_log( idcola = idcola tcode = tcode tipo = 'E' mensaje = l_msg ).
    ENDIF.
  ENDIF.

  IF pendiente IS SUPPLIED.
    UPDATE zwhs_cola
       SET pendiente = pendiente
     WHERE idcola = idcola.
    IF sy-subrc = 0.
      CONCATENATE 'Cambio a pendiente:' pendiente mensaje INTO l_msg SEPARATED BY space.
      inserta_log( idcola = idcola tcode = tcode tipo = 'I' mensaje = l_msg ).
    ELSE.
      CONCATENATE 'Error cambiando a pendiente:' pendiente mensaje INTO l_msg SEPARATED BY space.
      inserta_log( idcola = idcola tcode = tcode tipo = 'E' mensaje = l_msg ).
    ENDIF.
  ENDIF.

endmethod.
METHOD cola_2_fichero.
  DATA: l_fichero        TYPE string,
        l_cola           TYPE zwhs_cola,
        l_mensaje        TYPE zwhs_mensaje,
        l_log            TYPE zwhs_log,
        l_ruta_out       TYPE zwhs_cola-ruta,
        i_fichero        TYPE TABLE OF string,
        o_ftp            TYPE REF TO zcl_ap_ftp,
        l_indice(3)      TYPE c,
        l_fichero_existe,
        l_objkey         TYPE string,
        l_string         TYPE string,
        l_codepage       TYPE abap_encoding.

  CLEAR mensaje.
  SELECT SINGLE * FROM zwhs_cola
    INTO l_cola
   WHERE idcola = idcola.
  IF sy-subrc NE 0.
    CONCATENATE 'No existe el ID cola' idcola INTO mensaje SEPARATED BY space.
    EXIT.
  ENDIF.

  IF l_cola-estado = 'E' AND verificar_estado = 'X'.
    mensaje = 'No es posible grabar fichero en mensajes con estado erróneo'.
    MESSAGE mensaje TYPE 'I'.
    EXIT.
  ENDIF.

  SELECT SINGLE * FROM zwhs_mensaje
    INTO l_mensaje
  WHERE idmsg = l_cola-idmsg.

  IF l_mensaje-inactivo = 'X'.
    UPDATE zwhs_cola
       SET inactivo = 'X'
     WHERE idcola  = idcola.

    mensaje = 'Mensaje inactivo. No se envía'.
    inserta_log( idcola  = idcola tipo    = 'E'
                 mensaje = mensaje ).
    EXIT.
  ENDIF.

  IF regenerar IS INITIAL AND l_mensaje-formato NE 'S' AND l_mensaje-formato NE 'W'.
    IF l_cola-contenido_ficher IS INITIAL AND NOT l_cola-contenido_zip IS INITIAL AND l_mensaje-formato NE 'W'.
      l_cola-contenido_ficher = zcl_ap_string=>xstring2string( xstring = l_cola-contenido_zip descomprimir = 'X' ).
    ENDIF.
  ELSE.
    CALL FUNCTION l_mensaje-funcion
      EXPORTING
        objkey    = l_cola-objkey
        mensaje   = l_mensaje
      IMPORTING
        contenido = l_cola-contenido_ficher
        message   = mensaje
      CHANGING
        cola      = l_cola.
    MODIFY zwhs_cola FROM l_cola.
    IF mensaje IS INITIAL.
      IF no_info_reproceso IS INITIAL.
        inserta_log( idcola  = l_cola-idcola tipo    = 'S'
                     mensaje = 'Se ha regenerado el mensaje con éxito' ).
      ENDIF.

      "APC20160205 Los mensajes SQL como no generan fichero, ya los datos por finalizados
      IF l_mensaje-formato = 'S'.
        UPDATE zwhs_cola
           SET estado  = 'X'
         WHERE idcola  = idcola.
      ENDIF.
    ELSE.
      inserta_log( idcola  = l_cola-idcola tipo    = 'E' mensaje = mensaje ).
    ENDIF.
  ENDIF.

  CHECK l_mensaje-formato NE 'S'.  "En los mensajes SQL no generamos fichero

  zcl_ap_string=>string2tabla( EXPORTING string = l_cola-contenido_ficher
                                         longitud = 10000
                               CHANGING  tabla = i_fichero ).

  IF l_cola-objkey CS '&'.
    SPLIT l_cola-objkey AT '&' INTO l_objkey l_string.
  ELSE.
    l_objkey = l_cola-objkey.
  ENDIF.

  IF NOT l_mensaje-transformacion IS INITIAL.
    CONCATENATE l_cola-idmsg l_cola-version l_cola-fecha_creacion l_cola-hora_creacion '.' l_objkey '.XML' INTO l_fichero.
  ELSE.
    IF l_cola-idcliente = 'DHL'.
      CONCATENATE 'T'    " Valor constante
                  '013'  "Código de agencia de origen, en vuestro caso “013” Ciudad Real.
                  '_'    " : Constante
                  '001270' " Código de cliente. En vuestro caso “001270”
                  '_'      " Constante
                  sy-datum " Fecha de generación del fichero en formato YYMMDD
                  '_'      " CONSTANTE
                  sy-uzeit "Hora de generación del fichero en formato HHMMSS
                  '.EXP'
                 INTO l_fichero.
    ELSEIF l_cola-idcliente = 'IN2'.
      DATA(l_cliente) = zcl_ap_parametros=>get_atributo1( clave = 'DHL' campo = 'INTEGRA2_COD_CLIENTE' ).
      DATA(l_delegacion) = zcl_ap_parametros=>get_atributo1( clave = 'DHL' campo = 'INTEGRA2_DELEGACION' ).
      CONCATENATE 'I2_CLIE'    " Valor constante
                  l_delegacion
                  l_cliente
                  'FTP'
                  l_cola-objkey+1 "Nº de lote = manifiesto
                  '.'
                  sy-datum " Fecha de generación del fichero
                 INTO l_fichero.
    ELSEIF l_mensaje-formato = 'J'.
      CONCATENATE l_cola-idmsg l_cola-version l_cola-fecha_creacion l_cola-hora_creacion '.' l_objkey '.JSON' INTO l_fichero.
    ELSE.
      CONCATENATE l_cola-idmsg l_cola-version l_cola-fecha_creacion l_cola-hora_creacion '.' l_objkey '.TXT' INTO l_fichero.
    ENDIF.
  ENDIF.

* Si hay un salto de línea al final del fichero lo quito
  IF l_cola-idcliente = 'DHL'.
    DATA(l_long) = strlen( l_cola-contenido_ficher ).
    IF l_long > 3.
      SUBTRACT 2 FROM l_long.
      IF l_cola-contenido_ficher+l_long = cl_abap_char_utilities=>cr_lf.
        l_cola-contenido_ficher = l_cola-contenido_ficher(l_long).
      ENDIF.
    ENDIF.
  ENDIF.


  IF ruta_forzada IS INITIAL.
    l_ruta_out = zwhs_general=>get_ruta_out( idmsg                = l_cola-idmsg
                                             idcliente            = l_cola-idcliente
                                             preguntar_ruta_local = preguntar_ruta_local ).

    SELECT SINGLE protocolo FROM zwhs_interlocuto
      INTO @DATA(l_protocolo)
     WHERE idcliente = @l_cola-idcliente.
  ELSE.
    l_ruta_out = ruta_forzada.
  ENDIF.

  IF l_mensaje-formato = 'W'.
* Los mensajes de tipo WebService no graban fichero
    l_fichero = l_cola-fichero.
    l_ruta_out = l_cola-ruta.
  ELSE.
    IF l_ruta_out(4) = 'ftp:' OR l_protocolo = 'F'.

      IF l_ruta_out(4) = 'ftp:'.
        o_ftp = zwhs_general=>get_ftp( host = l_ruta_out idcliente = l_mensaje-idcliente ).
      ELSE.
        o_ftp = zwhs_general=>get_ftp( idcliente = l_mensaje-idcliente ).
      ENDIF.
      IF o_ftp->error_conexion = 'X'.
        mensaje = 'Error de conexión FTP'.
        RETURN.
      ENDIF.

      ruta = zcl_ap_documentos=>get_directorio_temporal( ).
      ruta = zcl_ap_ficheros=>concat_ruta( directorio = ruta
                                           fichero    = l_fichero ).

      zcl_ap_ficheros=>grabar_fichero( EXPORTING fichero = ruta
                                                 binario = 'X'
                                       IMPORTING mensaje = mensaje
                                       CHANGING  tabla   = i_fichero ).

      IF o_ftp->put( ruta ) = 'X'.
        CONCATENATE l_ruta_out '/' l_fichero INTO ruta.
      ELSE.
        mensaje = 'Error al grabar fichero por FTP'.
      ENDIF.
    ELSE.
      ruta = zcl_ap_ficheros=>concat_ruta( directorio = l_ruta_out
                                           fichero    = l_fichero ).

* APC16052014 Tras el nuevo cambio de nomenclatura quitamos control de duplicados
*    DO 999 TIMES.
*      CLEAR l_fichero_existe.
*      IF ruta CS ':'.
*        IF zcl_ap_ficheros=>existe( ruta ) = 'X'.
*          l_fichero_existe = 'X'.
*        ENDIF.
*      ELSE.
*        OPEN DATASET ruta FOR INPUT IN TEXT MODE ENCODING DEFAULT.
*        IF sy-subrc = 0.
*          l_fichero_existe = 'X'.
*          CLOSE DATASET ruta.
*        ENDIF.
*      ENDIF.
*      IF l_fichero_existe IS INITIAL.
*        EXIT.
*      ELSE.
*        ADD 1 TO l_indice.
*        CONDENSE l_indice NO-GAPS.
*        CONCATENATE l_cola-idmsg l_cola-version l_cola-fecha_creacion l_cola-hora_creacion '.' l_cola-objkey '.' l_indice '.TXT' INTO l_fichero.
*        ruta = zcl_ap_ficheros=>concat_ruta( directorio = l_ruta_out
*                                             fichero    = l_fichero ).
*      ENDIF.
*    ENDDO.

*    IF ruta CS ':' AND sy-batch IS INITIAL.
*      IF l_cola-idcliente = 'DHL'.
*        l_cola-contenido_ficher = zcl_ap_string=>CONVIERTE_CODIFICACION( cadena = l_cola-contenido_ficher outcode = '1100' ).
*      endif.
*
*      DATA(l_xstring) = zcl_ap_string=>string2xstring( l_cola-contenido_ficher ).
*
*
*      DATA(l_long_xstring) = xstrlen( l_xstring ).
*    ENDIF.

*    IF NOT l_xstring IS INITIAL.
*      IF l_cola-idcliente = 'DHL'.
*        l_codepage = '1100'.
*      ENDIF.
*      zcl_ap_ficheros=>grabar_fichero( EXPORTING fichero = ruta
*                                                 xstring      = l_xstring
*                                                 bin_filesize = l_long_xstring
*                                                 codepage = l_codepage
*                                       IMPORTING mensaje = mensaje
*                                       CHANGING  tabla   = i_fichero ).
*    ELSE.


      SELECT SINGLE codepage FROM zwhs_interlocuto
        INTO l_codepage
       WHERE idcliente = l_cola-idcliente.
* 1100: ISO-8859-1
* 4110 - UTF-8
      IF ( l_codepage = '' OR L_CODEPAGE = '0000' )
          AND ( l_cola-idcliente = 'DHL' OR l_cola-idcliente = 'IN2'
           or l_cola-idmsg = 'SOR' ). "La grabación como binario genera saltos de líneas adicionales si la longitud de linea supera los 1024 carácteres
        l_codepage = '1100'.
      ENDIF.
      IF l_codepage NE '' AND l_codepage NE '0000'.
        IF l_codepage = '4110'.
          DATA(l_unicode) = 'X'.
        ENDIF.
        zcl_ap_ficheros=>grabar_fichero( EXPORTING fichero = ruta
                                                   binario = ''
                                                   codepage = l_codepage
                                                   unicode  = l_unicode
                                         IMPORTING mensaje = mensaje
                                         CHANGING  tabla   = i_fichero ).
      ELSE.
        zcl_ap_ficheros=>grabar_fichero( EXPORTING fichero = ruta
                                                   binario = 'X'
                                                   bin_filesize = l_cola-tamanyo_fichero
                                                   string       = l_cola-contenido_ficher
                                         IMPORTING mensaje = mensaje
                                         CHANGING  tabla   = i_fichero ).
      ENDIF.
*endif.
    ENDIF.
  ENDIF.

  IF mensaje IS INITIAL.
    IF l_cola-fecha_fichero IS INITIAL.
      l_cola-fecha_fichero = sy-datum.
      l_cola-hora_fichero = sy-uzeit.
    ENDIF.
    UPDATE zwhs_cola
       SET ruta    = l_ruta_out
           fichero = l_fichero
           estado  = 'X'
           fecha_fichero = l_cola-fecha_fichero
           hora_fichero = l_cola-hora_fichero
     WHERE idcola  = idcola.
    CONCATENATE 'Se ha grabado el fichero local' ruta INTO l_log-mensaje SEPARATED BY space.

    inserta_log( idcola = idcola tipo = 'S' mensaje = l_log-mensaje ).

    IF l_mensaje-espera  > 0.
      l_indice = l_mensaje-espera.
      CONCATENATE 'Esperamos' l_indice 'segundos' INTO l_log-mensaje SEPARATED BY space.
      inserta_log( idcola = idcola tipo = 'I' mensaje = l_log-mensaje ).
      WAIT UP TO l_mensaje-espera SECONDS.
    ENDIF.
  ELSE.
    inserta_log( idcola = idcola mensaje = mensaje ).
  ENDIF.

ENDMETHOD.
METHOD fichero_2_cola.
  DATA: l_msg                       TYPE bapi_msg,
        l_cola                      TYPE zwhs_cola,
        l_cola_dup                  TYPE zwhs_cola,
        l_mensaje                   TYPE zwhs_mensaje,
        l_log                       TYPE zwhs_log,
        i_fichero                   TYPE TABLE OF string,
        l_fichero                   TYPE string,
        l_dir_ftp                   TYPE string,
        l_string                    TYPE string,
        l_ftp                       TYPE string,
        l_ruta_backup               TYPE string,
        l_ruta_file                 TYPE string,
        l_rc                        TYPE i,
        l_ruta                      TYPE string,
        o_ftp                       TYPE REF TO zcl_ap_ftp,
        i_lista                     TYPE TABLE OF string,
        l_fichero_pc                TYPE string,
        l_ok,
        l_letra,
        l_mensaje_cola_previo       TYPE bapi_msg,
        l_tipo_mensaje_cola_previo  TYPE msgty,
        l_mensaje_cola_previo2      TYPE bapi_msg,
        l_tipo_mensaje_cola_previo2 TYPE msgty,
        l_idmsg                     TYPE zidmsg,
        l_fecha_hora_xml            TYPE string,
        o_ws                        TYPE REF TO zcl_ap_ws,
        ztemps                      TYPE ztemps,
        l_codepage                  TYPE abap_encoding,
        l_char4(4),
        l_char3(3).


  FIELD-SYMBOLS <fichero> TYPE string.

  IF ruta IS INITIAL.
    mensaje = 'No ha informado fichero'.
    EXIT.
  ENDIF.

  l_ruta = ruta.
  IF l_ruta(4) = 'ftp:'.
    l_ruta = l_ruta+4.
    l_fichero = zcl_ap_ficheros=>get_nombre_fichero( fichero = l_ruta con_extension = 'X' ).
    l_dir_ftp = zcl_ap_ficheros=>get_directorio_fichero( fichero = l_ruta ).
    REPLACE ALL OCCURRENCES OF '\' IN l_dir_ftp WITH '/'.
    SPLIT l_dir_ftp AT '/' INTO l_ftp l_dir_ftp.
    l_ruta = ruta.
  ELSE.
    DATA: l_ruta255 TYPE text255, l_file255 TYPE text255.

    l_ruta255 = l_ruta.

** INI S4 POST Ajustes DPEREZF 20.12.2018
**    CALL FUNCTION 'DSVAS_DOC_FILENAME_SPLIT'
**      EXPORTING
**        pf_docid    = l_ruta255
**      IMPORTING
**        pf_filename = l_file255.
**    IF sy-subrc <> 0.
**      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
**              WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4 INTO mensaje.
**      CONCATENATE 'Fallo al buscar nombre fichero' mensaje INTO mensaje SEPARATED BY space.
**      EXIT.
**    ELSE.
**    l_fichero = l_file255.
**    ENDIF.
*
*    l_fichero = l_ruta255.
*
** FIN S4 POST Ajustes DPEREZF 20.12.2018
    l_fichero = zcl_ap_ficheros=>get_nombre_fichero( fichero = l_ruta con_extension = 'X' ).

  ENDIF.

*  TRANSLATE l_fichero TO UPPER CASE.

  IF idmsg IS INITIAL.
    l_idmsg = l_fichero(3).
  ELSE.
    l_idmsg = idmsg.
  ENDIF.
  TRANSLATE l_idmsg TO UPPER CASE.

  CLEAR mensaje.
  SELECT SINGLE * FROM zwhs_mensaje
    INTO l_mensaje
   WHERE idmsg = l_idmsg.
  IF sy-subrc NE 0.
    CONCATENATE 'No existe el mensaje' l_idmsg INTO mensaje SEPARATED BY space.
    EXIT.
  ELSEIF l_mensaje-e_s NE 'E'.
    CONCATENATE 'Mensaje' l_idmsg 'no es de entrada' INTO mensaje SEPARATED BY space.
    EXIT.
  ENDIF.

  IF l_ruta(4) = 'ftp:'.
    CONCATENATE 'ftp:' l_ftp INTO l_ftp.
    o_ftp = zwhs_general=>get_ftp( host = l_ftp idcliente = l_mensaje-idcliente directorio = l_dir_ftp ).
    IF o_ftp->error_conexion = 'X'.
      CONCATENATE 'Error conexión FTP' l_dir_ftp INTO mensaje SEPARATED BY space.
      EXIT.
    ENDIF.
*    IF backup = 'X'.
*      l_ruta_file = zwhs_general=>get_ruta_in_backup( idcliente = l_mensaje-idcliente
*                                                      idmsg     = l_mensaje-idmsg ).
*      IF l_ruta_file(4) = 'ftp:'.
*        l_ruta_file = zcl_ap_ficheros=>get_directorio_temporal( ).
*      ENDIF.
*    ELSE.
*      l_ruta_file = zcl_ap_ficheros=>get_directorio_temporal( ).
*    ENDIF.
    TYPES: BEGIN OF t_line,
             line(1024) TYPE c, "x,
           END OF t_line.
    DATA: i_fichero_txt TYPE TABLE OF t_line,
          l_fichero_txt TYPE  t_line.


*    o_ftp->download_binary_file( EXPORTING fichero = l_fichero directorio = l_dir_ftp passive_mode = 'X' IMPORTING i_tabla = i_fichero_txt  ).
    o_ftp->download_text_file( EXPORTING fichero = l_fichero directorio = l_dir_ftp passive_mode = 'X' IMPORTING i_tabla = i_fichero_txt  ).
    IF NOT o_ftp->mensaje_error IS INITIAL.
      CONCATENATE 'Error accediendo a fichero' ruta o_ftp->mensaje_error INTO mensaje SEPARATED BY space.
    ELSE.
      FIELD-SYMBOLS <fichero_txt> TYPE text4096.
      LOOP AT i_fichero_txt INTO l_fichero_txt.
        l_string = l_fichero_txt.
        APPEND l_string TO i_fichero.
      ENDLOOP.
    ENDIF.
*    concatenate l_fichero l_ruta_file into l_fichero.
*    l_ruta_file = '\\SrvSAPD\INTERFACES_DED\Lactiber\Entrada\'.
*    o_ftp->get( EXPORTING fichero = l_fichero dir_temp = l_ruta_file passive_mode = 'X'
*                IMPORTING fichero_pc = l_fichero_pc ok = l_ok ).
*    MESSAGE s398(00) WITH 'Fichero PC' l_fichero_pc .
*    IF l_ok IS INITIAL.
*      CONCATENATE 'Error accediendo a fichero' ruta INTO mensaje SEPARATED BY space.
*    ELSE.
*      CONCATENATE 'Se mueve a fichero' l_fichero_pc INTO l_mensaje_cola_previo SEPARATED BY space.
*      l_tipo_mensaje_cola_previo = 'I'.
**      inserta_log( idcola = l_cola-idcola tipo = 'I' mensaje = l_msg tcode = tcode ).
*
*      zcl_ap_ficheros=>leer_fichero( EXPORTING fichero = l_fichero_pc mostrar_error = ''
*                                     IMPORTING mensaje = mensaje
*                                     CHANGING  tabla   = i_fichero ).
*      IF NOT mensaje IS INITIAL.
*        CONCATENATE 'Error' mensaje 'accediendo a fichero backup' INTO l_mensaje_cola_previo SEPARATED BY space.
**        inserta_log( idcola = l_cola-idcola tipo = 'E' mensaje = l_msg tcode = tcode ).
*        l_tipo_mensaje_cola_previo = 'E'.
*      ENDIF.
*    ENDIF.
  ELSE.
    IF NOT ruta CS '.FICTICIO' AND fichero_ficticio IS INITIAL.
* En JGC, al menos los ficheros de SII, están en codepage 1100, pero los de TETRA no!!
      IF l_mensaje-idcliente NE 'TET'.
        l_codepage = '1100'.
      ENDIF.
      zcl_ap_ficheros=>leer_fichero( EXPORTING fichero = l_ruta mostrar_error = ''
                                               codepage = l_codepage
                                     IMPORTING mensaje = mensaje
                                     CHANGING  tabla   = i_fichero ).

* Si no hemos sido capaces de recuperar el contenido del fichero con un formato, intentamos el otro
      IF i_fichero[] IS INITIAL.
        inserta_log( idcola = l_cola-idcola tipo = 'W' p1 = mensaje p2 = 'no hemos podido leer fichero con codepage' p3 = l_codepage tcode = tcode ).
        IF l_codepage IS INITIAL.
          l_codepage = '1100'.
        ELSE.
          CLEAR: l_codepage, mensaje.
          zcl_ap_ficheros=>leer_fichero( EXPORTING fichero = l_ruta mostrar_error = ''
                                                   codepage = l_codepage
                                         IMPORTING mensaje = mensaje
                                         CHANGING  tabla   = i_fichero ).
          IF i_fichero[] IS INITIAL.
            inserta_log( idcola = l_cola-idcola tipo = 'W' p1 = mensaje p2 = 'no hemos podido leer fichero con codepage' p3 = l_codepage tcode = tcode ).
          ELSE.
            inserta_log( idcola = l_cola-idcola tipo = 'S' p1 = 'Hemos podido leer fichero con codepage' p3 = l_codepage tcode = tcode ).
          ENDIF.
        ENDIF.
      ENDIF.

* A veces llegan carácteres extraños al principio del fichero que tenemos que eliminar
      READ TABLE i_fichero ASSIGNING <fichero> INDEX 1.
      IF sy-subrc = 0.
        l_char3 = <fichero>.
        IF l_char3 = 'ï»¿'.
          <fichero> = <fichero>+3.
        ENDIF.
      ENDIF.

    ENDIF.
  ENDIF.

  IF mensaje IS INITIAL.
    IF NOT ruta CS '.FICTICIO' AND backup = 'X' AND fichero_ficticio IS INITIAL.
      l_ruta_backup = zwhs_general=>get_ruta_in_backup( idcliente = l_mensaje-idcliente
                                                        idmsg     = l_mensaje-idmsg ).
      IF NOT l_ruta_backup IS INITIAL.
        DATA l_txt TYPE text1024.
        l_txt = l_ruta_backup.
        IF l_txt(4) = 'ftp:'.
          l_ruta_backup = l_txt+4.
*          CONCATENATE 'backup/' l_fichero INTO l_ruta_backup.
*          o_ftp->mv( fichero_origen = l_fichero
*                     fichero_destino = l_ruta_backup ).
          CLEAR i_fichero_txt.
          LOOP AT i_fichero INTO l_string.
            l_fichero_txt = l_string.
            APPEND l_fichero_txt TO i_fichero_txt.
          ENDLOOP.
          o_ftp->upload_text_file( EXPORTING fichero = l_fichero directorio = l_ruta_backup i_tabla = i_fichero_txt  ).
          IF NOT o_ftp->mensaje_error IS INITIAL.
            CONCATENATE 'Error copiando fichero a' ruta o_ftp->mensaje_error INTO mensaje SEPARATED BY space.
          ELSE.
            CONCATENATE 'Se copia backup en' l_ruta_backup INTO l_mensaje_cola_previo2 SEPARATED BY space.
            l_tipo_mensaje_cola_previo2 = 'I'.

            IF o_ftp->delete( l_fichero ) = 'X'.
              CONCATENATE 'Se borra fichero' l_fichero 'del ftp' INTO l_mensaje_cola_previo2 SEPARATED BY space.
*            inserta_log( idcola = l_cola-idcola tipo = 'I' mensaje = l_msg tcode = tcode ).
*              l_tipo_mensaje_cola_previo2 = 'I'.
            ELSE.
              CONCATENATE 'Error' o_ftp->mensaje_error 'borrando fichero' l_fichero 'del ftp' INTO l_mensaje_cola_previo2 SEPARATED BY space.
              inserta_log( idcola = l_cola-idcola tipo = 'E' mensaje = l_msg tcode = tcode ).
              l_tipo_mensaje_cola_previo2 = 'E'.
            ENDIF.
          ENDIF.
        ELSE.
          IF l_ruta_backup = l_ruta_file AND l_ruta(4) = 'ftp:'.
            IF o_ftp->delete( l_fichero ) = 'X'.
              CONCATENATE 'Se borra fichero' l_fichero 'del ftp' INTO l_mensaje_cola_previo2 SEPARATED BY space.
*            inserta_log( idcola = l_cola-idcola tipo = 'I' mensaje = l_msg tcode = tcode ).
              l_tipo_mensaje_cola_previo2 = 'I'.
            ELSE.
              CONCATENATE 'Error' o_ftp->mensaje_error 'borrando fichero' l_fichero 'del ftp' INTO l_mensaje_cola_previo2 SEPARATED BY space.
              inserta_log( idcola = l_cola-idcola tipo = 'E' mensaje = l_msg tcode = tcode ).
              l_tipo_mensaje_cola_previo2 = 'E'.
            ENDIF.
          ELSE.
            l_ruta_backup = zcl_ap_ficheros=>concat_ruta( directorio = l_ruta_backup
                                                          fichero    = l_fichero ).
            zcl_ap_ficheros=>grabar_fichero( EXPORTING fichero = l_ruta_backup
                                             IMPORTING mensaje = mensaje
                                             CHANGING  tabla   = i_fichero ).
            IF mensaje IS INITIAL.
              CONCATENATE 'Se copia backup en' l_ruta_backup INTO l_mensaje_cola_previo2 SEPARATED BY space.
              l_tipo_mensaje_cola_previo2 = 'I'.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

  IF mensaje IS INITIAL.
    CLEAR l_cola.
    IF cola-correccion_man  = 'Z'. "Si hemos marcado esto queremos mantener los valores de la cola (ese mensaje se ha creado a partir de otro que le ha pasado parámetros)
      l_cola = cola.
      CLEAR l_cola-correccion_man.
    ENDIF.

    IF simulacion IS INITIAL OR simulacion = 'Y'.
      idcola = l_cola-idcola  = zcl_ap_rango_numero=>siguiente_numero_n10( rango = 'ZIDCOLA' ).
    ENDIF.
    l_cola-idmsg   = l_idmsg.
    IF l_mensaje-idcliente = 'WHS'.
      l_cola-version = l_fichero+3(2).
    ENDIF.
    l_cola-estado  = ''.

    IF NOT ruta CS '.FICTICIO' AND fichero_ficticio IS INITIAL.
      l_cola-contenido_ficher = zcl_ap_string=>tabla2string( tabla = i_fichero ).
    ELSE.
      l_cola-contenido_ficher = contenido.
    ENDIF.

* Si el primer carácter es un caracter no valido, lo eliminamos.
    IF NOT l_cola-contenido_ficher IS INITIAL.
      l_letra = l_cola-contenido_ficher.
      TRANSLATE l_letra TO UPPER CASE.
      IF l_letra(1) NA ' ABCDEFGHIKLMNÑOPQRSTVWXYZ0123456789!#$%&/()=?¿¡,;._-+*/<>{}'.
        l_cola-contenido_ficher = l_cola-contenido_ficher+1.
      ENDIF.
      l_cola-tamanyo_fichero = strlen( l_cola-contenido_ficher ).
    ENDIF.

    IF l_mensaje-comprimir = 'X'.
      l_cola-contenido_zip = zcl_ap_string=>string2xstring( string = l_cola-contenido_ficher comprimir = 'X' ).
      CLEAR l_cola-contenido_ficher.
    ENDIF.

    l_cola-objkey = l_cola-contenido_ficher.
    l_cola-idcliente = l_mensaje-idcliente.

*    IF STRLEN( l_fichero ) >= 19 AND zcl_ap_fechas=>es_valida( l_cola-fecha_fichero ) = 'X'.
*      l_cola-fecha_fichero = l_fichero+5(8).
*      l_cola-hora_fichero = l_fichero+13(6).
*    ELSE.
    IF fecha_fichero IS INITIAL OR zcl_ap_fechas=>es_valida( fecha_fichero ) = ''.
      l_cola-fecha_fichero = sy-datum.
      l_cola-hora_fichero = sy-uzeit.
    ELSE.
      l_cola-fecha_fichero = fecha_fichero.
      l_cola-hora_fichero = hora_fichero.
    ENDIF.

    IF l_cola-fecha_fichero IS INITIAL.
      l_cola-fecha_fichero = sy-datum.
      l_cola-hora_fichero = sy-uzeit.
    ENDIF.
*    ENDIF.

    IF NOT l_mensaje-campo_fecha_hora IS INITIAL.
      CREATE OBJECT o_ws.
      o_ws->string = l_cola-contenido_ficher.
      l_fecha_hora_xml = o_ws->get_xml_value_direct( l_mensaje-campo_fecha_hora ).
      zcl_ap_fechas=>datetimews_2_fechahora( EXPORTING fecha_ws = l_fecha_hora_xml
                                             IMPORTING fecha = l_cola-fecha_fichero hora = l_cola-hora_fichero ).

*APC20180103 Queremos "retrasar" la hora de llegada de los VAC
      IF l_mensaje-idmsg = 'VAC' AND NOT l_cola-fecha_creacion IS INITIAL.
        DATA l_time TYPE t.

        l_time = 5.
        CALL FUNCTION 'C14B_ADD_TIME'
          EXPORTING
            i_starttime = l_cola-hora_fichero
            i_startdate = l_cola-fecha_creacion
            i_addtime   = l_time
          IMPORTING
            e_endtime   = l_cola-hora_fichero
            e_enddate   = l_cola-fecha_creacion.
      ENDIF.

    ENDIF.
    IF l_cola-fecha_creacion IS INITIAL.
      l_cola-fecha_creacion = sy-datum.
      l_cola-hora_creacion = sy-uzeit.
    ENDIF.

    l_cola-timestamp = zcl_ap_fechas=>fechahora_2_timestamp( fecha = l_cola-fecha_fichero hora = l_cola-hora_fichero ).

    l_cola-usuario = sy-uname.

    IF l_ruta(4) = 'ftp:'.
      SPLIT ruta AT l_fichero INTO l_cola-ruta l_cola-fichero.
      l_cola-fichero = l_fichero.
    ELSE.
      l_cola-ruta    = zcl_ap_ficheros=>get_directorio_fichero( ruta ).
      l_cola-fichero = l_fichero.
    ENDIF.

    IF simulacion IS INITIAL OR simulacion = 'Y'.
*APC20150809 Validación ficheros duplicados
      IF NOT ( l_cola-fichero IS INITIAL OR l_cola-fichero CS '.FICTICIO' ) AND  "No queremos que actue esto con los ficheros FICTICIOS
        fichero_ficticio = ''.
        SELECT SINGLE * FROM zwhs_cola
          INTO l_cola_dup
         WHERE fichero = l_cola-fichero
           AND idmsg   = l_cola-idmsg
           AND ruta    = l_cola-ruta
           AND fecha_fichero = l_cola-fecha_fichero
           AND hora_fichero  = l_cola-hora_fichero
           AND idcola NE l_cola-idcola.
        IF sy-subrc = 0.
          l_cola-estado = 'E'.
          l_cola-pendiente = 'D'.
          CONCATENATE 'Fichero ya procesado en mensaje' l_cola_dup-idcola INTO l_mensaje_cola_previo SEPARATED BY space.
          inserta_log( idcola = l_cola-idcola tipo = 'E' mensaje = l_mensaje_cola_previo tcode = tcode ).
        ENDIF.
      ENDIF.

      MODIFY zwhs_cola FROM l_cola.

      CONCATENATE 'Se ha leído el fichero' ruta INTO l_msg SEPARATED BY space.
      inserta_log( idcola = l_cola-idcola tipo = 'S' mensaje = l_msg tcode = tcode ).

      COMMIT WORK AND WAIT.

      IF  NOT l_mensaje_cola_previo IS INITIAL.
        inserta_log( idcola = l_cola-idcola tipo = l_tipo_mensaje_cola_previo mensaje = l_mensaje_cola_previo tcode = tcode ).
      ENDIF.

      IF  NOT l_mensaje_cola_previo2 IS INITIAL.
        inserta_log( idcola = l_cola-idcola tipo = l_tipo_mensaje_cola_previo2 mensaje = l_mensaje_cola_previo2 tcode = tcode ).
      ENDIF.

      l_char4 = l_ruta.
      IF NOT ruta CS '.FICT' AND l_ruta_backup NE l_ruta_file AND l_char4 NE 'ftp:' AND fichero_ficticio IS INITIAL.
        CONCATENATE 'Se borra fichero origen' l_ruta INTO l_msg SEPARATED BY space.
        inserta_log( idcola = l_cola-idcola tipo = 'I' mensaje = l_msg tcode = tcode ).
        CLEAR sy-subrc.
        IF ruta CS ':'.
          CALL METHOD cl_gui_frontend_services=>file_delete
            EXPORTING
              filename             = l_ruta
            CHANGING
              rc                   = l_rc
            EXCEPTIONS
              file_delete_failed   = 1
              cntl_error           = 2
              error_no_gui         = 3
              file_not_found       = 4
              access_denied        = 5
              unknown_error        = 6
              not_supported_by_gui = 7
              wrong_parameter      = 8
              OTHERS               = 9.
        ELSE.
          DELETE DATASET ruta.
        ENDIF.
        IF sy-subrc NE 0.
          CONCATENATE 'Error al borrar el fichero origen' ruta INTO mensaje SEPARATED BY space.
          inserta_log( idcola = l_cola-idcola mensaje = mensaje tcode = tcode ).
        ENDIF.
      ENDIF.
    ENDIF.
  ELSE.
    IF simulacion IS INITIAL.
      inserta_log( idcola = '9999999999' mensaje = mensaje tcode = tcode ).
    ENDIF.
  ENDIF.

  IF simulacion IS INITIAL.
    zcl_ap_dev=>commit( ).
  ELSEIF simulacion = 'Y'. "Nos sirve para ejecución inmedita
    zcl_ap_dev=>commit( ).
    cola = l_cola.
    CALL FUNCTION l_mensaje-funcion
      EXPORTING
        mensaje   = l_mensaje
        simular   = simulacion
        contenido = l_cola-contenido_ficher
      IMPORTING
        message   = mensaje
      CHANGING
        cola      = cola.

    IF NOT mensaje IS INITIAL.
      cola-estado = 'E'.
    ELSE.
      IF cola-estado NE 'P'.
        cola-estado = 'X'.
      ENDIF.
    ENDIF.

    MODIFY zwhs_cola FROM cola.

    IF mensaje IS INITIAL.
      inserta_log( idcola  = cola-idcola tipo    = 'S'  tcode   = tcode
                   mensaje = 'Se ha procesado el mensaje con éxito' ).
    ELSE.
      inserta_log( idcola  = cola-idcola tipo    = 'E' tcode   = tcode
                   mensaje = mensaje ).
    ENDIF.
  ELSE.
    cola = l_cola.
    CALL FUNCTION l_mensaje-funcion
      EXPORTING
        mensaje   = l_mensaje
        simular   = simulacion
        contenido = l_cola-contenido_ficher
      IMPORTING
        message   = mensaje
      CHANGING
        cola      = cola.

    CLEAR ztemps.
    ztemps-clave = 'ZWHS_SIM'.
    CONCATENATE l_mensaje-idmsg l_fichero INTO ztemps-subclave SEPARATED BY '-'.
    ztemps-string = l_cola-contenido_ficher.
    ztemps-erdat = sy-datum.
    ztemps-erzet = sy-uzeit.
    MODIFY ztemps FROM ztemps.

  ENDIF.


ENDMETHOD.
method FORMATEA_CAMPO.
  DATA: l_campo TYPE zwhs_campos,
        l_nuevo_valor(2048),
        l_long TYPE i,
        l_entero(30),
        l_decimales(10),
        l_string(30),
        l_numero TYPE p DECIMALS 5.

  CLEAR: mensaje, l_nuevo_valor, l_long.

  SELECT SINGLE * FROM  zwhs_campos
    INTO l_campo
   WHERE idmsg         = idmsg
     AND idestructura  = idestructura
     AND idcampo       = idcampo.
  IF sy-subrc NE 0.
    CONCATENATE 'No hay definición de campo para' idmsg idestructura idcampo INTO mensaje SEPARATED BY space.
  ELSE.
    CASE l_campo-tipo_datos.
      WHEN 'B'.
        IF entrada IS INITIAL OR entrada = '0'.
          l_nuevo_valor(1) = '0'.
        ELSE.
          l_nuevo_valor(1) = '1'.
        ENDIF.
      WHEN 'N'.
        CLEAR l_numero.
        SPLIT entrada AT '.' INTO l_entero l_decimales.
        CONDENSE: l_entero NO-GAPS,
                  l_decimales NO-GAPS.

        IF l_campo-long2 IS INITIAL.
          l_decimales = ''.
          l_nuevo_valor(l_campo-long1) = l_entero.
        ELSE.
          CONCATENATE l_decimales '00000000000' INTO l_decimales(l_campo-long2).
          CONCATENATE l_entero l_decimales(l_campo-long2) INTO l_nuevo_valor(l_campo-long1).
        ENDIF.
        zcl_ap_string=>poner_ceros_c( CHANGING cadena = l_nuevo_valor(l_campo-long1) ).

* Los valores 0, en lugar de devolver 000000 devolvemos blanco, sólo en caso de NO ser obligatorio
        IF not ( l_campo-tipo_campo = 'X' or "No obligatorio
                 l_campo-tipo_campo = 'D'    "Valor por defecto
               ).
          IF zcl_ap_string=>es_numero( l_nuevo_valor(l_campo-long1) ) = 'X'.
            l_string = l_entero.
            zcl_ap_string=>quitar_ceros_c( CHANGING cadena = l_string ).
            l_long = STRLEN( l_string ).
            IF l_long < 6.
              l_numero = l_entero.
            ELSE.
              l_numero = -1.
            ENDIF.
            IF l_numero = 0.
              CLEAR l_nuevo_valor(l_campo-long1).
            ENDIF.
          ENDIF.
        ENDIF.

      WHEN 'D'.
        IF entrada = '00000000' OR entrada = ''.
          CLEAR l_nuevo_valor(l_campo-long1).
        ELSE.
          CONCATENATE entrada '000000' INTO l_nuevo_valor(l_campo-long1).
        ENDIF.
      WHEN 'A'.
        l_nuevo_valor(l_campo-long1) = entrada.
      WHEN 'U'.
        DATA l_meins TYPE meins.
        l_meins = entrada.
        WRITE l_meins TO l_nuevo_valor(l_campo-long1).
      WHEN OTHERS.
        WRITE entrada TO l_nuevo_valor(l_campo-long1).
    ENDCASE.
  ENDIF.

  CHECK mensaje IS INITIAL.

  salida = l_nuevo_valor(l_campo-long1).

  IF convertir = 'X'.
    mapea_campo_sap2easy( EXPORTING idmsg        = idmsg
                                    idestructura = idestructura
                                    idcampo      = idcampo
                                    entrada      = salida
                          IMPORTING salida       = salida
                                    mensaje      = mensaje ).
  ENDIF.

endmethod.
method GENERA_LINEA.
  DATA l_transformacion TYPE zwhs_mensaje-transformacion.

  IF NOT idestructura IS INITIAL.
    genera_linea_texto( EXPORTING
                          idmsg         = idmsg
                          idestructura  = idestructura
                          estructura    = estructura
                        IMPORTING
                          tamanyo_linea = tamanyo_linea
                          linea         = linea
                          mensaje       = mensaje
                      ).
  ELSE.
    IF l_transformacion IS INITIAL.
      SELECT SINGLE transformacion FROM zwhs_mensaje
        INTO l_transformacion
       WHERE idmsg = idmsg.
    ENDIF.

    IF l_transformacion IS INITIAL.
      mensaje = 'No es posible generar línea'.
    ELSE.
      genera_linea_xml( EXPORTING
                            idmsg          = idmsg
                            transformacion = l_transformacion
                            estructura     = estructura
                          IMPORTING
                            tamanyo_linea  = tamanyo_linea
                            linea          = linea
                            mensaje        = mensaje
                        ).
    ENDIF.
  ENDIF.

endmethod.
METHOD genera_linea_texto.
  DATA: i_campos      TYPE TABLE OF zwhs_campos,
        l_linea(2048),
        l_campo(80),
        l_long        TYPE i,
        l_string      TYPE string.

  FIELD-SYMBOLS: <campo>     TYPE zwhs_campos,
                 <campo_sap> TYPE any.

  CLEAR: mensaje, l_linea, linea, l_long.

  SELECT * FROM  zwhs_campos
    INTO TABLE i_campos
   WHERE idmsg         = idmsg
     AND idestructura  = idestructura
   ORDER BY posicion.
  IF sy-subrc NE 0.
    CONCATENATE 'No hay definición de campos para' idmsg idestructura INTO mensaje SEPARATED BY space.
  ELSE.

    LOOP AT i_campos ASSIGNING <campo>.
      CONCATENATE 'ESTRUCTURA-' <campo>-idcampo INTO l_campo.
      ASSIGN (l_campo) TO <campo_sap>.
      IF sy-subrc = 0.
        l_string = <campo_sap>.

        IF <campo>-tipo_campo = 'D'.
          IF <campo_sap> IS INITIAL AND NOT <campo>-valor_def IS INITIAL.
            l_string = <campo>-valor_def.
          ENDIF.
        ELSEIF <campo>-tipo_campo = 'F'.
          l_string = <campo>-valor_def.
        ENDIF.

      ELSE.
        IF <campo>-valor_def IS INITIAL.
          CONCATENATE 'Error al acceder al campo' l_campo INTO mensaje SEPARATED BY space.
        ELSE.
          l_string = <campo>-valor_def.
        ENDIF.
      ENDIF.

      formatea_campo( EXPORTING idmsg        = idmsg
                                idestructura = idestructura
                                idcampo      = <campo>-idcampo
                                entrada      = l_string
                      IMPORTING salida       = l_string
                                mensaje      = mensaje ).

*      IF NOT mensaje IS INITIAL.
*        EXIT.
*      ENDIF.

      IF <campo>-tipo_campo = 'X' "Campo obligatorio
         AND l_string IS INITIAL.
        CONCATENATE 'No hay definido valor en campo obligatorio' l_campo INTO mensaje SEPARATED BY space.
*        EXIT.
      ENDIF.

      IF <campo>-var = 'X'. "Campo variable
        CONCATENATE '[' l_string ']' INTO l_string.
        <campo>-long1 = strlen( l_string ).
      ENDIF.

      IF <campo>-long1 > 0.
        l_linea+l_long(<campo>-long1) = l_string.
        ADD <campo>-long1 TO l_long.
      ENDIF.
    ENDLOOP.

  ENDIF.

*  CHECK mensaje IS INITIAL.

*  l_linea+l_long = cl_abap_char_utilities=>newline.

  linea = l_linea.
  tamanyo_linea = l_long.

ENDMETHOD.
METHOD genera_linea_xml.
  DATA: l_string   TYPE string,
        l_errtrans TYPE REF TO cx_invalid_transformation.

  TRY .
      CALL TRANSFORMATION (transformacion)
          SOURCE cab = estructura
          RESULT XML l_string.

    CATCH cx_invalid_transformation INTO l_errtrans.
      mensaje = l_errtrans->get_text( ).
      CONCATENATE 'T' transformacion 'invalida' mensaje INTO mensaje SEPARATED BY space.
      EXIT.
  ENDTRY.

  IF l_string IS INITIAL.
    CONCATENATE 'Error en la transformación' transformacion INTO mensaje SEPARATED BY space.
  ELSE.
    REPLACE '<?xml version="1.0" encoding="utf-16"?>' WITH '<?xml version="1.0" encoding="utf-8"?>' INTO l_string.

    DATA: i_string TYPE TABLE OF string.                  "APC20190225 HANA
    i_string = zcl_ap_ws=>xml_str2table( l_string ).      "APC20190225 HANA
    l_string = zcl_ap_string=>tabla2string( i_string ).   "APC20190225 HANA

    linea = l_string.
    tamanyo_linea = strlen( l_string ).
  ENDIF.

ENDMETHOD.
METHOD genera_msg.
  DATA: l_mensaje      TYPE zwhs_mensaje,
        l_tfdir        TYPE tfdir,
        l_log          TYPE zwhs_log,
        l_cola         TYPE zwhs_cola,
        l_message      TYPE bapi_msg,
        l_interlocutor TYPE zwhs_interlocuto.

  CLEAR: l_cola, mensaje.

  MOVE-CORRESPONDING cola TO l_cola.
  l_cola-fecha_creacion = sy-datum.
  l_cola-hora_creacion  = sy-uzeit.
  l_cola-usuario        = uname.
  l_cola-tcode          = tcode.
  l_cola-objkey         = objkey.


  SELECT SINGLE * FROM zwhs_mensaje
    INTO l_mensaje
  WHERE idmsg = idmsg.
  IF sy-subrc NE 0.
    CONCATENATE 'No existe parametrización para mensaje' idmsg INTO mensaje SEPARATED BY space.
  ELSE.
    MOVE-CORRESPONDING l_mensaje TO l_cola.
    IF l_mensaje-funcion IS INITIAL.
      CONCATENATE 'Mensaje' idmsg 'no tiene función definida' INTO mensaje SEPARATED BY space.
    ELSE.
      SELECT SINGLE * FROM tfdir
        INTO l_tfdir
      WHERE funcname = l_mensaje-funcion.
      IF sy-subrc NE 0.
        CONCATENATE 'Mensaje' idmsg 'función' l_mensaje-funcion 'no existe' INTO mensaje SEPARATED BY space.
      ELSE.
        IF envio_en_fondo = 'X'.
          DATA o_job TYPE REF TO zcl_ap_jobs.

          CREATE OBJECT o_job
            EXPORTING
              jobname = 'ZWHS_GEN_MENSAJE'.

          o_job->abrir( ).

          IF NOT o_job->jobcount IS INITIAL.
            SUBMIT zwhs_msg
               AND RETURN
              WITH p_idmsg = idmsg
              WITH p_objkey = l_cola-objkey
            VIA JOB o_job->jobname NUMBER o_job->jobcount.

            o_job->cerrar( inmediato = '' retraso = retraso_job ).
            EXIT. "Si hemos lanzado el job con éxito salimos
          ELSE.
            mensaje = 'Error lanzando job'.
          ENDIF.
        ELSE.
          idcola = l_cola-idcola = zcl_ap_rango_numero=>siguiente_numero_n10( rango = 'ZIDCOLA' ).

          IF cola_ref IS INITIAL AND var1 IS INITIAL AND var2 IS INITIAL AND modo_ct IS INITIAL.
            CALL FUNCTION l_mensaje-funcion
              EXPORTING
                objkey    = l_cola-objkey
                mensaje   = l_mensaje
              IMPORTING
                contenido = l_cola-contenido_ficher
                message   = mensaje
              CHANGING
                cola      = l_cola.
          ELSE.
            DATA: ptab      TYPE abap_func_parmbind_tab,
                  ptab_line TYPE abap_func_parmbind,
                  etab      TYPE abap_func_excpbind_tab,
                  etab_line TYPE abap_func_excpbind.

            ptab_line-name = 'OBJKEY'.
            ptab_line-kind = abap_func_exporting.
            GET REFERENCE OF l_cola-objkey INTO ptab_line-value.
            INSERT ptab_line INTO TABLE ptab.

            ptab_line-name = 'MENSAJE'.
            ptab_line-kind = abap_func_exporting.
            GET REFERENCE OF l_mensaje INTO ptab_line-value.
            INSERT ptab_line INTO TABLE ptab.

            IF NOT cola_ref IS INITIAL.
              ptab_line-name = 'COLA_REF'.
              ptab_line-kind = abap_func_exporting.
              GET REFERENCE OF cola_ref INTO ptab_line-value.
              INSERT ptab_line INTO TABLE ptab.
            ENDIF.

            IF NOT var1 IS INITIAL.
              ptab_line-name = 'VAR1'.
              ptab_line-kind = abap_func_exporting.
              GET REFERENCE OF var1 INTO ptab_line-value.
              INSERT ptab_line INTO TABLE ptab.
            ENDIF.

            IF NOT var2 IS INITIAL.
              ptab_line-name = 'VAR2'.
              ptab_line-kind = abap_func_exporting.
              GET REFERENCE OF var2 INTO ptab_line-value.
              INSERT ptab_line INTO TABLE ptab.
            ENDIF.

            IF NOT modo_ct IS INITIAL.
              ptab_line-name = 'MODO_CT'.
              ptab_line-kind = abap_func_exporting.
              GET REFERENCE OF modo_ct INTO ptab_line-value.
              INSERT ptab_line INTO TABLE ptab.
            ENDIF.

            ptab_line-name = 'CONTENIDO'.
            ptab_line-kind = abap_func_importing.
            GET REFERENCE OF l_cola-contenido_ficher INTO ptab_line-value.
            INSERT ptab_line INTO TABLE ptab.

            ptab_line-name = 'MESSAGE'.
            ptab_line-kind = abap_func_importing.
            GET REFERENCE OF mensaje INTO ptab_line-value.
            INSERT ptab_line INTO TABLE ptab.

            ptab_line-name = 'COLA'.
            ptab_line-kind = abap_func_changing.
            GET REFERENCE OF l_cola INTO ptab_line-value.
            INSERT ptab_line INTO TABLE ptab.

            TRY.
                CALL FUNCTION l_mensaje-funcion
                  PARAMETER-TABLE ptab.
              CATCH cx_root INTO DATA(o_root).
                mensaje = o_root->get_text( ).
            ENDTRY.

          ENDIF.

          IF l_mensaje-comprimir = 'X'.
            l_cola-contenido_zip = zcl_ap_string=>string2xstring( string = l_cola-contenido_ficher comprimir = 'X' ).
            CLEAR l_cola-contenido_ficher.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

  IF NOT mensaje IS INITIAL.
    IF mensaje(1) = '!'.
      l_cola-estado = 'A'.
      mensaje = mensaje+1.
    ELSEIF mensaje(10) = '(NO ERROR)'.
    ELSE.
      l_cola-estado = 'E'.
    ENDIF.
  ENDIF.

  IF idcola IS INITIAL.
    idcola = l_cola-idcola = zcl_ap_rango_numero=>siguiente_numero_n10( rango = 'ZIDCOLA' ).
  ENDIF.
  MODIFY zwhs_cola FROM l_cola.

  IF mensaje IS INITIAL OR mensaje(10) = '(NO ERROR)'.
    IF mensaje(10) = '(NO ERROR)' AND mensaje+10 NE ''.
      inserta_log( idcola  = l_cola-idcola tipo    = 'S'  tcode   = tcode
                   mensaje = mensaje+10 ).
    ELSE.
      IF l_mensaje-formato NE 'T'. "En mensajes definidos como tabla no genramos este mensaje para que se quede el del log
        inserta_log( idcola  = l_cola-idcola tipo    = 'S'  tcode   = tcode
                     mensaje = 'Se ha generado el mensaje con éxito' ).
      ENDIF.
    ENDIF.

* Si se ha generado bien el mensaje y está activa la salida inmediata, enviamos el fichero
    IF l_mensaje-e_s = 'S'.
      IF l_mensaje-formato = '' OR "Fichero plano
         l_mensaje-formato = 'C' OR "CSV
         l_mensaje-formato = 'X'.   "XML
        SELECT SINGLE * FROM zwhs_interlocuto
          INTO l_interlocutor
         WHERE idcliente = l_mensaje-idcliente.
        IF sy-subrc = 0 AND l_interlocutor-envio_msg_inm = 'X'.
          cola_2_fichero( EXPORTING idcola  = l_cola-idcola
                          IMPORTING ruta    = l_cola-fichero
                                    mensaje = mensaje ).
        ENDIF.
      ENDIF.
    ENDIF.
  ELSE.
    inserta_log( idcola  = l_cola-idcola tipo    = 'E' tcode   = tcode
                 mensaje = mensaje ).
  ENDIF.

  IF commit = 'X'.
    zcl_ap_dev=>commit( ).
  ENDIF.

ENDMETHOD.
METHOD get_linea.
  DATA: i_valores        TYPE zwhs_valores_t,
        l_campo(40),
        l_string         TYPE string,
        l_transformacion TYPE zwhs_mensaje-transformacion,
        l_err_trans      TYPE REF TO cx_invalid_transformation,
        l_err_match      TYPE REF TO cx_st_match_element,
        l_err_match_type TYPE REF TO cx_st_match_type,
        l_err_conv       TYPE REF TO cx_sy_conversion_data_loss,
        l_err_call_st    TYPE REF TO cx_call_st_error,
        l_err_root       TYPE REF TO cx_root.
  FIELD-SYMBOLS: <valor_in>  TYPE zwhs_valores,
                 <valor_out> TYPE any.

  IF NOT idestructura IS INITIAL.

    i_valores = modifica_msg( idmsg        = idmsg
                                       idestructura = idestructura
                                       linea        = linea ).

    LOOP AT i_valores ASSIGNING <valor_in>.
      CONCATENATE 'ESTRUCTURA-' <valor_in>-idcampo INTO l_campo.
      ASSIGN (l_campo) TO <valor_out>.
      IF sy-subrc = 0.
        l_string = <valor_in>-valor.
* Quitamos posibles valores "raros"
        IF l_string CS 'Ã#Â'.
          REPLACE ALL OCCURRENCES OF 'Ã#Â' IN l_string WITH ''.
        ENDIF.
        valor_easy2sap( EXPORTING idmsg        = idmsg
                                  idestructura = idestructura
                                  idcampo      = <valor_in>-idcampo
                                  entrada      = l_string
                        IMPORTING salida       = l_string
                                  mensaje      = mensaje ).
        TRY.
            <valor_out> = l_string.
          CATCH cx_root INTO l_err_root.  "Caza cualquier excepción que no sea ninguna de las anteriores
            mensaje = l_err_root->get_text( ).
            CONCATENATE 'Error en convesión campo' <valor_in>-idcampo l_string mensaje INTO mensaje SEPARATED BY space.
        ENDTRY.
      ENDIF.
    ENDLOOP.
  ELSE.
    SELECT SINGLE transformacion FROM zwhs_mensaje
      INTO l_transformacion
     WHERE idmsg = idmsg.

    IF l_transformacion IS INITIAL.
      mensaje = 'No es posible generar línea'.
    ELSEIF linea IS INITIAL.
      mensaje = 'Mensaje vacío'.
    ELSE.
      TRY .
          CALL TRANSFORMATION (l_transformacion)
              SOURCE XML linea
              RESULT cab = estructura.

        CATCH cx_sy_conversion_data_loss INTO l_err_conv.
          mensaje = l_err_conv->get_text( ).
          CONCATENATE 'T:' l_transformacion mensaje INTO mensaje SEPARATED BY space.
          EXIT.
        CATCH cx_invalid_transformation INTO l_err_trans.
          mensaje = l_err_trans->get_text( ).
          CONCATENATE 'T:' l_transformacion mensaje INTO mensaje SEPARATED BY space.
          EXIT.
        CATCH cx_st_match_element INTO l_err_match.
          mensaje = l_err_match->get_longtext( ).
          IF mensaje IS INITIAL. mensaje = l_err_match->get_text( ). ENDIF.
          CONCATENATE 'T:' l_transformacion mensaje INTO mensaje SEPARATED BY space.
          EXIT.
        CATCH cx_call_st_error INTO l_err_call_st.
          mensaje = l_err_call_st->get_longtext( ).
          IF mensaje IS INITIAL. mensaje = l_err_call_st->get_text( ). ENDIF.
          CONCATENATE 'T:' l_transformacion mensaje INTO mensaje SEPARATED BY space.
          EXIT.
        CATCH cx_st_match_type INTO l_err_match_type.
          mensaje = l_err_match_type->get_longtext( ).
          IF mensaje IS INITIAL. mensaje = l_err_match_type->get_text( ). ENDIF.
          CONCATENATE 'T:' l_transformacion mensaje INTO mensaje SEPARATED BY space.
          EXIT.
        CATCH cx_root INTO l_err_root.  "Caza cualquier excepción que no sea ninguna de las anteriores
          mensaje = l_err_root->get_text( ).
          CONCATENATE 'T:' l_transformacion mensaje INTO mensaje SEPARATED BY space.
          EXIT.
      ENDTRY.

      IF estructura IS INITIAL.
        CONCATENATE 'Error en la transformación' l_transformacion INTO mensaje SEPARATED BY space.
      ENDIF.
    ENDIF.
  ENDIF.

ENDMETHOD.
METHOD inserta_log.
  DATA: l_log          TYPE zwhs_log,
        o_mail         TYPE REF TO zcl_ap_envio_mail,
        l_destinatario TYPE znotificar_a,
        l_cola         TYPE zwhs_cola,
        l_mensaje      TYPE zwhs_mensaje,
        l_subject      TYPE string,
        l_urgente      TYPE abap_bool,
        l_texto        TYPE string,
        l_cont         TYPE i,
        i_last_log     TYPE TABLE OF zwhs_log.
  FIELD-SYMBOLS <last_log> TYPE zwhs_log.

  CHECK NOT idcola IS INITIAL.

  IF tipo = 'I'.
    SELECT SINGLE * FROM zwhs_log
      INTO l_log
     WHERE idcola  = idcola
       AND tipo    = tipo
       AND mensaje = mensaje.
    IF sy-subrc = 0.
*APC20150217 Si un mensaje informativo ya existía lo borramos y lo volvemos a informar con la última fecha/hora
      DELETE FROM  zwhs_log
       WHERE idcola   = l_log-idcola
         AND fecha    = l_log-fecha
         AND hora     = l_log-hora
         AND usuario  = l_log-usuario
         AND cont     = l_log-cont.
    ENDIF.
  ENDIF.

  CLEAR l_log.
  l_log-idcola  = idcola.
  l_log-fecha   = sy-datum.
  l_log-hora    = sy-uzeit.
  l_log-usuario = sy-uname.
  l_log-tcode   = tcode.

  IF archivado IS INITIAL.
    SELECT MAX( cont ) FROM  zwhs_log
      INTO l_log-cont
     WHERE idcola   = l_log-idcola
       AND fecha    = l_log-fecha
       AND hora     = l_log-hora
       AND usuario  = l_log-usuario.
  ELSE.
    SELECT MAX( cont ) FROM  zwhs_log_bak
      INTO l_log-cont
     WHERE idcola   = l_log-idcola
       AND fecha    = l_log-fecha
       AND hora     = l_log-hora
       AND usuario  = l_log-usuario.
  ENDIF.

  SELECT * FROM  zwhs_log
    INTO TABLE i_last_log
     UP TO 2 ROWS
   WHERE idcola   = l_log-idcola
   ORDER BY fecha DESCENDING hora DESCENDING cont DESCENDING.

  IF tipo = 'E'.
* Detectamos si hay varios duplicados del mismo mensaje
*    SELECT * FROM  zwhs_log
*      INTO TABLE i_last_log
*       UP TO 2 ROWS
*     WHERE idcola   = l_log-idcola
*     ORDER BY fecha DESCENDING hora DESCENDING cont DESCENDING.
* Si el mensaje es el mismo que había, borramos la última entrada repetida
    CLEAR l_cont.
    LOOP AT i_last_log ASSIGNING <last_log> WHERE mensaje = mensaje.
      ADD 1 TO l_cont.
    ENDLOOP.
    IF l_cont = 2.
      READ TABLE i_last_log ASSIGNING <last_log> INDEX 1.
      DELETE FROM zwhs_log
       WHERE idcola   = <last_log>-idcola
         AND fecha    = <last_log>-fecha
         AND hora     = <last_log>-hora
         AND usuario  = <last_log>-usuario
         AND cont     = <last_log>-cont.
    ENDIF.
  ENDIF.

  ADD 1 TO l_log-cont.
  l_log-tipo    = tipo.

  IF NOT mensaje IS INITIAL.
    l_log-mensaje = mensaje.
  ELSEIF NOT p1 IS INITIAL.
    l_log-mensaje = zcl_ap_utils=>concat( p1 = p1 p2 = p2 p3 = p3 p4 = p4 p5 = p5 p6 = p6 p7 = p7 p8 = p8 p9 = p9 p10 = p10 ).
  ENDIF.
  CONDENSE l_log-mensaje.

* APC20230209 Si el último mensaje ya existía en el mismo segundo, no lo insertamos
  READ TABLE i_last_log ASSIGNING <last_log> INDEX 1.
  IF sy-subrc = 0.
    IF <last_log>-mensaje = l_log-mensaje AND <last_log>-fecha = l_log-fecha.
      IF ( <last_log>-hora - l_log-hora ) < 3.
        RETURN.
      ENDIF.
    ENDIF.
  ENDIF.


  IF archivado IS INITIAL.
    MODIFY zwhs_log FROM l_log.
  ELSE.
    MODIFY zwhs_log_bak FROM l_log.
  ENDIF.

  IF tipo = 'A'.
    SELECT SINGLE * FROM zwhs_cola
      INTO l_cola
     WHERE idcola = idcola.
    IF sy-subrc = 0.
      SELECT SINGLE * FROM zwhs_mensaje
        INTO l_mensaje
       WHERE idmsg = l_cola-idmsg.
      IF l_mensaje-notificar_a = 'NO'.
        CLEAR l_destinatario.
      ELSEIF l_mensaje-notificar_a NE ''.
        l_destinatario = l_mensaje-notificar_a.
      ELSE.
        SELECT SINGLE notificar_a FROM zwhs_interlocuto
          INTO l_destinatario
         WHERE idcliente = l_mensaje-idcliente.
      ENDIF.
    ENDIF.

    IF NOT l_destinatario IS INITIAL.
      CREATE OBJECT o_mail.

      CONCATENATE 'Error mensaje' l_mensaje-idmsg l_cola-objkey INTO l_subject SEPARATED BY space.

      IF l_mensaje-e_s = 'S'.
        o_mail->set_text( 'Se ha producido un error al procesar el mensaje de SALIDA' ).
      ELSE.
        o_mail->set_text( 'Se ha producido un error al procesar el mensaje de ENTRADA' ).
      ENDIF.

      o_mail->set_text( '<br></br><h3>DETALLES</h3>' ).
      o_mail->cabecera_html( charset = 'ISO-8859-1' ).

      o_mail->inicio_tabla_html( c1 = 'Campo'
                                 c2 = 'Valor' ).

      o_mail->add_fila_html( c1 = 'Clave objeto' c2 = l_cola-idcola ).
      o_mail->add_fila_html( c1 = 'Mensaje' c2 = l_mensaje-descripcion ).
      o_mail->add_fila_html( c1 = 'Error' c2 = mensaje ).
      o_mail->add_fila_html( c1 = 'Id.Cola' c2 = idcola ).
      o_mail->add_fila_html( c1 = 'Fecha' c2 = l_log-fecha ).
      o_mail->add_fila_html( c1 = 'Hora' c2 = l_log-hora ).
      o_mail->add_fila_html( c1 = 'Usuario' c2 = l_log-usuario ).
      o_mail->add_fila_html( c1 = 'Transacción' c2 = l_log-tcode ).

      o_mail->fin_tabla_html( ).

      IF tipo = 'A'.
        l_urgente = 'X'.
        CONCATENATE 'URGENTE' l_subject INTO l_subject SEPARATED BY space.
      ENDIF.

      CALL METHOD o_mail->envio_mail
        EXPORTING
          subject   = l_subject
          direccion = l_destinatario
          urgente   = l_urgente
          html      = 'X'.

    ENDIF.
  ENDIF.

ENDMETHOD.
method MAPEA_CAMPO_EASY2SAP.
  DATA: l_mapeo TYPE zwhs_mapeo.

  CLEAR: mensaje.

  SELECT SINGLE valor_sap FROM  zwhs_mapeo
    INTO l_mapeo-valor_sap
   WHERE idmsg         = idmsg
     AND idestructura  = idestructura
     AND idcampo       = idcampo
     AND valor_easy    = entrada.
  IF sy-subrc = 0.
    salida = l_mapeo-valor_sap.
  ELSE.
    salida = entrada.
  ENDIF.

endmethod.
method MAPEA_CAMPO_SAP2EASY.
  DATA: l_mapeo TYPE zwhs_mapeo.

  CLEAR: mensaje.

  SELECT SINGLE valor_easy FROM  zwhs_mapeo
    INTO l_mapeo-valor_easy
   WHERE idmsg         = idmsg
     AND idestructura  = idestructura
     AND idcampo       = idcampo
     AND valor_sap     = entrada.
  IF sy-subrc = 0.
    salida = l_mapeo-valor_easy.
  ELSE.
    salida = entrada.
  ENDIF.

endmethod.
method MODIFICA_MSG.
  DATA: i_campos TYPE TABLE OF zwhs_campos,
        l_linea(4096),
        l_campo(80),
        l_long TYPE i,
        l_valor TYPE zwhs_valores,
        l_aux1(255), l_aux2(255),
        l_string TYPE string.

  field-symbols: <campo> TYPE zwhs_campos,
                 <campo_sap> TYPE any.

  CLEAR: i_valores, l_linea, l_long.

  SELECT * FROM  zwhs_campos
    INTO TABLE i_campos
   WHERE idmsg         = idmsg
     AND idestructura  = idestructura
   ORDER BY posicion.
  IF sy-subrc = 0.
    l_linea = linea.
    LOOP AT i_campos ASSIGNING <campo>.
      CLEAR l_valor.
      MOVE-CORRESPONDING <campo> TO l_valor.

      IF <campo>-var = 'X'.
        SPLIT l_linea+l_long AT ']' INTO l_string l_aux1.
        <campo>-long1 = STRLEN( l_string ) + 1.
        SPLIT l_string AT '[' INTO l_aux2 l_valor-valor.
      ELSE.
        l_valor-valor = l_linea+l_long(<campo>-long1).
      ENDIF.

      APPEND l_valor TO i_valores.

      ADD <campo>-long1 TO l_long.
    ENDLOOP.

  ENDIF.

endmethod.
METHOD muestra_msg.
  DATA: l_cola         TYPE zwhs_cola,
        l_cola_ant     TYPE zwhs_cola,
        l_mensaje      TYPE zwhs_mensaje,
        l_idestructura TYPE zwhs_campos-idestructura,
        l_string       TYPE string,
        i_string       TYPE TABLE OF string,
        i_valores      TYPE zwhs_valores_t,
        l_cancelado,
        l_archivado,
        l_fichero      TYPE string.

  SELECT SINGLE * FROM zwhs_cola
    INTO l_cola
   WHERE idcola = idcola.
  IF sy-subrc NE 0.
    SELECT SINGLE * FROM zwhs_cola_bak
      INTO CORRESPONDING FIELDS OF l_cola
     WHERE idcola = idcola.
    IF sy-subrc = 0.
      l_archivado = 'X'.
    ELSE.
      CONCATENATE 'No existe el ID' idcola INTO mensaje SEPARATED BY space.
      EXIT.
    ENDIF.
  ENDIF.

  SELECT SINGLE * FROM zwhs_mensaje
    INTO l_mensaje
   WHERE idmsg = l_cola-idmsg.
  IF sy-subrc NE 0.
    CONCATENATE 'No existe el mensaje' l_cola-idmsg INTO mensaje SEPARATED BY space.
    EXIT.
  ENDIF.

  l_cola_ant = l_cola.

  IF NOT l_mensaje-estructura_cab IS INITIAL AND
     l_mensaje-estructura_lin1 IS INITIAL AND
    l_mensaje-estructura_lin2 IS INITIAL.
    l_idestructura = l_mensaje-estructura_cab.
  ENDIF.

  IF l_cola-contenido_ficher IS INITIAL AND NOT l_cola-contenido_zip IS INITIAL.
    IF l_mensaje-formato = 'W'.
      l_fichero = zcl_ap_documentos=>get_directorio_temporal( ).
      l_fichero = zcl_ap_ficheros=>concat_ruta( directorio = l_fichero
                                           fichero    = 'mensaje.zip' ).
      zcl_ap_ficheros=>grabar_xstring( EXPORTING fichero = l_fichero
                                                 xstring = l_cola-contenido_zip ).
      zcl_ap_gos=>visualizar_fichero_st( fichero = l_fichero extension = 'ZIP' ).
      EXIT.
    ELSE.
      l_cola-contenido_ficher = zcl_ap_string=>xstring2string( xstring = l_cola-contenido_zip descomprimir = 'X' ).
    ENDIF.
  ENDIF.

  IF NOT l_idestructura IS INITIAL.
    i_valores = modifica_msg( idmsg        = l_cola-idmsg
                              idestructura = l_idestructura
                              linea        = l_cola-contenido_ficher ).

    IF NOT i_valores IS INITIAL.
      CALL FUNCTION 'Z_WHS_POPUP_EDICION_LINEA'
        EXPORTING
          linea        = l_cola-contenido_ficher
          titulo       = l_idestructura
          idmsg        = l_cola-idmsg
          idestructura = l_idestructura
          editar       = editar
        IMPORTING
          cancelado    = l_cancelado
        CHANGING
          valores      = i_valores.
      IF l_cancelado IS INITIAL.
        l_cola-contenido_ficher = actualiza_msg( idmsg        = l_cola-idmsg
                                                 idestructura = l_idestructura
                                                 i_valores    = i_valores ).
      ENDIF.
    ENDIF.
  ELSE.
    CALL FUNCTION 'Z_WHS_POPUP_EDICION_FICHERO'
      EXPORTING
        idmsg  = l_cola-idmsg
        editar = editar
      CHANGING
        linea  = l_cola-contenido_ficher.
  ENDIF.

  IF l_cola-contenido_ficher NE l_cola_ant-contenido_ficher.
    IF l_archivado IS INITIAL.
      MODIFY zwhs_cola FROM l_cola.
      inserta_log( idcola = l_cola-idcola tipo = 'I' mensaje = 'Se ha editado contenido de mensaje' ).
    ELSE.
      DATA zwhs_cola_bak TYPE zwhs_cola_bak.
      MOVE-CORRESPONDING l_cola TO zwhs_cola_bak.
      MODIFY zwhs_cola_bak FROM zwhs_cola_bak.
      inserta_log( idcola = l_cola-idcola tipo = 'I' mensaje = 'Se ha editado contenido de mensaje' archivado = 'X' ).
    ENDIF.
  ENDIF.

ENDMETHOD.
METHOD procesa_msg.
  DATA: l_mensaje TYPE zwhs_mensaje,
        l_tfdir   TYPE tfdir,
        l_log     TYPE zwhs_log,
        l_cola    TYPE zwhs_cola,
        l_message TYPE bapi_msg,
        l_ok,
        l_string  TYPE string.

  DEFINE salir_metodo.
    CALL FUNCTION 'DEQUEUE_EZWHS_COLA'
      EXPORTING
        mode_zwhs_cola = 'E'
        mandt          = sy-mandt
        idcola         = idcola
        x_idcola       = ' '
        _scope         = '3'
        _synchron      = ' '
        _collect       = ' '.

    zcl_ap_dev=>commit( ).
    EXIT.
  END-OF-DEFINITION.

  CALL FUNCTION 'ENQUEUE_EZWHS_COLA'
    EXPORTING
      mode_zwhs_cola = 'E'
      mandt          = sy-mandt
      idcola         = idcola
      x_idcola       = ' '
      _scope         = '2'
      _wait          = ' '
      _collect       = ' '
    EXCEPTIONS
      foreign_lock   = 1
      system_failure = 2
      OTHERS         = 3.
  IF sy-subrc <> 0.
    mensaje = 'IDCOLA Bloqueada'.
    inserta_log( idcola  = l_cola-idcola tipo    = 'W'  tcode   = tcode
                 mensaje = mensaje ).
    EXIT.
  ENDIF.

  CLEAR mensaje.

  SELECT SINGLE * FROM zwhs_cola
    INTO l_cola
   WHERE idcola = idcola.
  IF sy-subrc NE 0.
    CONCATENATE 'No existe el ID cola' idcola INTO mensaje SEPARATED BY space.
    salir_metodo.
  ENDIF.

  IF forzar_reproceso IS INITIAL AND NOT l_cola-estado IS INITIAL.
    mensaje = 'Mensaje ya procesado previamente'.
    inserta_log( idcola  = l_cola-idcola tipo    = 'W'  tcode   = tcode
                 mensaje = mensaje ).
    salir_metodo.
  ENDIF.

*APC20150809 Si hemos marcado el mensaje como duplicado, no se procesa nunca
  IF l_cola-estado = 'E' AND l_cola-pendiente = 'D'.
    mensaje = 'Mensaje ya procesado previamente en FICHERO PREVIO'.
    inserta_log( idcola  = l_cola-idcola tipo    = 'W'  tcode   = tcode
                 mensaje = mensaje ).
    salir_metodo.
  ENDIF.


  SELECT SINGLE * FROM zwhs_mensaje
    INTO l_mensaje
   WHERE idmsg = l_cola-idmsg
     AND version = l_cola-version.
  IF sy-subrc NE 0.
    SELECT SINGLE * FROM zwhs_mensaje
      INTO l_mensaje
     WHERE idmsg = l_cola-idmsg
       AND formato = 'X'.
  ENDIF.
  IF l_mensaje IS INITIAL.
    CONCATENATE 'No existe parametrización para mensaje' l_cola-idmsg l_cola-version INTO mensaje SEPARATED BY space.
  ELSE.
    IF l_mensaje-funcion IS INITIAL.
      CONCATENATE 'Mensaje' l_cola-idmsg 'no tiene función definida' INTO mensaje SEPARATED BY space.
    ELSE.
      SELECT SINGLE * FROM tfdir
        INTO l_tfdir
      WHERE funcname = l_mensaje-funcion.
      IF sy-subrc NE 0.
        CONCATENATE 'Mensaje' l_cola-idmsg 'función' l_mensaje-funcion 'no existe' INTO mensaje SEPARATED BY space.
      ELSE.

        IF l_mensaje-inactivo = 'X'.
          inserta_log( idcola  = idcola tipo    = 'E'
                       mensaje = 'Mensaje inactivo. No se procesa' ).
        ELSE.
          l_ok = 'X'.
          IF l_mensaje-en_pruebas = 'X'.
            CALL FUNCTION l_mensaje-funcion
              EXPORTING
                mensaje   = l_mensaje
                simular   = 'X'
                contenido = l_cola-contenido_ficher
              CHANGING
                cola      = l_cola.
          ENDIF.

          IF l_ok IS INITIAL.
            inserta_log( idcola  = idcola tipo    = 'E' mensaje = 'Mensaje en pruebas no permitido. No se procesa' ).
            MODIFY zwhs_cola FROM l_cola. "Actualizamos valores
          ELSE.
            IF l_cola-contenido_ficher IS INITIAL AND NOT l_cola-contenido_zip IS INITIAL.
              l_cola-contenido_ficher = zcl_ap_string=>xstring2string( xstring = l_cola-contenido_zip descomprimir = 'X' ).
            ENDIF.

            IF ( l_mensaje-formato = 'S' AND modo_ct NE 'A' ) OR l_mensaje-e_s = 'S'.
              CALL FUNCTION l_mensaje-funcion
                EXPORTING
                  objkey    = l_cola-objkey
                  mensaje   = l_mensaje
                  modo_ct   = modo_ct
                  simular   = simular
                IMPORTING
                  contenido = l_cola-contenido_ficher
                  message   = mensaje
                CHANGING
                  cola      = l_cola.
            ELSE.
              CALL FUNCTION l_mensaje-funcion
                EXPORTING
                  contenido = l_cola-contenido_ficher
                  mensaje   = l_mensaje
                  modo_ct   = modo_ct
                  simular   = simular
                IMPORTING
                  objkey    = l_cola-objkey
                  message   = mensaje
                CHANGING
                  cola      = l_cola.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

  IF NOT mensaje IS INITIAL.
    IF mensaje(10) = '(NO ERROR)'.

    ELSE.
      l_cola-estado = 'E'.
    ENDIF.
  ELSE.
    IF l_cola-estado NE 'P'.
      l_cola-estado = 'X'.

      IF l_mensaje-espera  > 0.
        WAIT UP TO l_mensaje-espera SECONDS.
      ENDIF.
    ENDIF.
  ENDIF.

  MODIFY zwhs_cola FROM l_cola.

  IF mensaje NE 'Se cancela ejecución por popup'.
    IF mensaje IS INITIAL OR mensaje CS 'es de TEST TETRA' OR mensaje(10) = '(NO ERROR)'.
      IF mensaje(10) = '(NO ERROR)' AND mensaje+10 NE ''.
        inserta_log( idcola  = l_cola-idcola tipo    = 'S' tcode   = tcode
                     mensaje = mensaje+10 ).
      ELSE.
        IF l_mensaje-formato NE 'T'. "Dejamos el último mensaje del log.
          inserta_log( idcola  = l_cola-idcola tipo    = 'S'  tcode   = tcode
                       mensaje = 'Se ha procesado el mensaje con éxito' ).
        ENDIF.
      ENDIF.
    ELSE.
      inserta_log( idcola  = l_cola-idcola tipo    = 'E' tcode   = tcode
                   mensaje = mensaje ).
    ENDIF.
  ENDIF.

  salir_metodo.

ENDMETHOD.
METHOD select_cola.
  DATA o_idcli TYPE REF TO zcl_ap_rango.

  FIELD-SYMBOLS <cola> TYPE zwhs_monitor.

  CREATE OBJECT o_idcli
    EXPORTING
      valor_inicial = idcliente.

  IF r_log IS INITIAL.
    SELECT * FROM zwhs_cola JOIN zwhs_mensaje ON zwhs_cola~idmsg = zwhs_mensaje~idmsg
      UP TO max_entries ROWS
      INTO CORRESPONDING FIELDS OF TABLE i_cola
     WHERE idcola          IN r_idcola
       AND zwhs_cola~idmsg IN r_idmsg
       AND estado          IN r_estado
       AND e_s             IN r_e_s
       AND objkey          IN r_objkey
       AND fecha_creacion  IN r_fechac
       AND hora_creacion   IN r_horac
       AND usuario         IN r_usuario
       AND pendiente       IN r_pendiente
       AND entrega         IN r_entrega
       AND pedido          IN r_pedido
       AND ebeln           IN r_ebeln
       AND matnr           IN r_matnr
       AND werks           IN r_werks
       AND lifnr           IN r_lifnr
       AND charg           IN r_charg
       AND exidv           IN r_exidv
       AND aufnr           IN r_aufnr
       AND aufnr2          IN r_aufnr2
       AND auart           IN r_auart
       AND lgort           IN r_lgort
       AND otros           IN r_otros
       AND zwhs_cola~idcliente    IN o_idcli->rango
       AND bukrs           IN r_bukrs
       AND belnr           IN r_belnr
       AND gjahr           IN r_gjahr
       AND fecha_expedicion IN r_fexpe
       AND cpudt           IN r_cpudt
       AND cputm           IN r_cputm
       AND tanum           IN r_tanum.
  ELSE.
    SELECT * FROM zwhs_cola JOIN zwhs_mensaje ON zwhs_cola~idmsg  = zwhs_mensaje~idmsg
                            JOIN zwhs_log     ON zwhs_cola~idcola = zwhs_log~idcola
      UP TO max_entries ROWS
      INTO CORRESPONDING FIELDS OF TABLE i_cola
     WHERE zwhs_cola~idcola IN r_idcola
       AND zwhs_cola~idmsg IN r_idmsg
       AND estado          IN r_estado
       AND e_s             IN r_e_s
       AND objkey          IN r_objkey
       AND fecha_creacion  IN r_fechac
       AND hora_creacion   IN r_horac
       AND zwhs_cola~usuario         IN r_usuario
       AND pendiente       IN r_pendiente
       AND entrega         IN r_entrega
       AND pedido          IN r_pedido
       AND ebeln           IN r_ebeln
       AND matnr           IN r_matnr
       AND werks           IN r_werks
       AND charg           IN r_charg
       AND exidv           IN r_exidv
       AND lifnr           IN r_lifnr
       AND aufnr           IN r_aufnr
       AND auart           IN r_auart
       AND lgort           IN r_lgort
       AND otros           IN r_otros
       AND zwhs_cola~idcliente    IN o_idcli->rango
       AND mensaje         IN r_log
       AND bukrs           IN r_bukrs
       AND belnr           IN r_belnr
       AND gjahr           IN r_gjahr
       AND fecha_expedicion IN r_fexpe
       AND cpudt           IN r_cpudt
       AND cputm           IN r_cputm
       AND tanum           IN r_tanum.
  ENDIF.

  IF incluir_archivados = 'X'.
    SELECT * FROM zwhs_cola_bak JOIN zwhs_mensaje ON zwhs_cola_bak~idmsg = zwhs_mensaje~idmsg
      APPENDING CORRESPONDING FIELDS OF TABLE i_cola
     WHERE idcola          IN r_idcola
       AND zwhs_cola_bak~idmsg IN r_idmsg
       AND estado          IN r_estado
       AND e_s             IN r_e_s
       AND objkey          IN r_objkey
       AND fecha_creacion  IN r_fechac
       AND hora_creacion   IN r_horac
       AND usuario         IN r_usuario
       AND pendiente       IN r_pendiente
       AND entrega         IN r_entrega
       AND matnr           IN r_matnr
       AND werks           IN r_werks
       AND charg           IN r_charg
       AND exidv           IN r_exidv
       AND aufnr           IN r_aufnr
       AND aufnr2          IN r_aufnr2
       AND lifnr           IN r_lifnr
       AND auart           IN r_auart
       AND lgort           IN r_lgort
       AND otros           IN r_otros
       AND zwhs_cola_bak~idcliente    IN o_idcli->rango
       AND bukrs           IN r_bukrs
       AND belnr           IN r_belnr
       AND gjahr           IN r_gjahr
       AND fecha_expedicion IN r_fexpe
       AND cpudt           IN r_cpudt
       AND cputm           IN r_cputm
       AND tanum           IN r_tanum.
  ENDIF.

  SORT i_cola.

  LOOP AT i_cola ASSIGNING <cola>.
    IF r_log[] IS INITIAL.
      SELECT fecha hora tipo mensaje FROM zwhs_log
        INTO CORRESPONDING FIELDS OF <cola>
        UP TO 1 ROWS
       WHERE idcola = <cola>-idcola
        ORDER BY fecha DESCENDING hora DESCENDING cont DESCENDING.
      ENDSELECT.
      IF sy-subrc NE 0.
        SELECT fecha hora tipo mensaje FROM zwhs_log_bak
          INTO CORRESPONDING FIELDS OF <cola>
          UP TO 1 ROWS
         WHERE idcola = <cola>-idcola
          ORDER BY fecha DESCENDING hora DESCENDING cont DESCENDING.
        ENDSELECT.
      ENDIF.
    ENDIF.

    IF NOT <cola>-ruta IS INITIAL.
      <cola>-fichero = zcl_ap_ficheros=>concat_ruta( directorio = <cola>-ruta
                                                     fichero    = <cola>-fichero ).
    ENDIF.

    CASE <cola>-estado.
      WHEN 'X'. <cola>-lights = zcl_ap_alv=>c_sem_verde.
      WHEN 'E'. <cola>-lights = zcl_ap_alv=>c_sem_rojo.
      WHEN 'N'. CLEAR <cola>-lights.
      WHEN OTHERS. <cola>-lights = zcl_ap_alv=>c_sem_ambar.
    ENDCASE.

    IF <cola>-contenido_ficher IS INITIAL AND NOT <cola>-contenido_zip IS INITIAL
      AND <cola>-formato NE 'W'. "En los webservice guardamos datos como referencia, y no queremos descomprimirlos.
      <cola>-contenido_ficher = zcl_ap_string=>xstring2string( xstring = <cola>-contenido_zip descomprimir = 'X' ).
    ENDIF.

    IF <cola>-fecha_fichero IS INITIAL.
      <cola>-fecha_fichero = <cola>-fecha_creacion.
      <cola>-hora_fichero = <cola>-hora_creacion.
    ENDIF.

    IF NOT <cola>-codigo IS INITIAL.
      SELECT SINGLE tipo descripcion FROM zwhs_mot_cest
        INTO (<cola>-tipo_ce, <cola>-descripcion_ce)
       WHERE codigo = <cola>-codigo.

      IF NOT <cola>-tipo_ce IS INITIAL.
        <cola>-tipo_ce = zcl_ap_utils=>get_texto_dominio( dominio = 'ZTIPO_MOT_CEST' valor = <cola>-tipo_ce ).
      ENDIF.
    ENDIF.
  ENDLOOP.

ENDMETHOD.
method UPDATE_CAMPOS_ESTRUCTURA.
  DATA: i_campos TYPE TABLE OF zwhs_campos,
        l_campo TYPE zwhs_campos,
        i_campos_est TYPE ddfields,
        l_mensaje TYPE zwhs_mensaje,
        l_cont TYPE zwhs_campos-posicion.

  FIELD-SYMBOLS: <campo_est> TYPE dfies,
                 <campo> TYPE zwhs_campos.
  CLEAR mensaje.

  SELECT SINGLE * FROM  zwhs_mensaje
    INTO l_mensaje
   WHERE idmsg         = idmsg.
  IF sy-subrc NE 0.
    CONCATENATE 'No existe el mensaje' idmsg INTO mensaje SEPARATED BY space.
    EXIT.
  ENDIF.

  IF l_mensaje-estructura_cab NE idestructura AND
     l_mensaje-estructura_lin1 NE idestructura AND
     l_mensaje-estructura_lin2 NE idestructura.
    CONCATENATE 'Estructura' idestructura 'no parametriada en mensaje' idmsg INTO mensaje SEPARATED BY space.
    EXIT.
  ENDIF.

  i_campos_est = zcl_ap_dev=>get_fieldcatalog_tabla( idestructura ).
  IF i_campos_est IS INITIAL.
    CONCATENATE 'Estructura' idestructura 'errónea' idmsg INTO mensaje SEPARATED BY space.
    EXIT.
  ENDIF.

  SELECT * FROM  zwhs_campos
    INTO TABLE i_campos
   WHERE idmsg         = idmsg
     AND idestructura  = idestructura
   ORDER BY posicion.

  CLEAR l_cont.
  LOOP AT i_campos_est ASSIGNING <campo_est>.
    ADD 10 TO l_cont.
    READ TABLE i_campos ASSIGNING <campo> WITH KEY idcampo = <campo_est>-fieldname.
    IF sy-subrc = 0.
      IF <campo>-descripcion IS INITIAL.
        <campo>-descripcion = <campo_est>-fieldtext.
      ENDIF.
      IF <campo>-long1 IS INITIAL.
        <campo>-long1 = <campo_est>-leng.
      ENDIF.
      IF <campo>-long2 IS INITIAL.
        <campo>-long2 = <campo_est>-decimals.
      ENDIF.
    ELSE.
      CLEAR l_campo.
      l_campo-idmsg         = idmsg.
      l_campo-idestructura  = idestructura.
      l_campo-idcampo       = <campo_est>-fieldname..
      l_campo-posicion      = l_cont.
      l_campo-tipo_campo    = 'O'.
      l_campo-long1         = <campo_est>-leng.
      IF <campo_est>-domname = 'BOOLEAN'.
        l_campo-tipo_datos = 'B'.
      ELSE.
        CASE <campo_est>-datatype.
          WHEN 'DATS'.
            l_campo-tipo_datos = 'D'.
            l_campo-long1 = 14.
          WHEN 'CHAR' OR 'NUMC' OR 'SSTR' OR 'STRG' OR 'LANG' OR 'CUKY'.
            l_campo-tipo_datos = 'A'.
          WHEN 'INT1' OR 'INT2' OR 'INT4' OR 'CURR' OR 'DEC' OR 'FLTP' OR
               'QUAN'.
            l_campo-tipo_datos = 'N'.
        ENDCASE.
      ENDIF.
      CASE <campo_est>-rollname.
        WHEN 'MENGV13' OR 'BOOLEAN'.
        WHEN 'BPERC'.
          L_CAMPO-DESCRIPCION = '%'.
          L_CAMPO-LONG2 = 2.
        WHEN OTHERS.
          IF <campo_est>-rollname(4) = 'CHAR' OR <campo_est>-rollname(3) = 'DEC' OR <campo_est>-rollname(3) = 'INT'
            OR <campo_est>-rollname(4) = 'NUMC' OR <campo_est>-rollname(4) = 'TEXT'.
          ELSE.
            l_campo-descripcion   = <campo_est>-fieldtext.
          ENDIF.
      ENDCASE.
      APPEND l_campo TO i_campos.
    ENDIF.
  ENDLOOP.

  DELETE FROM  zwhs_campos
   WHERE idmsg         = idmsg
     AND idestructura  = idestructura.

  MODIFY zwhs_campos FROM TABLE i_campos.

endmethod.
method UPDATE_COLA_MEM.
  DATA: r_idcola TYPE RANGE OF zidcola,
        lr_idcola LIKE LINE OF r_idcola,
        i_cola TYPE TABLE OF zwhs_monitor.

  CHECK NOT monitor-idcola IS INITIAL.

  CLEAR lr_idcola.
  lr_idcola-option = 'EQ'.
  lr_idcola-sign   = 'I'.
  lr_idcola-low    = monitor-idcola.
  APPEND lr_idcola TO r_idcola.

  i_cola = select_cola( r_idcola = r_idcola ).

  READ TABLE i_cola INTO monitor INDEX 1.

endmethod.
method VALOR_EASY2SAP.
  DATA: l_campo TYPE zwhs_campos,
        l_nuevo_valor(2048),
        l_long TYPE i,
        l_entero(30),
        l_decimales(10),
        l_entrada(10000).

  CLEAR: mensaje, l_nuevo_valor, l_long.

  SELECT SINGLE * FROM  zwhs_campos
    INTO l_campo
   WHERE idmsg         = idmsg
     AND idestructura  = idestructura
     AND idcampo       = idcampo.
  IF sy-subrc NE 0.
    CONCATENATE 'No hay definición de campo para' idmsg idestructura idcampo INTO mensaje SEPARATED BY space.
  ELSE.
    CASE l_campo-tipo_datos.
      WHEN 'B'.
        IF entrada = '0' OR entrada = ''.
          l_nuevo_valor(1) = ''.
        ELSE.
          l_nuevo_valor(1) = 'X'.
        ENDIF.
      WHEN 'N'.
        IF NOT entrada IS INITIAL.
          IF l_campo-long2 IS INITIAL.
            WRITE entrada TO l_entero.
            zcl_ap_string=>quitar_ceros_c( CHANGING cadena = l_entero ).
          ELSE.
            l_entrada = entrada.
            l_long = l_campo-long1 - l_campo-long2.
            WRITE l_entrada(l_long) TO l_entero.
            zcl_ap_string=>quitar_ceros_c( CHANGING cadena = l_entero ).
            CONCATENATE l_entero '.' l_entrada+l_long(l_campo-long2) INTO l_entero.
            CLEAR l_nuevo_valor.
            l_nuevo_valor = l_entero.
          ENDIF.
        ENDIF.
      WHEN 'D'.
        l_nuevo_valor(8) = entrada.
      WHEN 'A'.
        l_nuevo_valor = entrada.
      WHEN OTHERS.
        WRITE entrada TO l_nuevo_valor(l_campo-long1).
    ENDCASE.
  ENDIF.

  CHECK mensaje IS INITIAL.

  salida = l_nuevo_valor(l_campo-long1).

  IF convertir = 'X'.
    mapea_campo_easy2sap( EXPORTING idmsg        = idmsg
                                    idestructura = idestructura
                                    idcampo      = idcampo
                                    entrada      = salida
                          IMPORTING salida       = salida
                                    mensaje      = mensaje ).
  ENDIF.

endmethod.
